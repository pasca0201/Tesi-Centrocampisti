<html>
<head>
<title>test_merge_asof.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_merge_asof.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">pytz</span>

<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">Timedelta</span><span class="s2">,</span>
    <span class="s1">merge_asof</span><span class="s2">,</span>
    <span class="s1">option_context</span><span class="s2">,</span>
    <span class="s1">to_datetime</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">.</span><span class="s1">merge </span><span class="s0">import </span><span class="s1">MergeError</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;s&quot;</span><span class="s2">, </span><span class="s3">&quot;ms&quot;</span><span class="s2">, </span><span class="s3">&quot;us&quot;</span><span class="s2">, </span><span class="s3">&quot;ns&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">unit</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Resolution for datetimelike dtypes. 
    &quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s0">class </span><span class="s1">TestAsOfMerge</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">dedupe</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">dedupe</span><span class="s2">:</span>
            <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop_duplicates</span><span class="s2">([</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">], </span><span class="s1">keep</span><span class="s2">=</span><span class="s3">&quot;last&quot;</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span>
                <span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">time </span><span class="s2">= </span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">time</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">df</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">trades</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;75&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;155&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.7700&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;200&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;300&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;600&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;44&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6700&quot;</span><span class="s2">, </span><span class="s3">&quot;478343&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6700&quot;</span><span class="s2">, </span><span class="s3">&quot;478343&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6600&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;30&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;75&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;20&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;35&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;10&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5500&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5500&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;1000&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;200&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;300&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;400&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;600&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;200&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;783&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">quotes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.041&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.072&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.88&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.92&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">dedupe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">asof</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;155&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.77&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;44&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.66&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;30&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;20&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;35&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;1000&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;400&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;783&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;155&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.77&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;44&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.66&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;30&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;20&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;35&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;1000&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;400&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;783&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">allow_exact_matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;155&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.77&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;44&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.66&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;30&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;20&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;35&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;1000&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;400&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;783&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">allow_exact_matches_and_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;155&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.77&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;44&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.66&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;30&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;20&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;35&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;1000&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;400&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;783&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_examples1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_examples2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">unit </span><span class="s2">== </span><span class="s3">&quot;s&quot;</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                <span class="s3">&quot;This test is invalid for unit='s' because that would &quot;</span>
                <span class="s3">&quot;round the trades['time']]&quot;</span>
            <span class="s2">)</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">f&quot;M8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.77</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">98.00</span><span class="s2">],</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s2">: [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">155</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;quantity&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.030&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.041&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.049&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.072&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">f&quot;M8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s3">&quot;bid&quot;</span><span class="s2">: [</span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.97</span><span class="s2">, </span><span class="s5">51.99</span><span class="s2">, </span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">97.99</span><span class="s2">, </span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">52.01</span><span class="s2">],</span>
                <span class="s3">&quot;ask&quot;</span><span class="s2">: [</span><span class="s5">720.93</span><span class="s2">, </span><span class="s5">51.96</span><span class="s2">, </span><span class="s5">51.98</span><span class="s2">, </span><span class="s5">52.00</span><span class="s2">, </span><span class="s5">720.93</span><span class="s2">, </span><span class="s5">98.01</span><span class="s2">, </span><span class="s5">720.88</span><span class="s2">, </span><span class="s5">52.03</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;2ms&quot;</span><span class="s2">))</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">f&quot;M8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.77</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">98.00</span><span class="s2">],</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s2">: [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">155</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
                <span class="s3">&quot;bid&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">51.97</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s3">&quot;ask&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">51.98</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;quantity&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">,</span>
            <span class="s1">quotes</span><span class="s2">,</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">,</span>
            <span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;10ms&quot;</span><span class="s2">),</span>
            <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_examples3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;forward&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_examples4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4">&quot;&quot;&quot;doc-string examples&quot;&quot;&quot;</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_categorical</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span>
        <span class="s1">trades</span><span class="s2">.</span><span class="s1">ticker </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">)</span>
        <span class="s1">quotes</span><span class="s2">.</span><span class="s1">ticker </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">ticker </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_left_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s6"># GH14253</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span>
        <span class="s2">)</span>
        <span class="s6"># left-only index uses right&quot;s index, oddly</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s6"># time column appears after left&quot;s columns</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_right_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_left_index_right_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multi_index_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s6"># MultiIndex is prohibited</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">])</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;left can only have one index&quot;</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multi_index_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s6"># MultiIndex is prohibited</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;right can only have one index&quot;</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_on_and_index_left_on</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s6"># &quot;on&quot; parameter and index together is prohibited</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">'Can only pass argument &quot;left_on&quot; OR &quot;left_index&quot; not both.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_on_and_index_right_on</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">'Can only pass argument &quot;right_on&quot; OR &quot;right_index&quot; not both.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_left_by_right_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s6"># GH14253</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">left_by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">right_by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_missing_right_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">asof</span>

        <span class="s1">q </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">[</span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">ticker </span><span class="s2">!= </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">ticker </span><span class="s2">== </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, [</span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">]] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiby</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH13936</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.046&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.050&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;BATS&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.77</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">98.00</span><span class="s2">],</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s2">: [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">155</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;quantity&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.030&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.041&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.045&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.049&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s3">&quot;BATS&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;bid&quot;</span><span class="s2">: [</span><span class="s5">720.51</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.97</span><span class="s2">, </span><span class="s5">51.99</span><span class="s2">, </span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">97.99</span><span class="s2">],</span>
                <span class="s3">&quot;ask&quot;</span><span class="s2">: [</span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">51.96</span><span class="s2">, </span><span class="s5">51.98</span><span class="s2">, </span><span class="s5">52.00</span><span class="s2">, </span><span class="s5">720.93</span><span class="s2">, </span><span class="s5">98.01</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.046&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.050&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;BATS&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.77</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">98.00</span><span class="s2">],</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s2">: [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">155</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
                <span class="s3">&quot;bid&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">720.51</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s3">&quot;ask&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">51.96</span><span class="s2">, </span><span class="s5">720.93</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;quantity&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;object&quot;</span><span class="s2">, </span><span class="s3">&quot;string&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_multiby_heterogeneous_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># GH13936</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.046&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.050&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;BATS&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.77</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">98.00</span><span class="s2">],</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s2">: [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">155</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;quantity&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;ticker&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>

        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.030&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.041&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.045&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.049&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s3">&quot;BATS&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;bid&quot;</span><span class="s2">: [</span><span class="s5">720.51</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.97</span><span class="s2">, </span><span class="s5">51.99</span><span class="s2">, </span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">97.99</span><span class="s2">],</span>
                <span class="s3">&quot;ask&quot;</span><span class="s2">: [</span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">51.96</span><span class="s2">, </span><span class="s5">51.98</span><span class="s2">, </span><span class="s5">52.00</span><span class="s2">, </span><span class="s5">720.93</span><span class="s2">, </span><span class="s5">98.01</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;ticker&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.046&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.050&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;ticker&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s3">&quot;ARCA&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">, </span><span class="s3">&quot;BATS&quot;</span><span class="s2">, </span><span class="s3">&quot;NSDQ&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.77</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s5">98.00</span><span class="s2">],</span>
                <span class="s3">&quot;quantity&quot;</span><span class="s2">: [</span><span class="s5">75</span><span class="s2">, </span><span class="s5">155</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span><span class="s2">],</span>
                <span class="s3">&quot;bid&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">51.95</span><span class="s2">, </span><span class="s5">720.50</span><span class="s2">, </span><span class="s5">720.51</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s3">&quot;ask&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">51.96</span><span class="s2">, </span><span class="s5">720.93</span><span class="s2">, </span><span class="s5">720.92</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;quantity&quot;</span><span class="s2">, </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;ticker&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mismatched_index_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># similar to test_multiby_indexed, but we change the dtype on left.index</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160602&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160602&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160603&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160603&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">],</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s6"># different dtype for the index</span>
        <span class="s1">left</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">index </span><span class="s2">- </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160502&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160502&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160503&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160503&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;incompatible merge keys&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_multiby_indexed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH15676</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160602&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160602&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160603&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160603&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">],</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160502&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160502&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160503&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160503&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160602&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160602&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160603&quot;</span><span class="s2">), </span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;20160603&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;left_by and right_by must be the same length&quot;</span>
        <span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">left</span><span class="s2">,</span>
                <span class="s1">right</span><span class="s2">,</span>
                <span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s1">left_by</span><span class="s2">=[</span><span class="s3">&quot;k1&quot;</span><span class="s2">, </span><span class="s3">&quot;k2&quot;</span><span class="s2">],</span>
                <span class="s1">right_by</span><span class="s2">=[</span><span class="s3">&quot;k1&quot;</span><span class="s2">],</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;155&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.77&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;GOOG&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;44&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;720.93&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.67&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;478343&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.66&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;30&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;75&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;20&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;35&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.65&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;1000&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;400&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;600&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;200&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;783&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.084&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.64&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;40&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.084&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;149&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.086&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.56&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;500&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.55&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;647&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;300&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;50&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;50&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;70&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;70&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;1&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.105&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.105&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;700&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.106&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.107&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.107&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;53&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.108&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.108&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;839&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.115&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.118&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;295&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.118&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;5&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;10&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;59&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;31&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;69&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;12&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;12&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;317&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;283&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.135&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;MSFT&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.93&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;EDGX&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.92&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;51.95&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.135&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;12&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;88&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;162&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;BATS&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;25&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;14&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.61&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;12&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.62&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;ARCA&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;AAPL&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;100&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;NASDAQ&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.6&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;98.63&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">trades </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;75&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.038&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;155&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.7700&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;200&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;300&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;600&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;44&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.074&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6700&quot;</span><span class="s2">, </span><span class="s3">&quot;478343&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6700&quot;</span><span class="s2">, </span><span class="s3">&quot;478343&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6600&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;30&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;75&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;20&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;35&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6500&quot;</span><span class="s2">, </span><span class="s3">&quot;10&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5500&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5500&quot;</span><span class="s2">, </span><span class="s3">&quot;6&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;1000&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;200&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;300&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;400&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;600&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;200&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;783&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.084&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6400&quot;</span><span class="s2">, </span><span class="s3">&quot;40&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.084&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5500&quot;</span><span class="s2">, </span><span class="s3">&quot;149&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.086&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.5600&quot;</span><span class="s2">, </span><span class="s3">&quot;500&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;647&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;300&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;50&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;50&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;70&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;70&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;62&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;10&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.105&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.105&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;700&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.106&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;61&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.107&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.107&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;53&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.108&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.108&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;839&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.115&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;5&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.118&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;295&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.118&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;5&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;10&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;59&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;31&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;69&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;12&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;12&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;317&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9500&quot;</span><span class="s2">, </span><span class="s3">&quot;283&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.135&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.9300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;EDGX&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.135&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;12&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;88&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;162&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6100&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;BATS&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;61&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;25&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;14&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;12&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6200&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;ARCA&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.6300&quot;</span><span class="s2">, </span><span class="s3">&quot;100&quot;</span><span class="s2">, </span><span class="s3">&quot;NASDAQ&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,price,quantity,marketCenter&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">trades</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">] = </span><span class="s1">trades</span><span class="s2">[</span><span class="s3">&quot;price&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">trades</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">] = </span><span class="s1">trades</span><span class="s2">[</span><span class="s3">&quot;quantity&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">)</span>

        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.023&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.041&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.048&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.93&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.072&quot;</span><span class="s2">, </span><span class="s3">&quot;GOOG&quot;</span><span class="s2">, </span><span class="s3">&quot;720.50&quot;</span><span class="s2">, </span><span class="s3">&quot;720.88&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.075&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.076&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.078&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.92&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.079&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.92&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.080&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.084&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.56&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.086&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.55&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.088&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.65&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.089&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.104&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.105&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.107&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.115&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.115&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.118&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.128&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.129&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.93&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.93&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.130&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.131&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.131&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.135&quot;</span><span class="s2">, </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">, </span><span class="s3">&quot;51.92&quot;</span><span class="s2">, </span><span class="s3">&quot;51.95&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.135&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.136&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.136&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.144&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.62&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.60&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.61&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;20160525 13:30:00.145&quot;</span><span class="s2">, </span><span class="s3">&quot;AAPL&quot;</span><span class="s2">, </span><span class="s3">&quot;98.60&quot;</span><span class="s2">, </span><span class="s3">&quot;98.63&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;time,ticker,bid,ask&quot;</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;,&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">quotes</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">] = </span><span class="s1">quotes</span><span class="s2">[</span><span class="s3">&quot;bid&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">quotes</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">] = </span><span class="s1">quotes</span><span class="s2">[</span><span class="s3">&quot;ask&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">dedupe</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basic_no_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= (</span>
            <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ticker </span><span class="s2">== </span><span class="s3">&quot;MSFT&quot;</span><span class="s2">]</span>
            <span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s6"># just use a single ticker</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">asof</span><span class="s2">)</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">quotes</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_join_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;incompatible merge keys \[1\] .* must be the same type&quot;</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;can only asof on a key for left&quot;</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">], </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;can only asof on a key for left&quot;</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_with_duplicates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">asof</span><span class="s2">):</span>
        <span class="s1">q </span><span class="s2">= (</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">])</span>
            <span class="s2">.</span><span class="s1">sort_values</span><span class="s2">([</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;ticker&quot;</span><span class="s2">])</span>
            <span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">prep_data</span><span class="s2">(</span><span class="s1">asof</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_with_duplicates_no_on</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]})</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;key&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_allow_exact_matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;allow_exact_matches must be boolean, passed foo&quot;</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s3">&quot;foo&quot;</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_valid_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s6"># dti</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1s&quot;</span><span class="s2">))</span>

        <span class="s6"># integer</span>
        <span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(),</span>
            <span class="s1">quotes</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(),</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">,</span>
            <span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;incompatible tolerance .*, must be compat with type .*&quot;</span>

        <span class="s6"># incompat</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>

        <span class="s6"># invalid</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">trades</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(),</span>
                <span class="s1">quotes</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(),</span>
                <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">,</span>
                <span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">,</span>
                <span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">,</span>
            <span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;tolerance must be positive&quot;</span>

        <span class="s6"># invalid negative</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=-</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1s&quot;</span><span class="s2">)</span>
            <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span>
                <span class="s1">trades</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(),</span>
                <span class="s1">quotes</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(),</span>
                <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">,</span>
                <span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">,</span>
                <span class="s1">tolerance</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">):</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s6"># we require that we are already sorted on time &amp; quotes</span>
        <span class="s0">assert not </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">time</span><span class="s2">.</span><span class="s1">is_monotonic_increasing</span>
        <span class="s0">assert not </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">time</span><span class="s2">.</span><span class="s1">is_monotonic_increasing</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;left keys must be sorted&quot;</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">time</span><span class="s2">.</span><span class="s1">is_monotonic_increasing</span>
        <span class="s0">assert not </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">time</span><span class="s2">.</span><span class="s1">is_monotonic_increasing</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;right keys must be sorted&quot;</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">time</span><span class="s2">.</span><span class="s1">is_monotonic_increasing</span>
        <span class="s0">assert </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">time</span><span class="s2">.</span><span class="s1">is_monotonic_increasing</span>

        <span class="s6"># ok, though has dupes</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;tolerance_ts&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1day&quot;</span><span class="s2">), </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timedelta</span><span class="s2">(</span><span class="s1">days</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)],</span>
        <span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;Timedelta&quot;</span><span class="s2">, </span><span class="s3">&quot;datetime.timedelta&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tolerance_ts</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s1">tolerance_ts</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">tolerance</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_forward</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_nearest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_tz</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">):</span>
        <span class="s6"># GH 14844</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span>
                    <span class="s1">start</span><span class="s2">=</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;2016-01-02&quot;</span><span class="s2">),</span>
                    <span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">,</span>
                    <span class="s1">periods</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
                    <span class="s1">tz</span><span class="s2">=</span><span class="s1">pytz</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                    <span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span><span class="s2">,</span>
                <span class="s2">),</span>
                <span class="s3">&quot;value1&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span>
                    <span class="s1">start</span><span class="s2">=</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;2016-01-01&quot;</span><span class="s2">),</span>
                    <span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">,</span>
                    <span class="s1">periods</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
                    <span class="s1">tz</span><span class="s2">=</span><span class="s1">pytz</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                    <span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span><span class="s2">,</span>
                <span class="s2">),</span>
                <span class="s3">&quot;value2&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCDE&quot;</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;date&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1 day&quot;</span><span class="s2">))</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span>
                    <span class="s1">start</span><span class="s2">=</span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s3">&quot;2016-01-02&quot;</span><span class="s2">),</span>
                    <span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">,</span>
                    <span class="s1">periods</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
                    <span class="s1">tz</span><span class="s2">=</span><span class="s1">pytz</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                    <span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span><span class="s2">,</span>
                <span class="s2">),</span>
                <span class="s3">&quot;value1&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">),</span>
                <span class="s3">&quot;value2&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;BCDEE&quot;</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tolerance_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH22981</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1.1</span><span class="s2">, </span><span class="s5">3.5</span><span class="s2">, </span><span class="s5">10.9</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">3.3</span><span class="s2">, </span><span class="s5">7.5</span><span class="s2">, </span><span class="s5">11.5</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">3.3</span><span class="s2">, </span><span class="s5">7.5</span><span class="s2">, </span><span class="s5">11.5</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1.1</span><span class="s2">, </span><span class="s5">3.5</span><span class="s2">, </span><span class="s5">10.9</span><span class="s2">],</span>
                <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3.3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_index_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">):</span>
        <span class="s6"># GH 15135</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">tolerance</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">trades </span><span class="s2">= </span><span class="s1">trades</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">quotes </span><span class="s2">= </span><span class="s1">quotes</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">,</span>
            <span class="s1">quotes</span><span class="s2">,</span>
            <span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1day&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">allow_exact_matches</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">, </span><span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">allow_exact_matches</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_forward</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_nearest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span><span class="s2">, </span><span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">trades</span><span class="s2">, </span><span class="s1">quotes</span><span class="s2">, </span><span class="s1">allow_exact_matches_and_tolerance</span>
    <span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">trades</span><span class="s2">,</span>
            <span class="s1">quotes</span><span class="s2">,</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">,</span>
            <span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;ticker&quot;</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;100ms&quot;</span><span class="s2">),</span>
            <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">allow_exact_matches_and_tolerance</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH 13695</span>
        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]), </span><span class="s3">&quot;username&quot;</span><span class="s2">: [</span><span class="s3">&quot;bob&quot;</span><span class="s2">]}</span>
        <span class="s2">)</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s3">&quot;2016-07-15 13:30:00.000&quot;</span><span class="s2">, </span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;version&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]),</span>
                <span class="s3">&quot;username&quot;</span><span class="s2">: [</span><span class="s3">&quot;bob&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;version&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]),</span>
                <span class="s3">&quot;username&quot;</span><span class="s2">: [</span><span class="s3">&quot;bob&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;version&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">df1</span><span class="s2">,</span>
            <span class="s1">df2</span><span class="s2">,</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">,</span>
            <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;10ms&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]),</span>
                <span class="s3">&quot;username&quot;</span><span class="s2">: [</span><span class="s3">&quot;bob&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;version&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH 13709</span>
        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">, </span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;username&quot;</span><span class="s2">: [</span><span class="s3">&quot;bob&quot;</span><span class="s2">, </span><span class="s3">&quot;charlie&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s3">&quot;2016-07-15 13:30:00.000&quot;</span><span class="s2">, </span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;version&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">df1</span><span class="s2">,</span>
            <span class="s1">df2</span><span class="s2">,</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">,</span>
            <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;10ms&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">, </span><span class="s3">&quot;2016-07-15 13:30:00.030&quot;</span><span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;username&quot;</span><span class="s2">: [</span><span class="s3">&quot;bob&quot;</span><span class="s2">, </span><span class="s3">&quot;charlie&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;version&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance_forward</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">,</span>
            <span class="s1">right</span><span class="s2">,</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">,</span>
            <span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;forward&quot;</span><span class="s2">,</span>
            <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_allow_exact_matches_and_tolerance_nearest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">,</span>
            <span class="s1">right</span><span class="s2">,</span>
            <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">,</span>
            <span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span><span class="s2">,</span>
            <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_forward_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;forward&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nearest_by</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH14887</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">16</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_by_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># we specialize by type, so test that this is correct</span>
        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.020&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.030&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.040&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.050&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.060&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;value1&quot;</span><span class="s2">: [</span><span class="s5">1.1</span><span class="s2">, </span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">1.3</span><span class="s2">, </span><span class="s5">1.4</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;value1&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.015&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.020&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.025&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.035&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.040&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.055&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.060&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.065&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
                <span class="s3">&quot;value2&quot;</span><span class="s2">: [</span><span class="s5">2.1</span><span class="s2">, </span><span class="s5">2.2</span><span class="s2">, </span><span class="s5">2.3</span><span class="s2">, </span><span class="s5">2.4</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.6</span><span class="s2">, </span><span class="s5">2.7</span><span class="s2">, </span><span class="s5">2.8</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;value2&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;key&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s3">&quot;20160525 13:30:00.020&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.030&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.040&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.050&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;20160525 13:30:00.060&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;value1&quot;</span><span class="s2">: [</span><span class="s5">1.1</span><span class="s2">, </span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">1.3</span><span class="s2">, </span><span class="s5">1.4</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">],</span>
                <span class="s3">&quot;value2&quot;</span><span class="s2">: [</span><span class="s5">2.2</span><span class="s2">, </span><span class="s5">2.1</span><span class="s2">, </span><span class="s5">2.3</span><span class="s2">, </span><span class="s5">2.4</span><span class="s2">, </span><span class="s5">2.7</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;value1&quot;</span><span class="s2">, </span><span class="s3">&quot;value2&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_on_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># mimics how to determine the minimum-price variation</span>
        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">5.01</span><span class="s2">, </span><span class="s5">0.0023</span><span class="s2">, </span><span class="s5">25.13</span><span class="s2">, </span><span class="s5">340.05</span><span class="s2">, </span><span class="s5">30.78</span><span class="s2">, </span><span class="s5">1040.90</span><span class="s2">, </span><span class="s5">0.0078</span><span class="s2">],</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCDEFG&quot;</span><span class="s2">),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">100.0</span><span class="s2">], </span><span class="s3">&quot;mpv&quot;</span><span class="s2">: [</span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">]},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;mpv&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;price&quot;</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;price&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;BGACEDF&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">0.0023</span><span class="s2">, </span><span class="s5">0.0078</span><span class="s2">, </span><span class="s5">5.01</span><span class="s2">, </span><span class="s5">25.13</span><span class="s2">, </span><span class="s5">30.78</span><span class="s2">, </span><span class="s5">340.05</span><span class="s2">, </span><span class="s5">1040.90</span><span class="s2">],</span>
                <span class="s3">&quot;mpv&quot;</span><span class="s2">: [</span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;mpv&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_on_specialized_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">any_real_numpy_dtype</span><span class="s2">):</span>
        <span class="s6"># see gh-13936</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">any_real_numpy_dtype</span><span class="s2">).</span><span class="s1">type</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">78</span><span class="s2">, </span><span class="s5">120</span><span class="s2">, </span><span class="s5">79</span><span class="s2">], </span><span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCDEFG&quot;</span><span class="s2">)},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">df1</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">80</span><span class="s2">, </span><span class="s5">120</span><span class="s2">, </span><span class="s5">125</span><span class="s2">], </span><span class="s3">&quot;result&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;xyzw&quot;</span><span class="s2">)},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;value&quot;</span><span class="s2">, </span><span class="s3">&quot;result&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;value&quot;</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;value&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;BACEGDF&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">78</span><span class="s2">, </span><span class="s5">79</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">120</span><span class="s2">],</span>
                <span class="s3">&quot;result&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;xxxxxyz&quot;</span><span class="s2">),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">, </span><span class="s3">&quot;result&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_on_specialized_type_by_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">any_real_numpy_dtype</span><span class="s2">):</span>
        <span class="s6"># see gh-13936</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">any_real_numpy_dtype</span><span class="s2">).</span><span class="s1">type</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">78</span><span class="s2">, </span><span class="s5">120</span><span class="s2">, </span><span class="s5">79</span><span class="s2">],</span>
                <span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCDEFG&quot;</span><span class="s2">),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">df1</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">80</span><span class="s2">, </span><span class="s5">120</span><span class="s2">, </span><span class="s5">125</span><span class="s2">], </span><span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;result&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;xyzw&quot;</span><span class="s2">)},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;value&quot;</span><span class="s2">, </span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;result&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;value&quot;</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;value&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;key&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;BACEGDF&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;key&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">78</span><span class="s2">, </span><span class="s5">79</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">120</span><span class="s2">],</span>
                <span class="s3">&quot;result&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;key&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">, </span><span class="s3">&quot;result&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_on_float_by_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># type specialize both &quot;by&quot; and &quot;on&quot; parameters</span>
        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;AAABBBCCC&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span>
                    <span class="s5">3.26</span><span class="s2">,</span>
                    <span class="s5">3.2599</span><span class="s2">,</span>
                    <span class="s5">3.2598</span><span class="s2">,</span>
                    <span class="s5">12.58</span><span class="s2">,</span>
                    <span class="s5">12.59</span><span class="s2">,</span>
                    <span class="s5">12.5</span><span class="s2">,</span>
                    <span class="s5">378.15</span><span class="s2">,</span>
                    <span class="s5">378.2</span><span class="s2">,</span>
                    <span class="s5">378.25</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">100.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">, </span><span class="s5">100.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">, </span><span class="s5">1000.0</span><span class="s2">],</span>
                <span class="s3">&quot;mpv&quot;</span><span class="s2">: [</span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">, </span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;mpv&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;price&quot;</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df2</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;price&quot;</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;exch&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;symbol&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;AAABBBCCC&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;exch&quot;</span><span class="s2">: [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
                <span class="s3">&quot;price&quot;</span><span class="s2">: [</span>
                    <span class="s5">3.2598</span><span class="s2">,</span>
                    <span class="s5">3.2599</span><span class="s2">,</span>
                    <span class="s5">3.26</span><span class="s2">,</span>
                    <span class="s5">12.5</span><span class="s2">,</span>
                    <span class="s5">12.58</span><span class="s2">,</span>
                    <span class="s5">12.59</span><span class="s2">,</span>
                    <span class="s5">378.15</span><span class="s2">,</span>
                    <span class="s5">378.2</span><span class="s2">,</span>
                    <span class="s5">378.25</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s3">&quot;mpv&quot;</span><span class="s2">: [</span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.0001</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;symbol&quot;</span><span class="s2">, </span><span class="s3">&quot;exch&quot;</span><span class="s2">, </span><span class="s3">&quot;price&quot;</span><span class="s2">, </span><span class="s3">&quot;mpv&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_merge_datatype_error_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">using_infer_string</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">using_infer_string</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;incompatible merge keys&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], </span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]})</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_merge_datatype_categorical_error_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">r&quot;incompatible merge keys \[0\] .* both sides category, &quot;</span>
            <span class="s3">&quot;but not equal ones&quot;</span>
        <span class="s2">)</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">],</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MergeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_merge_groupby_multiple_column_with_categorical_column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH 16454</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;x&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">], </span><span class="s3">&quot;y&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">], </span><span class="s3">&quot;z&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s5">0</span><span class="s2">])})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;y&quot;</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;x&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">], </span><span class="s3">&quot;y&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">], </span><span class="s3">&quot;z&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s5">0</span><span class="s2">])})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;func&quot;</span><span class="s2">, [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)], </span><span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;numeric&quot;</span><span class="s2">, </span><span class="s3">&quot;datetime&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;side&quot;</span><span class="s2">, [</span><span class="s3">&quot;left&quot;</span><span class="s2">, </span><span class="s3">&quot;right&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_merge_on_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">side</span><span class="s2">):</span>
        <span class="s6"># GH 23189</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">f&quot;Merge keys contain null values on </span><span class="s0">{</span><span class="s1">side</span><span class="s0">} </span><span class="s3">side&quot;</span>
        <span class="s1">nulls </span><span class="s2">= </span><span class="s1">func</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">non_nulls </span><span class="s2">= </span><span class="s1">func</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">, </span><span class="s5">10.0</span><span class="s2">])</span>
        <span class="s1">df_null </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">nulls</span><span class="s2">, </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">non_nulls</span><span class="s2">, </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]})</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">side </span><span class="s2">== </span><span class="s3">&quot;left&quot;</span><span class="s2">:</span>
                <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df_null</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_null</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_by_nullable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">any_numeric_ea_dtype</span><span class="s2">, </span><span class="s1">using_infer_string</span><span class="s2">):</span>
        <span class="s6"># Note: this test passes if instead of using pd.array we use</span>
        <span class="s6">#  np.array([np.nan, 1]).  Other than that, I (@jbrockmendel)</span>
        <span class="s6">#  have NO IDEA what the expected behavior is.</span>
        <span class="s6"># TODO(GH#32306): may be relevant to the expected behavior here.</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">any_numeric_ea_dtype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s3">&quot;u&quot;</span><span class="s2">]:</span>
            <span class="s1">max_val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">numpy_dtype</span><span class="s2">).</span><span class="s1">max</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">max_val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">numpy_dtype</span><span class="s2">).</span><span class="s1">max</span>
        <span class="s6"># set value s.t. (at least for integer dtypes) arr._values_for_argsort</span>
        <span class="s6">#  is not an injection</span>
        <span class="s1">arr</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] = </span><span class="s1">max_val</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col1&quot;</span><span class="s2">: </span><span class="s1">arr</span><span class="s2">,</span>
                <span class="s3">&quot;by_col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;HELLO&quot;</span><span class="s2">, </span><span class="s3">&quot;To&quot;</span><span class="s2">, </span><span class="s3">&quot;You&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col1&quot;</span><span class="s2">: </span><span class="s1">arr</span><span class="s2">,</span>
                <span class="s3">&quot;by_col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;WORLD&quot;</span><span class="s2">, </span><span class="s3">&quot;Wide&quot;</span><span class="s2">, </span><span class="s3">&quot;Web&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;f&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;by_col1&quot;</span><span class="s2">, </span><span class="s3">&quot;by_col2&quot;</span><span class="s2">], </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;on_col&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col1&quot;</span><span class="s2">: </span><span class="s1">arr</span><span class="s2">,</span>
                <span class="s3">&quot;by_col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;HELLO&quot;</span><span class="s2">, </span><span class="s3">&quot;To&quot;</span><span class="s2">, </span><span class="s3">&quot;You&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">],</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;value_y&quot;</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">using_infer_string</span><span class="s2">:</span>
            <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;value_y&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;value_y&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;string[pyarrow_numpy]&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_merge_by_col_tz_aware</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH 21184</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">]).</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;values&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">]).</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
                <span class="s3">&quot;values&quot;</span><span class="s2">: [</span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;by_col&quot;</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;on_col&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;by_col&quot;</span><span class="s2">, </span><span class="s3">&quot;on_col&quot;</span><span class="s2">, </span><span class="s3">&quot;values_x&quot;</span><span class="s2">, </span><span class="s3">&quot;values_y&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_by_mixed_tz_aware</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">using_infer_string</span><span class="s2">):</span>
        <span class="s6"># GH 26649</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">]).</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;by_col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;HELLO&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">]).</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;by_col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;WORLD&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;by_col1&quot;</span><span class="s2">, </span><span class="s3">&quot;by_col2&quot;</span><span class="s2">], </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;on_col&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">), </span><span class="s3">&quot;HELLO&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">]],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;by_col1&quot;</span><span class="s2">, </span><span class="s3">&quot;by_col2&quot;</span><span class="s2">, </span><span class="s3">&quot;on_col&quot;</span><span class="s2">, </span><span class="s3">&quot;value_x&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;value_y&quot;</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">using_infer_string</span><span class="s2">:</span>
            <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;value_y&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;value_y&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;string[pyarrow_numpy]&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;float64&quot;</span><span class="s2">, </span><span class="s3">&quot;int16&quot;</span><span class="s2">, </span><span class="s3">&quot;m8[ns]&quot;</span><span class="s2">, </span><span class="s3">&quot;M8[us]&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_by_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># GH 55453, GH 22794</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
                <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">by</span><span class="s2">=</span><span class="s3">&quot;by_col&quot;</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;on_col&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;by_col&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
                <span class="s3">&quot;on_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">],</span>
                <span class="s3">&quot;value_x&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;value_y&quot;</span><span class="s2">: [</span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_timedelta_tolerance_nearest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">):</span>
        <span class="s6"># GH 27642</span>
        <span class="s0">if </span><span class="s1">unit </span><span class="s2">== </span><span class="s3">&quot;s&quot;</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                <span class="s3">&quot;This test is invalid with unit='s' because that would &quot;</span>
                <span class="s3">&quot;round left['time']&quot;</span>
            <span class="s2">)</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">25</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])),</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;left&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">left</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s1">left</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">], </span><span class="s3">&quot;ms&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">f&quot;m8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">)</span>

        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">18</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])),</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;right&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">right</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s1">right</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">], </span><span class="s3">&quot;ms&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">f&quot;m8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">list</span><span class="s2">(</span>
                <span class="s1">zip</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">25</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s2">)</span>
            <span class="s2">),</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s3">&quot;left&quot;</span><span class="s2">, </span><span class="s3">&quot;right&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">], </span><span class="s3">&quot;ms&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">f&quot;m8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1ms&quot;</span><span class="s2">), </span><span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;nearest&quot;</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_int_type_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">any_int_dtype</span><span class="s2">):</span>
        <span class="s6"># GH #28870</span>

        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]})</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">25</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]})</span>
        <span class="s1">left</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s1">left</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">any_int_dtype</span><span class="s2">)</span>
        <span class="s1">right</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s1">right</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">any_int_dtype</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]}</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">any_int_dtype</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_merge_index_column_tz</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># GH 29864</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2019-10-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;30min&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">)</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;xyz&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:])</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;from_date&quot;</span><span class="s2">: </span><span class="s1">index</span><span class="s2">, </span><span class="s3">&quot;abc&quot;</span><span class="s2">: [</span><span class="s5">2.46</span><span class="s2">] * </span><span class="s5">4 </span><span class="s2">+ [</span><span class="s5">2.19</span><span class="s2">]})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">=</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">=</span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=[</span><span class="s3">&quot;from_date&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;xyz&quot;</span><span class="s2">: [</span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">],</span>
                <span class="s3">&quot;from_date&quot;</span><span class="s2">: </span><span class="s1">index</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:],</span>
                <span class="s3">&quot;abc&quot;</span><span class="s2">: [</span><span class="s5">2.46</span><span class="s2">] * </span><span class="s5">3 </span><span class="s2">+ [</span><span class="s5">2.19</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span>
                <span class="s3">&quot;2019-10-01 00:30:00&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;30min&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">=</span><span class="s1">right</span><span class="s2">, </span><span class="s1">right</span><span class="s2">=</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=[</span><span class="s3">&quot;from_date&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;from_date&quot;</span><span class="s2">: </span><span class="s1">index</span><span class="s2">,</span>
                <span class="s3">&quot;abc&quot;</span><span class="s2">: [</span><span class="s5">2.46</span><span class="s2">] * </span><span class="s5">4 </span><span class="s2">+ [</span><span class="s5">2.19</span><span class="s2">],</span>
                <span class="s3">&quot;xyz&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">],</span>
            <span class="s2">},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_left_index_right_index_tolerance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">):</span>
        <span class="s6"># https://github.com/pandas-dev/pandas/issues/35558</span>
        <span class="s0">if </span><span class="s1">unit </span><span class="s2">== </span><span class="s3">&quot;s&quot;</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                <span class="s3">&quot;This test is invalid with unit='s' because that would round dr1&quot;</span>
            <span class="s2">)</span>

        <span class="s1">dr1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span>
            <span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;1/1/2020&quot;</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s3">&quot;1/20/2020&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;2D&quot;</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span>
        <span class="s2">) + </span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s1">seconds</span><span class="s2">=</span><span class="s5">0.4</span><span class="s2">).</span><span class="s1">as_unit</span><span class="s2">(</span><span class="s1">unit</span><span class="s2">)</span>
        <span class="s1">dr2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;1/1/2020&quot;</span><span class="s2">, </span><span class="s1">end</span><span class="s2">=</span><span class="s3">&quot;2/1/2020&quot;</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span><span class="s2">)</span>

        <span class="s1">df1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;val1&quot;</span><span class="s2">: </span><span class="s3">&quot;foo&quot;</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">(</span><span class="s1">dr1</span><span class="s2">))</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;val2&quot;</span><span class="s2">: </span><span class="s3">&quot;bar&quot;</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">(</span><span class="s1">dr2</span><span class="s2">))</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;val1&quot;</span><span class="s2">: </span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s3">&quot;val2&quot;</span><span class="s2">: </span><span class="s3">&quot;bar&quot;</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">(</span><span class="s1">dr1</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">df1</span><span class="s2">,</span>
            <span class="s1">df2</span><span class="s2">,</span>
            <span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s1">seconds</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;infer_string&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">))]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;kwargs&quot;</span><span class="s2">, [{</span><span class="s3">&quot;on&quot;</span><span class="s2">: </span><span class="s3">&quot;x&quot;</span><span class="s2">}, {</span><span class="s3">&quot;left_index&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;right_index&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;data&quot;</span><span class="s2">,</span>
    <span class="s2">[[</span><span class="s3">&quot;2019-06-01 00:09:12&quot;</span><span class="s2">, </span><span class="s3">&quot;2019-06-01 00:10:29&quot;</span><span class="s2">], [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s3">&quot;2019-06-01 00:10:29&quot;</span><span class="s2">]],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_merge_asof_non_numerical_dtype</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">infer_string</span><span class="s2">):</span>
    <span class="s6"># GH#29130</span>
    <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;future.infer_string&quot;</span><span class="s2">, </span><span class="s1">infer_string</span><span class="s2">):</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;x&quot;</span><span class="s2">: </span><span class="s1">data</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;x&quot;</span><span class="s2">: </span><span class="s1">data</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">MergeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s3">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_non_numerical_dtype_object</span><span class="s2">():</span>
    <span class="s6"># GH#29130</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;12&quot;</span><span class="s2">, </span><span class="s3">&quot;13&quot;</span><span class="s2">, </span><span class="s3">&quot;15&quot;</span><span class="s2">], </span><span class="s3">&quot;left_val1&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">, </span><span class="s3">&quot;f&quot;</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">MergeError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">merge_asof</span><span class="s2">(</span>
            <span class="s1">left</span><span class="s2">,</span>
            <span class="s1">right</span><span class="s2">,</span>
            <span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;left_val1&quot;</span><span class="s2">,</span>
            <span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">,</span>
            <span class="s1">left_by</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">,</span>
            <span class="s1">right_by</span><span class="s2">=</span><span class="s3">&quot;left_val&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s3">&quot;right_index&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;left_index&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s3">&quot;left_on&quot;</span><span class="s2">: </span><span class="s3">&quot;left_time&quot;</span><span class="s2">, </span><span class="s3">&quot;right_index&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s3">&quot;left_index&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;right_on&quot;</span><span class="s2">: </span><span class="s3">&quot;right&quot;</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_merge_asof_index_behavior</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6"># GH 33463</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">)</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;left&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;left_time&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;right&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;left&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s3">&quot;left_time&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], </span><span class="s3">&quot;right&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_numeric_column_in_index</span><span class="s2">():</span>
    <span class="s6"># GH#34488</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">22</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">22</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_numeric_column_in_multiindex</span><span class="s2">():</span>
    <span class="s6"># GH#34488</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">]},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">]),</span>
    <span class="s2">)</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">22</span><span class="s2">]},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">]], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">]),</span>
    <span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">22</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_numeri_column_in_index_object_dtype</span><span class="s2">():</span>
    <span class="s6"># GH#34488</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s3">&quot;2&quot;</span><span class="s2">, </span><span class="s3">&quot;3&quot;</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">22</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">&quot;m&quot;</span><span class="s2">, </span><span class="s3">&quot;n&quot;</span><span class="s2">, </span><span class="s3">&quot;o&quot;</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">MergeError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s1">left </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">().</span><span class="s1">set_index</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">right</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">().</span><span class="s1">set_index</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">MergeError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">r&quot;Incompatible merge dtype, .*, both sides must have numeric dtype&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_array_as_on</span><span class="s2">(</span><span class="s1">unit</span><span class="s2">):</span>
    <span class="s6"># GH#42844</span>
    <span class="s1">dti </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s3">&quot;2021/01/01 00:37&quot;</span><span class="s2">, </span><span class="s3">&quot;2021/01/01 01:40&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">f&quot;M8[</span><span class="s0">{</span><span class="s1">unit</span><span class="s0">}</span><span class="s3">]&quot;</span>
    <span class="s2">)</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">],</span>
            <span class="s3">&quot;ts&quot;</span><span class="s2">: </span><span class="s1">dti</span><span class="s2">,</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">ts_merge </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span>
        <span class="s1">start</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2021/01/01 00:00&quot;</span><span class="s2">), </span><span class="s1">periods</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;1h&quot;</span><span class="s2">, </span><span class="s1">unit</span><span class="s2">=</span><span class="s1">unit</span>
    <span class="s2">)</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
        <span class="s1">left</span><span class="s2">,</span>
        <span class="s1">right</span><span class="s2">,</span>
        <span class="s1">left_on</span><span class="s2">=</span><span class="s1">ts_merge</span><span class="s2">,</span>
        <span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;ts&quot;</span><span class="s2">,</span>
        <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;backward&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], </span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">], </span><span class="s3">&quot;ts&quot;</span><span class="s2">: </span><span class="s1">ts_merge</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
        <span class="s1">right</span><span class="s2">,</span>
        <span class="s1">left</span><span class="s2">,</span>
        <span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;ts&quot;</span><span class="s2">,</span>
        <span class="s1">right_on</span><span class="s2">=</span><span class="s1">ts_merge</span><span class="s2">,</span>
        <span class="s1">allow_exact_matches</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;backward&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">],</span>
            <span class="s3">&quot;ts&quot;</span><span class="s2">: </span><span class="s1">dti</span><span class="s2">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">8</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_raise_for_duplicate_columns</span><span class="s2">():</span>
    <span class="s6"># GH#50102</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;left_val&quot;</span><span class="s2">])</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;right_val&quot;</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;column label 'a'&quot;</span><span class="s2">):</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;column label 'a'&quot;</span><span class="s2">):</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;right_val&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;column label 'a'&quot;</span><span class="s2">):</span>
        <span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_on</span><span class="s2">=</span><span class="s3">&quot;left_val&quot;</span><span class="s2">, </span><span class="s1">right_on</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s3">&quot;Int64&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;timestamp[s][pyarrow]&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_merge_asof_extension_dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s6"># GH 52904</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;join_col&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">],</span>
            <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;join_col&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">],</span>
            <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;join_col&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">right</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;join_col&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;join_col&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;join_col&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">],</span>
            <span class="s3">&quot;left_val&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
            <span class="s3">&quot;right_val&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;join_col&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_merge_asof_pyarrow_td_tolerance</span><span class="s2">():</span>
    <span class="s6"># GH 56486</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s5">2023</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;timestamp[us, UTC][pyarrow]&quot;</span>
    <span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;timestamp&quot;</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">,</span>
            <span class="s3">&quot;value&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;timestamp&quot;</span><span class="s2">, </span><span class="s1">tolerance</span><span class="s2">=</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s3">&quot;1s&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;timestamp&quot;</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">,</span>
            <span class="s3">&quot;value_x&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
            <span class="s3">&quot;value_y&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_read_only_ndarray</span><span class="s2">():</span>
    <span class="s6"># GH 53513</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s5">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;left&quot;</span><span class="s2">)</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s5">1</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;right&quot;</span><span class="s2">)</span>
    <span class="s6"># set to read-only</span>
    <span class="s1">left</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">values</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">right</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">values</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">right_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;left&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">], </span><span class="s3">&quot;right&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_merge_asof_multiby_with_categorical</span><span class="s2">():</span>
    <span class="s6"># GH 43541</span>
    <span class="s1">left </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;c1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">categories</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]),</span>
            <span class="s3">&quot;c2&quot;</span><span class="s2">: [</span><span class="s3">&quot;x&quot;</span><span class="s2">] * </span><span class="s5">4</span><span class="s2">,</span>
            <span class="s3">&quot;t&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">] * </span><span class="s5">4</span><span class="s2">,</span>
            <span class="s3">&quot;v&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">4</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;c1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">categories</span><span class="s2">=[</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">]),</span>
            <span class="s3">&quot;c2&quot;</span><span class="s2">: [</span><span class="s3">&quot;x&quot;</span><span class="s2">] * </span><span class="s5">2</span><span class="s2">,</span>
            <span class="s3">&quot;t&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s3">&quot;v&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">merge_asof</span><span class="s2">(</span>
        <span class="s1">left</span><span class="s2">,</span>
        <span class="s1">right</span><span class="s2">,</span>
        <span class="s1">by</span><span class="s2">=[</span><span class="s3">&quot;c1&quot;</span><span class="s2">, </span><span class="s3">&quot;c2&quot;</span><span class="s2">],</span>
        <span class="s1">on</span><span class="s2">=</span><span class="s3">&quot;t&quot;</span><span class="s2">,</span>
        <span class="s1">direction</span><span class="s2">=</span><span class="s3">&quot;forward&quot;</span><span class="s2">,</span>
        <span class="s1">suffixes</span><span class="s2">=[</span><span class="s3">&quot;_left&quot;</span><span class="s2">, </span><span class="s3">&quot;_right&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;c1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">categories</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]),</span>
            <span class="s3">&quot;c2&quot;</span><span class="s2">: [</span><span class="s3">&quot;x&quot;</span><span class="s2">] * </span><span class="s5">4</span><span class="s2">,</span>
            <span class="s3">&quot;t&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">] * </span><span class="s5">4</span><span class="s2">,</span>
            <span class="s3">&quot;v_left&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">4</span><span class="s2">),</span>
            <span class="s3">&quot;v_right&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>