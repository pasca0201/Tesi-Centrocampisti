<html>
<head>
<title>test_umath.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_umath.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">import </span><span class="s1">fnmatch</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">from </span><span class="s1">fractions </span><span class="s0">import </span><span class="s1">Fraction</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">reduce</span>
<span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">namedtuple</span>

<span class="s0">import </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">umath </span><span class="s0">as </span><span class="s1">ncu</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">_core </span><span class="s0">import </span><span class="s1">_umath_tests </span><span class="s0">as </span><span class="s1">ncu_tests</span><span class="s2">, </span><span class="s1">sctypes</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_raises</span><span class="s2">, </span><span class="s1">assert_raises_regex</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_max_ulp</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_no_warnings</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">,</span>
    <span class="s1">_gen_alignment_data</span><span class="s2">, </span><span class="s1">assert_array_almost_equal_nulp</span><span class="s2">, </span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">IS_MUSL</span><span class="s2">,</span>
    <span class="s1">IS_PYPY</span><span class="s2">, </span><span class="s1">HAS_REFCOUNT</span>
    <span class="s2">)</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">_private</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">_glibc_older_than</span>

<span class="s1">UFUNCS </span><span class="s2">= [</span><span class="s1">obj </span><span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">umath</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()</span>
         <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ufunc</span><span class="s2">)]</span>

<span class="s1">UFUNCS_UNARY </span><span class="s2">= [</span>
    <span class="s1">uf </span><span class="s0">for </span><span class="s1">uf </span><span class="s0">in </span><span class="s1">UFUNCS </span><span class="s0">if </span><span class="s1">uf</span><span class="s2">.</span><span class="s1">nin </span><span class="s2">== </span><span class="s3">1</span>
<span class="s2">]</span>
<span class="s1">UFUNCS_UNARY_FP </span><span class="s2">= [</span>
    <span class="s1">uf </span><span class="s0">for </span><span class="s1">uf </span><span class="s0">in </span><span class="s1">UFUNCS_UNARY </span><span class="s0">if </span><span class="s4">'f-&gt;f' </span><span class="s0">in </span><span class="s1">uf</span><span class="s2">.</span><span class="s1">types</span>
<span class="s2">]</span>

<span class="s1">UFUNCS_BINARY </span><span class="s2">= [</span>
    <span class="s1">uf </span><span class="s0">for </span><span class="s1">uf </span><span class="s0">in </span><span class="s1">UFUNCS </span><span class="s0">if </span><span class="s1">uf</span><span class="s2">.</span><span class="s1">nin </span><span class="s2">== </span><span class="s3">2</span>
<span class="s2">]</span>
<span class="s1">UFUNCS_BINARY_ACC </span><span class="s2">= [</span>
    <span class="s1">uf </span><span class="s0">for </span><span class="s1">uf </span><span class="s0">in </span><span class="s1">UFUNCS_BINARY </span><span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">uf</span><span class="s2">, </span><span class="s4">&quot;accumulate&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">uf</span><span class="s2">.</span><span class="s1">nout </span><span class="s2">== </span><span class="s3">1</span>
<span class="s2">]</span>

<span class="s0">def </span><span class="s1">interesting_binop_operands</span><span class="s2">(</span><span class="s1">val1</span><span class="s2">, </span><span class="s1">val2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Helper to create &quot;interesting&quot; operands to cover common code paths: 
    * scalar inputs 
    * only first &quot;values&quot; is an array (e.g. scalar division fast-paths) 
    * Longer array (SIMD) placing the value of interest at different positions 
    * Oddly strided arrays which may not be SIMD compatible 
 
    It does not attempt to cover unaligned access or mixed dtypes. 
    These are normally handled by the casting/buffering machinery. 
 
    This is not a fixture (currently), since I believe a fixture normally 
    only yields once? 
    &quot;&quot;&quot;</span>
    <span class="s1">fill_value </span><span class="s2">= </span><span class="s3">1  </span><span class="s6"># could be a parameter, but maybe not an optional one?</span>

    <span class="s1">arr1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">10003</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">fill_value</span><span class="s2">)</span>
    <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s3">10003</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">fill_value</span><span class="s2">)</span>

    <span class="s1">arr1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">val1</span>
    <span class="s1">arr2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">val2</span>

    <span class="s1">extractor </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">res</span><span class="s2">: </span><span class="s1">res</span>
    <span class="s0">yield </span><span class="s1">arr1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">arr2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">extractor</span><span class="s2">, </span><span class="s4">&quot;scalars&quot;</span>

    <span class="s1">extractor </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">res</span><span class="s2">: </span><span class="s1">res</span>
    <span class="s0">yield </span><span class="s1">arr1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, ...], </span><span class="s1">arr2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, ...], </span><span class="s1">extractor</span><span class="s2">, </span><span class="s4">&quot;scalar-arrays&quot;</span>

    <span class="s6"># reset array values to fill_value:</span>
    <span class="s1">arr1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">fill_value</span>
    <span class="s1">arr2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s1">fill_value</span>

    <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">]:</span>
        <span class="s1">arr1</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">] = </span><span class="s1">val1</span>
        <span class="s1">arr2</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">] = </span><span class="s1">val2</span>

        <span class="s1">extractor </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">res</span><span class="s2">: </span><span class="s1">res</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">]</span>
        <span class="s0">yield </span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">, </span><span class="s1">extractor</span><span class="s2">, </span><span class="s4">f&quot;off-</span><span class="s0">{</span><span class="s1">pos</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s0">yield </span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">], </span><span class="s1">extractor</span><span class="s2">, </span><span class="s4">f&quot;off-</span><span class="s0">{</span><span class="s1">pos</span><span class="s0">}</span><span class="s4">-with-scalar&quot;</span>

        <span class="s1">arr1</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">] = </span><span class="s1">fill_value</span>
        <span class="s1">arr2</span><span class="s2">[</span><span class="s1">pos</span><span class="s2">] = </span><span class="s1">fill_value</span>

    <span class="s0">for </span><span class="s1">stride </span><span class="s0">in </span><span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">113</span><span class="s2">]:</span>
        <span class="s1">op1 </span><span class="s2">= </span><span class="s1">arr1</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]</span>
        <span class="s1">op2 </span><span class="s2">= </span><span class="s1">arr2</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]</span>
        <span class="s1">op1</span><span class="s2">[</span><span class="s3">10</span><span class="s2">] = </span><span class="s1">val1</span>
        <span class="s1">op2</span><span class="s2">[</span><span class="s3">10</span><span class="s2">] = </span><span class="s1">val2</span>

        <span class="s1">extractor </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">res</span><span class="s2">: </span><span class="s1">res</span><span class="s2">[</span><span class="s3">10</span><span class="s2">]</span>
        <span class="s0">yield </span><span class="s1">op1</span><span class="s2">, </span><span class="s1">op2</span><span class="s2">, </span><span class="s1">extractor</span><span class="s2">, </span><span class="s4">f&quot;stride-</span><span class="s0">{</span><span class="s1">stride</span><span class="s0">}</span><span class="s4">&quot;</span>

        <span class="s1">op1</span><span class="s2">[</span><span class="s3">10</span><span class="s2">] = </span><span class="s1">fill_value</span>
        <span class="s1">op2</span><span class="s2">[</span><span class="s3">10</span><span class="s2">] = </span><span class="s1">fill_value</span>


<span class="s0">def </span><span class="s1">on_powerpc</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; True if we are running on a Power PC platform.&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">processor</span><span class="s2">() == </span><span class="s4">'powerpc' </span><span class="s0">or </span><span class="s1">\</span>
           <span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'ppc'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">bad_arcsinh</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;The blocklisted trig functions are not accurate on aarch64/PPC for 
    complex256. Rather than dig through the actual problem skip the 
    test. This should be fixed when we can move past glibc2.17 
    which is the version in manylinux2014 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'aarch64'</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s3">1.78e-10</span>
    <span class="s0">elif </span><span class="s1">on_powerpc</span><span class="s2">():</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s3">2.16e-10</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return False</span>
    <span class="s1">v1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float128</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s1">v2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex256</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)).</span><span class="s1">real</span>
    <span class="s6"># The eps for float128 is 1-e33, so this is way bigger</span>
    <span class="s0">return </span><span class="s1">abs</span><span class="s2">((</span><span class="s1">v1 </span><span class="s2">/ </span><span class="s1">v2</span><span class="s2">) - </span><span class="s3">1.0</span><span class="s2">) &gt; </span><span class="s3">1e-23</span>


<span class="s0">class </span><span class="s1">_FilterInvalids</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">olderr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">seterr</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">teardown_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">seterr</span><span class="s2">(**</span><span class="s1">self</span><span class="s2">.</span><span class="s1">olderr</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestConstants</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_pi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s3">3.141592653589793</span><span class="s2">, </span><span class="s3">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_e</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s3">2.718281828459045</span><span class="s2">, </span><span class="s3">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_euler_gamma</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">euler_gamma</span><span class="s2">, </span><span class="s3">0.5772156649015329</span><span class="s2">, </span><span class="s3">1e-15</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestOut</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_out_subok</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">subok </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">)</span>
            <span class="s1">o </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(())</span>

            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r </span><span class="s0">is </span><span class="s1">o</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r </span><span class="s0">is </span><span class="s1">o</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">o</span><span class="s2">,), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r </span><span class="s0">is </span><span class="s1">o</span><span class="s2">)</span>

            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">5.7</span><span class="s2">)</span>
            <span class="s1">o1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(())</span>
            <span class="s1">o2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">o1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r1 </span><span class="s0">is </span><span class="s1">o1</span><span class="s2">)</span>
            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">o2</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r2 </span><span class="s0">is </span><span class="s1">o2</span><span class="s2">)</span>
            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">o1</span><span class="s2">, </span><span class="s1">o2</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r1 </span><span class="s0">is </span><span class="s1">o1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r2 </span><span class="s0">is </span><span class="s1">o2</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">o1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r1 </span><span class="s0">is </span><span class="s1">o1</span><span class="s2">)</span>
            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">o2</span><span class="s2">), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r2 </span><span class="s0">is </span><span class="s1">o2</span><span class="s2">)</span>
            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">o1</span><span class="s2">, </span><span class="s1">o2</span><span class="s2">), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r1 </span><span class="s0">is </span><span class="s1">o1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">r2 </span><span class="s0">is </span><span class="s1">o2</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s6"># Out argument must be tuple, since there are multiple outputs.</span>
                <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">o1</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>

            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">o</span><span class="s2">, </span><span class="s1">o</span><span class="s2">), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, [], </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=[], </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=([],), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">o</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">o</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">o</span><span class="s2">,), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_out_wrap_subok</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">class </span><span class="s1">ArrayWrap</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">10</span>

            <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">()</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">subok </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">ArrayWrap</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">])</span>

            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">,), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">d </span><span class="s2">= </span><span class="s1">ArrayWrap</span><span class="s2">([</span><span class="s3">5.7</span><span class="s2">])</span>
            <span class="s1">o1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">1</span><span class="s2">,))</span>
            <span class="s1">o2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">1</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">o1</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">o1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">o2</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">o1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">o2</span><span class="s2">), </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">subok</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">ArrayWrap</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s6"># Out argument must be tuple, since there are multiple outputs.</span>
                <span class="s1">r1</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">o1</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s1">subok</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Python lacks refcounts&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_out_wrap_no_leak</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Regression test for gh-26545</span>
        <span class="s0">class </span><span class="s1">ArrSubclass</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">ArrSubclass</span><span class="s2">)</span>

        <span class="s1">arr </span><span class="s2">*= </span><span class="s3">1</span>
        <span class="s0">assert </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">) == </span><span class="s3">2</span>


<span class="s0">class </span><span class="s1">TestComparisons</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">operator</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, </span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'uint'</span><span class="s2">] + </span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'int'</span><span class="s2">] +</span>
                             <span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'float'</span><span class="s2">] + [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'py_comp,np_comp'</span><span class="s2">, [</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">)</span>
    <span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_comparison_functions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">py_comp</span><span class="s2">, </span><span class="s1">np_comp</span><span class="s2">):</span>
        <span class="s6"># Initialize input arrays</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">)</span>
            <span class="s1">scalar </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">scalar </span><span class="s2">= </span><span class="s3">5</span>
        <span class="s1">np_scalar </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">type</span><span class="s2">(</span><span class="s1">scalar</span><span class="s2">)</span>
        <span class="s1">a_lst </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>
        <span class="s1">b_lst </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>

        <span class="s6"># (Binary) Comparison (x1=array, x2=array)</span>
        <span class="s1">comp_b </span><span class="s2">= </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">comp_b_list </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">a_lst</span><span class="s2">, </span><span class="s1">b_lst</span><span class="s2">)]</span>

        <span class="s6"># (Scalar1) Comparison (x1=scalar, x2=array)</span>
        <span class="s1">comp_s1 </span><span class="s2">= </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">np_scalar</span><span class="s2">, </span><span class="s1">b</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">comp_s1_list </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">scalar</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">b_lst</span><span class="s2">]</span>

        <span class="s6"># (Scalar2) Comparison (x1=array, x2=scalar)</span>
        <span class="s1">comp_s2 </span><span class="s2">= </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np_scalar</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">comp_s2_list </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">scalar</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a_lst</span><span class="s2">]</span>

        <span class="s6"># Sequence: Binary, Scalar1 and Scalar2</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">comp_b</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">comp_b_list</span><span class="s2">,</span>
            <span class="s4">f&quot;Failed comparison (</span><span class="s0">{</span><span class="s1">py_comp</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">)&quot;</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">comp_s1</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">comp_s1_list</span><span class="s2">,</span>
            <span class="s4">f&quot;Failed comparison (</span><span class="s0">{</span><span class="s1">py_comp</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">)&quot;</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">comp_s2</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">comp_s2_list</span><span class="s2">,</span>
            <span class="s4">f&quot;Failed comparison (</span><span class="s0">{</span><span class="s1">py_comp</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">)&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ignore_object_identity_in_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Check comparing identical objects whose comparison</span>
        <span class="s6"># is not a simple boolean, e.g., arrays that are compared elementwise.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]), </span><span class="s0">None</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s6"># Check error raised when comparing identical non-comparable objects.</span>
        <span class="s0">class </span><span class="s1">FunkyType</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s4">&quot;I won't compare&quot;</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">FunkyType</span><span class="s2">()])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s6"># Check identity doesn't override comparison mismatch.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), [</span><span class="s0">False</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_ignore_object_identity_in_not_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Check comparing identical objects whose comparison</span>
        <span class="s6"># is not a simple boolean, e.g., arrays that are compared elementwise.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]), </span><span class="s0">None</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s6"># Check error raised when comparing identical non-comparable objects.</span>
        <span class="s0">class </span><span class="s1">FunkyType</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s4">&quot;I won't compare&quot;</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">FunkyType</span><span class="s2">()])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s6"># Check identity doesn't override comparison mismatch.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), [</span><span class="s0">True</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_error_in_equal_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gh-20929</span>
        <span class="s6"># make sure np.equal.reduce raises a TypeError if an array is passed</span>
        <span class="s6"># without specifying the dtype</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">), </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">signature</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">&quot;O&quot;</span><span class="s2">)).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span>

    <span class="s0">def </span><span class="s1">test_object_nonbool_dtype_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># bool output dtype is fine of course:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">bool</span>

        <span class="s6"># but the following are examples do not have a loop:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;No loop matching&quot;</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;No loop matching&quot;</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">&quot;l&quot;</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtypes&quot;</span><span class="s2">, [</span><span class="s4">&quot;qQ&quot;</span><span class="s2">, </span><span class="s4">&quot;Qq&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'py_comp, np_comp'</span><span class="s2">, [</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">)</span>
    <span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;vals&quot;</span><span class="s2">, [(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">+</span><span class="s3">1</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_large_integer_direct_comparison</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">py_comp</span><span class="s2">, </span><span class="s1">np_comp</span><span class="s2">, </span><span class="s1">vals</span><span class="s2">):</span>
        <span class="s6"># Note that float(2**60) + 1 == float(2**60).</span>
        <span class="s1">a1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">a2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">**</span><span class="s3">60 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">py_comp</span><span class="s2">(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**</span><span class="s3">60</span><span class="s2">+</span><span class="s3">1</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a2</span><span class="s2">) == </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a2</span><span class="s2">) == </span><span class="s1">expected</span>
        <span class="s6"># Also check the scalars:</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">a1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">a2</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">s2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>
        <span class="s6"># The Python operator here is mainly interesting:</span>
        <span class="s0">assert </span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">) == </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">s2</span><span class="s2">) == </span><span class="s1">expected</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'UnsignedInteger'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'py_comp_func, np_comp_func'</span><span class="s2">, [</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">)</span>
    <span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;flip&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_unsigned_signed_direct_comparison</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">py_comp_func</span><span class="s2">, </span><span class="s1">np_comp_func</span><span class="s2">, </span><span class="s1">flip</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">flip</span><span class="s2">:</span>
            <span class="s1">py_comp </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">: </span><span class="s1">py_comp_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">np_comp </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">: </span><span class="s1">np_comp_func</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">py_comp </span><span class="s2">= </span><span class="s1">py_comp_func</span>
            <span class="s1">np_comp </span><span class="s2">= </span><span class="s1">np_comp_func</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">max</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]), -</span><span class="s3">1</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">) == </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">) == </span><span class="s1">expected</span>

        <span class="s1">scalar </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">scalar</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>
        <span class="s6"># The Python operator here is mainly interesting:</span>
        <span class="s0">assert </span><span class="s1">py_comp</span><span class="s2">(</span><span class="s1">scalar</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">) == </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">np_comp</span><span class="s2">(</span><span class="s1">scalar</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">) == </span><span class="s1">expected</span>


<span class="s0">class </span><span class="s1">TestAdd</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_reduce_alignment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gh-9876</span>
        <span class="s6"># make sure arrays with weird strides work with the optimizations in</span>
        <span class="s6"># pairwise_sum_@TYPE@. On x86, the 'b' field will count as aligned at a</span>
        <span class="s6"># 4 byte offset, even though its itemsize is 8.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)])</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s4">'a'</span><span class="s2">] = -</span><span class="s3">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'b'</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">(), </span><span class="s3">0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDivision</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_division_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># int division should follow Python</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">90</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">, -</span><span class="s3">90</span><span class="s2">, -</span><span class="s3">100</span><span class="s2">, -</span><span class="s3">120</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s3">5 </span><span class="s2">/ </span><span class="s3">10 </span><span class="s2">== </span><span class="s3">0.5</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">/ </span><span class="s3">100</span><span class="s2">, [</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
                                   <span class="s2">-</span><span class="s3">0.05</span><span class="s2">, -</span><span class="s3">0.1</span><span class="s2">, -</span><span class="s3">0.9</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1.2</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">/ </span><span class="s3">100</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">// </span><span class="s3">100</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">% </span><span class="s3">100</span><span class="s2">, [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">90</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">95</span><span class="s2">, </span><span class="s3">90</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">80</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype,ex_val&quot;</span><span class="s2">, </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span>
        <span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'int'</span><span class="s2">] + </span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'uint'</span><span class="s2">], (</span>
            <span class="s2">(</span>
                <span class="s6"># dividend</span>
                <span class="s4">&quot;np.array(range(fo.max-lsize, fo.max)).astype(dtype),&quot;</span>
                <span class="s6"># divisors</span>
                <span class="s4">&quot;np.arange(lsize).astype(dtype),&quot;</span>
                <span class="s6"># scalar divisors</span>
                <span class="s4">&quot;range(15)&quot;</span>
            <span class="s2">),</span>
            <span class="s2">(</span>
                <span class="s6"># dividend</span>
                <span class="s4">&quot;np.arange(fo.min, fo.min+lsize).astype(dtype),&quot;</span>
                <span class="s6"># divisors</span>
                <span class="s4">&quot;np.arange(lsize//-2, lsize//2).astype(dtype),&quot;</span>
                <span class="s6"># scalar divisors</span>
                <span class="s4">&quot;range(fo.min, fo.min + 15)&quot;</span>
            <span class="s2">), (</span>
                <span class="s6"># dividend</span>
                <span class="s4">&quot;np.array(range(fo.max-lsize, fo.max)).astype(dtype),&quot;</span>
                <span class="s6"># divisors</span>
                <span class="s4">&quot;np.arange(lsize).astype(dtype),&quot;</span>
                <span class="s6"># scalar divisors</span>
                <span class="s4">&quot;[1,3,9,13,neg, fo.min+1, fo.min//2, fo.max//3, fo.max//4]&quot;</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_division_int_boundary</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ex_val</span><span class="s2">):</span>
        <span class="s1">fo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">neg </span><span class="s2">= -</span><span class="s3">1 </span><span class="s0">if </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min </span><span class="s2">&lt; </span><span class="s3">0 </span><span class="s0">else </span><span class="s3">1</span>
        <span class="s6"># Large enough to test SIMD loops and remainder elements</span>
        <span class="s1">lsize </span><span class="s2">= </span><span class="s3">512 </span><span class="s2">+ </span><span class="s3">7</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">divisors </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">ex_val</span><span class="s2">)</span>
        <span class="s1">a_lst</span><span class="s2">, </span><span class="s1">b_lst </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">(), </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>

        <span class="s1">c_div </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">n</span><span class="s2">, </span><span class="s1">d</span><span class="s2">: (</span>
            <span class="s3">0 </span><span class="s0">if </span><span class="s1">d </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">else </span><span class="s2">(</span>
                <span class="s1">fo</span><span class="s2">.</span><span class="s1">min </span><span class="s0">if </span><span class="s2">(</span><span class="s1">n </span><span class="s0">and </span><span class="s1">n </span><span class="s2">== </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min </span><span class="s0">and </span><span class="s1">d </span><span class="s2">== -</span><span class="s3">1</span><span class="s2">) </span><span class="s0">else </span><span class="s1">n</span><span class="s2">//</span><span class="s1">d</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">ac </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">ac </span><span class="s2">//= </span><span class="s1">b</span>
            <span class="s1">div_ab </span><span class="s2">= </span><span class="s1">a </span><span class="s2">// </span><span class="s1">b</span>
        <span class="s1">div_lst </span><span class="s2">= [</span><span class="s1">c_div</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">a_lst</span><span class="s2">, </span><span class="s1">b_lst</span><span class="s2">)]</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Integer arrays floor division check (//)&quot;</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">div_ab </span><span class="s2">== </span><span class="s1">div_lst</span><span class="s2">), </span><span class="s1">msg</span>
        <span class="s1">msg_eq </span><span class="s2">= </span><span class="s4">&quot;Integer arrays floor division check (//=)&quot;</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ac </span><span class="s2">== </span><span class="s1">div_lst</span><span class="s2">), </span><span class="s1">msg_eq</span>

        <span class="s0">for </span><span class="s1">divisor </span><span class="s0">in </span><span class="s1">divisors</span><span class="s2">:</span>
            <span class="s1">ac </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">over</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
                <span class="s1">div_a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">// </span><span class="s1">divisor</span>
                <span class="s1">ac </span><span class="s2">//= </span><span class="s1">divisor</span>
            <span class="s1">div_lst </span><span class="s2">= [</span><span class="s1">c_div</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">divisor</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">a_lst</span><span class="s2">]</span>

            <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">div_a </span><span class="s2">== </span><span class="s1">div_lst</span><span class="s2">), </span><span class="s1">msg</span>
            <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ac </span><span class="s2">== </span><span class="s1">div_lst</span><span class="s2">), </span><span class="s1">msg_eq</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s3">0 </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
                <span class="s6"># Verify overflow case</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                        <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divide by zero encountered in floor_divide&quot;</span><span class="s2">):</span>
                    <span class="s1">a </span><span class="s2">// </span><span class="s1">b</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">a </span><span class="s2">// </span><span class="s1">b</span>
            <span class="s0">if </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min </span><span class="s0">and </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min </span><span class="s0">in </span><span class="s1">a</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                        <span class="s1">match</span><span class="s2">=</span><span class="s4">'overflow encountered in floor_divide'</span><span class="s2">):</span>
                    <span class="s1">a </span><span class="s2">// -</span><span class="s3">1</span>
            <span class="s0">elif </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min</span><span class="s2">:</span>
                <span class="s1">a </span><span class="s2">// -</span><span class="s3">1</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                    <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divide by zero encountered in floor_divide&quot;</span><span class="s2">):</span>
                <span class="s1">a </span><span class="s2">// </span><span class="s3">0</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                    <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divide by zero encountered in floor_divide&quot;</span><span class="s2">):</span>
                <span class="s1">ac </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">ac </span><span class="s2">//= </span><span class="s3">0</span>

            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">) // </span><span class="s3">0</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype,ex_val&quot;</span><span class="s2">, </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span>
        <span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'int'</span><span class="s2">] + </span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'uint'</span><span class="s2">], (</span>
            <span class="s4">&quot;np.array([fo.max, 1, 2, 1, 1, 2, 3], dtype=dtype)&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;np.array([fo.min, 1, -2, 1, 1, 2, -3]).astype(dtype)&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;np.arange(fo.min, fo.min+(100*10), 10, dtype=dtype)&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;np.array(range(fo.max-(100*7), fo.max, 7)).astype(dtype)&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_division_int_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">ex_val</span><span class="s2">):</span>
        <span class="s1">fo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">ex_val</span><span class="s2">)</span>
        <span class="s1">lst </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>
        <span class="s1">c_div </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">n</span><span class="s2">, </span><span class="s1">d</span><span class="s2">: (</span>
            <span class="s3">0 </span><span class="s0">if </span><span class="s1">d </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">or </span><span class="s2">(</span><span class="s1">n </span><span class="s0">and </span><span class="s1">n </span><span class="s2">== </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min </span><span class="s0">and </span><span class="s1">d </span><span class="s2">== -</span><span class="s3">1</span><span class="s2">) </span><span class="s0">else </span><span class="s1">n</span><span class="s2">//</span><span class="s1">d</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">div_a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">div_lst </span><span class="s2">= </span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">c_div</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Reduce floor integer division check&quot;</span>
        <span class="s0">assert </span><span class="s1">div_a </span><span class="s2">== </span><span class="s1">div_lst</span><span class="s2">, </span><span class="s1">msg</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                    <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divide by zero encountered in reduce&quot;</span><span class="s2">):</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">100</span><span class="s2">, </span><span class="s3">100</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                        <span class="s1">match</span><span class="s2">=</span><span class="s4">'overflow encountered in reduce'</span><span class="s2">):</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span>
                        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">fo</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
                    <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
            <span class="s4">&quot;dividend,divisor,quotient&quot;</span><span class="s2">,</span>
            <span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'M'</span><span class="s2">), </span><span class="s3">12</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'M'</span><span class="s2">), -</span><span class="s3">12</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'M'</span><span class="s2">), -</span><span class="s3">12</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'M'</span><span class="s2">), </span><span class="s3">12</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'M'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), -</span><span class="s3">1</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">,</span><span class="s4">'M'</span><span class="s2">), </span><span class="s3">0</span><span class="s2">),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), -</span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), -</span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), -</span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), -</span><span class="s3">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">0</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
             <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">), </span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">'Nat'</span><span class="s2">,</span><span class="s4">'Y'</span><span class="s2">)),</span>
            <span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_division_int_timedelta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dividend</span><span class="s2">, </span><span class="s1">divisor</span><span class="s2">, </span><span class="s1">quotient</span><span class="s2">):</span>
        <span class="s6"># If either divisor is 0 or quotient is Nat, check for division by 0</span>
        <span class="s0">if </span><span class="s1">divisor </span><span class="s0">and </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">quotient</span><span class="s2">, </span><span class="s1">int</span><span class="s2">) </span><span class="s0">or not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnat</span><span class="s2">(</span><span class="s1">quotient</span><span class="s2">)):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Timedelta floor division check&quot;</span>
            <span class="s0">assert </span><span class="s1">dividend </span><span class="s2">// </span><span class="s1">divisor </span><span class="s2">== </span><span class="s1">quotient</span><span class="s2">, </span><span class="s1">msg</span>

            <span class="s6"># Test for arrays as well</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Timedelta arrays floor division check&quot;</span>
            <span class="s1">dividend_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">dividend</span><span class="s2">]*</span><span class="s3">5</span><span class="s2">)</span>
            <span class="s1">quotient_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">quotient</span><span class="s2">]*</span><span class="s3">5</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">dividend_array </span><span class="s2">// </span><span class="s1">divisor </span><span class="s2">== </span><span class="s1">quotient_array</span><span class="s2">), </span><span class="s1">msg</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">IS_WASM</span><span class="s2">:</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">):</span>
                    <span class="s1">dividend </span><span class="s2">// </span><span class="s1">divisor</span>

    <span class="s0">def </span><span class="s1">test_division_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check that implementation is correct</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Complex division implementation check&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1. </span><span class="s2">+ </span><span class="s3">1.</span><span class="s2">*</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1. </span><span class="s2">+ </span><span class="s3">.5</span><span class="s2">*</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1. </span><span class="s2">+ </span><span class="s3">2.</span><span class="s2">*</span><span class="s3">1j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">/</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s6"># check overflow, underflow</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Complex division overflow/underflow check&quot;</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.e+110</span><span class="s2">, </span><span class="s3">1.e-110</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">/</span><span class="s1">x</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">/</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_division_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">, </span><span class="s1">divide</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s3">1.0</span><span class="s2">/</span><span class="s1">x</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)/</span><span class="s1">x</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)/</span><span class="s1">x</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)/</span><span class="s1">x</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s3">0.0</span><span class="s2">/</span><span class="s1">x</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_floor_division_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check that floor division, divmod and remainder raises type errors</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">.9 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, -</span><span class="s3">.1 </span><span class="s2">+ </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">.9 </span><span class="s2">+ </span><span class="s3">.5</span><span class="s2">*</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">.9 </span><span class="s2">+ </span><span class="s3">2.</span><span class="s2">*</span><span class="s3">1j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">// </span><span class="s3">7</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">7</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">7</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_floor_division_signed_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Check that the sign bit is correctly set when dividing positive and</span>
        <span class="s6"># negative zero by one.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">x</span><span class="s2">//</span><span class="s3">1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">((-</span><span class="s1">x</span><span class="s2">)//</span><span class="s3">1</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">__config__</span><span class="s2">, </span><span class="s4">&quot;blas_ssl2_info&quot;</span><span class="s2">),</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;gh-22982&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_floor_division_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fzer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">finf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s6"># divide by zero error check</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>

        <span class="s6"># The following already contain a NaN and should not warn</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fzer</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_floor_division_corner_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># test corner cases like 1.0//0.0 for errors and return vals</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fzer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">finf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s4">&quot;invalid value encountered in floor_divide&quot;</span><span class="s2">)</span>
            <span class="s1">div </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
            <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, div: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">div</span><span class="s2">)</span>
            <span class="s1">div </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
            <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, div: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">div</span><span class="s2">)</span>
            <span class="s1">div </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
            <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, div: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">div</span><span class="s2">)</span>
        <span class="s6"># verify 1.0//0.0 computations return inf</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">z</span><span class="s2">).</span><span class="s1">all</span><span class="s2">())</span>

<span class="s0">def </span><span class="s1">floor_divide_and_remainder</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_signs</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'UnsignedInteger'</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s2">(+</span><span class="s3">1</span><span class="s2">,)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">(+</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRemainder</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_remainder_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">] + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s1">floor_divide_and_remainder</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">dt1</span><span class="s2">, </span><span class="s1">dt2 </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">sg1</span><span class="s2">, </span><span class="s1">sg2 </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">_signs</span><span class="s2">(</span><span class="s1">dt1</span><span class="s2">), </span><span class="s1">_signs</span><span class="s2">(</span><span class="s1">dt2</span><span class="s2">)):</span>
                    <span class="s1">fmt </span><span class="s2">= </span><span class="s4">'op: %s, dt1: %s, dt2: %s, sg1: %s, sg2: %s'</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s1">fmt </span><span class="s2">% (</span><span class="s1">op</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">dt1</span><span class="s2">, </span><span class="s1">dt2</span><span class="s2">, </span><span class="s1">sg1</span><span class="s2">, </span><span class="s1">sg2</span><span class="s2">)</span>
                    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sg1</span><span class="s2">*</span><span class="s3">71</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt1</span><span class="s2">)</span>
                    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sg2</span><span class="s2">*</span><span class="s3">19</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt2</span><span class="s2">)</span>
                    <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">div</span><span class="s2">*</span><span class="s1">b </span><span class="s2">+ </span><span class="s1">rem</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">sg2 </span><span class="s2">== -</span><span class="s3">1</span><span class="s2">:</span>
                        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s2">&lt; </span><span class="s1">rem </span><span class="s2">&lt;= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s2">&gt; </span><span class="s1">rem </span><span class="s2">&gt;= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_remainder_exact</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># test that float results are exact for small integers. This also</span>
        <span class="s6"># holds for the same integers scaled by powers of two.</span>
        <span class="s1">nlst </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(-</span><span class="s3">127</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>
        <span class="s1">plst </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">128</span><span class="s2">))</span>
        <span class="s1">dividend </span><span class="s2">= </span><span class="s1">nlst </span><span class="s2">+ [</span><span class="s3">0</span><span class="s2">] + </span><span class="s1">plst</span>
        <span class="s1">divisor </span><span class="s2">= </span><span class="s1">nlst </span><span class="s2">+ </span><span class="s1">plst</span>
        <span class="s1">arg </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">dividend</span><span class="s2">, </span><span class="s1">divisor</span><span class="s2">))</span>
        <span class="s1">tgt </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">divmod</span><span class="s2">(*</span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">arg</span><span class="s2">)</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">).</span><span class="s1">T</span>
        <span class="s6"># convert exact integer results from Python to float so that</span>
        <span class="s6"># signed zero can be used, it is checked.</span>
        <span class="s1">tgtdiv</span><span class="s2">, </span><span class="s1">tgtrem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">tgt</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">T</span>
        <span class="s1">tgtdiv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">((</span><span class="s1">tgtdiv </span><span class="s2">== </span><span class="s3">0.0</span><span class="s2">) &amp; ((</span><span class="s1">b </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">) ^ (</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">)), -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">tgtdiv</span><span class="s2">)</span>
        <span class="s1">tgtrem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">((</span><span class="s1">tgtrem </span><span class="s2">== </span><span class="s3">0.0</span><span class="s2">) &amp; (</span><span class="s1">b </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">), -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">tgtrem</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s1">floor_divide_and_remainder</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">]:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s4">'op: %s, dtype: %s' </span><span class="s2">% (</span><span class="s1">op</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">fa </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">fb </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">fa</span><span class="s2">, </span><span class="s1">fb</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">div</span><span class="s2">, </span><span class="s1">tgtdiv</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">, </span><span class="s1">tgtrem</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_remainder_roundoff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gh-6127</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s1">floor_divide_and_remainder</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">dt1</span><span class="s2">, </span><span class="s1">dt2 </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">sg1</span><span class="s2">, </span><span class="s1">sg2 </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">((+</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), (+</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)):</span>
                    <span class="s1">fmt </span><span class="s2">= </span><span class="s4">'op: %s, dt1: %s, dt2: %s, sg1: %s, sg2: %s'</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s1">fmt </span><span class="s2">% (</span><span class="s1">op</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s1">dt1</span><span class="s2">, </span><span class="s1">dt2</span><span class="s2">, </span><span class="s1">sg1</span><span class="s2">, </span><span class="s1">sg2</span><span class="s2">)</span>
                    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sg1</span><span class="s2">*</span><span class="s3">78</span><span class="s2">*</span><span class="s3">6e-8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt1</span><span class="s2">)</span>
                    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sg2</span><span class="s2">*</span><span class="s3">6e-8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt2</span><span class="s2">)</span>
                    <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
                    <span class="s6"># Equal assertion should hold when fmod is used</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">div</span><span class="s2">*</span><span class="s1">b </span><span class="s2">+ </span><span class="s1">rem</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">sg2 </span><span class="s2">== -</span><span class="s3">1</span><span class="s2">:</span>
                        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s2">&lt; </span><span class="s1">rem </span><span class="s2">&lt;= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s2">&gt; </span><span class="s1">rem </span><span class="s2">&gt;= </span><span class="s3">0</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;darwin&quot;</span><span class="s2">),</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;MacOS seems to not give the correct 'invalid' warning for &quot;</span>
                   <span class="s4">&quot;`fmod`.  Hopefully, others always do.&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_float_divmod_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># Check valid errors raised for divmod and remainder</span>
        <span class="s1">fzero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">finf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s6"># since divmod is combination of both remainder and divide</span>
        <span class="s6"># ops it will set both dividebyzero and invalid flags</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">finf</span><span class="s2">, </span><span class="s1">finf</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s6"># inf / 0 does not set any flags, only the modulo creates a NaN</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">__config__</span><span class="s2">, </span><span class="s4">&quot;blas_ssl2_info&quot;</span><span class="s2">),</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;gh-22982&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;darwin&quot;</span><span class="s2">),</span>
           <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;MacOS seems to not give the correct 'invalid' warning for &quot;</span>
                  <span class="s4">&quot;`fmod`.  Hopefully, others always do.&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'fn'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_float_remainder_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">):</span>
        <span class="s1">fzero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">finf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s6"># The following already contain a NaN and should not warn.</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">,</span>
                    <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;invalid value&quot;</span><span class="s2">):</span>
                <span class="s1">fn</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>
            <span class="s1">fn</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fzero</span><span class="s2">)</span>
            <span class="s1">fn</span><span class="s2">(</span><span class="s1">fzero</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
            <span class="s1">fn</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
            <span class="s1">fn</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_float_remainder_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">tiny</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">div</span><span class="s2">, </span><span class="s1">mod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">mod </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">over</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_divmod_corner_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check nan cases</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">]:</span>
            <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">fzer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">finf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
                <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s4">&quot;invalid value encountered in divmod&quot;</span><span class="s2">)</span>
                <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s4">&quot;divide by zero encountered in divmod&quot;</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">'dt: %s, div: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">fzer</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">finf</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, rem: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, rem: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, rem: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, rem: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s1">div</span><span class="s2">, </span><span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, rem: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>
                <span class="s0">assert</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">div</span><span class="s2">)), </span><span class="s4">&quot;dt: %s, rem: %s&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_remainder_corner_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Check remainder magnitude.</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">]:</span>
            <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">fzer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">), -</span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">rem </span><span class="s2">&lt;= </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'dt: %s' </span><span class="s2">% </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(-</span><span class="s1">a</span><span class="s2">, -</span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">rem </span><span class="s2">&gt;= -</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'dt: %s' </span><span class="s2">% </span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s6"># Check nans, inf</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s4">&quot;invalid value encountered in remainder&quot;</span><span class="s2">)</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s4">&quot;invalid value encountered in fmod&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Float'</span><span class="s2">]:</span>
                <span class="s1">fone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">fzer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">finf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">fnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s6"># MSVC 2008 returns NaN here, so disable the check.</span>
                <span class="s6">#rem = np.remainder(fone, finf)</span>
                <span class="s6">#assert_(rem == fone, 'dt: %s, rem: %s' % (dt, rem))</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
                <span class="s1">fmod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">fmod</span><span class="s2">), </span><span class="s4">'dt: %s, fmod: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">fmod</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">finf</span><span class="s2">)</span>
                <span class="s1">fmod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">fmod</span><span class="s2">), </span><span class="s4">'dt: %s, fmod: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">fmod</span><span class="s2">))</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s1">fmod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">finf</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">fmod</span><span class="s2">), </span><span class="s4">'dt: %s, fmod: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">fmod</span><span class="s2">))</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
                <span class="s1">fmod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">fone</span><span class="s2">, </span><span class="s1">fnan</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">fmod</span><span class="s2">), </span><span class="s4">'dt: %s, fmod: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">fmod</span><span class="s2">))</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s1">fmod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fzer</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">fmod</span><span class="s2">), </span><span class="s4">'dt: %s, fmod: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">rem </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
                <span class="s1">fmod </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">fnan</span><span class="s2">, </span><span class="s1">fone</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">rem</span><span class="s2">), </span><span class="s4">'dt: %s, rem: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">fmod</span><span class="s2">), </span><span class="s4">'dt: %s, fmod: %s' </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">rem</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestDivisionIntegerOverflowsAndDivideByZero</span><span class="s2">:</span>
    <span class="s1">result_type </span><span class="s2">= </span><span class="s1">namedtuple</span><span class="s2">(</span><span class="s4">'result_type'</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s4">'nocast'</span><span class="s2">, </span><span class="s4">'casted'</span><span class="s2">])</span>
    <span class="s1">helper_lambdas </span><span class="s2">= {</span>
        <span class="s4">'zero'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">dtype</span><span class="s2">: </span><span class="s3">0</span><span class="s2">,</span>
        <span class="s4">'min'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">dtype</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">,</span>
        <span class="s4">'neg_min'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">dtype</span><span class="s2">: -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">,</span>
        <span class="s4">'min-zero'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">dtype</span><span class="s2">: (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),</span>
        <span class="s4">'neg_min-zero'</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">dtype</span><span class="s2">: (-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s1">overflow_results </span><span class="s2">= {</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">: </span><span class="s1">result_type</span><span class="s2">(</span>
            <span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'zero'</span><span class="s2">], </span><span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'zero'</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">: </span><span class="s1">result_type</span><span class="s2">(</span>
            <span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'zero'</span><span class="s2">], </span><span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'zero'</span><span class="s2">]),</span>
        <span class="s1">operator</span><span class="s2">.</span><span class="s1">mod</span><span class="s2">: </span><span class="s1">result_type</span><span class="s2">(</span>
            <span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'zero'</span><span class="s2">], </span><span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'zero'</span><span class="s2">]),</span>
        <span class="s1">operator</span><span class="s2">.</span><span class="s1">floordiv</span><span class="s2">: </span><span class="s1">result_type</span><span class="s2">(</span>
            <span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'min'</span><span class="s2">], </span><span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'neg_min'</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">: </span><span class="s1">result_type</span><span class="s2">(</span>
            <span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'min'</span><span class="s2">], </span><span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'neg_min'</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">: </span><span class="s1">result_type</span><span class="s2">(</span>
            <span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'min-zero'</span><span class="s2">], </span><span class="s1">helper_lambdas</span><span class="s2">[</span><span class="s4">'neg_min-zero'</span><span class="s2">])</span>
    <span class="s2">}</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">&quot;Integer&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_signed_division_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">to_check </span><span class="s2">= </span><span class="s1">interesting_binop_operands</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">op1</span><span class="s2">, </span><span class="s1">op2</span><span class="s2">, </span><span class="s1">extractor</span><span class="s2">, </span><span class="s1">operand_identifier </span><span class="s0">in </span><span class="s1">to_check</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;overflow encountered&quot;</span><span class="s2">):</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">op1 </span><span class="s2">// </span><span class="s1">op2</span>

            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span>

            <span class="s6"># Remainder is well defined though, and does not warn:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">op1 </span><span class="s2">% </span><span class="s1">op2</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == </span><span class="s3">0</span>
            <span class="s6"># Check fmod as well:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">(</span><span class="s1">op1</span><span class="s2">, </span><span class="s1">op2</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == </span><span class="s3">0</span>

            <span class="s6"># Divmod warns for the division part:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;overflow encountered&quot;</span><span class="s2">):</span>
                <span class="s1">res1</span><span class="s2">, </span><span class="s1">res2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">op1</span><span class="s2">, </span><span class="s1">op2</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">) == </span><span class="s3">0</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">&quot;AllInteger&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_divide_by_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># Note that the return value cannot be well defined here, but NumPy</span>
        <span class="s6"># currently uses 0 consistently.  This could be changed.</span>
        <span class="s1">to_check </span><span class="s2">= </span><span class="s1">interesting_binop_operands</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">op1</span><span class="s2">, </span><span class="s1">op2</span><span class="s2">, </span><span class="s1">extractor</span><span class="s2">, </span><span class="s1">operand_identifier </span><span class="s0">in </span><span class="s1">to_check</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divide by zero&quot;</span><span class="s2">):</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">op1 </span><span class="s2">// </span><span class="s1">op2</span>

            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == </span><span class="s3">0</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;divide by zero&quot;</span><span class="s2">):</span>
                <span class="s1">res1</span><span class="s2">, </span><span class="s1">res2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">op1</span><span class="s2">, </span><span class="s1">op2</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">op1</span><span class="s2">.</span><span class="s1">dtype</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">) == </span><span class="s3">0</span>
            <span class="s0">assert </span><span class="s1">extractor</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">) == </span><span class="s3">0</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dividend_dtype&quot;</span><span class="s2">, </span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'int'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;divisor_dtype&quot;</span><span class="s2">, </span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'int'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;operation&quot;</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">remainder</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmod</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">,</span>
             <span class="s1">operator</span><span class="s2">.</span><span class="s1">mod</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">floordiv</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'warn'</span><span class="s2">, </span><span class="s1">over</span><span class="s2">=</span><span class="s4">'warn'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_overflows</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dividend_dtype</span><span class="s2">, </span><span class="s1">divisor_dtype</span><span class="s2">, </span><span class="s1">operation</span><span class="s2">):</span>
        <span class="s6"># SIMD tries to perform the operation on as many elements as possible</span>
        <span class="s6"># that is a multiple of the register's size. We resort to the</span>
        <span class="s6"># default implementation for the leftover elements.</span>
        <span class="s6"># We try to cover all paths here.</span>
        <span class="s1">arrays </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dividend_dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">]*</span><span class="s1">i</span><span class="s2">,</span>
                           <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dividend_dtype</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">129</span><span class="s2">)]</span>
        <span class="s1">divisor </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">divisor_dtype</span><span class="s2">)</span>
        <span class="s6"># If dividend is a larger type than the divisor (`else` case),</span>
        <span class="s6"># then, result will be a larger type than dividend and will not</span>
        <span class="s6"># result in an overflow for `divmod` and `floor_divide`.</span>
        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dividend_dtype</span><span class="s2">).</span><span class="s1">itemsize </span><span class="s2">&gt;= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span>
                <span class="s1">divisor_dtype</span><span class="s2">).</span><span class="s1">itemsize </span><span class="s0">and </span><span class="s1">operation </span><span class="s0">in </span><span class="s2">(</span>
                        <span class="s1">np</span><span class="s2">.</span><span class="s1">divmod</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor_divide</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">floordiv</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
                    <span class="s1">RuntimeWarning</span><span class="s2">,</span>
                    <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;overflow encountered in&quot;</span><span class="s2">):</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">operation</span><span class="s2">(</span>
                            <span class="s1">dividend_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dividend_dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">),</span>
                            <span class="s1">divisor_dtype</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">)</span>
                        <span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">overflow_results</span><span class="s2">[</span><span class="s1">operation</span><span class="s2">].</span><span class="s1">nocast</span><span class="s2">(</span>
                        <span class="s1">dividend_dtype</span><span class="s2">)</span>

            <span class="s6"># Arrays</span>
            <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrays</span><span class="s2">:</span>
                <span class="s6"># In case of divmod, we need to flatten the result</span>
                <span class="s6"># column first as we get a column vector of quotient and</span>
                <span class="s6"># remainder and a normal flatten of the expected result.</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
                        <span class="s1">RuntimeWarning</span><span class="s2">,</span>
                        <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;overflow encountered in&quot;</span><span class="s2">):</span>
                    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">operation</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">divisor</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">(</span><span class="s4">'f'</span><span class="s2">)</span>
                    <span class="s1">expected_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                            <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">overflow_results</span><span class="s2">[</span><span class="s1">operation</span><span class="s2">].</span><span class="s1">nocast</span><span class="s2">(</span>
                                <span class="s1">dividend_dtype</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
                    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected_array</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># Scalars</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">operation</span><span class="s2">(</span>
                        <span class="s1">dividend_dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dividend_dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">),</span>
                        <span class="s1">divisor_dtype</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">)</span>
                    <span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">overflow_results</span><span class="s2">[</span><span class="s1">operation</span><span class="s2">].</span><span class="s1">casted</span><span class="s2">(</span>
                    <span class="s1">dividend_dtype</span><span class="s2">)</span>

            <span class="s6"># Arrays</span>
            <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrays</span><span class="s2">:</span>
                <span class="s6"># See above comment on flatten</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">operation</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">divisor</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">(</span><span class="s4">'f'</span><span class="s2">)</span>
                <span class="s1">expected_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                        <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">overflow_results</span><span class="s2">[</span><span class="s1">operation</span><span class="s2">].</span><span class="s1">casted</span><span class="s2">(</span>
                            <span class="s1">dividend_dtype</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected_array</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCbrt</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_cbrt_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(-</span><span class="s3">2.5</span><span class="s2">)**</span><span class="s3">3</span><span class="s2">)), -</span><span class="s3">2.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cbrt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, -</span><span class="s3">3.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">3</span><span class="s2">), </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cbrt</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPower</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_power_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">0</span><span class="s2">, [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">1</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">y </span><span class="s2">**= </span><span class="s3">2</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**(-</span><span class="s3">1</span><span class="s2">), [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">/</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**(</span><span class="s3">0.5</span><span class="s2">), [</span><span class="s3">1.</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)])</span>

        <span class="s0">for </span><span class="s1">out</span><span class="s2">, </span><span class="s1">inp</span><span class="s2">, </span><span class="s1">msg </span><span class="s0">in </span><span class="s1">_gen_alignment_data</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">,</span>
                                                 <span class="s1">type</span><span class="s2">=</span><span class="s4">'unary'</span><span class="s2">,</span>
                                                 <span class="s1">max_size</span><span class="s2">=</span><span class="s3">11</span><span class="s2">):</span>
            <span class="s1">exp </span><span class="s2">= [</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">inp</span><span class="s2">]</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">**(</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">out</span><span class="s2">, </span><span class="s1">inp</span><span class="s2">, </span><span class="s1">msg </span><span class="s0">in </span><span class="s1">_gen_alignment_data</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
                                                 <span class="s1">type</span><span class="s2">=</span><span class="s4">'unary'</span><span class="s2">,</span>
                                                 <span class="s1">max_size</span><span class="s2">=</span><span class="s3">7</span><span class="s2">):</span>
            <span class="s1">exp </span><span class="s2">= [</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">inp</span><span class="s2">]</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">**(</span><span class="s3">0.5</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_power_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">, </span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">0</span><span class="s2">, [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">1</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, [-</span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">+</span><span class="s3">12j</span><span class="s2">, -</span><span class="s3">7</span><span class="s2">+</span><span class="s3">24j</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">3</span><span class="s2">, [(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">)**</span><span class="s3">3</span><span class="s2">, (</span><span class="s3">2</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">)**</span><span class="s3">3</span><span class="s2">, (</span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">)**</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">4</span><span class="s2">, [(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">)**</span><span class="s3">4</span><span class="s2">, (</span><span class="s3">2</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">)**</span><span class="s3">4</span><span class="s2">, (</span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">)**</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**(-</span><span class="s3">1</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">/(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">), </span><span class="s3">1</span><span class="s2">/(</span><span class="s3">2</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">), </span><span class="s3">1</span><span class="s2">/(</span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">)])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**(-</span><span class="s3">2</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">/(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">/(</span><span class="s3">2</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">/(</span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**(-</span><span class="s3">3</span><span class="s2">), [(-</span><span class="s3">11</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">)/</span><span class="s3">125</span><span class="s2">, (-</span><span class="s3">46</span><span class="s2">-</span><span class="s3">9j</span><span class="s2">)/</span><span class="s3">2197</span><span class="s2">,</span>
                                      <span class="s2">(-</span><span class="s3">117</span><span class="s2">-</span><span class="s3">44j</span><span class="s2">)/</span><span class="s3">15625</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**(</span><span class="s3">0.5</span><span class="s2">), [</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">2j</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">),</span>
                                       <span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">3</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">)])</span>
        <span class="s1">norm </span><span class="s2">= </span><span class="s3">1.</span><span class="s2">/((</span><span class="s1">x</span><span class="s2">**</span><span class="s3">14</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">14 </span><span class="s2">* </span><span class="s1">norm</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s1">norm </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[-</span><span class="s3">76443</span><span class="s2">+</span><span class="s3">16124j</span><span class="s2">, </span><span class="s3">23161315</span><span class="s2">+</span><span class="s3">58317492j</span><span class="s2">,</span>
                                    <span class="s3">5583548873 </span><span class="s2">+ </span><span class="s3">2465133864j</span><span class="s2">]])</span>

        <span class="s6"># Ticket #836</span>
        <span class="s0">def </span><span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">z </span><span class="s0">in </span><span class="s2">[</span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)]:</span>
            <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">z</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
                <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">**</span><span class="s3">1</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
                <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, </span><span class="s1">z</span><span class="s2">*</span><span class="s1">z</span><span class="s2">)</span>
                <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">**</span><span class="s3">3</span><span class="s2">, </span><span class="s1">z</span><span class="s2">*</span><span class="s1">z</span><span class="s2">*</span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_power_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># ticket #1271</span>
        <span class="s1">zero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0j</span><span class="s2">])</span>
        <span class="s1">one </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">+</span><span class="s3">0j</span><span class="s2">])</span>
        <span class="s1">cnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)])</span>
        <span class="s6"># FIXME cinf not tested.</span>
        <span class="s6">#cinf = np.array([complex(np.inf, 0)])</span>

        <span class="s0">def </span><span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)</span>

        <span class="s6"># positive powers</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0.33</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6.6</span><span class="s2">]:</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s1">zero</span><span class="s2">)</span>

        <span class="s6"># zero power</span>
        <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">one</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">0</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>

            <span class="s6"># negative power</span>
            <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0.33</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6.6</span><span class="s2">]:</span>
                <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, -</span><span class="s1">p</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">+</span><span class="s3">0.2j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_zero_power_nonzero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Testing 0^{Non-zero} issue 18378</span>
        <span class="s1">zero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">+</span><span class="s3">0.0j</span><span class="s2">])</span>
        <span class="s1">cnan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)])</span>

        <span class="s0">def </span><span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)</span>

        <span class="s6">#Complex powers with positive real part will not generate a warning</span>
        <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">1</span><span class="s2">+</span><span class="s3">4j</span><span class="s2">), </span><span class="s1">zero</span><span class="s2">)</span>
        <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">2</span><span class="s2">-</span><span class="s3">3j</span><span class="s2">), </span><span class="s1">zero</span><span class="s2">)</span>
        <span class="s6">#Testing zero values when real part is greater than zero</span>
        <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">1</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">zero</span><span class="s2">)</span>
        <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">1</span><span class="s2">+</span><span class="s3">0j</span><span class="s2">), </span><span class="s1">zero</span><span class="s2">)</span>
        <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">1</span><span class="s2">-</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">zero</span><span class="s2">)</span>
        <span class="s6">#Complex powers will negative real part or 0 (provided imaginary</span>
        <span class="s6"># part is not zero) will generate a NAN and hence a RUNTIME warning</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">expected_warning</span><span class="s2">=</span><span class="s1">RuntimeWarning</span><span class="s2">) </span><span class="s0">as </span><span class="s1">r</span><span class="s2">:</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">-</span><span class="s3">3j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, -</span><span class="s3">7</span><span class="s2">+</span><span class="s3">0j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">0</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>
            <span class="s1">assert_complex_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">zero</span><span class="s2">, </span><span class="s3">0</span><span class="s2">-</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">cnan</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">r</span><span class="s2">) == </span><span class="s3">5</span>

    <span class="s0">def </span><span class="s1">test_fast_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s3">2.0</span>
        <span class="s1">assert_</span><span class="s2">((</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2.00001</span><span class="s2">).</span><span class="s1">dtype </span><span class="s0">is </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">9</span><span class="s2">])</span>
        <span class="s6"># check the inplace operation on the casted copy doesn't mess with x</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">may_share_memory</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

        <span class="s6"># Check that the fast path ignores 1-element not 0-d arrays</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">x </span><span class="s2">** </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[[</span><span class="s3">2</span><span class="s2">]]])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_integer_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">15</span><span class="s2">, </span><span class="s3">15</span><span class="s2">], </span><span class="s4">'i8'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s3">437893890380859375</span><span class="s2">, </span><span class="s3">437893890380859375</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_integer_power_with_integer_zero_exponent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Integer'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

        <span class="s1">dtypes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'UnsignedInteger'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_integer_power_of_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_integer_power_of_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_integer_to_negative_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'Integer'</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">one </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">minusone </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">minusone</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">one</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">one</span><span class="s2">, </span><span class="s1">minusone</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_to_inf_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                                <span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_power_fast_paths</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gh-26055</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">12e12</span><span class="s2">, -</span><span class="s3">10.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.21</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">1.44e+26</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">)</span>
            <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">12e12</span><span class="s2">], </span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">)</span>
            <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFloat_power</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_type_conversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arg_type </span><span class="s2">= </span><span class="s4">'?bhilBHILefdgFDG'</span>
        <span class="s1">res_type </span><span class="s2">= </span><span class="s4">'ddddddddddddgDDG'</span>
        <span class="s0">for </span><span class="s1">dtin</span><span class="s2">, </span><span class="s1">dtout </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">arg_type</span><span class="s2">, </span><span class="s1">res_type</span><span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dtin: %s, dtout: %s&quot; </span><span class="s2">% (</span><span class="s1">dtin</span><span class="s2">, </span><span class="s1">dtout</span><span class="s2">)</span>
            <span class="s1">arg </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtin</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float_power</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">arg</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtout</span><span class="s2">).</span><span class="s1">name</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLog2</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dt'</span><span class="s2">, [</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_log2_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">256</span><span class="s2">, </span><span class="s3">512</span><span class="s2">, </span><span class="s3">1024</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]</span>
        <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">xf</span><span class="s2">), </span><span class="s1">yf</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;i&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">65</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_log2_ints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">i</span><span class="s2">):</span>
        <span class="s6"># a good log2 implementation should provide this,</span>
        <span class="s6"># might fail on OS with bad libm</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">**</span><span class="s1">i</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">'at exponent %d' </span><span class="s2">% </span><span class="s1">i</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_log2_special</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">), </span><span class="s3">0.</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>

        <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">w</span><span class="s2">:</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">'always'</span><span class="s2">, </span><span class="s4">''</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">)))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">category </span><span class="s0">is </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">category </span><span class="s0">is </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s3">2</span><span class="s2">].</span><span class="s1">category </span><span class="s0">is </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestExp2</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_exp2_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">256</span><span class="s2">, </span><span class="s3">512</span><span class="s2">, </span><span class="s3">1024</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp2</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLogAddExp2</span><span class="s2">(</span><span class="s1">_FilterInvalids</span><span class="s2">):</span>
    <span class="s6"># Need test for intermediate precisions</span>
    <span class="s0">def </span><span class="s1">test_logaddexp2_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">z </span><span class="s2">= [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">dec_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">15</span><span class="s2">]):</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s1">zf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">xf</span><span class="s2">, </span><span class="s1">yf</span><span class="s2">), </span><span class="s1">zf</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">dec_</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logaddexp2_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1000000</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">, </span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000200</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000200</span><span class="s2">, </span><span class="s3">1000000</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">]</span>
        <span class="s1">z </span><span class="s2">= [</span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">, </span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
            <span class="s1">logxf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">logyf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">logzf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">logxf</span><span class="s2">, </span><span class="s1">logyf</span><span class="s2">), </span><span class="s1">logzf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">inf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,  -</span><span class="s1">inf</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,   </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,   -</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">z </span><span class="s2">= [</span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,    </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">logxf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">logyf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">logzf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">logxf</span><span class="s2">, </span><span class="s1">logyf</span><span class="s2">), </span><span class="s1">logzf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([]), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp2</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]), </span><span class="s3">0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLog</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_log_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">256</span><span class="s2">, </span><span class="s3">512</span><span class="s2">, </span><span class="s3">1024</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
            <span class="s1">log2_ </span><span class="s2">= </span><span class="s3">0.69314718055994530943</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)*</span><span class="s1">log2_</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">xf</span><span class="s2">), </span><span class="s1">yf</span><span class="s2">)</span>

        <span class="s6"># test aliasing(issue #17761)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.937500</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0.947500</span><span class="s2">, </span><span class="s3">1.054697</span><span class="s2">])</span>
        <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">x</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log_values_maxofdtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># test log() of max for dtype does not raise</span>
        <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]</span>
        <span class="s6"># This is failing at least on linux aarch64 (see gh-25460), and on most</span>
        <span class="s6"># other non x86-64 platforms checking `longdouble` isn't too useful as</span>
        <span class="s6"># it's an alias for float64.</span>
        <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'x86_64'</span><span class="s2">:</span>
            <span class="s1">dtypes </span><span class="s2">+= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">strides </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4</span><span class="s2">,-</span><span class="s3">3</span><span class="s2">,-</span><span class="s3">2</span><span class="s2">,-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">sizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s3">100</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ii </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s1">x_f64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s3">100.0</span><span class="s2">,</span><span class="s1">size</span><span class="s2">=</span><span class="s1">ii</span><span class="s2">))</span>
            <span class="s1">x_special </span><span class="s2">= </span><span class="s1">x_f64</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">x_special</span><span class="s2">[</span><span class="s3">3</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">:</span><span class="s3">4</span><span class="s2">] = </span><span class="s3">1.0</span>
            <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)</span>
            <span class="s1">y_special </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_special</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">jj </span><span class="s0">in </span><span class="s1">strides</span><span class="s2">:</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">y_true</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_special</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">y_special</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s6"># Reference values were computed with mpmath, with mp.dps = 200.</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">'z, wref'</span><span class="s2">,</span>
        <span class="s2">[(</span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1e-12j</span><span class="s2">, </span><span class="s3">5e-25 </span><span class="s2">+ </span><span class="s3">1e-12j</span><span class="s2">),</span>
         <span class="s2">(</span><span class="s3">1.000000000000001 </span><span class="s2">+ </span><span class="s3">3e-08j</span><span class="s2">,</span>
          <span class="s3">1.5602230246251546e-15 </span><span class="s2">+ </span><span class="s3">2.999999999999996e-08j</span><span class="s2">),</span>
         <span class="s2">(</span><span class="s3">0.9999995000000417 </span><span class="s2">+ </span><span class="s3">0.0009999998333333417j</span><span class="s2">,</span>
          <span class="s3">7.831475869017683e-18 </span><span class="s2">+ </span><span class="s3">0.001j</span><span class="s2">),</span>
         <span class="s2">(</span><span class="s3">0.9999999999999996 </span><span class="s2">+ </span><span class="s3">2.999999999999999e-08j</span><span class="s2">,</span>
          <span class="s3">5.9107901499372034e-18 </span><span class="s2">+ </span><span class="s3">3e-08j</span><span class="s2">),</span>
         <span class="s2">(</span><span class="s3">0.99995000042 </span><span class="s2">- </span><span class="s3">0.009999833j</span><span class="s2">,</span>
          <span class="s2">-</span><span class="s3">7.015159763822903e-15 </span><span class="s2">- </span><span class="s3">0.009999999665816696j</span><span class="s2">)],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_log_precision_float64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">wref</span><span class="s2">):</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">wref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">)</span>

    <span class="s6"># Reference values were computed with mpmath, with mp.dps = 200.</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">'z, wref'</span><span class="s2">,</span>
        <span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(</span><span class="s3">1.0 </span><span class="s2">+ </span><span class="s3">3e-6j</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(</span><span class="s3">4.5e-12</span><span class="s2">+</span><span class="s3">3e-06j</span><span class="s2">)),</span>
         <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(</span><span class="s3">1.0 </span><span class="s2">- </span><span class="s3">2e-5j</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(</span><span class="s3">1.9999999e-10 </span><span class="s2">- </span><span class="s3">2e-5j</span><span class="s2">)),</span>
         <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(</span><span class="s3">0.9999999 </span><span class="s2">+ </span><span class="s3">1e-06j</span><span class="s2">),</span>
          <span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(-</span><span class="s3">1.192088e-07</span><span class="s2">+</span><span class="s3">1.0000001e-06j</span><span class="s2">))],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_log_precision_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">wref</span><span class="s2">):</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">wref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-6</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestExp</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_exp_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">256</span><span class="s2">, </span><span class="s3">512</span><span class="s2">, </span><span class="s3">1024</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
            <span class="s1">log2_ </span><span class="s2">= </span><span class="s3">0.69314718055994530943</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)*</span><span class="s1">log2_</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_exp_strides</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">strides </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4</span><span class="s2">,-</span><span class="s3">3</span><span class="s2">,-</span><span class="s3">2</span><span class="s2">,-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">sizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s3">100</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ii </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s1">x_f64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s3">709.1</span><span class="s2">,</span><span class="s1">size</span><span class="s2">=</span><span class="s1">ii</span><span class="s2">))</span>
            <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">jj </span><span class="s0">in </span><span class="s1">strides</span><span class="s2">:</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">y_true</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestSpecialFloats</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_exp_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">under</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">]</span>
            <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

    <span class="s6"># See: https://github.com/numpy/numpy/issues/19192</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
        <span class="s1">_glibc_older_than</span><span class="s2">(</span><span class="s4">&quot;2.17&quot;</span><span class="s2">),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Older glibc versions may not raise appropriate FP exceptions&quot;</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_exp_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">11.0899</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">100.</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">1E19</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">800.</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">1E19</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">under</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(-</span><span class="s3">17.5</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(-</span><span class="s3">1000.</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(-</span><span class="s3">1E19</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(-</span><span class="s3">1000.</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(-</span><span class="s3">1E19</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_log_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">]</span>
            <span class="s1">y1p </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">2.0</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">yf1p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y1p</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">yf1p</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s6"># See https://github.com/numpy/numpy/issues/18005</span>
        <span class="s0">with </span><span class="s1">assert_no_warnings</span><span class="s2">():</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1e9</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'float32'</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sincos_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;darwin&quot;</span><span class="s2">),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;underflow is triggered for scalar 'sin'&quot;</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_sincos_underflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">under</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">underflow_trigger </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                <span class="s1">float</span><span class="s2">.</span><span class="s1">fromhex</span><span class="s2">(</span><span class="s4">&quot;0x1.f37f47a03f82ap-511&quot;</span><span class="s2">),</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
            <span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">underflow_trigger</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">underflow_trigger</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'callable'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'value'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sincos_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callable</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">callable</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">value</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'callable'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'stride'</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sincos_overlaps</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callable</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">stride</span><span class="s2">):</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">100</span>
        <span class="s1">M </span><span class="s2">= </span><span class="s1">N </span><span class="s2">// </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">stride</span><span class="s2">)</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">callable</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">x</span><span class="s2">[:</span><span class="s1">M</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:</span><span class="s1">M</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dt'</span><span class="s2">, [</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sqrt_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">]</span>
            <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">]</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

        <span class="s6"># with np.errstate(invalid='raise'):</span>
        <span class="s6">#     assert_raises(</span>
        <span class="s6">#         FloatingPointError, np.sqrt, np.array(-100., dtype=dt)</span>
        <span class="s6">#     )</span>

    <span class="s0">def </span><span class="s1">test_abs_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, -</span><span class="s3">0.</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_square_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">square</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">square</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1E3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'e'</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">square</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1E32</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">square</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1E200</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'d'</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_reciprocal_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s1">y </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, -</span><span class="s3">0.</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">(</span><span class="s1">yf</span><span class="s2">), </span><span class="s1">xf</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_tan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tan</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tan</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
                <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tan</span><span class="s2">,</span>
                              <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_arcsincos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">callable </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, -</span><span class="s3">2.0</span><span class="s2">]:</span>
                <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">callable</span><span class="s2">,</span>
                                      <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_arctan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_sinh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
            <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sinh</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sinh</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">12.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'e'</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sinh</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">120.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sinh</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1200.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'d'</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s4">'bsd' </span><span class="s0">in </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fallback implementation may not raise, see gh-2487&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_cosh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
            <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cosh</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cosh</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">12.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'e'</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cosh</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">120.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">))</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cosh</span><span class="s2">,</span>
                          <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1200.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'d'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_tanh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
            <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tanh</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arcsinh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
            <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_arccosh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0.0</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">,</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_arctanh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1.01</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">,</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s6"># Make sure glibc &lt; 2.18 atanh is not used, issue 25087</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">(-</span><span class="s3">1j</span><span class="s2">).</span><span class="s1">real</span><span class="s2">)</span>

    <span class="s6"># See: https://github.com/numpy/numpy/issues/20448</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
        <span class="s1">_glibc_older_than</span><span class="s2">(</span><span class="s4">&quot;2.17&quot;</span><span class="s2">),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Older glibc versions may not raise appropriate FP exceptions&quot;</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_exp2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp2</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s2">[</span><span class="s3">2000.0</span><span class="s2">, -</span><span class="s3">2000.0</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">, </span><span class="s1">under</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp2</span><span class="s2">,</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;fp errors don't work in wasm&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_expm1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">in_ </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">]:</span>
                <span class="s1">in_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">in_</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">out_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">in_arr</span><span class="s2">), </span><span class="s1">out_arr</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s2">[</span><span class="s3">200.0</span><span class="s2">, </span><span class="s3">2000.0</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">]:</span>
                    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">FloatingPointError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">,</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s6"># test to ensure no spurious FP exceptions are raised due to SIMD</span>
    <span class="s1">INF_INVALID_ERR </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span>
    <span class="s2">]</span>
    <span class="s1">NEG_INVALID_ERR </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span>
    <span class="s2">]</span>
    <span class="s1">ONE_INVALID_ERR </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">LTONE_INVALID_ERR </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">BYZERO_ERR </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">reciprocal</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span>
    <span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;ufunc&quot;</span><span class="s2">, </span><span class="s1">UFUNCS_UNARY_FP</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;data, escape&quot;</span><span class="s2">, (</span>
        <span class="s2">([</span><span class="s3">0.03</span><span class="s2">], </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s3">0.03</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s6"># neg</span>
        <span class="s2">([-</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">NEG_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s3">1.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">NEG_INVALID_ERR</span><span class="s2">),</span>
        <span class="s6"># flat</span>
        <span class="s2">([</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">ONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s3">1.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">ONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s6"># zero</span>
        <span class="s2">([</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">BYZERO_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s3">0.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">BYZERO_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">BYZERO_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s3">0.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">BYZERO_ERR</span><span class="s2">),</span>
        <span class="s6"># nan</span>
        <span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">ONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">ONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], []),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, []),</span>
        <span class="s6"># inf</span>
        <span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">INF_INVALID_ERR </span><span class="s2">+ </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">INF_INVALID_ERR </span><span class="s2">+ </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s6"># ninf</span>
        <span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">],</span>
         <span class="s1">NEG_INVALID_ERR </span><span class="s2">+ </span><span class="s1">INF_INVALID_ERR </span><span class="s2">+ </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">,</span>
         <span class="s1">NEG_INVALID_ERR </span><span class="s2">+ </span><span class="s1">INF_INVALID_ERR </span><span class="s2">+ </span><span class="s1">LTONE_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">NEG_INVALID_ERR </span><span class="s2">+ </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">NEG_INVALID_ERR </span><span class="s2">+ </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">NEG_INVALID_ERR </span><span class="s2">+ </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
        <span class="s2">([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]*</span><span class="s3">32</span><span class="s2">, </span><span class="s1">NEG_INVALID_ERR </span><span class="s2">+ </span><span class="s1">INF_INVALID_ERR</span><span class="s2">),</span>
    <span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_unary_spurious_fpexception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">escape</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">escape </span><span class="s0">and </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s1">escape</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s6"># FIXME: NAN raises FP invalid exception:</span>
        <span class="s6">#  - ceil/float16 on MSVC:32-bit</span>
        <span class="s6">#  - spacing/float16 on almost all platforms</span>
        <span class="s0">if </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">) </span><span class="s0">and </span><span class="s1">dtype </span><span class="s2">== </span><span class="s4">'e'</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_no_warnings</span><span class="s2">():</span>
            <span class="s1">ufunc</span><span class="s2">(</span><span class="s1">array</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s4">'e'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_divide_spurious_fpexception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">dt_info </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">subnorm </span><span class="s2">= </span><span class="s1">dt_info</span><span class="s2">.</span><span class="s1">smallest_subnormal</span>
        <span class="s6"># Verify a bug fix caused due to filling the remaining lanes of the</span>
        <span class="s6"># partially loaded dividend SIMD vector with ones, which leads to</span>
        <span class="s6"># raising an overflow warning when the divisor is denormal.</span>
        <span class="s6"># see https://github.com/numpy/numpy/issues/25097</span>
        <span class="s0">with </span><span class="s1">assert_no_warnings</span><span class="s2">():</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">128 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">) / </span><span class="s1">subnorm</span>

<span class="s0">class </span><span class="s1">TestFPClass</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;stride&quot;</span><span class="s2">, [-</span><span class="s3">5</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
                                <span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_fpclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">stride</span><span class="s2">):</span>
        <span class="s1">arr_f64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.2251e-308</span><span class="s2">, -</span><span class="s3">2.2251e-308</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'d'</span><span class="s2">)</span>
        <span class="s1">arr_f32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.4013e-045</span><span class="s2">, -</span><span class="s3">1.4013e-045</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f'</span><span class="s2">)</span>
        <span class="s1">nan     </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">inf     </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">sign    </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">finite  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">arr_f32</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">nan</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">arr_f64</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">nan</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">arr_f32</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">inf</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">arr_f64</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">inf</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'riscv64'</span><span class="s2">:</span>
            <span class="s6"># On RISC-V, many operations that produce NaNs, such as converting</span>
            <span class="s6"># a -NaN from f64 to f32, return a canonical NaN.  The canonical</span>
            <span class="s6"># NaNs are always positive.  See section 11.3 NaN Generation and</span>
            <span class="s6"># Propagation of the RISC-V Unprivileged ISA for more details.</span>
            <span class="s6"># We disable the sign test on riscv64 for -np.nan as we</span>
            <span class="s6"># cannot assume that its sign will be honoured in these tests.</span>
            <span class="s1">arr_f64_rv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">arr_f64</span><span class="s2">)</span>
            <span class="s1">arr_f32_rv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">arr_f32</span><span class="s2">)</span>
            <span class="s1">arr_f64_rv</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = -</span><span class="s3">1.0</span>
            <span class="s1">arr_f32_rv</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = -</span><span class="s3">1.0</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">arr_f32_rv</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">sign</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">arr_f64_rv</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">sign</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">arr_f32</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">sign</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">arr_f64</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">sign</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">arr_f32</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">finite</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">arr_f64</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">finite</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_fp_noncontiguous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">,</span>
                            <span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.2251e-308</span><span class="s2">,</span>
                            <span class="s2">-</span><span class="s3">2.2251e-308</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">,</span>
                            <span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">inf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">,</span>
                            <span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">sign </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">,</span>
                            <span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">finite </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">,</span>
                            <span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'bool'</span><span class="s2">)</span>
        <span class="s1">ncontig_in </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">ncontig_out </span><span class="s2">= </span><span class="s1">out</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">contig_in </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'riscv64'</span><span class="s2">:</span>
            <span class="s6"># Disable the -np.nan signbit tests on riscv64.  See comments in</span>
            <span class="s6"># test_fpclass for more details.</span>
            <span class="s1">data_rv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s1">data_rv</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = -</span><span class="s3">1.0</span>
            <span class="s1">ncontig_sign_in </span><span class="s2">= </span><span class="s1">data_rv</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">]</span>
            <span class="s1">contig_sign_in </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">ncontig_sign_in</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ncontig_sign_in </span><span class="s2">= </span><span class="s1">ncontig_in</span>
            <span class="s1">contig_sign_in </span><span class="s2">= </span><span class="s1">contig_in</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncontig_out</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">contig_in</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncontig_sign_in</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">contig_sign_in</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s6"># ncontig in, ncontig out</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">nan</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">inf</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">ncontig_sign_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">sign</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">finite</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s6"># contig in, ncontig out</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">contig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">nan</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">contig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">inf</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">contig_sign_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">sign</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">contig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">), </span><span class="s1">finite</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s6"># ncontig in, contig out</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">), </span><span class="s1">nan</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">), </span><span class="s1">inf</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">ncontig_sign_in</span><span class="s2">), </span><span class="s1">sign</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">), </span><span class="s1">finite</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s6"># contig in, contig out, nd stride</span>
        <span class="s1">data_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">nan_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">inf_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">sign_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">sign</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">finite_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">finite</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">data_split</span><span class="s2">), </span><span class="s1">nan_split</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">data_split</span><span class="s2">), </span><span class="s1">inf_split</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'riscv64'</span><span class="s2">:</span>
            <span class="s1">data_split_rv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">data_rv</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">data_split_rv</span><span class="s2">), </span><span class="s1">sign_split</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">data_split</span><span class="s2">), </span><span class="s1">sign_split</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">data_split</span><span class="s2">), </span><span class="s1">finite_split</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestLDExp</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;stride&quot;</span><span class="s2">, [-</span><span class="s3">4</span><span class="s2">,-</span><span class="s3">2</span><span class="s2">,-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">4</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_ldexp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">stride</span><span class="s2">):</span>
        <span class="s1">mant </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.125</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">8.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">exp  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i'</span><span class="s2">)</span>
        <span class="s1">out  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s1">mant</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">exp</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)[::</span><span class="s1">stride</span><span class="s2">])</span>

<span class="s0">class </span><span class="s1">TestFRExp</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;stride&quot;</span><span class="s2">, [-</span><span class="s3">4</span><span class="s2">,-</span><span class="s3">2</span><span class="s2">,-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">4</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'linux'</span><span class="s2">),</span>
                        <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;np.frexp gives different answers for NAN/INF on windows and linux&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">IS_MUSL</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;gh23049&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_frexp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">stride</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">mant_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">exp_true  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i'</span><span class="s2">)</span>
        <span class="s1">out_mant  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">out_exp   </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i'</span><span class="s2">)</span>
        <span class="s1">mant</span><span class="s2">, </span><span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">out_mant</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">out_exp</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mant_true</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">mant</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">exp_true</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out_mant</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">mant_true</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out_exp</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">], </span><span class="s1">exp_true</span><span class="s2">[::</span><span class="s1">stride</span><span class="s2">])</span>

<span class="s6"># func : [maxulperror, low, high]</span>
<span class="s1">avx_ufuncs </span><span class="s2">= {</span><span class="s4">'sqrt'        </span><span class="s2">:[</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">0.</span><span class="s2">,   </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'absolute'    </span><span class="s2">:[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">100.</span><span class="s2">, </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'reciprocal'  </span><span class="s2">:[</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1.</span><span class="s2">,   </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'square'      </span><span class="s2">:[</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">100.</span><span class="s2">, </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'rint'        </span><span class="s2">:[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">100.</span><span class="s2">, </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'floor'       </span><span class="s2">:[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">100.</span><span class="s2">, </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'ceil'        </span><span class="s2">:[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">100.</span><span class="s2">, </span><span class="s3">100.</span><span class="s2">],</span>
              <span class="s4">'trunc'       </span><span class="s2">:[</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">100.</span><span class="s2">, </span><span class="s3">100.</span><span class="s2">]}</span>

<span class="s0">class </span><span class="s1">TestAVXUfuncs</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_avx_based_ufunc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">strides </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4</span><span class="s2">,-</span><span class="s3">3</span><span class="s2">,-</span><span class="s3">2</span><span class="s2">,-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">func</span><span class="s2">, </span><span class="s1">prop </span><span class="s0">in </span><span class="s1">avx_ufuncs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">maxulperr </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">minval </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">maxval </span><span class="s2">= </span><span class="s1">prop</span><span class="s2">[</span><span class="s3">2</span><span class="s2">]</span>
            <span class="s6"># various array sizes to ensure masking in AVX is tested</span>
            <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">,</span><span class="s3">32</span><span class="s2">):</span>
                <span class="s1">myfunc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)</span>
                <span class="s1">x_f32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s1">minval</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s1">maxval</span><span class="s2">,</span>
                                          <span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
                <span class="s1">x_f64 </span><span class="s2">= </span><span class="s1">x_f32</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
                <span class="s1">x_f128 </span><span class="s2">= </span><span class="s1">x_f32</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">)</span>
                <span class="s1">y_true128 </span><span class="s2">= </span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f128</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">maxulperr </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">), </span><span class="s1">y_true128</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">), </span><span class="s1">y_true128</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">),</span>
                                         <span class="s1">y_true128</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
                                         <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulperr</span><span class="s2">)</span>
                    <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">),</span>
                                         <span class="s1">y_true128</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                                         <span class="s1">maxulp</span><span class="s2">=</span><span class="s1">maxulperr</span><span class="s2">)</span>
                <span class="s6"># various strides to test gather instruction</span>
                <span class="s0">if </span><span class="s1">size </span><span class="s2">&gt; </span><span class="s3">1</span><span class="s2">:</span>
                    <span class="s1">y_true32 </span><span class="s2">= </span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">)</span>
                    <span class="s1">y_true64 </span><span class="s2">= </span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">jj </span><span class="s0">in </span><span class="s1">strides</span><span class="s2">:</span>
                        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">y_true64</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">])</span>
                        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">myfunc</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">y_true32</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">])</span>

<span class="s0">class </span><span class="s1">TestAVXFloat32Transcendental</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_exp_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">x_f32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">0.0</span><span class="s2">,</span><span class="s1">high</span><span class="s2">=</span><span class="s3">88.1</span><span class="s2">,</span><span class="s1">size</span><span class="s2">=</span><span class="s3">1000000</span><span class="s2">))</span>
        <span class="s1">x_f64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_log_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">x_f32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">0.0</span><span class="s2">,</span><span class="s1">high</span><span class="s2">=</span><span class="s3">1000</span><span class="s2">,</span><span class="s1">size</span><span class="s2">=</span><span class="s3">1000000</span><span class="s2">))</span>
        <span class="s1">x_f64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sincos_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s3">1000000</span>
        <span class="s1">M </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int_</span><span class="s2">(</span><span class="s1">N</span><span class="s2">/</span><span class="s3">20</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s1">N</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">M</span><span class="s2">)</span>
        <span class="s1">x_f32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=-</span><span class="s3">100.</span><span class="s2">,</span><span class="s1">high</span><span class="s2">=</span><span class="s3">100.</span><span class="s2">,</span><span class="s1">size</span><span class="s2">=</span><span class="s1">N</span><span class="s2">))</span>
        <span class="s0">if not </span><span class="s1">_glibc_older_than</span><span class="s2">(</span><span class="s4">&quot;2.17&quot;</span><span class="s2">):</span>
            <span class="s6"># test coverage for elements &gt; 117435.992f for which glibc is used</span>
            <span class="s6"># this is known to be problematic on old glibc, so skip it there</span>
            <span class="s1">x_f32</span><span class="s2">[</span><span class="s1">index</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">10E+10</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">M</span><span class="s2">))</span>
        <span class="s1">x_f64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s6"># test aliasing(issue #17761)</span>
        <span class="s1">tx_f32 </span><span class="s2">= </span><span class="s1">x_f32</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">x_f32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_max_ulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">tx_f32</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">tx_f32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x_f64</span><span class="s2">)), </span><span class="s1">maxulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_strided_float32</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">strides </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4</span><span class="s2">,-</span><span class="s3">3</span><span class="s2">,-</span><span class="s3">2</span><span class="s2">,-</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">sizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2</span><span class="s2">,</span><span class="s3">100</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">ii </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s1">x_f32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">,</span><span class="s1">high</span><span class="s2">=</span><span class="s3">88.1</span><span class="s2">,</span><span class="s1">size</span><span class="s2">=</span><span class="s1">ii</span><span class="s2">))</span>
            <span class="s1">x_f32_large </span><span class="s2">= </span><span class="s1">x_f32</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
            <span class="s1">x_f32_large</span><span class="s2">[</span><span class="s3">3</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">:</span><span class="s3">4</span><span class="s2">] = </span><span class="s3">120000.0</span>
            <span class="s1">exp_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">)</span>
            <span class="s1">log_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">)</span>
            <span class="s1">sin_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x_f32_large</span><span class="s2">)</span>
            <span class="s1">cos_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x_f32_large</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">jj </span><span class="s0">in </span><span class="s1">strides</span><span class="s2">:</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">exp_true</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">x_f32</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">log_true</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x_f32_large</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">sin_true</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">assert_array_almost_equal_nulp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x_f32_large</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">]), </span><span class="s1">cos_true</span><span class="s2">[::</span><span class="s1">jj</span><span class="s2">], </span><span class="s1">nulp</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestLogAddExp</span><span class="s2">(</span><span class="s1">_FilterInvalids</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_logaddexp_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">z </span><span class="s2">= [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">dec_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">15</span><span class="s2">]):</span>
            <span class="s1">xf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s1">yf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s1">zf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">xf</span><span class="s2">, </span><span class="s1">yf</span><span class="s2">), </span><span class="s1">zf</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">dec_</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_logaddexp_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s3">1000000</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">, </span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000200</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000200</span><span class="s2">, </span><span class="s3">1000000</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">]</span>
        <span class="s1">z </span><span class="s2">= [</span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">, </span><span class="s3">1000200</span><span class="s2">, -</span><span class="s3">1000000</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
            <span class="s1">logxf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">logyf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">logzf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">logxf</span><span class="s2">, </span><span class="s1">logyf</span><span class="s2">), </span><span class="s1">logzf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">inf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,  -</span><span class="s1">inf</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,   </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,   -</span><span class="s1">inf</span><span class="s2">]</span>
        <span class="s1">z </span><span class="s2">= [</span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">,  </span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,    </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'raise'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">]:</span>
                <span class="s1">logxf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">logyf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">logzf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">logxf</span><span class="s2">, </span><span class="s1">logyf</span><span class="s2">), </span><span class="s1">logzf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logaddexp</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([]), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLog1p</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_log1p</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1.2</span><span class="s2">))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s3">1e-6</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">1e-6</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_special</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">, </span><span class="s1">divide</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(-</span><span class="s3">2.</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestExpm1</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_expm1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s3">1e-6</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s3">1e-6</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_special</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">), </span><span class="s3">0.</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(-</span><span class="s3">0.</span><span class="s2">), -</span><span class="s3">0.</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), -</span><span class="s3">1.</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1e-12</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">expm1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestHypot</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">]), </span><span class="s3">5.0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]), </span><span class="s3">5.0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">9.0</span><span class="s2">, </span><span class="s3">12.0</span><span class="s2">, </span><span class="s3">20.0</span><span class="s2">]), </span><span class="s3">25.0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([]), </span><span class="s3">0.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">assert_hypot_isnan</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)),</span>
                <span class="s4">&quot;hypot(%s, %s) is %s, not nan&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)),</span>
                <span class="s4">&quot;hypot(%s, %s) is %s, not inf&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">class </span><span class="s1">TestHypotSpecialValues</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_nan_outputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_hypot_isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">assert_hypot_isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan_outputs2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_hypot_isinf</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">23.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_no_fpe</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">assert_arctan2_isnan</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)), </span><span class="s4">&quot;arctan(%s, %s) is %s, not nan&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">assert_arctan2_ispinf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)) </span><span class="s0">and </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) &gt; </span><span class="s3">0</span><span class="s2">), </span><span class="s4">&quot;arctan(%s, %s) is %s, not +inf&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">assert_arctan2_isninf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)) </span><span class="s0">and </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) &lt; </span><span class="s3">0</span><span class="s2">), </span><span class="s4">&quot;arctan(%s, %s) is %s, not -inf&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">assert_arctan2_ispzero</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">0 </span><span class="s0">and not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))), </span><span class="s4">&quot;arctan(%s, %s) is %s, not +0&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">assert_arctan2_isnzero</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s1">assert_</span><span class="s2">((</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))), </span><span class="s4">&quot;arctan(%s, %s) is %s, not -0&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>


<span class="s0">class </span><span class="s1">TestArctan2SpecialValues</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_one_one</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(1, 1) returns pi/4.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s3">0.25 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), -</span><span class="s3">0.25 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), </span><span class="s3">0.75 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_nzero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-0, -0) returns +-pi.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_pzero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-0, +0) returns +-0.</span>
        <span class="s1">assert_arctan2_ispzero</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">)</span>
        <span class="s1">assert_arctan2_isnzero</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_negative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-0, x) returns +-pi for x &lt; 0.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_positive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-0, x) returns +-0 for x &gt; 0.</span>
        <span class="s1">assert_arctan2_ispzero</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_arctan2_isnzero</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_positive_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(y, +-0) returns +pi/2 for y &gt; 0.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">), </span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">), </span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_negative_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(y, +-0) returns -pi/2 for y &lt; 0.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">PZERO</span><span class="s2">), -</span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span><span class="s2">), -</span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_any_ninf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-y, -infinity) returns +-pi for finite y &gt; 0.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_any_pinf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-y, +infinity) returns +-0 for finite y &gt; 0.</span>
        <span class="s1">assert_arctan2_ispzero</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_arctan2_isnzero</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf_any</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-infinity, x) returns +-pi/2 for finite x.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">( </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),  </span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), -</span><span class="s3">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf_ninf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-infinity, -infinity) returns +-3*pi/4.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">( </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),  </span><span class="s3">0.75 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), -</span><span class="s3">0.75 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inf_pinf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(+-infinity, +infinity) returns +-pi/4.</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">( </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),  </span><span class="s3">0.25 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), -</span><span class="s3">0.25 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan_any</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># atan2(nan, x) returns nan for any x, including inf</span>
        <span class="s1">assert_arctan2_isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_arctan2_isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">assert_arctan2_isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLdexp</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">_check_ldexp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
                                      <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">)), </span><span class="s3">16.</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                                      <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">)), </span><span class="s3">16.</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">),</span>
                                      <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">)), </span><span class="s3">16.</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ldexp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># The default Python int type should work</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">3</span><span class="s2">),  </span><span class="s3">16.</span><span class="s2">)</span>
        <span class="s6"># The following int types should all be accepted</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ldexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ldexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ldexp</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ldexp</span><span class="s2">(</span><span class="s4">'i'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_ldexp</span><span class="s2">(</span><span class="s4">'l'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ldexp_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># silence warning emitted on overflow</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">imax </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'l'</span><span class="s2">)).</span><span class="s1">max</span>
            <span class="s1">imin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'l'</span><span class="s2">)).</span><span class="s1">min</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s1">imax</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">ldexp</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">, </span><span class="s1">imin</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestMaximum</span><span class="s2">(</span><span class="s1">_FilterInvalids</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dflt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllFloat'</span><span class="s2">]</span>
        <span class="s1">dint </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
        <span class="s1">seq1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">11</span><span class="s2">)</span>
        <span class="s1">seq2 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">.</span><span class="s1">reduce</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dint</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dflt</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">tmp1</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">tmp2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduce_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">1</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Multiple checks to give this a chance to</span>
        <span class="s6"># fail if cmp is used instead of rich compare.</span>
        <span class="s6"># Failure cannot be guaranteed.</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s4">'nan'</span><span class="s2">), </span><span class="s1">object</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s3">1.0</span>
            <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s4">'nan'</span><span class="s2">), </span><span class="s1">object</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">1.0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">1.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s0">for </span><span class="s1">cnan </span><span class="s0">in </span><span class="s2">[</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">)]:</span>
            <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">cnan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">+ </span><span class="s3">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">arg2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_strided_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arr1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">,  </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">,-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">,    </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">,    -</span><span class="s3">3.0</span><span class="s2">])</span>
        <span class="s1">maxtrue  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">out_maxtrue </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">,</span><span class="s1">arr2</span><span class="s2">), </span><span class="s1">maxtrue</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">],</span><span class="s1">arr2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">]), </span><span class="s1">maxtrue</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[:</span><span class="s3">4</span><span class="s2">:], </span><span class="s1">arr2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">], </span><span class="s1">arr2</span><span class="s2">[:</span><span class="s3">3</span><span class="s2">:]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[:</span><span class="s3">6</span><span class="s2">:</span><span class="s3">2</span><span class="s2">], </span><span class="s1">arr2</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">10.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">out_maxtrue</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_precision</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">dtmin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">min</span>
            <span class="s1">dtmax </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span>
            <span class="s1">d1 </span><span class="s2">= </span><span class="s1">dt</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">)</span>
            <span class="s1">d1_next </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

            <span class="s1">test_cases </span><span class="s2">= [</span>
                <span class="s6"># v1    v2          expected</span>
                <span class="s2">(</span><span class="s1">dtmin</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,    </span><span class="s1">dtmin</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmax</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,    </span><span class="s1">dtmax</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">d1</span><span class="s2">,    </span><span class="s1">d1_next</span><span class="s2">,    </span><span class="s1">d1_next</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmax</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,     </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
            <span class="s2">]</span>

            <span class="s0">for </span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">test_cases</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">], [</span><span class="s1">v2</span><span class="s2">]), [</span><span class="s1">expected</span><span class="s2">])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">]), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestMinimum</span><span class="s2">(</span><span class="s1">_FilterInvalids</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dflt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllFloat'</span><span class="s2">]</span>
        <span class="s1">dint </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
        <span class="s1">seq1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">11</span><span class="s2">)</span>
        <span class="s1">seq2 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">.</span><span class="s1">reduce</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dint</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dflt</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">tmp1</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">tmp2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduce_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">2j</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">2j</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Multiple checks to give this a chance to</span>
        <span class="s6"># fail if cmp is used instead of rich compare.</span>
        <span class="s6"># Failure cannot be guaranteed.</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s4">'nan'</span><span class="s2">), </span><span class="s1">object</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s3">1.0</span>
            <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s4">'nan'</span><span class="s2">), </span><span class="s1">object</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">1.0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">1.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s0">for </span><span class="s1">cnan </span><span class="s0">in </span><span class="s2">[</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">)]:</span>
            <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">cnan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">arg1 </span><span class="s2">+ </span><span class="s3">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">arg1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_strided_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arr1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">,  </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">,-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">,    </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">,    -</span><span class="s3">3.0</span><span class="s2">])</span>
        <span class="s1">mintrue  </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">8</span><span class="s2">)</span>
        <span class="s1">out_mintrue </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">,</span><span class="s1">arr2</span><span class="s2">), </span><span class="s1">mintrue</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">],</span><span class="s1">arr2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">]), </span><span class="s1">mintrue</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[:</span><span class="s3">4</span><span class="s2">:], </span><span class="s1">arr2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">], </span><span class="s1">arr2</span><span class="s2">[:</span><span class="s3">3</span><span class="s2">:]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">[:</span><span class="s3">6</span><span class="s2">:</span><span class="s3">2</span><span class="s2">], </span><span class="s1">arr2</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">[::</span><span class="s3">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">4.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">out_mintrue</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_precision</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">dtmin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">min</span>
            <span class="s1">dtmax </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span>
            <span class="s1">d1 </span><span class="s2">= </span><span class="s1">dt</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">)</span>
            <span class="s1">d1_next </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

            <span class="s1">test_cases </span><span class="s2">= [</span>
                <span class="s6"># v1    v2          expected</span>
                <span class="s2">(</span><span class="s1">dtmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,     </span><span class="s1">dtmin</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmax</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,     </span><span class="s1">dtmax</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">d1</span><span class="s2">,    </span><span class="s1">d1_next</span><span class="s2">,    </span><span class="s1">d1</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,     </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
            <span class="s2">]</span>

            <span class="s0">for </span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">test_cases</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">], [</span><span class="s1">v2</span><span class="s2">]), [</span><span class="s1">expected</span><span class="s2">])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">]), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFmax</span><span class="s2">(</span><span class="s1">_FilterInvalids</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dflt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllFloat'</span><span class="s2">]</span>
        <span class="s1">dint </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
        <span class="s1">seq1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">11</span><span class="s2">)</span>
        <span class="s1">seq2 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">.</span><span class="s1">reduce</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dint</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dflt</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">tmp1</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">tmp2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">9</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">9</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduce_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">1</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,   </span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s0">for </span><span class="s1">cnan </span><span class="s0">in </span><span class="s2">[</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">)]:</span>
            <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">cnan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,    </span><span class="s3">0</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_precision</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">dtmin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">min</span>
            <span class="s1">dtmax </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span>
            <span class="s1">d1 </span><span class="s2">= </span><span class="s1">dt</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">)</span>
            <span class="s1">d1_next </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

            <span class="s1">test_cases </span><span class="s2">= [</span>
                <span class="s6"># v1    v2          expected</span>
                <span class="s2">(</span><span class="s1">dtmin</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,    </span><span class="s1">dtmin</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmax</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,    </span><span class="s1">dtmax</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">d1</span><span class="s2">,    </span><span class="s1">d1_next</span><span class="s2">,    </span><span class="s1">d1_next</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmax</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,     </span><span class="s1">dtmax</span><span class="s2">),</span>
            <span class="s2">]</span>

            <span class="s0">for </span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">test_cases</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">], [</span><span class="s1">v2</span><span class="s2">]), [</span><span class="s1">expected</span><span class="s2">])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmax</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">]), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFmin</span><span class="s2">(</span><span class="s1">_FilterInvalids</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dflt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllFloat'</span><span class="s2">]</span>
        <span class="s1">dint </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
        <span class="s1">seq1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">11</span><span class="s2">)</span>
        <span class="s1">seq2 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">.</span><span class="s1">reduce</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dint</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dflt</span><span class="s2">:</span>
            <span class="s1">tmp1 </span><span class="s2">= </span><span class="s1">seq1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">tmp2 </span><span class="s2">= </span><span class="s1">seq2</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">0</span><span class="s2">)</span>
            <span class="s1">tmp1</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">tmp2</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp1</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">tmp2</span><span class="s2">), </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduce_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">2j</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">1</span><span class="s2">+</span><span class="s3">3j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">]), </span><span class="s3">2j</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,   </span><span class="s3">0</span><span class="s2">,   </span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_nans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s0">for </span><span class="s1">cnan </span><span class="s0">in </span><span class="s2">[</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">)]:</span>
            <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">cnan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">cnan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">,    </span><span class="s3">0</span><span class="s2">, </span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_precision</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dtypes</span><span class="s2">:</span>
            <span class="s1">dtmin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">min</span>
            <span class="s1">dtmax </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">max</span>
            <span class="s1">d1 </span><span class="s2">= </span><span class="s1">dt</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">)</span>
            <span class="s1">d1_next </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

            <span class="s1">test_cases </span><span class="s2">= [</span>
                <span class="s6"># v1    v2          expected</span>
                <span class="s2">(</span><span class="s1">dtmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,     </span><span class="s1">dtmin</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmax</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,     </span><span class="s1">dtmax</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">d1</span><span class="s2">,    </span><span class="s1">d1_next</span><span class="s2">,    </span><span class="s1">d1</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s1">dtmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,     </span><span class="s1">dtmin</span><span class="s2">),</span>
            <span class="s2">]</span>

            <span class="s0">for </span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">test_cases</span><span class="s2">:</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">], [</span><span class="s1">v2</span><span class="s2">]), [</span><span class="s1">expected</span><span class="s2">])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v2</span><span class="s2">]), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBool</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">subtract</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_truth_table_logical</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># 2, 3 and 4 serves as true values</span>
        <span class="s1">input1 </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">input2 </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>

        <span class="s1">typecodes </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllFloat'</span><span class="s2">]</span>
                     <span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">'AllInteger'</span><span class="s2">]</span>
                     <span class="s2">+ </span><span class="s4">'?'</span><span class="s2">)     </span><span class="s6"># boolean</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">typecodes</span><span class="s2">):</span>
            <span class="s1">arg1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">input1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">arg2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">input2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

            <span class="s6"># OR</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_or</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">):</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>
            <span class="s6"># AND</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">):</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>
            <span class="s6"># XOR</span>
            <span class="s1">out </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_xor</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">):</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_truth_table_bitwise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arg1 </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>
        <span class="s1">arg2 </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>

        <span class="s1">out </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

        <span class="s1">out </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">(</span><span class="s1">arg1</span><span class="s2">, </span><span class="s1">arg2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduce</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">none </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">some </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">every </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">empty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">bool</span><span class="s2">)</span>

        <span class="s1">arrs </span><span class="s2">= [</span><span class="s1">none</span><span class="s2">, </span><span class="s1">some</span><span class="s2">, </span><span class="s1">every</span><span class="s2">, </span><span class="s1">empty</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_and</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), </span><span class="s1">all</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_or</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), </span><span class="s1">any</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_xor</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() % </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestBitwiseUFuncs</span><span class="s2">:</span>

    <span class="s1">_all_ints_bits </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">c</span><span class="s2">).</span><span class="s1">itemsize </span><span class="s2">* </span><span class="s3">8 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">&quot;AllInteger&quot;</span><span class="s2">]]</span>
    <span class="s1">bitwise_types </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s4">'?' </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s4">&quot;AllInteger&quot;</span><span class="s2">] + </span><span class="s4">'O'</span><span class="s2">]</span>
    <span class="s1">bitwise_bits </span><span class="s2">= [</span>
        <span class="s3">2</span><span class="s2">,  </span><span class="s6"># boolean type</span>
        <span class="s2">*</span><span class="s1">_all_ints_bits</span><span class="s2">,  </span><span class="s6"># All integers</span>
        <span class="s1">max</span><span class="s2">(</span><span class="s1">_all_ints_bits</span><span class="s2">) + </span><span class="s3">1</span><span class="s2">,  </span><span class="s6"># Object_ type</span>
    <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bitwise_types</span><span class="s2">:</span>
            <span class="s1">zeros </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">ones </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dt = '%s'&quot; </span><span class="s2">% </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">char</span>

            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_not</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_not</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">ones</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">, </span><span class="s1">ones</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">ones</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">, </span><span class="s1">ones</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">ones</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">, </span><span class="s1">ones</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bitwise_types</span><span class="s2">:</span>
            <span class="s1">zeros </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">ones </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dt = '%s'&quot; </span><span class="s2">% </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">char</span>

            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_not</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_identity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">.</span><span class="s1">identity </span><span class="s2">== </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'bitwise_or'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">.</span><span class="s1">identity </span><span class="s2">== </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'bitwise_xor'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">.</span><span class="s1">identity </span><span class="s2">== -</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'bitwise_and'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_reduction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">binary_funcs </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_or</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_xor</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_and</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bitwise_types</span><span class="s2">:</span>
            <span class="s1">zeros </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">ones </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">binary_funcs</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dt: '%s', f: '%s'&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">zeros</span><span class="s2">), </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">ones</span><span class="s2">), </span><span class="s1">ones</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s6"># Test empty reduction, no object dtype</span>
        <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bitwise_types</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">]:</span>
            <span class="s6"># No object array types</span>
            <span class="s1">empty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">binary_funcs</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dt: '%s', f: '%s'&quot; </span><span class="s2">% (</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>
                <span class="s1">tgt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">empty</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">tgt</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s6"># Empty object arrays use the identity.  Note that the types may</span>
        <span class="s6"># differ, the actual type used is determined by the assign_identity</span>
        <span class="s6"># function and is not the same as the type returned by the identity</span>
        <span class="s6"># method.</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">binary_funcs</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dt: '%s'&quot; </span><span class="s2">% (</span><span class="s1">f</span><span class="s2">,)</span>
            <span class="s1">empty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
            <span class="s1">tgt </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">identity</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">empty</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s6"># Non-empty object arrays do not use the identity</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">binary_funcs</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;dt: '%s'&quot; </span><span class="s2">% (</span><span class="s1">f</span><span class="s2">,)</span>
            <span class="s1">btype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">btype</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">bool</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;input_dtype_obj, bitsize&quot;</span><span class="s2">,</span>
            <span class="s1">zip</span><span class="s2">(</span><span class="s1">bitwise_types</span><span class="s2">, </span><span class="s1">bitwise_bits</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_bitwise_count</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">input_dtype_obj</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">):</span>
        <span class="s1">input_dtype </span><span class="s2">= </span><span class="s1">input_dtype_obj</span><span class="s2">.</span><span class="s1">type</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">):</span>
            <span class="s1">num </span><span class="s2">= </span><span class="s3">2</span><span class="s2">**</span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;bitwise_count for </span><span class="s0">{</span><span class="s1">num</span><span class="s0">}</span><span class="s4">&quot;</span>
            <span class="s0">assert </span><span class="s1">i </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_count</span><span class="s2">(</span><span class="s1">input_dtype</span><span class="s2">(</span><span class="s1">num</span><span class="s2">)), </span><span class="s1">msg</span>
            <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span>
                <span class="s1">input_dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">signedinteger</span><span class="s2">) </span><span class="s0">or </span><span class="s1">input_dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">i </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_count</span><span class="s2">(</span><span class="s1">input_dtype</span><span class="s2">(-</span><span class="s1">num</span><span class="s2">)), </span><span class="s1">msg</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">**</span><span class="s1">i</span><span class="s2">-</span><span class="s3">1 </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span><span class="s2">)</span>
        <span class="s1">bitwise_count_a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bitwise_count</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;array bitwise_count for </span><span class="s0">{</span><span class="s1">input_dtype</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">bitwise_count_a </span><span class="s2">== </span><span class="s1">expected</span><span class="s2">), </span><span class="s1">msg</span>


<span class="s0">class </span><span class="s1">TestInt</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_logical_not</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">o </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10 </span><span class="s2">* </span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">tgt </span><span class="s2">= </span><span class="s1">o</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">tgt</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">] = </span><span class="s0">False</span>
        <span class="s1">os </span><span class="s2">= </span><span class="s1">o</span><span class="s2">[::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_not</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">os</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">o</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFloatingPoint</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_floating_point</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">FLOATING_POINT_SUPPORT</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDegrees</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_degrees</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">degrees</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">), </span><span class="s3">180.0</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">degrees</span><span class="s2">(-</span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">), -</span><span class="s3">90.0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRadians</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_radians</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">(</span><span class="s3">180.0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">(-</span><span class="s3">90.0</span><span class="s2">), -</span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestHeavside</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_heaviside</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s3">30.0</span><span class="s2">, -</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">], [</span><span class="s3">7.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]])</span>
        <span class="s1">expectedhalf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>
        <span class="s1">expected1 </span><span class="s2">= </span><span class="s1">expectedhalf</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">] = </span><span class="s3">1</span>

        <span class="s1">h </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">heaviside</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">expectedhalf</span><span class="s2">)</span>

        <span class="s1">h </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">heaviside</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>

        <span class="s1">h </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">heaviside</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">expectedhalf</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>

        <span class="s1">h </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">heaviside</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestSign</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_sign</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">tgt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, -</span><span class="s3">1.</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sign_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),</span>
            <span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),  </span><span class="s6"># nan</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),  </span><span class="s6"># nan</span>
            <span class="s3">0.0</span><span class="s2">,  </span><span class="s6"># 0.</span>
            <span class="s3">3.0</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">, -</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">+</span><span class="s3">4.0j</span><span class="s2">, -</span><span class="s3">8.0</span><span class="s2">+</span><span class="s3">6.0j</span>
        <span class="s2">])</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">tgt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
            <span class="s3">1.</span><span class="s2">, -</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, -</span><span class="s3">1j</span><span class="s2">,</span>
            <span class="s2">] + [</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)] * </span><span class="s3">5 </span><span class="s2">+ [</span>
            <span class="s3">0.0</span><span class="s2">,</span>
            <span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">+</span><span class="s3">0.8j</span><span class="s2">, -</span><span class="s3">0.8</span><span class="s2">+</span><span class="s3">0.6j</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res </span><span class="s0">is </span><span class="s1">out</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sign_dtype_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># In reference to github issue #6229</span>

        <span class="s1">foo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">.1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">.1</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">object</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">)</span>

        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sign_dtype_nan_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># In reference to github issue #6229</span>
        <span class="s0">def </span><span class="s1">test_nan</span><span class="s2">():</span>
            <span class="s1">foo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
            <span class="s6"># FIXME: a not used</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">object</span><span class="s2">))</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">test_nan</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestMinMax</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_minmax_blocked</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># simd tests on max/min, test all alignments, slow but important</span>
        <span class="s6"># for 2 * vz + 2 * (vs - 1) + 1 (unrolled once)</span>
        <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">sz </span><span class="s0">in </span><span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">15</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">7</span><span class="s2">)]:</span>
            <span class="s0">for </span><span class="s1">out</span><span class="s2">, </span><span class="s1">inp</span><span class="s2">, </span><span class="s1">msg </span><span class="s0">in </span><span class="s1">_gen_alignment_data</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">'unary'</span><span class="s2">,</span>
                                                     <span class="s1">max_size</span><span class="s2">=</span><span class="s1">sz</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                    <span class="s1">inp</span><span class="s2">[:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                    <span class="s1">inp</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
                    <span class="s1">emsg </span><span class="s2">= </span><span class="s0">lambda</span><span class="s2">: </span><span class="s4">'%r</span><span class="s0">\n</span><span class="s4">%s' </span><span class="s2">% (</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">)</span>
                    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
                        <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">,</span>
                                   <span class="s4">&quot;invalid value encountered in reduce&quot;</span><span class="s2">)</span>
                        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()), </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">emsg</span><span class="s2">)</span>
                        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">min</span><span class="s2">()), </span><span class="s1">msg</span><span class="s2">=</span><span class="s1">emsg</span><span class="s2">)</span>

                    <span class="s1">inp</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s3">1e10</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(), </span><span class="s3">1e10</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                    <span class="s1">inp</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = -</span><span class="s3">1e10</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), -</span><span class="s3">1e10</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lower_align</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check data that is not aligned to element size</span>
        <span class="s6"># i.e doubles are aligned to 4 bytes on i386</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">23 </span><span class="s2">* </span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)[</span><span class="s3">4</span><span class="s2">:-</span><span class="s3">4</span><span class="s2">].</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(), </span><span class="s1">d</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(), </span><span class="s1">d</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_reduce_reorder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gh 10370, 11029 Some compilers reorder the call to npy_getfloatstatus</span>
        <span class="s6"># and put it before the call to an intrinsic function that causes</span>
        <span class="s6"># invalid status to be set. Also make sure warnings are not emitted</span>
        <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">32</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diagflat</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">] * </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)):</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">r</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_minimize_no_warns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAbsoluteNegative</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_abs_neg_blocked</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># simd tests on abs, test all alignments for vz + 2 * (vs - 1) + 1</span>
        <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">sz </span><span class="s0">in </span><span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s3">11</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)]:</span>
            <span class="s0">for </span><span class="s1">out</span><span class="s2">, </span><span class="s1">inp</span><span class="s2">, </span><span class="s1">msg </span><span class="s0">in </span><span class="s1">_gen_alignment_data</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">'unary'</span><span class="s2">,</span>
                                                     <span class="s1">max_size</span><span class="s2">=</span><span class="s1">sz</span><span class="s2">):</span>
                <span class="s1">tgt </span><span class="s2">= [</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">inp</span><span class="s2">]</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">((</span><span class="s1">out </span><span class="s2">&gt;= </span><span class="s3">0</span><span class="s2">).</span><span class="s1">all</span><span class="s2">())</span>

                <span class="s1">tgt </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">*(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">inp</span><span class="s2">]</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">tgt</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

                <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]:</span>
                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>
                        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
                        <span class="s1">inp</span><span class="s2">[:] = -</span><span class="s1">d</span>
                        <span class="s1">inp</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">v</span>
                        <span class="s1">d</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = -</span><span class="s1">v </span><span class="s0">if </span><span class="s1">v </span><span class="s2">== -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf </span><span class="s0">else </span><span class="s1">v</span>
                        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">), </span><span class="s1">d</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                        <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
                        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

                        <span class="s1">assert_array_equal</span><span class="s2">(-</span><span class="s1">inp</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">*</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>
                        <span class="s1">d </span><span class="s2">= -</span><span class="s3">1 </span><span class="s2">* </span><span class="s1">inp</span>
                        <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
                        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lower_align</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check data that is not aligned to element size</span>
        <span class="s6"># i.e doubles are aligned to 4 bytes on i386</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">23 </span><span class="s2">* </span><span class="s3">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)[</span><span class="s3">4</span><span class="s2">:-</span><span class="s3">4</span><span class="s2">].</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), -</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">out</span><span class="s2">=</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">out</span><span class="s2">=</span><span class="s1">d</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">'d'</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'int32'</span><span class="s2">, </span><span class="s4">'int64'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;big&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_noncontiguous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">big</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.2251e-308</span><span class="s2">, -</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">6</span><span class="s2">,</span>
                            <span class="s3">6</span><span class="s2">, -</span><span class="s3">2.2251e-308</span><span class="s2">, -</span><span class="s3">8</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">0.0</span><span class="s2">, -</span><span class="s3">2.2251e-308</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, -</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">,</span>
                            <span class="s2">-</span><span class="s3">6</span><span class="s2">, </span><span class="s3">2.2251e-308</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, -</span><span class="s3">10</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">big</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">expect </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">ncontig_in </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">ncontig_out </span><span class="s2">= </span><span class="s1">out</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">contig_in </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">)</span>
        <span class="s6"># contig in, contig out</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">contig_in</span><span class="s2">), </span><span class="s1">expect</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s6"># contig in, ncontig out</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">contig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">),</span>
                                <span class="s1">expect</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s6"># ncontig in, contig out</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">), </span><span class="s1">expect</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s6"># ncontig in, ncontig out</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">ncontig_in</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">ncontig_out</span><span class="s2">),</span>
                                <span class="s1">expect</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s6"># contig in, contig out, nd stride</span>
        <span class="s1">data_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">expect_split </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_split</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">data_split</span><span class="s2">), </span><span class="s1">expect_split</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPositive</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_valid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">valid_dtypes </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">object</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">valid_dtypes</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">result</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_invalid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">'2000-01-01'</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'foo'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">str</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">positive</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'bar'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestSpecialMethods</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">with_wrap</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s1">r </span><span class="s2">= </span><span class="s1">with_wrap</span><span class="s2">()</span>
                <span class="s1">r</span><span class="s2">.</span><span class="s1">arr </span><span class="s2">= </span><span class="s1">arr</span>
                <span class="s1">r</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">context</span>
                <span class="s0">return </span><span class="s1">r</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">with_wrap</span><span class="s2">()</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">i </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">context</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">func </span><span class="s0">is </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">), </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wrap_out</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Calling convention for out should not affect how special methods are</span>
        <span class="s6"># called</span>

        <span class="s0">class </span><span class="s1">StoreArrayPrepareWrap</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s1">_wrap_args </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">_prepare_args </span><span class="s2">= </span><span class="s0">None</span>

            <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(()).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_wrap_args </span><span class="s2">= </span><span class="s1">context</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]</span>
                <span class="s0">return </span><span class="s1">obj</span>

            <span class="s2">@</span><span class="s1">property</span>
            <span class="s0">def </span><span class="s1">args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s6"># We need to ensure these are fetched at the same time, before</span>
                <span class="s6"># any other ufuncs are called by the assertions</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_wrap_args</span>

            <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s4">&quot;a&quot;  </span><span class="s6"># for short test output</span>

        <span class="s0">def </span><span class="s1">do_test</span><span class="s2">(</span><span class="s1">f_call</span><span class="s2">, </span><span class="s1">f_expected</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">StoreArrayPrepareWrap</span><span class="s2">()</span>

            <span class="s1">f_call</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

            <span class="s1">w </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">args</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">f_expected</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">w </span><span class="s2">== </span><span class="s1">expected</span>
            <span class="s0">except </span><span class="s1">AssertionError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s6"># assert_equal produces truly useless error messages</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span>
                    <span class="s4">&quot;Bad arguments passed in ufunc call&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot; expected:              {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">),</span>
                    <span class="s4">&quot; __array_wrap__ got:    {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)</span>
                <span class="s2">]))</span>

        <span class="s6"># method not on the out argument</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),              </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),        </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">),    </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">,)), </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>

        <span class="s6"># method on the out argument</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">),           </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">),       </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">a</span><span class="s2">,)),    </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>

        <span class="s6"># Also check the where mask handling:</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>
        <span class="s1">do_test</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_wrap_with_iterable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># test fix for bug #1026:</span>

        <span class="s0">class </span><span class="s1">with_wrap</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">10</span>

            <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">()</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">with_wrap</span><span class="s2">()</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">with_wrap</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_priority_with_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># test fix for bug #826:</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">10</span>

            <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s4">'float64'</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)*</span><span class="s1">a</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">A</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_priority</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s1">r </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)()</span>
                <span class="s1">r</span><span class="s2">.</span><span class="s1">arr </span><span class="s2">= </span><span class="s1">arr</span>
                <span class="s1">r</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">context</span>
                <span class="s0">return </span><span class="s1">r</span>

        <span class="s0">class </span><span class="s1">B</span><span class="s2">(</span><span class="s1">A</span><span class="s2">):</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">20.</span>

        <span class="s0">class </span><span class="s1">C</span><span class="s2">(</span><span class="s1">A</span><span class="s2">):</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">40.</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">B</span><span class="s2">()</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">C</span><span class="s2">()</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">minimum</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">C</span><span class="s2">)</span>

        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">C</span><span class="s2">)</span>

        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">is </span><span class="s1">A</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">b</span><span class="s2">) </span><span class="s0">is </span><span class="s1">B</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">is </span><span class="s1">C</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_failing_wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">RuntimeError</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_failing_out_wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">singleton </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">])</span>

        <span class="s0">class </span><span class="s1">Ok</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">singleton</span>

        <span class="s0">class </span><span class="s1">Bad</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">RuntimeError</span>

        <span class="s1">ok </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s3">1</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">Ok</span><span class="s2">)</span>
        <span class="s1">bad </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s3">1</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">Bad</span><span class="s2">)</span>
        <span class="s6"># double-free (segfault) of &quot;ok&quot; if &quot;bad&quot; raises an exception</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">10</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">ok</span><span class="s2">, </span><span class="s1">bad</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_none_wrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Tests that issue #8507 is resolved. Previously, this would segfault</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
                <span class="s0">return None</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_default_prepare</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">with_wrap</span><span class="s2">:</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">10</span>

            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

            <span class="s0">def </span><span class="s1">__array_wrap__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">return_scalar</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">arr</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">with_wrap</span><span class="s2">()</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_array_too_many_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">context</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s4">'2 required positional'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check override works even with instance with high priority.</span>
        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">kwargs</span>

        <span class="s0">class </span><span class="s1">MyNDArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s3">100</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyNDArray</span><span class="s2">)</span>
        <span class="s1">res0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">)</span>

        <span class="s6"># self</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res0</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res0</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res0</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'__call__'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'__call__'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res0</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res0</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {})</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'out'</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">,)})</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_mro</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s6"># Some multi arg functions for testing.</span>
        <span class="s0">def </span><span class="s1">tres_mul</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b </span><span class="s2">* </span><span class="s1">c</span>

        <span class="s0">def </span><span class="s1">quatro_mul</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b </span><span class="s2">* </span><span class="s1">c </span><span class="s2">* </span><span class="s1">d</span>

        <span class="s6"># Make these into ufuncs.</span>
        <span class="s1">three_mul_ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frompyfunc</span><span class="s2">(</span><span class="s1">tres_mul</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">four_mul_ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frompyfunc</span><span class="s2">(</span><span class="s1">quatro_mul</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s4">&quot;A&quot;</span>

        <span class="s0">class </span><span class="s1">ASub</span><span class="s2">(</span><span class="s1">A</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s4">&quot;ASub&quot;</span>

        <span class="s0">class </span><span class="s1">B</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s4">&quot;B&quot;</span>

        <span class="s0">class </span><span class="s1">C</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>

            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">count </span><span class="s2">+= </span><span class="s3">1</span>
                <span class="s0">return </span><span class="s1">NotImplemented</span>

        <span class="s0">class </span><span class="s1">CSub</span><span class="s2">(</span><span class="s1">C</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">count </span><span class="s2">+= </span><span class="s3">1</span>
                <span class="s0">return </span><span class="s1">NotImplemented</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">a_sub </span><span class="s2">= </span><span class="s1">ASub</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">B</span><span class="s2">()</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">C</span><span class="s2">()</span>

        <span class="s6"># Standard</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a_sub</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a_sub</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>

        <span class="s6"># With 1 NotImplemented</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s6"># Check our counter works, so we can trust tests below.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s6"># Both NotImplemented.</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">C</span><span class="s2">()</span>
        <span class="s1">c_sub </span><span class="s2">= </span><span class="s1">CSub</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s6"># Ternary testing.</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">6</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">a_sub</span><span class="s2">), </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a_sub</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">a_sub</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a_sub</span><span class="s2">, </span><span class="s1">c</span><span class="s2">), </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">three_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s4">&quot;B&quot;</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">three_mul_ufunc</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">three_mul_ufunc</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">three_mul_ufunc</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>

        <span class="s6"># Quaternary testing.</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s4">&quot;B&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s1">a_sub</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">four_mul_ufunc</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">a_sub</span><span class="s2">), </span><span class="s4">&quot;ASub&quot;</span><span class="s2">)</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">C</span><span class="s2">()</span>
        <span class="s1">c_sub </span><span class="s2">= </span><span class="s1">CSub</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">four_mul_ufunc</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">four_mul_ufunc</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c2 </span><span class="s2">= </span><span class="s1">C</span><span class="s2">()</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">four_mul_ufunc</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c2</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s1">c2</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">four_mul_ufunc</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">c_sub</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c_sub</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c2</span><span class="s2">.</span><span class="s1">count</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_methods</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">kwargs</span>

        <span class="s6"># __call__</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">__call__</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">foo</span><span class="s2">=</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s1">answer</span><span class="s2">=</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">__call__</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">subok</span><span class="s2">=</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'__call__'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s3">1</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'subok'</span><span class="s2">: </span><span class="s4">'bar'</span><span class="s2">, </span><span class="s4">'where'</span><span class="s2">: </span><span class="s3">42</span><span class="s2">})</span>

        <span class="s6"># __call__, wrong args</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">inner1d</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axes</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

        <span class="s6"># reduce, positional args</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s4">'dtype0'</span><span class="s2">, </span><span class="s4">'out0'</span><span class="s2">, </span><span class="s4">'keep0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'reduce'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'dtype'</span><span class="s2">:</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                              <span class="s4">'out'</span><span class="s2">: (</span><span class="s4">'out0'</span><span class="s2">,),</span>
                              <span class="s4">'keepdims'</span><span class="s2">: </span><span class="s4">'keep0'</span><span class="s2">,</span>
                              <span class="s4">'axis'</span><span class="s2">: </span><span class="s4">'axis0'</span><span class="s2">})</span>

        <span class="s6"># reduce, kwargs</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'dtype0'</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'out0'</span><span class="s2">,</span>
                                 <span class="s1">keepdims</span><span class="s2">=</span><span class="s4">'keep0'</span><span class="s2">, </span><span class="s1">initial</span><span class="s2">=</span><span class="s4">'init0'</span><span class="s2">,</span>
                                 <span class="s1">where</span><span class="s2">=</span><span class="s4">'where0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'reduce'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'dtype'</span><span class="s2">:</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                              <span class="s4">'out'</span><span class="s2">: (</span><span class="s4">'out0'</span><span class="s2">,),</span>
                              <span class="s4">'keepdims'</span><span class="s2">: </span><span class="s4">'keep0'</span><span class="s2">,</span>
                              <span class="s4">'axis'</span><span class="s2">: </span><span class="s4">'axis0'</span><span class="s2">,</span>
                              <span class="s4">'initial'</span><span class="s2">: </span><span class="s4">'init0'</span><span class="s2">,</span>
                              <span class="s4">'where'</span><span class="s2">: </span><span class="s4">'where0'</span><span class="s2">})</span>

        <span class="s6"># reduce, output equal to None removed, but not other explicit ones,</span>
        <span class="s6"># even if they are at their default value.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'keepdims'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">keepdims</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'keepdims'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'keepdims'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
                              <span class="s4">'initial'</span><span class="s2">: </span><span class="s3">2</span><span class="s2">, </span><span class="s4">'where'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">})</span>
        <span class="s6"># np._NoValue ignored for initial</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">,</span>
                                 <span class="s1">np</span><span class="s2">.</span><span class="s1">_NoValue</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'keepdims'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
                              <span class="s4">'where'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">})</span>
        <span class="s6"># None kept for initial, True for where.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'keepdims'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
                              <span class="s4">'initial'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'where'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">})</span>

        <span class="s6"># reduce, wrong args</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=())</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s4">'out0'</span><span class="s2">, </span><span class="s4">'out1'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'axis0'</span><span class="s2">)</span>

        <span class="s6"># accumulate, pos args</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s4">'dtype0'</span><span class="s2">, </span><span class="s4">'out0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'accumulate'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'dtype'</span><span class="s2">:</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                              <span class="s4">'out'</span><span class="s2">: (</span><span class="s4">'out0'</span><span class="s2">,),</span>
                              <span class="s4">'axis'</span><span class="s2">: </span><span class="s4">'axis0'</span><span class="s2">})</span>

        <span class="s6"># accumulate, kwargs</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                                     <span class="s1">out</span><span class="s2">=</span><span class="s4">'out0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'accumulate'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'dtype'</span><span class="s2">:</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                              <span class="s4">'out'</span><span class="s2">: (</span><span class="s4">'out0'</span><span class="s2">,),</span>
                              <span class="s4">'axis'</span><span class="s2">: </span><span class="s4">'axis0'</span><span class="s2">})</span>

        <span class="s6"># accumulate, output equal to None removed.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'dtype1'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s4">'dtype1'</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>

        <span class="s6"># accumulate, wrong args</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=())</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                      <span class="s1">out</span><span class="s2">=(</span><span class="s4">'out0'</span><span class="s2">, </span><span class="s4">'out1'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                      <span class="s4">'axis0'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'axis0'</span><span class="s2">)</span>

        <span class="s6"># reduceat, pos args</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s4">'dtype0'</span><span class="s2">, </span><span class="s4">'out0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'reduceat'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'dtype'</span><span class="s2">:</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                              <span class="s4">'out'</span><span class="s2">: (</span><span class="s4">'out0'</span><span class="s2">,),</span>
                              <span class="s4">'axis'</span><span class="s2">: </span><span class="s4">'axis0'</span><span class="s2">})</span>

        <span class="s6"># reduceat, kwargs</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'axis0'</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                                   <span class="s1">out</span><span class="s2">=</span><span class="s4">'out0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'reduceat'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'dtype'</span><span class="s2">:</span><span class="s4">'dtype0'</span><span class="s2">,</span>
                              <span class="s4">'out'</span><span class="s2">: (</span><span class="s4">'out0'</span><span class="s2">,),</span>
                              <span class="s4">'axis'</span><span class="s2">: </span><span class="s4">'axis0'</span><span class="s2">})</span>

        <span class="s6"># reduceat, output equal to None removed.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'dt'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s4">'dt'</span><span class="s2">})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'axis'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'dtype'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>

        <span class="s6"># reduceat, wrong args</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">out</span><span class="s2">=())</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                      <span class="s1">out</span><span class="s2">=(</span><span class="s4">'out0'</span><span class="s2">, </span><span class="s4">'out1'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                      <span class="s4">'axis0'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'axis0'</span><span class="s2">)</span>

        <span class="s6"># outer</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'outer'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">42</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {})</span>

        <span class="s6"># outer, wrong args</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">sig</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">=</span><span class="s4">'a'</span><span class="s2">)</span>

        <span class="s6"># at</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">at</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s4">'b0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'at'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s4">'b0'</span><span class="s2">))</span>

        <span class="s6"># at, wrong args</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">at</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">at</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_out</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">kwargs</span>

        <span class="s0">class </span><span class="s1">B</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">kwargs</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">B</span><span class="s2">()</span>
        <span class="s1">res0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">res4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">res5 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'out_arg'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res0</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res3</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res4</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out_arg'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res5</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out_arg'</span><span class="s2">)</span>

        <span class="s6"># ufuncs with multiple output modf and frexp.</span>
        <span class="s1">res6 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'out0'</span><span class="s2">, </span><span class="s4">'out1'</span><span class="s2">)</span>
        <span class="s1">res7 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">'out0'</span><span class="s2">, </span><span class="s4">'out1'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res6</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res6</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">1</span><span class="s2">], </span><span class="s4">'out1'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res7</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'out0'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res7</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">][</span><span class="s3">1</span><span class="s2">], </span><span class="s4">'out1'</span><span class="s2">)</span>

        <span class="s6"># While we're at it, check that default output is never passed on.</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) == {})</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">) == {})</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">,)) == {})</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) == {})</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) == {})</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)) == {})</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s6"># Out argument must be tuple, since there are multiple outputs.</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>

        <span class="s6"># don't give positional and output argument, or too many arguments.</span>
        <span class="s6"># wrong number of arguments in the tuple is an error too.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'one'</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'two'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s4">'one'</span><span class="s2">, </span><span class="s4">'two'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s4">'one'</span><span class="s2">, </span><span class="s4">'two'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=())</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'one'</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s4">'two'</span><span class="s2">, </span><span class="s4">'three'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'one'</span><span class="s2">, </span><span class="s4">'two'</span><span class="s2">, </span><span class="s4">'three'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s4">'one'</span><span class="s2">, </span><span class="s4">'two'</span><span class="s2">, </span><span class="s4">'three'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s4">'one'</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_where</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">OverriddenArrayOld</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>

            <span class="s0">def </span><span class="s1">_unwrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">objs</span><span class="s2">):</span>
                <span class="s1">cls </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
                <span class="s1">result </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">objs</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">):</span>
                        <span class="s1">obj </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                    <span class="s0">elif </span><span class="s1">type</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) != </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">:</span>
                        <span class="s0">return </span><span class="s1">NotImplemented</span>
                    <span class="s1">result</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">result</span>

            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>

                <span class="s1">inputs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unwrap</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">inputs </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">NotImplemented</span>

                <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s4">&quot;out&quot; </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
                    <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;out&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unwrap</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;out&quot;</span><span class="s2">])</span>
                    <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;out&quot;</span><span class="s2">] </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                        <span class="s0">return </span><span class="s1">NotImplemented</span>

                <span class="s1">r </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">r </span><span class="s0">is not </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                    <span class="s1">r </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>

                <span class="s0">return </span><span class="s1">r</span>

        <span class="s0">class </span><span class="s1">OverriddenArrayNew</span><span class="s2">(</span><span class="s1">OverriddenArrayOld</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>

                <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s4">&quot;where&quot; </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">:</span>
                    <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;where&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_unwrap</span><span class="s2">((</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;where&quot;</span><span class="s2">], ))</span>
                    <span class="s0">if </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;where&quot;</span><span class="s2">] </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                        <span class="s0">return </span><span class="s1">NotImplemented</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;where&quot;</span><span class="s2">] = </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">&quot;where&quot;</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]</span>

                <span class="s1">r </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">r </span><span class="s0">is not </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                    <span class="s1">r </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">))</span>

                <span class="s0">return </span><span class="s1">r</span>

        <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span>

        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">where </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">ufunc</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">OverriddenArrayOld</span><span class="s2">))</span>

        <span class="s1">result_1 </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">(</span>
            <span class="s1">array</span><span class="s2">,</span>
            <span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">OverriddenArrayNew</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result_1</span><span class="s2">, </span><span class="s1">OverriddenArrayNew</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">result_1</span><span class="s2">) == </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">)</span>

        <span class="s1">result_2 </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">(</span>
            <span class="s1">array</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">OverriddenArrayNew</span><span class="s2">),</span>
            <span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">OverriddenArrayNew</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result_2</span><span class="s2">, </span><span class="s1">OverriddenArrayNew</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">result_2</span><span class="s2">) == </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=</span><span class="s1">where</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">a</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;oops&quot;</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">divide</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_not_implemented</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">NotImplemented</span>

        <span class="s1">msg </span><span class="s2">= (</span><span class="s4">&quot;operand type(s) all returned NotImplemented from &quot;</span>
               <span class="s4">&quot;__array_ufunc__(&lt;ufunc 'negative'&gt;, '__call__', &lt;*&gt;): 'A'&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">fnmatch</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">A</span><span class="s2">())</span>

        <span class="s1">msg </span><span class="s2">= (</span><span class="s4">&quot;operand type(s) all returned NotImplemented from &quot;</span>
               <span class="s4">&quot;__array_ufunc__(&lt;ufunc 'add'&gt;, '__call__', &lt;*&gt;, &lt;object *&gt;, &quot;</span>
               <span class="s4">&quot;out=(1,)): 'A', 'object', 'int'&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">fnmatch</span><span class="s2">.</span><span class="s1">translate</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">A</span><span class="s2">(), </span><span class="s1">object</span><span class="s2">(), </span><span class="s1">out</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_disabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">OptOut</span><span class="s2">:</span>
            <span class="s1">__array_ufunc__ </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">opt_out </span><span class="s2">= </span><span class="s1">OptOut</span><span class="s2">()</span>

        <span class="s6"># ufuncs always raise</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;operand 'OptOut' does not support ufuncs&quot;</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">opt_out</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">opt_out</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">opt_out</span><span class="s2">)</span>

        <span class="s6"># opt-outs still hold even when other arguments have pathological</span>
        <span class="s6"># __array_ufunc__ implementations</span>

        <span class="s0">class </span><span class="s1">GreedyArray</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span>

        <span class="s1">greedy </span><span class="s2">= </span><span class="s1">GreedyArray</span><span class="s2">()</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">negative</span><span class="s2">(</span><span class="s1">greedy</span><span class="s2">) </span><span class="s0">is </span><span class="s1">greedy</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">greedy</span><span class="s2">, </span><span class="s1">opt_out</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises_regex</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">greedy</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">opt_out</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gufunc_override</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gufunc are just ufunc instances, but follow a different path,</span>
        <span class="s6"># so check __array_ufunc__ overrides them properly.</span>
        <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">kwargs</span>

        <span class="s1">inner1d </span><span class="s2">= </span><span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">inner1d</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">inner1d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">inner1d</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'__call__'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {})</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">inner1d</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">inner1d</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">2</span><span class="s2">], </span><span class="s4">'__call__'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">3</span><span class="s2">], (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">4</span><span class="s2">], {</span><span class="s4">'out'</span><span class="s2">: (</span><span class="s1">a</span><span class="s2">,)})</span>

        <span class="s6"># wrong number of arguments in the tuple is an error too.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">inner1d</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'two'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">inner1d</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'one'</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s4">'two'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">inner1d</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s4">'one'</span><span class="s2">, </span><span class="s4">'two'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">inner1d</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s4">'one'</span><span class="s2">, </span><span class="s4">'two'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">inner1d</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=())</span>

    <span class="s0">def </span><span class="s1">test_ufunc_override_with_super</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># NOTE: this class is used in doc/source/user/basics.subclassing.rst</span>
        <span class="s6"># if you make any changes here, do update it there too.</span>
        <span class="s0">class </span><span class="s1">A</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s1">args </span><span class="s2">= []</span>
                <span class="s1">in_no </span><span class="s2">= []</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">input_ </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input_</span><span class="s2">, </span><span class="s1">A</span><span class="s2">):</span>
                        <span class="s1">in_no</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
                        <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">input_</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">))</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">input_</span><span class="s2">)</span>

                <span class="s1">outputs </span><span class="s2">= </span><span class="s1">out</span>
                <span class="s1">out_no </span><span class="s2">= []</span>
                <span class="s0">if </span><span class="s1">outputs</span><span class="s2">:</span>
                    <span class="s1">out_args </span><span class="s2">= []</span>
                    <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">output </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">outputs</span><span class="s2">):</span>
                        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">A</span><span class="s2">):</span>
                            <span class="s1">out_no</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">j</span><span class="s2">)</span>
                            <span class="s1">out_args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">output</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">))</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s1">out_args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
                    <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'out'</span><span class="s2">] = </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">out_args</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">outputs </span><span class="s2">= (</span><span class="s0">None</span><span class="s2">,) * </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nout</span>

                <span class="s1">info </span><span class="s2">= {}</span>
                <span class="s0">if </span><span class="s1">in_no</span><span class="s2">:</span>
                    <span class="s1">info</span><span class="s2">[</span><span class="s4">'inputs'</span><span class="s2">] = </span><span class="s1">in_no</span>
                <span class="s0">if </span><span class="s1">out_no</span><span class="s2">:</span>
                    <span class="s1">info</span><span class="s2">[</span><span class="s4">'outputs'</span><span class="s2">] = </span><span class="s1">out_no</span>

                <span class="s1">results </span><span class="s2">= </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">,</span>
                                                  <span class="s2">*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">results </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">NotImplemented</span>

                <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">'at'</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">inputs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">A</span><span class="s2">):</span>
                        <span class="s1">inputs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">info </span><span class="s2">= </span><span class="s1">info</span>
                    <span class="s0">return</span>

                <span class="s0">if </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">nout </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                    <span class="s1">results </span><span class="s2">= (</span><span class="s1">results</span><span class="s2">,)</span>

                <span class="s1">results </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">result</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
                                 <span class="s0">if </span><span class="s1">output </span><span class="s0">is None else </span><span class="s1">output</span><span class="s2">)</span>
                                <span class="s0">for </span><span class="s1">result</span><span class="s2">, </span><span class="s1">output </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">results</span><span class="s2">, </span><span class="s1">outputs</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s1">results </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">A</span><span class="s2">):</span>
                    <span class="s1">results</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">info </span><span class="s2">= </span><span class="s1">info</span>

                <span class="s0">return </span><span class="s1">results</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">results</span><span class="s2">) == </span><span class="s3">1 </span><span class="s0">else </span><span class="s1">results</span>

        <span class="s0">class </span><span class="s1">B</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, *</span><span class="s1">inputs</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">input_</span><span class="s2">, </span><span class="s1">A</span><span class="s2">) </span><span class="s0">for </span><span class="s1">input_ </span><span class="s0">in </span><span class="s1">inputs</span><span class="s2">):</span>
                    <span class="s0">return </span><span class="s4">&quot;A!&quot;</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">NotImplemented</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">)</span>
        <span class="s6"># 1 input, 1 output</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">check </span><span class="s2">== </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">a</span><span class="s2">,))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">check </span><span class="s2">== </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">check </span><span class="s2">== </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>

        <span class="s6"># 1 input, 2 outputs</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">b1</span><span class="s2">, </span><span class="s1">b2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b1</span><span class="s2">, </span><span class="s1">b2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b2 </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">]})</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">c1</span><span class="s2">, </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">modf</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c1 </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c2 </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c1</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]})</span>

        <span class="s6"># 2 input, 1 output</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s6"># some tests with a non-ndarray subclass</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">B</span><span class="s2">()</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s4">'__call__'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s4">'__call__'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s4">'__call__'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s4">'__call__'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) == </span><span class="s4">&quot;A!&quot;</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) == </span><span class="s4">&quot;A!&quot;</span><span class="s2">)</span>
        <span class="s6"># regression check for gh-9102 -- tests ufunc.reduce implicitly.</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">any</span><span class="s2">()</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">any</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">0</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">out</span><span class="s2">=</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">check</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s6"># simple explicit tests of reduce, accumulate, reduceat</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">indices </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">'outputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s6"># and a few tests for at</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>
        <span class="s1">check </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">().</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">at</span><span class="s2">(</span><span class="s1">check</span><span class="s2">, ([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]), </span><span class="s3">1.</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">at</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, ([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]), </span><span class="s3">1.</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">]})</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">().</span><span class="s1">view</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">at</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, ([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]), </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">info</span><span class="s2">, {</span><span class="s4">'inputs'</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]})</span>

    <span class="s0">def </span><span class="s1">test_array_ufunc_direct_call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># This is mainly a regression test for gh-24023 (shouldn't segfault)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">()</span>

        <span class="s6"># No kwargs means kwargs may be NULL on the C-level</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s6"># And the same with a valid call:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">__array_ufunc__</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s4">&quot;__call__&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">a</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">TestChoose</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_mixed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">choose</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, (</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]))</span>


<span class="s0">class </span><span class="s1">TestRationalFunctions</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_lcm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_lcm_inner</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_lcm_inner</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lcm_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_lcm_inner</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gcd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_gcd_inner</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_lcm_inner</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gcd_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_test_gcd_inner</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_test_lcm_inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># basic use</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">12</span><span class="s2">, </span><span class="s3">120</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">200</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">60</span><span class="s2">, </span><span class="s3">600</span><span class="s2">])</span>

        <span class="s0">if not </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unsignedinteger</span><span class="s2">):</span>
            <span class="s6"># negatives are ignored</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">12</span><span class="s2">, -</span><span class="s3">12</span><span class="s2">,  </span><span class="s3">12</span><span class="s2">, -</span><span class="s3">12</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">20</span><span class="s2">,  </span><span class="s3">20</span><span class="s2">, -</span><span class="s3">20</span><span class="s2">, -</span><span class="s3">20</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">60</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">)</span>

        <span class="s6"># reduce</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">20</span><span class="s2">]), </span><span class="s3">60</span><span class="s2">)</span>

        <span class="s6"># broadcasting, and a test including 0</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s3">20</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">60</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">20</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">_test_gcd_inner</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s6"># basic use</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">12</span><span class="s2">, </span><span class="s3">120</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">20</span><span class="s2">, </span><span class="s3">200</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">40</span><span class="s2">])</span>

        <span class="s0">if not </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unsignedinteger</span><span class="s2">):</span>
            <span class="s6"># negatives are ignored</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">12</span><span class="s2">, -</span><span class="s3">12</span><span class="s2">,  </span><span class="s3">12</span><span class="s2">, -</span><span class="s3">12</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">20</span><span class="s2">,  </span><span class="s3">20</span><span class="s2">, -</span><span class="s3">20</span><span class="s2">, -</span><span class="s3">20</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">4</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">)</span>

        <span class="s6"># reduce</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">15</span><span class="s2">, </span><span class="s3">25</span><span class="s2">, </span><span class="s3">35</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s3">5</span><span class="s2">)</span>

        <span class="s6"># broadcasting, and a test including 0</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s3">20</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">20</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">4</span><span class="s2">,  </span><span class="s3">5</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_lcm_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># verify that we don't overflow when a*b does overflow</span>
        <span class="s1">big </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">).</span><span class="s1">max </span><span class="s2">// </span><span class="s3">11</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">big</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s3">5</span><span class="s2">*</span><span class="s1">big</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s3">10</span><span class="s2">*</span><span class="s1">big</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gcd_overflow</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">):</span>
            <span class="s6"># verify that we don't overflow when taking abs(x)</span>
            <span class="s6"># not relevant for lcm, where the result is unrepresentable anyway</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">min</span><span class="s2">)  </span><span class="s6"># negative power of two</span>
            <span class="s1">q </span><span class="s2">= -(</span><span class="s1">a </span><span class="s2">// </span><span class="s3">4</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">,  </span><span class="s1">q</span><span class="s2">*</span><span class="s3">3</span><span class="s2">), </span><span class="s1">q</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, -</span><span class="s1">q</span><span class="s2">*</span><span class="s3">3</span><span class="s2">), </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_decimal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">decimal </span><span class="s0">import </span><span class="s1">Decimal</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]) * </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s4">'0.20'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]) * </span><span class="s1">Decimal</span><span class="s2">(</span><span class="s4">'0.12'</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s3">4</span><span class="s2">*[</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s4">'0.04'</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s3">4</span><span class="s2">*[</span><span class="s1">Decimal</span><span class="s2">(</span><span class="s4">'0.60'</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># not well-defined on float due to rounding errors</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_huge_integers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Converting to an array first is a bit different as it means we</span>
        <span class="s6"># have an explicit object dtype:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">200</span><span class="s2">), </span><span class="s3">2</span><span class="s2">**</span><span class="s3">200</span><span class="s2">)</span>
        <span class="s6"># Special promotion rules should ensure that this also works for</span>
        <span class="s6"># two Python integers (even if slow).</span>
        <span class="s6"># (We do this for comparisons, as the result is always bool and</span>
        <span class="s6"># we also special case array comparisons with Python integers)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">200</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**</span><span class="s3">200</span><span class="s2">)</span>

        <span class="s6"># But, we cannot do this when it would affect the result dtype:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OverflowError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">100</span><span class="s2">, </span><span class="s3">3</span><span class="s2">**</span><span class="s3">100</span><span class="s2">)</span>

        <span class="s6"># Asking for `object` explicitly is fine, though:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">100</span><span class="s2">, </span><span class="s3">3</span><span class="s2">**</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">) == </span><span class="s3">1</span>

        <span class="s6"># As of now, the below work, because it is using arrays (which</span>
        <span class="s6"># will be object arrays)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">2</span><span class="s2">**</span><span class="s3">100 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">**</span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">**</span><span class="s3">100 </span><span class="s2">* </span><span class="s3">5</span><span class="s2">**</span><span class="s3">7</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**</span><span class="s3">50 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">**</span><span class="s3">10</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">2</span><span class="s2">**</span><span class="s3">100</span><span class="s2">,               </span><span class="s3">2</span><span class="s2">**</span><span class="s3">50 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">**</span><span class="s3">5</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lcm</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [</span><span class="s3">2</span><span class="s2">**</span><span class="s3">100 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">**</span><span class="s3">5 </span><span class="s2">* </span><span class="s3">5</span><span class="s2">**</span><span class="s3">7</span><span class="s2">, </span><span class="s3">2</span><span class="s2">**</span><span class="s3">100 </span><span class="s2">* </span><span class="s3">3</span><span class="s2">**</span><span class="s3">10</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_inf_and_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">inf </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">gcd</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>
        


<span class="s0">class </span><span class="s1">TestRoundingFunctions</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_object_direct</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; test direct implementation of these magic methods &quot;&quot;&quot;</span>
        <span class="s0">class </span><span class="s1">C</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__floor__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s3">1</span>
            <span class="s0">def </span><span class="s1">__ceil__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s3">2</span>
            <span class="s0">def </span><span class="s1">__trunc__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s3">3</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">C</span><span class="s2">(), </span><span class="s1">C</span><span class="s2">()])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">),  [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_object_indirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; test implementations via __float__ &quot;&quot;&quot;</span>
        <span class="s0">class </span><span class="s1">C</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__float__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s2">-</span><span class="s3">2.5</span>

        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">C</span><span class="s2">(), </span><span class="s1">C</span><span class="s2">()])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), [-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">),  [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)  </span><span class="s6"># consistent with math.trunc</span>

    <span class="s0">def </span><span class="s1">test_fraction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">Fraction</span><span class="s2">(-</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">f</span><span class="s2">), -</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">f</span><span class="s2">), -</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">), -</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'func'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">trunc</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">,</span>
                                       <span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_output_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>


<span class="s0">class </span><span class="s1">TestComplexFunctions</span><span class="s2">:</span>
    <span class="s1">funcs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">,  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">,  </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">,</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">,     </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">,    </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tan</span><span class="s2">,     </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">,</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">exp2</span><span class="s2">,    </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">,     </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">,   </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">,   </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">,</span>
             <span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_it</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">funcs</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">f </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">:</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s3">1.5</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s3">.5</span>
            <span class="s1">fr </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">fz </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">fz</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">fr</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">'real part %s' </span><span class="s2">% </span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">fz</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">'imag part %s' </span><span class="s2">% </span><span class="s1">f</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;doesn't work&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_precisions_consistent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s3">1 </span><span class="s2">+ </span><span class="s3">1j</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">funcs</span><span class="s2">:</span>
            <span class="s1">fcf </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">csingle</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>
            <span class="s1">fcd </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cdouble</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>
            <span class="s1">fcl </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">fcf</span><span class="s2">, </span><span class="s1">fcd</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">6</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">'fch-fcd %s' </span><span class="s2">% </span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">fcl</span><span class="s2">, </span><span class="s1">fcd</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s3">15</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">'fch-fcl %s' </span><span class="s2">% </span><span class="s1">f</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;doesn't work&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_branch_cuts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check branch cuts and continuity on them</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">,   -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">,  -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">,  -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],   [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],   [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">],  [</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">,  </span><span class="s3">2j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,   </span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">, [ -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">,  </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">,   </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

        <span class="s6"># check against bogus branch cuts: assert continuity between quadrants</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">], [ </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">], [ </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;doesn't work&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_branch_cuts_complex64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># check branch cuts and continuity on them</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">,   -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">,  -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">, -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log1p</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">,  -</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>

        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],   [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],   [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">],  [</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>

        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">,  </span><span class="s3">2j</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,   </span><span class="s3">1</span><span class="s2">], -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">, [ -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">,  </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">,   </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>

        <span class="s6"># check against bogus branch cuts: assert continuity between quadrants</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">], [ </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccos</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">], [ </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>

        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, [ -</span><span class="s3">2</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arccosh</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">-</span><span class="s3">2j</span><span class="s2">, </span><span class="s3">2j</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">1j</span><span class="s2">], </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_against_cmath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">import </span><span class="s1">cmath</span>

        <span class="s1">points </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">-</span><span class="s3">1j</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">, +</span><span class="s3">1</span><span class="s2">-</span><span class="s3">1j</span><span class="s2">, +</span><span class="s3">1</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">]</span>
        <span class="s1">name_map </span><span class="s2">= {</span><span class="s4">'arcsin'</span><span class="s2">: </span><span class="s4">'asin'</span><span class="s2">, </span><span class="s4">'arccos'</span><span class="s2">: </span><span class="s4">'acos'</span><span class="s2">, </span><span class="s4">'arctan'</span><span class="s2">: </span><span class="s4">'atan'</span><span class="s2">,</span>
                    <span class="s4">'arcsinh'</span><span class="s2">: </span><span class="s4">'asinh'</span><span class="s2">, </span><span class="s4">'arccosh'</span><span class="s2">: </span><span class="s4">'acosh'</span><span class="s2">, </span><span class="s4">'arctanh'</span><span class="s2">: </span><span class="s4">'atanh'</span><span class="s2">}</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s3">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">complex</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">funcs</span><span class="s2">:</span>
            <span class="s1">fname </span><span class="s2">= </span><span class="s1">func</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">'.'</span><span class="s2">)[-</span><span class="s3">1</span><span class="s2">]</span>
            <span class="s1">cname </span><span class="s2">= </span><span class="s1">name_map</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">cfunc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cmath</span><span class="s2">, </span><span class="s1">cname</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">points</span><span class="s2">:</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)))</span>
                <span class="s1">b </span><span class="s2">= </span><span class="s1">cfunc</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
                <span class="s1">assert_</span><span class="s2">(</span>
                    <span class="s1">abs</span><span class="s2">(</span><span class="s1">a </span><span class="s2">- </span><span class="s1">b</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">,</span>
                    <span class="s4">&quot;%s %s: %s; cmath: %s&quot; </span><span class="s2">% (</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
                <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
        <span class="s6"># manylinux2014 uses glibc2.17</span>
        <span class="s1">_glibc_older_than</span><span class="s2">(</span><span class="s4">&quot;2.18&quot;</span><span class="s2">),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Older glibc versions are imprecise (maybe passes with SIMD?)&quot;</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;doesn't work&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'dtype'</span><span class="s2">, [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span>
    <span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_loss_of_precision</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot;Check loss of precision in complex arc* functions&quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble </span><span class="s0">and </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() != </span><span class="s4">'x86_64'</span><span class="s2">:</span>
            <span class="s6"># Failures on musllinux, aarch64, s390x, ppc64le (see gh-17554)</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'Only works reliably for x86-64 and recent glibc'</span><span class="s2">)</span>

        <span class="s6"># Check against known-good functions</span>

        <span class="s1">info </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">real_dtype </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">).</span><span class="s1">real</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s1">eps </span><span class="s2">= </span><span class="s1">info</span><span class="s2">.</span><span class="s1">eps</span>

        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">real_dtype</span><span class="s2">)</span>

            <span class="s1">z </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">z</span><span class="s2">).</span><span class="s1">real </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s1">rtol</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">x</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)], </span><span class="s1">d</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(),</span>
                                      <span class="s4">'arcsinh'</span><span class="s2">))</span>

            <span class="s1">z </span><span class="s2">= (</span><span class="s3">1j</span><span class="s2">*</span><span class="s1">x</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">(</span><span class="s1">z</span><span class="s2">).</span><span class="s1">imag </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s1">rtol</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">x</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)], </span><span class="s1">d</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(),</span>
                                      <span class="s4">'arcsin'</span><span class="s2">))</span>

            <span class="s1">z </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">(</span><span class="s1">z</span><span class="s2">).</span><span class="s1">real </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s1">rtol</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">x</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)], </span><span class="s1">d</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(),</span>
                                      <span class="s4">'arctanh'</span><span class="s2">))</span>

            <span class="s1">z </span><span class="s2">= (</span><span class="s3">1j</span><span class="s2">*</span><span class="s1">x</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">(</span><span class="s1">z</span><span class="s2">).</span><span class="s1">imag </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s1">rtol</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">), </span><span class="s1">x</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)], </span><span class="s1">d</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(),</span>
                                      <span class="s4">'arctan'</span><span class="s2">))</span>

        <span class="s6"># The switchover was chosen as 1e-3; hence there can be up to</span>
        <span class="s6"># ~eps/1e-3 of relative cancellation error before it</span>

        <span class="s1">x_series </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">logspace</span><span class="s2">(-</span><span class="s3">20</span><span class="s2">, -</span><span class="s3">3.001</span><span class="s2">, </span><span class="s3">200</span><span class="s2">)</span>
        <span class="s1">x_basic </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">logspace</span><span class="s2">(-</span><span class="s3">2.999</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">dtype </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">bad_arcsinh</span><span class="s2">():</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;Trig functions of np.clongdouble values known &quot;</span>
                            <span class="s4">&quot;to be inaccurate on aarch64 and PPC for some &quot;</span>
                            <span class="s4">&quot;compilation configurations.&quot;</span><span class="s2">)</span>
            <span class="s6"># It's not guaranteed that the system-provided arc functions</span>
            <span class="s6"># are accurate down to a few epsilons. (Eg. on Linux 64-bit)</span>
            <span class="s6"># So, give more leeway for long complex tests here:</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">x_series</span><span class="s2">, </span><span class="s3">50.0</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">x_series</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">)</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">x_basic</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">/</span><span class="s3">1e-3</span><span class="s2">)</span>

        <span class="s6"># Check a few points</span>

        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1e-5</span><span class="s2">*(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s3">9.999999999333333333e-6 </span><span class="s2">+ </span><span class="s3">1.000000000066666666e-5j</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s3">1</span><span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)/</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s3">1e-15</span><span class="s2">))</span>

        <span class="s1">p </span><span class="s2">= </span><span class="s3">1.0000000000333333333e-5 </span><span class="s2">+ </span><span class="s3">9.999999999666666667e-6j</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s3">1</span><span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)/</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s3">1e-15</span><span class="s2">))</span>

        <span class="s1">p </span><span class="s2">= </span><span class="s3">9.999999999333333333e-6j </span><span class="s2">+ </span><span class="s3">1.000000000066666666e-5</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s3">1</span><span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)/</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s3">1e-15</span><span class="s2">))</span>

        <span class="s1">p </span><span class="s2">= </span><span class="s3">1.0000000000333333333e-5j </span><span class="s2">+ </span><span class="s3">9.999999999666666667e-6</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s3">1</span><span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)/</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d </span><span class="s2">&lt; </span><span class="s3">1e-15</span><span class="s2">))</span>

        <span class="s6"># Check continuity across switchover points</span>

        <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">, </span><span class="s1">d</span><span class="s2">=</span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">z0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">z0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">zp </span><span class="s2">= </span><span class="s1">z0 </span><span class="s2">+ </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">z0</span><span class="s2">) * </span><span class="s1">d </span><span class="s2">* </span><span class="s1">eps </span><span class="s2">* </span><span class="s3">2</span>
            <span class="s1">zm </span><span class="s2">= </span><span class="s1">z0 </span><span class="s2">- </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">z0</span><span class="s2">) * </span><span class="s1">d </span><span class="s2">* </span><span class="s1">eps </span><span class="s2">* </span><span class="s3">2</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">zp </span><span class="s2">!= </span><span class="s1">zm</span><span class="s2">), (</span><span class="s1">zp</span><span class="s2">, </span><span class="s1">zm</span><span class="s2">))</span>

            <span class="s6"># NB: the cancellation error at the switchover is at least eps</span>
            <span class="s1">good </span><span class="s2">= (</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">) - </span><span class="s1">func</span><span class="s2">(</span><span class="s1">zm</span><span class="s2">)) &lt; </span><span class="s3">2</span><span class="s2">*</span><span class="s1">eps</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">good</span><span class="s2">), (</span><span class="s1">func</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">[~</span><span class="s1">good</span><span class="s2">]))</span>

        <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsinh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arcsin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctanh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan</span><span class="s2">):</span>
            <span class="s1">pts </span><span class="s2">= [</span><span class="s1">rp</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">*</span><span class="s1">ip </span><span class="s0">for </span><span class="s1">rp </span><span class="s0">in </span><span class="s2">(-</span><span class="s3">1e-3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1e-3</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ip </span><span class="s0">in</span><span class="s2">(-</span><span class="s3">1e-3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1e-3</span><span class="s2">)</span>
                   <span class="s0">if </span><span class="s1">rp </span><span class="s2">!= </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">ip </span><span class="s2">!= </span><span class="s3">0</span><span class="s2">]</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">pts</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">pts</span><span class="s2">, </span><span class="s3">1j</span><span class="s2">)</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">pts</span><span class="s2">, </span><span class="s3">1</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_promotion_corner_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">funcs</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span>
            <span class="s6"># Integer to low precision float promotion is a dubious choice:</span>
            <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span>
            <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span>


<span class="s0">class </span><span class="s1">TestAttributes</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_attributes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">add </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">add</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">add</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">, </span><span class="s4">'add'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">add</span><span class="s2">.</span><span class="s1">ntypes </span><span class="s2">&gt;= </span><span class="s3">18</span><span class="s2">)  </span><span class="s6"># don't fail if types added</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s4">'ii-&gt;i' </span><span class="s0">in </span><span class="s1">add</span><span class="s2">.</span><span class="s1">types</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">add</span><span class="s2">.</span><span class="s1">nin</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">add</span><span class="s2">.</span><span class="s1">nout</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">add</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_doc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># don't bother checking the long list of kwargs, which are likely to</span>
        <span class="s6"># change</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">__doc__</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span>
            <span class="s4">&quot;add(x1, x2, /, out=None, *, where=True&quot;</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">frexp</span><span class="s2">.</span><span class="s1">__doc__</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span>
            <span class="s4">&quot;frexp(x[, out1, out2], / [, out=(None, None)], *, where=True&quot;</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestSubclass</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_subclass_op</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">class </span><span class="s1">simple</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">def </span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">subtype</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">):</span>
                <span class="s1">self </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">.</span><span class="s1">__new__</span><span class="s2">(</span><span class="s1">subtype</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">self</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">simple</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">+</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFrompyfunc</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_identity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">mul</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span>

        <span class="s6"># with identity=value</span>
        <span class="s1">mul_ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frompyfunc</span><span class="s2">(</span><span class="s1">mul</span><span class="s2">, </span><span class="s1">nin</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">nout</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">identity</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]), </span><span class="s3">24</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([]), </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s6"># with identity=None (reorderable)</span>
        <span class="s1">mul_ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frompyfunc</span><span class="s2">(</span><span class="s1">mul</span><span class="s2">, </span><span class="s1">nin</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">nout</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">identity</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]), </span><span class="s3">24</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)), </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([]))</span>

        <span class="s6"># with no identity (not reorderable)</span>
        <span class="s1">mul_ufunc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frompyfunc</span><span class="s2">(</span><span class="s1">mul</span><span class="s2">, </span><span class="s1">nin</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">nout</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]), </span><span class="s3">24</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">mul_ufunc</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">([]))</span>


<span class="s0">def </span><span class="s1">_check_branch_cut</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">dx</span><span class="s2">, </span><span class="s1">re_sign</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">im_sign</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">sig_zero_ok</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                      <span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Check for a branch cut in a function. 
 
    Assert that `x0` lies on a branch cut of function `f` and `f` is 
    continuous from the direction `dx`. 
 
    Parameters 
    ---------- 
    f : func 
        Function to check 
    x0 : array-like 
        Point on branch cut 
    dx : array-like 
        Direction to check continuity in 
    re_sign, im_sign : {1, -1} 
        Change of sign of the real or imaginary part expected 
    sig_zero_ok : bool 
        Whether to check if the branch cut respects signed zero (if applicable) 
    dtype : dtype 
        Dtype to check (should be complex) 
 
    &quot;&quot;&quot;</span>
    <span class="s1">x0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_1d</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">dx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_1d</span><span class="s2">(</span><span class="s1">dx</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">char </span><span class="s2">== </span><span class="s4">'F'</span><span class="s2">:</span>
        <span class="s1">scale </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps </span><span class="s2">* </span><span class="s3">1e2</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s3">1e-2</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">scale </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps </span><span class="s2">* </span><span class="s3">1e3</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s3">1e-4</span>

    <span class="s1">y0 </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">)</span>
    <span class="s1">yp </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">dx</span><span class="s2">*</span><span class="s1">scale</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">)/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">dx</span><span class="s2">))</span>
    <span class="s1">ym </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x0 </span><span class="s2">- </span><span class="s1">dx</span><span class="s2">*</span><span class="s1">scale</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">)/</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">dx</span><span class="s2">))</span>

    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">.</span><span class="s1">real </span><span class="s2">- </span><span class="s1">yp</span><span class="s2">.</span><span class="s1">real</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">.</span><span class="s1">imag </span><span class="s2">- </span><span class="s1">yp</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">yp</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">.</span><span class="s1">real </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">.</span><span class="s1">real</span><span class="s2">*</span><span class="s1">re_sign</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">ym</span><span class="s2">))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">.</span><span class="s1">imag </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">*</span><span class="s1">im_sign</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">, </span><span class="s1">ym</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">sig_zero_ok</span><span class="s2">:</span>
        <span class="s6"># check that signed zeros also work as a displacement</span>
        <span class="s1">jr </span><span class="s2">= (</span><span class="s1">x0</span><span class="s2">.</span><span class="s1">real </span><span class="s2">== </span><span class="s3">0</span><span class="s2">) &amp; (</span><span class="s1">dx</span><span class="s2">.</span><span class="s1">real </span><span class="s2">!= </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">ji </span><span class="s2">= (</span><span class="s1">x0</span><span class="s2">.</span><span class="s1">imag </span><span class="s2">== </span><span class="s3">0</span><span class="s2">) &amp; (</span><span class="s1">dx</span><span class="s2">.</span><span class="s1">imag </span><span class="s2">!= </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">jr</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x0</span><span class="s2">[</span><span class="s1">jr</span><span class="s2">]</span>
            <span class="s1">x</span><span class="s2">.</span><span class="s1">real </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span>
            <span class="s1">ym </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">jr</span><span class="s2">].</span><span class="s1">real </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">.</span><span class="s1">real</span><span class="s2">*</span><span class="s1">re_sign</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">jr</span><span class="s2">], </span><span class="s1">ym</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">jr</span><span class="s2">].</span><span class="s1">imag </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">*</span><span class="s1">im_sign</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">jr</span><span class="s2">], </span><span class="s1">ym</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">ji</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x0</span><span class="s2">[</span><span class="s1">ji</span><span class="s2">]</span>
            <span class="s1">x</span><span class="s2">.</span><span class="s1">imag </span><span class="s2">= </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">NZERO</span>
            <span class="s1">ym </span><span class="s2">= </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">ji</span><span class="s2">].</span><span class="s1">real </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">.</span><span class="s1">real</span><span class="s2">*</span><span class="s1">re_sign</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">ji</span><span class="s2">], </span><span class="s1">ym</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">absolute</span><span class="s2">(</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">ji</span><span class="s2">].</span><span class="s1">imag </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">*</span><span class="s1">im_sign</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">), (</span><span class="s1">y0</span><span class="s2">[</span><span class="s1">ji</span><span class="s2">], </span><span class="s1">ym</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_copysign</span><span class="s2">():</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">copysign</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">) == -</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copysign</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">) &lt; </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s3">1 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copysign</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">) &gt; </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">copysign</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">copysign</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)))</span>

<span class="s0">def </span><span class="s1">_test_nextafter</span><span class="s2">(</span><span class="s1">t</span><span class="s2">):</span>
    <span class="s1">one </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">two </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">zero </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">).</span><span class="s1">eps</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">one</span><span class="s2">, </span><span class="s1">two</span><span class="s2">) - </span><span class="s1">one </span><span class="s2">== </span><span class="s1">eps</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">one</span><span class="s2">, </span><span class="s1">zero</span><span class="s2">) - </span><span class="s1">one </span><span class="s2">&lt; </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">one</span><span class="s2">)))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">one</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">one</span><span class="s2">, </span><span class="s1">one</span><span class="s2">) == </span><span class="s1">one</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_nextafter</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_test_nextafter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nextafterf</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_test_nextafter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">),</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;long double is same as double&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">condition</span><span class="s2">=</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;ppc64&quot;</span><span class="s2">),</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;IBM double double&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nextafterl</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_test_nextafter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nextafter_0</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">t</span><span class="s2">, </span><span class="s1">direction </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">sctypes</span><span class="s2">[</span><span class="s4">'float'</span><span class="s2">], (</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">)):</span>
        <span class="s6"># The value of tiny for double double is NaN, so we need to pass the</span>
        <span class="s6"># assert</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">).</span><span class="s1">tiny</span><span class="s2">):</span>
                <span class="s1">tiny </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">).</span><span class="s1">tiny</span>
                <span class="s1">assert_</span><span class="s2">(</span>
                    <span class="s3">0. </span><span class="s2">&lt; </span><span class="s1">direction </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">t</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">t</span><span class="s2">(</span><span class="s1">direction</span><span class="s2">)) &lt; </span><span class="s1">tiny</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">t</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">t</span><span class="s2">(</span><span class="s1">direction</span><span class="s2">)) / </span><span class="s1">t</span><span class="s2">(</span><span class="s3">2.1</span><span class="s2">), </span><span class="s1">direction </span><span class="s2">* </span><span class="s3">0.0</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">_test_spacing</span><span class="s2">(</span><span class="s1">t</span><span class="s2">):</span>
    <span class="s1">one </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">t</span><span class="s2">).</span><span class="s1">eps</span>
    <span class="s1">nan </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
    <span class="s1">inf </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s1">one</span><span class="s2">), </span><span class="s1">eps</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s1">nan</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s1">inf</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(-</span><span class="s1">inf</span><span class="s2">)))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s1">t</span><span class="s2">(</span><span class="s3">1e30</span><span class="s2">)) != </span><span class="s3">0</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_spacing</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_test_spacing</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_spacingf</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_test_spacing</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">),</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;long double is same as double&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">condition</span><span class="s2">=</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;ppc64&quot;</span><span class="s2">),</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;IBM double double&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_spacingl</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">_test_spacing</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_spacing_gfortran</span><span class="s2">():</span>
    <span class="s6"># Reference from this fortran file, built with gfortran 4.3.3 on linux</span>
    <span class="s6"># 32bits:</span>
    <span class="s6">#       PROGRAM test_spacing</span>
    <span class="s6">#        INTEGER, PARAMETER :: SGL = SELECTED_REAL_KIND(p=6, r=37)</span>
    <span class="s6">#        INTEGER, PARAMETER :: DBL = SELECTED_REAL_KIND(p=13, r=200)</span>
    <span class="s6">#</span>
    <span class="s6">#        WRITE(*,*) spacing(0.00001_DBL)</span>
    <span class="s6">#        WRITE(*,*) spacing(1.0_DBL)</span>
    <span class="s6">#        WRITE(*,*) spacing(1000._DBL)</span>
    <span class="s6">#        WRITE(*,*) spacing(10500._DBL)</span>
    <span class="s6">#</span>
    <span class="s6">#        WRITE(*,*) spacing(0.00001_SGL)</span>
    <span class="s6">#        WRITE(*,*) spacing(1.0_SGL)</span>
    <span class="s6">#        WRITE(*,*) spacing(1000._SGL)</span>
    <span class="s6">#        WRITE(*,*) spacing(10500._SGL)</span>
    <span class="s6">#       END PROGRAM</span>
    <span class="s1">ref </span><span class="s2">= {</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">: [</span><span class="s3">1.69406589450860068E-021</span><span class="s2">,</span>
                        <span class="s3">2.22044604925031308E-016</span><span class="s2">,</span>
                        <span class="s3">1.13686837721616030E-013</span><span class="s2">,</span>
                        <span class="s3">1.81898940354585648E-012</span><span class="s2">],</span>
           <span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">: [</span><span class="s3">9.09494702E-13</span><span class="s2">,</span>
                        <span class="s3">1.19209290E-07</span><span class="s2">,</span>
                        <span class="s3">6.10351563E-05</span><span class="s2">,</span>
                        <span class="s3">9.76562500E-04</span><span class="s2">]}</span>

    <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">dec_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">], (</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">)):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">, </span><span class="s3">10500</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">ref</span><span class="s2">[</span><span class="s1">dt</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s1">dec_</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_nextafter_vs_spacing</span><span class="s2">():</span>
    <span class="s6"># XXX: spacing does not handle long double yet</span>
    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]:</span>
        <span class="s0">for </span><span class="s1">_f </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1e-5</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">]:</span>
            <span class="s1">f </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s1">_f</span><span class="s2">)</span>
            <span class="s1">f1 </span><span class="s2">= </span><span class="s1">t</span><span class="s2">(</span><span class="s1">_f </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nextafter</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">) - </span><span class="s1">f </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s1">f</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_pos_nan</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Check np.nan is a positive nan.&quot;&quot;&quot;</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">signbit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_reduceat</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test bug in reduceat when structured arrays are not copied.&quot;&quot;&quot;</span>
    <span class="s1">db </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'name'</span><span class="s2">, </span><span class="s4">'S11'</span><span class="s2">), (</span><span class="s4">'time'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">), (</span><span class="s4">'value'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)])</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">([</span><span class="s3">100</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">db</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s4">'name'</span><span class="s2">] = </span><span class="s4">'Simple'</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s4">'time'</span><span class="s2">] = </span><span class="s3">10</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s4">'value'</span><span class="s2">] = </span><span class="s3">100</span>
    <span class="s1">indx </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">25</span><span class="s2">]</span>

    <span class="s1">h2 </span><span class="s2">= []</span>
    <span class="s1">val1 </span><span class="s2">= </span><span class="s1">indx</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">val2 </span><span class="s0">in </span><span class="s1">indx</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:]:</span>
        <span class="s1">h2</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'value'</span><span class="s2">][</span><span class="s1">val1</span><span class="s2">:</span><span class="s1">val2</span><span class="s2">]))</span>
        <span class="s1">val1 </span><span class="s2">= </span><span class="s1">val2</span>
    <span class="s1">h2</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'value'</span><span class="s2">][</span><span class="s1">val1</span><span class="s2">:]))</span>
    <span class="s1">h2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">)</span>

    <span class="s6"># test buffered -- this should work</span>
    <span class="s1">h1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'value'</span><span class="s2">], </span><span class="s1">indx</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">h1</span><span class="s2">, </span><span class="s1">h2</span><span class="s2">)</span>

    <span class="s6"># This is when the error occurs.</span>
    <span class="s6"># test no buffer</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">setbufsize</span><span class="s2">(</span><span class="s3">32</span><span class="s2">)</span>
    <span class="s1">h1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'value'</span><span class="s2">], </span><span class="s1">indx</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">setbufsize</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">UFUNC_BUFSIZE_DEFAULT</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">h1</span><span class="s2">, </span><span class="s1">h2</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_reduceat_empty</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Reduceat should work with empty arrays&quot;&quot;&quot;</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s4">'i4'</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s4">'f8'</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">0</span><span class="s2">,))</span>
    <span class="s6"># Another case with a slightly different zero-sized shape</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_complex_nan_comparisons</span><span class="s2">():</span>
    <span class="s1">nans </span><span class="s2">= [</span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)]</span>
    <span class="s1">fins </span><span class="s2">= [</span><span class="s1">complex</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">),</span>
            <span class="s1">complex</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), </span><span class="s1">complex</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)]</span>

    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">nans </span><span class="s2">+ </span><span class="s1">fins</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">x</span><span class="s2">])</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">nans </span><span class="s2">+ </span><span class="s1">fins</span><span class="s2">:</span>
                <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">y</span><span class="s2">])</span>

                <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">y</span><span class="s2">):</span>
                    <span class="s0">continue</span>

                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">y</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">&quot;%r &lt; %r&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s1">y</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">&quot;%r &gt; %r&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s1">y</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">&quot;%r &lt;= %r&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s1">y</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">&quot;%r &gt;= %r&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x </span><span class="s2">== </span><span class="s1">y</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s4">&quot;%r == %r&quot; </span><span class="s2">% (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_rint_big_int</span><span class="s2">():</span>
    <span class="s6"># np.rint bug for large integer values on Windows 32-bit and MKL</span>
    <span class="s6"># https://github.com/numpy/numpy/issues/6685</span>
    <span class="s1">val </span><span class="s2">= </span><span class="s3">4607998452777363968</span>
    <span class="s6"># This is exactly representable in floating point</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)))</span>
    <span class="s6"># Rint should not change the value</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rint</span><span class="s2">(</span><span class="s1">val</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'ftype'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_memoverlap_accumulate</span><span class="s2">(</span><span class="s1">ftype</span><span class="s2">):</span>
    <span class="s6"># Reproduces bug https://github.com/numpy/numpy/issues/15597</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.61</span><span class="s2">, </span><span class="s3">0.60</span><span class="s2">, </span><span class="s3">0.77</span><span class="s2">, </span><span class="s3">0.41</span><span class="s2">, </span><span class="s3">0.19</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">ftype</span><span class="s2">)</span>
    <span class="s1">out_max </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.61</span><span class="s2">, </span><span class="s3">0.61</span><span class="s2">, </span><span class="s3">0.77</span><span class="s2">, </span><span class="s3">0.77</span><span class="s2">, </span><span class="s3">0.77</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">ftype</span><span class="s2">)</span>
    <span class="s1">out_min </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.61</span><span class="s2">, </span><span class="s3">0.60</span><span class="s2">, </span><span class="s3">0.60</span><span class="s2">, </span><span class="s3">0.41</span><span class="s2">, </span><span class="s3">0.19</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">ftype</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), </span><span class="s1">out_max</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), </span><span class="s1">out_min</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;ufunc, dtype&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s1">UFUNCS_BINARY_ACC</span>
    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">types</span>
    <span class="s0">if </span><span class="s1">t</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] == </span><span class="s4">'?' </span><span class="s0">and </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">not in </span><span class="s4">'DFGMmO'</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_memoverlap_accumulate_cmp</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'For generic signatures only'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">256</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]*</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">acc </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'?'</span><span class="s2">)</span>
        <span class="s1">acc_u8 </span><span class="s2">= </span><span class="s1">acc</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">acc_u8</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;ufunc, dtype&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">ufunc </span><span class="s0">in </span><span class="s1">UFUNCS_BINARY_ACC</span>
    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">types</span>
    <span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s1">t</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] </span><span class="s0">and </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s1">t</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] </span><span class="s0">and </span><span class="s1">t</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">not in </span><span class="s4">'DFGMmO?'</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_memoverlap_accumulate_symmetric</span><span class="s2">(</span><span class="s1">ufunc</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">'For generic signatures only'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">size </span><span class="s0">in </span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">64</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">256</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]*</span><span class="s1">size</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">acc </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">ufunc</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">exp</span><span class="s2">, </span><span class="s1">acc</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_signaling_nan_exceptions</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">assert_no_warnings</span><span class="s2">():</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'float32'</span><span class="s2">, </span><span class="s1">buffer</span><span class="s2">=</span><span class="s7">b'</span><span class="s0">\x00\xe0\xbf\xff</span><span class="s7">'</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;arr&quot;</span><span class="s2">, [</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">2</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">matrix</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">matrix</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]),</span>
    <span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_outer_subclass_preserve</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
    <span class="s6"># for gh-8661</span>
    <span class="s0">class </span><span class="s1">foo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">): </span><span class="s0">pass</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">), </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">actual</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s2">== </span><span class="s4">'foo'</span>

<span class="s0">def </span><span class="s1">test_outer_bad_subclass</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">BadArr1</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">__array_finalize__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s6"># The outer call reshapes to 3 dims, try to do a bad reshape.</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s3">3</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">+ (</span><span class="s3">1</span><span class="s2">,)</span>

    <span class="s0">class </span><span class="s1">BadArr2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">__array_finalize__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">BadArr2</span><span class="s2">):</span>
                <span class="s6"># outer inserts 1-sized dims. In that case disturb them.</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] == </span><span class="s3">1</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[::-</span><span class="s3">1</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">cls </span><span class="s0">in </span><span class="s2">[</span><span class="s1">BadArr1</span><span class="s2">, </span><span class="s1">BadArr2</span><span class="s2">]:</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">a</span><span class="s2">:</span>
            <span class="s6"># The first array gets reshaped (not the second one)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

        <span class="s6"># This actually works, since we only see the reshaping error:</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">arr</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">cls</span>

<span class="s0">def </span><span class="s1">test_outer_exceeds_maxdims</span><span class="s2">():</span>
    <span class="s1">deep </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">1</span><span class="s2">,) * </span><span class="s3">33</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">deep</span><span class="s2">, </span><span class="s1">deep</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_bad_legacy_ufunc_silent_errors</span><span class="s2">():</span>
    <span class="s6"># legacy ufuncs can't report errors and NumPy can't check if the GIL</span>
    <span class="s6"># is released.  So NumPy has to check after the GIL is released just to</span>
    <span class="s6"># cover all bases.  `np.power` uses/used to use this.</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s6"># not contiguous means the fast-path cannot be taken</span>
        <span class="s1">non_contig </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s3">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)[:, ::</span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">(</span><span class="s1">non_contig</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">.</span><span class="s1">outer</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">.</span><span class="s1">reduceat</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">.</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error</span><span class="s2">.</span><span class="s1">at</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">arr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'x1'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">3.0</span><span class="s2">), [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_bad_legacy_gufunc_silent_errors</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">):</span>
    <span class="s6"># Verify that an exception raised in a gufunc loop propagates correctly.</span>
    <span class="s6"># The signature of always_error_gufunc is '(i),()-&gt;()'.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;How unexpected :\)!&quot;</span><span class="s2">):</span>
        <span class="s1">ncu_tests</span><span class="s2">.</span><span class="s1">always_error_gufunc</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAddDocstring</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">optimize </span><span class="s2">== </span><span class="s3">2</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Python running -OO&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_PYPY</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;PyPy does not modify tp_doc&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_add_same_docstring</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># test for attributes (which are C-level defined)</span>
        <span class="s1">ncu</span><span class="s2">.</span><span class="s1">add_docstring</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">.</span><span class="s1">__doc__</span><span class="s2">)</span>

        <span class="s6"># And typical functions:</span>
        <span class="s0">def </span><span class="s1">func</span><span class="s2">():</span>
            <span class="s5">&quot;&quot;&quot;docstring&quot;&quot;&quot;</span>
            <span class="s0">return</span>

        <span class="s1">ncu</span><span class="s2">.</span><span class="s1">add_docstring</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">func</span><span class="s2">.</span><span class="s1">__doc__</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">optimize </span><span class="s2">== </span><span class="s3">2</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Python running -OO&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_different_docstring_fails</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># test for attributes (which are C-level defined)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
            <span class="s1">ncu</span><span class="s2">.</span><span class="s1">add_docstring</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">, </span><span class="s4">&quot;different docstring&quot;</span><span class="s2">)</span>

        <span class="s6"># And typical functions:</span>
        <span class="s0">def </span><span class="s1">func</span><span class="s2">():</span>
            <span class="s5">&quot;&quot;&quot;docstring&quot;&quot;&quot;</span>
            <span class="s0">return</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
            <span class="s1">ncu</span><span class="s2">.</span><span class="s1">add_docstring</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s4">&quot;different docstring&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestAdd_newdoc_ufunc</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_ufunc_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">_add_newdoc_ufunc</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s4">&quot;blah&quot;</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">_add_newdoc_ufunc</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s4">&quot;blah&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_string_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">_add_newdoc_ufunc</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
</pre>
</body>
</html>