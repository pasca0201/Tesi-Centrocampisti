<html>
<head>
<title>split.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
split.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Allows building all the variable fonts of a DesignSpace version 5 by 
splitting the document into interpolable sub-space, then into each VF. 
&quot;&quot;&quot;</span>

<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">math</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">Callable</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">, </span><span class="s1">Iterator</span><span class="s3">, </span><span class="s1">List</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">, </span><span class="s1">cast</span>

<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">designspaceLib </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">AxisDescriptor</span><span class="s3">,</span>
    <span class="s1">AxisMappingDescriptor</span><span class="s3">,</span>
    <span class="s1">DesignSpaceDocument</span><span class="s3">,</span>
    <span class="s1">DiscreteAxisDescriptor</span><span class="s3">,</span>
    <span class="s1">InstanceDescriptor</span><span class="s3">,</span>
    <span class="s1">RuleDescriptor</span><span class="s3">,</span>
    <span class="s1">SimpleLocationDict</span><span class="s3">,</span>
    <span class="s1">SourceDescriptor</span><span class="s3">,</span>
    <span class="s1">VariableFontDescriptor</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">designspaceLib</span><span class="s3">.</span><span class="s1">statNames </span><span class="s2">import </span><span class="s1">StatNames</span><span class="s3">, </span><span class="s1">getStatNames</span>
<span class="s2">from </span><span class="s1">fontTools</span><span class="s3">.</span><span class="s1">designspaceLib</span><span class="s3">.</span><span class="s1">types </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ConditionSet</span><span class="s3">,</span>
    <span class="s1">Range</span><span class="s3">,</span>
    <span class="s1">Region</span><span class="s3">,</span>
    <span class="s1">getVFUserRegion</span><span class="s3">,</span>
    <span class="s1">locationInRegion</span><span class="s3">,</span>
    <span class="s1">regionInRegion</span><span class="s3">,</span>
    <span class="s1">userRegionToDesignRegion</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s1">LOGGER </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s1">__name__</span><span class="s3">)</span>

<span class="s1">MakeInstanceFilenameCallable </span><span class="s3">= </span><span class="s1">Callable</span><span class="s3">[</span>
    <span class="s3">[</span><span class="s1">DesignSpaceDocument</span><span class="s3">, </span><span class="s1">InstanceDescriptor</span><span class="s3">, </span><span class="s1">StatNames</span><span class="s3">], </span><span class="s1">str</span>
<span class="s3">]</span>


<span class="s2">def </span><span class="s1">defaultMakeInstanceFilename</span><span class="s3">(</span>
    <span class="s1">doc</span><span class="s3">: </span><span class="s1">DesignSpaceDocument</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">: </span><span class="s1">InstanceDescriptor</span><span class="s3">, </span><span class="s1">statNames</span><span class="s3">: </span><span class="s1">StatNames</span>
<span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Default callable to synthesize an instance filename 
    when makeNames=True, for instances that don't specify an instance name 
    in the designspace. This part of the name generation can be overriden 
    because it's not specified by the STAT table. 
    &quot;&quot;&quot;</span>
    <span class="s1">familyName </span><span class="s3">= </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">familyName </span><span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">familyNames</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;en&quot;</span><span class="s3">)</span>
    <span class="s1">styleName </span><span class="s3">= </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleName </span><span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">styleNames</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;en&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">familyName</span><span class="s2">}</span><span class="s4">-</span><span class="s2">{</span><span class="s1">styleName</span><span class="s2">}</span><span class="s4">.ttf&quot;</span>


<span class="s2">def </span><span class="s1">splitInterpolable</span><span class="s3">(</span>
    <span class="s1">doc</span><span class="s3">: </span><span class="s1">DesignSpaceDocument</span><span class="s3">,</span>
    <span class="s1">makeNames</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s1">expandLocations</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s1">makeInstanceFilename</span><span class="s3">: </span><span class="s1">MakeInstanceFilenameCallable </span><span class="s3">= </span><span class="s1">defaultMakeInstanceFilename</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; Iterator</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">SimpleLocationDict</span><span class="s3">, </span><span class="s1">DesignSpaceDocument</span><span class="s3">]]:</span>
    <span class="s0">&quot;&quot;&quot;Split the given DS5 into several interpolable sub-designspaces. 
    There are as many interpolable sub-spaces as there are combinations of 
    discrete axis values. 
 
    E.g. with axes: 
        - italic (discrete) Upright or Italic 
        - style (discrete) Sans or Serif 
        - weight (continuous) 100 to 900 
 
    There are 4 sub-spaces in which the Weight axis should interpolate: 
    (Upright, Sans), (Upright, Serif), (Italic, Sans) and (Italic, Serif). 
 
    The sub-designspaces still include the full axis definitions and STAT data, 
    but the rules, sources, variable fonts, instances are trimmed down to only 
    keep what falls within the interpolable sub-space. 
 
    Args: 
      - ``makeNames``: Whether to compute the instance family and style 
        names using the STAT data. 
      - ``expandLocations``: Whether to turn all locations into &quot;full&quot; 
        locations, including implicit default axis values where missing. 
      - ``makeInstanceFilename``: Callable to synthesize an instance filename 
        when makeNames=True, for instances that don't specify an instance name 
        in the designspace. This part of the name generation can be overridden 
        because it's not specified by the STAT table. 
 
    .. versionadded:: 5.0 
    &quot;&quot;&quot;</span>
    <span class="s1">discreteAxes </span><span class="s3">= []</span>
    <span class="s1">interpolableUserRegion</span><span class="s3">: </span><span class="s1">Region </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">, </span><span class="s4">&quot;values&quot;</span><span class="s3">):</span>
            <span class="s5"># Mypy doesn't support narrowing union types via hasattr()</span>
            <span class="s5"># TODO(Python 3.10): use TypeGuard</span>
            <span class="s5"># https://mypy.readthedocs.io/en/stable/type_narrowing.html</span>
            <span class="s1">axis </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">DiscreteAxisDescriptor</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s1">discreteAxes</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">axis </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">AxisDescriptor</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s1">interpolableUserRegion</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">Range</span><span class="s3">(</span>
                <span class="s1">axis</span><span class="s3">.</span><span class="s1">minimum</span><span class="s3">,</span>
                <span class="s1">axis</span><span class="s3">.</span><span class="s1">maximum</span><span class="s3">,</span>
                <span class="s1">axis</span><span class="s3">.</span><span class="s1">default</span><span class="s3">,</span>
            <span class="s3">)</span>
    <span class="s1">valueCombinations </span><span class="s3">= </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">(*[</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">values </span><span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">discreteAxes</span><span class="s3">])</span>
    <span class="s2">for </span><span class="s1">values </span><span class="s2">in </span><span class="s1">valueCombinations</span><span class="s3">:</span>
        <span class="s1">discreteUserLocation </span><span class="s3">= {</span>
            <span class="s1">discreteAxis</span><span class="s3">.</span><span class="s1">name</span><span class="s3">: </span><span class="s1">value</span>
            <span class="s2">for </span><span class="s1">discreteAxis</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">discreteAxes</span><span class="s3">, </span><span class="s1">values</span><span class="s3">)</span>
        <span class="s3">}</span>
        <span class="s1">subDoc </span><span class="s3">= </span><span class="s1">_extractSubSpace</span><span class="s3">(</span>
            <span class="s1">doc</span><span class="s3">,</span>
            <span class="s3">{**</span><span class="s1">interpolableUserRegion</span><span class="s3">, **</span><span class="s1">discreteUserLocation</span><span class="s3">},</span>
            <span class="s1">keepVFs</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">makeNames</span><span class="s3">=</span><span class="s1">makeNames</span><span class="s3">,</span>
            <span class="s1">expandLocations</span><span class="s3">=</span><span class="s1">expandLocations</span><span class="s3">,</span>
            <span class="s1">makeInstanceFilename</span><span class="s3">=</span><span class="s1">makeInstanceFilename</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">yield </span><span class="s1">discreteUserLocation</span><span class="s3">, </span><span class="s1">subDoc</span>


<span class="s2">def </span><span class="s1">splitVariableFonts</span><span class="s3">(</span>
    <span class="s1">doc</span><span class="s3">: </span><span class="s1">DesignSpaceDocument</span><span class="s3">,</span>
    <span class="s1">makeNames</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
    <span class="s1">expandLocations</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
    <span class="s1">makeInstanceFilename</span><span class="s3">: </span><span class="s1">MakeInstanceFilenameCallable </span><span class="s3">= </span><span class="s1">defaultMakeInstanceFilename</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; Iterator</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">DesignSpaceDocument</span><span class="s3">]]:</span>
    <span class="s0">&quot;&quot;&quot;Convert each variable font listed in this document into a standalone 
    designspace. This can be used to compile all the variable fonts from a 
    format 5 designspace using tools that can only deal with 1 VF at a time. 
 
    Args: 
      - ``makeNames``: Whether to compute the instance family and style 
        names using the STAT data. 
      - ``expandLocations``: Whether to turn all locations into &quot;full&quot; 
        locations, including implicit default axis values where missing. 
      - ``makeInstanceFilename``: Callable to synthesize an instance filename 
        when makeNames=True, for instances that don't specify an instance name 
        in the designspace. This part of the name generation can be overridden 
        because it's not specified by the STAT table. 
 
    .. versionadded:: 5.0 
    &quot;&quot;&quot;</span>
    <span class="s5"># Make one DesignspaceDoc v5 for each variable font</span>
    <span class="s2">for </span><span class="s1">vf </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">getVariableFonts</span><span class="s3">():</span>
        <span class="s1">vfUserRegion </span><span class="s3">= </span><span class="s1">getVFUserRegion</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">vf</span><span class="s3">)</span>
        <span class="s1">vfDoc </span><span class="s3">= </span><span class="s1">_extractSubSpace</span><span class="s3">(</span>
            <span class="s1">doc</span><span class="s3">,</span>
            <span class="s1">vfUserRegion</span><span class="s3">,</span>
            <span class="s1">keepVFs</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">makeNames</span><span class="s3">=</span><span class="s1">makeNames</span><span class="s3">,</span>
            <span class="s1">expandLocations</span><span class="s3">=</span><span class="s1">expandLocations</span><span class="s3">,</span>
            <span class="s1">makeInstanceFilename</span><span class="s3">=</span><span class="s1">makeInstanceFilename</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">vfDoc</span><span class="s3">.</span><span class="s1">lib </span><span class="s3">= {**</span><span class="s1">vfDoc</span><span class="s3">.</span><span class="s1">lib</span><span class="s3">, **</span><span class="s1">vf</span><span class="s3">.</span><span class="s1">lib</span><span class="s3">}</span>
        <span class="s2">yield </span><span class="s1">vf</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">vfDoc</span>


<span class="s2">def </span><span class="s1">convert5to4</span><span class="s3">(</span>
    <span class="s1">doc</span><span class="s3">: </span><span class="s1">DesignSpaceDocument</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">DesignSpaceDocument</span><span class="s3">]:</span>
    <span class="s0">&quot;&quot;&quot;Convert each variable font listed in this document into a standalone 
    format 4 designspace. This can be used to compile all the variable fonts 
    from a format 5 designspace using tools that only know about format 4. 
 
    .. versionadded:: 5.0 
    &quot;&quot;&quot;</span>
    <span class="s1">vfs </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">_location</span><span class="s3">, </span><span class="s1">subDoc </span><span class="s2">in </span><span class="s1">splitInterpolable</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">vfName</span><span class="s3">, </span><span class="s1">vfDoc </span><span class="s2">in </span><span class="s1">splitVariableFonts</span><span class="s3">(</span><span class="s1">subDoc</span><span class="s3">):</span>
            <span class="s1">vfDoc</span><span class="s3">.</span><span class="s1">formatVersion </span><span class="s3">= </span><span class="s4">&quot;4.1&quot;</span>
            <span class="s1">vfs</span><span class="s3">[</span><span class="s1">vfName</span><span class="s3">] = </span><span class="s1">vfDoc</span>
    <span class="s2">return </span><span class="s1">vfs</span>


<span class="s2">def </span><span class="s1">_extractSubSpace</span><span class="s3">(</span>
    <span class="s1">doc</span><span class="s3">: </span><span class="s1">DesignSpaceDocument</span><span class="s3">,</span>
    <span class="s1">userRegion</span><span class="s3">: </span><span class="s1">Region</span><span class="s3">,</span>
    <span class="s3">*,</span>
    <span class="s1">keepVFs</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">,</span>
    <span class="s1">makeNames</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">,</span>
    <span class="s1">expandLocations</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">,</span>
    <span class="s1">makeInstanceFilename</span><span class="s3">: </span><span class="s1">MakeInstanceFilenameCallable</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; DesignSpaceDocument</span><span class="s3">:</span>
    <span class="s1">subDoc </span><span class="s3">= </span><span class="s1">DesignSpaceDocument</span><span class="s3">()</span>
    <span class="s5"># Don't include STAT info</span>
    <span class="s5"># FIXME: (Jany) let's think about it. Not include = OK because the point of</span>
    <span class="s5"># the splitting is to build VFs and we'll use the STAT data of the full</span>
    <span class="s5"># document to generate the STAT of the VFs, so &quot;no need&quot; to have STAT data</span>
    <span class="s5"># in sub-docs. Counterpoint: what if someone wants to split this DS for</span>
    <span class="s5"># other purposes?  Maybe for that it would be useful to also subset the STAT</span>
    <span class="s5"># data?</span>
    <span class="s5"># subDoc.elidedFallbackName = doc.elidedFallbackName</span>

    <span class="s2">def </span><span class="s1">maybeExpandDesignLocation</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">expandLocations</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">object</span><span class="s3">.</span><span class="s1">getFullDesignLocation</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">object</span><span class="s3">.</span><span class="s1">designLocation</span>

    <span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">:</span>
        <span class="s1">range </span><span class="s3">= </span><span class="s1">userRegion</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">name</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">range</span><span class="s3">, </span><span class="s1">Range</span><span class="s3">) </span><span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">, </span><span class="s4">&quot;minimum&quot;</span><span class="s3">):</span>
            <span class="s5"># Mypy doesn't support narrowing union types via hasattr()</span>
            <span class="s5"># TODO(Python 3.10): use TypeGuard</span>
            <span class="s5"># https://mypy.readthedocs.io/en/stable/type_narrowing.html</span>
            <span class="s1">axis </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">AxisDescriptor</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">addAxis</span><span class="s3">(</span>
                <span class="s1">AxisDescriptor</span><span class="s3">(</span>
                    <span class="s5"># Same info</span>
                    <span class="s1">tag</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">tag</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                    <span class="s1">labelNames</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">labelNames</span><span class="s3">,</span>
                    <span class="s1">hidden</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">hidden</span><span class="s3">,</span>
                    <span class="s5"># Subset range</span>
                    <span class="s1">minimum</span><span class="s3">=</span><span class="s1">max</span><span class="s3">(</span><span class="s1">range</span><span class="s3">.</span><span class="s1">minimum</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">minimum</span><span class="s3">),</span>
                    <span class="s1">default</span><span class="s3">=</span><span class="s1">range</span><span class="s3">.</span><span class="s1">default </span><span class="s2">or </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">default</span><span class="s3">,</span>
                    <span class="s1">maximum</span><span class="s3">=</span><span class="s1">min</span><span class="s3">(</span><span class="s1">range</span><span class="s3">.</span><span class="s1">maximum</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">maximum</span><span class="s3">),</span>
                    <span class="s1">map</span><span class="s3">=[</span>
                        <span class="s3">(</span><span class="s1">user</span><span class="s3">, </span><span class="s1">design</span><span class="s3">)</span>
                        <span class="s2">for </span><span class="s1">user</span><span class="s3">, </span><span class="s1">design </span><span class="s2">in </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">map</span>
                        <span class="s2">if </span><span class="s1">range</span><span class="s3">.</span><span class="s1">minimum </span><span class="s3">&lt;= </span><span class="s1">user </span><span class="s3">&lt;= </span><span class="s1">range</span><span class="s3">.</span><span class="s1">maximum</span>
                    <span class="s3">],</span>
                    <span class="s5"># Don't include STAT info</span>
                    <span class="s1">axisOrdering</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                    <span class="s1">axisLabels</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

    <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">axisMappings </span><span class="s3">= </span><span class="s1">mappings </span><span class="s3">= []</span>
    <span class="s1">subDocAxes </span><span class="s3">= {</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">name </span><span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">subDoc</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">}</span>
    <span class="s2">for </span><span class="s1">mapping </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">axisMappings</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span><span class="s1">axis </span><span class="s2">in </span><span class="s1">subDocAxes </span><span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">mapping</span><span class="s3">.</span><span class="s1">inputLocation</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()):</span>
            <span class="s2">continue</span>
        <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span><span class="s1">axis </span><span class="s2">in </span><span class="s1">subDocAxes </span><span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">mapping</span><span class="s3">.</span><span class="s1">outputLocation</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()):</span>
            <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                <span class="s4">&quot;In axis mapping from input %s, some output axes are not in the variable-font: %s&quot;</span><span class="s3">,</span>
                <span class="s1">mapping</span><span class="s3">.</span><span class="s1">inputLocation</span><span class="s3">,</span>
                <span class="s1">mapping</span><span class="s3">.</span><span class="s1">outputLocation</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s2">continue</span>

        <span class="s1">mappingAxes </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">mappingAxes</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">mapping</span><span class="s3">.</span><span class="s1">inputLocation</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())</span>
        <span class="s1">mappingAxes</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">mapping</span><span class="s3">.</span><span class="s1">outputLocation</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())</span>
        <span class="s2">for </span><span class="s1">axis </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">axes</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">name </span><span class="s2">not in </span><span class="s1">mappingAxes</span><span class="s3">:</span>
                <span class="s2">continue</span>
            <span class="s1">range </span><span class="s3">= </span><span class="s1">userRegion</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">.</span><span class="s1">name</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">range</span><span class="s3">.</span><span class="s1">minimum </span><span class="s3">!= </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">minimum</span>
                <span class="s2">or </span><span class="s3">(</span><span class="s1">range</span><span class="s3">.</span><span class="s1">default </span><span class="s2">is not None and </span><span class="s1">range</span><span class="s3">.</span><span class="s1">default </span><span class="s3">!= </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">default</span><span class="s3">)</span>
                <span class="s2">or </span><span class="s1">range</span><span class="s3">.</span><span class="s1">maximum </span><span class="s3">!= </span><span class="s1">axis</span><span class="s3">.</span><span class="s1">maximum</span>
            <span class="s3">):</span>
                <span class="s1">LOGGER</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span>
                    <span class="s4">&quot;Limiting axis ranges used in &lt;mapping&gt; elements not supported: %s&quot;</span><span class="s3">,</span>
                    <span class="s1">axis</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                <span class="s3">)</span>
                <span class="s2">continue</span>

        <span class="s1">mappings</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
            <span class="s1">AxisMappingDescriptor</span><span class="s3">(</span>
                <span class="s1">inputLocation</span><span class="s3">=</span><span class="s1">mapping</span><span class="s3">.</span><span class="s1">inputLocation</span><span class="s3">,</span>
                <span class="s1">outputLocation</span><span class="s3">=</span><span class="s1">mapping</span><span class="s3">.</span><span class="s1">outputLocation</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s5"># Don't include STAT info</span>
    <span class="s5"># subDoc.locationLabels = doc.locationLabels</span>

    <span class="s5"># Rules: subset them based on conditions</span>
    <span class="s1">designRegion </span><span class="s3">= </span><span class="s1">userRegionToDesignRegion</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">userRegion</span><span class="s3">)</span>
    <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">rules </span><span class="s3">= </span><span class="s1">_subsetRulesBasedOnConditions</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">rules</span><span class="s3">, </span><span class="s1">designRegion</span><span class="s3">)</span>
    <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">rulesProcessingLast </span><span class="s3">= </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">rulesProcessingLast</span>

    <span class="s5"># Sources: keep only the ones that fall within the kept axis ranges</span>
    <span class="s2">for </span><span class="s1">source </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">sources</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">locationInRegion</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">.</span><span class="s1">map_backward</span><span class="s3">(</span><span class="s1">source</span><span class="s3">.</span><span class="s1">designLocation</span><span class="s3">), </span><span class="s1">userRegion</span><span class="s3">):</span>
            <span class="s2">continue</span>

        <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">addSource</span><span class="s3">(</span>
            <span class="s1">SourceDescriptor</span><span class="s3">(</span>
                <span class="s1">filename</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">,</span>
                <span class="s1">path</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">path</span><span class="s3">,</span>
                <span class="s1">font</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">font</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                <span class="s1">designLocation</span><span class="s3">=</span><span class="s1">_filterLocation</span><span class="s3">(</span>
                    <span class="s1">userRegion</span><span class="s3">, </span><span class="s1">maybeExpandDesignLocation</span><span class="s3">(</span><span class="s1">source</span><span class="s3">)</span>
                <span class="s3">),</span>
                <span class="s1">layerName</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">layerName</span><span class="s3">,</span>
                <span class="s1">familyName</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">familyName</span><span class="s3">,</span>
                <span class="s1">styleName</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">styleName</span><span class="s3">,</span>
                <span class="s1">muteKerning</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">muteKerning</span><span class="s3">,</span>
                <span class="s1">muteInfo</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">muteInfo</span><span class="s3">,</span>
                <span class="s1">mutedGlyphNames</span><span class="s3">=</span><span class="s1">source</span><span class="s3">.</span><span class="s1">mutedGlyphNames</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s5"># Copy family name translations from the old default source to the new default</span>
    <span class="s1">vfDefault </span><span class="s3">= </span><span class="s1">subDoc</span><span class="s3">.</span><span class="s1">findDefault</span><span class="s3">()</span>
    <span class="s1">oldDefault </span><span class="s3">= </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">findDefault</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">vfDefault </span><span class="s2">is not None and </span><span class="s1">oldDefault </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">vfDefault</span><span class="s3">.</span><span class="s1">localisedFamilyName </span><span class="s3">= </span><span class="s1">oldDefault</span><span class="s3">.</span><span class="s1">localisedFamilyName</span>

    <span class="s5"># Variable fonts: keep only the ones that fall within the kept axis ranges</span>
    <span class="s2">if </span><span class="s1">keepVFs</span><span class="s3">:</span>
        <span class="s5"># Note: call getVariableFont() to make the implicit VFs explicit</span>
        <span class="s2">for </span><span class="s1">vf </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">getVariableFonts</span><span class="s3">():</span>
            <span class="s1">vfUserRegion </span><span class="s3">= </span><span class="s1">getVFUserRegion</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">vf</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">regionInRegion</span><span class="s3">(</span><span class="s1">vfUserRegion</span><span class="s3">, </span><span class="s1">userRegion</span><span class="s3">):</span>
                <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">addVariableFont</span><span class="s3">(</span>
                    <span class="s1">VariableFontDescriptor</span><span class="s3">(</span>
                        <span class="s1">name</span><span class="s3">=</span><span class="s1">vf</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                        <span class="s1">filename</span><span class="s3">=</span><span class="s1">vf</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">,</span>
                        <span class="s1">axisSubsets</span><span class="s3">=[</span>
                            <span class="s1">axisSubset</span>
                            <span class="s2">for </span><span class="s1">axisSubset </span><span class="s2">in </span><span class="s1">vf</span><span class="s3">.</span><span class="s1">axisSubsets</span>
                            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">userRegion</span><span class="s3">[</span><span class="s1">axisSubset</span><span class="s3">.</span><span class="s1">name</span><span class="s3">], </span><span class="s1">Range</span><span class="s3">)</span>
                        <span class="s3">],</span>
                        <span class="s1">lib</span><span class="s3">=</span><span class="s1">vf</span><span class="s3">.</span><span class="s1">lib</span><span class="s3">,</span>
                    <span class="s3">)</span>
                <span class="s3">)</span>

    <span class="s5"># Instances: same as Sources + compute missing names</span>
    <span class="s2">for </span><span class="s1">instance </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">instances</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">locationInRegion</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">getFullUserLocation</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">), </span><span class="s1">userRegion</span><span class="s3">):</span>
            <span class="s2">continue</span>

        <span class="s2">if </span><span class="s1">makeNames</span><span class="s3">:</span>
            <span class="s1">statNames </span><span class="s3">= </span><span class="s1">getStatNames</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">getFullUserLocation</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">))</span>
            <span class="s1">familyName </span><span class="s3">= </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">familyName </span><span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">familyNames</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;en&quot;</span><span class="s3">)</span>
            <span class="s1">styleName </span><span class="s3">= </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleName </span><span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">styleNames</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;en&quot;</span><span class="s3">)</span>
            <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">addInstance</span><span class="s3">(</span>
                <span class="s1">InstanceDescriptor</span><span class="s3">(</span>
                    <span class="s1">filename</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">filename</span>
                    <span class="s2">or </span><span class="s1">makeInstanceFilename</span><span class="s3">(</span><span class="s1">doc</span><span class="s3">, </span><span class="s1">instance</span><span class="s3">, </span><span class="s1">statNames</span><span class="s3">),</span>
                    <span class="s1">path</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">path</span><span class="s3">,</span>
                    <span class="s1">font</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">font</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">name </span><span class="s2">or </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">familyName</span><span class="s2">} {</span><span class="s1">styleName</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s1">userLocation</span><span class="s3">={} </span><span class="s2">if </span><span class="s1">expandLocations </span><span class="s2">else </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">userLocation</span><span class="s3">,</span>
                    <span class="s1">designLocation</span><span class="s3">=</span><span class="s1">_filterLocation</span><span class="s3">(</span>
                        <span class="s1">userRegion</span><span class="s3">, </span><span class="s1">maybeExpandDesignLocation</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">)</span>
                    <span class="s3">),</span>
                    <span class="s1">familyName</span><span class="s3">=</span><span class="s1">familyName</span><span class="s3">,</span>
                    <span class="s1">styleName</span><span class="s3">=</span><span class="s1">styleName</span><span class="s3">,</span>
                    <span class="s1">postScriptFontName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">postScriptFontName</span>
                    <span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">postScriptFontName</span><span class="s3">,</span>
                    <span class="s1">styleMapFamilyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleMapFamilyName</span>
                    <span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">styleMapFamilyNames</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;en&quot;</span><span class="s3">),</span>
                    <span class="s1">styleMapStyleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleMapStyleName</span>
                    <span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">styleMapStyleName</span><span class="s3">,</span>
                    <span class="s1">localisedFamilyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedFamilyName</span>
                    <span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">familyNames</span><span class="s3">,</span>
                    <span class="s1">localisedStyleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedStyleName</span>
                    <span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">styleNames</span><span class="s3">,</span>
                    <span class="s1">localisedStyleMapFamilyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedStyleMapFamilyName</span>
                    <span class="s2">or </span><span class="s1">statNames</span><span class="s3">.</span><span class="s1">styleMapFamilyNames</span><span class="s3">,</span>
                    <span class="s1">localisedStyleMapStyleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedStyleMapStyleName</span>
                    <span class="s2">or </span><span class="s3">{},</span>
                    <span class="s1">lib</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">lib</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">addInstance</span><span class="s3">(</span>
                <span class="s1">InstanceDescriptor</span><span class="s3">(</span>
                    <span class="s1">filename</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">,</span>
                    <span class="s1">path</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">path</span><span class="s3">,</span>
                    <span class="s1">font</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">font</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">name</span><span class="s3">,</span>
                    <span class="s1">userLocation</span><span class="s3">={} </span><span class="s2">if </span><span class="s1">expandLocations </span><span class="s2">else </span><span class="s1">instance</span><span class="s3">.</span><span class="s1">userLocation</span><span class="s3">,</span>
                    <span class="s1">designLocation</span><span class="s3">=</span><span class="s1">_filterLocation</span><span class="s3">(</span>
                        <span class="s1">userRegion</span><span class="s3">, </span><span class="s1">maybeExpandDesignLocation</span><span class="s3">(</span><span class="s1">instance</span><span class="s3">)</span>
                    <span class="s3">),</span>
                    <span class="s1">familyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">familyName</span><span class="s3">,</span>
                    <span class="s1">styleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleName</span><span class="s3">,</span>
                    <span class="s1">postScriptFontName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">postScriptFontName</span><span class="s3">,</span>
                    <span class="s1">styleMapFamilyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleMapFamilyName</span><span class="s3">,</span>
                    <span class="s1">styleMapStyleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">styleMapStyleName</span><span class="s3">,</span>
                    <span class="s1">localisedFamilyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedFamilyName</span><span class="s3">,</span>
                    <span class="s1">localisedStyleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedStyleName</span><span class="s3">,</span>
                    <span class="s1">localisedStyleMapFamilyName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedStyleMapFamilyName</span><span class="s3">,</span>
                    <span class="s1">localisedStyleMapStyleName</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">localisedStyleMapStyleName</span><span class="s3">,</span>
                    <span class="s1">lib</span><span class="s3">=</span><span class="s1">instance</span><span class="s3">.</span><span class="s1">lib</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

    <span class="s1">subDoc</span><span class="s3">.</span><span class="s1">lib </span><span class="s3">= </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">lib</span>

    <span class="s2">return </span><span class="s1">subDoc</span>


<span class="s2">def </span><span class="s1">_conditionSetFrom</span><span class="s3">(</span><span class="s1">conditionSet</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]]) </span><span class="s1">-&gt; ConditionSet</span><span class="s3">:</span>
    <span class="s1">c</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Range</span><span class="s3">] = {}</span>
    <span class="s2">for </span><span class="s1">condition </span><span class="s2">in </span><span class="s1">conditionSet</span><span class="s3">:</span>
        <span class="s1">minimum</span><span class="s3">, </span><span class="s1">maximum </span><span class="s3">= </span><span class="s1">condition</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;minimum&quot;</span><span class="s3">), </span><span class="s1">condition</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;maximum&quot;</span><span class="s3">)</span>
        <span class="s1">c</span><span class="s3">[</span><span class="s1">condition</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]] = </span><span class="s1">Range</span><span class="s3">(</span>
            <span class="s1">minimum </span><span class="s2">if </span><span class="s1">minimum </span><span class="s2">is not None else </span><span class="s3">-</span><span class="s1">math</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
            <span class="s1">maximum </span><span class="s2">if </span><span class="s1">maximum </span><span class="s2">is not None else </span><span class="s1">math</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">c</span>


<span class="s2">def </span><span class="s1">_subsetRulesBasedOnConditions</span><span class="s3">(</span>
    <span class="s1">rules</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">RuleDescriptor</span><span class="s3">], </span><span class="s1">designRegion</span><span class="s3">: </span><span class="s1">Region</span>
<span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">RuleDescriptor</span><span class="s3">]:</span>
    <span class="s5"># What rules to keep:</span>
    <span class="s5">#  - Keep the rule if any conditionset is relevant.</span>
    <span class="s5">#  - A conditionset is relevant if all conditions are relevant or it is empty.</span>
    <span class="s5">#  - A condition is relevant if</span>
    <span class="s5">#    - axis is point (C-AP),</span>
    <span class="s5">#       - and point in condition's range (C-AP-in)</span>
    <span class="s5">#            (in this case remove the condition because it's always true)</span>
    <span class="s5">#       - else (C-AP-out) whole conditionset can be discarded (condition false</span>
    <span class="s5">#         =&gt; conditionset false)</span>
    <span class="s5">#    - axis is range (C-AR),</span>
    <span class="s5">#       - (C-AR-all) and axis range fully contained in condition range: we can</span>
    <span class="s5">#         scrap the condition because it's always true</span>
    <span class="s5">#       - (C-AR-inter) and intersection(axis range, condition range) not empty:</span>
    <span class="s5">#         keep the condition with the smaller range (= intersection)</span>
    <span class="s5">#       - (C-AR-none) else, whole conditionset can be discarded</span>
    <span class="s1">newRules</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">RuleDescriptor</span><span class="s3">] = []</span>
    <span class="s2">for </span><span class="s1">rule </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">:</span>
        <span class="s1">newRule</span><span class="s3">: </span><span class="s1">RuleDescriptor </span><span class="s3">= </span><span class="s1">RuleDescriptor</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">rule</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">conditionSets</span><span class="s3">=[], </span><span class="s1">subs</span><span class="s3">=</span><span class="s1">rule</span><span class="s3">.</span><span class="s1">subs</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">conditionset </span><span class="s2">in </span><span class="s1">rule</span><span class="s3">.</span><span class="s1">conditionSets</span><span class="s3">:</span>
            <span class="s1">cs </span><span class="s3">= </span><span class="s1">_conditionSetFrom</span><span class="s3">(</span><span class="s1">conditionset</span><span class="s3">)</span>
            <span class="s1">newConditionset</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]] = []</span>
            <span class="s1">discardConditionset </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">for </span><span class="s1">selectionName</span><span class="s3">, </span><span class="s1">selectionValue </span><span class="s2">in </span><span class="s1">designRegion</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s5"># TODO: Ensure that all(key in conditionset for key in region.keys())?</span>
                <span class="s2">if </span><span class="s1">selectionName </span><span class="s2">not in </span><span class="s1">cs</span><span class="s3">:</span>
                    <span class="s5"># raise Exception(&quot;Selection has different axes than the rules&quot;)</span>
                    <span class="s2">continue</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">selectionValue</span><span class="s3">, (</span><span class="s1">float</span><span class="s3">, </span><span class="s1">int</span><span class="s3">)):  </span><span class="s5"># is point</span>
                    <span class="s5"># Case C-AP-in</span>
                    <span class="s2">if </span><span class="s1">selectionValue </span><span class="s2">in </span><span class="s1">cs</span><span class="s3">[</span><span class="s1">selectionName</span><span class="s3">]:</span>
                        <span class="s2">pass  </span><span class="s5"># always matches, conditionset can stay empty for this one.</span>
                    <span class="s5"># Case C-AP-out</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">discardConditionset </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s2">else</span><span class="s3">:  </span><span class="s5"># is range</span>
                    <span class="s5"># Case C-AR-all</span>
                    <span class="s2">if </span><span class="s1">selectionValue </span><span class="s2">in </span><span class="s1">cs</span><span class="s3">[</span><span class="s1">selectionName</span><span class="s3">]:</span>
                        <span class="s2">pass  </span><span class="s5"># always matches, conditionset can stay empty for this one.</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">intersection </span><span class="s3">= </span><span class="s1">cs</span><span class="s3">[</span><span class="s1">selectionName</span><span class="s3">].</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">selectionValue</span><span class="s3">)</span>
                        <span class="s5"># Case C-AR-inter</span>
                        <span class="s2">if </span><span class="s1">intersection </span><span class="s2">is not None</span><span class="s3">:</span>
                            <span class="s1">newConditionset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                                <span class="s3">{</span>
                                    <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">selectionName</span><span class="s3">,</span>
                                    <span class="s4">&quot;minimum&quot;</span><span class="s3">: </span><span class="s1">intersection</span><span class="s3">.</span><span class="s1">minimum</span><span class="s3">,</span>
                                    <span class="s4">&quot;maximum&quot;</span><span class="s3">: </span><span class="s1">intersection</span><span class="s3">.</span><span class="s1">maximum</span><span class="s3">,</span>
                                <span class="s3">}</span>
                            <span class="s3">)</span>
                        <span class="s5"># Case C-AR-none</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s1">discardConditionset </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">if not </span><span class="s1">discardConditionset</span><span class="s3">:</span>
                <span class="s1">newRule</span><span class="s3">.</span><span class="s1">conditionSets</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">newConditionset</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">newRule</span><span class="s3">.</span><span class="s1">conditionSets</span><span class="s3">:</span>
            <span class="s1">newRules</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">newRule</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">newRules</span>


<span class="s2">def </span><span class="s1">_filterLocation</span><span class="s3">(</span>
    <span class="s1">userRegion</span><span class="s3">: </span><span class="s1">Region</span><span class="s3">,</span>
    <span class="s1">location</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">float</span><span class="s3">],</span>
<span class="s3">) </span><span class="s1">-&gt; Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]:</span>
    <span class="s2">return </span><span class="s3">{</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">value</span>
        <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">location</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">userRegion </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">userRegion</span><span class="s3">[</span><span class="s1">name</span><span class="s3">], </span><span class="s1">Range</span><span class="s3">)</span>
    <span class="s3">}</span>
</pre>
</body>
</html>