<html>
<head>
<title>test_hierarchy.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_hierarchy.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># Author: Damian Eads</span>
<span class="s0"># Date: April 17, 2008</span>
<span class="s0">#</span>
<span class="s0"># Copyright (C) 2008 Damian Eads</span>
<span class="s0">#</span>
<span class="s0"># Redistribution and use in source and binary forms, with or without</span>
<span class="s0"># modification, are permitted provided that the following conditions</span>
<span class="s0"># are met:</span>
<span class="s0">#</span>
<span class="s0"># 1. Redistributions of source code must retain the above copyright</span>
<span class="s0">#    notice, this list of conditions and the following disclaimer.</span>
<span class="s0">#</span>
<span class="s0"># 2. Redistributions in binary form must reproduce the above</span>
<span class="s0">#    copyright notice, this list of conditions and the following</span>
<span class="s0">#    disclaimer in the documentation and/or other materials provided</span>
<span class="s0">#    with the distribution.</span>
<span class="s0">#</span>
<span class="s0"># 3. The name of the author may not be used to endorse or promote</span>
<span class="s0">#    products derived from this software without specific prior</span>
<span class="s0">#    written permission.</span>
<span class="s0">#</span>
<span class="s0"># THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS</span>
<span class="s0"># OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="s0"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="s0"># ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="s0"># DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="s0"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE</span>
<span class="s0"># GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="s0"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
<span class="s0"># WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="s0"># NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="s0"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_</span><span class="s3">, </span><span class="s1">assert_warns</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>

<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">hierarchy</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">hierarchy </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ClusterWarning</span><span class="s3">, </span><span class="s1">linkage</span><span class="s3">, </span><span class="s1">from_mlab_linkage</span><span class="s3">, </span><span class="s1">to_mlab_linkage</span><span class="s3">,</span>
    <span class="s1">num_obs_linkage</span><span class="s3">, </span><span class="s1">inconsistent</span><span class="s3">, </span><span class="s1">cophenet</span><span class="s3">, </span><span class="s1">fclusterdata</span><span class="s3">, </span><span class="s1">fcluster</span><span class="s3">,</span>
    <span class="s1">is_isomorphic</span><span class="s3">, </span><span class="s1">single</span><span class="s3">, </span><span class="s1">leaders</span><span class="s3">,</span>
    <span class="s1">correspond</span><span class="s3">, </span><span class="s1">is_monotonic</span><span class="s3">, </span><span class="s1">maxdists</span><span class="s3">, </span><span class="s1">maxinconsts</span><span class="s3">, </span><span class="s1">maxRstat</span><span class="s3">,</span>
    <span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">to_tree</span><span class="s3">, </span><span class="s1">leaves_list</span><span class="s3">, </span><span class="s1">dendrogram</span><span class="s3">,</span>
    <span class="s1">set_link_color_palette</span><span class="s3">, </span><span class="s1">cut_tree</span><span class="s3">, </span><span class="s1">optimal_leaf_ordering</span><span class="s3">,</span>
    <span class="s1">_order_cluster_tree</span><span class="s3">, </span><span class="s1">_hierarchy</span><span class="s3">, </span><span class="s1">_LINKAGE_METHODS</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">spatial</span><span class="s3">.</span><span class="s1">distance </span><span class="s2">import </span><span class="s1">pdist</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">_hierarchy </span><span class="s2">import </span><span class="s1">Heap</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">conftest </span><span class="s2">import </span><span class="s1">array_api_compatible</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_array_api </span><span class="s2">import </span><span class="s1">xp_assert_close</span><span class="s3">, </span><span class="s1">xp_assert_equal</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">hierarchy_test_data</span>


<span class="s0"># Matplotlib is not a scipy dependency but is optionally used in dendrogram, so</span>
<span class="s0"># check if it's available</span>
<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">matplotlib</span>
    <span class="s0"># and set the backend to be Agg (no gui)</span>
    <span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">use</span><span class="s3">(</span><span class="s4">'Agg'</span><span class="s3">)</span>
    <span class="s0"># before importing pyplot</span>
    <span class="s2">import </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">pyplot </span><span class="s2">as </span><span class="s1">plt</span>
    <span class="s1">have_matplotlib </span><span class="s3">= </span><span class="s2">True</span>
<span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
    <span class="s1">have_matplotlib </span><span class="s3">= </span><span class="s2">False</span>


<span class="s1">pytestmark </span><span class="s3">= [</span><span class="s1">array_api_compatible</span><span class="s3">, </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;skip_xp_backends&quot;</span><span class="s3">)]</span>
<span class="s1">skip_xp_backends </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skip_xp_backends</span>


<span class="s2">class </span><span class="s1">TestLinkage</span><span class="s3">:</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_linkage_non_finite_elements_in_distance_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests linkage(Y) where Y contains a non-finite element (e.g. NaN or Inf).</span>
        <span class="s0"># Exception expected.</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">] + [</span><span class="s5">0.0</span><span class="s3">]*</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">linkage</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_linkage_empty_distance_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests linkage(Y) where Y is a 0x4 linkage matrix. Exception expected.</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">,))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">linkage</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_linkage_tdist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'single'</span><span class="s3">, </span><span class="s4">'complete'</span><span class="s3">, </span><span class="s4">'average'</span><span class="s3">, </span><span class="s4">'weighted'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_linkage_tdist</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_linkage_tdist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests linkage(Y, method) on the tdist data set.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">expectedZ </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">, </span><span class="s4">'linkage_ytdist_' </span><span class="s3">+ </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_linkage_X</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'centroid'</span><span class="s3">, </span><span class="s4">'median'</span><span class="s3">, </span><span class="s4">'ward'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_linkage_q</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_linkage_q</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests linkage(Y, method) on the Q data set.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">X</span><span class="s3">), </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">expectedZ </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">, </span><span class="s4">'linkage_X_' </span><span class="s3">+ </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-06</span><span class="s3">)</span>

        <span class="s1">y </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">spatial</span><span class="s3">.</span><span class="s1">distance</span><span class="s3">.</span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">X</span><span class="s3">,</span>
                                         <span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;euclidean&quot;</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-06</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_compare_with_trivial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">20</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">method</span><span class="s3">, </span><span class="s1">code </span><span class="s2">in </span><span class="s1">_LINKAGE_METHODS</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">Z_trivial </span><span class="s3">= </span><span class="s1">_hierarchy</span><span class="s3">.</span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">code</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">d</span><span class="s3">), </span><span class="s1">method</span><span class="s3">)</span>
            <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">Z_trivial</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_optimal_leaf_ordering</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s1">optimal_ordering</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">expectedZ </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">, </span><span class="s4">'linkage_ytdist_single_olo'</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestLinkageTies</span><span class="s3">:</span>

    <span class="s1">_expectations </span><span class="s3">= {</span>
        <span class="s4">'single'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s4">'complete'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                              <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.82842712</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s4">'average'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.12132034</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s4">'weighted'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                              <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.12132034</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s4">'centroid'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                              <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.12132034</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s4">'median'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.12132034</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
        <span class="s4">'ward'</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.41421356</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                          <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2.44948974</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]),</span>
    <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">test_linkage_ties</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'single'</span><span class="s3">, </span><span class="s4">'complete'</span><span class="s3">, </span><span class="s4">'average'</span><span class="s3">, </span><span class="s4">'weighted'</span><span class="s3">,</span>
                       <span class="s4">'centroid'</span><span class="s3">, </span><span class="s4">'median'</span><span class="s3">, </span><span class="s4">'ward'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_linkage_ties</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_linkage_ties</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]])</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">expectedZ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_expectations</span><span class="s3">[</span><span class="s1">method</span><span class="s3">]</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-06</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestInconsistent</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_inconsistent_tdist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">depth </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">inconsistent_ytdist</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_inconsistent_tdist</span><span class="s3">(</span><span class="s1">depth</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_inconsistent_tdist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">depth</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">linkage_ytdist_single</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">depth</span><span class="s3">),</span>
                        <span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">inconsistent_ytdist</span><span class="s3">[</span><span class="s1">depth</span><span class="s3">]))</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestCopheneticDistance</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_linkage_cophenet_tdist_Z</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests cophenet(Z) on tdist data set.</span>
        <span class="s1">expectedM </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">268</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">255</span><span class="s3">, </span><span class="s5">255</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">268</span><span class="s3">, </span><span class="s5">268</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">295</span><span class="s3">,</span>
                                <span class="s5">295</span><span class="s3">, </span><span class="s5">138</span><span class="s3">, </span><span class="s5">219</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">295</span><span class="s3">])</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">linkage_ytdist_single</span><span class="s3">)</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">cophenet</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">M</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedM</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_linkage_cophenet_tdist_Z_Y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests cophenet(Z, Y) on tdist data set.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">linkage_ytdist_single</span><span class="s3">)</span>
        <span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s1">M</span><span class="s3">) = </span><span class="s1">cophenet</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">))</span>
        <span class="s1">expectedM </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">268</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">255</span><span class="s3">, </span><span class="s5">255</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">268</span><span class="s3">, </span><span class="s5">268</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">295</span><span class="s3">,</span>
                                <span class="s5">295</span><span class="s3">, </span><span class="s5">138</span><span class="s3">, </span><span class="s5">219</span><span class="s3">, </span><span class="s5">295</span><span class="s3">, </span><span class="s5">295</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">expectedc </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s5">0.639931296433393415057366837573</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)[()]</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s1">expectedc</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">M</span><span class="s3">, </span><span class="s1">expectedM</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMLabLinkageConversion</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_mlab_linkage_conversion_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests from/to_mlab_linkage on empty linkage array.</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">from_mlab_linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">xp_assert_equal</span><span class="s3">(</span><span class="s1">to_mlab_linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_mlab_linkage_conversion_single_row</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests from/to_mlab_linkage on linkage array with single row.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">, </span><span class="s5">3.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">]])</span>
        <span class="s1">Zm </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]])</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">from_mlab_linkage</span><span class="s3">(</span><span class="s1">Zm</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">to_mlab_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">Zm</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_mlab_linkage_conversion_multiple_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests from/to_mlab_linkage on linkage array with multiple rows.</span>
        <span class="s1">Zm </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">138</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">219</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">255</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">268</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">295</span><span class="s3">]])</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">2.</span><span class="s3">, </span><span class="s5">5.</span><span class="s3">, </span><span class="s5">138.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3.</span><span class="s3">, </span><span class="s5">4.</span><span class="s3">, </span><span class="s5">219.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">7.</span><span class="s3">, </span><span class="s5">255.</span><span class="s3">, </span><span class="s5">3.</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">8.</span><span class="s3">, </span><span class="s5">268.</span><span class="s3">, </span><span class="s5">4.</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">6.</span><span class="s3">, </span><span class="s5">9.</span><span class="s3">, </span><span class="s5">295.</span><span class="s3">, </span><span class="s5">6.</span><span class="s3">]],</span>
                       <span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">from_mlab_linkage</span><span class="s3">(</span><span class="s1">Zm</span><span class="s3">), </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">to_mlab_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">Zm</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestFcluster</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_fclusterdata</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_inconsistent</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fclusterdata</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s4">'inconsistent'</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_distance</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fclusterdata</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s4">'distance'</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_maxclust</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fclusterdata</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s4">'maxclust'</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_fclusterdata</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests fclusterdata(X, criterion=criterion, t=t) on a random 3-cluster data set</span>
        <span class="s1">expectedT </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">, </span><span class="s4">'fcluster_' </span><span class="s3">+ </span><span class="s1">criterion</span><span class="s3">)[</span><span class="s1">t</span><span class="s3">])</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">T </span><span class="s3">= </span><span class="s1">fclusterdata</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">=</span><span class="s1">criterion</span><span class="s3">, </span><span class="s1">t</span><span class="s3">=</span><span class="s1">t</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">expectedT</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_fcluster</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_inconsistent</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fcluster</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s4">'inconsistent'</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_distance</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fcluster</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s4">'distance'</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_maxclust</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fcluster</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s4">'maxclust'</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_fcluster</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests fcluster(Z, criterion=criterion, t=t) on a random 3-cluster data set.</span>
        <span class="s1">expectedT </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">, </span><span class="s4">'fcluster_' </span><span class="s3">+ </span><span class="s1">criterion</span><span class="s3">)[</span><span class="s1">t</span><span class="s3">])</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">single</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">))</span>
        <span class="s1">T </span><span class="s3">= </span><span class="s1">fcluster</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">=</span><span class="s1">criterion</span><span class="s3">, </span><span class="s1">t</span><span class="s3">=</span><span class="s1">t</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">expectedT</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_fcluster_monocrit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_distance</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fcluster_monocrit</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_maxclust</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_fcluster_maxclust_monocrit</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_fcluster_monocrit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">expectedT </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_distance</span><span class="s3">[</span><span class="s1">t</span><span class="s3">])</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">single</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">))</span>
        <span class="s1">T </span><span class="s3">= </span><span class="s1">fcluster</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">=</span><span class="s4">'monocrit'</span><span class="s3">, </span><span class="s1">monocrit</span><span class="s3">=</span><span class="s1">maxdists</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">expectedT</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">check_fcluster_maxclust_monocrit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">expectedT </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">fcluster_maxclust</span><span class="s3">[</span><span class="s1">t</span><span class="s3">])</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">single</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">))</span>
        <span class="s1">T </span><span class="s3">= </span><span class="s1">fcluster</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">=</span><span class="s4">'maxclust_monocrit'</span><span class="s3">, </span><span class="s1">monocrit</span><span class="s3">=</span><span class="s1">maxdists</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">expectedT</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestLeaders</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_leaders_single</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests leaders using a flat clustering generated by single linkage.</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
        <span class="s1">T </span><span class="s3">= </span><span class="s1">fcluster</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">criterion</span><span class="s3">=</span><span class="s4">'maxclust'</span><span class="s3">, </span><span class="s1">t</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">Lright </span><span class="s3">= (</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">53</span><span class="s3">, </span><span class="s5">55</span><span class="s3">, </span><span class="s5">56</span><span class="s3">]), </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]))</span>
        <span class="s1">T </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
        <span class="s1">L </span><span class="s3">= </span><span class="s1">leaders</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">(</span><span class="s1">L</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">(</span><span class="s1">Lright</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">np_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                   <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'`is_isomorphic` only supports NumPy backend'</span><span class="s3">])</span>
<span class="s2">class </span><span class="s1">TestIsIsomorphic</span><span class="s3">:</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">np_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                       <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'array-likes only supported for NumPy backend'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_array_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">([], [])</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #1 (one flat cluster, different labellings)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #2 (two flat clusters, different labelings)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #3 (no flat clusters)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_4A</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #4A</span>
        <span class="s0"># (3 flat clusters, different labelings, isomorphic)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_4B</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #4B</span>
        <span class="s0"># (3 flat clusters, different labelings, nonisomorphic)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">) </span><span class="s2">is False</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">) </span><span class="s2">is False</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_4C</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #4C</span>
        <span class="s0"># (3 flat clusters, different labelings, isomorphic)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">7</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">6</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_5</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #5 (1000 observations, 2/3/5 random</span>
        <span class="s0"># clusters, random permutation of the labeling).</span>
        <span class="s2">for </span><span class="s1">nc </span><span class="s2">in </span><span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">help_is_isomorphic_randperm</span><span class="s3">(</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">nc</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_6</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_isomorphic on test case #5A (1000 observations, 2/3/5 random</span>
        <span class="s0"># clusters, random permutation of the labeling, slightly</span>
        <span class="s0"># nonisomorphic.)</span>
        <span class="s2">for </span><span class="s1">nc </span><span class="s2">in </span><span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">help_is_isomorphic_randperm</span><span class="s3">(</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">nc</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_isomorphic_7</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-6271</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s2">assert not </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">help_is_isomorphic_randperm</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">nclusters</span><span class="s3">, </span><span class="s1">noniso</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">nerrors</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
                                    <span class="s3">*, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">a </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">nobs</span><span class="s3">) * </span><span class="s1">nclusters</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)</span>
            <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">)</span>
            <span class="s1">P </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">permutation</span><span class="s3">(</span><span class="s1">nclusters</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]):</span>
                <span class="s1">b</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">P</span><span class="s3">[</span><span class="s1">a</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]]</span>
            <span class="s2">if </span><span class="s1">noniso</span><span class="s3">:</span>
                <span class="s1">Q </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">permutation</span><span class="s3">(</span><span class="s1">nobs</span><span class="s3">)</span>
                <span class="s1">b</span><span class="s3">[</span><span class="s1">Q</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s1">nerrors</span><span class="s3">]] += </span><span class="s5">1</span>
                <span class="s1">b</span><span class="s3">[</span><span class="s1">Q</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s1">nerrors</span><span class="s3">]] %= </span><span class="s1">nclusters</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
            <span class="s1">b </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">) == (</span><span class="s2">not </span><span class="s1">noniso</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">is_isomorphic</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span><span class="s3">) == (</span><span class="s2">not </span><span class="s1">noniso</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestIsValidLinkage</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_is_valid_linkage_various_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">nrow</span><span class="s3">, </span><span class="s1">ncol</span><span class="s3">, </span><span class="s1">valid </span><span class="s2">in </span><span class="s3">[(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s2">False</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s2">False</span><span class="s3">),</span>
                                  <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s2">True</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_is_valid_linkage_various_size</span><span class="s3">(</span><span class="s1">nrow</span><span class="s3">, </span><span class="s1">ncol</span><span class="s3">, </span><span class="s1">valid</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_is_valid_linkage_various_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nrow</span><span class="s3">, </span><span class="s1">ncol</span><span class="s3">, </span><span class="s1">valid</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) with linkage matrices of various sizes</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">[:</span><span class="s1">nrow</span><span class="s3">, :</span><span class="s1">ncol</span><span class="s3">]</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) == </span><span class="s1">valid</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">valid</span><span class="s3">:</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_linkage_int_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) with integer type.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_linkage_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) with empty linkage.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_linkage_4_and_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) on linkage on observation sets between</span>
        <span class="s0"># sizes 4 and 15 (step size 3).</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_linkage_4_and_up_neg_index_left</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) on linkage on observation sets between</span>
        <span class="s0"># sizes 4 and 15 (step size 3) with negative indices (left).</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">0</span><span class="s3">] = -</span><span class="s5">2</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_linkage_4_and_up_neg_index_right</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) on linkage on observation sets between</span>
        <span class="s0"># sizes 4 and 15 (step size 3) with negative indices (right).</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">1</span><span class="s3">] = -</span><span class="s5">2</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_linkage_4_and_up_neg_dist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) on linkage on observation sets between</span>
        <span class="s0"># sizes 4 and 15 (step size 3) with negative distances.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">] = -</span><span class="s5">0.5</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_linkage_4_and_up_neg_counts</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_linkage(Z) on linkage on observation sets between</span>
        <span class="s0"># sizes 4 and 15 (step size 3) with negative counts.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">] = -</span><span class="s5">2</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestIsValidInconsistent</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_is_valid_im_int_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) with integer type.</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_im_various_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">nrow</span><span class="s3">, </span><span class="s1">ncol</span><span class="s3">, </span><span class="s1">valid </span><span class="s2">in </span><span class="s3">[(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s2">False</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s2">False</span><span class="s3">),</span>
                                  <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s2">True</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_is_valid_im_various_size</span><span class="s3">(</span><span class="s1">nrow</span><span class="s3">, </span><span class="s1">ncol</span><span class="s3">, </span><span class="s1">valid</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_is_valid_im_various_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nrow</span><span class="s3">, </span><span class="s1">ncol</span><span class="s3">, </span><span class="s1">valid</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) with linkage matrices of various sizes</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">R</span><span class="s3">[:</span><span class="s1">nrow</span><span class="s3">, :</span><span class="s1">ncol</span><span class="s3">]</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) == </span><span class="s1">valid</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">valid</span><span class="s3">:</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_im_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) with empty inconsistency matrix.</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_im_4_and_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) on im on observation sets between sizes 4 and 15</span>
        <span class="s0"># (step size 3).</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">R </span><span class="s3">= </span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) </span><span class="s2">is True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_im_4_and_up_neg_index_left</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) on im on observation sets between sizes 4 and 15</span>
        <span class="s0"># (step size 3) with negative link height means.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">R </span><span class="s3">= </span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
            <span class="s1">R</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">0</span><span class="s3">] = -</span><span class="s5">2.0</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_im_4_and_up_neg_index_right</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) on im on observation sets between sizes 4 and 15</span>
        <span class="s0"># (step size 3) with negative link height standard deviations.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">R </span><span class="s3">= </span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
            <span class="s1">R</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">1</span><span class="s3">] = -</span><span class="s5">2.0</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_valid_im_4_and_up_neg_dist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_valid_im(R) on im on observation sets between sizes 4 and 15</span>
        <span class="s0"># (step size 3) with negative link counts.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">R </span><span class="s3">= </span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
            <span class="s1">R</span><span class="s3">[</span><span class="s1">i</span><span class="s3">//</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">] = -</span><span class="s5">0.5</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">is_valid_im</span><span class="s3">(</span><span class="s1">R</span><span class="s3">) </span><span class="s2">is False</span><span class="s3">)</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_valid_im</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestNumObsLinkage</span><span class="s3">:</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_num_obs_linkage_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_linkage(Z) with empty linkage.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">num_obs_linkage</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_linkage_1x4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_linkage(Z) on linkage over 2 observations.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">num_obs_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_linkage_2x4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_linkage(Z) on linkage over 3 observations.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">num_obs_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_num_obs_linkage_4_and_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_linkage(Z) on linkage on observation sets between sizes</span>
        <span class="s0"># 4 and 15 (step size 3).</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">num_obs_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s1">i</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestLeavesList</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_leaves_list_1x4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests leaves_list(Z) on a 1x4 linkage.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">to_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">leaves_list</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_leaves_list_2x4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests leaves_list(Z) on a 2x4 linkage.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">to_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">leaves_list</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_leaves_list_Q</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'single'</span><span class="s3">, </span><span class="s4">'complete'</span><span class="s3">, </span><span class="s4">'average'</span><span class="s3">, </span><span class="s4">'weighted'</span><span class="s3">, </span><span class="s4">'centroid'</span><span class="s3">,</span>
                       <span class="s4">'median'</span><span class="s3">, </span><span class="s4">'ward'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_leaves_list_Q</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_leaves_list_Q</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests leaves_list(Z) on the Q data set</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">node </span><span class="s3">= </span><span class="s1">to_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">node</span><span class="s3">.</span><span class="s1">pre_order</span><span class="s3">(), </span><span class="s1">leaves_list</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_Q_subtree_pre_order</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests that pre_order() works when called on sub-trees.</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s1">node </span><span class="s3">= </span><span class="s1">to_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">node</span><span class="s3">.</span><span class="s1">pre_order</span><span class="s3">(), (</span><span class="s1">node</span><span class="s3">.</span><span class="s1">get_left</span><span class="s3">().</span><span class="s1">pre_order</span><span class="s3">()</span>
                                           <span class="s3">+ </span><span class="s1">node</span><span class="s3">.</span><span class="s1">get_right</span><span class="s3">().</span><span class="s1">pre_order</span><span class="s3">()),</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestCorrespond</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_correspond_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests correspond(Z, y) with empty linkage and condensed distance matrix.</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">correspond</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_correspond_2_and_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests correspond(Z, y) on linkage and CDMs over observation sets of</span>
        <span class="s0"># different sizes.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">correspond</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">15</span><span class="s3">, </span><span class="s5">3</span><span class="s3">):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">correspond</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_correspond_4_and_up</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests correspond(Z, y) on linkage and CDMs over observation sets of</span>
        <span class="s0"># different sizes. Correspondence should be false.</span>
        <span class="s2">for </span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">) </span><span class="s2">in </span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)), </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)))) +</span>
                       <span class="s1">list</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)), </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">))))):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">j</span><span class="s3">*(</span><span class="s1">j</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">y2 </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z2 </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s2">assert not </span><span class="s1">correspond</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s2">assert not </span><span class="s1">correspond</span><span class="s3">(</span><span class="s1">Z2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_correspond_4_and_up_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests correspond(Z, y) on linkage and CDMs over observation sets of</span>
        <span class="s0"># different sizes. Correspondence should be false.</span>
        <span class="s2">for </span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">) </span><span class="s2">in </span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">7</span><span class="s3">)), </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s5">21</span><span class="s3">)))) +</span>
                       <span class="s1">list</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">7</span><span class="s3">)), </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s5">21</span><span class="s3">))))):</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">i</span><span class="s3">*(</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">j</span><span class="s3">*(</span><span class="s1">j</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">y2 </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">Z2 </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s2">assert not </span><span class="s1">correspond</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s2">assert not </span><span class="s1">correspond</span><span class="s3">(</span><span class="s1">Z2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_linkage_multi_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_linkage with observation matrices of multiple sizes.</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">10</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
            <span class="s1">Y </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">Y </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
            <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">num_obs_linkage</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestIsMonotonic</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on an empty linkage.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">is_monotonic</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_1x4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 1x4 linkage. Expecting True.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_2x4_T</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 2x4 linkage. Expecting True.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_2x4_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 2x4 linkage. Expecting False.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_3x4_T</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 3x4 linkage. Expecting True.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_3x4_F1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 3x4 linkage (case 1). Expecting False.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_3x4_F2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 3x4 linkage (case 2). Expecting False.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.8</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_3x4_F3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on 3x4 linkage (case 3). Expecting False</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_tdist_linkage1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on clustering generated by single linkage on</span>
        <span class="s0"># tdist data set. Expecting True.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_is_monotonic_tdist_linkage2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on clustering generated by single linkage on</span>
        <span class="s0"># tdist data set. Perturbing. Expecting False.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s1">Z</span><span class="s3">[</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">] = </span><span class="s5">0.0</span>
        <span class="s2">assert not </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_monotonic_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests is_monotonic(Z) on clustering generated by single linkage on</span>
        <span class="s0"># Q data set. Expecting True.</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">is_monotonic</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestMaxDists</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_maxdists_empty_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxdists(Z) on empty linkage. Expecting exception.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">maxdists</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxdists_one_cluster_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxdists(Z) on linkage with one cluster.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">MD </span><span class="s3">= </span><span class="s1">maxdists</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">expectedMD </span><span class="s3">= </span><span class="s1">calculate_maximum_distances</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">MD</span><span class="s3">, </span><span class="s1">expectedMD</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxdists_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'single'</span><span class="s3">, </span><span class="s4">'complete'</span><span class="s3">, </span><span class="s4">'ward'</span><span class="s3">, </span><span class="s4">'centroid'</span><span class="s3">, </span><span class="s4">'median'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxdists_Q_linkage</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxdists_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxdists(Z) on the Q data set</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">MD </span><span class="s3">= </span><span class="s1">maxdists</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">expectedMD </span><span class="s3">= </span><span class="s1">calculate_maximum_distances</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">MD</span><span class="s3">, </span><span class="s1">expectedMD</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMaxInconsts</span><span class="s3">:</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxinconsts_empty_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxinconsts(Z, R) on empty linkage. Expecting exception.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">maxinconsts</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_maxinconsts_difrow_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxinconsts(Z, R) on linkage and inconsistency matrices with</span>
        <span class="s0"># different numbers of clusters. Expecting exception.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">R</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">maxinconsts</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxinconsts_one_cluster_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxinconsts(Z, R) on linkage with one cluster.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">MD </span><span class="s3">= </span><span class="s1">maxinconsts</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">)</span>
        <span class="s1">expectedMD </span><span class="s3">= </span><span class="s1">calculate_maximum_inconsistencies</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">MD</span><span class="s3">, </span><span class="s1">expectedMD</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxinconsts_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'single'</span><span class="s3">, </span><span class="s4">'complete'</span><span class="s3">, </span><span class="s4">'ward'</span><span class="s3">, </span><span class="s4">'centroid'</span><span class="s3">, </span><span class="s4">'median'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxinconsts_Q_linkage</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxinconsts_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxinconsts(Z, R) on the Q data set</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">MD </span><span class="s3">= </span><span class="s1">maxinconsts</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">)</span>
        <span class="s1">expectedMD </span><span class="s3">= </span><span class="s1">calculate_maximum_inconsistencies</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">MD</span><span class="s3">, </span><span class="s1">expectedMD</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMaxRStat</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_maxRstat_invalid_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s3">[</span><span class="s5">3.3</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxRstat_invalid_index</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxRstat_invalid_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxRstat(Z, R, i). Expecting exception.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">maxRstat</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">maxRstat</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxRstat_empty_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxRstat_empty_linkage</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxRstat_empty_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxRstat(Z, R, i) on empty linkage. Expecting exception.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">maxRstat</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_maxRstat_difrow_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxRstat_difrow_linkage</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxRstat_difrow_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxRstat(Z, R, i) on linkage and inconsistency matrices with</span>
        <span class="s0"># different numbers of clusters. Expecting exception.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">R</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">maxRstat</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxRstat_one_cluster_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxRstat_one_cluster_linkage</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxRstat_one_cluster_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxRstat(Z, R, i) on linkage with one cluster.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">MD </span><span class="s3">= </span><span class="s1">maxRstat</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">expectedMD </span><span class="s3">= </span><span class="s1">calculate_maximum_inconsistencies</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">MD</span><span class="s3">, </span><span class="s1">expectedMD</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s4">'jax.numpy'</span><span class="s3">,</span>
                      <span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'jax arrays do not support item assignment'</span><span class="s3">],</span>
                      <span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_maxRstat_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'single'</span><span class="s3">, </span><span class="s4">'complete'</span><span class="s3">, </span><span class="s4">'ward'</span><span class="s3">, </span><span class="s4">'centroid'</span><span class="s3">, </span><span class="s4">'median'</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">check_maxRstat_Q_linkage</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_maxRstat_Q_linkage</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests maxRstat(Z, R, i) on the Q data set</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">Q_X</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">inconsistent</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
        <span class="s1">MD </span><span class="s3">= </span><span class="s1">maxRstat</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">expectedMD </span><span class="s3">= </span><span class="s1">calculate_maximum_inconsistencies</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>
        <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">MD</span><span class="s3">, </span><span class="s1">expectedMD</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestDendrogram</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_dendrogram_single_linkage_tdist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests dendrogram calculation on single linkage of the tdist data set.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">no_plot</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">leaves </span><span class="s3">= </span><span class="s1">R</span><span class="s3">[</span><span class="s4">&quot;leaves&quot;</span><span class="s3">]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">leaves</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_valid_orientation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dendrogram</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">=</span><span class="s4">&quot;foo&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_labels_as_array_or_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># test for gh-12418</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s1">labels </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]</span>
        <span class="s1">result1 </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">labels</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">labels</span><span class="s3">), </span><span class="s1">no_plot</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">result2 </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">labels</span><span class="s3">=</span><span class="s1">labels</span><span class="s3">, </span><span class="s1">no_plot</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result1 </span><span class="s3">== </span><span class="s1">result2</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">have_matplotlib</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no matplotlib&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_valid_label_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">link </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span>
            <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">6</span><span class="s3">],</span>
        <span class="s3">])</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">exc_info</span><span class="s3">:</span>
            <span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">link</span><span class="s3">, </span><span class="s1">labels</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)))</span>
        <span class="s2">assert </span><span class="s4">&quot;Dimensions of Z and labels must be consistent.&quot;</span><span class="s1">\</span>
               <span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">exc_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">ValueError</span><span class="s3">,</span>
                <span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Dimensions of Z and labels must be consistent.&quot;</span><span class="s3">):</span>
            <span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">link</span><span class="s3">, </span><span class="s1">labels</span><span class="s3">=[])</span>

        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">have_matplotlib</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no matplotlib&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_dendrogram_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">orientation </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'top'</span><span class="s3">, </span><span class="s4">'bottom'</span><span class="s3">, </span><span class="s4">'left'</span><span class="s3">, </span><span class="s4">'right'</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_dendrogram_plot</span><span class="s3">(</span><span class="s1">orientation</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_dendrogram_plot</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests dendrogram plotting.</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= {</span><span class="s4">'color_list'</span><span class="s3">: [</span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">],</span>
                    <span class="s4">'dcoord'</span><span class="s3">: [[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">138.0</span><span class="s3">, </span><span class="s5">138.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">219.0</span><span class="s3">, </span><span class="s5">219.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">255.0</span><span class="s3">, </span><span class="s5">255.0</span><span class="s3">, </span><span class="s5">219.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">268.0</span><span class="s3">, </span><span class="s5">268.0</span><span class="s3">, </span><span class="s5">255.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">138.0</span><span class="s3">, </span><span class="s5">295.0</span><span class="s3">, </span><span class="s5">295.0</span><span class="s3">, </span><span class="s5">268.0</span><span class="s3">]],</span>
                    <span class="s4">'icoord'</span><span class="s3">: [[</span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">15.0</span><span class="s3">, </span><span class="s5">15.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">45.0</span><span class="s3">, </span><span class="s5">45.0</span><span class="s3">, </span><span class="s5">55.0</span><span class="s3">, </span><span class="s5">55.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">35.0</span><span class="s3">, </span><span class="s5">35.0</span><span class="s3">, </span><span class="s5">50.0</span><span class="s3">, </span><span class="s5">50.0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">25.0</span><span class="s3">, </span><span class="s5">25.0</span><span class="s3">, </span><span class="s5">42.5</span><span class="s3">, </span><span class="s5">42.5</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">33.75</span><span class="s3">, </span><span class="s5">33.75</span><span class="s3">]],</span>
                    <span class="s4">'ivl'</span><span class="s3">: [</span><span class="s4">'2'</span><span class="s3">, </span><span class="s4">'5'</span><span class="s3">, </span><span class="s4">'1'</span><span class="s3">, </span><span class="s4">'0'</span><span class="s3">, </span><span class="s4">'3'</span><span class="s3">, </span><span class="s4">'4'</span><span class="s3">],</span>
                    <span class="s4">'leaves'</span><span class="s3">: [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
                    <span class="s4">'leaves_color_list'</span><span class="s3">: [</span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">],</span>
                    <span class="s3">}</span>

        <span class="s1">fig </span><span class="s3">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
        <span class="s1">ax </span><span class="s3">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">add_subplot</span><span class="s3">(</span><span class="s5">221</span><span class="s3">)</span>

        <span class="s0"># test that dendrogram accepts ax keyword</span>
        <span class="s1">R1 </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">ax</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">=</span><span class="s1">orientation</span><span class="s3">)</span>
        <span class="s1">R1</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">R1</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">R1</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s0"># test that dendrogram accepts and handle the leaf_font_size and</span>
        <span class="s0"># leaf_rotation keywords</span>
        <span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">ax</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">=</span><span class="s1">orientation</span><span class="s3">,</span>
                   <span class="s1">leaf_font_size</span><span class="s3">=</span><span class="s5">20</span><span class="s3">, </span><span class="s1">leaf_rotation</span><span class="s3">=</span><span class="s5">90</span><span class="s3">)</span>
        <span class="s1">testlabel </span><span class="s3">= (</span>
            <span class="s1">ax</span><span class="s3">.</span><span class="s1">get_xticklabels</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">orientation </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'top'</span><span class="s3">, </span><span class="s4">'bottom'</span><span class="s3">]</span>
            <span class="s2">else </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_yticklabels</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">testlabel</span><span class="s3">.</span><span class="s1">get_rotation</span><span class="s3">(), </span><span class="s5">90</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">testlabel</span><span class="s3">.</span><span class="s1">get_size</span><span class="s3">(), </span><span class="s5">20</span><span class="s3">)</span>
        <span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">ax</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">=</span><span class="s1">orientation</span><span class="s3">,</span>
                   <span class="s1">leaf_rotation</span><span class="s3">=</span><span class="s5">90</span><span class="s3">)</span>
        <span class="s1">testlabel </span><span class="s3">= (</span>
            <span class="s1">ax</span><span class="s3">.</span><span class="s1">get_xticklabels</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">orientation </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'top'</span><span class="s3">, </span><span class="s4">'bottom'</span><span class="s3">]</span>
            <span class="s2">else </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_yticklabels</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">testlabel</span><span class="s3">.</span><span class="s1">get_rotation</span><span class="s3">(), </span><span class="s5">90</span><span class="s3">)</span>
        <span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">ax</span><span class="s3">=</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">=</span><span class="s1">orientation</span><span class="s3">,</span>
                   <span class="s1">leaf_font_size</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)</span>
        <span class="s1">testlabel </span><span class="s3">= (</span>
            <span class="s1">ax</span><span class="s3">.</span><span class="s1">get_xticklabels</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">orientation </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'top'</span><span class="s3">, </span><span class="s4">'bottom'</span><span class="s3">]</span>
            <span class="s2">else </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">get_yticklabels</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">testlabel</span><span class="s3">.</span><span class="s1">get_size</span><span class="s3">(), </span><span class="s5">20</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s0"># test plotting to gca (will import pylab)</span>
        <span class="s1">R2 </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">orientation</span><span class="s3">=</span><span class="s1">orientation</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">R2</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">R2</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">R2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">have_matplotlib</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;no matplotlib&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_dendrogram_truncate_mode</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>

        <span class="s1">R </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s4">'lastp'</span><span class="s3">, </span><span class="s1">show_contracted</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">R</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">R</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">R</span><span class="s3">, {</span><span class="s4">'color_list'</span><span class="s3">: [</span><span class="s4">'C0'</span><span class="s3">],</span>
                         <span class="s4">'dcoord'</span><span class="s3">: [[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">295.0</span><span class="s3">, </span><span class="s5">295.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">]],</span>
                         <span class="s4">'icoord'</span><span class="s3">: [[</span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">15.0</span><span class="s3">, </span><span class="s5">15.0</span><span class="s3">]],</span>
                         <span class="s4">'ivl'</span><span class="s3">: [</span><span class="s4">'(2)'</span><span class="s3">, </span><span class="s4">'(4)'</span><span class="s3">],</span>
                         <span class="s4">'leaves'</span><span class="s3">: [</span><span class="s5">6</span><span class="s3">, </span><span class="s5">9</span><span class="s3">],</span>
                         <span class="s4">'leaves_color_list'</span><span class="s3">: [</span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">],</span>
                         <span class="s3">})</span>

        <span class="s1">R </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s4">'mtica'</span><span class="s3">, </span><span class="s1">show_contracted</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">R</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">R</span><span class="s3">[</span><span class="s4">'dcoord'</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">R</span><span class="s3">, {</span><span class="s4">'color_list'</span><span class="s3">: [</span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">],</span>
                         <span class="s4">'dcoord'</span><span class="s3">: [[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">138.0</span><span class="s3">, </span><span class="s5">138.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">],</span>
                                    <span class="s3">[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">255.0</span><span class="s3">, </span><span class="s5">255.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">],</span>
                                    <span class="s3">[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">268.0</span><span class="s3">, </span><span class="s5">268.0</span><span class="s3">, </span><span class="s5">255.0</span><span class="s3">],</span>
                                    <span class="s3">[</span><span class="s5">138.0</span><span class="s3">, </span><span class="s5">295.0</span><span class="s3">, </span><span class="s5">295.0</span><span class="s3">, </span><span class="s5">268.0</span><span class="s3">]],</span>
                         <span class="s4">'icoord'</span><span class="s3">: [[</span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">5.0</span><span class="s3">, </span><span class="s5">15.0</span><span class="s3">, </span><span class="s5">15.0</span><span class="s3">],</span>
                                    <span class="s3">[</span><span class="s5">35.0</span><span class="s3">, </span><span class="s5">35.0</span><span class="s3">, </span><span class="s5">45.0</span><span class="s3">, </span><span class="s5">45.0</span><span class="s3">],</span>
                                    <span class="s3">[</span><span class="s5">25.0</span><span class="s3">, </span><span class="s5">25.0</span><span class="s3">, </span><span class="s5">40.0</span><span class="s3">, </span><span class="s5">40.0</span><span class="s3">],</span>
                                    <span class="s3">[</span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">32.5</span><span class="s3">, </span><span class="s5">32.5</span><span class="s3">]],</span>
                         <span class="s4">'ivl'</span><span class="s3">: [</span><span class="s4">'2'</span><span class="s3">, </span><span class="s4">'5'</span><span class="s3">, </span><span class="s4">'1'</span><span class="s3">, </span><span class="s4">'0'</span><span class="s3">, </span><span class="s4">'(2)'</span><span class="s3">],</span>
                         <span class="s4">'leaves'</span><span class="s3">: [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">],</span>
                         <span class="s4">'leaves_color_list'</span><span class="s3">: [</span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">],</span>
                         <span class="s3">})</span>

    <span class="s2">def </span><span class="s1">test_dendrogram_colors</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># Tests dendrogram plots with alternate colors</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">), </span><span class="s4">'single'</span><span class="s3">)</span>

        <span class="s1">set_link_color_palette</span><span class="s3">([</span><span class="s4">'c'</span><span class="s3">, </span><span class="s4">'m'</span><span class="s3">, </span><span class="s4">'y'</span><span class="s3">, </span><span class="s4">'k'</span><span class="s3">])</span>
        <span class="s1">R </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">no_plot</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                       <span class="s1">above_threshold_color</span><span class="s3">=</span><span class="s4">'g'</span><span class="s3">, </span><span class="s1">color_threshold</span><span class="s3">=</span><span class="s5">250</span><span class="s3">)</span>
        <span class="s1">set_link_color_palette</span><span class="s3">([</span><span class="s4">'g'</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">, </span><span class="s4">'c'</span><span class="s3">, </span><span class="s4">'m'</span><span class="s3">, </span><span class="s4">'y'</span><span class="s3">, </span><span class="s4">'k'</span><span class="s3">])</span>

        <span class="s1">color_list </span><span class="s3">= </span><span class="s1">R</span><span class="s3">[</span><span class="s4">'color_list'</span><span class="s3">]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">color_list</span><span class="s3">, [</span><span class="s4">'c'</span><span class="s3">, </span><span class="s4">'m'</span><span class="s3">, </span><span class="s4">'g'</span><span class="s3">, </span><span class="s4">'g'</span><span class="s3">, </span><span class="s4">'g'</span><span class="s3">])</span>

        <span class="s0"># reset color palette (global list)</span>
        <span class="s1">set_link_color_palette</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dendrogram_leaf_colors_zero_dist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># tests that the colors of leafs are correct for tree</span>
        <span class="s0"># with two identical points</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>
        <span class="s1">z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">&quot;single&quot;</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">no_plot</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">exp_colors </span><span class="s3">= [</span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C2'</span><span class="s3">, </span><span class="s4">'C2'</span><span class="s3">]</span>
        <span class="s1">colors </span><span class="s3">= </span><span class="s1">d</span><span class="s3">[</span><span class="s4">&quot;leaves_color_list&quot;</span><span class="s3">]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">colors</span><span class="s3">, </span><span class="s1">exp_colors</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dendrogram_leaf_colors</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
        <span class="s0"># tests that the colors are correct for a tree</span>
        <span class="s0"># with two near points ((0, 0, 1.1) and (0, 0, 1))</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1.1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>
        <span class="s1">z </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">&quot;single&quot;</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">dendrogram</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">no_plot</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">exp_colors </span><span class="s3">= [</span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C1'</span><span class="s3">, </span><span class="s4">'C0'</span><span class="s3">, </span><span class="s4">'C2'</span><span class="s3">, </span><span class="s4">'C2'</span><span class="s3">]</span>
        <span class="s1">colors </span><span class="s3">= </span><span class="s1">d</span><span class="s3">[</span><span class="s4">&quot;leaves_color_list&quot;</span><span class="s3">]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">colors</span><span class="s3">, </span><span class="s1">exp_colors</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">calculate_maximum_distances</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s0"># Used for testing correctness of maxdists.</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">1</span>
    <span class="s1">B </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">Z</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">3</span><span class="s3">,))</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">n </span><span class="s3">- </span><span class="s5">1</span><span class="s3">):</span>
        <span class="s1">q</span><span class="s3">[:] = </span><span class="s5">0.0</span>
        <span class="s1">left </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">right </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">left </span><span class="s3">&gt;= </span><span class="s1">n</span><span class="s3">:</span>
            <span class="s1">q</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s1">B</span><span class="s3">[</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">) - </span><span class="s1">n</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">right </span><span class="s3">&gt;= </span><span class="s1">n</span><span class="s3">:</span>
            <span class="s1">q</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">B</span><span class="s3">[</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">right</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">) - </span><span class="s1">n</span><span class="s3">]</span>
        <span class="s1">q</span><span class="s3">[</span><span class="s5">2</span><span class="s3">] = </span><span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>
        <span class="s1">B</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">q</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">B</span>


<span class="s2">def </span><span class="s1">calculate_maximum_inconsistencies</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">=</span><span class="s1">np</span><span class="s3">):</span>
    <span class="s0"># Used for testing correctness of maxinconsts.</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] + </span><span class="s5">1</span>
    <span class="s1">dtype </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">result_type</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">R</span><span class="s3">)</span>
    <span class="s1">B </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">3</span><span class="s3">,))</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">n </span><span class="s3">- </span><span class="s5">1</span><span class="s3">):</span>
        <span class="s1">q</span><span class="s3">[:] = </span><span class="s5">0.0</span>
        <span class="s1">left </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">right </span><span class="s3">= </span><span class="s1">Z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">left </span><span class="s3">&gt;= </span><span class="s1">n</span><span class="s3">:</span>
            <span class="s1">q</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s1">B</span><span class="s3">[</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">) - </span><span class="s1">n</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">right </span><span class="s3">&gt;= </span><span class="s1">n</span><span class="s3">:</span>
            <span class="s1">q</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">B</span><span class="s3">[</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">right</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">) - </span><span class="s1">n</span><span class="s3">]</span>
        <span class="s1">q</span><span class="s3">[</span><span class="s5">2</span><span class="s3">] = </span><span class="s1">R</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">k</span><span class="s3">]</span>
        <span class="s1">B</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">q</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">B</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_unsupported_uncondensed_distance_matrix_linkage_warning</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s1">assert_warns</span><span class="s3">(</span><span class="s1">ClusterWarning</span><span class="s3">, </span><span class="s1">linkage</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]))</span>


<span class="s2">def </span><span class="s1">test_euclidean_linkage_value_error</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">hierarchy</span><span class="s3">.</span><span class="s1">_EUCLIDEAN_METHODS</span><span class="s3">:</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">linkage</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]),</span>
                      <span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'cityblock'</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_2x2_linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s1">Z1 </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">1</span><span class="s3">]), </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'single'</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'euclidean'</span><span class="s3">)</span>
    <span class="s1">Z2 </span><span class="s3">= </span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]), </span><span class="s1">method</span><span class="s3">=</span><span class="s4">'single'</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'euclidean'</span><span class="s3">)</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z1</span><span class="s3">, </span><span class="s1">Z2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_node_compare</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">23</span><span class="s3">)</span>
    <span class="s1">nobs </span><span class="s3">= </span><span class="s5">50</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">nobs</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">Z </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">hierarchy</span><span class="s3">.</span><span class="s1">ward</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">tree </span><span class="s3">= </span><span class="s1">to_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">tree </span><span class="s3">&gt; </span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_left</span><span class="s3">())</span>
    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_right</span><span class="s3">() &gt; </span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_left</span><span class="s3">())</span>
    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_right</span><span class="s3">() == </span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_right</span><span class="s3">())</span>
    <span class="s1">assert_</span><span class="s3">(</span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_right</span><span class="s3">() != </span><span class="s1">tree</span><span class="s3">.</span><span class="s1">get_left</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">np_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'`cut_tree` uses non-standard indexing'</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_cut_tree</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">23</span><span class="s3">)</span>
    <span class="s1">nobs </span><span class="s3">= </span><span class="s5">50</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">nobs</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">Z </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">hierarchy</span><span class="s3">.</span><span class="s1">ward</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">cutree </span><span class="s3">= </span><span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s0"># cutree.dtype varies between int32 and int64 over platforms</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">nobs</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">, </span><span class="s1">check_dtype</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, -</span><span class="s5">1</span><span class="s3">], </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">nobs</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">, </span><span class="s1">check_dtype</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">).</span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">nobs </span><span class="s3">- </span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">))</span>

    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, [-</span><span class="s5">5</span><span class="s3">]], </span><span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">n_clusters</span><span class="s3">=</span><span class="s5">5</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, [-</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">]], </span><span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">n_clusters</span><span class="s3">=[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, [-</span><span class="s5">10</span><span class="s3">, -</span><span class="s5">5</span><span class="s3">]], </span><span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">n_clusters</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s1">nodes </span><span class="s3">= </span><span class="s1">_order_cluster_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">)</span>
    <span class="s1">heights </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">node</span><span class="s3">.</span><span class="s1">dist </span><span class="s2">for </span><span class="s1">node </span><span class="s2">in </span><span class="s1">nodes</span><span class="s3">])</span>

    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">searchsorted</span><span class="s3">(</span><span class="s1">heights</span><span class="s3">, [</span><span class="s5">5</span><span class="s3">])],</span>
                    <span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">height</span><span class="s3">=</span><span class="s5">5</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">searchsorted</span><span class="s3">(</span><span class="s1">heights</span><span class="s3">, [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])],</span>
                    <span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">height</span><span class="s3">=[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">cutree</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">searchsorted</span><span class="s3">(</span><span class="s1">heights</span><span class="s3">, [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])],</span>
                    <span class="s1">cut_tree</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">height</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">cpu_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_optimal_leaf_ordering</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s0"># test with the distance vector y</span>
    <span class="s1">Z </span><span class="s3">= </span><span class="s1">optimal_leaf_ordering</span><span class="s3">(</span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">)),</span>
                              <span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">ytdist</span><span class="s3">))</span>
    <span class="s1">expectedZ </span><span class="s3">= </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">linkage_ytdist_single_olo</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>

    <span class="s0"># test with the observation matrix X</span>
    <span class="s1">Z </span><span class="s3">= </span><span class="s1">optimal_leaf_ordering</span><span class="s3">(</span><span class="s1">linkage</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">X</span><span class="s3">), </span><span class="s4">'ward'</span><span class="s3">),</span>
                              <span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">expectedZ </span><span class="s3">= </span><span class="s1">hierarchy_test_data</span><span class="s3">.</span><span class="s1">linkage_X_ward_olo</span>
    <span class="s1">xp_assert_close</span><span class="s3">(</span><span class="s1">Z</span><span class="s3">, </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">expectedZ</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-06</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_xp_backends</span><span class="s3">(</span><span class="s1">np_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">reasons</span><span class="s3">=[</span><span class="s4">'`Heap` only supports NumPy backend'</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_Heap</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">):</span>
    <span class="s1">values </span><span class="s3">= </span><span class="s1">xp</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s1">heap </span><span class="s3">= </span><span class="s1">Heap</span><span class="s3">(</span><span class="s1">values</span><span class="s3">)</span>

    <span class="s1">pair </span><span class="s3">= </span><span class="s1">heap</span><span class="s3">.</span><span class="s1">get_min</span><span class="s3">()</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'key'</span><span class="s3">], </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'value'</span><span class="s3">], -</span><span class="s5">1.5</span><span class="s3">)</span>

    <span class="s1">heap</span><span class="s3">.</span><span class="s1">remove_min</span><span class="s3">()</span>
    <span class="s1">pair </span><span class="s3">= </span><span class="s1">heap</span><span class="s3">.</span><span class="s1">get_min</span><span class="s3">()</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'key'</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'value'</span><span class="s3">], -</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">heap</span><span class="s3">.</span><span class="s1">change_value</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">)</span>
    <span class="s1">pair </span><span class="s3">= </span><span class="s1">heap</span><span class="s3">.</span><span class="s1">get_min</span><span class="s3">()</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'key'</span><span class="s3">], </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'value'</span><span class="s3">], </span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">heap</span><span class="s3">.</span><span class="s1">remove_min</span><span class="s3">()</span>
    <span class="s1">heap</span><span class="s3">.</span><span class="s1">remove_min</span><span class="s3">()</span>

    <span class="s1">heap</span><span class="s3">.</span><span class="s1">change_value</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
    <span class="s1">pair </span><span class="s3">= </span><span class="s1">heap</span><span class="s3">.</span><span class="s1">get_min</span><span class="s3">()</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'key'</span><span class="s3">], </span><span class="s5">4</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'value'</span><span class="s3">], </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s1">heap</span><span class="s3">.</span><span class="s1">remove_min</span><span class="s3">()</span>
    <span class="s1">pair </span><span class="s3">= </span><span class="s1">heap</span><span class="s3">.</span><span class="s1">get_min</span><span class="s3">()</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'key'</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pair</span><span class="s3">[</span><span class="s4">'value'</span><span class="s3">], </span><span class="s5">10</span><span class="s3">)</span>
</pre>
</body>
</html>