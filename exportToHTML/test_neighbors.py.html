<html>
<head>
<title>test_neighbors.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_neighbors.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>

<span class="s0">import </span><span class="s1">joblib</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse </span><span class="s0">import </span><span class="s1">issparse</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">config_context</span><span class="s2">,</span>
    <span class="s1">datasets</span><span class="s2">,</span>
    <span class="s1">metrics</span><span class="s2">,</span>
    <span class="s1">neighbors</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">clone</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">DataConversionWarning</span><span class="s2">, </span><span class="s1">EfficiencyWarning</span><span class="s2">, </span><span class="s1">NotFittedError</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">_dist_metrics </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DistanceMetric</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise </span><span class="s0">import </span><span class="s1">PAIRWISE_BOOLEAN_FUNCTIONS</span><span class="s2">, </span><span class="s1">pairwise_distances</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">test_dist_metrics </span><span class="s0">import </span><span class="s1">BOOL_METRICS</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">test_pairwise_distances_reduction </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_compatible_argkmin_results</span><span class="s2">,</span>
    <span class="s1">assert_compatible_radius_results</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">cross_val_score</span><span class="s2">, </span><span class="s1">train_test_split</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">neighbors </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">VALID_METRICS_SPARSE</span><span class="s2">,</span>
    <span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">_base </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">KNeighborsMixin</span><span class="s2">,</span>
    <span class="s1">_check_precomputed</span><span class="s2">,</span>
    <span class="s1">_is_sorted_by_data</span><span class="s2">,</span>
    <span class="s1">sort_graph_by_row_values</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">make_pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">ignore_warnings</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">COO_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">DIA_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">DOK_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">LIL_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">parse_version</span><span class="s2">,</span>
    <span class="s1">sp_version</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">validation </span><span class="s0">import </span><span class="s1">check_random_state</span>

<span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
<span class="s4"># load and shuffle iris dataset</span>
<span class="s1">iris </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">()</span>
<span class="s1">perm </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">permutation</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>
<span class="s1">iris</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s1">perm</span><span class="s2">]</span>
<span class="s1">iris</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">[</span><span class="s1">perm</span><span class="s2">]</span>

<span class="s4"># load and shuffle digits</span>
<span class="s1">digits </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_digits</span><span class="s2">()</span>
<span class="s1">perm </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">permutation</span><span class="s2">(</span><span class="s1">digits</span><span class="s2">.</span><span class="s1">target</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>
<span class="s1">digits</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">digits</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s1">perm</span><span class="s2">]</span>
<span class="s1">digits</span><span class="s2">.</span><span class="s1">target </span><span class="s2">= </span><span class="s1">digits</span><span class="s2">.</span><span class="s1">target</span><span class="s2">[</span><span class="s1">perm</span><span class="s2">]</span>

<span class="s1">SPARSE_TYPES </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span>
    <span class="s1">BSR_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">COO_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">CSR_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">DOK_CONTAINERS</span>
    <span class="s2">+ </span><span class="s1">LIL_CONTAINERS</span>
<span class="s2">)</span>
<span class="s1">SPARSE_OR_DENSE </span><span class="s2">= </span><span class="s1">SPARSE_TYPES </span><span class="s2">+ (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">,)</span>

<span class="s1">ALGORITHMS </span><span class="s2">= (</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
<span class="s1">COMMON_VALID_METRICS </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span>
    <span class="s1">set</span><span class="s2">.</span><span class="s1">intersection</span><span class="s2">(*</span><span class="s1">map</span><span class="s2">(</span><span class="s1">set</span><span class="s2">, </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()))</span>
<span class="s2">)  </span><span class="s4"># type: ignore</span>

<span class="s1">P </span><span class="s2">= (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

<span class="s4"># Filter deprecation warnings.</span>
<span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph </span><span class="s2">= </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">)</span>
<span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph </span><span class="s2">= </span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">)</span>

<span class="s4"># A list containing metrics where the string specifies the use of the</span>
<span class="s4"># DistanceMetric object directly (as resolved in _parse_metric)</span>
<span class="s1">DISTANCE_METRIC_OBJS </span><span class="s2">= [</span><span class="s5">&quot;DM_euclidean&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">_parse_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Helper function for properly building a type-specialized DistanceMetric instances. 
 
    Constructs a type-specialized DistanceMetric instance from a string 
    beginning with &quot;DM_&quot; while allowing a pass-through for other metric-specifying 
    strings. This is necessary since we wish to parameterize dtype independent of 
    metric, yet DistanceMetric requires it for construction. 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">metric</span><span class="s2">[:</span><span class="s3">3</span><span class="s2">] == </span><span class="s5">&quot;DM_&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">DistanceMetric</span><span class="s2">.</span><span class="s1">get_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">[</span><span class="s3">3</span><span class="s2">:], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">metric</span>


<span class="s0">def </span><span class="s1">_generate_test_params_for</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">: </span><span class="s1">int</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Return list of DistanceMetric kwargs for tests.&quot;&quot;&quot;</span>

    <span class="s4"># Distinguishing on cases not to compute unneeded datastructures.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;minkowski&quot;</span><span class="s2">:</span>
        <span class="s1">minkowski_kwargs </span><span class="s2">= [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s3">2</span><span class="s2">), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)]</span>
        <span class="s0">if </span><span class="s1">sp_version </span><span class="s2">&gt;= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s5">&quot;1.8.0.dev0&quot;</span><span class="s2">):</span>
            <span class="s4"># TODO: remove the test once we no longer support scipy &lt; 1.8.0.</span>
            <span class="s4"># Recent scipy versions accept weights in the Minkowski metric directly:</span>
            <span class="s4"># type: ignore</span>
            <span class="s1">minkowski_kwargs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">w</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">)))</span>
        <span class="s0">return </span><span class="s1">minkowski_kwargs</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;seuclidean&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">V</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">))]</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;mahalanobis&quot;</span><span class="s2">:</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
        <span class="s4"># Make the matrix symmetric positive definite</span>
        <span class="s1">VI </span><span class="s2">= </span><span class="s1">A </span><span class="s2">+ </span><span class="s1">A</span><span class="s2">.</span><span class="s1">T </span><span class="s2">+ </span><span class="s3">3 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">VI</span><span class="s2">=</span><span class="s1">VI</span><span class="s2">)]</span>

    <span class="s4"># Case of: &quot;euclidean&quot;, &quot;manhattan&quot;, &quot;chebyshev&quot;, &quot;haversine&quot; or any other metric.</span>
    <span class="s4"># In those cases, no kwargs are needed.</span>
    <span class="s0">return </span><span class="s2">[{}]</span>


<span class="s0">def </span><span class="s1">_weight_func</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Weight function to replace lambda d: d ** -2. 
    The lambda function is not valid because: 
    if d==0 then 0^-2 is not valid.&quot;&quot;&quot;</span>

    <span class="s4"># Dist could be multidimensional, flatten it so all values</span>
    <span class="s4"># can be looped</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">):</span>
        <span class="s1">retval </span><span class="s2">= </span><span class="s3">1.0 </span><span class="s2">/ </span><span class="s1">dist</span>
    <span class="s0">return </span><span class="s1">retval</span><span class="s2">**</span><span class="s3">2</span>


<span class="s1">WEIGHTS </span><span class="s2">= [</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">_weight_func</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;n_samples, n_features, n_query_pts, n_neighbors&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">100</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">1000</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;query_is_train&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">COMMON_VALID_METRICS </span><span class="s2">+ </span><span class="s1">DISTANCE_METRIC_OBJS</span><span class="s2">)  </span><span class="s4"># type: ignore # noqa</span>
<span class="s0">def </span><span class="s1">test_unsupervised_kneighbors</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">,</span>
    <span class="s1">n_query_pts</span><span class="s2">,</span>
    <span class="s1">n_neighbors</span><span class="s2">,</span>
    <span class="s1">query_is_train</span><span class="s2">,</span>
    <span class="s1">metric</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4"># The different algorithms must return identical results</span>
    <span class="s4"># on their common metrics, with and without returning</span>
    <span class="s4"># distances</span>

    <span class="s1">metric </span><span class="s2">= </span><span class="s1">_parse_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s4"># Redefining the rng locally to use the same generated X</span>
    <span class="s1">local_rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">local_rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">query </span><span class="s2">= (</span>
        <span class="s1">X</span>
        <span class="s0">if </span><span class="s1">query_is_train</span>
        <span class="s0">else </span><span class="s1">local_rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_query_pts</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">results_nodist </span><span class="s2">= []</span>
    <span class="s1">results </span><span class="s2">= []</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">DistanceMetric</span><span class="s2">) </span><span class="s0">and </span><span class="s1">global_dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s5">&quot;tree&quot; </span><span class="s0">in </span><span class="s1">algorithm</span><span class="s2">:  </span><span class="s4"># pragma: nocover</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                    <span class="s5">&quot;Neither KDTree nor BallTree support 32-bit distance metric&quot;</span>
                    <span class="s5">&quot; objects.&quot;</span>
                <span class="s2">)</span>
        <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span>
        <span class="s2">)</span>
        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

        <span class="s1">results_nodist</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>
        <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">results</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">):</span>
        <span class="s1">algorithm </span><span class="s2">= </span><span class="s1">ALGORITHMS</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">next_algorithm </span><span class="s2">= </span><span class="s1">ALGORITHMS</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>

        <span class="s1">indices_no_dist </span><span class="s2">= </span><span class="s1">results_nodist</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">distances</span><span class="s2">, </span><span class="s1">next_distances </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s3">0</span><span class="s2">], </span><span class="s1">results</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">][</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">indices</span><span class="s2">, </span><span class="s1">next_indices </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s3">1</span><span class="s2">], </span><span class="s1">results</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">][</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">indices_no_dist</span><span class="s2">,</span>
            <span class="s1">indices</span><span class="s2">,</span>
            <span class="s1">err_msg</span><span class="s2">=(</span>
                <span class="s5">f&quot;The '</span><span class="s0">{</span><span class="s1">algorithm</span><span class="s0">}</span><span class="s5">' algorithm returns different&quot;</span>
                <span class="s5">&quot;indices depending on 'return_distances'.&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">indices</span><span class="s2">,</span>
            <span class="s1">next_indices</span><span class="s2">,</span>
            <span class="s1">err_msg</span><span class="s2">=(</span>
                <span class="s5">f&quot;The '</span><span class="s0">{</span><span class="s1">algorithm</span><span class="s0">}</span><span class="s5">' and '</span><span class="s0">{</span><span class="s1">next_algorithm</span><span class="s0">}</span><span class="s5">' &quot;</span>
                <span class="s5">&quot;algorithms return different indices.&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">distances</span><span class="s2">,</span>
            <span class="s1">next_distances</span><span class="s2">,</span>
            <span class="s1">err_msg</span><span class="s2">=(</span>
                <span class="s5">f&quot;The '</span><span class="s0">{</span><span class="s1">algorithm</span><span class="s0">}</span><span class="s5">' and '</span><span class="s0">{</span><span class="s1">next_algorithm</span><span class="s0">}</span><span class="s5">' &quot;</span>
                <span class="s5">&quot;algorithms return different distances.&quot;</span>
            <span class="s2">),</span>
            <span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-6</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;n_samples, n_features, n_query_pts&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">100</span><span class="s2">, </span><span class="s3">100</span><span class="s2">, </span><span class="s3">10</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">1000</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">100</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">COMMON_VALID_METRICS </span><span class="s2">+ </span><span class="s1">DISTANCE_METRIC_OBJS</span><span class="s2">)  </span><span class="s4"># type: ignore # noqa</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;n_neighbors, radius&quot;</span><span class="s2">, [(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">100</span><span class="s2">), (</span><span class="s3">50</span><span class="s2">, </span><span class="s3">500</span><span class="s2">), (</span><span class="s3">100</span><span class="s2">, </span><span class="s3">1000</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;NeighborsMixinSubclass&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_neigh_predictions_algorithm_agnosticity</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">,</span>
    <span class="s1">n_query_pts</span><span class="s2">,</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">n_neighbors</span><span class="s2">,</span>
    <span class="s1">radius</span><span class="s2">,</span>
    <span class="s1">NeighborsMixinSubclass</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4"># The different algorithms must return identical predictions results</span>
    <span class="s4"># on their common metrics.</span>

    <span class="s1">metric </span><span class="s2">= </span><span class="s1">_parse_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">global_dtype</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">DistanceMetric</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s5">&quot;Classifier&quot; </span><span class="s0">in </span><span class="s1">NeighborsMixinSubclass</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                <span class="s5">&quot;Metrics of type `DistanceMetric` are not yet supported for&quot;</span>
                <span class="s5">&quot; classifiers.&quot;</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s5">&quot;Radius&quot; </span><span class="s0">in </span><span class="s1">NeighborsMixinSubclass</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                <span class="s5">&quot;Metrics of type `DistanceMetric` are not yet supported for&quot;</span>
                <span class="s5">&quot; radius-neighbor estimators.&quot;</span>
            <span class="s2">)</span>

    <span class="s4"># Redefining the rng locally to use the same generated X</span>
    <span class="s1">local_rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">local_rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">local_rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">)</span>

    <span class="s1">query </span><span class="s2">= </span><span class="s1">local_rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_query_pts</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">predict_results </span><span class="s2">= []</span>

    <span class="s1">parameter </span><span class="s2">= (</span>
        <span class="s1">n_neighbors </span><span class="s0">if </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">NeighborsMixinSubclass</span><span class="s2">, </span><span class="s1">KNeighborsMixin</span><span class="s2">) </span><span class="s0">else </span><span class="s1">radius</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">DistanceMetric</span><span class="s2">) </span><span class="s0">and </span><span class="s1">global_dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s5">&quot;tree&quot; </span><span class="s0">in </span><span class="s1">algorithm</span><span class="s2">:  </span><span class="s4"># pragma: nocover</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                    <span class="s5">&quot;Neither KDTree nor BallTree support 32-bit distance metric&quot;</span>
                    <span class="s5">&quot; objects.&quot;</span>
                <span class="s2">)</span>
        <span class="s1">neigh </span><span class="s2">= </span><span class="s1">NeighborsMixinSubclass</span><span class="s2">(</span><span class="s1">parameter</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>
        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">predict_results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">query</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">predict_results</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">):</span>
        <span class="s1">algorithm </span><span class="s2">= </span><span class="s1">ALGORITHMS</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">next_algorithm </span><span class="s2">= </span><span class="s1">ALGORITHMS</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>

        <span class="s1">predictions</span><span class="s2">, </span><span class="s1">next_predictions </span><span class="s2">= </span><span class="s1">predict_results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">predict_results</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">]</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">predictions</span><span class="s2">,</span>
            <span class="s1">next_predictions</span><span class="s2">,</span>
            <span class="s1">err_msg</span><span class="s2">=(</span>
                <span class="s5">f&quot;The '</span><span class="s0">{</span><span class="s1">algorithm</span><span class="s0">}</span><span class="s5">' and '</span><span class="s0">{</span><span class="s1">next_algorithm</span><span class="s0">}</span><span class="s5">' &quot;</span>
                <span class="s5">&quot;algorithms return different predictions.&quot;</span>
            <span class="s2">),</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;KNeighborsMixinSubclass&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_unsupervised_inputs</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">KNeighborsMixinSubclass</span><span class="s2">):</span>
    <span class="s4"># Test unsupervised inputs for neighbors estimators</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">nbrs_fid </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">nbrs_fid</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">dist1</span><span class="s2">, </span><span class="s1">ind1 </span><span class="s2">= </span><span class="s1">nbrs_fid</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">KNeighborsMixinSubclass</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">data </span><span class="s0">in </span><span class="s2">(</span><span class="s1">nbrs_fid</span><span class="s2">, </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">BallTree</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KDTree</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">dist2</span><span class="s2">, </span><span class="s1">ind2 </span><span class="s2">= </span><span class="s1">nbrs</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist1</span><span class="s2">, </span><span class="s1">dist2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_not_fitted_error_gets_raised</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">neighbors_ </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">neighbors_</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">neighbors_</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:EfficiencyWarning&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">check_precomputed</span><span class="s2">(</span><span class="s1">make_train_test</span><span class="s2">, </span><span class="s1">estimators</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Tests unsupervised NearestNeighbors with a distance matrix.&quot;&quot;&quot;</span>
    <span class="s4"># Note: smaller samples may result in spurious test success</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">DXX</span><span class="s2">, </span><span class="s1">DYX </span><span class="s2">= </span><span class="s1">make_train_test</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s5">&quot;kneighbors&quot;</span><span class="s2">,</span>
    <span class="s2">]:</span>
        <span class="s4"># TODO: also test radius_neighbors, but requires different assertion</span>

        <span class="s4"># As a feature matrix (n_samples by n_features)</span>
        <span class="s1">nbrs_X </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">nbrs_X</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">dist_X</span><span class="s2">, </span><span class="s1">ind_X </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nbrs_X</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">Y</span><span class="s2">)</span>

        <span class="s4"># As a dense distance matrix (n_samples by n_samples)</span>
        <span class="s1">nbrs_D </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span>
        <span class="s2">)</span>
        <span class="s1">nbrs_D</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">DXX</span><span class="s2">)</span>
        <span class="s1">dist_D</span><span class="s2">, </span><span class="s1">ind_D </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nbrs_D</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">DYX</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist_X</span><span class="s2">, </span><span class="s1">dist_D</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind_X</span><span class="s2">, </span><span class="s1">ind_D</span><span class="s2">)</span>

        <span class="s4"># Check auto works too</span>
        <span class="s1">nbrs_D </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span>
        <span class="s2">)</span>
        <span class="s1">nbrs_D</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">DXX</span><span class="s2">)</span>
        <span class="s1">dist_D</span><span class="s2">, </span><span class="s1">ind_D </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nbrs_D</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">DYX</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist_X</span><span class="s2">, </span><span class="s1">dist_D</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind_X</span><span class="s2">, </span><span class="s1">ind_D</span><span class="s2">)</span>

        <span class="s4"># Check X=None in prediction</span>
        <span class="s1">dist_X</span><span class="s2">, </span><span class="s1">ind_X </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nbrs_X</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">dist_D</span><span class="s2">, </span><span class="s1">ind_D </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">nbrs_D</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist_X</span><span class="s2">, </span><span class="s1">dist_D</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind_X</span><span class="s2">, </span><span class="s1">ind_D</span><span class="s2">)</span>

        <span class="s4"># Must raise a ValueError if the matrix is not of correct shape</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">nbrs_D</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">Est </span><span class="s0">in </span><span class="s1">estimators</span><span class="s2">:</span>
        <span class="s1">est </span><span class="s2">= </span><span class="s1">Est</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">)</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">radius </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">n_neighbors </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">pred_X </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">target</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">metric </span><span class="s2">= </span><span class="s5">&quot;precomputed&quot;</span>
        <span class="s1">pred_D </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">DXX</span><span class="s2">, </span><span class="s1">target</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">DYX</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pred_X</span><span class="s2">, </span><span class="s1">pred_D</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_precomputed_dense</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">make_train_test</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">),</span>
            <span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">X_train</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s1">estimators </span><span class="s2">= [</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">check_precomputed</span><span class="s2">(</span><span class="s1">make_train_test</span><span class="s2">, </span><span class="s1">estimators</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;fmt&quot;</span><span class="s2">, [</span><span class="s5">&quot;csr&quot;</span><span class="s2">, </span><span class="s5">&quot;lil&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_precomputed_sparse_knn</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">make_train_test</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">):</span>
        <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3 </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">asformat</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">),</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">asformat</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s4"># We do not test RadiusNeighborsClassifier and RadiusNeighborsRegressor</span>
    <span class="s4"># since the precomputed neighbors graph is built with k neighbors only.</span>
    <span class="s1">estimators </span><span class="s2">= [</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">check_precomputed</span><span class="s2">(</span><span class="s1">make_train_test</span><span class="s2">, </span><span class="s1">estimators</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;fmt&quot;</span><span class="s2">, [</span><span class="s5">&quot;csr&quot;</span><span class="s2">, </span><span class="s5">&quot;lil&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_precomputed_sparse_radius</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">make_train_test</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">):</span>
        <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">asformat</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">),</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">asformat</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s4"># We do not test KNeighborsClassifier and KNeighborsRegressor</span>
    <span class="s4"># since the precomputed neighbors graph is built with a radius.</span>
    <span class="s1">estimators </span><span class="s2">= [</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s1">check_precomputed</span><span class="s2">(</span><span class="s1">make_train_test</span><span class="s2">, </span><span class="s1">estimators</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_is_sorted_by_data</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># Test that _is_sorted_by_data works as expected. In CSR sparse matrix,</span>
    <span class="s4"># entries in each row can be sorted by indices, by data, or unsorted.</span>
    <span class="s4"># _is_sorted_by_data should return True when entries are sorted by data,</span>
    <span class="s4"># and False in all other cases.</span>

    <span class="s4"># Test with sorted single row sparse array</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s4"># Test with unsorted 1D array</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">] = </span><span class="s3">5</span>
    <span class="s0">assert not </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s4"># Test when the data is sorted in each sample, but not necessarily</span>
    <span class="s4"># between samples</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])</span>
    <span class="s0">assert </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s4"># Test with duplicates entries in X.indptr</span>
    <span class="s1">data</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indptr </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">((</span><span class="s1">data</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, </span><span class="s1">indptr</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">=(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:EfficiencyWarning&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;function&quot;</span><span class="s2">, [</span><span class="s1">sort_graph_by_row_values</span><span class="s2">, </span><span class="s1">_check_precomputed</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">function</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># Test that sort_graph_by_row_values returns a graph sorted by row values</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)))</span>
    <span class="s0">assert not </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s1">function</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">)</span>

    <span class="s4"># test with a different number of nonzero entries for each sample</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">).</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s1">mask </span><span class="s2">== </span><span class="s3">1</span><span class="s2">] = </span><span class="s3">0</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s1">function</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:EfficiencyWarning&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort_graph_by_row_values_copy</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># Test if the sorting is done inplace if X is CSR, so that Xt is X.</span>
    <span class="s1">X_ </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)))</span>
    <span class="s0">assert not </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">)</span>

    <span class="s4"># sort_graph_by_row_values is done inplace if copy=False</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">data </span><span class="s0">is </span><span class="s1">X</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">data </span><span class="s0">is </span><span class="s1">X</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">data </span><span class="s0">is not </span><span class="s1">X</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s4"># _check_precomputed is never done inplace</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">_check_precomputed</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">data </span><span class="s0">is not </span><span class="s1">X</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s4"># do not raise if X is not CSR and copy=True</span>
    <span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">tocsc</span><span class="s2">(), </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s4"># raise if X is not CSR and copy=False</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Use copy=True to allow the conversion&quot;</span><span class="s2">):</span>
        <span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">tocsc</span><span class="s2">(), </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort_graph_by_row_values_warning</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># Test that the parameter warn_when_not_sorted works as expected.</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)))</span>
    <span class="s0">assert not </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s4"># warning</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">EfficiencyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;was not sorted by row values&quot;</span><span class="s2">):</span>
        <span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">EfficiencyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;was not sorted by row values&quot;</span><span class="s2">):</span>
        <span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">warn_when_not_sorted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">EfficiencyWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;was not sorted by row values&quot;</span><span class="s2">):</span>
        <span class="s1">_check_precomputed</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s4"># no warning</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s5">&quot;error&quot;</span><span class="s2">)</span>
        <span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">warn_when_not_sorted</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">DOK_CONTAINERS </span><span class="s2">+ </span><span class="s1">BSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">DIA_CONTAINERS</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort_graph_by_row_values_bad_sparse_format</span><span class="s2">(</span><span class="s1">sparse_container</span><span class="s2">):</span>
    <span class="s4"># Test that sort_graph_by_row_values and _check_precomputed error on bad formats</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;format is not supported&quot;</span><span class="s2">):</span>
        <span class="s1">sort_graph_by_row_values</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;format is not supported&quot;</span><span class="s2">):</span>
        <span class="s1">_check_precomputed</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:EfficiencyWarning&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_precomputed_sparse_invalid</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>
    <span class="s1">dist_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
    <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span><span class="s2">)</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">dist_csr</span><span class="s2">)</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]]), </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># Ensures enough number of nearest neighbors</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>
    <span class="s1">dist_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">dist_csr</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;2 neighbors per samples are required, but some samples have only 1&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s4"># Checks error with inconsistent distance matrix</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>
    <span class="s1">dist_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Negative values in data passed to precomputed distance matrix.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">dist_csr</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_precomputed_cross_validation</span><span class="s2">():</span>
    <span class="s4"># Ensure array is split correctly</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">D </span><span class="s2">= </span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s3">20</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">Est </span><span class="s0">in </span><span class="s2">(</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">metric_score </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">Est</span><span class="s2">(), </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">precomp_score </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">Est</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span><span class="s2">), </span><span class="s1">D</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">metric_score</span><span class="s2">, </span><span class="s1">precomp_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_unsupervised_radius_neighbors</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s3">20</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_query_pts</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test unsupervised radius-based query</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">test </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_query_pts</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">P</span><span class="s2">:</span>
        <span class="s1">results </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
            <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">)</span>
            <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

            <span class="s1">ind1 </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

            <span class="s4"># sort the results: this is not done automatically for</span>
            <span class="s4"># radius searches</span>
            <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">d</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">i1 </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">ind</span><span class="s2">, </span><span class="s1">ind1</span><span class="s2">):</span>
                <span class="s1">j </span><span class="s2">= </span><span class="s1">d</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">()</span>
                <span class="s1">d</span><span class="s2">[:] = </span><span class="s1">d</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
                <span class="s1">i</span><span class="s2">[:] = </span><span class="s1">i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
                <span class="s1">i1</span><span class="s2">[:] = </span><span class="s1">i1</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
            <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">ind</span><span class="s2">))</span>

            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">ind1</span><span class="s2">)))</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">results</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s3">0</span><span class="s2">])),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">][</span><span class="s3">0</span><span class="s2">])),</span>
            <span class="s2">),</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s3">1</span><span class="s2">])),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">][</span><span class="s3">1</span><span class="s2">])),</span>
            <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;weights&quot;</span><span class="s2">, </span><span class="s1">WEIGHTS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_kneighbors_classifier</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">algorithm</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">,</span>
    <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4"># Test k-neighbors classification</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= ((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) &lt; </span><span class="s3">0.5</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">y_str </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>

    <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
    <span class="s2">)</span>
    <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">])</span>
    <span class="s4"># Test prediction with y_str</span>
    <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y_str</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y_str</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_kneighbors_classifier_float_labels</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">,</span>
    <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4"># Test k-neighbors classification</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= ((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) &lt; </span><span class="s3">0.5</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">)</span>
    <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">))</span>
    <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_kneighbors_classifier_predict_proba</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">):</span>
    <span class="s4"># Test KNeighborsClassifier.predict_proba() method</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">cls </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)  </span><span class="s4"># cityblock dist</span>
    <span class="s1">cls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_prob </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">real_prob </span><span class="s2">= (</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s2">/ </span><span class="s3">3.0</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">real_prob</span><span class="s2">, </span><span class="s1">y_prob</span><span class="s2">)</span>
    <span class="s4"># Check that it also works with non integer labels</span>
    <span class="s1">cls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">))</span>
    <span class="s1">y_prob </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">real_prob</span><span class="s2">, </span><span class="s1">y_prob</span><span class="s2">)</span>
    <span class="s4"># Check that it works with weights='distance'</span>
    <span class="s1">cls </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">cls</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">y_prob </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]))</span>
    <span class="s1">real_prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">real_prob</span><span class="s2">, </span><span class="s1">y_prob</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;weights&quot;</span><span class="s2">, </span><span class="s1">WEIGHTS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_classifier</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">algorithm</span><span class="s2">,</span>
    <span class="s1">weights</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">,</span>
    <span class="s1">radius</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">,</span>
    <span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4"># Test radius-based classification</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= ((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) &lt; </span><span class="s1">radius</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">y_str </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>

    <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
    <span class="s2">)</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">])</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y_str</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y_str</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;weights&quot;</span><span class="s2">, </span><span class="s1">WEIGHTS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;outlier_label&quot;</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_classifier_when_no_neighbors</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">, </span><span class="s1">outlier_label</span>
<span class="s2">):</span>
    <span class="s4"># Test radius-based classifier when no neighbors found.</span>
    <span class="s4"># In this case it should rise an informative exception</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s3">0.1</span>

    <span class="s4"># no outliers</span>
    <span class="s1">z1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">], [</span><span class="s3">2.01</span><span class="s2">, </span><span class="s3">2.01</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s4"># one outlier</span>
    <span class="s1">z2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">], [</span><span class="s3">1.4</span><span class="s2">, </span><span class="s3">1.4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s1">rnc </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">rnc</span><span class="s2">(</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">,</span>
        <span class="s1">outlier_label</span><span class="s2">=</span><span class="s1">outlier_label</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]), </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z1</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">outlier_label </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;weights&quot;</span><span class="s2">, </span><span class="s1">WEIGHTS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_classifier_outlier_labeling</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">):</span>
    <span class="s4"># Test radius-based classifier when no neighbors found and outliers</span>
    <span class="s4"># are labeled.</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">], [</span><span class="s3">0.99</span><span class="s2">, </span><span class="s3">0.99</span><span class="s2">], [</span><span class="s3">0.98</span><span class="s2">, </span><span class="s3">0.98</span><span class="s2">], [</span><span class="s3">2.01</span><span class="s2">, </span><span class="s3">2.01</span><span class="s2">]],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s3">0.1</span>

    <span class="s4"># no outliers</span>
    <span class="s1">z1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">], [</span><span class="s3">2.01</span><span class="s2">, </span><span class="s3">2.01</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s4"># one outlier</span>
    <span class="s1">z2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.4</span><span class="s2">, </span><span class="s3">1.4</span><span class="s2">], [</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">], [</span><span class="s3">2.01</span><span class="s2">, </span><span class="s3">2.01</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s1">correct_labels1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">correct_labels2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">outlier_proba </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=-</span><span class="s3">1</span>
    <span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">correct_labels1</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z1</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Outlier label -1 is not in training classes&quot;</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">correct_labels2</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z2</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Outlier label -1 is not in training classes&quot;</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">outlier_proba</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">z2</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>

    <span class="s4"># test outlier_labeling of using predict_proba()</span>
    <span class="s1">RNC </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">], [</span><span class="s3">9</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">global_dtype</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

    <span class="s4"># test outlier_label scalar verification</span>
    <span class="s0">def </span><span class="s1">check_array_exception</span><span class="s2">():</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=[[</span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">check_array_exception</span><span class="s2">()</span>

    <span class="s4"># test invalid outlier_label dtype</span>
    <span class="s0">def </span><span class="s1">check_dtype_exception</span><span class="s2">():</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=</span><span class="s5">&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">check_dtype_exception</span><span class="s2">()</span>

    <span class="s4"># test most frequent</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=</span><span class="s5">&quot;most_frequent&quot;</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">proba</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s4"># test manual label in y</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">proba</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s4"># test manual label out of y warning</span>
    <span class="s0">def </span><span class="s1">check_warning</span><span class="s2">():</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
        <span class="s1">check_warning</span><span class="s2">()</span>

    <span class="s4"># test multi output same outlier label</span>
    <span class="s1">y_multi </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y_multi</span><span class="s2">)</span>
    <span class="s1">proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[</span><span class="s3">7</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">proba</span><span class="s2">[</span><span class="s3">1</span><span class="s2">][</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s3">7</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s4"># test multi output different outlier label</span>
    <span class="s1">y_multi </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y_multi</span><span class="s2">)</span>
    <span class="s1">proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[</span><span class="s3">7</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">proba</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">proba</span><span class="s2">[</span><span class="s3">1</span><span class="s2">][</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s3">7</span><span class="s2">], [</span><span class="s3">15</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, :], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s4"># test inconsistent outlier label list length</span>
    <span class="s0">def </span><span class="s1">check_exception</span><span class="s2">():</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">RNC</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y_multi</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">check_exception</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_classifier_zero_distance</span><span class="s2">():</span>
    <span class="s4"># Test radius-based classifier, when distance to a sample is zero.</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s3">0.1</span>

    <span class="s1">z1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]])</span>
    <span class="s1">correct_labels1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">weight_func </span><span class="s2">= </span><span class="s1">_weight_func</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">weights </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">weight_func</span><span class="s2">]:</span>
            <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span>
                <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
            <span class="s2">)</span>
            <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">):</span>
                <span class="s4"># Ignore the warning raised in _weight_func when making</span>
                <span class="s4"># predictions with null distances resulting in np.inf values.</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">correct_labels1</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z1</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_neighbors_regressors_zero_distance</span><span class="s2">():</span>
    <span class="s4"># Test radius-based regressor, when distance to a sample is zero.</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">], [</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">])</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s3">0.2</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">], [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]])</span>

    <span class="s1">rnn_correct_labels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>

    <span class="s1">knn_correct_unif </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s1">knn_correct_dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s4"># we don't test for weights=_weight_func since user will be expected</span>
        <span class="s4"># to handle zero distances themselves in the function.</span>
        <span class="s0">for </span><span class="s1">weights </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">]:</span>
            <span class="s1">rnn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">(</span>
                <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
            <span class="s2">)</span>
            <span class="s1">rnn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rnn_correct_labels</span><span class="s2">, </span><span class="s1">rnn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">weights</span><span class="s2">, </span><span class="s1">corr_labels </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">], [</span><span class="s1">knn_correct_unif</span><span class="s2">, </span><span class="s1">knn_correct_dist</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span>
                <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
            <span class="s2">)</span>
            <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">corr_labels</span><span class="s2">, </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_boundary_handling</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test whether points lying on boundary are handled consistently 
 
    Also ensures that even with only one query point, an object array 
    is returned rather than a 2d array. 
    &quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.5</span><span class="s2">], [</span><span class="s3">3.0</span><span class="s2">], [</span><span class="s3">3.01</span><span class="s2">]])</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s3">3.0</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">nbrs</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">]], </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">results</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s3">1</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">results</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">results</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_returns_array_of_objects</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># check that we can pass precomputed distances to</span>
    <span class="s4"># NearestNeighbors.radius_neighbors()</span>
    <span class="s4"># non-regression test for</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/16036</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)))</span>
    <span class="s1">X</span><span class="s2">.</span><span class="s1">setdiag</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

    <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">leaf_size</span><span class="s2">=</span><span class="s3">30</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">neigh_dist</span><span class="s2">, </span><span class="s1">neigh_ind </span><span class="s2">= </span><span class="s1">nbrs</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">expected_dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">expected_dist</span><span class="s2">[:] = [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">])]</span>
    <span class="s1">expected_ind </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">expected_ind</span><span class="s2">[:] = [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">3</span><span class="s2">])]</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">neigh_dist</span><span class="s2">, </span><span class="s1">expected_dist</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">neigh_ind</span><span class="s2">, </span><span class="s1">expected_ind</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, [</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_query_equidistant_kth_nn</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s4"># For several candidates for the k-th nearest neighbor position,</span>
    <span class="s4"># the first candidate should be chosen</span>
    <span class="s1">query_point </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">equidistant_points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s4"># The 3rd and 4th points should not replace the 2nd point</span>
    <span class="s4"># for the 2th nearest neighbor position</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s3">2</span>
    <span class="s1">knn_indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">equidistant_points</span><span class="s2">)</span>
    <span class="s1">indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">query_point</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">knn_indices</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s5">&quot;metric&quot;</span><span class="s2">],</span>
    <span class="s1">list</span><span class="s2">(</span>
        <span class="s1">product</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">, *</span><span class="s1">DISTANCE_METRIC_OBJS</span><span class="s2">),</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s2">+ [</span>
        <span class="s2">(</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s5">&quot;euclidean&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s5">&quot;precomputed&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_sort_results</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">):</span>
    <span class="s4"># Test radius_neighbors[_graph] output when sort_result is True</span>

    <span class="s1">metric </span><span class="s2">= </span><span class="s1">_parse_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">DistanceMetric</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
            <span class="s5">&quot;Metrics of type `DistanceMetric` are not yet supported for radius-neighbor&quot;</span>
            <span class="s5">&quot; estimators.&quot;</span>
        <span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">10</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;precomputed&quot;</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s4"># self.radius_neighbors</span>
    <span class="s1">distances</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">sort_results</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ii </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">distances</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">distances</span><span class="s2">[</span><span class="s1">ii</span><span class="s2">]))</span>

    <span class="s4"># sort_results=True and return_distance=False</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">!= </span><span class="s5">&quot;precomputed&quot;</span><span class="s2">:  </span><span class="s4"># no need to raise with precomputed graph</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;return_distance must be True&quot;</span><span class="s2">):</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span>
                <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">sort_results</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span>
            <span class="s2">)</span>

    <span class="s4"># self.radius_neighbors_graph</span>
    <span class="s1">graph </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">sort_results</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">_is_sorted_by_data</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_RadiusNeighborsClassifier_multioutput</span><span class="s2">():</span>
    <span class="s4"># Test k-NN classifier on multioutput data</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s3">2</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">40</span>
    <span class="s1">n_output </span><span class="s2">= </span><span class="s3">3</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, (</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_output</span><span class="s2">))</span>

    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s1">weights </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">_weight_func</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">ALGORITHMS</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">):</span>
        <span class="s4"># Stack single output prediction</span>
        <span class="s1">y_pred_so </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_output</span><span class="s2">):</span>
            <span class="s1">rnn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span>
                <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
            <span class="s2">)</span>
            <span class="s1">rnn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">[:, </span><span class="s1">o</span><span class="s2">])</span>
            <span class="s1">y_pred_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">rnn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>

        <span class="s1">y_pred_so </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">(</span><span class="s1">y_pred_so</span><span class="s2">).</span><span class="s1">T</span>
        <span class="s0">assert </span><span class="s1">y_pred_so</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>

        <span class="s4"># Multioutput prediction</span>
        <span class="s1">rnn_mo </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
        <span class="s2">)</span>
        <span class="s1">rnn_mo</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
        <span class="s1">y_pred_mo </span><span class="s2">= </span><span class="s1">rnn_mo</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">y_pred_mo</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred_mo</span><span class="s2">, </span><span class="s1">y_pred_so</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_kneighbors_classifier_sparse</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test k-NN classifier on sparse matrices</span>
    <span class="s4"># Like the above, but with various types of sparse matrices</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">X </span><span class="s2">*= </span><span class="s1">X </span><span class="s2">&gt; </span><span class="s3">0.2</span>
    <span class="s1">y </span><span class="s2">= ((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) &lt; </span><span class="s3">0.5</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">sparsemat </span><span class="s0">in </span><span class="s1">SPARSE_TYPES</span><span class="s2">:</span>
        <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
        <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">sparsemat</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">sparsev </span><span class="s0">in </span><span class="s1">SPARSE_TYPES </span><span class="s2">+ (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">,):</span>
            <span class="s1">X_eps </span><span class="s2">= </span><span class="s1">sparsev</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
            <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_eps</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_KNeighborsClassifier_multioutput</span><span class="s2">():</span>
    <span class="s4"># Test k-NN classifier on multioutput data</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s3">5</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">50</span>
    <span class="s1">n_output </span><span class="s2">= </span><span class="s3">3</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, (</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_output</span><span class="s2">))</span>

    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s1">weights </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">_weight_func</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">ALGORITHMS</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">):</span>
        <span class="s4"># Stack single output prediction</span>
        <span class="s1">y_pred_so </span><span class="s2">= []</span>
        <span class="s1">y_pred_proba_so </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_output</span><span class="s2">):</span>
            <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
            <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">[:, </span><span class="s1">o</span><span class="s2">])</span>
            <span class="s1">y_pred_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>
            <span class="s1">y_pred_proba_so</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>

        <span class="s1">y_pred_so </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">(</span><span class="s1">y_pred_so</span><span class="s2">).</span><span class="s1">T</span>
        <span class="s0">assert </span><span class="s1">y_pred_so</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">y_pred_proba_so</span><span class="s2">) == </span><span class="s1">n_output</span>

        <span class="s4"># Multioutput prediction</span>
        <span class="s1">knn_mo </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">knn_mo</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
        <span class="s1">y_pred_mo </span><span class="s2">= </span><span class="s1">knn_mo</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">y_pred_mo</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred_mo</span><span class="s2">, </span><span class="s1">y_pred_so</span><span class="s2">)</span>

        <span class="s4"># Check proba</span>
        <span class="s1">y_pred_proba_mo </span><span class="s2">= </span><span class="s1">knn_mo</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">y_pred_proba_mo</span><span class="s2">) == </span><span class="s1">n_output</span>

        <span class="s0">for </span><span class="s1">proba_mo</span><span class="s2">, </span><span class="s1">proba_so </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">y_pred_proba_mo</span><span class="s2">, </span><span class="s1">y_pred_proba_so</span><span class="s2">):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">proba_mo</span><span class="s2">, </span><span class="s1">proba_so</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_kneighbors_regressor</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test k-neighbors regression</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">/= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>

    <span class="s1">y_target </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">]</span>

    <span class="s1">weight_func </span><span class="s2">= </span><span class="s1">_weight_func</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">weights </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">weight_func</span><span class="s2">]:</span>
            <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span>
                <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
            <span class="s2">)</span>
            <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_pred </span><span class="s2">- </span><span class="s1">y_target</span><span class="s2">) &lt; </span><span class="s3">0.3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_KNeighborsRegressor_multioutput_uniform_weight</span><span class="s2">():</span>
    <span class="s4"># Test k-neighbors in multi-output regression with uniform weight</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s3">5</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">40</span>
    <span class="s1">n_output </span><span class="s2">= </span><span class="s3">4</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_output</span><span class="s2">)</span>

    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">ALGORITHMS</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;uniform&quot;</span><span class="s2">]):</span>
        <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>

        <span class="s1">neigh_idx </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">y_pred_idx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y_train</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">neigh_idx</span><span class="s2">])</span>

        <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s0">assert </span><span class="s1">y_pred_idx</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y_pred_idx</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_kneighbors_regressor_multioutput</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test k-neighbors in multi-output regression</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">/= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">([</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]).</span><span class="s1">T</span>

    <span class="s1">y_target </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">]</span>

    <span class="s1">weights </span><span class="s2">= [</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">_weight_func</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">ALGORITHMS</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">):</span>
        <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
        <span class="s2">)</span>
        <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_target</span><span class="s2">.</span><span class="s1">shape</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_pred </span><span class="s2">- </span><span class="s1">y_target</span><span class="s2">) &lt; </span><span class="s3">0.3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_regressor</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test radius-based neighbors regression</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">/= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>

    <span class="s1">y_target </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">]</span>

    <span class="s1">weight_func </span><span class="s2">= </span><span class="s1">_weight_func</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">weights </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">weight_func</span><span class="s2">]:</span>
            <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">(</span>
                <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span>
            <span class="s2">)</span>
            <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_pred </span><span class="s2">- </span><span class="s1">y_target</span><span class="s2">) &lt; </span><span class="s1">radius </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s4"># test that nan is returned when no nearby observations</span>
    <span class="s0">for </span><span class="s1">weights </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">]:</span>
        <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">(</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span>
        <span class="s2">)</span>
        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">X_test_nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">), -</span><span class="s3">1.0</span><span class="s2">)</span>
        <span class="s1">empty_warning_msg </span><span class="s2">= (</span>
            <span class="s5">&quot;One or more samples have no neighbors &quot;</span>
            <span class="s5">&quot;within specified radius; predicting NaN.&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">empty_warning_msg</span><span class="s2">)):</span>
            <span class="s1">pred </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test_nan</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_RadiusNeighborsRegressor_multioutput_with_uniform_weight</span><span class="s2">():</span>
    <span class="s4"># Test radius neighbors in multi-output regression (uniform weight)</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s3">5</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s3">40</span>
    <span class="s1">n_output </span><span class="s2">= </span><span class="s3">4</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_output</span><span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">ALGORITHMS</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;uniform&quot;</span><span class="s2">]):</span>
        <span class="s1">rnn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">rnn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>

        <span class="s1">neigh_idx </span><span class="s2">= </span><span class="s1">rnn</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">y_pred_idx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y_train</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">neigh_idx</span><span class="s2">])</span>

        <span class="s1">y_pred_idx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">y_pred_idx</span><span class="s2">)</span>
        <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rnn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">y_pred_idx</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s0">assert </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_test</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y_pred_idx</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_RadiusNeighborsRegressor_multioutput</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test k-neighbors in multi-output regression with various weight</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">/= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">([</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]).</span><span class="s1">T</span>

    <span class="s1">y_target </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">]</span>
    <span class="s1">weights </span><span class="s2">= [</span><span class="s5">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">, </span><span class="s1">_weight_func</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">weights </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span><span class="s1">ALGORITHMS</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">):</span>
        <span class="s1">rnn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">rnn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1e-5 </span><span class="s2">* (</span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rnn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_test_pts</span><span class="s2">] + </span><span class="s1">epsilon</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">y_target</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">y_pred </span><span class="s2">- </span><span class="s1">y_target</span><span class="s2">) &lt; </span><span class="s3">0.3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore:EfficiencyWarning&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_kneighbors_regressor_sparse</span><span class="s2">(</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">40</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_test_pts</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
<span class="s2">):</span>
    <span class="s4"># Test radius-based regression on sparse matrices</span>
    <span class="s4"># Like the above, but with various types of sparse matrices</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= ((</span><span class="s1">X</span><span class="s2">**</span><span class="s3">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) &lt; </span><span class="s3">0.25</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">sparsemat </span><span class="s0">in </span><span class="s1">SPARSE_TYPES</span><span class="s2">:</span>
        <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
        <span class="s1">knn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">sparsemat</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">knn_pre </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span>
        <span class="s2">)</span>
        <span class="s1">knn_pre</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">), </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">sparsev </span><span class="s0">in </span><span class="s1">SPARSE_OR_DENSE</span><span class="s2">:</span>
            <span class="s1">X2 </span><span class="s2">= </span><span class="s1">sparsev</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">).</span><span class="s1">round</span><span class="s2">() == </span><span class="s1">y</span><span class="s2">) &gt; </span><span class="s3">0.95</span>

            <span class="s1">X2_pre </span><span class="s2">= </span><span class="s1">sparsev</span><span class="s2">(</span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">sparsev </span><span class="s0">in </span><span class="s1">DOK_CONTAINERS </span><span class="s2">+ </span><span class="s1">BSR_CONTAINERS</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;not supported due to its handling of explicit zeros&quot;</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                    <span class="s1">knn_pre</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X2_pre</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">knn_pre</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X2_pre</span><span class="s2">).</span><span class="s1">round</span><span class="s2">() == </span><span class="s1">y</span><span class="s2">) &gt; </span><span class="s3">0.95</span>


<span class="s0">def </span><span class="s1">test_neighbors_iris</span><span class="s2">():</span>
    <span class="s4"># Sanity checks on the iris dataset</span>
    <span class="s4"># Puts three points of each label in the plane and performs a</span>
    <span class="s4"># nearest neighbor query on points near the decision boundary.</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">), </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>

        <span class="s1">clf</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">9</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">) == </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">) &gt; </span><span class="s3">0.95</span>

        <span class="s1">rgs </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
        <span class="s1">rgs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">rgs</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">).</span><span class="s1">round</span><span class="s2">() == </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">) &gt; </span><span class="s3">0.95</span>


<span class="s0">def </span><span class="s1">test_neighbors_digits</span><span class="s2">():</span>
    <span class="s4"># Sanity check on the digits dataset</span>
    <span class="s4"># the 'brute' algorithm has been observed to fail if the input</span>
    <span class="s4"># dtype is uint8 due to overflow in distance calculations.</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">digits</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;uint8&quot;</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">digits</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) = </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s1">train_test_boundary </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">n_samples </span><span class="s2">* </span><span class="s3">0.8</span><span class="s2">)</span>
    <span class="s1">train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">train_test_boundary</span><span class="s2">)</span>
    <span class="s1">test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">train_test_boundary</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">Y_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">Y_test</span><span class="s2">) = </span><span class="s1">X</span><span class="s2">[</span><span class="s1">train</span><span class="s2">], </span><span class="s1">Y</span><span class="s2">[</span><span class="s1">train</span><span class="s2">], </span><span class="s1">X</span><span class="s2">[</span><span class="s1">test</span><span class="s2">], </span><span class="s1">Y</span><span class="s2">[</span><span class="s1">test</span><span class="s2">]</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">)</span>
    <span class="s1">score_uint8 </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">Y_train</span><span class="s2">).</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">Y_test</span><span class="s2">)</span>
    <span class="s1">score_float </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s1">Y_train</span><span class="s2">).</span><span class="s1">score</span><span class="s2">(</span>
        <span class="s1">X_test</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s1">Y_test</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">score_uint8 </span><span class="s2">== </span><span class="s1">score_float</span>


<span class="s0">def </span><span class="s1">test_kneighbors_graph</span><span class="s2">():</span>
    <span class="s4"># Test kneighbors_graph to build the k-Nearest Neighbor graph.</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>

    <span class="s4"># n_neighbors = 1</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]))</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">0.00</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.00</span><span class="s2">, </span><span class="s3">1.40716026</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s4"># n_neighbors = 2</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]])</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">2.23606798</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.40716026</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">2.23606798</span><span class="s2">, </span><span class="s3">1.40716026</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">],</span>
        <span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s4"># n_neighbors = 3</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;n_neighbors&quot;</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;mode&quot;</span><span class="s2">, [</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_kneighbors_graph_sparse</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s3">36</span><span class="s2">):</span>
    <span class="s4"># Test kneighbors_graph to build the k-Nearest Neighbor graph</span>
    <span class="s4"># for sparse input.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">Xcsr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">Xcsr</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_graph</span><span class="s2">():</span>
    <span class="s4"># Test radius_neighbors_graph to build the Nearest Neighbor graph.</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]])</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">A</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.01</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.40716026</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.40716026</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]]</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;n_neighbors&quot;</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;mode&quot;</span><span class="s2">, [</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s5">&quot;distance&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_graph_sparse</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s3">36</span><span class="s2">):</span>
    <span class="s4"># Test radius_neighbors_graph to build the Nearest Neighbor graph</span>
    <span class="s4"># for sparse input.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">Xcsr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">Xcsr</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;Estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_neighbors_validate_parameters</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Additional parameter validation for *Neighbors* estimators not covered by common 
    validation.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
    <span class="s1">Xsparse </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X3 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>

    <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;haversine&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;instance is not fitted yet&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Metric 'haversine' not valid for sparse input.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xsparse</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>

    <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;haversine&quot;</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">)</span>
    <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X3</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Haversine distance only valid in 2 dimensions&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X3</span><span class="s2">)</span>

    <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">()</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s5">&quot;Found array with 0 sample(s)&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">0</span><span class="s2">))</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Found array with dim 3&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, :, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s5">&quot;Found array with 0 feature(s)&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;Estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;n_features&quot;</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, [</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_neighbors_minkowski_semimetric_algo_warn</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Validation of all classes extending NeighborsBase with 
    Minkowski semi-metrics (i.e. when 0 &lt; p &lt; 1). That proper 
    Warning is raised for `algorithm=&quot;auto&quot;` and &quot;brute&quot;. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;Mind that for 0 &lt; p &lt; 1, Minkowski metrics are not distance&quot;</span>
        <span class="s5">&quot; metrics. Continuing the execution with `algorithm='brute'`.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_fit_method </span><span class="s2">== </span><span class="s5">&quot;brute&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;Estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">,</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;n_features&quot;</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">100</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, [</span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_neighbors_minkowski_semimetric_algo_error</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise a proper error if `algorithm!='brute'` and `p&lt;1`.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">f'algorithm=&quot;</span><span class="s0">{</span><span class="s1">algorithm</span><span class="s0">}</span><span class="s5">&quot; does not support 0 &lt; p &lt; 1 for '</span>
        <span class="s5">&quot;the Minkowski metric. To resolve this problem either &quot;</span>
        <span class="s5">'set p &gt;= 1 or algorithm=&quot;brute&quot;.'</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s4"># TODO: remove when NearestNeighbors methods uses parameter validation mechanism</span>
<span class="s0">def </span><span class="s1">test_nearest_neighbors_validate_params</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Validate parameter of NearestNeighbors.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

    <span class="s1">nbrs </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">'Unsupported mode, must be one of &quot;connectivity&quot;, or &quot;distance&quot; but got &quot;blah&quot;'</span>
        <span class="s5">&quot; instead&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;blah&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nbrs</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;blah&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;metric&quot;</span><span class="s2">,</span>
    <span class="s1">sorted</span><span class="s2">(</span>
        <span class="s1">set</span><span class="s2">(</span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">[</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">]).</span><span class="s1">intersection</span><span class="s2">(</span>
            <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">[</span><span class="s5">&quot;brute&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s2">- </span><span class="s1">set</span><span class="s2">([</span><span class="s5">&quot;pyfunc&quot;</span><span class="s2">, *</span><span class="s1">BOOL_METRICS</span><span class="s2">])</span>
    <span class="s2">)</span>
    <span class="s2">+ </span><span class="s1">DISTANCE_METRIC_OBJS</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_neighbors_metrics</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">20</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
    <span class="s1">n_query_pts</span><span class="s2">=</span><span class="s3">2</span><span class="s2">,</span>
    <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>

    <span class="s1">metric </span><span class="s2">= </span><span class="s1">_parse_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s4"># Test computing the neighbors for various metrics</span>
    <span class="s1">algorithms </span><span class="s2">= [</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">, </span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">]</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_query_pts</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">metric_params_list </span><span class="s2">= </span><span class="s1">_generate_test_params_for</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">metric_params </span><span class="s0">in </span><span class="s1">metric_params_list</span><span class="s2">:</span>
        <span class="s4"># Some metric (e.g. Weighted minkowski) are not supported by KDTree</span>
        <span class="s1">exclude_kd_tree </span><span class="s2">= (</span>
            <span class="s0">False</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">DistanceMetric</span><span class="s2">)</span>
            <span class="s0">else </span><span class="s1">metric </span><span class="s0">not in </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">[</span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">]</span>
            <span class="s0">or </span><span class="s2">(</span><span class="s5">&quot;minkowski&quot; </span><span class="s0">in </span><span class="s1">metric </span><span class="s0">and </span><span class="s5">&quot;w&quot; </span><span class="s0">in </span><span class="s1">metric_params</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">results </span><span class="s2">= {}</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">metric_params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">&quot;p&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">algorithms</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">DistanceMetric</span><span class="s2">) </span><span class="s0">and </span><span class="s1">global_dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s5">&quot;tree&quot; </span><span class="s0">in </span><span class="s1">algorithm</span><span class="s2">:  </span><span class="s4"># pragma: nocover</span>
                    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                        <span class="s5">&quot;Neither KDTree nor BallTree support 32-bit distance metric&quot;</span>
                        <span class="s5">&quot; objects.&quot;</span>
                    <span class="s2">)</span>
            <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
                <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">,</span>
                <span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">,</span>
                <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
                <span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">,</span>
                <span class="s1">metric_params</span><span class="s2">=</span><span class="s1">metric_params</span><span class="s2">,</span>
            <span class="s2">)</span>

            <span class="s0">if </span><span class="s1">exclude_kd_tree </span><span class="s0">and </span><span class="s1">algorithm </span><span class="s2">== </span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
                <span class="s0">continue</span>

            <span class="s4"># Haversine distance only accepts 2D data</span>
            <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;haversine&quot;</span><span class="s2">:</span>
                <span class="s1">feature_sl </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>
                <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>

            <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
            <span class="s1">results</span><span class="s2">[</span><span class="s1">algorithm</span><span class="s2">] = </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">brute_dst</span><span class="s2">, </span><span class="s1">brute_idx </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s5">&quot;brute&quot;</span><span class="s2">]</span>
        <span class="s1">ball_tree_dst</span><span class="s2">, </span><span class="s1">ball_tree_idx </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">]</span>

        <span class="s4"># The returned distances are always in float64 regardless of the input dtype</span>
        <span class="s4"># We need to adjust the tolerance w.r.t the input dtype</span>
        <span class="s1">rtol </span><span class="s2">= </span><span class="s3">1e-7 </span><span class="s0">if </span><span class="s1">global_dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64 </span><span class="s0">else </span><span class="s3">1e-4</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">brute_dst</span><span class="s2">, </span><span class="s1">ball_tree_dst</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">brute_idx</span><span class="s2">, </span><span class="s1">ball_tree_idx</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">exclude_kd_tree</span><span class="s2">:</span>
            <span class="s1">kd_tree_dst</span><span class="s2">, </span><span class="s1">kd_tree_idx </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">]</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">brute_dst</span><span class="s2">, </span><span class="s1">kd_tree_dst</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">brute_idx</span><span class="s2">, </span><span class="s1">kd_tree_idx</span><span class="s2">)</span>

            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ball_tree_dst</span><span class="s2">, </span><span class="s1">kd_tree_dst</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ball_tree_idx</span><span class="s2">, </span><span class="s1">kd_tree_idx</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">[</span><span class="s5">&quot;brute&quot;</span><span class="s2">]) - </span><span class="s1">set</span><span class="s2">([</span><span class="s5">&quot;precomputed&quot;</span><span class="s2">]))</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_kneighbors_brute_backend</span><span class="s2">(</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">2000</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s3">30</span><span class="s2">,</span>
    <span class="s1">n_query_pts</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s4"># Both backend for the 'brute' algorithm of kneighbors must give identical results.</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_query_pts</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s4"># Haversine distance only accepts 2D data</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;haversine&quot;</span><span class="s2">:</span>
        <span class="s1">feature_sl </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>
        <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s0">in </span><span class="s1">PAIRWISE_BOOLEAN_FUNCTIONS</span><span class="s2">:</span>
        <span class="s1">X_train </span><span class="s2">= </span><span class="s1">X_train </span><span class="s2">&gt; </span><span class="s3">0.5</span>
        <span class="s1">X_test </span><span class="s2">= </span><span class="s1">X_test </span><span class="s2">&gt; </span><span class="s3">0.5</span>

    <span class="s1">metric_params_list </span><span class="s2">= </span><span class="s1">_generate_test_params_for</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">metric_params </span><span class="s0">in </span><span class="s1">metric_params_list</span><span class="s2">:</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">metric_params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">&quot;p&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">,</span>
            <span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">,</span>
            <span class="s1">metric_params</span><span class="s2">=</span><span class="s1">metric_params</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">enable_cython_pairwise_dist</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
            <span class="s4"># Use the legacy backend for brute</span>
            <span class="s1">legacy_brute_dst</span><span class="s2">, </span><span class="s1">legacy_brute_idx </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span>
                <span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">enable_cython_pairwise_dist</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s4"># Use the pairwise-distances reduction backend for brute</span>
            <span class="s1">pdr_brute_dst</span><span class="s2">, </span><span class="s1">pdr_brute_idx </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span>
                <span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>

        <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
            <span class="s1">legacy_brute_dst</span><span class="s2">, </span><span class="s1">pdr_brute_dst</span><span class="s2">, </span><span class="s1">legacy_brute_idx</span><span class="s2">, </span><span class="s1">pdr_brute_idx</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_callable_metric</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">custom_metric</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s1">x2</span><span class="s2">**</span><span class="s3">2</span><span class="s2">))</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">42</span><span class="s2">).</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">nbrs1 </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">custom_metric</span>
    <span class="s2">)</span>
    <span class="s1">nbrs2 </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">custom_metric</span>
    <span class="s2">)</span>

    <span class="s1">nbrs1</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">nbrs2</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">dist1</span><span class="s2">, </span><span class="s1">ind1 </span><span class="s2">= </span><span class="s1">nbrs1</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">dist2</span><span class="s2">, </span><span class="s1">ind2 </span><span class="s2">= </span><span class="s1">nbrs2</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist1</span><span class="s2">, </span><span class="s1">dist2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">[</span><span class="s5">&quot;brute&quot;</span><span class="s2">] + </span><span class="s1">DISTANCE_METRIC_OBJS</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_valid_brute_metric_for_auto_algorithm</span><span class="s2">(</span>
    <span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s3">20</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">12</span>
<span class="s2">):</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s1">_parse_metric</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">global_dtype</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">Xcsr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">metric_params_list </span><span class="s2">= </span><span class="s1">_generate_test_params_for</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;precomputed&quot;</span><span class="s2">:</span>
        <span class="s1">X_precomputed </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
        <span class="s1">Y_precomputed </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
        <span class="s1">DXX </span><span class="s2">= </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X_precomputed</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">)</span>
        <span class="s1">DYX </span><span class="s2">= </span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">pairwise_distances</span><span class="s2">(</span>
            <span class="s1">Y_precomputed</span><span class="s2">, </span><span class="s1">X_precomputed</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span>
        <span class="s2">)</span>
        <span class="s1">nb_p </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span><span class="s2">)</span>
        <span class="s1">nb_p</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">DXX</span><span class="s2">)</span>
        <span class="s1">nb_p</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">DYX</span><span class="s2">)</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">metric_params </span><span class="s0">in </span><span class="s1">metric_params_list</span><span class="s2">:</span>
            <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
                <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
                <span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">,</span>
                <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
                <span class="s1">metric_params</span><span class="s2">=</span><span class="s1">metric_params</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s4"># Haversine distance only accepts 2D data</span>
            <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;haversine&quot;</span><span class="s2">:</span>
                <span class="s1">feature_sl </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
                <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>

            <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">metric </span><span class="s0">in </span><span class="s1">VALID_METRICS_SPARSE</span><span class="s2">[</span><span class="s5">&quot;brute&quot;</span><span class="s2">]:</span>
                <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
                    <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span>
                <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xcsr</span><span class="s2">)</span>
                <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">Xcsr</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_metric_params_interface</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">metric_params</span><span class="s2">={</span><span class="s5">&quot;p&quot;</span><span class="s2">: </span><span class="s3">3</span><span class="s2">})</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">SyntaxWarning</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_predict_sparse_ball_kd_tree</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">nbrs1 </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">)</span>
    <span class="s1">nbrs2 </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">model </span><span class="s0">in </span><span class="s2">[</span><span class="s1">nbrs1</span><span class="s2">, </span><span class="s1">nbrs2</span><span class="s2">]:</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_non_euclidean_kneighbors</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>

    <span class="s4"># Find a reasonable radius.</span>
    <span class="s1">dist_array </span><span class="s2">= </span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">dist_array</span><span class="s2">)</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s1">dist_array</span><span class="s2">[</span><span class="s3">15</span><span class="s2">]</span>

    <span class="s4"># Test kneighbors_graph</span>
    <span class="s0">for </span><span class="s1">metric </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;manhattan&quot;</span><span class="s2">, </span><span class="s5">&quot;chebyshev&quot;</span><span class="s2">]:</span>
        <span class="s1">nbrs_graph </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s1">nbrs1 </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">nbrs_graph</span><span class="s2">, </span><span class="s1">nbrs1</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">())</span>

    <span class="s4"># Test radiusneighbors_graph</span>
    <span class="s0">for </span><span class="s1">metric </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;manhattan&quot;</span><span class="s2">, </span><span class="s5">&quot;chebyshev&quot;</span><span class="s2">]:</span>
        <span class="s1">nbrs_graph </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;connectivity&quot;</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s1">nbrs1 </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">nbrs_graph</span><span class="s2">, </span><span class="s1">nbrs1</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">())</span>

    <span class="s4"># Raise error when wrong parameters are supplied,</span>
    <span class="s1">X_nbrs </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;manhattan&quot;</span><span class="s2">)</span>
    <span class="s1">X_nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X_nbrs</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">)</span>
    <span class="s1">X_nbrs </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;manhattan&quot;</span><span class="s2">)</span>
    <span class="s1">X_nbrs</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X_nbrs</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">nparray</span><span class="s2">, </span><span class="s1">list_check</span><span class="s2">):</span>
    <span class="s0">for </span><span class="s1">ind</span><span class="s2">, </span><span class="s1">ele </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">nparray</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ele</span><span class="s2">, </span><span class="s1">list_check</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_k_and_radius_neighbors_train_is_not_query</span><span class="s2">():</span>
    <span class="s4"># Test kneighbors et.al when query is not training data</span>

    <span class="s0">for </span><span class="s1">algorithm </span><span class="s0">in </span><span class="s1">ALGORITHMS</span><span class="s2">:</span>
        <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>

        <span class="s1">X </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]]</span>
        <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">test_data </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]]</span>

        <span class="s4"># Test neighbors.</span>
        <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]])</span>
        <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
        <span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

        <span class="s4"># Test the graph variants.</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]]</span>
        <span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]]),</span>
        <span class="s2">)</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_k_and_radius_neighbors_X_None</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s4"># Test kneighbors et.al when query is None</span>
    <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">]])</span>

    <span class="s4"># Test the graph variants.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s1">kng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">graph </span><span class="s0">in </span><span class="s2">[</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">kng</span><span class="s2">]:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
    <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">().</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]),</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_k_and_radius_neighbors_duplicates</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s4"># Test behavior of kneighbors when duplicates are present in query</span>
    <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
    <span class="s1">duplicates </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">]]</span>

    <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">duplicates</span><span class="s2">)</span>

    <span class="s4"># Do not do anything special to duplicates.</span>
    <span class="s1">kng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">duplicates</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">kng</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">kng</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">kng</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">check_object_arrays</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">duplicates</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">rng</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]])</span>
    <span class="s2">)</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">rng</span><span class="s2">.</span><span class="s1">sort_indices</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>

    <span class="s4"># Mask the first duplicates when n_duplicates &gt; n_neighbors.</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">)</span>
    <span class="s1">nn</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, [[</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s4"># Test that zeros are explicitly marked in kneighbors_graph.</span>
    <span class="s1">kng </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">kng</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">kng</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">kng</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">().</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]]),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_include_self_neighbors_graph</span><span class="s2">():</span>
    <span class="s4"># Test include_self parameter in neighbors_graph</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
    <span class="s1">kng </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">kng_not_self </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">kng</span><span class="s2">, [[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">kng_not_self</span><span class="s2">, [[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">rng_not_self </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">, </span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">, [[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">rng_not_self</span><span class="s2">, [[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_same_knn_parallel</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">30</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_redundant</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
    <span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">graph </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">clf</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">n_jobs</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s1">y_parallel </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">dist_parallel</span><span class="s2">, </span><span class="s1">ind_parallel </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">graph_parallel </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_parallel</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">, </span><span class="s1">dist_parallel</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, </span><span class="s1">ind_parallel</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">, </span><span class="s1">graph_parallel</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_same_radius_neighbors_parallel</span><span class="s2">(</span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">30</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_redundant</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
    <span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">dist</span><span class="s2">, </span><span class="s1">ind </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">graph </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">clf</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">n_jobs</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
    <span class="s1">y_parallel </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">dist_parallel</span><span class="s2">, </span><span class="s1">ind_parallel </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">graph_parallel </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">radius_neighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_parallel</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">dist_parallel</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">ind_parallel</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">graph</span><span class="s2">, </span><span class="s1">graph_parallel</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;backend&quot;</span><span class="s2">, [</span><span class="s5">&quot;threading&quot;</span><span class="s2">, </span><span class="s5">&quot;loky&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;algorithm&quot;</span><span class="s2">, </span><span class="s1">ALGORITHMS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_knn_forcing_backend</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">):</span>
    <span class="s4"># Non-regression test which ensures the knn methods are properly working</span>
    <span class="s4"># even when forcing the global joblib backend.</span>
    <span class="s0">with </span><span class="s1">joblib</span><span class="s2">.</span><span class="s1">parallel_backend</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">):</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
            <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">30</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">n_redundant</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span>
        <span class="s2">)</span>
        <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span>
            <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s1">algorithm</span><span class="s2">, </span><span class="s1">n_jobs</span><span class="s2">=</span><span class="s3">2</span>
        <span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">kneighbors_graph</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_dtype_convert</span><span class="s2">():</span>
    <span class="s1">classifier </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">CLASSES </span><span class="s2">= </span><span class="s3">15</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">CLASSES</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s1">ch </span><span class="s0">for </span><span class="s1">ch </span><span class="s0">in </span><span class="s5">&quot;ABCDEFGHIJKLMNOPQRSTU&quot;</span><span class="s2">[:</span><span class="s1">CLASSES</span><span class="s2">]]</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">classifier</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sparse_metric_callable</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">sparse_metric</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):  </span><span class="s4"># Metric accepting sparse matrix input (only)</span>
        <span class="s0">assert </span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">and </span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">T</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">().</span><span class="s1">item</span><span class="s2">()</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]  </span><span class="s4"># Population matrix</span>
    <span class="s2">)</span>

    <span class="s1">Y </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])  </span><span class="s4"># Query matrix</span>

    <span class="s1">nn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
        <span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">sparse_metric</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">N </span><span class="s2">= </span><span class="s1">nn</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s4"># GS indices of nearest neighbours in `X` for `sparse_metric`</span>
    <span class="s1">gold_standard_nn </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s1">gold_standard_nn</span><span class="s2">)</span>


<span class="s4"># ignore conversion to boolean in pairwise_distances</span>
<span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">DataConversionWarning</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pairwise_boolean_distance</span><span class="s2">():</span>
    <span class="s4"># Non-regression test for #4523</span>
    <span class="s4"># 'brute': uses scipy.spatial.distance through pairwise_distances</span>
    <span class="s4"># 'ball_tree': uses sklearn.neighbors._dist_metrics</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))</span>
    <span class="s1">NN </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span>

    <span class="s1">nn1 </span><span class="s2">= </span><span class="s1">NN</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;jaccard&quot;</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">nn2 </span><span class="s2">= </span><span class="s1">NN</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;jaccard&quot;</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">nn1</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">nn2</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_predict_proba</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">seed </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">):</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
            <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">50</span><span class="s2">,</span>
            <span class="s1">n_features</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
            <span class="s1">n_informative</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
            <span class="s1">n_redundant</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
            <span class="s1">n_classes</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">X_tr</span><span class="s2">, </span><span class="s1">X_te</span><span class="s2">, </span><span class="s1">y_tr</span><span class="s2">, </span><span class="s1">y_te </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">outlier_label </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s3">2 </span><span class="s2">- </span><span class="s1">seed</span><span class="s2">)</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsClassifier</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">=</span><span class="s1">outlier_label</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">, </span><span class="s1">y_tr</span><span class="s2">)</span>
        <span class="s1">pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_te</span><span class="s2">)</span>
        <span class="s1">proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X_te</span><span class="s2">)</span>
        <span class="s1">proba_label </span><span class="s2">= </span><span class="s1">proba</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">proba_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">proba</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) == </span><span class="s3">0</span><span class="s2">, </span><span class="s1">outlier_label</span><span class="s2">, </span><span class="s1">proba_label</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">pred</span><span class="s2">, </span><span class="s1">proba_label</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pipeline_with_nearest_neighbors_transformer</span><span class="s2">():</span>
    <span class="s4"># Test chaining KNeighborsTransformer and classifiers/regressors</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">40</span><span class="s2">, </span><span class="s3">5</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">X2 </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">40</span><span class="s2">, </span><span class="s3">5</span><span class="s2">) - </span><span class="s3">1</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">40</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s1">n_neighbors </span><span class="s2">= </span><span class="s3">12</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s3">1.5</span>
    <span class="s4"># We precompute more neighbors than necessary, to have equivalence between</span>
    <span class="s4"># k-neighbors estimator after radius-neighbors transformer, and vice-versa.</span>
    <span class="s1">factor </span><span class="s2">= </span><span class="s3">2</span>

    <span class="s1">k_trans </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsTransformer</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">k_trans_factor </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsTransformer</span><span class="s2">(</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">int</span><span class="s2">(</span><span class="s1">n_neighbors </span><span class="s2">* </span><span class="s1">factor</span><span class="s2">), </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span>
    <span class="s2">)</span>

    <span class="s1">r_trans </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsTransformer</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span><span class="s2">)</span>
    <span class="s1">r_trans_factor </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsTransformer</span><span class="s2">(</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">int</span><span class="s2">(</span><span class="s1">radius </span><span class="s2">* </span><span class="s1">factor</span><span class="s2">), </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;distance&quot;</span>
    <span class="s2">)</span>

    <span class="s1">k_reg </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s1">n_neighbors</span><span class="s2">)</span>
    <span class="s1">r_reg </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">RadiusNeighborsRegressor</span><span class="s2">(</span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">)</span>

    <span class="s1">test_list </span><span class="s2">= [</span>
        <span class="s2">(</span><span class="s1">k_trans</span><span class="s2">, </span><span class="s1">k_reg</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">k_trans_factor</span><span class="s2">, </span><span class="s1">r_reg</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">r_trans</span><span class="s2">, </span><span class="s1">r_reg</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">r_trans_factor</span><span class="s2">, </span><span class="s1">k_reg</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">trans</span><span class="s2">, </span><span class="s1">reg </span><span class="s0">in </span><span class="s1">test_list</span><span class="s2">:</span>
        <span class="s4"># compare the chained version and the compact version</span>
        <span class="s1">reg_compact </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">reg</span><span class="s2">)</span>
        <span class="s1">reg_precomp </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">reg</span><span class="s2">)</span>
        <span class="s1">reg_precomp</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">=</span><span class="s5">&quot;precomputed&quot;</span><span class="s2">)</span>

        <span class="s1">reg_chain </span><span class="s2">= </span><span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">clone</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">), </span><span class="s1">reg_precomp</span><span class="s2">)</span>

        <span class="s1">y_pred_chain </span><span class="s2">= </span><span class="s1">reg_chain</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>
        <span class="s1">y_pred_compact </span><span class="s2">= </span><span class="s1">reg_compact</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_pred_chain</span><span class="s2">, </span><span class="s1">y_pred_compact</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, metric, metric_params, expected_algo&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)), </span><span class="s5">&quot;precomputed&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">), </span><span class="s5">&quot;euclidean&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s5">&quot;euclidean&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s5">&quot;euclidean&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;kd_tree&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s5">&quot;seuclidean&quot;</span><span class="s2">, {</span><span class="s5">&quot;V&quot;</span><span class="s2">: [</span><span class="s3">2</span><span class="s2">] * </span><span class="s3">5</span><span class="s2">}, </span><span class="s5">&quot;ball_tree&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s5">&quot;correlation&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;brute&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_auto_algorithm</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_params</span><span class="s2">, </span><span class="s1">expected_algo</span><span class="s2">):</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">4</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_params</span><span class="s2">=</span><span class="s1">metric_params</span>
    <span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_fit_method </span><span class="s2">== </span><span class="s1">expected_algo</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">[</span><span class="s5">&quot;brute&quot;</span><span class="s2">]) - </span><span class="s1">set</span><span class="s2">([</span><span class="s5">&quot;precomputed&quot;</span><span class="s2">]))</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_brute_backend</span><span class="s2">(</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s3">2000</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s3">30</span><span class="s2">,</span>
    <span class="s1">n_query_pts</span><span class="s2">=</span><span class="s3">5</span><span class="s2">,</span>
    <span class="s1">radius</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s4"># Both backends for the 'brute' algorithm of radius_neighbors</span>
    <span class="s4"># must give identical results.</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_query_pts</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s4"># Haversine distance only accepts 2D data</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s5">&quot;haversine&quot;</span><span class="s2">:</span>
        <span class="s1">feature_sl </span><span class="s2">= </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>
        <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">[:, </span><span class="s1">feature_sl</span><span class="s2">])</span>

    <span class="s1">metric_params_list </span><span class="s2">= </span><span class="s1">_generate_test_params_for</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">metric_params </span><span class="s0">in </span><span class="s1">metric_params_list</span><span class="s2">:</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">metric_params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">&quot;p&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

        <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">p</span><span class="s2">=</span><span class="s1">p</span><span class="s2">,</span>
            <span class="s1">metric_params</span><span class="s2">=</span><span class="s1">metric_params</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">enable_cython_pairwise_dist</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
            <span class="s4"># Use the legacy backend for brute</span>
            <span class="s1">legacy_brute_dst</span><span class="s2">, </span><span class="s1">legacy_brute_idx </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span>
                <span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">enable_cython_pairwise_dist</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s4"># Use the pairwise-distances reduction backend for brute</span>
            <span class="s1">pdr_brute_dst</span><span class="s2">, </span><span class="s1">pdr_brute_idx </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span>
                <span class="s1">X_test</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>

        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">legacy_brute_dst</span><span class="s2">,</span>
            <span class="s1">pdr_brute_dst</span><span class="s2">,</span>
            <span class="s1">legacy_brute_idx</span><span class="s2">,</span>
            <span class="s1">pdr_brute_idx</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_valid_metrics_has_no_duplicate</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">VALID_METRICS</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">val</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">val</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_regressor_predict_on_arraylikes</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Ensures that `predict` works for array-likes when `weights` is a callable. 
 
    Non-regression test for #22687. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">_weights</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">KNeighborsRegressor</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">_weights</span><span class="s2">)</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">est</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">]]), [</span><span class="s3">6</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_predict_dataframe</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that KNN predict works with dataframes 
 
    non-regression test for issue #26768 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">]]), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>

    <span class="s1">knn </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">2</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">knn</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nearest_neighbours_works_with_p_less_than_1</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that NearestNeighbors works with :math:`p \\in (0,1)` when `algorithm` 
    is `&quot;auto&quot;` or `&quot;brute&quot;` regardless of the dtype of X. 
 
    Non-regression test for issue #26548 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]])</span>
    <span class="s1">neigh </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">NearestNeighbors</span><span class="s2">(</span>
        <span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">algorithm</span><span class="s2">=</span><span class="s5">&quot;brute&quot;</span><span class="s2">, </span><span class="s1">metric_params</span><span class="s2">={</span><span class="s5">&quot;p&quot;</span><span class="s2">: </span><span class="s3">0.5</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">neigh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">y </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">radius_neighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), </span><span class="s1">radius</span><span class="s2">=</span><span class="s3">4</span><span class="s2">, </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">y </span><span class="s2">= </span><span class="s1">neigh</span><span class="s2">.</span><span class="s1">kneighbors</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">), </span><span class="s1">return_distance</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_KNeighborsClassifier_raise_on_all_zero_weights</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that `predict` and `predict_proba` raises on sample of all zeros weights. 
 
    Related to Issue #25854. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">_weights</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">0 </span><span class="s0">if </span><span class="s1">x </span><span class="s2">&gt; </span><span class="s3">0.5 </span><span class="s0">else </span><span class="s3">1</span><span class="s2">)(</span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">neighbors</span><span class="s2">.</span><span class="s1">KNeighborsClassifier</span><span class="s2">(</span><span class="s1">n_neighbors</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">_weights</span><span class="s2">)</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;All neighbors of some sample is getting zero weights. &quot;</span>
        <span class="s5">&quot;Please modify 'weights' to avoid this case if you are &quot;</span>
        <span class="s5">&quot;using a user-defined function.&quot;</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">]])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">est</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">]])</span>
</pre>
</body>
</html>