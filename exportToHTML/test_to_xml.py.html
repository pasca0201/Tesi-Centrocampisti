<html>
<head>
<title>test_to_xml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_to_xml.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BytesIO</span><span class="s2">,</span>
    <span class="s1">StringIO</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">os</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">NA</span><span class="s2">,</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">common </span><span class="s0">import </span><span class="s1">get_handle</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">xml </span><span class="s0">import </span><span class="s1">read_xml</span>

<span class="s3"># CHECKLIST</span>

<span class="s3"># [x] - ValueError: &quot;Values for parser can only be lxml or etree.&quot;</span>

<span class="s3"># etree</span>
<span class="s3"># [x] - ImportError: &quot;lxml not found, please install or use the etree parser.&quot;</span>
<span class="s3"># [X] - TypeError: &quot;...is not a valid type for attr_cols&quot;</span>
<span class="s3"># [X] - TypeError: &quot;...is not a valid type for elem_cols&quot;</span>
<span class="s3"># [X] - LookupError: &quot;unknown encoding&quot;</span>
<span class="s3"># [X] - KeyError: &quot;...is not included in namespaces&quot;</span>
<span class="s3"># [X] - KeyError: &quot;no valid column&quot;</span>
<span class="s3"># [X] - ValueError: &quot;To use stylesheet, you need lxml installed...&quot;</span>
<span class="s3"># []  - OSError: (NEED PERMISSOIN ISSUE, DISK FULL, ETC.)</span>
<span class="s3"># [X] - FileNotFoundError: &quot;No such file or directory&quot;</span>
<span class="s3"># [X] - PermissionError: &quot;Forbidden&quot;</span>

<span class="s3"># lxml</span>
<span class="s3"># [X] - TypeError: &quot;...is not a valid type for attr_cols&quot;</span>
<span class="s3"># [X] - TypeError: &quot;...is not a valid type for elem_cols&quot;</span>
<span class="s3"># [X] - LookupError: &quot;unknown encoding&quot;</span>
<span class="s3"># []  - OSError: (NEED PERMISSOIN ISSUE, DISK FULL, ETC.)</span>
<span class="s3"># [X] - FileNotFoundError: &quot;No such file or directory&quot;</span>
<span class="s3"># [X] - KeyError: &quot;...is not included in namespaces&quot;</span>
<span class="s3"># [X] - KeyError: &quot;no valid column&quot;</span>
<span class="s3"># [X] - ValueError: &quot;stylesheet is not a url, file, or xml string.&quot;</span>
<span class="s3"># []  - LookupError: (NEED WRONG ENCODING FOR FILE OUTPUT)</span>
<span class="s3"># []  - URLError: (USUALLY DUE TO NETWORKING)</span>
<span class="s3"># []  - HTTPError: (NEED AN ONLINE STYLESHEET)</span>
<span class="s3"># [X] - OSError: &quot;failed to load external entity&quot;</span>
<span class="s3"># [X] - XMLSyntaxError: &quot;Opening and ending tag mismatch&quot;</span>
<span class="s3"># [X] - XSLTApplyError: &quot;Cannot resolve URI&quot;</span>
<span class="s3"># [X] - XSLTParseError: &quot;failed to compile&quot;</span>
<span class="s3"># [X] - PermissionError: &quot;Forbidden&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">geom_df</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;square&quot;</span><span class="s2">, </span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;triangle&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;degrees&quot;</span><span class="s2">: [</span><span class="s5">360</span><span class="s2">, </span><span class="s5">360</span><span class="s2">, </span><span class="s5">180</span><span class="s2">],</span>
            <span class="s4">&quot;sides&quot;</span><span class="s2">: [</span><span class="s5">4</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">planet_df</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;planet&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;Mercury&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Venus&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Earth&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Mars&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Jupiter&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Saturn&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Uranus&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Neptune&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;type&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;terrestrial&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;terrestrial&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;terrestrial&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;terrestrial&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;gas giant&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;gas giant&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;ice giant&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;ice giant&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;location&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;inner&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;inner&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;inner&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;inner&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;outer&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;outer&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;outer&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;outer&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;mass&quot;</span><span class="s2">: [</span>
                <span class="s5">0.330114</span><span class="s2">,</span>
                <span class="s5">4.86747</span><span class="s2">,</span>
                <span class="s5">5.97237</span><span class="s2">,</span>
                <span class="s5">0.641712</span><span class="s2">,</span>
                <span class="s5">1898.187</span><span class="s2">,</span>
                <span class="s5">568.3174</span><span class="s2">,</span>
                <span class="s5">86.8127</span><span class="s2">,</span>
                <span class="s5">102.4126</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">from_file_expected</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;category&gt;cooking&lt;/category&gt; 
    &lt;title&gt;Everyday Italian&lt;/title&gt; 
    &lt;author&gt;Giada De Laurentiis&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;30.0&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;category&gt;children&lt;/category&gt; 
    &lt;title&gt;Harry Potter&lt;/title&gt; 
    &lt;author&gt;J K. Rowling&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;29.99&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;category&gt;web&lt;/category&gt; 
    &lt;title&gt;Learning XML&lt;/title&gt; 
    &lt;author&gt;Erik T. Ray&lt;/author&gt; 
    &lt;year&gt;2003&lt;/year&gt; 
    &lt;price&gt;39.95&lt;/price&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">doc</span><span class="s2">):</span>
    <span class="s3"># etree and lxml differ on quotes and case in xml declaration</span>
    <span class="s0">if </span><span class="s1">doc </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">doc </span><span class="s2">= </span><span class="s1">doc</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span>
            <span class="s4">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?'</span><span class="s2">,</span>
            <span class="s4">&quot;&lt;?xml version='1.0' encoding='utf-8'?&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">doc</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s4">&quot;rb&quot;</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">mode</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)), </span><span class="s4">&quot;etree&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s3"># FILE OUTPUT</span>


<span class="s0">def </span><span class="s1">test_file_output_str_read</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">from_file_expected</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">from_file_expected</span>


<span class="s0">def </span><span class="s1">test_file_output_bytes_read</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">from_file_expected</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">from_file_expected</span>


<span class="s0">def </span><span class="s1">test_str_output</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">from_file_expected</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">from_file_expected</span>


<span class="s0">def </span><span class="s1">test_wrong_file_path</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s4">&quot;/my/fake/path/output.xml&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">OSError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span><span class="s4">r&quot;Cannot save file into a non-existent directory: .*path&quot;</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s3"># INDEX</span>


<span class="s0">def </span><span class="s1">test_index_false</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;category&gt;cooking&lt;/category&gt; 
    &lt;title&gt;Everyday Italian&lt;/title&gt; 
    &lt;author&gt;Giada De Laurentiis&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;30.0&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;category&gt;children&lt;/category&gt; 
    &lt;title&gt;Harry Potter&lt;/title&gt; 
    &lt;author&gt;J K. Rowling&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;29.99&lt;/price&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;category&gt;web&lt;/category&gt; 
    &lt;title&gt;Learning XML&lt;/title&gt; 
    &lt;author&gt;Erik T. Ray&lt;/author&gt; 
    &lt;year&gt;2003&lt;/year&gt; 
    &lt;price&gt;39.95&lt;/price&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_index_false_rename_row_root</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;books&gt; 
  &lt;book&gt; 
    &lt;category&gt;cooking&lt;/category&gt; 
    &lt;title&gt;Everyday Italian&lt;/title&gt; 
    &lt;author&gt;Giada De Laurentiis&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;30.0&lt;/price&gt; 
  &lt;/book&gt; 
  &lt;book&gt; 
    &lt;category&gt;children&lt;/category&gt; 
    &lt;title&gt;Harry Potter&lt;/title&gt; 
    &lt;author&gt;J K. Rowling&lt;/author&gt; 
    &lt;year&gt;2005&lt;/year&gt; 
    &lt;price&gt;29.99&lt;/price&gt; 
  &lt;/book&gt; 
  &lt;book&gt; 
    &lt;category&gt;web&lt;/category&gt; 
    &lt;title&gt;Learning XML&lt;/title&gt; 
    &lt;author&gt;Erik T. Ray&lt;/author&gt; 
    &lt;year&gt;2003&lt;/year&gt; 
    &lt;price&gt;39.95&lt;/price&gt; 
  &lt;/book&gt; 
&lt;/books&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
            <span class="s1">path</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">root_name</span><span class="s2">=</span><span class="s4">&quot;books&quot;</span><span class="s2">, </span><span class="s1">row_name</span><span class="s2">=</span><span class="s4">&quot;book&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">()</span>

        <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;offset_index&quot;</span><span class="s2">, [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">13</span><span class="s2">)), [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">13</span><span class="s2">)]]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_index_false_with_offset_input_index</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">offset_index</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Tests that the output does not contain the `&lt;index&gt;` field when the index of the 
    input Dataframe has an offset. 
 
    This is a regression test for issue #42458. 
    &quot;&quot;&quot;</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">offset_geom_df </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">offset_geom_df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">(</span><span class="s1">offset_index</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">offset_geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># NA_REP</span>

<span class="s1">na_expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_na_elem_output</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">na_expected</span>


<span class="s0">def </span><span class="s1">test_na_empty_str_elem_option</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">na_rep</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">na_expected</span>


<span class="s0">def </span><span class="s1">test_na_empty_elem_option</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;0.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">na_rep</span><span class="s2">=</span><span class="s4">&quot;0.0&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># ATTR_COLS</span>


<span class="s0">def </span><span class="s1">test_attrs_cols_nan_output</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row index=&quot;0&quot; shape=&quot;square&quot; degrees=&quot;360&quot; sides=&quot;4.0&quot;/&gt; 
  &lt;row index=&quot;1&quot; shape=&quot;circle&quot; degrees=&quot;360&quot;/&gt; 
  &lt;row index=&quot;2&quot; shape=&quot;triangle&quot; degrees=&quot;180&quot; sides=&quot;3.0&quot;/&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">attr_cols</span><span class="s2">=[</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">], </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_attrs_cols_prefix</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://example.xom&quot;&gt; 
  &lt;doc:row doc:index=&quot;0&quot; doc:shape=&quot;square&quot; </span><span class="s0">\ 
</span><span class="s4">doc:degrees=&quot;360&quot; doc:sides=&quot;4.0&quot;/&gt; 
  &lt;doc:row doc:index=&quot;1&quot; doc:shape=&quot;circle&quot; </span><span class="s0">\ 
</span><span class="s4">doc:degrees=&quot;360&quot;/&gt; 
  &lt;doc:row doc:index=&quot;2&quot; doc:shape=&quot;triangle&quot; </span><span class="s0">\ 
</span><span class="s4">doc:degrees=&quot;180&quot; doc:sides=&quot;3.0&quot;/&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
        <span class="s1">attr_cols</span><span class="s2">=[</span><span class="s4">&quot;index&quot;</span><span class="s2">, </span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">],</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.xom&quot;</span><span class="s2">},</span>
        <span class="s1">prefix</span><span class="s2">=</span><span class="s4">&quot;doc&quot;</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_attrs_unknown_column</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;no valid column&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">attr_cols</span><span class="s2">=[</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degree&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">], </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_attrs_wrong_type</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;is not a valid type for attr_cols&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">attr_cols</span><span class="s2">=</span><span class="s4">'&quot;shape&quot;, &quot;degree&quot;, &quot;sides&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s3"># ELEM_COLS</span>


<span class="s0">def </span><span class="s1">test_elems_cols_nan_output</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">elems_cols_expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">elem_cols</span><span class="s2">=[</span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">, </span><span class="s4">&quot;shape&quot;</span><span class="s2">], </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">elems_cols_expected</span>


<span class="s0">def </span><span class="s1">test_elems_unknown_column</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;no valid column&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">elem_cols</span><span class="s2">=[</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degree&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">], </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_elems_wrong_type</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;is not a valid type for elem_cols&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">elem_cols</span><span class="s2">=</span><span class="s4">'&quot;shape&quot;, &quot;degree&quot;, &quot;sides&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_elems_and_attrs_cols</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">elems_cols_expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row shape=&quot;square&quot;&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row shape=&quot;circle&quot;&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row shape=&quot;triangle&quot;&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">elem_cols</span><span class="s2">=[</span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">],</span>
        <span class="s1">attr_cols</span><span class="s2">=[</span><span class="s4">&quot;shape&quot;</span><span class="s2">],</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">elems_cols_expected</span>


<span class="s3"># HIERARCHICAL COLUMNS</span>


<span class="s0">def </span><span class="s1">test_hierarchical_columns</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">planet_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;location&gt;inner&lt;/location&gt; 
    &lt;type&gt;terrestrial&lt;/type&gt; 
    &lt;count_mass&gt;4&lt;/count_mass&gt; 
    &lt;sum_mass&gt;11.81&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;2.95&lt;/mean_mass&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;gas giant&lt;/type&gt; 
    &lt;count_mass&gt;2&lt;/count_mass&gt; 
    &lt;sum_mass&gt;2466.5&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;1233.25&lt;/mean_mass&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;ice giant&lt;/type&gt; 
    &lt;count_mass&gt;2&lt;/count_mass&gt; 
    &lt;sum_mass&gt;189.23&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;94.61&lt;/mean_mass&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;All&lt;/location&gt; 
    &lt;type/&gt; 
    &lt;count_mass&gt;8&lt;/count_mass&gt; 
    &lt;sum_mass&gt;2667.54&lt;/sum_mass&gt; 
    &lt;mean_mass&gt;333.44&lt;/mean_mass&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">pvt </span><span class="s2">= </span><span class="s1">planet_df</span><span class="s2">.</span><span class="s1">pivot_table</span><span class="s2">(</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;location&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">],</span>
        <span class="s1">values</span><span class="s2">=</span><span class="s4">&quot;mass&quot;</span><span class="s2">,</span>
        <span class="s1">aggfunc</span><span class="s2">=[</span><span class="s4">&quot;count&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s2">],</span>
        <span class="s1">margins</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">round</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">pvt</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_hierarchical_attrs_columns</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">planet_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row location=&quot;inner&quot; type=&quot;terrestrial&quot; count_mass=&quot;4&quot; </span><span class="s0">\ 
</span><span class="s4">sum_mass=&quot;11.81&quot; mean_mass=&quot;2.95&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;gas giant&quot; count_mass=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s4">sum_mass=&quot;2466.5&quot; mean_mass=&quot;1233.25&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;ice giant&quot; count_mass=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s4">sum_mass=&quot;189.23&quot; mean_mass=&quot;94.61&quot;/&gt; 
  &lt;row location=&quot;All&quot; type=&quot;&quot; count_mass=&quot;8&quot; </span><span class="s0">\ 
</span><span class="s4">sum_mass=&quot;2667.54&quot; mean_mass=&quot;333.44&quot;/&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">pvt </span><span class="s2">= </span><span class="s1">planet_df</span><span class="s2">.</span><span class="s1">pivot_table</span><span class="s2">(</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;location&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">],</span>
        <span class="s1">values</span><span class="s2">=</span><span class="s4">&quot;mass&quot;</span><span class="s2">,</span>
        <span class="s1">aggfunc</span><span class="s2">=[</span><span class="s4">&quot;count&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s2">],</span>
        <span class="s1">margins</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">round</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">pvt</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">attr_cols</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s1">pvt</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">().</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">values</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># MULTIINDEX</span>


<span class="s0">def </span><span class="s1">test_multi_index</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">planet_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;location&gt;inner&lt;/location&gt; 
    &lt;type&gt;terrestrial&lt;/type&gt; 
    &lt;count&gt;4&lt;/count&gt; 
    &lt;sum&gt;11.81&lt;/sum&gt; 
    &lt;mean&gt;2.95&lt;/mean&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;gas giant&lt;/type&gt; 
    &lt;count&gt;2&lt;/count&gt; 
    &lt;sum&gt;2466.5&lt;/sum&gt; 
    &lt;mean&gt;1233.25&lt;/mean&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;location&gt;outer&lt;/location&gt; 
    &lt;type&gt;ice giant&lt;/type&gt; 
    &lt;count&gt;2&lt;/count&gt; 
    &lt;sum&gt;189.23&lt;/sum&gt; 
    &lt;mean&gt;94.61&lt;/mean&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">agg </span><span class="s2">= (</span>
        <span class="s1">planet_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">([</span><span class="s4">&quot;location&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">])[</span><span class="s4">&quot;mass&quot;</span><span class="s2">]</span>
        <span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s4">&quot;count&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s2">])</span>
        <span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">agg</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_multi_index_attrs_cols</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">planet_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row location=&quot;inner&quot; type=&quot;terrestrial&quot; count=&quot;4&quot; </span><span class="s0">\ 
</span><span class="s4">sum=&quot;11.81&quot; mean=&quot;2.95&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;gas giant&quot; count=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s4">sum=&quot;2466.5&quot; mean=&quot;1233.25&quot;/&gt; 
  &lt;row location=&quot;outer&quot; type=&quot;ice giant&quot; count=&quot;2&quot; </span><span class="s0">\ 
</span><span class="s4">sum=&quot;189.23&quot; mean=&quot;94.61&quot;/&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">agg </span><span class="s2">= (</span>
        <span class="s1">planet_df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">([</span><span class="s4">&quot;location&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">])[</span><span class="s4">&quot;mass&quot;</span><span class="s2">]</span>
        <span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s4">&quot;count&quot;</span><span class="s2">, </span><span class="s4">&quot;sum&quot;</span><span class="s2">, </span><span class="s4">&quot;mean&quot;</span><span class="s2">])</span>
        <span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">agg</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">attr_cols</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s1">agg</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">().</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">values</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># NAMESPACE</span>


<span class="s0">def </span><span class="s1">test_default_namespace</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data xmlns=&quot;http://example.com&quot;&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">}, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_unused_namespaces</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data xmlns:oth=&quot;http://other.org&quot; xmlns:ex=&quot;http://example.com&quot;&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;oth&quot;</span><span class="s2">: </span><span class="s4">&quot;http://other.org&quot;</span><span class="s2">, </span><span class="s4">&quot;ex&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># PREFIX</span>


<span class="s0">def </span><span class="s1">test_namespace_prefix</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://example.com&quot;&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;0&lt;/doc:index&gt; 
    &lt;doc:shape&gt;square&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;4.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;1&lt;/doc:index&gt; 
    &lt;doc:shape&gt;circle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides/&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;2&lt;/doc:index&gt; 
    &lt;doc:shape&gt;triangle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;180&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;3.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">}, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s4">&quot;doc&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_in_nmsp</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;doc is not included in namespaces&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
            <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">}, </span><span class="s1">prefix</span><span class="s2">=</span><span class="s4">&quot;doc&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_namespace_prefix_and_default</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://other.org&quot; xmlns=&quot;http://example.com&quot;&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;0&lt;/doc:index&gt; 
    &lt;doc:shape&gt;square&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;4.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;1&lt;/doc:index&gt; 
    &lt;doc:shape&gt;circle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides/&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:index&gt;2&lt;/doc:index&gt; 
    &lt;doc:shape&gt;triangle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;180&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;3.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">, </span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://other.org&quot;</span><span class="s2">},</span>
        <span class="s1">prefix</span><span class="s2">=</span><span class="s4">&quot;doc&quot;</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># ENCODING</span>

<span class="s1">encoding_expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='ISO-8859-1'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;rank&gt;1&lt;/rank&gt; 
    &lt;malename&gt;Jos&lt;/malename&gt; 
    &lt;femalename&gt;Sofa&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;rank&gt;2&lt;/rank&gt; 
    &lt;malename&gt;Luis&lt;/malename&gt; 
    &lt;femalename&gt;Valentina&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;rank&gt;3&lt;/rank&gt; 
    &lt;malename&gt;Carlos&lt;/malename&gt; 
    &lt;femalename&gt;Isabella&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;3&lt;/index&gt; 
    &lt;rank&gt;4&lt;/rank&gt; 
    &lt;malename&gt;Juan&lt;/malename&gt; 
    &lt;femalename&gt;Camila&lt;/femalename&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;4&lt;/index&gt; 
    &lt;rank&gt;5&lt;/rank&gt; 
    &lt;malename&gt;Jorge&lt;/malename&gt; 
    &lt;femalename&gt;Valeria&lt;/femalename&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_encoding_option_str</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">).</span><span class="s1">head</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s3"># etree and lxml differ on quotes and case in xml declaration</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span>
            <span class="s4">'&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?'</span><span class="s2">,</span>
            <span class="s4">&quot;&lt;?xml version='1.0' encoding='ISO-8859-1'?&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">encoding_expected</span>


<span class="s0">def </span><span class="s1">test_correct_encoding_file</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;encoding&quot;</span><span class="s2">, [</span><span class="s4">&quot;UTF-8&quot;</span><span class="s2">, </span><span class="s4">&quot;UTF-16&quot;</span><span class="s2">, </span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_wrong_encoding_option_lxml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df_file</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s1">encoding</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_misspelled_encoding</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LookupError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;unknown encoding&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;uft-8&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s3"># PRETTY PRINT</span>


<span class="s0">def </span><span class="s1">test_xml_declaration_pretty_print</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">xml_declaration</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_no_pretty_print_with_decl</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s4">&quot;&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><span class="s0">\n</span><span class="s4">&quot;</span>
        <span class="s4">&quot;&lt;data&gt;&lt;row&gt;&lt;index&gt;0&lt;/index&gt;&lt;shape&gt;square&lt;/shape&gt;&quot;</span>
        <span class="s4">&quot;&lt;degrees&gt;360&lt;/degrees&gt;&lt;sides&gt;4.0&lt;/sides&gt;&lt;/row&gt;&lt;row&gt;&quot;</span>
        <span class="s4">&quot;&lt;index&gt;1&lt;/index&gt;&lt;shape&gt;circle&lt;/shape&gt;&lt;degrees&gt;360&quot;</span>
        <span class="s4">&quot;&lt;/degrees&gt;&lt;sides/&gt;&lt;/row&gt;&lt;row&gt;&lt;index&gt;2&lt;/index&gt;&lt;shape&gt;&quot;</span>
        <span class="s4">&quot;triangle&lt;/shape&gt;&lt;degrees&gt;180&lt;/degrees&gt;&lt;sides&gt;3.0&lt;/sides&gt;&quot;</span>
        <span class="s4">&quot;&lt;/row&gt;&lt;/data&gt;&quot;</span>
    <span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">pretty_print</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s3"># etree adds space for closed tags</span>
    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot; /&gt;&quot;</span><span class="s2">, </span><span class="s4">&quot;/&gt;&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_no_pretty_print_no_decl</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">expected </span><span class="s2">= (</span>
        <span class="s4">&quot;&lt;data&gt;&lt;row&gt;&lt;index&gt;0&lt;/index&gt;&lt;shape&gt;square&lt;/shape&gt;&quot;</span>
        <span class="s4">&quot;&lt;degrees&gt;360&lt;/degrees&gt;&lt;sides&gt;4.0&lt;/sides&gt;&lt;/row&gt;&lt;row&gt;&quot;</span>
        <span class="s4">&quot;&lt;index&gt;1&lt;/index&gt;&lt;shape&gt;circle&lt;/shape&gt;&lt;degrees&gt;360&quot;</span>
        <span class="s4">&quot;&lt;/degrees&gt;&lt;sides/&gt;&lt;/row&gt;&lt;row&gt;&lt;index&gt;2&lt;/index&gt;&lt;shape&gt;&quot;</span>
        <span class="s4">&quot;triangle&lt;/shape&gt;&lt;degrees&gt;180&lt;/degrees&gt;&lt;sides&gt;3.0&lt;/sides&gt;&quot;</span>
        <span class="s4">&quot;&lt;/row&gt;&lt;/data&gt;&quot;</span>
    <span class="s2">)</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">xml_declaration</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">pretty_print</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s3"># etree adds space for closed tags</span>
    <span class="s0">if </span><span class="s1">output </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot; /&gt;&quot;</span><span class="s2">, </span><span class="s4">&quot;/&gt;&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s3"># PARSER</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_installed</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_default_parser_no_lxml</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;lxml not found, please install or use the etree parser.&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_unknown_parser</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Values for parser can only be lxml or etree.&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;bs4&quot;</span><span class="s2">)</span>


<span class="s3"># STYLESHEET</span>

<span class="s1">xsl_expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;field field=&quot;index&quot;&gt;0&lt;/field&gt; 
    &lt;field field=&quot;shape&quot;&gt;square&lt;/field&gt; 
    &lt;field field=&quot;degrees&quot;&gt;360&lt;/field&gt; 
    &lt;field field=&quot;sides&quot;&gt;4.0&lt;/field&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;field field=&quot;index&quot;&gt;1&lt;/field&gt; 
    &lt;field field=&quot;shape&quot;&gt;circle&lt;/field&gt; 
    &lt;field field=&quot;degrees&quot;&gt;360&lt;/field&gt; 
    &lt;field field=&quot;sides&quot;/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;field field=&quot;index&quot;&gt;2&lt;/field&gt; 
    &lt;field field=&quot;shape&quot;&gt;triangle&lt;/field&gt; 
    &lt;field field=&quot;degrees&quot;&gt;180&lt;/field&gt; 
    &lt;field field=&quot;sides&quot;&gt;3.0&lt;/field&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_stylesheet_file_like</span><span class="s2">(</span><span class="s1">xsl_row_field_output</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span>
        <span class="s1">xsl_row_field_output</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">f</span><span class="s2">) == </span><span class="s1">xsl_expected</span>


<span class="s0">def </span><span class="s1">test_stylesheet_io</span><span class="s2">(</span><span class="s1">xsl_row_field_output</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s3"># note: By default the bodies of untyped functions are not checked,</span>
    <span class="s3"># consider using --check-untyped-defs</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xsl_obj</span><span class="s2">: </span><span class="s1">BytesIO </span><span class="s2">| </span><span class="s1">StringIO  </span><span class="s3"># type: ignore[annotation-unchecked]</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span>
        <span class="s1">xsl_row_field_output</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;rb&quot;</span><span class="s2">:</span>
            <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_obj</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">xsl_expected</span>


<span class="s0">def </span><span class="s1">test_stylesheet_buffered_reader</span><span class="s2">(</span><span class="s1">xsl_row_field_output</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span>
        <span class="s1">xsl_row_field_output</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_obj</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">output </span><span class="s2">== </span><span class="s1">xsl_expected</span>


<span class="s0">def </span><span class="s1">test_stylesheet_wrong_path</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;xml&quot;</span><span class="s2">, </span><span class="s4">&quot;row_field_output.xslt&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XMLSyntaxError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Start tag expected, '&lt;' not found&quot;</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;val&quot;</span><span class="s2">, [</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s7">b&quot;&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_empty_string_stylesheet</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;|&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s4">&quot;Document is empty&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;Start tag expected, '&lt;' not found&quot;</span><span class="s2">,</span>
            <span class="s3"># Seen on Mac with lxml 4.9.1</span>
            <span class="s4">r&quot;None \(line 0\)&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XMLSyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">val</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_incorrect_xsl_syntax</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; &gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node()&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:apply-templates select=&quot;@*|node()&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row/*&quot;&gt; 
        &lt;field&gt; 
            &lt;xsl:attribute name=&quot;field&quot;&gt; 
                &lt;xsl:value-of select=&quot;name()&quot;/&gt; 
            &lt;/xsl:attribute&gt; 
            &lt;xsl:value-of select=&quot;text()&quot;/&gt; 
        &lt;/field&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XMLSyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Opening and ending tag mismatch&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_incorrect_xsl_eval</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node(*)&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:apply-templates select=&quot;@*|node()&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row/*&quot;&gt; 
        &lt;field&gt; 
            &lt;xsl:attribute name=&quot;field&quot;&gt; 
                &lt;xsl:value-of select=&quot;name()&quot;/&gt; 
            &lt;/xsl:attribute&gt; 
            &lt;xsl:value-of select=&quot;text()&quot;/&gt; 
        &lt;/field&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XSLTParseError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;failed to compile&quot;</span><span class="s2">)):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_incorrect_xsl_apply</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node()&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:copy-of select=&quot;document('non_existent.xml')/*&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XSLTApplyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Cannot resolve URI&quot;</span><span class="s2">)):</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s4">&quot;test.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_stylesheet_with_etree</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node(*)&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:apply-templates select=&quot;@*|node()&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;To use stylesheet, you need lxml installed&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_style_to_csv</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;text&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:param name=&quot;delim&quot;&gt;,&lt;/xsl:param&gt; 
    &lt;xsl:template match=&quot;/data&quot;&gt; 
        &lt;xsl:text&gt;,shape,degrees,sides&amp;#xa;&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;row&quot;/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row&quot;&gt; 
        &lt;xsl:value-of select=&quot;concat(index, $delim, shape, $delim, 
                                     degrees, $delim, sides)&quot;/&gt; 
         &lt;xsl:text&gt;&amp;#xa;&lt;/xsl:text&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">out_csv </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_csv</span><span class="s2">(</span><span class="s1">lineterminator</span><span class="s2">=</span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">out_csv </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">out_csv </span><span class="s2">= </span><span class="s1">out_csv</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
    <span class="s1">out_xml </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">out_csv </span><span class="s2">== </span><span class="s1">out_xml</span>


<span class="s0">def </span><span class="s1">test_style_to_string</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;text&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:param name=&quot;delim&quot;&gt;&lt;xsl:text&gt;               &lt;/xsl:text&gt;&lt;/xsl:param&gt; 
    &lt;xsl:template match=&quot;/data&quot;&gt; 
        &lt;xsl:text&gt;      shape  degrees  sides&amp;#xa;&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;row&quot;/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;row&quot;&gt; 
        &lt;xsl:value-of select=&quot;concat(index, ' ', 
                                     substring($delim, 1, string-length('triangle') 
                                               - string-length(shape) + 1), 
                                     shape, 
                                     substring($delim, 1, string-length(name(degrees)) 
                                               - string-length(degrees) + 2), 
                                     degrees, 
                                     substring($delim, 1, string-length(name(sides)) 
                                               - string-length(sides) + 2), 
                                     sides)&quot;/&gt; 
         &lt;xsl:text&gt;&amp;#xa;&lt;/xsl:text&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">out_str </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_string</span><span class="s2">()</span>
    <span class="s1">out_xml </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">na_rep</span><span class="s2">=</span><span class="s4">&quot;NaN&quot;</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">out_xml </span><span class="s2">== </span><span class="s1">out_str</span>


<span class="s0">def </span><span class="s1">test_style_to_json</span><span class="s2">(</span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;text&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:param name=&quot;quot&quot;&gt;&quot;&lt;/xsl:param&gt; 
 
    &lt;xsl:template match=&quot;/data&quot;&gt; 
        &lt;xsl:text&gt;{&quot;shape&quot;:{&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;descendant::row/shape&quot;/&gt; 
        &lt;xsl:text&gt;},&quot;degrees&quot;:{&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;descendant::row/degrees&quot;/&gt; 
        &lt;xsl:text&gt;},&quot;sides&quot;:{&lt;/xsl:text&gt; 
        &lt;xsl:apply-templates select=&quot;descendant::row/sides&quot;/&gt; 
        &lt;xsl:text&gt;}}&lt;/xsl:text&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;shape|degrees|sides&quot;&gt; 
        &lt;xsl:variable name=&quot;val&quot;&gt; 
            &lt;xsl:if test = &quot;.=''&quot;&gt; 
                &lt;xsl:value-of select=&quot;'null'&quot;/&gt; 
            &lt;/xsl:if&gt; 
            &lt;xsl:if test = &quot;number(text()) = text()&quot;&gt; 
                &lt;xsl:value-of select=&quot;text()&quot;/&gt; 
            &lt;/xsl:if&gt; 
            &lt;xsl:if test = &quot;number(text()) != text()&quot;&gt; 
                &lt;xsl:value-of select=&quot;concat($quot, text(), $quot)&quot;/&gt; 
            &lt;/xsl:if&gt; 
        &lt;/xsl:variable&gt; 
        &lt;xsl:value-of select=&quot;concat($quot, preceding-sibling::index, 
                                     $quot,':', $val)&quot;/&gt; 
        &lt;xsl:if test=&quot;preceding-sibling::index != //row[last()]/index&quot;&gt; 
            &lt;xsl:text&gt;,&lt;/xsl:text&gt; 
        &lt;/xsl:if&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">out_json </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_json</span><span class="s2">()</span>
    <span class="s1">out_xml </span><span class="s2">= </span><span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">out_json </span><span class="s2">== </span><span class="s1">out_xml</span>


<span class="s3"># COMPRESSION</span>


<span class="s1">geom_xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;1&lt;/index&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;index&gt;2&lt;/index&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_compression_output</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression_only</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">get_handle</span><span class="s2">(</span>
            <span class="s1">path</span><span class="s2">,</span>
            <span class="s4">&quot;r&quot;</span><span class="s2">,</span>
            <span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">,</span>
        <span class="s2">) </span><span class="s0">as </span><span class="s1">handle_obj</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">handle_obj</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">geom_xml </span><span class="s2">== </span><span class="s1">output</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_filename_and_suffix_comp</span><span class="s2">(</span>
    <span class="s1">parser</span><span class="s2">, </span><span class="s1">compression_only</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">, </span><span class="s1">compression_to_extension</span>
<span class="s2">):</span>
    <span class="s1">compfile </span><span class="s2">= </span><span class="s4">&quot;xml.&quot; </span><span class="s2">+ </span><span class="s1">compression_to_extension</span><span class="s2">[</span><span class="s1">compression_only</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">=</span><span class="s1">compfile</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">get_handle</span><span class="s2">(</span>
            <span class="s1">path</span><span class="s2">,</span>
            <span class="s4">&quot;r&quot;</span><span class="s2">,</span>
            <span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">,</span>
        <span class="s2">) </span><span class="s0">as </span><span class="s1">handle_obj</span><span class="s2">:</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">handle_obj</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s1">output </span><span class="s2">= </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">geom_xml </span><span class="s2">== </span><span class="s1">output</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_ea_dtypes</span><span class="s2">(</span><span class="s1">any_numeric_ea_dtype</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s3"># GH#43903</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data&gt; 
  &lt;row&gt; 
    &lt;index&gt;0&lt;/index&gt; 
    &lt;a/&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s1">NA</span><span class="s2">]}).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">any_numeric_ea_dtype</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">equalize_decl</span><span class="s2">(</span><span class="s1">result</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">() == </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_unsuported_compression</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unrecognized compression type&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s4">&quot;7z&quot;</span><span class="s2">)</span>


<span class="s3"># STORAGE OPTIONS</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>
<span class="s0">def </span><span class="s1">test_s3_permission_output</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">s3_public_bucket</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">):</span>
    <span class="s1">s3fs </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;s3fs&quot;</span><span class="s2">)</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">external_error_raised</span><span class="s2">((</span><span class="s1">PermissionError</span><span class="s2">, </span><span class="s1">FileNotFoundError</span><span class="s2">)):</span>
        <span class="s1">fs </span><span class="s2">= </span><span class="s1">s3fs</span><span class="s2">.</span><span class="s1">S3FileSystem</span><span class="s2">(</span><span class="s1">anon</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fs</span><span class="s2">.</span><span class="s1">ls</span><span class="s2">(</span><span class="s1">s3_public_bucket</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
            <span class="s4">f&quot;s3://</span><span class="s0">{</span><span class="s1">s3_public_bucket</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}</span><span class="s4">/geom.xml&quot;</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s4">&quot;zip&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
</pre>
</body>
</html>