<html>
<head>
<title>test_xml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_xml.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BytesIO</span><span class="s2">,</span>
    <span class="s1">StringIO</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">lzma </span><span class="s0">import </span><span class="s1">LZMAError</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">tarfile </span><span class="s0">import </span><span class="s1">ReadError</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">error </span><span class="s0">import </span><span class="s1">HTTPError</span>
<span class="s0">from </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree </span><span class="s0">import </span><span class="s1">ParseError</span>
<span class="s0">from </span><span class="s1">zipfile </span><span class="s0">import </span><span class="s1">BadZipFile</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">compat</span><span class="s2">.</span><span class="s1">_optional </span><span class="s0">import </span><span class="s1">import_optional_dependency</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">EmptyDataError</span><span class="s2">,</span>
    <span class="s1">ParserError</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">NA</span><span class="s2">,</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">arrays </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ArrowStringArray</span><span class="s2">,</span>
    <span class="s1">StringArray</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">arrays</span><span class="s2">.</span><span class="s1">string_arrow </span><span class="s0">import </span><span class="s1">ArrowStringArrayNumpySemantics</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">common </span><span class="s0">import </span><span class="s1">get_handle</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">xml </span><span class="s0">import </span><span class="s1">read_xml</span>

<span class="s3"># CHECK LIST</span>

<span class="s3"># [x] - ValueError: &quot;Values for parser can only be lxml or etree.&quot;</span>

<span class="s3"># etree</span>
<span class="s3"># [X] - ImportError: &quot;lxml not found, please install or use the etree parser.&quot;</span>
<span class="s3"># [X] - TypeError: &quot;expected str, bytes or os.PathLike object, not NoneType&quot;</span>
<span class="s3"># [X] - ValueError: &quot;Either element or attributes can be parsed not both.&quot;</span>
<span class="s3"># [X] - ValueError: &quot;xpath does not return any nodes...&quot;</span>
<span class="s3"># [X] - SyntaxError: &quot;You have used an incorrect or unsupported XPath&quot;</span>
<span class="s3"># [X] - ValueError: &quot;names does not match length of child elements in xpath.&quot;</span>
<span class="s3"># [X] - TypeError: &quot;...is not a valid type for names&quot;</span>
<span class="s3"># [X] - ValueError: &quot;To use stylesheet, you need lxml installed...&quot;</span>
<span class="s3"># []  - URLError: (GENERAL ERROR WITH HTTPError AS SUBCLASS)</span>
<span class="s3"># [X] - HTTPError: &quot;HTTP Error 404: Not Found&quot;</span>
<span class="s3"># []  - OSError: (GENERAL ERROR WITH FileNotFoundError AS SUBCLASS)</span>
<span class="s3"># [X] - FileNotFoundError: &quot;No such file or directory&quot;</span>
<span class="s3"># []  - ParseError    (FAILSAFE CATCH ALL FOR VERY COMPLEX XML)</span>
<span class="s3"># [X] - UnicodeDecodeError: &quot;'utf-8' codec can't decode byte 0xe9...&quot;</span>
<span class="s3"># [X] - UnicodeError: &quot;UTF-16 stream does not start with BOM&quot;</span>
<span class="s3"># [X] - BadZipFile: &quot;File is not a zip file&quot;</span>
<span class="s3"># [X] - OSError: &quot;Invalid data stream&quot;</span>
<span class="s3"># [X] - LZMAError: &quot;Input format not supported by decoder&quot;</span>
<span class="s3"># [X] - ValueError: &quot;Unrecognized compression type&quot;</span>
<span class="s3"># [X] - PermissionError: &quot;Forbidden&quot;</span>

<span class="s3"># lxml</span>
<span class="s3"># [X] - ValueError: &quot;Either element or attributes can be parsed not both.&quot;</span>
<span class="s3"># [X] - AttributeError: &quot;__enter__&quot;</span>
<span class="s3"># [X] - XSLTApplyError: &quot;Cannot resolve URI&quot;</span>
<span class="s3"># [X] - XSLTParseError: &quot;document is not a stylesheet&quot;</span>
<span class="s3"># [X] - ValueError: &quot;xpath does not return any nodes.&quot;</span>
<span class="s3"># [X] - XPathEvalError: &quot;Invalid expression&quot;</span>
<span class="s3"># []  - XPathSyntaxError: (OLD VERSION IN lxml FOR XPATH ERRORS)</span>
<span class="s3"># [X] - TypeError: &quot;empty namespace prefix is not supported in XPath&quot;</span>
<span class="s3"># [X] - ValueError: &quot;names does not match length of child elements in xpath.&quot;</span>
<span class="s3"># [X] - TypeError: &quot;...is not a valid type for names&quot;</span>
<span class="s3"># [X] - LookupError: &quot;unknown encoding&quot;</span>
<span class="s3"># []  - URLError: (USUALLY DUE TO NETWORKING)</span>
<span class="s3"># [X  - HTTPError: &quot;HTTP Error 404: Not Found&quot;</span>
<span class="s3"># [X] - OSError: &quot;failed to load external entity&quot;</span>
<span class="s3"># [X] - XMLSyntaxError: &quot;Start tag expected, '&lt;' not found&quot;</span>
<span class="s3"># []  - ParserError: (FAILSAFE CATCH ALL FOR VERY COMPLEX XML</span>
<span class="s3"># [X] - ValueError: &quot;Values for parser can only be lxml or etree.&quot;</span>
<span class="s3"># [X] - UnicodeDecodeError: &quot;'utf-8' codec can't decode byte 0xe9...&quot;</span>
<span class="s3"># [X] - UnicodeError: &quot;UTF-16 stream does not start with BOM&quot;</span>
<span class="s3"># [X] - BadZipFile: &quot;File is not a zip file&quot;</span>
<span class="s3"># [X] - OSError: &quot;Invalid data stream&quot;</span>
<span class="s3"># [X] - LZMAError: &quot;Input format not supported by decoder&quot;</span>
<span class="s3"># [X] - ValueError: &quot;Unrecognized compression type&quot;</span>
<span class="s3"># [X] - PermissionError: &quot;Forbidden&quot;</span>

<span class="s1">geom_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
    <span class="s2">{</span>
        <span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;square&quot;</span><span class="s2">, </span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;triangle&quot;</span><span class="s2">],</span>
        <span class="s4">&quot;degrees&quot;</span><span class="s2">: [</span><span class="s5">360</span><span class="s2">, </span><span class="s5">360</span><span class="s2">, </span><span class="s5">180</span><span class="s2">],</span>
        <span class="s4">&quot;sides&quot;</span><span class="s2">: [</span><span class="s5">4</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
    <span class="s2">}</span>
<span class="s2">)</span>

<span class="s1">xml_default_nmsp </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data xmlns=&quot;http://example.com&quot;&gt; 
  &lt;row&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides&gt;4&lt;/sides&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;360&lt;/degrees&gt; 
    &lt;sides/&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;180&lt;/degrees&gt; 
    &lt;sides&gt;3&lt;/sides&gt; 
  &lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

<span class="s1">xml_prefix_nmsp </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;doc:data xmlns:doc=&quot;http://example.com&quot;&gt; 
  &lt;doc:row&gt; 
    &lt;doc:shape&gt;square&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;4.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:shape&gt;circle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;360&lt;/doc:degrees&gt; 
    &lt;doc:sides/&gt; 
  &lt;/doc:row&gt; 
  &lt;doc:row&gt; 
    &lt;doc:shape&gt;triangle&lt;/doc:shape&gt; 
    &lt;doc:degrees&gt;180&lt;/doc:degrees&gt; 
    &lt;doc:sides&gt;3.0&lt;/doc:sides&gt; 
  &lt;/doc:row&gt; 
&lt;/doc:data&gt;&quot;&quot;&quot;</span>


<span class="s1">df_kml </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
    <span class="s2">{</span>
        <span class="s4">&quot;id&quot;</span><span class="s2">: {</span>
            <span class="s5">0</span><span class="s2">: </span><span class="s4">&quot;ID_00001&quot;</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s2">: </span><span class="s4">&quot;ID_00002&quot;</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s2">: </span><span class="s4">&quot;ID_00003&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">: </span><span class="s4">&quot;ID_00004&quot;</span><span class="s2">,</span>
            <span class="s5">4</span><span class="s2">: </span><span class="s4">&quot;ID_00005&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s4">&quot;name&quot;</span><span class="s2">: {</span>
            <span class="s5">0</span><span class="s2">: </span><span class="s4">&quot;Blue Line (Forest Park)&quot;</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s2">: </span><span class="s4">&quot;Red, Purple Line&quot;</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s2">: </span><span class="s4">&quot;Red, Purple Line&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">: </span><span class="s4">&quot;Red, Purple Line&quot;</span><span class="s2">,</span>
            <span class="s5">4</span><span class="s2">: </span><span class="s4">&quot;Red, Purple Line&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s4">&quot;styleUrl&quot;</span><span class="s2">: {</span>
            <span class="s5">0</span><span class="s2">: </span><span class="s4">&quot;#LineStyle01&quot;</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s2">: </span><span class="s4">&quot;#LineStyle01&quot;</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s2">: </span><span class="s4">&quot;#LineStyle01&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">: </span><span class="s4">&quot;#LineStyle01&quot;</span><span class="s2">,</span>
            <span class="s5">4</span><span class="s2">: </span><span class="s4">&quot;#LineStyle01&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s4">&quot;extrude&quot;</span><span class="s2">: {</span><span class="s5">0</span><span class="s2">: </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">: </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">: </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">: </span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">: </span><span class="s5">0</span><span class="s2">},</span>
        <span class="s4">&quot;altitudeMode&quot;</span><span class="s2">: {</span>
            <span class="s5">0</span><span class="s2">: </span><span class="s4">&quot;clampedToGround&quot;</span><span class="s2">,</span>
            <span class="s5">1</span><span class="s2">: </span><span class="s4">&quot;clampedToGround&quot;</span><span class="s2">,</span>
            <span class="s5">2</span><span class="s2">: </span><span class="s4">&quot;clampedToGround&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">: </span><span class="s4">&quot;clampedToGround&quot;</span><span class="s2">,</span>
            <span class="s5">4</span><span class="s2">: </span><span class="s4">&quot;clampedToGround&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s4">&quot;coordinates&quot;</span><span class="s2">: {</span>
            <span class="s5">0</span><span class="s2">: (</span>
                <span class="s4">&quot;-87.77678526964958,41.8708863930319,0 &quot;</span>
                <span class="s4">&quot;-87.77826234150609,41.87097820122218,0 &quot;</span>
                <span class="s4">&quot;-87.78251583439344,41.87130129991005,0 &quot;</span>
                <span class="s4">&quot;-87.78418294588424,41.87145055520308,0 &quot;</span>
                <span class="s4">&quot;-87.7872369165933,41.8717239119163,0 &quot;</span>
                <span class="s4">&quot;-87.79160214925886,41.87210797280065,0&quot;</span>
            <span class="s2">),</span>
            <span class="s5">1</span><span class="s2">: (</span>
                <span class="s4">&quot;-87.65758750947528,41.96427269188822,0 &quot;</span>
                <span class="s4">&quot;-87.65802133507393,41.96581929055245,0 &quot;</span>
                <span class="s4">&quot;-87.65819033925305,41.96621846093642,0 &quot;</span>
                <span class="s4">&quot;-87.6583189819129,41.96650362897086,0 &quot;</span>
                <span class="s4">&quot;-87.65835858701473,41.96669002089185,0 &quot;</span>
                <span class="s4">&quot;-87.65838428411853,41.96688150295095,0 &quot;</span>
                <span class="s4">&quot;-87.65842208882658,41.96745896091846,0 &quot;</span>
                <span class="s4">&quot;-87.65846556843937,41.9683761425439,0 &quot;</span>
                <span class="s4">&quot;-87.65849296214573,41.96913893870342,0&quot;</span>
            <span class="s2">),</span>
            <span class="s5">2</span><span class="s2">: (</span>
                <span class="s4">&quot;-87.65492939166126,41.95377494531437,0 &quot;</span>
                <span class="s4">&quot;-87.65557043199591,41.95376544118533,0 &quot;</span>
                <span class="s4">&quot;-87.65606302030132,41.95376391658746,0 &quot;</span>
                <span class="s4">&quot;-87.65623502146268,41.95377379126367,0 &quot;</span>
                <span class="s4">&quot;-87.65634748981634,41.95380103566435,0 &quot;</span>
                <span class="s4">&quot;-87.65646537904269,41.95387703994676,0 &quot;</span>
                <span class="s4">&quot;-87.65656532461145,41.95396622645799,0 &quot;</span>
                <span class="s4">&quot;-87.65664760856414,41.95404201996044,0 &quot;</span>
                <span class="s4">&quot;-87.65671750555913,41.95416647054043,0 &quot;</span>
                <span class="s4">&quot;-87.65673983607117,41.95429949810849,0 &quot;</span>
                <span class="s4">&quot;-87.65673866475777,41.95441024240925,0 &quot;</span>
                <span class="s4">&quot;-87.6567690255541,41.95490657227902,0 &quot;</span>
                <span class="s4">&quot;-87.65683672482363,41.95692259283837,0 &quot;</span>
                <span class="s4">&quot;-87.6568900886376,41.95861070983142,0 &quot;</span>
                <span class="s4">&quot;-87.65699865558875,41.96181418669004,0 &quot;</span>
                <span class="s4">&quot;-87.65756347177603,41.96397045777844,0 &quot;</span>
                <span class="s4">&quot;-87.65758750947528,41.96427269188822,0&quot;</span>
            <span class="s2">),</span>
            <span class="s5">3</span><span class="s2">: (</span>
                <span class="s4">&quot;-87.65362593118043,41.94742799535678,0 &quot;</span>
                <span class="s4">&quot;-87.65363554415794,41.94819886386848,0 &quot;</span>
                <span class="s4">&quot;-87.6536456393239,41.95059994675451,0 &quot;</span>
                <span class="s4">&quot;-87.65365831235026,41.95108288489359,0 &quot;</span>
                <span class="s4">&quot;-87.6536604873874,41.9519954657554,0 &quot;</span>
                <span class="s4">&quot;-87.65362592053201,41.95245597302328,0 &quot;</span>
                <span class="s4">&quot;-87.65367158496069,41.95311153649393,0 &quot;</span>
                <span class="s4">&quot;-87.65368468595476,41.9533202828916,0 &quot;</span>
                <span class="s4">&quot;-87.65369271253692,41.95343095587119,0 &quot;</span>
                <span class="s4">&quot;-87.65373335834569,41.95351536301472,0 &quot;</span>
                <span class="s4">&quot;-87.65378605844126,41.95358212680591,0 &quot;</span>
                <span class="s4">&quot;-87.65385067928185,41.95364452823767,0 &quot;</span>
                <span class="s4">&quot;-87.6539390793817,41.95370263886964,0 &quot;</span>
                <span class="s4">&quot;-87.6540786298351,41.95373403675265,0 &quot;</span>
                <span class="s4">&quot;-87.65430648647626,41.9537535411832,0 &quot;</span>
                <span class="s4">&quot;-87.65492939166126,41.95377494531437,0&quot;</span>
            <span class="s2">),</span>
            <span class="s5">4</span><span class="s2">: (</span>
                <span class="s4">&quot;-87.65345391792157,41.94217681262115,0 &quot;</span>
                <span class="s4">&quot;-87.65342448305786,41.94237224420864,0 &quot;</span>
                <span class="s4">&quot;-87.65339745703922,41.94268217746244,0 &quot;</span>
                <span class="s4">&quot;-87.65337753982941,41.94288140770284,0 &quot;</span>
                <span class="s4">&quot;-87.65336256753105,41.94317369618263,0 &quot;</span>
                <span class="s4">&quot;-87.65338799707138,41.94357253961736,0 &quot;</span>
                <span class="s4">&quot;-87.65340240886648,41.94389158188269,0 &quot;</span>
                <span class="s4">&quot;-87.65341837392448,41.94406444407721,0 &quot;</span>
                <span class="s4">&quot;-87.65342275247338,41.94421065714904,0 &quot;</span>
                <span class="s4">&quot;-87.65347469646018,41.94434829382345,0 &quot;</span>
                <span class="s4">&quot;-87.65351486483024,41.94447699917548,0 &quot;</span>
                <span class="s4">&quot;-87.65353483605053,41.9453896864472,0 &quot;</span>
                <span class="s4">&quot;-87.65361975532807,41.94689193720703,0 &quot;</span>
                <span class="s4">&quot;-87.65362593118043,41.94742799535678,0&quot;</span>
            <span class="s2">),</span>
        <span class="s2">},</span>
    <span class="s2">}</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_literal_xml_deprecation</span><span class="s2">():</span>
    <span class="s3"># GH 53809</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Passing literal xml to 'read_xml' is deprecated and &quot;</span>
        <span class="s4">&quot;will be removed in a future version. To read from a &quot;</span>
        <span class="s4">&quot;literal string, wrap it in a 'StringIO' object.&quot;</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s4">&quot;rb&quot;</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">mode</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)), </span><span class="s4">&quot;etree&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s0">def </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">read_xml_iterparse_comp</span><span class="s2">(</span><span class="s1">comp_path</span><span class="s2">, </span><span class="s1">compression_only</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">get_handle</span><span class="s2">(</span><span class="s1">comp_path</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">) </span><span class="s0">as </span><span class="s1">handles</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
                <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">handles</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
            <span class="s0">return </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s3"># FILE / URL</span>


<span class="s0">def </span><span class="s1">test_parser_consistency_file</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_file_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_file_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>

    <span class="s1">df_iter_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>
    <span class="s1">df_iter_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file_lxml</span><span class="s2">, </span><span class="s1">df_file_etree</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file_lxml</span><span class="s2">, </span><span class="s1">df_iter_lxml</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter_lxml</span><span class="s2">, </span><span class="s1">df_iter_etree</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">network</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>
<span class="s0">def </span><span class="s1">test_parser_consistency_url</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">httpserver</span><span class="s2">):</span>
    <span class="s1">httpserver</span><span class="s2">.</span><span class="s1">serve_content</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">xml_default_nmsp</span><span class="s2">)</span>

    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">()),</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_iter</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_like</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_io</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s1">df_io </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">) </span><span class="s0">else </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">)),</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_io</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_buffered_reader_string</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;rb&quot;</span><span class="s2">:</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">())</span>
    <span class="s0">elif </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot;</span><span class="s2">:</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">)</span>

    <span class="s1">df_str </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_str</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_buffered_reader_no_xml_declaration</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;rb&quot;</span><span class="s2">:</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">())</span>
    <span class="s0">elif </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot;</span><span class="s2">:</span>
        <span class="s1">xml_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">)</span>

    <span class="s1">df_str </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_obj</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_str</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_string_charset</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">txt </span><span class="s2">= </span><span class="s4">&quot;&lt;中文標籤&gt;&lt;row&gt;&lt;c1&gt;1&lt;/c1&gt;&lt;c2&gt;2&lt;/c2&gt;&lt;/row&gt;&lt;/中文標籤&gt;&quot;</span>

    <span class="s1">df_str </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">txt</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;c1&quot;</span><span class="s2">: </span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;c2&quot;</span><span class="s2">: </span><span class="s5">2</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">])</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_str</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_charset</span><span class="s2">(</span><span class="s1">xml_doc_ch_utf</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_doc_ch_utf</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;問&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;問  若箇是邪而言破邪 何者是正而道(Sorry, this is Big5 only)申正&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;問 既破有得申無得 亦應但破性執申假名以不&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;問 既破性申假 亦應但破有申無 若有無兩洗 亦應性假雙破耶&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;答&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s4">&quot;答  邪既無量 正亦多途  大略為言不出二種 謂&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;有得與無得 有得是邪須破 無得是正須申</span><span class="s0">\n\t\t</span><span class="s4">故&quot;</span><span class="s2">,</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
                <span class="s0">None</span><span class="s2">,</span>
                <span class="s4">&quot;答  不例  有無皆是性 所以須雙破 既分性假異 故有破不破&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;a&quot;</span><span class="s2">: [</span>
                <span class="s0">None</span><span class="s2">,</span>
                <span class="s4">&quot;答 性執是有得 假名是無得  今破有得申無得 即是破性執申假名也&quot;</span><span class="s2">,</span>
                <span class="s0">None</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_handle_close</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s0">assert not </span><span class="s1">f</span><span class="s2">.</span><span class="s1">closed</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;val&quot;</span><span class="s2">, [</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s6">b&quot;&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_empty_string_lxml</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;|&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s4">&quot;Document is empty&quot;</span><span class="s2">,</span>
            <span class="s3"># Seen on Mac with lxml 4.91</span>
            <span class="s4">r&quot;None \(line 0\)&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XMLSyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">val</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">val</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;val&quot;</span><span class="s2">, [</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s6">b&quot;&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_empty_string_etree</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ParseError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;no element found&quot;</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">val</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">val</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_file_path</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Passing literal xml to 'read_xml' is deprecated and &quot;</span>
        <span class="s4">&quot;will be removed in a future version. To read from a &quot;</span>
        <span class="s4">&quot;literal string, wrap it in a 'StringIO' object.&quot;</span>
    <span class="s2">)</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;html&quot;</span><span class="s2">, </span><span class="s4">&quot;books.xml&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">FutureWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">network</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>
<span class="s0">def </span><span class="s1">test_url</span><span class="s2">(</span><span class="s1">httpserver</span><span class="s2">, </span><span class="s1">xml_file</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_file</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">httpserver</span><span class="s2">.</span><span class="s1">serve_content</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s1">df_url </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">httpserver</span><span class="s2">.</span><span class="s1">url</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//book[count(*)=4]&quot;</span><span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_url</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">network</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>
<span class="s0">def </span><span class="s1">test_wrong_url</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">httpserver</span><span class="s2">):</span>
    <span class="s1">httpserver</span><span class="s2">.</span><span class="s1">serve_content</span><span class="s2">(</span><span class="s4">&quot;NOT FOUND&quot;</span><span class="s2">, </span><span class="s1">code</span><span class="s2">=</span><span class="s5">404</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">HTTPError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;HTTP Error 404: NOT FOUND&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">httpserver</span><span class="s2">.</span><span class="s1">url</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//book[count(*)=4]&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s3"># CONTENT</span>


<span class="s0">def </span><span class="s1">test_whitespace</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
      &lt;data&gt; 
        &lt;row sides=&quot; 4 &quot;&gt; 
          &lt;shape&gt; 
              square 
          &lt;/shape&gt; 
          &lt;degrees&gt;&amp;#009;360&amp;#009;&lt;/degrees&gt; 
        &lt;/row&gt; 
        &lt;row sides=&quot; 0 &quot;&gt; 
          &lt;shape&gt; 
              circle 
          &lt;/shape&gt; 
          &lt;degrees&gt;&amp;#009;360&amp;#009;&lt;/degrees&gt; 
        &lt;/row&gt; 
        &lt;row sides=&quot; 3 &quot;&gt; 
          &lt;shape&gt; 
              triangle 
          &lt;/shape&gt; 
          &lt;degrees&gt;&amp;#009;180&amp;#009;&lt;/degrees&gt; 
        &lt;/row&gt; 
      &lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string&quot;</span><span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;sides&quot;</span><span class="s2">, </span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">]},</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;sides&quot;</span><span class="s2">: [</span><span class="s4">&quot; 4 &quot;</span><span class="s2">, </span><span class="s4">&quot; 0 &quot;</span><span class="s2">, </span><span class="s4">&quot; 3 &quot;</span><span class="s2">],</span>
            <span class="s4">&quot;shape&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;</span><span class="s0">\n              </span><span class="s4">square</span><span class="s0">\n          </span><span class="s4">&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;</span><span class="s0">\n              </span><span class="s4">circle</span><span class="s0">\n          </span><span class="s4">&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;</span><span class="s0">\n              </span><span class="s4">triangle</span><span class="s0">\n          </span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;degrees&quot;</span><span class="s2">: [</span><span class="s4">&quot;</span><span class="s0">\t</span><span class="s4">360</span><span class="s0">\t</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s4">&quot;</span><span class="s0">\t</span><span class="s4">360</span><span class="s0">\t</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s4">&quot;</span><span class="s0">\t</span><span class="s4">180</span><span class="s0">\t</span><span class="s4">&quot;</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s3"># XPATH</span>


<span class="s0">def </span><span class="s1">test_empty_xpath_lxml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;xpath does not return any nodes&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//python&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bad_xpath_etree</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;You have used an incorrect or unsupported XPath&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//[book]&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bad_xpath_lxml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XPathEvalError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Invalid expression&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//[book]&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>


<span class="s3"># NAMESPACE</span>


<span class="s0">def </span><span class="s1">test_default_namespace</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_nmsp </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//ns:row&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;ns&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml_default_nmsp</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;square&quot;</span><span class="s2">, </span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;triangle&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;degrees&quot;</span><span class="s2">: [</span><span class="s5">360</span><span class="s2">, </span><span class="s5">360</span><span class="s2">, </span><span class="s5">180</span><span class="s2">],</span>
            <span class="s4">&quot;sides&quot;</span><span class="s2">: [</span><span class="s5">4.0</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s4">&quot;nan&quot;</span><span class="s2">), </span><span class="s5">3.0</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_nmsp</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_prefix_namespace</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_nmsp </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_prefix_nmsp</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//doc:row&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml_prefix_nmsp</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;square&quot;</span><span class="s2">, </span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;triangle&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;degrees&quot;</span><span class="s2">: [</span><span class="s5">360</span><span class="s2">, </span><span class="s5">360</span><span class="s2">, </span><span class="s5">180</span><span class="s2">],</span>
            <span class="s4">&quot;sides&quot;</span><span class="s2">: [</span><span class="s5">4.0</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s4">&quot;nan&quot;</span><span class="s2">), </span><span class="s5">3.0</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_nmsp</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_consistency_default_namespace</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//ns:row&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;ns&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//doc:row&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_lxml</span><span class="s2">, </span><span class="s1">df_etree</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_consistency_prefix_namespace</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_prefix_nmsp</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//doc:row&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_prefix_nmsp</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//doc:row&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;doc&quot;</span><span class="s2">: </span><span class="s4">&quot;http://example.com&quot;</span><span class="s2">},</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_lxml</span><span class="s2">, </span><span class="s1">df_etree</span><span class="s2">)</span>


<span class="s3"># PREFIX</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_with_default_namespace</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;xpath does not return any nodes&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//Placemark&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_definition_etree</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;you used an undeclared namespace prefix&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//kml:Placemark&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_missing_prefix_definition_lxml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XPathEvalError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Undefined namespace prefix&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//kml:Placemark&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;key&quot;</span><span class="s2">, [</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_none_namespace_prefix</span><span class="s2">(</span><span class="s1">key</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;empty namespace prefix is not supported in XPath&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span>
            <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml_default_nmsp</span><span class="s2">),</span>
            <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//kml:Placemark&quot;</span><span class="s2">,</span>
            <span class="s1">namespaces</span><span class="s2">={</span><span class="s1">key</span><span class="s2">: </span><span class="s4">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s2">},</span>
            <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s3"># ELEMS AND ATTRS</span>


<span class="s0">def </span><span class="s1">test_file_elems_and_attrs</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>
    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_only_attrs</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">attrs_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">]})</span>
    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">]})</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_only_elems</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">elems_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>
    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_elem_and_attrs_only</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Either element or attributes can be parsed not both&quot;</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">elems_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">attrs_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_empty_attrs_only</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
      &lt;data&gt; 
        &lt;row&gt; 
          &lt;shape sides=&quot;4&quot;&gt;square&lt;/shape&gt; 
          &lt;degrees&gt;360&lt;/degrees&gt; 
        &lt;/row&gt; 
        &lt;row&gt; 
          &lt;shape sides=&quot;0&quot;&gt;circle&lt;/shape&gt; 
          &lt;degrees&gt;360&lt;/degrees&gt; 
        &lt;/row&gt; 
        &lt;row&gt; 
          &lt;shape sides=&quot;3&quot;&gt;triangle&lt;/shape&gt; 
          &lt;degrees&gt;180&lt;/degrees&gt; 
        &lt;/row&gt; 
      &lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;xpath does not return any nodes or attributes&quot;</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;./row&quot;</span><span class="s2">, </span><span class="s1">attrs_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_empty_elems_only</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
      &lt;data&gt; 
        &lt;row sides=&quot;4&quot; shape=&quot;square&quot; degrees=&quot;360&quot;/&gt; 
        &lt;row sides=&quot;0&quot; shape=&quot;circle&quot; degrees=&quot;360&quot;/&gt; 
        &lt;row sides=&quot;3&quot; shape=&quot;triangle&quot; degrees=&quot;180&quot;/&gt; 
      &lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;xpath does not return any nodes or attributes&quot;</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;./row&quot;</span><span class="s2">, </span><span class="s1">elems_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_attribute_centric_xml</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;TrainSchedule&gt; 
      &lt;Stations&gt; 
         &lt;station Name=&quot;Manhattan&quot; coords=&quot;31,460,195,498&quot;/&gt; 
         &lt;station Name=&quot;Laraway Road&quot; coords=&quot;63,409,194,455&quot;/&gt; 
         &lt;station Name=&quot;179th St (Orland Park)&quot; coords=&quot;0,364,110,395&quot;/&gt; 
         &lt;station Name=&quot;153rd St (Orland Park)&quot; coords=&quot;7,333,113,362&quot;/&gt; 
         &lt;station Name=&quot;143rd St (Orland Park)&quot; coords=&quot;17,297,115,330&quot;/&gt; 
         &lt;station Name=&quot;Palos Park&quot; coords=&quot;128,281,239,303&quot;/&gt; 
         &lt;station Name=&quot;Palos Heights&quot; coords=&quot;148,257,283,279&quot;/&gt; 
         &lt;station Name=&quot;Worth&quot; coords=&quot;170,230,248,255&quot;/&gt; 
         &lt;station Name=&quot;Chicago Ridge&quot; coords=&quot;70,187,208,214&quot;/&gt; 
         &lt;station Name=&quot;Oak Lawn&quot; coords=&quot;166,159,266,185&quot;/&gt; 
         &lt;station Name=&quot;Ashburn&quot; coords=&quot;197,133,336,157&quot;/&gt; 
         &lt;station Name=&quot;Wrightwood&quot; coords=&quot;219,106,340,133&quot;/&gt; 
         &lt;station Name=&quot;Chicago Union Sta&quot; coords=&quot;220,0,360,43&quot;/&gt; 
      &lt;/Stations&gt; 
&lt;/TrainSchedule&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//station&quot;</span><span class="s2">)</span>
    <span class="s1">df_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//station&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">)</span>

    <span class="s1">df_iter_lx </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;station&quot;</span><span class="s2">: [</span><span class="s4">&quot;Name&quot;</span><span class="s2">, </span><span class="s4">&quot;coords&quot;</span><span class="s2">]})</span>
    <span class="s1">df_iter_et </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;station&quot;</span><span class="s2">: [</span><span class="s4">&quot;Name&quot;</span><span class="s2">, </span><span class="s4">&quot;coords&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_lxml</span><span class="s2">, </span><span class="s1">df_etree</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter_lx</span><span class="s2">, </span><span class="s1">df_iter_et</span><span class="s2">)</span>


<span class="s3"># NAMES</span>


<span class="s0">def </span><span class="s1">test_names_option_output</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">df_file </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;Col1&quot;</span><span class="s2">, </span><span class="s4">&quot;Col2&quot;</span><span class="s2">, </span><span class="s4">&quot;Col3&quot;</span><span class="s2">, </span><span class="s4">&quot;Col4&quot;</span><span class="s2">, </span><span class="s4">&quot;Col5&quot;</span><span class="s2">], </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
    <span class="s2">)</span>
    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;Col1&quot;</span><span class="s2">, </span><span class="s4">&quot;Col2&quot;</span><span class="s2">, </span><span class="s4">&quot;Col3&quot;</span><span class="s2">, </span><span class="s4">&quot;Col4&quot;</span><span class="s2">, </span><span class="s4">&quot;Col5&quot;</span><span class="s2">],</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;Col1&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;Col2&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;Col3&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;Col4&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;Col5&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_file</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_repeat_names</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;shapes&gt; 
  &lt;shape type=&quot;2D&quot;&gt; 
    &lt;name&gt;circle&lt;/name&gt; 
    &lt;type&gt;curved&lt;/type&gt; 
  &lt;/shape&gt; 
  &lt;shape type=&quot;3D&quot;&gt; 
    &lt;name&gt;sphere&lt;/name&gt; 
    &lt;type&gt;curved&lt;/type&gt; 
  &lt;/shape&gt; 
&lt;/shapes&gt;&quot;&quot;&quot;</span>
    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//shape&quot;</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;type_dim&quot;</span><span class="s2">, </span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;type_edge&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;type&quot;</span><span class="s2">, </span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">]},</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;type_dim&quot;</span><span class="s2">, </span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;type_edge&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;type_dim&quot;</span><span class="s2">: [</span><span class="s4">&quot;2D&quot;</span><span class="s2">, </span><span class="s4">&quot;3D&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;sphere&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;type_edge&quot;</span><span class="s2">: [</span><span class="s4">&quot;curved&quot;</span><span class="s2">, </span><span class="s4">&quot;curved&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_repeat_values_new_names</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;shapes&gt; 
  &lt;shape&gt; 
    &lt;name&gt;rectangle&lt;/name&gt; 
    &lt;family&gt;rectangle&lt;/family&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;name&gt;square&lt;/name&gt; 
    &lt;family&gt;rectangle&lt;/family&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;name&gt;ellipse&lt;/name&gt; 
    &lt;family&gt;ellipse&lt;/family&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;name&gt;circle&lt;/name&gt; 
    &lt;family&gt;ellipse&lt;/family&gt; 
  &lt;/shape&gt; 
&lt;/shapes&gt;&quot;&quot;&quot;</span>
    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//shape&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;group&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;family&quot;</span><span class="s2">]},</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;group&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s2">: [</span><span class="s4">&quot;rectangle&quot;</span><span class="s2">, </span><span class="s4">&quot;square&quot;</span><span class="s2">, </span><span class="s4">&quot;ellipse&quot;</span><span class="s2">, </span><span class="s4">&quot;circle&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;group&quot;</span><span class="s2">: [</span><span class="s4">&quot;rectangle&quot;</span><span class="s2">, </span><span class="s4">&quot;rectangle&quot;</span><span class="s2">, </span><span class="s4">&quot;ellipse&quot;</span><span class="s2">, </span><span class="s4">&quot;ellipse&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_repeat_elements</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;shapes&gt; 
  &lt;shape&gt; 
    &lt;value item=&quot;name&quot;&gt;circle&lt;/value&gt; 
    &lt;value item=&quot;family&quot;&gt;ellipse&lt;/value&gt; 
    &lt;value item=&quot;degrees&quot;&gt;360&lt;/value&gt; 
    &lt;value item=&quot;sides&quot;&gt;0&lt;/value&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;value item=&quot;name&quot;&gt;triangle&lt;/value&gt; 
    &lt;value item=&quot;family&quot;&gt;polygon&lt;/value&gt; 
    &lt;value item=&quot;degrees&quot;&gt;180&lt;/value&gt; 
    &lt;value item=&quot;sides&quot;&gt;3&lt;/value&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;value item=&quot;name&quot;&gt;square&lt;/value&gt; 
    &lt;value item=&quot;family&quot;&gt;polygon&lt;/value&gt; 
    &lt;value item=&quot;degrees&quot;&gt;360&lt;/value&gt; 
    &lt;value item=&quot;sides&quot;&gt;4&lt;/value&gt; 
  &lt;/shape&gt; 
&lt;/shapes&gt;&quot;&quot;&quot;</span>
    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//shape&quot;</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;family&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]},</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;family&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s2">: [</span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;triangle&quot;</span><span class="s2">, </span><span class="s4">&quot;square&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;family&quot;</span><span class="s2">: [</span><span class="s4">&quot;ellipse&quot;</span><span class="s2">, </span><span class="s4">&quot;polygon&quot;</span><span class="s2">, </span><span class="s4">&quot;polygon&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;degrees&quot;</span><span class="s2">: [</span><span class="s5">360</span><span class="s2">, </span><span class="s5">180</span><span class="s2">, </span><span class="s5">360</span><span class="s2">],</span>
            <span class="s4">&quot;sides&quot;</span><span class="s2">: [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_names_option_wrong_length</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;names does not match length&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;Col1&quot;</span><span class="s2">, </span><span class="s4">&quot;Col2&quot;</span><span class="s2">, </span><span class="s4">&quot;Col3&quot;</span><span class="s2">], </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_names_option_wrong_type</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;is not a valid type for names&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=</span><span class="s4">&quot;Col1, Col2, Col3&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s3"># ENCODING</span>


<span class="s0">def </span><span class="s1">test_wrong_encoding</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UnicodeDecodeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;'utf-8' codec can't decode&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_utf16_encoding</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">UnicodeError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span>
            <span class="s4">&quot;UTF-16 stream does not start with BOM|&quot;</span>
            <span class="s4">&quot;'utf-16(-le)?' codec can't decode byte&quot;</span>
        <span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;UTF-16&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_unknown_encoding</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LookupError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;unknown encoding: UFT-8&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;UFT-8&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ascii_encoding</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UnicodeDecodeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;'ascii' codec can't decode byte&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ascii&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_parser_consistency_with_encoding</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_xpath_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">)</span>
    <span class="s1">df_xpath_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_baby_names</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;iso-8859-1&quot;</span><span class="s2">)</span>

    <span class="s1">df_iter_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_baby_names</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">,</span>
        <span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;rank&quot;</span><span class="s2">, </span><span class="s4">&quot;malename&quot;</span><span class="s2">, </span><span class="s4">&quot;femalename&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>
    <span class="s1">df_iter_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">xml_baby_names</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">,</span>
        <span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ISO-8859-1&quot;</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;rank&quot;</span><span class="s2">, </span><span class="s4">&quot;malename&quot;</span><span class="s2">, </span><span class="s4">&quot;femalename&quot;</span><span class="s2">]},</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath_lxml</span><span class="s2">, </span><span class="s1">df_xpath_etree</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath_etree</span><span class="s2">, </span><span class="s1">df_iter_etree</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter_lxml</span><span class="s2">, </span><span class="s1">df_iter_etree</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_encoding_for_lxml</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s3"># GH#45133</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;&lt;data&gt; 
  &lt;row&gt; 
    &lt;a&gt;c&lt;/a&gt; 
  &lt;/row&gt; 
&lt;/data&gt; 
&quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;encoding None&quot;</span><span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_none_encoding_etree</span><span class="s2">():</span>
    <span class="s3"># GH#45133</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;&lt;data&gt; 
  &lt;row&gt; 
    &lt;a&gt;c&lt;/a&gt; 
  &lt;/row&gt; 
&lt;/data&gt; 
&quot;&quot;&quot;</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;c&quot;</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s3"># PARSER</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_installed</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_default_parser_no_lxml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;lxml not found, please install or use the etree parser.&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_parser</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Values for parser can only be lxml or etree.&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;bs4&quot;</span><span class="s2">)</span>


<span class="s3"># STYLESHEET</span>


<span class="s0">def </span><span class="s1">test_stylesheet_file</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xsl_flatten_doc</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">df_style </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">kml_cta_rail_lines</span><span class="s2">,</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//k:Placemark&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;k&quot;</span><span class="s2">: </span><span class="s4">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s2">},</span>
        <span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_flatten_doc</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">kml_cta_rail_lines</span><span class="s2">,</span>
        <span class="s1">iterparse</span><span class="s2">={</span>
            <span class="s4">&quot;Placemark&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;id&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;name&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;styleUrl&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;extrude&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;altitudeMode&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;coordinates&quot;</span><span class="s2">,</span>
            <span class="s2">]</span>
        <span class="s2">},</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_kml</span><span class="s2">, </span><span class="s1">df_style</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_kml</span><span class="s2">, </span><span class="s1">df_iter</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_stylesheet_file_like</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">df_style </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
            <span class="s1">kml_cta_rail_lines</span><span class="s2">,</span>
            <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//k:Placemark&quot;</span><span class="s2">,</span>
            <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;k&quot;</span><span class="s2">: </span><span class="s4">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s2">},</span>
            <span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">f</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_kml</span><span class="s2">, </span><span class="s1">df_style</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_stylesheet_io</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s3"># note: By default the bodies of untyped functions are not checked,</span>
    <span class="s3"># consider using --check-untyped-defs</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xsl_obj</span><span class="s2">: </span><span class="s1">BytesIO </span><span class="s2">| </span><span class="s1">StringIO  </span><span class="s3"># type: ignore[annotation-unchecked]</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;rb&quot;</span><span class="s2">:</span>
            <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>

    <span class="s1">df_style </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">kml_cta_rail_lines</span><span class="s2">,</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//k:Placemark&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;k&quot;</span><span class="s2">: </span><span class="s4">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s2">},</span>
        <span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_obj</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_kml</span><span class="s2">, </span><span class="s1">df_style</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_stylesheet_buffered_reader</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s1">df_style </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">kml_cta_rail_lines</span><span class="s2">,</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//k:Placemark&quot;</span><span class="s2">,</span>
        <span class="s1">namespaces</span><span class="s2">={</span><span class="s4">&quot;k&quot;</span><span class="s2">: </span><span class="s4">&quot;http://www.opengis.net/kml/2.2&quot;</span><span class="s2">},</span>
        <span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_obj</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_kml</span><span class="s2">, </span><span class="s1">df_style</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_style_charset</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&lt;中文標籤&gt;&lt;row&gt;&lt;c1&gt;1&lt;/c1&gt;&lt;c2&gt;2&lt;/c2&gt;&lt;/row&gt;&lt;/中文標籤&gt;&quot;</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
 &lt;xsl:output omit-xml-declaration=&quot;yes&quot; indent=&quot;yes&quot;/&gt; 
 &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
 &lt;xsl:template match=&quot;node()|@*&quot;&gt; 
     &lt;xsl:copy&gt; 
       &lt;xsl:apply-templates select=&quot;node()|@*&quot;/&gt; 
     &lt;/xsl:copy&gt; 
 &lt;/xsl:template&gt; 
 
 &lt;xsl:template match=&quot;中文標籤&quot;&gt; 
     &lt;根&gt; 
       &lt;xsl:apply-templates /&gt; 
     &lt;/根&gt; 
 &lt;/xsl:template&gt; 
 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">))</span>
    <span class="s1">df_style </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_orig</span><span class="s2">, </span><span class="s1">df_style</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_not_stylesheet</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xml_books</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XSLTParseError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;document is not a stylesheet&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xml_books</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_incorrect_xsl_syntax</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; 
                              xmlns:k=&quot;http://www.opengis.net/kml/2.2&quot;/&gt; 
    &lt;xsl:output method=&quot;xml&quot; omit-xml-declaration=&quot;yes&quot; 
                cdata-section-elements=&quot;k:description&quot; indent=&quot;yes&quot;/&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;node()|@*&quot;&gt; 
     &lt;xsl:copy&gt; 
       &lt;xsl:apply-templates select=&quot;node()|@*&quot;/&gt; 
     &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:MultiGeometry|k:LineString&quot;&gt; 
        &lt;xsl:apply-templates select='*'/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:description|k:Snippet|k:Style&quot;/&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XMLSyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Extra content at the end of the document&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_incorrect_xsl_eval</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; 
                              xmlns:k=&quot;http://www.opengis.net/kml/2.2&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; omit-xml-declaration=&quot;yes&quot; 
                cdata-section-elements=&quot;k:description&quot; indent=&quot;yes&quot;/&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;node(*)|@*&quot;&gt; 
     &lt;xsl:copy&gt; 
       &lt;xsl:apply-templates select=&quot;node()|@*&quot;/&gt; 
     &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:MultiGeometry|k:LineString&quot;&gt; 
        &lt;xsl:apply-templates select='*'/&gt; 
    &lt;/xsl:template&gt; 
 
    &lt;xsl:template match=&quot;k:description|k:Snippet|k:Style&quot;/&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XSLTParseError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;failed to compile&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_incorrect_xsl_apply</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">):</span>
    <span class="s1">lxml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
    &lt;xsl:output method=&quot;xml&quot; encoding=&quot;utf-8&quot; indent=&quot;yes&quot; /&gt; 
    &lt;xsl:strip-space elements=&quot;*&quot;/&gt; 
 
    &lt;xsl:template match=&quot;@*|node()&quot;&gt; 
        &lt;xsl:copy&gt; 
            &lt;xsl:copy-of select=&quot;document('non_existent.xml')/*&quot;/&gt; 
        &lt;/xsl:copy&gt; 
    &lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt;&quot;&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">lxml_etree</span><span class="s2">.</span><span class="s1">XSLTApplyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Cannot resolve URI&quot;</span><span class="s2">)):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_stylesheet</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xml_data_path</span><span class="s2">):</span>
    <span class="s1">xml_etree </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml.etree&quot;</span><span class="s2">)</span>

    <span class="s1">xsl </span><span class="s2">= </span><span class="s1">xml_data_path </span><span class="s2">/ </span><span class="s4">&quot;flatten.xsl&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">xml_etree</span><span class="s2">.</span><span class="s1">XMLSyntaxError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;Start tag expected, '&lt;' not found&quot;</span><span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_stylesheet_file_close</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s3"># note: By default the bodies of untyped functions are not checked,</span>
    <span class="s3"># consider using --check-untyped-defs</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xsl_obj</span><span class="s2">: </span><span class="s1">BytesIO </span><span class="s2">| </span><span class="s1">StringIO  </span><span class="s3"># type: ignore[annotation-unchecked]</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xsl_flatten_doc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;rb&quot;</span><span class="s2">:</span>
            <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">xsl_obj </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>

        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_obj</span><span class="s2">)</span>

        <span class="s0">assert not </span><span class="s1">f</span><span class="s2">.</span><span class="s1">closed</span>


<span class="s0">def </span><span class="s1">test_stylesheet_with_etree</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">xsl_flatten_doc</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;To use stylesheet, you need lxml installed&quot;</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml_cta_rail_lines</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl_flatten_doc</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;val&quot;</span><span class="s2">, [</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s6">b&quot;&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_empty_stylesheet</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Passing literal xml to 'read_xml' is deprecated and &quot;</span>
        <span class="s4">&quot;will be removed in a future version. To read from a &quot;</span>
        <span class="s4">&quot;literal string, wrap it in a 'StringIO' object.&quot;</span>
    <span class="s2">)</span>
    <span class="s1">kml </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;xml&quot;</span><span class="s2">, </span><span class="s4">&quot;cta_rail_lines.kml&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">kml</span><span class="s2">, </span><span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">val</span><span class="s2">)</span>


<span class="s3"># ITERPARSE</span>
<span class="s0">def </span><span class="s1">test_file_like_iterparse</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">and </span><span class="s1">parser </span><span class="s2">== </span><span class="s4">&quot;lxml&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;reading file objects must return bytes objects&quot;</span><span class="s2">)</span>
            <span class="s2">):</span>
                <span class="s1">read_xml</span><span class="s2">(</span>
                    <span class="s1">f</span><span class="s2">,</span>
                    <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                    <span class="s1">iterparse</span><span class="s2">={</span>
                        <span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]</span>
                    <span class="s2">},</span>
                <span class="s2">)</span>
            <span class="s0">return None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">df_filelike </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
                <span class="s1">f</span><span class="s2">,</span>
                <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]},</span>
            <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_filelike</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_file_io_iterparse</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">):</span>
    <span class="s1">funcIO </span><span class="s2">= </span><span class="s1">StringIO </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else </span><span class="s1">BytesIO</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span>
        <span class="s1">xml_books</span><span class="s2">,</span>
        <span class="s1">mode</span><span class="s2">,</span>
        <span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot; </span><span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">else None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">funcIO</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()) </span><span class="s0">as </span><span class="s1">b</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s4">&quot;r&quot; </span><span class="s0">and </span><span class="s1">parser </span><span class="s2">== </span><span class="s4">&quot;lxml&quot;</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                    <span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;reading file objects must return bytes objects&quot;</span><span class="s2">)</span>
                <span class="s2">):</span>
                    <span class="s1">read_xml</span><span class="s2">(</span>
                        <span class="s1">b</span><span class="s2">,</span>
                        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                        <span class="s1">iterparse</span><span class="s2">={</span>
                            <span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]</span>
                        <span class="s2">},</span>
                    <span class="s2">)</span>
                <span class="s0">return None</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">df_fileio </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
                    <span class="s1">b</span><span class="s2">,</span>
                    <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                    <span class="s1">iterparse</span><span class="s2">={</span>
                        <span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">]</span>
                    <span class="s2">},</span>
                <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;category&quot;</span><span class="s2">: [</span><span class="s4">&quot;cooking&quot;</span><span class="s2">, </span><span class="s4">&quot;children&quot;</span><span class="s2">, </span><span class="s4">&quot;web&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Everyday Italian&quot;</span><span class="s2">, </span><span class="s4">&quot;Harry Potter&quot;</span><span class="s2">, </span><span class="s4">&quot;Learning XML&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;author&quot;</span><span class="s2">: [</span><span class="s4">&quot;Giada De Laurentiis&quot;</span><span class="s2">, </span><span class="s4">&quot;J K. Rowling&quot;</span><span class="s2">, </span><span class="s4">&quot;Erik T. Ray&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2005</span><span class="s2">, </span><span class="s5">2003</span><span class="s2">],</span>
            <span class="s4">&quot;price&quot;</span><span class="s2">: [</span><span class="s5">30.00</span><span class="s2">, </span><span class="s5">29.99</span><span class="s2">, </span><span class="s5">39.95</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_fileio</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">network</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>
<span class="s0">def </span><span class="s1">test_url_path_error</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">httpserver</span><span class="s2">, </span><span class="s1">xml_file</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">xml_file</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">httpserver</span><span class="s2">.</span><span class="s1">serve_content</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ParserError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;iterparse is designed for large XML files&quot;</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">read_xml</span><span class="s2">(</span>
                <span class="s1">httpserver</span><span class="s2">.</span><span class="s1">url</span><span class="s2">,</span>
                <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">, </span><span class="s4">&quot;date&quot;</span><span class="s2">]},</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_compression_error</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression_only</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">=</span><span class="s4">&quot;geom_xml.zip&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ParserError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">&quot;iterparse is designed for large XML files&quot;</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">read_xml</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">,</span>
                <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">, </span><span class="s4">&quot;date&quot;</span><span class="s2">]},</span>
                <span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">,</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_dict_type</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;list is not a valid type for iterparse&quot;</span><span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span>
            <span class="s1">xml_books</span><span class="s2">,</span>
            <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
            <span class="s1">iterparse</span><span class="s2">=[</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s4">&quot;author&quot;</span><span class="s2">, </span><span class="s4">&quot;price&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_dict_value</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;&lt;class 'str'&gt; is not a valid type for value in iterparse&quot;</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: </span><span class="s4">&quot;category&quot;</span><span class="s2">})</span>


<span class="s0">def </span><span class="s1">test_bad_xml</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">bad_xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version='1.0' encoding='utf-8'?&gt; 
  &lt;row&gt; 
    &lt;shape&gt;square&lt;/shape&gt; 
    &lt;degrees&gt;00360&lt;/degrees&gt; 
    &lt;sides&gt;4.0&lt;/sides&gt; 
    &lt;date&gt;2020-01-01&lt;/date&gt; 
   &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;circle&lt;/shape&gt; 
    &lt;degrees&gt;00360&lt;/degrees&gt; 
    &lt;sides/&gt; 
    &lt;date&gt;2021-01-01&lt;/date&gt; 
  &lt;/row&gt; 
  &lt;row&gt; 
    &lt;shape&gt;triangle&lt;/shape&gt; 
    &lt;degrees&gt;00180&lt;/degrees&gt; 
    &lt;sides&gt;3.0&lt;/sides&gt; 
    &lt;date&gt;2022-01-01&lt;/date&gt; 
  &lt;/row&gt; 
&quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">=</span><span class="s4">&quot;bad.xml&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">bad_xml</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">SyntaxError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=(</span>
                <span class="s4">&quot;Extra content at the end of the document|&quot;</span>
                <span class="s4">&quot;junk after document element&quot;</span>
            <span class="s2">),</span>
        <span class="s2">):</span>
            <span class="s1">read_xml</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">,</span>
                <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                <span class="s1">parse_dates</span><span class="s2">=[</span><span class="s4">&quot;date&quot;</span><span class="s2">],</span>
                <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">, </span><span class="s4">&quot;date&quot;</span><span class="s2">]},</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_comment</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;!-- comment before root --&gt; 
&lt;shapes&gt; 
  &lt;!-- comment within root --&gt; 
  &lt;shape&gt; 
    &lt;name&gt;circle&lt;/name&gt; 
    &lt;type&gt;2D&lt;/type&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;name&gt;sphere&lt;/name&gt; 
    &lt;type&gt;3D&lt;/type&gt; 
    &lt;!-- comment within child --&gt; 
  &lt;/shape&gt; 
  &lt;!-- comment within root --&gt; 
&lt;/shapes&gt; 
&lt;!-- comment after root --&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//shape&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s2">: [</span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;sphere&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;type&quot;</span><span class="s2">: [</span><span class="s4">&quot;2D&quot;</span><span class="s2">, </span><span class="s4">&quot;3D&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_dtd</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;!DOCTYPE non-profits [ 
    &lt;!ELEMENT shapes (shape*) &gt; 
    &lt;!ELEMENT shape ( name, type )&gt; 
    &lt;!ELEMENT name (#PCDATA)&gt; 
]&gt; 
&lt;shapes&gt; 
  &lt;shape&gt; 
    &lt;name&gt;circle&lt;/name&gt; 
    &lt;type&gt;2D&lt;/type&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;name&gt;sphere&lt;/name&gt; 
    &lt;type&gt;3D&lt;/type&gt; 
  &lt;/shape&gt; 
&lt;/shapes&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//shape&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s2">: [</span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;sphere&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;type&quot;</span><span class="s2">: [</span><span class="s4">&quot;2D&quot;</span><span class="s2">, </span><span class="s4">&quot;3D&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_processing_instruction</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;style.xsl&quot;?&gt; 
&lt;?display table-view?&gt; 
&lt;?sort alpha-ascending?&gt; 
&lt;?textinfo whitespace is allowed ?&gt; 
&lt;?elementnames &lt;shape&gt;, &lt;name&gt;, &lt;type&gt; ?&gt; 
&lt;shapes&gt; 
  &lt;shape&gt; 
    &lt;name&gt;circle&lt;/name&gt; 
    &lt;type&gt;2D&lt;/type&gt; 
  &lt;/shape&gt; 
  &lt;shape&gt; 
    &lt;name&gt;sphere&lt;/name&gt; 
    &lt;type&gt;3D&lt;/type&gt; 
  &lt;/shape&gt; 
&lt;/shapes&gt;&quot;&quot;&quot;</span>

    <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">), </span><span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//shape&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse</span><span class="s2">(</span>
        <span class="s1">xml</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;shape&quot;</span><span class="s2">: [</span><span class="s4">&quot;name&quot;</span><span class="s2">, </span><span class="s4">&quot;type&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s2">: [</span><span class="s4">&quot;circle&quot;</span><span class="s2">, </span><span class="s4">&quot;sphere&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;type&quot;</span><span class="s2">: [</span><span class="s4">&quot;2D&quot;</span><span class="s2">, </span><span class="s4">&quot;3D&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_no_result</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ParserError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;No result from selected items in iterparse.&quot;</span>
    <span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span>
            <span class="s1">xml_books</span><span class="s2">,</span>
            <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
            <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;node&quot;</span><span class="s2">: [</span><span class="s4">&quot;attr1&quot;</span><span class="s2">, </span><span class="s4">&quot;elem1&quot;</span><span class="s2">, </span><span class="s4">&quot;elem2&quot;</span><span class="s2">, </span><span class="s4">&quot;elem3&quot;</span><span class="s2">]},</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_empty_data</span><span class="s2">(</span><span class="s1">xml_books</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">EmptyDataError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;No columns to parse from file&quot;</span><span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span>
            <span class="s1">xml_books</span><span class="s2">,</span>
            <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
            <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;book&quot;</span><span class="s2">: [</span><span class="s4">&quot;attr1&quot;</span><span class="s2">, </span><span class="s4">&quot;elem1&quot;</span><span class="s2">, </span><span class="s4">&quot;elem2&quot;</span><span class="s2">, </span><span class="s4">&quot;elem3&quot;</span><span class="s2">]},</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_online_stylesheet</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">xml </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;catalog&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Empire Burlesque&lt;/title&gt; 
    &lt;artist&gt;Bob Dylan&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;company&gt;Columbia&lt;/company&gt; 
    &lt;price&gt;10.90&lt;/price&gt; 
    &lt;year&gt;1985&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Hide your heart&lt;/title&gt; 
    &lt;artist&gt;Bonnie Tyler&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;CBS Records&lt;/company&gt; 
    &lt;price&gt;9.90&lt;/price&gt; 
    &lt;year&gt;1988&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Greatest Hits&lt;/title&gt; 
    &lt;artist&gt;Dolly Parton&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;company&gt;RCA&lt;/company&gt; 
    &lt;price&gt;9.90&lt;/price&gt; 
    &lt;year&gt;1982&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Still got the blues&lt;/title&gt; 
    &lt;artist&gt;Gary Moore&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Virgin records&lt;/company&gt; 
    &lt;price&gt;10.20&lt;/price&gt; 
    &lt;year&gt;1990&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Eros&lt;/title&gt; 
    &lt;artist&gt;Eros Ramazzotti&lt;/artist&gt; 
    &lt;country&gt;EU&lt;/country&gt; 
    &lt;company&gt;BMG&lt;/company&gt; 
    &lt;price&gt;9.90&lt;/price&gt; 
    &lt;year&gt;1997&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;One night only&lt;/title&gt; 
    &lt;artist&gt;Bee Gees&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Polydor&lt;/company&gt; 
    &lt;price&gt;10.90&lt;/price&gt; 
    &lt;year&gt;1998&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Sylvias Mother&lt;/title&gt; 
    &lt;artist&gt;Dr.Hook&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;CBS&lt;/company&gt; 
    &lt;price&gt;8.10&lt;/price&gt; 
    &lt;year&gt;1973&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Maggie May&lt;/title&gt; 
    &lt;artist&gt;Rod Stewart&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Pickwick&lt;/company&gt; 
    &lt;price&gt;8.50&lt;/price&gt; 
    &lt;year&gt;1990&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Romanza&lt;/title&gt; 
    &lt;artist&gt;Andrea Bocelli&lt;/artist&gt; 
    &lt;country&gt;EU&lt;/country&gt; 
    &lt;company&gt;Polydor&lt;/company&gt; 
    &lt;price&gt;10.80&lt;/price&gt; 
    &lt;year&gt;1996&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;When a man loves a woman&lt;/title&gt; 
    &lt;artist&gt;Percy Sledge&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;company&gt;Atlantic&lt;/company&gt; 
    &lt;price&gt;8.70&lt;/price&gt; 
    &lt;year&gt;1987&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Black angel&lt;/title&gt; 
    &lt;artist&gt;Savage Rose&lt;/artist&gt; 
    &lt;country&gt;EU&lt;/country&gt; 
    &lt;company&gt;Mega&lt;/company&gt; 
    &lt;price&gt;10.90&lt;/price&gt; 
    &lt;year&gt;1995&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;1999 Grammy Nominees&lt;/title&gt; 
    &lt;artist&gt;Many&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;company&gt;Grammy&lt;/company&gt; 
    &lt;price&gt;10.20&lt;/price&gt; 
    &lt;year&gt;1999&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;For the good times&lt;/title&gt; 
    &lt;artist&gt;Kenny Rogers&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Mucik Master&lt;/company&gt; 
    &lt;price&gt;8.70&lt;/price&gt; 
    &lt;year&gt;1995&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Big Willie style&lt;/title&gt; 
    &lt;artist&gt;Will Smith&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;company&gt;Columbia&lt;/company&gt; 
    &lt;price&gt;9.90&lt;/price&gt; 
    &lt;year&gt;1997&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Tupelo Honey&lt;/title&gt; 
    &lt;artist&gt;Van Morrison&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Polydor&lt;/company&gt; 
    &lt;price&gt;8.20&lt;/price&gt; 
    &lt;year&gt;1971&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Soulsville&lt;/title&gt; 
    &lt;artist&gt;Jorn Hoel&lt;/artist&gt; 
    &lt;country&gt;Norway&lt;/country&gt; 
    &lt;company&gt;WEA&lt;/company&gt; 
    &lt;price&gt;7.90&lt;/price&gt; 
    &lt;year&gt;1996&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;The very best of&lt;/title&gt; 
    &lt;artist&gt;Cat Stevens&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Island&lt;/company&gt; 
    &lt;price&gt;8.90&lt;/price&gt; 
    &lt;year&gt;1990&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Stop&lt;/title&gt; 
    &lt;artist&gt;Sam Brown&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;A and M&lt;/company&gt; 
    &lt;price&gt;8.90&lt;/price&gt; 
    &lt;year&gt;1988&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Bridge of Spies&lt;/title&gt; 
    &lt;artist&gt;T`Pau&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Siren&lt;/company&gt; 
    &lt;price&gt;7.90&lt;/price&gt; 
    &lt;year&gt;1987&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Private Dancer&lt;/title&gt; 
    &lt;artist&gt;Tina Turner&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;Capitol&lt;/company&gt; 
    &lt;price&gt;8.90&lt;/price&gt; 
    &lt;year&gt;1983&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Midt om natten&lt;/title&gt; 
    &lt;artist&gt;Kim Larsen&lt;/artist&gt; 
    &lt;country&gt;EU&lt;/country&gt; 
    &lt;company&gt;Medley&lt;/company&gt; 
    &lt;price&gt;7.80&lt;/price&gt; 
    &lt;year&gt;1983&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Pavarotti Gala Concert&lt;/title&gt; 
    &lt;artist&gt;Luciano Pavarotti&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;DECCA&lt;/company&gt; 
    &lt;price&gt;9.90&lt;/price&gt; 
    &lt;year&gt;1991&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;The dock of the bay&lt;/title&gt; 
    &lt;artist&gt;Otis Redding&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;COMPANY&gt;Stax Records&lt;/COMPANY&gt; 
    &lt;PRICE&gt;7.90&lt;/PRICE&gt; 
    &lt;YEAR&gt;1968&lt;/YEAR&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Picture book&lt;/title&gt; 
    &lt;artist&gt;Simply Red&lt;/artist&gt; 
    &lt;country&gt;EU&lt;/country&gt; 
    &lt;company&gt;Elektra&lt;/company&gt; 
    &lt;price&gt;7.20&lt;/price&gt; 
    &lt;year&gt;1985&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Red&lt;/title&gt; 
    &lt;artist&gt;The Communards&lt;/artist&gt; 
    &lt;country&gt;UK&lt;/country&gt; 
    &lt;company&gt;London&lt;/company&gt; 
    &lt;price&gt;7.80&lt;/price&gt; 
    &lt;year&gt;1987&lt;/year&gt; 
  &lt;/cd&gt; 
  &lt;cd&gt; 
    &lt;title&gt;Unchain my heart&lt;/title&gt; 
    &lt;artist&gt;Joe Cocker&lt;/artist&gt; 
    &lt;country&gt;USA&lt;/country&gt; 
    &lt;company&gt;EMI&lt;/company&gt; 
    &lt;price&gt;8.20&lt;/price&gt; 
    &lt;year&gt;1987&lt;/year&gt; 
  &lt;/cd&gt; 
&lt;/catalog&gt; 
&quot;&quot;&quot;</span>
    <span class="s1">xsl </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s4">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; 
&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;&gt; 
&lt;xsl:template match=&quot;/&quot;&gt; 
&lt;html&gt; 
&lt;body&gt; 
  &lt;h2&gt;My CD Collection&lt;/h2&gt; 
  &lt;table border=&quot;1&quot;&gt; 
    &lt;tr bgcolor=&quot;#9acd32&quot;&gt; 
      &lt;th style=&quot;text-align:left&quot;&gt;Title&lt;/th&gt; 
      &lt;th style=&quot;text-align:left&quot;&gt;Artist&lt;/th&gt; 
    &lt;/tr&gt; 
    &lt;xsl:for-each select=&quot;catalog/cd&quot;&gt; 
    &lt;tr&gt; 
      &lt;td&gt;&lt;xsl:value-of select=&quot;title&quot;/&gt;&lt;/td&gt; 
      &lt;td&gt;&lt;xsl:value-of select=&quot;artist&quot;/&gt;&lt;/td&gt; 
    &lt;/tr&gt; 
    &lt;/xsl:for-each&gt; 
  &lt;/table&gt; 
&lt;/body&gt; 
&lt;/html&gt; 
&lt;/xsl:template&gt; 
&lt;/xsl:stylesheet&gt; 
&quot;&quot;&quot;</span>

    <span class="s1">df_xsl </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span>
        <span class="s1">StringIO</span><span class="s2">(</span><span class="s1">xml</span><span class="s2">),</span>
        <span class="s1">xpath</span><span class="s2">=</span><span class="s4">&quot;.//tr[td and position() &lt;= 6]&quot;</span><span class="s2">,</span>
        <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;artist&quot;</span><span class="s2">],</span>
        <span class="s1">stylesheet</span><span class="s2">=</span><span class="s1">xsl</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;title&quot;</span><span class="s2">: {</span>
                <span class="s5">0</span><span class="s2">: </span><span class="s4">&quot;Empire Burlesque&quot;</span><span class="s2">,</span>
                <span class="s5">1</span><span class="s2">: </span><span class="s4">&quot;Hide your heart&quot;</span><span class="s2">,</span>
                <span class="s5">2</span><span class="s2">: </span><span class="s4">&quot;Greatest Hits&quot;</span><span class="s2">,</span>
                <span class="s5">3</span><span class="s2">: </span><span class="s4">&quot;Still got the blues&quot;</span><span class="s2">,</span>
                <span class="s5">4</span><span class="s2">: </span><span class="s4">&quot;Eros&quot;</span><span class="s2">,</span>
            <span class="s2">},</span>
            <span class="s4">&quot;artist&quot;</span><span class="s2">: {</span>
                <span class="s5">0</span><span class="s2">: </span><span class="s4">&quot;Bob Dylan&quot;</span><span class="s2">,</span>
                <span class="s5">1</span><span class="s2">: </span><span class="s4">&quot;Bonnie Tyler&quot;</span><span class="s2">,</span>
                <span class="s5">2</span><span class="s2">: </span><span class="s4">&quot;Dolly Parton&quot;</span><span class="s2">,</span>
                <span class="s5">3</span><span class="s2">: </span><span class="s4">&quot;Gary Moore&quot;</span><span class="s2">,</span>
                <span class="s5">4</span><span class="s2">: </span><span class="s4">&quot;Eros Ramazzotti&quot;</span><span class="s2">,</span>
            <span class="s2">},</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_expected</span><span class="s2">, </span><span class="s1">df_xsl</span><span class="s2">)</span>


<span class="s3"># COMPRESSION</span>


<span class="s0">def </span><span class="s1">test_compression_read</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression_only</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">comp_path</span><span class="s2">:</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span>
            <span class="s1">comp_path</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span>
        <span class="s2">)</span>

        <span class="s1">df_xpath </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">comp_path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">)</span>

        <span class="s1">df_iter </span><span class="s2">= </span><span class="s1">read_xml_iterparse_comp</span><span class="s2">(</span>
            <span class="s1">comp_path</span><span class="s2">,</span>
            <span class="s1">compression_only</span><span class="s2">,</span>
            <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
            <span class="s1">iterparse</span><span class="s2">={</span><span class="s4">&quot;row&quot;</span><span class="s2">: [</span><span class="s4">&quot;shape&quot;</span><span class="s2">, </span><span class="s4">&quot;degrees&quot;</span><span class="s2">, </span><span class="s4">&quot;sides&quot;</span><span class="s2">]},</span>
            <span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_only</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_xpath</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_iter</span><span class="s2">, </span><span class="s1">geom_df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wrong_compression</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">, </span><span class="s1">compression_only</span><span class="s2">):</span>
    <span class="s1">actual_compression </span><span class="s2">= </span><span class="s1">compression</span>
    <span class="s1">attempted_compression </span><span class="s2">= </span><span class="s1">compression_only</span>

    <span class="s0">if </span><span class="s1">actual_compression </span><span class="s2">== </span><span class="s1">attempted_compression</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">actual_compression</span><span class="s0">} </span><span class="s4">== </span><span class="s0">{</span><span class="s1">attempted_compression</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s1">errors </span><span class="s2">= {</span>
        <span class="s4">&quot;bz2&quot;</span><span class="s2">: (</span><span class="s1">OSError</span><span class="s2">, </span><span class="s4">&quot;Invalid data stream&quot;</span><span class="s2">),</span>
        <span class="s4">&quot;gzip&quot;</span><span class="s2">: (</span><span class="s1">OSError</span><span class="s2">, </span><span class="s4">&quot;Not a gzipped file&quot;</span><span class="s2">),</span>
        <span class="s4">&quot;zip&quot;</span><span class="s2">: (</span><span class="s1">BadZipFile</span><span class="s2">, </span><span class="s4">&quot;File is not a zip file&quot;</span><span class="s2">),</span>
        <span class="s4">&quot;tar&quot;</span><span class="s2">: (</span><span class="s1">ReadError</span><span class="s2">, </span><span class="s4">&quot;file could not be opened successfully&quot;</span><span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s1">zstd </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s4">&quot;zstandard&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">zstd </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">errors</span><span class="s2">[</span><span class="s4">&quot;zstd&quot;</span><span class="s2">] = (</span><span class="s1">zstd</span><span class="s2">.</span><span class="s1">ZstdError</span><span class="s2">, </span><span class="s4">&quot;Unknown frame descriptor&quot;</span><span class="s2">)</span>
    <span class="s1">lzma </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s4">&quot;lzma&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">lzma </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">errors</span><span class="s2">[</span><span class="s4">&quot;xz&quot;</span><span class="s2">] = (</span><span class="s1">LZMAError</span><span class="s2">, </span><span class="s4">&quot;Input format not supported by decoder&quot;</span><span class="s2">)</span>
    <span class="s1">error_cls</span><span class="s2">, </span><span class="s1">error_str </span><span class="s2">= </span><span class="s1">errors</span><span class="s2">[</span><span class="s1">attempted_compression</span><span class="s2">]</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">geom_df</span><span class="s2">.</span><span class="s1">to_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">actual_compression</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">error_cls</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_str</span><span class="s2">):</span>
            <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">attempted_compression</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_unsuported_compression</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unrecognized compression type&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">read_xml</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s4">&quot;7z&quot;</span><span class="s2">)</span>


<span class="s3"># STORAGE OPTIONS</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">network</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>
<span class="s0">def </span><span class="s1">test_s3_parser_consistency</span><span class="s2">(</span><span class="s1">s3_public_bucket_with_data</span><span class="s2">, </span><span class="s1">s3so</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;s3fs&quot;</span><span class="s2">)</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;lxml&quot;</span><span class="s2">)</span>
    <span class="s1">s3 </span><span class="s2">= </span><span class="s4">f&quot;s3://</span><span class="s0">{</span><span class="s1">s3_public_bucket_with_data</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}</span><span class="s4">/books.xml&quot;</span>

    <span class="s1">df_lxml </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">s3</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;lxml&quot;</span><span class="s2">, </span><span class="s1">storage_options</span><span class="s2">=</span><span class="s1">s3so</span><span class="s2">)</span>

    <span class="s1">df_etree </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">s3</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s4">&quot;etree&quot;</span><span class="s2">, </span><span class="s1">storage_options</span><span class="s2">=</span><span class="s1">s3so</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_lxml</span><span class="s2">, </span><span class="s1">df_etree</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_xml_nullable_dtypes</span><span class="s2">(</span>
    <span class="s1">parser</span><span class="s2">, </span><span class="s1">string_storage</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">, </span><span class="s1">using_infer_string</span>
<span class="s2">):</span>
    <span class="s3"># GH#50500</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot;&lt;?xml version='1.0' encoding='utf-8'?&gt; 
&lt;data xmlns=&quot;http://example.com&quot;&gt; 
&lt;row&gt; 
  &lt;a&gt;x&lt;/a&gt; 
  &lt;b&gt;1&lt;/b&gt; 
  &lt;c&gt;4.0&lt;/c&gt; 
  &lt;d&gt;x&lt;/d&gt; 
  &lt;e&gt;2&lt;/e&gt; 
  &lt;f&gt;4.0&lt;/f&gt; 
  &lt;g&gt;&lt;/g&gt; 
  &lt;h&gt;True&lt;/h&gt; 
  &lt;i&gt;False&lt;/i&gt; 
&lt;/row&gt; 
&lt;row&gt; 
  &lt;a&gt;y&lt;/a&gt; 
  &lt;b&gt;2&lt;/b&gt; 
  &lt;c&gt;5.0&lt;/c&gt; 
  &lt;d&gt;&lt;/d&gt; 
  &lt;e&gt;&lt;/e&gt; 
  &lt;f&gt;&lt;/f&gt; 
  &lt;g&gt;&lt;/g&gt; 
  &lt;h&gt;False&lt;/h&gt; 
  &lt;i&gt;&lt;/i&gt; 
&lt;/row&gt; 
&lt;/data&gt;&quot;&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">using_infer_string</span><span class="s2">:</span>
        <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s1">string_array </span><span class="s2">= </span><span class="s1">ArrowStringArrayNumpySemantics</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">]))</span>
        <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">ArrowStringArrayNumpySemantics</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]))</span>

    <span class="s0">elif </span><span class="s1">string_storage </span><span class="s2">== </span><span class="s4">&quot;python&quot;</span><span class="s2">:</span>
        <span class="s1">string_array </span><span class="s2">= </span><span class="s1">StringArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">))</span>
        <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">StringArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">))</span>

    <span class="s0">elif </span><span class="s1">dtype_backend </span><span class="s2">== </span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">:</span>
        <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">arrays </span><span class="s0">import </span><span class="s1">ArrowExtensionArray</span>

        <span class="s1">string_array </span><span class="s2">= </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">]))</span>
        <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]))</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s1">string_array </span><span class="s2">= </span><span class="s1">ArrowStringArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">]))</span>
        <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">ArrowStringArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]))</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s4">&quot;mode.string_storage&quot;</span><span class="s2">, </span><span class="s1">string_storage</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">read_xml</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s1">string_array</span><span class="s2">,</span>
            <span class="s4">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;Int64&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">5.0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;Float64&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;d&quot;</span><span class="s2">: </span><span class="s1">string_array_na</span><span class="s2">,</span>
            <span class="s4">&quot;e&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;Int64&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;f&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s5">4.0</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;Float64&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;g&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;Int64&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;h&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;boolean&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;i&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;boolean&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">dtype_backend </span><span class="s2">== </span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">:</span>
        <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">arrays </span><span class="s0">import </span><span class="s1">ArrowExtensionArray</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s1">col</span><span class="s2">: </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">from_pandas</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
                <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">columns</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">&quot;g&quot;</span><span class="s2">] = </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]))</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_invalid_dtype_backend</span><span class="s2">():</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;dtype_backend numpy is invalid, only 'numpy_nullable' and &quot;</span>
        <span class="s4">&quot;'pyarrow' are allowed.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">read_xml</span><span class="s2">(</span><span class="s4">&quot;test&quot;</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">=</span><span class="s4">&quot;numpy&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>