<html>
<head>
<title>PdfParser.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PdfParser.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">calendar</span>
<span class="s0">import </span><span class="s1">codecs</span>
<span class="s0">import </span><span class="s1">collections</span>
<span class="s0">import </span><span class="s1">mmap</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">zlib</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TYPE_CHECKING</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">List</span><span class="s2">, </span><span class="s1">NamedTuple</span><span class="s2">, </span><span class="s1">Union</span>


<span class="s3"># see 7.9.2.2 Text String Type on page 86 and D.3 PDFDocEncoding Character Set</span>
<span class="s3"># on page 656</span>
<span class="s0">def </span><span class="s1">encode_text</span><span class="s2">(</span><span class="s1">s</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF16_BE </span><span class="s2">+ </span><span class="s1">s</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;utf_16_be&quot;</span><span class="s2">)</span>


<span class="s1">PDFDocEncoding </span><span class="s2">= {</span>
    <span class="s5">0x16</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0017</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x18</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02D8</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x19</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02C7</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x1A</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02C6</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x1B</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02D9</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x1C</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02DD</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x1D</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02DB</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x1E</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02DA</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x1F</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u02DC</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x80</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2022</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x81</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2020</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x82</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2021</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x83</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2026</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x84</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2014</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x85</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2013</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x86</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0192</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x87</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2044</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x88</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2039</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x89</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u203A</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x8A</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2212</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x8B</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2030</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x8C</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u201E</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x8D</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u201C</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x8E</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u201D</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x8F</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2018</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x90</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2019</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x91</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u201A</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x92</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u2122</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x93</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\uFB01</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x94</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\uFB02</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x95</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0141</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x96</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0152</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x97</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0160</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x98</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0178</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x99</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u017D</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x9A</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0131</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x9B</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0142</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x9C</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0153</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x9D</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u0161</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0x9E</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u017E</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s5">0xA0</span><span class="s2">: </span><span class="s4">&quot;</span><span class="s0">\u20AC</span><span class="s4">&quot;</span><span class="s2">,</span>
<span class="s2">}</span>


<span class="s0">def </span><span class="s1">decode_text</span><span class="s2">(</span><span class="s1">b</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">b</span><span class="s2">[: </span><span class="s1">len</span><span class="s2">(</span><span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF16_BE</span><span class="s2">)] == </span><span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF16_BE</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">b</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">codecs</span><span class="s2">.</span><span class="s1">BOM_UTF16_BE</span><span class="s2">) :].</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf_16_be&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">PDFDocEncoding</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">byte</span><span class="s2">, </span><span class="s1">chr</span><span class="s2">(</span><span class="s1">byte</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">byte </span><span class="s0">in </span><span class="s1">b</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PdfFormatError</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;An error that probably indicates a syntactic or semantic error in the 
    PDF file structure&quot;&quot;&quot;</span>

    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">condition</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">, </span><span class="s1">error_message</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">if not </span><span class="s1">condition</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">PdfFormatError</span><span class="s2">(</span><span class="s1">error_message</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">IndirectReferenceTuple</span><span class="s2">(</span><span class="s1">NamedTuple</span><span class="s2">):</span>
    <span class="s1">object_id</span><span class="s2">: </span><span class="s1">int</span>
    <span class="s1">generation</span><span class="s2">: </span><span class="s1">int</span>


<span class="s0">class </span><span class="s1">IndirectReference</span><span class="s2">(</span><span class="s1">IndirectReferenceTuple</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id</span><span class="s0">} {</span><span class="s1">self</span><span class="s2">.</span><span class="s1">generation</span><span class="s0">} </span><span class="s4">R&quot;</span>

    <span class="s0">def </span><span class="s1">__bytes__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__str__</span><span class="s2">().</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s0">is not </span><span class="s1">other</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">:</span>
            <span class="s0">return False</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">IndirectReference</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">other</span><span class="s2">.</span><span class="s1">object_id </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id </span><span class="s0">and </span><span class="s1">other</span><span class="s2">.</span><span class="s1">generation </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generation</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return not </span><span class="s2">(</span><span class="s1">self </span><span class="s2">== </span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">generation</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">IndirectObjectDef</span><span class="s2">(</span><span class="s1">IndirectReference</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__str__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">object_id</span><span class="s0">} {</span><span class="s1">self</span><span class="s2">.</span><span class="s1">generation</span><span class="s0">} </span><span class="s4">obj&quot;</span>


<span class="s0">class </span><span class="s1">XrefTable</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries </span><span class="s2">= {}  </span><span class="s3"># object ID =&gt; (offset, generation)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries </span><span class="s2">= {}  </span><span class="s3"># object ID =&gt; (offset, generation)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries </span><span class="s2">= {</span><span class="s5">0</span><span class="s2">: </span><span class="s5">65536</span><span class="s2">}  </span><span class="s3"># object ID =&gt; generation</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">reading_finished </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">reading_finished</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">:</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__delitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">:</span>
            <span class="s1">generation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">][</span><span class="s5">1</span><span class="s2">] + </span><span class="s5">1</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">generation</span>
        <span class="s0">elif </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries</span><span class="s2">:</span>
            <span class="s1">generation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">][</span><span class="s5">1</span><span class="s2">] + </span><span class="s5">1</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">generation</span>
        <span class="s0">elif </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">:</span>
            <span class="s1">generation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;object ID </span><span class="s0">{</span><span class="s1">key</span><span class="s0">} </span><span class="s4">cannot be deleted because it doesn't exist&quot;</span>
            <span class="s0">raise </span><span class="s1">IndexError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__contains__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries </span><span class="s0">or </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span>
            <span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
            <span class="s2">| </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
            <span class="s2">| </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">existing_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) - </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s2">) | </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">f</span><span class="s2">):</span>
        <span class="s1">keys </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) | </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()))</span>
        <span class="s1">deleted_keys </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()))</span>
        <span class="s1">startxref </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;xref</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s0">while </span><span class="s1">keys</span><span class="s2">:</span>
            <span class="s3"># find a contiguous sequence of object IDs</span>
            <span class="s1">prev </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s0">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">key </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">prev </span><span class="s0">is None or </span><span class="s1">prev </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">== </span><span class="s1">key</span><span class="s2">:</span>
                    <span class="s1">prev </span><span class="s2">= </span><span class="s1">key</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">contiguous_keys </span><span class="s2">= </span><span class="s1">keys</span><span class="s2">[:</span><span class="s1">index</span><span class="s2">]</span>
                    <span class="s1">keys </span><span class="s2">= </span><span class="s1">keys</span><span class="s2">[</span><span class="s1">index</span><span class="s2">:]</span>
                    <span class="s0">break</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">contiguous_keys </span><span class="s2">= </span><span class="s1">keys</span>
                <span class="s1">keys </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;%d %d</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s2">% (</span><span class="s1">contiguous_keys</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">len</span><span class="s2">(</span><span class="s1">contiguous_keys</span><span class="s2">)))</span>
            <span class="s0">for </span><span class="s1">object_id </span><span class="s0">in </span><span class="s1">contiguous_keys</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">object_id </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">:</span>
                    <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;%010d %05d n </span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">new_entries</span><span class="s2">[</span><span class="s1">object_id</span><span class="s2">])</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">this_deleted_object_id </span><span class="s2">= </span><span class="s1">deleted_keys</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
                    <span class="s1">check_format_condition</span><span class="s2">(</span>
                        <span class="s1">object_id </span><span class="s2">== </span><span class="s1">this_deleted_object_id</span><span class="s2">,</span>
                        <span class="s4">f&quot;expected the next deleted object ID to be </span><span class="s0">{</span><span class="s1">object_id</span><span class="s0">}</span><span class="s4">, &quot;</span>
                        <span class="s4">f&quot;instead found </span><span class="s0">{</span><span class="s1">this_deleted_object_id</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">next_in_linked_list </span><span class="s2">= </span><span class="s1">deleted_keys</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
                    <span class="s0">except </span><span class="s1">IndexError</span><span class="s2">:</span>
                        <span class="s1">next_in_linked_list </span><span class="s2">= </span><span class="s5">0</span>
                    <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                        <span class="s7">b&quot;%010d %05d f </span><span class="s0">\n</span><span class="s7">&quot;</span>
                        <span class="s2">% (</span><span class="s1">next_in_linked_list</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">deleted_entries</span><span class="s2">[</span><span class="s1">object_id</span><span class="s2">])</span>
                    <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">startxref</span>


<span class="s0">class </span><span class="s1">PdfName</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">PdfName</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">name_as_str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">PdfName</span><span class="s2">) </span><span class="s0">and </span><span class="s1">other</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s2">) </span><span class="s0">or </span><span class="s1">other </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">(</span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span><span class="s0">}</span><span class="s4">)&quot;</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">from_pdf_stream</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">PdfParser</span><span class="s2">.</span><span class="s1">interpret_name</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>

    <span class="s1">allowed_chars </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">33</span><span class="s2">, </span><span class="s5">127</span><span class="s2">)) - {</span><span class="s1">ord</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s4">&quot;#%/()&lt;&gt;[]{}&quot;</span><span class="s2">}</span>

    <span class="s0">def </span><span class="s1">__bytes__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s7">b&quot;/&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">b </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">allowed_chars</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot;#%02X&quot; </span><span class="s2">% </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PdfArray</span><span class="s2">(</span><span class="s1">List</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">]):</span>
    <span class="s0">def </span><span class="s1">__bytes__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s7">b&quot;[ &quot; </span><span class="s2">+ </span><span class="s7">b&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pdf_repr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">self</span><span class="s2">) + </span><span class="s7">b&quot; ]&quot;</span>


<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s1">_DictBase </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">UserDict</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">], </span><span class="s1">Any</span><span class="s2">]</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s1">_DictBase </span><span class="s2">= </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">UserDict</span>


<span class="s0">class </span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">_DictBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s4">&quot;data&quot;</span><span class="s2">:</span>
            <span class="s1">collections</span><span class="s2">.</span><span class="s1">UserDict</span><span class="s2">.</span><span class="s1">__setattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">[</span><span class="s1">key</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)] = </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">[</span><span class="s1">key</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)]</span>
        <span class="s0">except </span><span class="s1">KeyError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">AttributeError</span><span class="s2">(</span><span class="s1">key</span><span class="s2">) </span><span class="s0">from </span><span class="s1">e</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">):</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">decode_text</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">key</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;Date&quot;</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;D:&quot;</span><span class="s2">):</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">value</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:]</span>

            <span class="s1">relationship </span><span class="s2">= </span><span class="s4">&quot;Z&quot;</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) &gt; </span><span class="s5">17</span><span class="s2">:</span>
                <span class="s1">relationship </span><span class="s2">= </span><span class="s1">value</span><span class="s2">[</span><span class="s5">14</span><span class="s2">]</span>
                <span class="s1">offset </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">[</span><span class="s5">15</span><span class="s2">:</span><span class="s5">17</span><span class="s2">]) * </span><span class="s5">60</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) &gt; </span><span class="s5">20</span><span class="s2">:</span>
                    <span class="s1">offset </span><span class="s2">+= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">[</span><span class="s5">18</span><span class="s2">:</span><span class="s5">20</span><span class="s2">])</span>

            <span class="s1">format </span><span class="s2">= </span><span class="s4">&quot;%Y%m%d%H%M%S&quot;</span><span class="s2">[: </span><span class="s1">len</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) - </span><span class="s5">2</span><span class="s2">]</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">(</span><span class="s1">value</span><span class="s2">[: </span><span class="s1">len</span><span class="s2">(</span><span class="s1">format</span><span class="s2">) + </span><span class="s5">2</span><span class="s2">], </span><span class="s1">format</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">relationship </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;+&quot;</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">]:</span>
                <span class="s1">offset </span><span class="s2">*= </span><span class="s5">60</span>
                <span class="s0">if </span><span class="s1">relationship </span><span class="s2">== </span><span class="s4">&quot;+&quot;</span><span class="s2">:</span>
                    <span class="s1">offset </span><span class="s2">*= -</span><span class="s5">1</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">gmtime</span><span class="s2">(</span><span class="s1">calendar</span><span class="s2">.</span><span class="s1">timegm</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) + </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">__bytes__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s7">b&quot;&lt;&lt;&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">pdf_repr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">PdfName</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)))</span>
            <span class="s1">out</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot; &quot;</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">out</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">&gt;&gt;&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">out</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PdfBinary</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">__bytes__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s7">b&quot;&lt;%s&gt;&quot; </span><span class="s2">% </span><span class="s7">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s7">b&quot;%02X&quot; </span><span class="s2">% </span><span class="s1">b </span><span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PdfStream</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dictionary</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dictionary </span><span class="s2">= </span><span class="s1">dictionary</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buf </span><span class="s2">= </span><span class="s1">buf</span>

    <span class="s0">def </span><span class="s1">decode</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">filter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictionary</span><span class="s2">.</span><span class="s1">Filter</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span>
        <span class="s0">if </span><span class="s1">filter </span><span class="s2">== </span><span class="s7">b&quot;FlateDecode&quot;</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">expected_length </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictionary</span><span class="s2">.</span><span class="s1">DL</span>
            <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
                <span class="s1">expected_length </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictionary</span><span class="s2">.</span><span class="s1">Length</span>
            <span class="s0">return </span><span class="s1">zlib</span><span class="s2">.</span><span class="s1">decompress</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">bufsize</span><span class="s2">=</span><span class="s1">int</span><span class="s2">(</span><span class="s1">expected_length</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;stream filter </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">dictionary</span><span class="s2">.</span><span class="s1">Filter</span><span class="s2">)</span><span class="s0">} </span><span class="s4">unknown/unsupported&quot;</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">pdf_repr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">x </span><span class="s0">is True</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s7">b&quot;true&quot;</span>
    <span class="s0">elif </span><span class="s1">x </span><span class="s0">is False</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s7">b&quot;false&quot;</span>
    <span class="s0">elif </span><span class="s1">x </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s7">b&quot;null&quot;</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s1">PdfName</span><span class="s2">, </span><span class="s1">PdfDict</span><span class="s2">, </span><span class="s1">PdfArray</span><span class="s2">, </span><span class="s1">PdfBinary</span><span class="s2">)):</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)):</span>
        <span class="s0">return </span><span class="s1">str</span><span class="s2">(</span><span class="s1">x</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">time</span><span class="s2">.</span><span class="s1">struct_time</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s7">b&quot;(D:&quot; </span><span class="s2">+ </span><span class="s1">time</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s4">&quot;%Y%m%d%H%M%SZ&quot;</span><span class="s2">, </span><span class="s1">x</span><span class="s2">).</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">) + </span><span class="s7">b&quot;)&quot;</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">PdfArray</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">pdf_repr</span><span class="s2">(</span><span class="s1">encode_text</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">):</span>
        <span class="s3"># XXX escape more chars? handle binary garbage</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">&quot;</span><span class="s2">, </span><span class="s7">b&quot;</span><span class="s0">\\\\</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s7">b&quot;(&quot;</span><span class="s2">, </span><span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">(&quot;</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s7">b&quot;)&quot;</span><span class="s2">, </span><span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">)&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s7">b&quot;(&quot; </span><span class="s2">+ </span><span class="s1">x </span><span class="s2">+ </span><span class="s7">b&quot;)&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PdfParser</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot;Based on 
    https://www.adobe.com/content/dam/acom/en/devnet/acrobat/pdfs/PDF32000_2008.pdf 
    Supports PDF up to 1.4 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">f</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">start_offset</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;rb&quot;</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">buf </span><span class="s0">and </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;specify buf or f or filename, but not both buf and f&quot;</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buf </span><span class="s2">= </span><span class="s1">buf</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">f </span><span class="s2">= </span><span class="s1">f</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">start_offset </span><span class="s2">= </span><span class="s1">start_offset</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">should_close_buf </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">should_close_file </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">filename </span><span class="s0">is not None and </span><span class="s1">f </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">f </span><span class="s2">= </span><span class="s1">f </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">should_close_file </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">f </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">buf </span><span class="s2">= </span><span class="s1">buf </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_buf_from_file</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">should_close_buf </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">if not </span><span class="s1">filename </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s4">&quot;name&quot;</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cached_objects </span><span class="s2">= {}</span>
        <span class="s0">if </span><span class="s1">buf</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">read_pdf_info</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">file_size_total </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_size_this </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">PdfDict</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">info </span><span class="s2">= </span><span class="s1">PdfDict</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">info_ref </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">page_tree_root </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pages </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">orig_pages </span><span class="s2">= []</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">last_xref_section_offset </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">trailer_dict </span><span class="s2">= {}</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table </span><span class="s2">= </span><span class="s1">XrefTable</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">.</span><span class="s1">reading_finished </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">f</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">seek_end</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__enter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; PdfParser</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span>

    <span class="s0">def </span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">start_writing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">close_buf</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">seek_end</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">close_buf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">buf </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">should_close_buf</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">close_buf</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">should_close_file</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">f </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">seek_end</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">SEEK_END</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write_header</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;%PDF-1.4</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write_comment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;% </span><span class="s0">{</span><span class="s1">s</span><span class="s0">}\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">write_catalog</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; IndirectReference</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">del_root</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">next_object_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">next_object_id</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rewrite_pages</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">write_obj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref</span><span class="s2">, </span><span class="s1">Type</span><span class="s2">=</span><span class="s1">PdfName</span><span class="s2">(</span><span class="s7">b&quot;Catalog&quot;</span><span class="s2">), </span><span class="s1">Pages</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">write_obj</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref</span><span class="s2">,</span>
            <span class="s1">Type</span><span class="s2">=</span><span class="s1">PdfName</span><span class="s2">(</span><span class="s7">b&quot;Pages&quot;</span><span class="s2">),</span>
            <span class="s1">Count</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">),</span>
            <span class="s1">Kids</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref</span>

    <span class="s0">def </span><span class="s1">rewrite_pages</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">pages_tree_nodes_to_delete </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">page_ref </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">orig_pages</span><span class="s2">):</span>
            <span class="s1">page_info </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cached_objects</span><span class="s2">[</span><span class="s1">page_ref</span><span class="s2">]</span>
            <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">page_ref</span><span class="s2">.</span><span class="s1">object_id</span><span class="s2">]</span>
            <span class="s1">pages_tree_nodes_to_delete</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">page_info</span><span class="s2">[</span><span class="s1">PdfName</span><span class="s2">(</span><span class="s7">b&quot;Parent&quot;</span><span class="s2">)])</span>
            <span class="s0">if </span><span class="s1">page_ref </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">:</span>
                <span class="s3"># the page has been deleted</span>
                <span class="s0">continue</span>
            <span class="s3"># make dict keys into strings for passing to write_page</span>
            <span class="s1">stringified_page_info </span><span class="s2">= {}</span>
            <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">page_info</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s3"># key should be a PdfName</span>
                <span class="s1">stringified_page_info</span><span class="s2">[</span><span class="s1">key</span><span class="s2">.</span><span class="s1">name_as_str</span><span class="s2">()] = </span><span class="s1">value</span>
            <span class="s1">stringified_page_info</span><span class="s2">[</span><span class="s4">&quot;Parent&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref</span>
            <span class="s1">new_page_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">write_page</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">stringified_page_info</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">cur_page_ref </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">cur_page_ref </span><span class="s2">== </span><span class="s1">page_ref</span><span class="s2">:</span>
                    <span class="s3"># replace the page reference with the new one</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">new_page_ref</span>
        <span class="s3"># delete redundant Pages tree nodes from xref table</span>
        <span class="s0">for </span><span class="s1">pages_tree_node_ref </span><span class="s0">in </span><span class="s1">pages_tree_nodes_to_delete</span><span class="s2">:</span>
            <span class="s0">while </span><span class="s1">pages_tree_node_ref</span><span class="s2">:</span>
                <span class="s1">pages_tree_node </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">cached_objects</span><span class="s2">[</span><span class="s1">pages_tree_node_ref</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">pages_tree_node_ref</span><span class="s2">.</span><span class="s1">object_id </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">:</span>
                    <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">pages_tree_node_ref</span><span class="s2">.</span><span class="s1">object_id</span><span class="s2">]</span>
                <span class="s1">pages_tree_node_ref </span><span class="s2">= </span><span class="s1">pages_tree_node</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s7">b&quot;Parent&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">orig_pages </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">write_xref_and_trailer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">new_root_ref</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">new_root_ref</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">del_root</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref </span><span class="s2">= </span><span class="s1">new_root_ref</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">info</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">info_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">write_obj</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">info</span><span class="s2">)</span>
        <span class="s1">start_xref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">num_entries </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">)</span>
        <span class="s1">trailer_dict </span><span class="s2">= {</span><span class="s7">b&quot;Root&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref</span><span class="s2">, </span><span class="s7">b&quot;Size&quot;</span><span class="s2">: </span><span class="s1">num_entries</span><span class="s2">}</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">last_xref_section_offset </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">trailer_dict</span><span class="s2">[</span><span class="s7">b&quot;Prev&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">last_xref_section_offset</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">info</span><span class="s2">:</span>
            <span class="s1">trailer_dict</span><span class="s2">[</span><span class="s7">b&quot;Info&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">info_ref</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">last_xref_section_offset </span><span class="s2">= </span><span class="s1">start_xref</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
            <span class="s7">b&quot;trailer</span><span class="s0">\n</span><span class="s7">&quot;</span>
            <span class="s2">+ </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">trailer_dict</span><span class="s2">))</span>
            <span class="s2">+ </span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">startxref</span><span class="s0">\n</span><span class="s7">%d</span><span class="s0">\n</span><span class="s7">%%%%EOF&quot; </span><span class="s2">% </span><span class="s1">start_xref</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write_page</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, *</span><span class="s1">objs</span><span class="s2">, **</span><span class="s1">dict_obj</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">[</span><span class="s1">ref</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s4">&quot;Type&quot; </span><span class="s0">not in </span><span class="s1">dict_obj</span><span class="s2">:</span>
            <span class="s1">dict_obj</span><span class="s2">[</span><span class="s4">&quot;Type&quot;</span><span class="s2">] = </span><span class="s1">PdfName</span><span class="s2">(</span><span class="s7">b&quot;Page&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s4">&quot;Parent&quot; </span><span class="s0">not in </span><span class="s1">dict_obj</span><span class="s2">:</span>
            <span class="s1">dict_obj</span><span class="s2">[</span><span class="s4">&quot;Parent&quot;</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">write_obj</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, *</span><span class="s1">objs</span><span class="s2">, **</span><span class="s1">dict_obj</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write_obj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, *</span><span class="s1">objs</span><span class="s2">, **</span><span class="s1">dict_obj</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span>
        <span class="s0">if </span><span class="s1">ref </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">next_object_id</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">())</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">object_id</span><span class="s2">] = (</span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">(), </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">generation</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">IndirectObjectDef</span><span class="s2">(*</span><span class="s1">ref</span><span class="s2">)))</span>
        <span class="s1">stream </span><span class="s2">= </span><span class="s1">dict_obj</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;stream&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">stream </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">dict_obj</span><span class="s2">[</span><span class="s4">&quot;Length&quot;</span><span class="s2">] = </span><span class="s1">len</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">dict_obj</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pdf_repr</span><span class="s2">(</span><span class="s1">dict_obj</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">objs</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">pdf_repr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">stream </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;stream</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">stream</span><span class="s2">)</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">endstream</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;endobj</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">ref</span>

    <span class="s0">def </span><span class="s1">del_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref</span><span class="s2">.</span><span class="s1">object_id</span><span class="s2">]</span>
        <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">[</span><span class="s7">b&quot;Pages&quot;</span><span class="s2">].</span><span class="s1">object_id</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">get_buf_from_file</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s4">&quot;getbuffer&quot;</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">f</span><span class="s2">.</span><span class="s1">getbuffer</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s4">&quot;getvalue&quot;</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">f</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">mmap</span><span class="s2">.</span><span class="s1">mmap</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">(), </span><span class="s5">0</span><span class="s2">, </span><span class="s1">access</span><span class="s2">=</span><span class="s1">mmap</span><span class="s2">.</span><span class="s1">ACCESS_READ</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:  </span><span class="s3"># cannot mmap an empty file</span>
                <span class="s0">return </span><span class="s7">b&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">read_pdf_info</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_size_total </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">file_size_this </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">file_size_total </span><span class="s2">- </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_offset</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">read_trailer</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trailer_dict</span><span class="s2">[</span><span class="s7">b&quot;Root&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">info_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trailer_dict</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s7">b&quot;Info&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">root </span><span class="s2">= </span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_indirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_ref</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">info_ref </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">info </span><span class="s2">= </span><span class="s1">PdfDict</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">info </span><span class="s2">= </span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_indirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">info_ref</span><span class="s2">))</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s7">b&quot;Type&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">, </span><span class="s4">&quot;/Type missing in Root&quot;</span><span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">[</span><span class="s7">b&quot;Type&quot;</span><span class="s2">] == </span><span class="s7">b&quot;Catalog&quot;</span><span class="s2">, </span><span class="s4">&quot;/Type in Root is not /Catalog&quot;</span>
        <span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s7">b&quot;Pages&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">, </span><span class="s4">&quot;/Pages missing in Root&quot;</span><span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">[</span><span class="s7">b&quot;Pages&quot;</span><span class="s2">], </span><span class="s1">IndirectReference</span><span class="s2">),</span>
            <span class="s4">&quot;/Pages in Root is not an indirect reference&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root</span><span class="s2">[</span><span class="s7">b&quot;Pages&quot;</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">page_tree_root </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_indirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages_ref</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">pages </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">linearize_page_tree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">page_tree_root</span><span class="s2">)</span>
        <span class="s3"># save the original list of page references</span>
        <span class="s3"># in case the user modifies, adds or deletes some pages</span>
        <span class="s3"># and we need to rewrite the pages and their list</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">orig_pages </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">pages</span><span class="s2">[:]</span>

    <span class="s0">def </span><span class="s1">next_object_id</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># TODO: support reuse of deleted objects</span>
            <span class="s1">reference </span><span class="s2">= </span><span class="s1">IndirectReference</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) + </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
            <span class="s1">reference </span><span class="s2">= </span><span class="s1">IndirectReference</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">offset </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">reference</span><span class="s2">.</span><span class="s1">object_id</span><span class="s2">] = (</span><span class="s1">offset</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">reference</span>

    <span class="s1">delimiter </span><span class="s2">= </span><span class="s7">rb&quot;[][()&lt;&gt;{}/%]&quot;</span>
    <span class="s1">delimiter_or_ws </span><span class="s2">= </span><span class="s7">rb&quot;[][()&lt;&gt;{}/%\000\011\012\014\015\040]&quot;</span>
    <span class="s1">whitespace </span><span class="s2">= </span><span class="s7">rb&quot;[\000\011\012\014\015\040]&quot;</span>
    <span class="s1">whitespace_or_hex </span><span class="s2">= </span><span class="s7">rb&quot;[\000\011\012\014\015\0400-9a-fA-F]&quot;</span>
    <span class="s1">whitespace_optional </span><span class="s2">= </span><span class="s1">whitespace </span><span class="s2">+ </span><span class="s7">b&quot;*&quot;</span>
    <span class="s1">whitespace_mandatory </span><span class="s2">= </span><span class="s1">whitespace </span><span class="s2">+ </span><span class="s7">b&quot;+&quot;</span>
    <span class="s3"># No &quot;\012&quot; aka &quot;\n&quot; or &quot;\015&quot; aka &quot;\r&quot;:</span>
    <span class="s1">whitespace_optional_no_nl </span><span class="s2">= </span><span class="s7">rb&quot;[\000\011\014\040]*&quot;</span>
    <span class="s1">newline_only </span><span class="s2">= </span><span class="s7">rb&quot;[\r\n]+&quot;</span>
    <span class="s1">newline </span><span class="s2">= </span><span class="s1">whitespace_optional_no_nl </span><span class="s2">+ </span><span class="s1">newline_only </span><span class="s2">+ </span><span class="s1">whitespace_optional_no_nl</span>
    <span class="s1">re_trailer_end </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_mandatory</span>
        <span class="s2">+ </span><span class="s7">rb&quot;trailer&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;&lt;&lt;(.*&gt;&gt;)&quot;</span>
        <span class="s2">+ </span><span class="s1">newline</span>
        <span class="s2">+ </span><span class="s7">rb&quot;startxref&quot;</span>
        <span class="s2">+ </span><span class="s1">newline</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">newline</span>
        <span class="s2">+ </span><span class="s7">rb&quot;%%EOF&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;$&quot;</span><span class="s2">,</span>
        <span class="s1">re</span><span class="s2">.</span><span class="s1">DOTALL</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">re_trailer_prev </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;trailer&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;&lt;&lt;(.*?&gt;&gt;)&quot;</span>
        <span class="s2">+ </span><span class="s1">newline</span>
        <span class="s2">+ </span><span class="s7">rb&quot;startxref&quot;</span>
        <span class="s2">+ </span><span class="s1">newline</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">newline</span>
        <span class="s2">+ </span><span class="s7">rb&quot;%%EOF&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_optional</span><span class="s2">,</span>
        <span class="s1">re</span><span class="s2">.</span><span class="s1">DOTALL</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read_trailer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">search_start_offset </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">) - </span><span class="s5">16384</span>
        <span class="s0">if </span><span class="s1">search_start_offset </span><span class="s2">&lt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_offset</span><span class="s2">:</span>
            <span class="s1">search_start_offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_offset</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">re_trailer_end</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">search_start_offset</span><span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">&quot;trailer end not found&quot;</span><span class="s2">)</span>
        <span class="s3"># make sure we found the LAST trailer</span>
        <span class="s1">last_match </span><span class="s2">= </span><span class="s1">m</span>
        <span class="s0">while </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">last_match </span><span class="s2">= </span><span class="s1">m</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">re_trailer_end</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">start</span><span class="s2">() + </span><span class="s5">16</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">last_match</span>
        <span class="s1">trailer_data </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">last_xref_section_offset </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">trailer_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">interpret_trailer</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table </span><span class="s2">= </span><span class="s1">XrefTable</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">read_xref_table</span><span class="s2">(</span><span class="s1">xref_section_offset</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">last_xref_section_offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s7">b&quot;Prev&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">trailer_dict</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">read_prev_trailer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">trailer_dict</span><span class="s2">[</span><span class="s7">b&quot;Prev&quot;</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">read_prev_trailer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xref_section_offset</span><span class="s2">):</span>
        <span class="s1">trailer_offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_xref_table</span><span class="s2">(</span><span class="s1">xref_section_offset</span><span class="s2">=</span><span class="s1">xref_section_offset</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">re_trailer_prev</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">[</span><span class="s1">trailer_offset </span><span class="s2">: </span><span class="s1">trailer_offset </span><span class="s2">+ </span><span class="s5">16384</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">&quot;previous trailer not found&quot;</span><span class="s2">)</span>
        <span class="s1">trailer_data </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)) == </span><span class="s1">xref_section_offset</span><span class="s2">,</span>
            <span class="s4">&quot;xref section offset in previous trailer doesn't match what was expected&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">trailer_dict </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">interpret_trailer</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s7">b&quot;Prev&quot; </span><span class="s0">in </span><span class="s1">trailer_dict</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">read_prev_trailer</span><span class="s2">(</span><span class="s1">trailer_dict</span><span class="s2">[</span><span class="s7">b&quot;Prev&quot;</span><span class="s2">])</span>

    <span class="s1">re_whitespace_optional </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional</span><span class="s2">)</span>
    <span class="s1">re_name </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;/([!-$&amp;'*-.0-;=?-Z\\^-z|~]+)(?=&quot;</span>
        <span class="s2">+ </span><span class="s1">delimiter_or_ws</span>
        <span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_dict_start </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;&lt;&lt;&quot;</span><span class="s2">)</span>
    <span class="s1">re_dict_end </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;&gt;&gt;&quot; </span><span class="s2">+ </span><span class="s1">whitespace_optional</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">interpret_trailer</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">trailer_data</span><span class="s2">):</span>
        <span class="s1">trailer </span><span class="s2">= {}</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_name</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_dict_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
                <span class="s1">check_format_condition</span><span class="s2">(</span>
                    <span class="s1">m </span><span class="s0">and </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">() == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">),</span>
                    <span class="s4">&quot;name not found in trailer, remaining data: &quot;</span>
                    <span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">[</span><span class="s1">offset</span><span class="s2">:]),</span>
                <span class="s2">)</span>
                <span class="s0">break</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">interpret_name</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>
            <span class="s1">value</span><span class="s2">, </span><span class="s1">offset </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get_value</span><span class="s2">(</span><span class="s1">trailer_data</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">())</span>
            <span class="s1">trailer</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s7">b&quot;Size&quot; </span><span class="s0">in </span><span class="s1">trailer </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">trailer</span><span class="s2">[</span><span class="s7">b&quot;Size&quot;</span><span class="s2">], </span><span class="s1">int</span><span class="s2">),</span>
            <span class="s4">&quot;/Size not in trailer or not an integer&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s7">b&quot;Root&quot; </span><span class="s0">in </span><span class="s1">trailer </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">trailer</span><span class="s2">[</span><span class="s7">b&quot;Root&quot;</span><span class="s2">], </span><span class="s1">IndirectReference</span><span class="s2">),</span>
            <span class="s4">&quot;/Root not in trailer or not an indirect reference&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">trailer</span>

    <span class="s1">re_hashes_in_name </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s7">rb&quot;([^#]*)(#([0-9a-fA-F]{2}))?&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">interpret_name</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">, </span><span class="s1">as_text</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s7">b&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">m </span><span class="s0">in </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_hashes_in_name</span><span class="s2">.</span><span class="s1">finditer</span><span class="s2">(</span><span class="s1">raw</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">3</span><span class="s2">):</span>
                <span class="s1">name </span><span class="s2">+= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) + </span><span class="s1">bytearray</span><span class="s2">.</span><span class="s1">fromhex</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">3</span><span class="s2">).</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">+= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">as_text</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">name</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s1">re_null </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;null(?=&quot; </span><span class="s2">+ </span><span class="s1">delimiter_or_ws </span><span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span><span class="s2">)</span>
    <span class="s1">re_true </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;true(?=&quot; </span><span class="s2">+ </span><span class="s1">delimiter_or_ws </span><span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span><span class="s2">)</span>
    <span class="s1">re_false </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;false(?=&quot; </span><span class="s2">+ </span><span class="s1">delimiter_or_ws </span><span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span><span class="s2">)</span>
    <span class="s1">re_int </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;([-+]?[0-9]+)(?=&quot; </span><span class="s2">+ </span><span class="s1">delimiter_or_ws </span><span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_real </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([-+]?([0-9]+\.[0-9]*|[0-9]*\.[0-9]+))(?=&quot;</span>
        <span class="s2">+ </span><span class="s1">delimiter_or_ws</span>
        <span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_array_start </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;\[&quot;</span><span class="s2">)</span>
    <span class="s1">re_array_end </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;]&quot;</span><span class="s2">)</span>
    <span class="s1">re_string_hex </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;&lt;(&quot; </span><span class="s2">+ </span><span class="s1">whitespace_or_hex </span><span class="s2">+ </span><span class="s7">rb&quot;*)&gt;&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_string_lit </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;\(&quot;</span><span class="s2">)</span>
    <span class="s1">re_indirect_reference </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([-+]?[0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_mandatory</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([-+]?[0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_mandatory</span>
        <span class="s2">+ </span><span class="s7">rb&quot;R(?=&quot;</span>
        <span class="s2">+ </span><span class="s1">delimiter_or_ws</span>
        <span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_indirect_def_start </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([-+]?[0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_mandatory</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([-+]?[0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_mandatory</span>
        <span class="s2">+ </span><span class="s7">rb&quot;obj(?=&quot;</span>
        <span class="s2">+ </span><span class="s1">delimiter_or_ws</span>
        <span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_indirect_def_end </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;endobj(?=&quot; </span><span class="s2">+ </span><span class="s1">delimiter_or_ws </span><span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_comment </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s7">rb&quot;(&quot; </span><span class="s2">+ </span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;%[^\r\n]*&quot; </span><span class="s2">+ </span><span class="s1">newline </span><span class="s2">+ </span><span class="s7">rb&quot;)*&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_stream_start </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;stream\r?\n&quot;</span><span class="s2">)</span>
    <span class="s1">re_stream_end </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;endstream(?=&quot; </span><span class="s2">+ </span><span class="s1">delimiter_or_ws </span><span class="s2">+ </span><span class="s7">rb&quot;)&quot;</span>
    <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">get_value</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">expect_indirect</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">max_nesting</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">max_nesting </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s0">return None</span><span class="s2">, </span><span class="s0">None</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_comment</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_indirect_def_start</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">check_format_condition</span><span class="s2">(</span>
                <span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)) &gt; </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s4">&quot;indirect object definition: object ID must be greater than 0&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">check_format_condition</span><span class="s2">(</span>
                <span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s4">&quot;indirect object definition: generation must be non-negative&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">check_format_condition</span><span class="s2">(</span>
                <span class="s1">expect_indirect </span><span class="s0">is None</span>
                <span class="s0">or </span><span class="s1">expect_indirect</span>
                <span class="s2">== </span><span class="s1">IndirectReference</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))),</span>
                <span class="s4">&quot;indirect object definition different than expected&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">object</span><span class="s2">, </span><span class="s1">offset </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get_value</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">(), </span><span class="s1">max_nesting</span><span class="s2">=</span><span class="s1">max_nesting </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">offset </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">object</span><span class="s2">, </span><span class="s0">None</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_indirect_def_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">&quot;indirect object definition end not found&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">object</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">expect_indirect</span><span class="s2">, </span><span class="s4">&quot;indirect object definition not found&quot;</span>
        <span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_indirect_reference</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">check_format_condition</span><span class="s2">(</span>
                <span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)) &gt; </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s4">&quot;indirect object reference: object ID must be greater than 0&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">check_format_condition</span><span class="s2">(</span>
                <span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s4">&quot;indirect object reference: generation must be non-negative&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">IndirectReference</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))), </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_dict_start</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
            <span class="s1">result </span><span class="s2">= {}</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_dict_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">while not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s1">key</span><span class="s2">, </span><span class="s1">offset </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get_value</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">max_nesting</span><span class="s2">=</span><span class="s1">max_nesting </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">offset </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">result</span><span class="s2">, </span><span class="s0">None</span>
                <span class="s1">value</span><span class="s2">, </span><span class="s1">offset </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get_value</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">max_nesting</span><span class="s2">=</span><span class="s1">max_nesting </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">value</span>
                <span class="s0">if </span><span class="s1">offset </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">result</span><span class="s2">, </span><span class="s0">None</span>
                <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_dict_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_stream_start</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">stream_len_str </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s7">b&quot;Length&quot;</span><span class="s2">)</span>
                    <span class="s1">stream_len </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">stream_len_str</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;bad or missing Length in stream dict (</span><span class="s0">{</span><span class="s1">stream_len_str</span><span class="s0">}</span><span class="s4">)&quot;</span>
                    <span class="s0">raise </span><span class="s1">PdfFormatError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">) </span><span class="s0">from </span><span class="s1">e</span>
                <span class="s1">stream_data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">() : </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">() + </span><span class="s1">stream_len</span><span class="s2">]</span>
                <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_stream_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">() + </span><span class="s1">stream_len</span><span class="s2">)</span>
                <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">&quot;stream end not found&quot;</span><span class="s2">)</span>
                <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">PdfStream</span><span class="s2">(</span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">result</span><span class="s2">), </span><span class="s1">stream_data</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">result </span><span class="s2">= </span><span class="s1">PdfDict</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">result</span><span class="s2">, </span><span class="s1">offset</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_array_start</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
            <span class="s1">result </span><span class="s2">= []</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_array_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">while not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s1">value</span><span class="s2">, </span><span class="s1">offset </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get_value</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">max_nesting</span><span class="s2">=</span><span class="s1">max_nesting </span><span class="s2">- </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">offset </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">result</span><span class="s2">, </span><span class="s0">None</span>
                <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_array_end</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">result</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_null</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return None</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_true</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return True</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_false</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return False</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_name</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">PdfName</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">interpret_name</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))), </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_int</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)), </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_real</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s3"># XXX Decimal instead of float???</span>
            <span class="s0">return </span><span class="s1">float</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)), </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_string_hex</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s3"># filter out whitespace</span>
            <span class="s1">hex_string </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span>
                <span class="s1">b </span><span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) </span><span class="s0">if </span><span class="s1">b </span><span class="s0">in </span><span class="s7">b&quot;0123456789abcdefABCDEF&quot;</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">hex_string</span><span class="s2">) % </span><span class="s5">2 </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
                <span class="s3"># append a 0 if the length is not even - yes, at the end</span>
                <span class="s1">hex_string</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;0&quot;</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">bytearray</span><span class="s2">.</span><span class="s1">fromhex</span><span class="s2">(</span><span class="s1">hex_string</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;us-ascii&quot;</span><span class="s2">)), </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_string_lit</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">get_literal_string</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">())</span>
        <span class="s3"># return None, offset  # fallback (only for debugging)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">f&quot;unrecognized object: </span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset </span><span class="s2">: </span><span class="s1">offset </span><span class="s2">+ </span><span class="s5">32</span><span class="s2">])</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s0">raise </span><span class="s1">PdfFormatError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s1">re_lit_str_token </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s7">rb&quot;(\\[nrtbf()\\])|(\\[0-9]{1,3})|(\\(\r\n|\r|\n))|(\r\n|\r|\n)|(\()|(\))&quot;</span>
    <span class="s2">)</span>
    <span class="s1">escaped_chars </span><span class="s2">= {</span>
        <span class="s7">b&quot;n&quot;</span><span class="s2">: </span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;r&quot;</span><span class="s2">: </span><span class="s7">b&quot;</span><span class="s0">\r</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;t&quot;</span><span class="s2">: </span><span class="s7">b&quot;</span><span class="s0">\t</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;b&quot;</span><span class="s2">: </span><span class="s7">b&quot;</span><span class="s0">\b</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;f&quot;</span><span class="s2">: </span><span class="s7">b&quot;</span><span class="s0">\f</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;(&quot;</span><span class="s2">: </span><span class="s7">b&quot;(&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;)&quot;</span><span class="s2">: </span><span class="s7">b&quot;)&quot;</span><span class="s2">,</span>
        <span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">&quot;</span><span class="s2">: </span><span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;n&quot;</span><span class="s2">): </span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;r&quot;</span><span class="s2">): </span><span class="s7">b&quot;</span><span class="s0">\r</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;t&quot;</span><span class="s2">): </span><span class="s7">b&quot;</span><span class="s0">\t</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;b&quot;</span><span class="s2">): </span><span class="s7">b&quot;</span><span class="s0">\b</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;f&quot;</span><span class="s2">): </span><span class="s7">b&quot;</span><span class="s0">\f</span><span class="s7">&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;(&quot;</span><span class="s2">): </span><span class="s7">b&quot;(&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;)&quot;</span><span class="s2">): </span><span class="s7">b&quot;)&quot;</span><span class="s2">,</span>
        <span class="s1">ord</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">&quot;</span><span class="s2">): </span><span class="s7">b&quot;</span><span class="s0">\\</span><span class="s7">&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">get_literal_string</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">):</span>
        <span class="s1">nesting_depth </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">m </span><span class="s0">in </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">re_lit_str_token</span><span class="s2">.</span><span class="s1">finditer</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">):</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s1">offset </span><span class="s2">: </span><span class="s1">m</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()])</span>
            <span class="s0">if </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">):</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">escaped_chars</span><span class="s2">[</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">]])</span>
            <span class="s0">elif </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">):</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:], </span><span class="s5">8</span><span class="s2">))</span>
            <span class="s0">elif </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">3</span><span class="s2">):</span>
                <span class="s0">pass</span>
            <span class="s0">elif </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">5</span><span class="s2">):</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">6</span><span class="s2">):</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot;(&quot;</span><span class="s2">)</span>
                <span class="s1">nesting_depth </span><span class="s2">+= </span><span class="s5">1</span>
            <span class="s0">elif </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">7</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">nesting_depth </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">result</span><span class="s2">), </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s7">b&quot;)&quot;</span><span class="s2">)</span>
                <span class="s1">nesting_depth </span><span class="s2">-= </span><span class="s5">1</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;unfinished literal string&quot;</span>
        <span class="s0">raise </span><span class="s1">PdfFormatError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s1">re_xref_section_start </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">whitespace_optional </span><span class="s2">+ </span><span class="s7">rb&quot;xref&quot; </span><span class="s2">+ </span><span class="s1">newline</span><span class="s2">)</span>
    <span class="s1">re_xref_subsection_start </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span>
        <span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_mandatory</span>
        <span class="s2">+ </span><span class="s7">rb&quot;([0-9]+)&quot;</span>
        <span class="s2">+ </span><span class="s1">whitespace_optional</span>
        <span class="s2">+ </span><span class="s1">newline_only</span>
    <span class="s2">)</span>
    <span class="s1">re_xref_entry </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s7">rb&quot;([0-9]{10}) ([0-9]{5}) ([fn])( \r| \n|\r\n)&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read_xref_table</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xref_section_offset</span><span class="s2">):</span>
        <span class="s1">subsection_found </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">re_xref_section_start</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">xref_section_offset </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_offset</span>
        <span class="s2">)</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">&quot;xref section start not found&quot;</span><span class="s2">)</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
        <span class="s0">while True</span><span class="s2">:</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">re_xref_subsection_start</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
                <span class="s1">check_format_condition</span><span class="s2">(</span>
                    <span class="s1">subsection_found</span><span class="s2">, </span><span class="s4">&quot;xref subsection start not found&quot;</span>
                <span class="s2">)</span>
                <span class="s0">break</span>
            <span class="s1">subsection_found </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
            <span class="s1">first_object </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>
            <span class="s1">num_objects </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">first_object</span><span class="s2">, </span><span class="s1">first_object </span><span class="s2">+ </span><span class="s1">num_objects</span><span class="s2">):</span>
                <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">re_xref_entry</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
                <span class="s1">check_format_condition</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s4">&quot;xref entry not found&quot;</span><span class="s2">)</span>
                <span class="s1">offset </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>
                <span class="s1">is_free </span><span class="s2">= </span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">3</span><span class="s2">) == </span><span class="s7">b&quot;f&quot;</span>
                <span class="s0">if not </span><span class="s1">is_free</span><span class="s2">:</span>
                    <span class="s1">generation </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
                    <span class="s1">new_entry </span><span class="s2">= (</span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)), </span><span class="s1">generation</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">i </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">new_entry</span>
        <span class="s0">return </span><span class="s1">offset</span>

    <span class="s0">def </span><span class="s1">read_indirect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">max_nesting</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">):</span>
        <span class="s1">offset</span><span class="s2">, </span><span class="s1">generation </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xref_table</span><span class="s2">[</span><span class="s1">ref</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]]</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s1">generation </span><span class="s2">== </span><span class="s1">ref</span><span class="s2">[</span><span class="s5">1</span><span class="s2">],</span>
            <span class="s4">f&quot;expected to find generation </span><span class="s0">{</span><span class="s1">ref</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span><span class="s0">} </span><span class="s4">for object ID </span><span class="s0">{</span><span class="s1">ref</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span><span class="s0">} </span><span class="s4">in xref &quot;</span>
            <span class="s4">f&quot;table, instead found generation </span><span class="s0">{</span><span class="s1">generation</span><span class="s0">} </span><span class="s4">at offset </span><span class="s0">{</span><span class="s1">offset</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_value</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">buf</span><span class="s2">,</span>
            <span class="s1">offset </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">start_offset</span><span class="s2">,</span>
            <span class="s1">expect_indirect</span><span class="s2">=</span><span class="s1">IndirectReference</span><span class="s2">(*</span><span class="s1">ref</span><span class="s2">),</span>
            <span class="s1">max_nesting</span><span class="s2">=</span><span class="s1">max_nesting</span><span class="s2">,</span>
        <span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">cached_objects</span><span class="s2">[</span><span class="s1">ref</span><span class="s2">] = </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">linearize_page_tree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">node</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">node </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">node </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">page_tree_root</span>
        <span class="s1">check_format_condition</span><span class="s2">(</span>
            <span class="s1">node</span><span class="s2">[</span><span class="s7">b&quot;Type&quot;</span><span class="s2">] == </span><span class="s7">b&quot;Pages&quot;</span><span class="s2">, </span><span class="s4">&quot;/Type of page tree node is not /Pages&quot;</span>
        <span class="s2">)</span>
        <span class="s1">pages </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">kid </span><span class="s0">in </span><span class="s1">node</span><span class="s2">[</span><span class="s7">b&quot;Kids&quot;</span><span class="s2">]:</span>
            <span class="s1">kid_object </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_indirect</span><span class="s2">(</span><span class="s1">kid</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">kid_object</span><span class="s2">[</span><span class="s7">b&quot;Type&quot;</span><span class="s2">] == </span><span class="s7">b&quot;Page&quot;</span><span class="s2">:</span>
                <span class="s1">pages</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">kid</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">pages</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">linearize_page_tree</span><span class="s2">(</span><span class="s1">node</span><span class="s2">=</span><span class="s1">kid_object</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">pages</span>
</pre>
</body>
</html>