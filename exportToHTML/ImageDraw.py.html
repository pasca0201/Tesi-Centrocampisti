<html>
<head>
<title>ImageDraw.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ImageDraw.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># The Python Imaging Library</span>
<span class="s0"># $Id$</span>
<span class="s0">#</span>
<span class="s0"># drawing interface operations</span>
<span class="s0">#</span>
<span class="s0"># History:</span>
<span class="s0"># 1996-04-13 fl   Created (experimental)</span>
<span class="s0"># 1996-08-07 fl   Filled polygons, ellipses.</span>
<span class="s0"># 1996-08-13 fl   Added text support</span>
<span class="s0"># 1998-06-28 fl   Handle I and F images</span>
<span class="s0"># 1998-12-29 fl   Added arc; use arc primitive to draw ellipses</span>
<span class="s0"># 1999-01-10 fl   Added shape stuff (experimental)</span>
<span class="s0"># 1999-02-06 fl   Added bitmap support</span>
<span class="s0"># 1999-02-11 fl   Changed all primitives to take options</span>
<span class="s0"># 1999-02-20 fl   Fixed backwards compatibility</span>
<span class="s0"># 2000-10-12 fl   Copy on write, when necessary</span>
<span class="s0"># 2001-02-18 fl   Use default ink for bitmap/text also in fill mode</span>
<span class="s0"># 2002-10-24 fl   Added support for CSS-style color strings</span>
<span class="s0"># 2002-12-10 fl   Added experimental support for RGBA-on-RGB drawing</span>
<span class="s0"># 2002-12-11 fl   Refactored low-level drawing API (work in progress)</span>
<span class="s0"># 2004-08-26 fl   Made Draw() a factory function, added getdraw() support</span>
<span class="s0"># 2004-09-04 fl   Added width support to line primitive</span>
<span class="s0"># 2004-09-10 fl   Added font mode handling</span>
<span class="s0"># 2006-06-19 fl   Added font bearing support (getmask2)</span>
<span class="s0">#</span>
<span class="s0"># Copyright (c) 1997-2006 by Secret Labs AB</span>
<span class="s0"># Copyright (c) 1996-2006 by Fredrik Lundh</span>
<span class="s0">#</span>
<span class="s0"># See the README file for information on usage and redistribution.</span>
<span class="s0">#</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">math</span>
<span class="s2">import </span><span class="s1">numbers</span>
<span class="s2">import </span><span class="s1">struct</span>
<span class="s2">from </span><span class="s1">types </span><span class="s2">import </span><span class="s1">ModuleType</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">TYPE_CHECKING</span><span class="s3">, </span><span class="s1">AnyStr</span><span class="s3">, </span><span class="s1">Callable</span><span class="s3">, </span><span class="s1">List</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">, </span><span class="s1">Union</span><span class="s3">, </span><span class="s1">cast</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">Image</span><span class="s3">, </span><span class="s1">ImageColor</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_deprecate </span><span class="s2">import </span><span class="s1">deprecate</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_typing </span><span class="s2">import </span><span class="s1">Coords</span>

<span class="s0"># experimental access to the outline API</span>
<span class="s1">Outline</span><span class="s3">: </span><span class="s1">Callable</span><span class="s3">[[], </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">_Outline</span><span class="s3">] | </span><span class="s2">None</span>
<span class="s2">try</span><span class="s3">:</span>
    <span class="s1">Outline </span><span class="s3">= </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">outline</span>
<span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
    <span class="s1">Outline </span><span class="s3">= </span><span class="s2">None</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">ImageDraw2</span><span class="s3">, </span><span class="s1">ImageFont</span>

<span class="s1">_Ink </span><span class="s3">= </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, ...], </span><span class="s1">str</span><span class="s3">]</span>

<span class="s4">&quot;&quot;&quot; 
A simple 2D drawing interface for PIL images. 
&lt;p&gt; 
Application code should use the &lt;b&gt;Draw&lt;/b&gt; factory, instead of 
directly. 
&quot;&quot;&quot;</span>


<span class="s2">class </span><span class="s1">ImageDraw</span><span class="s3">:</span>
    <span class="s1">font</span><span class="s3">: (</span>
        <span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">ImageFont </span><span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">FreeTypeFont </span><span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">TransposedFont </span><span class="s3">| </span><span class="s2">None</span>
    <span class="s3">) = </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">im</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Create a drawing instance. 
 
        :param im: The image to draw in. 
        :param mode: Optional mode to use for color values.  For RGB 
           images, this argument can be RGB or RGBA (to blend the 
           drawing into the image).  For all other modes, this argument 
           must be the same as the image mode.  If omitted, the mode 
           defaults to the mode of the image. 
        &quot;&quot;&quot;</span>
        <span class="s1">im</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">readonly</span><span class="s3">:</span>
            <span class="s1">im</span><span class="s3">.</span><span class="s1">_copy</span><span class="s3">()  </span><span class="s0"># make it writeable</span>
        <span class="s1">blend </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">mode </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s3">!= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;RGBA&quot; </span><span class="s2">and </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;RGB&quot;</span><span class="s3">:</span>
                <span class="s1">blend </span><span class="s3">= </span><span class="s6">1</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;mode mismatch&quot;</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;P&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">palette </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">palette</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">palette </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_image </span><span class="s3">= </span><span class="s1">im</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">im</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">draw </span><span class="s3">= </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">, </span><span class="s1">blend</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">= </span><span class="s1">mode</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;I&quot;</span><span class="s3">, </span><span class="s4">&quot;F&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_ink</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_ink</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">mode </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;1&quot;</span><span class="s3">, </span><span class="s4">&quot;P&quot;</span><span class="s3">, </span><span class="s4">&quot;I&quot;</span><span class="s3">, </span><span class="s4">&quot;F&quot;</span><span class="s3">):</span>
            <span class="s0"># FIXME: fix Fill2 to properly support matte for I+F images</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fontmode </span><span class="s3">= </span><span class="s4">&quot;1&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fontmode </span><span class="s3">= </span><span class="s4">&quot;L&quot;  </span><span class="s0"># aliasing is okay for other modes</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fill </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">getfont</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; ImageFont</span><span class="s3">.</span><span class="s1">ImageFont </span><span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">FreeTypeFont </span><span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">TransposedFont</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot; 
        Get the current default font. 
 
        To set the default font for this ImageDraw instance:: 
 
            from PIL import ImageDraw, ImageFont 
            draw.font = ImageFont.truetype(&quot;Tests/fonts/FreeMono.ttf&quot;) 
 
        To set the default font for all future ImageDraw instances:: 
 
            from PIL import ImageDraw, ImageFont 
            ImageDraw.ImageDraw.font = ImageFont.truetype(&quot;Tests/fonts/FreeMono.ttf&quot;) 
 
        If the current default font is ``None``, 
        it is initialized with ``ImageFont.load_default()``. 
 
        :returns: An image font.&quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">font</span><span class="s3">:</span>
            <span class="s0"># FIXME: should add a font repository</span>
            <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">ImageFont</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">font </span><span class="s3">= </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">load_default</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">font</span>

    <span class="s2">def </span><span class="s1">_getfont</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">font_size</span><span class="s3">: </span><span class="s1">float </span><span class="s3">| </span><span class="s2">None</span>
    <span class="s3">) </span><span class="s1">-&gt; ImageFont</span><span class="s3">.</span><span class="s1">ImageFont </span><span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">FreeTypeFont </span><span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">TransposedFont</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">font_size </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">ImageFont</span>

            <span class="s2">return </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">load_default</span><span class="s3">(</span><span class="s1">font_size</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getfont</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_getink</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">int </span><span class="s3">| </span><span class="s2">None</span><span class="s3">, </span><span class="s1">int </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s1">result_ink </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">result_fill </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is None and </span><span class="s1">fill </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fill</span><span class="s3">:</span>
                <span class="s1">result_fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ink</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">result_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ink</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                    <span class="s1">ink </span><span class="s3">= </span><span class="s1">ImageColor</span><span class="s3">.</span><span class="s1">getcolor</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">palette </span><span class="s2">and not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">, </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">Number</span><span class="s3">):</span>
                    <span class="s1">ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">palette</span><span class="s3">.</span><span class="s1">getcolor</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_image</span><span class="s3">)</span>
                <span class="s1">result_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_ink</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">fill </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                    <span class="s1">fill </span><span class="s3">= </span><span class="s1">ImageColor</span><span class="s3">.</span><span class="s1">getcolor</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">palette </span><span class="s2">and not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">, </span><span class="s1">numbers</span><span class="s3">.</span><span class="s1">Number</span><span class="s3">):</span>
                    <span class="s1">fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">palette</span><span class="s3">.</span><span class="s1">getcolor</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_image</span><span class="s3">)</span>
                <span class="s1">result_fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_ink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result_ink</span><span class="s3">, </span><span class="s1">result_fill</span>

    <span class="s2">def </span><span class="s1">arc</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">start</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">end</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw an arc.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_arc</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">bitmap</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">xy</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">bitmap</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a bitmap.&quot;&quot;&quot;</span>
        <span class="s1">bitmap</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">ink </span><span class="s3">= </span><span class="s1">fill</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_bitmap</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">bitmap</span><span class="s3">.</span><span class="s1">im</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">chord</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">start</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">end</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a chord.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_chord</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink </span><span class="s2">and </span><span class="s1">width </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_chord</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">ellipse</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw an ellipse.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_ellipse</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink </span><span class="s2">and </span><span class="s1">width </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_ellipse</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">circle</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">],</span>
        <span class="s1">radius</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a circle given center coordinates and a radius.&quot;&quot;&quot;</span>
        <span class="s1">ellipse_xy </span><span class="s3">= (</span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] - </span><span class="s1">radius</span><span class="s3">, </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] - </span><span class="s1">radius</span><span class="s3">, </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s1">radius</span><span class="s3">, </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s1">radius</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ellipse</span><span class="s3">(</span><span class="s1">ellipse_xy</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">, </span><span class="s1">outline</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">line</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">joint</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a line, or a connected sequence of line segments.&quot;&quot;&quot;</span>
        <span class="s1">ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_lines</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">joint </span><span class="s3">== </span><span class="s4">&quot;curve&quot; </span><span class="s2">and </span><span class="s1">width </span><span class="s3">&gt; </span><span class="s6">4</span><span class="s3">:</span>
                <span class="s1">points</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">]]</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
                    <span class="s1">points </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">]], </span><span class="s1">xy</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">points </span><span class="s3">= [</span>
                        <span class="s1">cast</span><span class="s3">(</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">], </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s1">i </span><span class="s3">: </span><span class="s1">i </span><span class="s3">+ </span><span class="s6">2</span><span class="s3">]))</span>
                        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">), </span><span class="s6">2</span><span class="s3">)</span>
                    <span class="s3">]</span>
                <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">points</span><span class="s3">) - </span><span class="s6">1</span><span class="s3">):</span>
                    <span class="s1">point </span><span class="s3">= </span><span class="s1">points</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
                    <span class="s1">angles </span><span class="s3">= [</span>
                        <span class="s1">math</span><span class="s3">.</span><span class="s1">degrees</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">atan2</span><span class="s3">(</span><span class="s1">end</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] - </span><span class="s1">start</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">start</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] - </span><span class="s1">end</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]))</span>
                        <span class="s3">% </span><span class="s6">360</span>
                        <span class="s2">for </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end </span><span class="s2">in </span><span class="s3">(</span>
                            <span class="s3">(</span><span class="s1">points</span><span class="s3">[</span><span class="s1">i </span><span class="s3">- </span><span class="s6">1</span><span class="s3">], </span><span class="s1">point</span><span class="s3">),</span>
                            <span class="s3">(</span><span class="s1">point</span><span class="s3">, </span><span class="s1">points</span><span class="s3">[</span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">]),</span>
                        <span class="s3">)</span>
                    <span class="s3">]</span>
                    <span class="s2">if </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                        <span class="s0"># This is a straight line, so no joint is required</span>
                        <span class="s2">continue</span>

                    <span class="s2">def </span><span class="s1">coord_at_angle</span><span class="s3">(</span>
                        <span class="s1">coord</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">], </span><span class="s1">angle</span><span class="s3">: </span><span class="s1">float</span>
                    <span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, ...]:</span>
                        <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">coord</span>
                        <span class="s1">angle </span><span class="s3">-= </span><span class="s6">90</span>
                        <span class="s1">distance </span><span class="s3">= </span><span class="s1">width </span><span class="s3">/ </span><span class="s6">2 </span><span class="s3">- </span><span class="s6">1</span>
                        <span class="s2">return </span><span class="s1">tuple</span><span class="s3">(</span>
                            <span class="s1">p </span><span class="s3">+ (</span><span class="s1">math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">p_d</span><span class="s3">) </span><span class="s2">if </span><span class="s1">p_d </span><span class="s3">&gt; </span><span class="s6">0 </span><span class="s2">else </span><span class="s1">math</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">(</span><span class="s1">p_d</span><span class="s3">))</span>
                            <span class="s2">for </span><span class="s1">p</span><span class="s3">, </span><span class="s1">p_d </span><span class="s2">in </span><span class="s3">(</span>
                                <span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">distance </span><span class="s3">* </span><span class="s1">math</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">radians</span><span class="s3">(</span><span class="s1">angle</span><span class="s3">))),</span>
                                <span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">distance </span><span class="s3">* </span><span class="s1">math</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">radians</span><span class="s3">(</span><span class="s1">angle</span><span class="s3">))),</span>
                            <span class="s3">)</span>
                        <span class="s3">)</span>

                    <span class="s1">flipped </span><span class="s3">= (</span>
                        <span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] &gt; </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">and </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] - </span><span class="s6">180 </span><span class="s3">&gt; </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
                    <span class="s3">) </span><span class="s2">or </span><span class="s3">(</span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] &lt; </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">and </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s6">180 </span><span class="s3">&gt; </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
                    <span class="s1">coords </span><span class="s3">= [</span>
                        <span class="s3">(</span><span class="s1">point</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] - </span><span class="s1">width </span><span class="s3">/ </span><span class="s6">2 </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">point</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] - </span><span class="s1">width </span><span class="s3">/ </span><span class="s6">2 </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">),</span>
                        <span class="s3">(</span><span class="s1">point</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s1">width </span><span class="s3">/ </span><span class="s6">2 </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s1">point</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s1">width </span><span class="s3">/ </span><span class="s6">2 </span><span class="s3">- </span><span class="s6">1</span><span class="s3">),</span>
                    <span class="s3">]</span>
                    <span class="s2">if </span><span class="s1">flipped</span><span class="s3">:</span>
                        <span class="s1">start</span><span class="s3">, </span><span class="s1">end </span><span class="s3">= (</span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s6">90</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s6">90</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">start</span><span class="s3">, </span><span class="s1">end </span><span class="s3">= (</span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] - </span><span class="s6">90</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] - </span><span class="s6">90</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">pieslice</span><span class="s3">(</span><span class="s1">coords</span><span class="s3">, </span><span class="s1">start </span><span class="s3">- </span><span class="s6">90</span><span class="s3">, </span><span class="s1">end </span><span class="s3">- </span><span class="s6">90</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>

                    <span class="s2">if </span><span class="s1">width </span><span class="s3">&gt; </span><span class="s6">8</span><span class="s3">:</span>
                        <span class="s0"># Cover potential gaps between the line and the joint</span>
                        <span class="s2">if </span><span class="s1">flipped</span><span class="s3">:</span>
                            <span class="s1">gap_coords </span><span class="s3">= [</span>
                                <span class="s1">coord_at_angle</span><span class="s3">(</span><span class="s1">point</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s6">90</span><span class="s3">),</span>
                                <span class="s1">point</span><span class="s3">,</span>
                                <span class="s1">coord_at_angle</span><span class="s3">(</span><span class="s1">point</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s6">90</span><span class="s3">),</span>
                            <span class="s3">]</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s1">gap_coords </span><span class="s3">= [</span>
                                <span class="s1">coord_at_angle</span><span class="s3">(</span><span class="s1">point</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] - </span><span class="s6">90</span><span class="s3">),</span>
                                <span class="s1">point</span><span class="s3">,</span>
                                <span class="s1">coord_at_angle</span><span class="s3">(</span><span class="s1">point</span><span class="s3">, </span><span class="s1">angles</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] - </span><span class="s6">90</span><span class="s3">),</span>
                            <span class="s3">]</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">gap_coords</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">, </span><span class="s1">width</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">shape</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">shape</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">_Outline</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;(Experimental) Draw a shape.&quot;&quot;&quot;</span>
        <span class="s1">shape</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_outline</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_outline</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pieslice</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">start</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">end</span><span class="s3">: </span><span class="s1">float</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a pieslice.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_pieslice</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink </span><span class="s2">and </span><span class="s1">width </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_pieslice</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">point</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw one or more individual pixels.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_points</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">polygon</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a polygon.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_polygon</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink </span><span class="s2">and </span><span class="s1">width </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">width </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_polygon</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s0"># To avoid expanding the polygon outwards,</span>
                <span class="s0"># use the fill as a mask</span>
                <span class="s1">mask </span><span class="s3">= </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">new</span><span class="s3">(</span><span class="s4">&quot;1&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
                <span class="s1">mask_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>

                <span class="s1">fill_im </span><span class="s3">= </span><span class="s1">mask</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
                <span class="s1">draw </span><span class="s3">= </span><span class="s1">Draw</span><span class="s3">(</span><span class="s1">fill_im</span><span class="s3">)</span>
                <span class="s1">draw</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_polygon</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">mask_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

                <span class="s1">ink_im </span><span class="s3">= </span><span class="s1">mask</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
                <span class="s1">draw </span><span class="s3">= </span><span class="s1">Draw</span><span class="s3">(</span><span class="s1">ink_im</span><span class="s3">)</span>
                <span class="s1">width </span><span class="s3">= </span><span class="s1">width </span><span class="s3">* </span><span class="s6">2 </span><span class="s3">- </span><span class="s6">1</span>
                <span class="s1">draw</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_polygon</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">mask_ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

                <span class="s1">mask</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">(</span><span class="s1">ink_im</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">=</span><span class="s1">fill_im</span><span class="s3">)</span>

                <span class="s1">im </span><span class="s3">= </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">new</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
                <span class="s1">draw </span><span class="s3">= </span><span class="s1">Draw</span><span class="s3">(</span><span class="s1">im</span><span class="s3">)</span>
                <span class="s1">draw</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_polygon</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">(</span><span class="s1">im</span><span class="s3">.</span><span class="s1">im</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">) + </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">.</span><span class="s1">im</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">regular_polygon</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">bounding_circle</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">] | </span><span class="s1">float</span><span class="s3">],</span>
        <span class="s1">n_sides</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">rotation</span><span class="s3">: </span><span class="s1">float </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a regular polygon.&quot;&quot;&quot;</span>
        <span class="s1">xy </span><span class="s3">= </span><span class="s1">_compute_regular_polygon_vertices</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">, </span><span class="s1">n_sides</span><span class="s3">, </span><span class="s1">rotation</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">polygon</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">, </span><span class="s1">outline</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">rectangle</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a rectangle.&quot;&quot;&quot;</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink </span><span class="s2">and </span><span class="s1">width </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">rounded_rectangle</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">Coords</span><span class="s3">,</span>
        <span class="s1">radius</span><span class="s3">: </span><span class="s1">float </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">outline</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">width</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">corners</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw a rounded rectangle.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
            <span class="s3">(</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">), (</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">) = </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">]], </span><span class="s1">xy</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">], </span><span class="s1">xy</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">x1 </span><span class="s3">&lt; </span><span class="s1">x0</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;x1 must be greater than or equal to x0&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">y1 </span><span class="s3">&lt; </span><span class="s1">y0</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;y1 must be greater than or equal to y0&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">corners </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">corners </span><span class="s3">= (</span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">d </span><span class="s3">= </span><span class="s1">radius </span><span class="s3">* </span><span class="s6">2</span>

        <span class="s1">x0 </span><span class="s3">= </span><span class="s1">round</span><span class="s3">(</span><span class="s1">x0</span><span class="s3">)</span>
        <span class="s1">y0 </span><span class="s3">= </span><span class="s1">round</span><span class="s3">(</span><span class="s1">y0</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">round</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">)</span>
        <span class="s1">y1 </span><span class="s3">= </span><span class="s1">round</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">)</span>
        <span class="s1">full_x</span><span class="s3">, </span><span class="s1">full_y </span><span class="s3">= </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span>
        <span class="s2">if </span><span class="s1">all</span><span class="s3">(</span><span class="s1">corners</span><span class="s3">):</span>
            <span class="s1">full_x </span><span class="s3">= </span><span class="s1">d </span><span class="s3">&gt;= </span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">x0 </span><span class="s3">- </span><span class="s6">1</span>
            <span class="s2">if </span><span class="s1">full_x</span><span class="s3">:</span>
                <span class="s0"># The two left and two right corners are joined</span>
                <span class="s1">d </span><span class="s3">= </span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">x0</span>
            <span class="s1">full_y </span><span class="s3">= </span><span class="s1">d </span><span class="s3">&gt;= </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">y0 </span><span class="s3">- </span><span class="s6">1</span>
            <span class="s2">if </span><span class="s1">full_y</span><span class="s3">:</span>
                <span class="s0"># The two top and two bottom corners are joined</span>
                <span class="s1">d </span><span class="s3">= </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">y0</span>
            <span class="s2">if </span><span class="s1">full_x </span><span class="s2">and </span><span class="s1">full_y</span><span class="s3">:</span>
                <span class="s0"># If all corners are joined, that is a circle</span>
                <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ellipse</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">, </span><span class="s1">outline</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">d </span><span class="s3">== </span><span class="s6">0 </span><span class="s2">or not </span><span class="s1">any</span><span class="s3">(</span><span class="s1">corners</span><span class="s3">):</span>
            <span class="s0"># If the corners have no curve,</span>
            <span class="s0"># or there are no corners,</span>
            <span class="s0"># that is a rectangle</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rectangle</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">, </span><span class="s1">outline</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)</span>

        <span class="s1">r </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">d </span><span class="s3">// </span><span class="s6">2</span><span class="s3">)</span>
        <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">outline</span><span class="s3">, </span><span class="s1">fill</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">draw_corners</span><span class="s3">(</span><span class="s1">pieslice</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">parts</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">], </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">], ...]</span>
            <span class="s2">if </span><span class="s1">full_x</span><span class="s3">:</span>
                <span class="s0"># Draw top and bottom halves</span>
                <span class="s1">parts </span><span class="s3">= (</span>
                    <span class="s3">((</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">), </span><span class="s6">180</span><span class="s3">, </span><span class="s6">360</span><span class="s3">),</span>
                    <span class="s3">((</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">d</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s6">180</span><span class="s3">),</span>
                <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">full_y</span><span class="s3">:</span>
                <span class="s0"># Draw left and right halves</span>
                <span class="s1">parts </span><span class="s3">= (</span>
                    <span class="s3">((</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">), </span><span class="s6">90</span><span class="s3">, </span><span class="s6">270</span><span class="s3">),</span>
                    <span class="s3">((</span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">), </span><span class="s6">270</span><span class="s3">, </span><span class="s6">90</span><span class="s3">),</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s0"># Draw four separate corners</span>
                <span class="s1">parts </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span>
                    <span class="s1">part</span>
                    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">part </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span>
                        <span class="s3">(</span>
                            <span class="s3">((</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">), </span><span class="s6">180</span><span class="s3">, </span><span class="s6">270</span><span class="s3">),</span>
                            <span class="s3">((</span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">), </span><span class="s6">270</span><span class="s3">, </span><span class="s6">360</span><span class="s3">),</span>
                            <span class="s3">((</span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">d</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">), </span><span class="s6">0</span><span class="s3">, </span><span class="s6">90</span><span class="s3">),</span>
                            <span class="s3">((</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">d</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">d</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">), </span><span class="s6">90</span><span class="s3">, </span><span class="s6">180</span><span class="s3">),</span>
                        <span class="s3">)</span>
                    <span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
                <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">part </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">pieslice</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_pieslice</span><span class="s3">(*(</span><span class="s1">part </span><span class="s3">+ (</span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_arc</span><span class="s3">(*(</span><span class="s1">part </span><span class="s3">+ (</span><span class="s1">ink</span><span class="s3">, </span><span class="s1">width</span><span class="s3">)))</span>

        <span class="s2">if </span><span class="s1">fill_ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">draw_corners</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">full_x</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">((</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">r </span><span class="s3">- </span><span class="s6">1</span><span class="s3">), </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">((</span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">r </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">), </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">full_x </span><span class="s2">and not </span><span class="s1">full_y</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">= [</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">r</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]:</span>
                    <span class="s1">left</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] += </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">3</span><span class="s3">]:</span>
                    <span class="s1">left</span><span class="s3">[</span><span class="s6">3</span><span class="s3">] -= </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

                <span class="s1">right </span><span class="s3">= [</span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">r</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">right</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] += </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]:</span>
                    <span class="s1">right</span><span class="s3">[</span><span class="s6">3</span><span class="s3">] -= </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">right</span><span class="s3">, </span><span class="s1">fill_ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None and </span><span class="s1">ink </span><span class="s3">!= </span><span class="s1">fill_ink </span><span class="s2">and </span><span class="s1">width </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">draw_corners</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>

            <span class="s2">if not </span><span class="s1">full_x</span><span class="s3">:</span>
                <span class="s1">top </span><span class="s3">= [</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y0 </span><span class="s3">+ </span><span class="s1">width </span><span class="s3">- </span><span class="s6">1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]:</span>
                    <span class="s1">top</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] += </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">top</span><span class="s3">[</span><span class="s6">2</span><span class="s3">] -= </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">top</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

                <span class="s1">bottom </span><span class="s3">= [</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y1 </span><span class="s3">- </span><span class="s1">width </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">3</span><span class="s3">]:</span>
                    <span class="s1">bottom</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] += </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]:</span>
                    <span class="s1">bottom</span><span class="s3">[</span><span class="s6">2</span><span class="s3">] -= </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">bottom</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">full_y</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">= [</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x0 </span><span class="s3">+ </span><span class="s1">width </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]:</span>
                    <span class="s1">left</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] += </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">3</span><span class="s3">]:</span>
                    <span class="s1">left</span><span class="s3">[</span><span class="s6">3</span><span class="s3">] -= </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

                <span class="s1">right </span><span class="s3">= [</span><span class="s1">x1 </span><span class="s3">- </span><span class="s1">width </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">right</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] += </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">corners</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]:</span>
                    <span class="s1">right</span><span class="s3">[</span><span class="s6">3</span><span class="s3">] -= </span><span class="s1">r </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_rectangle</span><span class="s3">(</span><span class="s1">right</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_multiline_check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">: </span><span class="s1">AnyStr</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s1">split_character </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot; </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">else </span><span class="s7">b&quot;</span><span class="s2">\n</span><span class="s7">&quot;</span>

        <span class="s2">return </span><span class="s1">split_character </span><span class="s2">in </span><span class="s1">text</span>

    <span class="s2">def </span><span class="s1">_multiline_split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text</span><span class="s3">: </span><span class="s1">AnyStr</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">AnyStr</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot; </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">else </span><span class="s7">b&quot;</span><span class="s2">\n</span><span class="s7">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_multiline_spacing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">font</span><span class="s3">, </span><span class="s1">spacing</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">textbbox</span><span class="s3">((</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">), </span><span class="s4">&quot;A&quot;</span><span class="s3">, </span><span class="s1">font</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">=</span><span class="s1">stroke_width</span><span class="s3">)[</span><span class="s6">3</span><span class="s3">]</span>
            <span class="s3">+ </span><span class="s1">stroke_width</span>
            <span class="s3">+ </span><span class="s1">spacing</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">text</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">],</span>
        <span class="s1">text</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">font</span><span class="s3">: (</span>
            <span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">ImageFont</span>
            <span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">FreeTypeFont</span>
            <span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">TransposedFont</span>
            <span class="s3">| </span><span class="s2">None</span>
        <span class="s3">) = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">anchor</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">spacing</span><span class="s3">=</span><span class="s6">4</span><span class="s3">,</span>
        <span class="s1">align</span><span class="s3">=</span><span class="s4">&quot;left&quot;</span><span class="s3">,</span>
        <span class="s1">direction</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">language</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">stroke_width</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">stroke_fill</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">embedded_color</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">*</span><span class="s1">args</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Draw text.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">embedded_color </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s2">not in </span><span class="s3">(</span><span class="s4">&quot;RGB&quot;</span><span class="s3">, </span><span class="s4">&quot;RGBA&quot;</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Embedded color supported only in RGB and RGBA modes&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">font </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">font </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfont</span><span class="s3">(</span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;font_size&quot;</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_check</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline_text</span><span class="s3">(</span>
                <span class="s1">xy</span><span class="s3">,</span>
                <span class="s1">text</span><span class="s3">,</span>
                <span class="s1">fill</span><span class="s3">,</span>
                <span class="s1">font</span><span class="s3">,</span>
                <span class="s1">anchor</span><span class="s3">,</span>
                <span class="s1">spacing</span><span class="s3">,</span>
                <span class="s1">align</span><span class="s3">,</span>
                <span class="s1">direction</span><span class="s3">,</span>
                <span class="s1">features</span><span class="s3">,</span>
                <span class="s1">language</span><span class="s3">,</span>
                <span class="s1">stroke_width</span><span class="s3">,</span>
                <span class="s1">stroke_fill</span><span class="s3">,</span>
                <span class="s1">embedded_color</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s2">def </span><span class="s1">getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">: </span><span class="s1">_Ink </span><span class="s3">| </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
            <span class="s1">ink</span><span class="s3">, </span><span class="s1">fill_ink </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ink </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">fill_ink </span><span class="s2">is not None</span>
                <span class="s2">return </span><span class="s1">fill_ink</span>
            <span class="s2">return </span><span class="s1">ink</span>

        <span class="s2">def </span><span class="s1">draw_text</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">stroke_offset</span><span class="s3">=</span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">mode </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fontmode</span>
            <span class="s2">if </span><span class="s1">stroke_width </span><span class="s3">== </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">embedded_color</span><span class="s3">:</span>
                <span class="s1">mode </span><span class="s3">= </span><span class="s4">&quot;RGBA&quot;</span>
            <span class="s1">coord </span><span class="s3">= []</span>
            <span class="s1">start </span><span class="s3">= []</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">):</span>
                <span class="s1">coord</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]))</span>
                <span class="s1">start</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">modf</span><span class="s3">(</span><span class="s1">xy</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])[</span><span class="s6">0</span><span class="s3">])</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">mask</span><span class="s3">, </span><span class="s1">offset </span><span class="s3">= </span><span class="s1">font</span><span class="s3">.</span><span class="s1">getmask2</span><span class="s3">(  </span><span class="s0"># type: ignore[union-attr,misc]</span>
                    <span class="s1">text</span><span class="s3">,</span>
                    <span class="s1">mode</span><span class="s3">,</span>
                    <span class="s1">direction</span><span class="s3">=</span><span class="s1">direction</span><span class="s3">,</span>
                    <span class="s1">features</span><span class="s3">=</span><span class="s1">features</span><span class="s3">,</span>
                    <span class="s1">language</span><span class="s3">=</span><span class="s1">language</span><span class="s3">,</span>
                    <span class="s1">stroke_width</span><span class="s3">=</span><span class="s1">stroke_width</span><span class="s3">,</span>
                    <span class="s1">anchor</span><span class="s3">=</span><span class="s1">anchor</span><span class="s3">,</span>
                    <span class="s1">ink</span><span class="s3">=</span><span class="s1">ink</span><span class="s3">,</span>
                    <span class="s1">start</span><span class="s3">=</span><span class="s1">start</span><span class="s3">,</span>
                    <span class="s3">*</span><span class="s1">args</span><span class="s3">,</span>
                    <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">,</span>
                <span class="s3">)</span>
                <span class="s1">coord </span><span class="s3">= [</span><span class="s1">coord</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s1">offset</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">coord</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s1">offset</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]]</span>
            <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">mask </span><span class="s3">= </span><span class="s1">font</span><span class="s3">.</span><span class="s1">getmask</span><span class="s3">(  </span><span class="s0"># type: ignore[misc]</span>
                        <span class="s1">text</span><span class="s3">,</span>
                        <span class="s1">mode</span><span class="s3">,</span>
                        <span class="s1">direction</span><span class="s3">,</span>
                        <span class="s1">features</span><span class="s3">,</span>
                        <span class="s1">language</span><span class="s3">,</span>
                        <span class="s1">stroke_width</span><span class="s3">,</span>
                        <span class="s1">anchor</span><span class="s3">,</span>
                        <span class="s1">ink</span><span class="s3">,</span>
                        <span class="s1">start</span><span class="s3">=</span><span class="s1">start</span><span class="s3">,</span>
                        <span class="s3">*</span><span class="s1">args</span><span class="s3">,</span>
                        <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">,</span>
                    <span class="s3">)</span>
                <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
                    <span class="s1">mask </span><span class="s3">= </span><span class="s1">font</span><span class="s3">.</span><span class="s1">getmask</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">stroke_offset</span><span class="s3">:</span>
                <span class="s1">coord </span><span class="s3">= [</span><span class="s1">coord</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s1">stroke_offset</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">coord</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s1">stroke_offset</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]]</span>
            <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s4">&quot;RGBA&quot;</span><span class="s3">:</span>
                <span class="s0"># font.getmask2(mode=&quot;RGBA&quot;) returns color in RGB bands and mask in A</span>
                <span class="s0"># extract mask and set text alpha</span>
                <span class="s1">color</span><span class="s3">, </span><span class="s1">mask </span><span class="s3">= </span><span class="s1">mask</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">.</span><span class="s1">getband</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)</span>
                <span class="s1">ink_alpha </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">pack</span><span class="s3">(</span><span class="s4">&quot;i&quot;</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">)[</span><span class="s6">3</span><span class="s3">]</span>
                <span class="s1">color</span><span class="s3">.</span><span class="s1">fillband</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">ink_alpha</span><span class="s3">)</span>
                <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">coord</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">(</span>
                        <span class="s1">color</span><span class="s3">, (</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">mask</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">y </span><span class="s3">+ </span><span class="s1">mask</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]), </span><span class="s1">mask</span>
                    <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">draw</span><span class="s3">.</span><span class="s1">draw_bitmap</span><span class="s3">(</span><span class="s1">coord</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">, </span><span class="s1">ink</span><span class="s3">)</span>

        <span class="s1">ink </span><span class="s3">= </span><span class="s1">getink</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ink </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">stroke_ink </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">if </span><span class="s1">stroke_width</span><span class="s3">:</span>
                <span class="s1">stroke_ink </span><span class="s3">= </span><span class="s1">getink</span><span class="s3">(</span><span class="s1">stroke_fill</span><span class="s3">) </span><span class="s2">if </span><span class="s1">stroke_fill </span><span class="s2">is not None else </span><span class="s1">ink</span>

            <span class="s2">if </span><span class="s1">stroke_ink </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s0"># Draw stroked text</span>
                <span class="s1">draw_text</span><span class="s3">(</span><span class="s1">stroke_ink</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">)</span>

                <span class="s0"># Draw normal text</span>
                <span class="s1">draw_text</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s0"># Only draw normal text</span>
                <span class="s1">draw_text</span><span class="s3">(</span><span class="s1">ink</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">multiline_text</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">],</span>
        <span class="s1">text</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">fill</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">font</span><span class="s3">: (</span>
            <span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">ImageFont</span>
            <span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">FreeTypeFont</span>
            <span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">TransposedFont</span>
            <span class="s3">| </span><span class="s2">None</span>
        <span class="s3">) = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">anchor</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">spacing</span><span class="s3">=</span><span class="s6">4</span><span class="s3">,</span>
        <span class="s1">align</span><span class="s3">=</span><span class="s4">&quot;left&quot;</span><span class="s3">,</span>
        <span class="s1">direction</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">language</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">stroke_width</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">stroke_fill</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">embedded_color</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">font_size</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">direction </span><span class="s3">== </span><span class="s4">&quot;ttb&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;ttb direction is unsupported for multiline text&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">anchor </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">anchor </span><span class="s3">= </span><span class="s4">&quot;la&quot;</span>
        <span class="s2">elif </span><span class="s1">len</span><span class="s3">(</span><span class="s1">anchor</span><span class="s3">) != </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;anchor must be a 2 character string&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] </span><span class="s2">in </span><span class="s4">&quot;tb&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;anchor not supported for multiline text&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">font </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">font </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfont</span><span class="s3">(</span><span class="s1">font_size</span><span class="s3">)</span>

        <span class="s1">widths </span><span class="s3">= []</span>
        <span class="s1">max_width</span><span class="s3">: </span><span class="s1">float </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_split</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
        <span class="s1">line_spacing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_spacing</span><span class="s3">(</span><span class="s1">font</span><span class="s3">, </span><span class="s1">spacing</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">lines</span><span class="s3">:</span>
            <span class="s1">line_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textlength</span><span class="s3">(</span>
                <span class="s1">line</span><span class="s3">, </span><span class="s1">font</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">=</span><span class="s1">direction</span><span class="s3">, </span><span class="s1">features</span><span class="s3">=</span><span class="s1">features</span><span class="s3">, </span><span class="s1">language</span><span class="s3">=</span><span class="s1">language</span>
            <span class="s3">)</span>
            <span class="s1">widths</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line_width</span><span class="s3">)</span>
            <span class="s1">max_width </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">max_width</span><span class="s3">, </span><span class="s1">line_width</span><span class="s3">)</span>

        <span class="s1">top </span><span class="s3">= </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] == </span><span class="s4">&quot;m&quot;</span><span class="s3">:</span>
            <span class="s1">top </span><span class="s3">-= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s6">1</span><span class="s3">) * </span><span class="s1">line_spacing </span><span class="s3">/ </span><span class="s6">2.0</span>
        <span class="s2">elif </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] == </span><span class="s4">&quot;d&quot;</span><span class="s3">:</span>
            <span class="s1">top </span><span class="s3">-= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s6">1</span><span class="s3">) * </span><span class="s1">line_spacing</span>

        <span class="s2">for </span><span class="s1">idx</span><span class="s3">, </span><span class="s1">line </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s1">left </span><span class="s3">= </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s1">width_difference </span><span class="s3">= </span><span class="s1">max_width </span><span class="s3">- </span><span class="s1">widths</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]</span>

            <span class="s0"># first align left by anchor</span>
            <span class="s2">if </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s4">&quot;m&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">-= </span><span class="s1">width_difference </span><span class="s3">/ </span><span class="s6">2.0</span>
            <span class="s2">elif </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s4">&quot;r&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">-= </span><span class="s1">width_difference</span>

            <span class="s0"># then align by align parameter</span>
            <span class="s2">if </span><span class="s1">align </span><span class="s3">== </span><span class="s4">&quot;left&quot;</span><span class="s3">:</span>
                <span class="s2">pass</span>
            <span class="s2">elif </span><span class="s1">align </span><span class="s3">== </span><span class="s4">&quot;center&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">+= </span><span class="s1">width_difference </span><span class="s3">/ </span><span class="s6">2.0</span>
            <span class="s2">elif </span><span class="s1">align </span><span class="s3">== </span><span class="s4">&quot;right&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">+= </span><span class="s1">width_difference</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s4">'align must be &quot;left&quot;, &quot;center&quot; or &quot;right&quot;'</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">text</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">top</span><span class="s3">),</span>
                <span class="s1">line</span><span class="s3">,</span>
                <span class="s1">fill</span><span class="s3">,</span>
                <span class="s1">font</span><span class="s3">,</span>
                <span class="s1">anchor</span><span class="s3">,</span>
                <span class="s1">direction</span><span class="s3">=</span><span class="s1">direction</span><span class="s3">,</span>
                <span class="s1">features</span><span class="s3">=</span><span class="s1">features</span><span class="s3">,</span>
                <span class="s1">language</span><span class="s3">=</span><span class="s1">language</span><span class="s3">,</span>
                <span class="s1">stroke_width</span><span class="s3">=</span><span class="s1">stroke_width</span><span class="s3">,</span>
                <span class="s1">stroke_fill</span><span class="s3">=</span><span class="s1">stroke_fill</span><span class="s3">,</span>
                <span class="s1">embedded_color</span><span class="s3">=</span><span class="s1">embedded_color</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">top </span><span class="s3">+= </span><span class="s1">line_spacing</span>

    <span class="s2">def </span><span class="s1">textlength</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">text</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">font</span><span class="s3">: (</span>
            <span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">ImageFont</span>
            <span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">FreeTypeFont</span>
            <span class="s3">| </span><span class="s1">ImageFont</span><span class="s3">.</span><span class="s1">TransposedFont</span>
            <span class="s3">| </span><span class="s2">None</span>
        <span class="s3">) = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">direction</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">language</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">embedded_color</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">font_size</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; float</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Get the length of a given string, in pixels with 1/64 precision.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_check</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;can't measure length of multiline text&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">embedded_color </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s2">not in </span><span class="s3">(</span><span class="s4">&quot;RGB&quot;</span><span class="s3">, </span><span class="s4">&quot;RGBA&quot;</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Embedded color supported only in RGB and RGBA modes&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">font </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">font </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfont</span><span class="s3">(</span><span class="s1">font_size</span><span class="s3">)</span>
        <span class="s1">mode </span><span class="s3">= </span><span class="s4">&quot;RGBA&quot; </span><span class="s2">if </span><span class="s1">embedded_color </span><span class="s2">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fontmode</span>
        <span class="s2">return </span><span class="s1">font</span><span class="s3">.</span><span class="s1">getlength</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">, </span><span class="s1">features</span><span class="s3">, </span><span class="s1">language</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">textbbox</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">,</span>
        <span class="s1">text</span><span class="s3">,</span>
        <span class="s1">font</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">anchor</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">spacing</span><span class="s3">=</span><span class="s6">4</span><span class="s3">,</span>
        <span class="s1">align</span><span class="s3">=</span><span class="s4">&quot;left&quot;</span><span class="s3">,</span>
        <span class="s1">direction</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">language</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">stroke_width</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">embedded_color</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">font_size</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]:</span>
        <span class="s5">&quot;&quot;&quot;Get the bounding box of a given string, in pixels.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">embedded_color </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s2">not in </span><span class="s3">(</span><span class="s4">&quot;RGB&quot;</span><span class="s3">, </span><span class="s4">&quot;RGBA&quot;</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Embedded color supported only in RGB and RGBA modes&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">font </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">font </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfont</span><span class="s3">(</span><span class="s1">font_size</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_check</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">multiline_textbbox</span><span class="s3">(</span>
                <span class="s1">xy</span><span class="s3">,</span>
                <span class="s1">text</span><span class="s3">,</span>
                <span class="s1">font</span><span class="s3">,</span>
                <span class="s1">anchor</span><span class="s3">,</span>
                <span class="s1">spacing</span><span class="s3">,</span>
                <span class="s1">align</span><span class="s3">,</span>
                <span class="s1">direction</span><span class="s3">,</span>
                <span class="s1">features</span><span class="s3">,</span>
                <span class="s1">language</span><span class="s3">,</span>
                <span class="s1">stroke_width</span><span class="s3">,</span>
                <span class="s1">embedded_color</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">mode </span><span class="s3">= </span><span class="s4">&quot;RGBA&quot; </span><span class="s2">if </span><span class="s1">embedded_color </span><span class="s2">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fontmode</span>
        <span class="s1">bbox </span><span class="s3">= </span><span class="s1">font</span><span class="s3">.</span><span class="s1">getbbox</span><span class="s3">(</span>
            <span class="s1">text</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">, </span><span class="s1">features</span><span class="s3">, </span><span class="s1">language</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">, </span><span class="s1">anchor</span>
        <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] + </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] + </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">], </span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">2</span><span class="s3">] + </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">3</span><span class="s3">] + </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">multiline_textbbox</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">xy</span><span class="s3">,</span>
        <span class="s1">text</span><span class="s3">,</span>
        <span class="s1">font</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">anchor</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">spacing</span><span class="s3">=</span><span class="s6">4</span><span class="s3">,</span>
        <span class="s1">align</span><span class="s3">=</span><span class="s4">&quot;left&quot;</span><span class="s3">,</span>
        <span class="s1">direction</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">language</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">stroke_width</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">embedded_color</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">font_size</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">direction </span><span class="s3">== </span><span class="s4">&quot;ttb&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;ttb direction is unsupported for multiline text&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">anchor </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">anchor </span><span class="s3">= </span><span class="s4">&quot;la&quot;</span>
        <span class="s2">elif </span><span class="s1">len</span><span class="s3">(</span><span class="s1">anchor</span><span class="s3">) != </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;anchor must be a 2 character string&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] </span><span class="s2">in </span><span class="s4">&quot;tb&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;anchor not supported for multiline text&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">font </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">font </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfont</span><span class="s3">(</span><span class="s1">font_size</span><span class="s3">)</span>

        <span class="s1">widths </span><span class="s3">= []</span>
        <span class="s1">max_width</span><span class="s3">: </span><span class="s1">float </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_split</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
        <span class="s1">line_spacing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_multiline_spacing</span><span class="s3">(</span><span class="s1">font</span><span class="s3">, </span><span class="s1">spacing</span><span class="s3">, </span><span class="s1">stroke_width</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">lines</span><span class="s3">:</span>
            <span class="s1">line_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textlength</span><span class="s3">(</span>
                <span class="s1">line</span><span class="s3">,</span>
                <span class="s1">font</span><span class="s3">,</span>
                <span class="s1">direction</span><span class="s3">=</span><span class="s1">direction</span><span class="s3">,</span>
                <span class="s1">features</span><span class="s3">=</span><span class="s1">features</span><span class="s3">,</span>
                <span class="s1">language</span><span class="s3">=</span><span class="s1">language</span><span class="s3">,</span>
                <span class="s1">embedded_color</span><span class="s3">=</span><span class="s1">embedded_color</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">widths</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line_width</span><span class="s3">)</span>
            <span class="s1">max_width </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">max_width</span><span class="s3">, </span><span class="s1">line_width</span><span class="s3">)</span>

        <span class="s1">top </span><span class="s3">= </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] == </span><span class="s4">&quot;m&quot;</span><span class="s3">:</span>
            <span class="s1">top </span><span class="s3">-= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s6">1</span><span class="s3">) * </span><span class="s1">line_spacing </span><span class="s3">/ </span><span class="s6">2.0</span>
        <span class="s2">elif </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] == </span><span class="s4">&quot;d&quot;</span><span class="s3">:</span>
            <span class="s1">top </span><span class="s3">-= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) - </span><span class="s6">1</span><span class="s3">) * </span><span class="s1">line_spacing</span>

        <span class="s1">bbox</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">for </span><span class="s1">idx</span><span class="s3">, </span><span class="s1">line </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s1">left </span><span class="s3">= </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s1">width_difference </span><span class="s3">= </span><span class="s1">max_width </span><span class="s3">- </span><span class="s1">widths</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">]</span>

            <span class="s0"># first align left by anchor</span>
            <span class="s2">if </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s4">&quot;m&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">-= </span><span class="s1">width_difference </span><span class="s3">/ </span><span class="s6">2.0</span>
            <span class="s2">elif </span><span class="s1">anchor</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s4">&quot;r&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">-= </span><span class="s1">width_difference</span>

            <span class="s0"># then align by align parameter</span>
            <span class="s2">if </span><span class="s1">align </span><span class="s3">== </span><span class="s4">&quot;left&quot;</span><span class="s3">:</span>
                <span class="s2">pass</span>
            <span class="s2">elif </span><span class="s1">align </span><span class="s3">== </span><span class="s4">&quot;center&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">+= </span><span class="s1">width_difference </span><span class="s3">/ </span><span class="s6">2.0</span>
            <span class="s2">elif </span><span class="s1">align </span><span class="s3">== </span><span class="s4">&quot;right&quot;</span><span class="s3">:</span>
                <span class="s1">left </span><span class="s3">+= </span><span class="s1">width_difference</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s4">'align must be &quot;left&quot;, &quot;center&quot; or &quot;right&quot;'</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

            <span class="s1">bbox_line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">textbbox</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">left</span><span class="s3">, </span><span class="s1">top</span><span class="s3">),</span>
                <span class="s1">line</span><span class="s3">,</span>
                <span class="s1">font</span><span class="s3">,</span>
                <span class="s1">anchor</span><span class="s3">,</span>
                <span class="s1">direction</span><span class="s3">=</span><span class="s1">direction</span><span class="s3">,</span>
                <span class="s1">features</span><span class="s3">=</span><span class="s1">features</span><span class="s3">,</span>
                <span class="s1">language</span><span class="s3">=</span><span class="s1">language</span><span class="s3">,</span>
                <span class="s1">stroke_width</span><span class="s3">=</span><span class="s1">stroke_width</span><span class="s3">,</span>
                <span class="s1">embedded_color</span><span class="s3">=</span><span class="s1">embedded_color</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">bbox </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">bbox </span><span class="s3">= </span><span class="s1">bbox_line</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bbox </span><span class="s3">= (</span>
                    <span class="s1">min</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">bbox_line</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]),</span>
                    <span class="s1">min</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">1</span><span class="s3">], </span><span class="s1">bbox_line</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]),</span>
                    <span class="s1">max</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">2</span><span class="s3">], </span><span class="s1">bbox_line</span><span class="s3">[</span><span class="s6">2</span><span class="s3">]),</span>
                    <span class="s1">max</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">[</span><span class="s6">3</span><span class="s3">], </span><span class="s1">bbox_line</span><span class="s3">[</span><span class="s6">3</span><span class="s3">]),</span>
                <span class="s3">)</span>

            <span class="s1">top </span><span class="s3">+= </span><span class="s1">line_spacing</span>

        <span class="s2">if </span><span class="s1">bbox </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">], </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">xy</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">bbox</span>


<span class="s2">def </span><span class="s1">Draw</span><span class="s3">(</span><span class="s1">im</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; ImageDraw</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot; 
    A simple 2D drawing interface for PIL images. 
 
    :param im: The image to draw in. 
    :param mode: Optional mode to use for color values.  For RGB 
       images, this argument can be RGB or RGBA (to blend the 
       drawing into the image).  For all other modes, this argument 
       must be the same as the image mode.  If omitted, the mode 
       defaults to the mode of the image. 
    &quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s4">&quot;getdraw&quot;</span><span class="s3">)(</span><span class="s1">mode</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">ImageDraw</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getdraw</span><span class="s3">(</span>
    <span class="s1">im</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">hints</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span>
<span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">ImageDraw2</span><span class="s3">.</span><span class="s1">Draw </span><span class="s3">| </span><span class="s2">None</span><span class="s3">, </span><span class="s1">ModuleType</span><span class="s3">]:</span>
    <span class="s5">&quot;&quot;&quot; 
    :param im: The image to draw in. 
    :param hints: An optional list of hints. Deprecated. 
    :returns: A (drawing context, drawing resource factory) tuple. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">hints </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">deprecate</span><span class="s3">(</span><span class="s4">&quot;'hints' parameter&quot;</span><span class="s3">, </span><span class="s6">12</span><span class="s3">)</span>
    <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">ImageDraw2</span>

    <span class="s1">draw </span><span class="s3">= </span><span class="s1">ImageDraw2</span><span class="s3">.</span><span class="s1">Draw</span><span class="s3">(</span><span class="s1">im</span><span class="s3">) </span><span class="s2">if </span><span class="s1">im </span><span class="s2">is not None else None</span>
    <span class="s2">return </span><span class="s1">draw</span><span class="s3">, </span><span class="s1">ImageDraw2</span>


<span class="s2">def </span><span class="s1">floodfill</span><span class="s3">(</span>
    <span class="s1">image</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">,</span>
    <span class="s1">xy</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">],</span>
    <span class="s1">value</span><span class="s3">: </span><span class="s1">float </span><span class="s3">| </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, ...],</span>
    <span class="s1">border</span><span class="s3">: </span><span class="s1">float </span><span class="s3">| </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, ...] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">thresh</span><span class="s3">: </span><span class="s1">float </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot; 
    .. warning:: This method is experimental. 
 
    Fills a bounded region with a given color. 
 
    :param image: Target image. 
    :param xy: Seed position (a 2-item coordinate tuple). See 
        :ref:`coordinate-system`. 
    :param value: Fill color. 
    :param border: Optional border value.  If given, the region consists of 
        pixels with a color different from the border color.  If not given, 
        the region consists of pixels having the same color as the seed 
        pixel. 
    :param thresh: Optional threshold value which specifies a maximum 
        tolerable difference of a pixel value from the 'background' in 
        order for it to be replaced. Useful for filling regions of 
        non-homogeneous, but similar, colors. 
    &quot;&quot;&quot;</span>
    <span class="s0"># based on an implementation by Eric S. Raymond</span>
    <span class="s0"># amended by yo1995 @20180806</span>
    <span class="s1">pixel </span><span class="s3">= </span><span class="s1">image</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">pixel </span><span class="s2">is not None</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">xy</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">background </span><span class="s3">= </span><span class="s1">pixel</span><span class="s3">[</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">_color_diff</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">background</span><span class="s3">) &lt;= </span><span class="s1">thresh</span><span class="s3">:</span>
            <span class="s2">return  </span><span class="s0"># seed point already has fill color</span>
        <span class="s1">pixel</span><span class="s3">[</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">] = </span><span class="s1">value</span>
    <span class="s2">except </span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">IndexError</span><span class="s3">):</span>
        <span class="s2">return  </span><span class="s0"># seed point outside image</span>
    <span class="s1">edge </span><span class="s3">= {(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)}</span>
    <span class="s0"># use a set to keep record of current and previous edge pixels</span>
    <span class="s0"># to reduce memory consumption</span>
    <span class="s1">full_edge </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
    <span class="s2">while </span><span class="s1">edge</span><span class="s3">:</span>
        <span class="s1">new_edge </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">edge</span><span class="s3">:  </span><span class="s0"># 4 adjacent method</span>
            <span class="s2">for </span><span class="s1">s</span><span class="s3">, </span><span class="s1">t </span><span class="s2">in </span><span class="s3">((</span><span class="s1">x </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">y</span><span class="s3">), (</span><span class="s1">x </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s1">y</span><span class="s3">), (</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">), (</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s3">- </span><span class="s6">1</span><span class="s3">)):</span>
                <span class="s0"># If already processed, or if a coordinate is negative, skip</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">t</span><span class="s3">) </span><span class="s2">in </span><span class="s1">full_edge </span><span class="s2">or </span><span class="s1">s </span><span class="s3">&lt; </span><span class="s6">0 </span><span class="s2">or </span><span class="s1">t </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
                    <span class="s2">continue</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">p </span><span class="s3">= </span><span class="s1">pixel</span><span class="s3">[</span><span class="s1">s</span><span class="s3">, </span><span class="s1">t</span><span class="s3">]</span>
                <span class="s2">except </span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">IndexError</span><span class="s3">):</span>
                    <span class="s2">pass</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">full_edge</span><span class="s3">.</span><span class="s1">add</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">t</span><span class="s3">))</span>
                    <span class="s2">if </span><span class="s1">border </span><span class="s2">is None</span><span class="s3">:</span>
                        <span class="s1">fill </span><span class="s3">= </span><span class="s1">_color_diff</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">background</span><span class="s3">) &lt;= </span><span class="s1">thresh</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">fill </span><span class="s3">= </span><span class="s1">p </span><span class="s2">not in </span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">border</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">fill</span><span class="s3">:</span>
                        <span class="s1">pixel</span><span class="s3">[</span><span class="s1">s</span><span class="s3">, </span><span class="s1">t</span><span class="s3">] = </span><span class="s1">value</span>
                        <span class="s1">new_edge</span><span class="s3">.</span><span class="s1">add</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">t</span><span class="s3">))</span>
        <span class="s1">full_edge </span><span class="s3">= </span><span class="s1">edge  </span><span class="s0"># discard pixels processed</span>
        <span class="s1">edge </span><span class="s3">= </span><span class="s1">new_edge</span>


<span class="s2">def </span><span class="s1">_compute_regular_polygon_vertices</span><span class="s3">(</span>
    <span class="s1">bounding_circle</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">float</span><span class="s3">] | </span><span class="s1">float</span><span class="s3">], </span><span class="s1">n_sides</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">rotation</span><span class="s3">: </span><span class="s1">float</span>
<span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]]:</span>
    <span class="s5">&quot;&quot;&quot; 
    Generate a list of vertices for a 2D regular polygon. 
 
    :param bounding_circle: The bounding circle is a sequence defined 
        by a point and radius. The polygon is inscribed in this circle. 
        (e.g. ``bounding_circle=(x, y, r)`` or ``((x, y), r)``) 
    :param n_sides: Number of sides 
        (e.g. ``n_sides=3`` for a triangle, ``6`` for a hexagon) 
    :param rotation: Apply an arbitrary rotation to the polygon 
        (e.g. ``rotation=90``, applies a 90 degree rotation) 
    :return: List of regular polygon vertices 
        (e.g. ``[(25, 50), (50, 50), (50, 25), (25, 25)]``) 
 
    How are the vertices computed? 
    1. Compute the following variables 
        - theta: Angle between the apothem &amp; the nearest polygon vertex 
        - side_length: Length of each polygon edge 
        - centroid: Center of bounding circle (1st, 2nd elements of bounding_circle) 
        - polygon_radius: Polygon radius (last element of bounding_circle) 
        - angles: Location of each polygon vertex in polar grid 
            (e.g. A square with 0 degree rotation =&gt; [225.0, 315.0, 45.0, 135.0]) 
 
    2. For each angle in angles, get the polygon vertex at that angle 
        The vertex is computed using the equation below. 
            X= xcos() + ysin() 
            Y= xsin() + ycos() 
 
        Note: 
             = angle in degrees 
            x = 0 
            y = polygon_radius 
 
        The formula above assumes rotation around the origin. 
        In our case, we are rotating around the centroid. 
        To account for this, we use the formula below 
            X = xcos() + ysin() + centroid_x 
            Y = xsin() + ycos() + centroid_y 
    &quot;&quot;&quot;</span>
    <span class="s0"># 1. Error Handling</span>
    <span class="s0"># 1.1 Check `n_sides` has an appropriate value</span>
    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">n_sides</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;n_sides should be an int&quot;  </span><span class="s0"># type: ignore[unreachable]</span>
        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">n_sides </span><span class="s3">&lt; </span><span class="s6">3</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;n_sides should be an int &gt; 2&quot;</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s0"># 1.2 Check `bounding_circle` has an appropriate value</span>
    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;bounding_circle should be a sequence&quot;</span>
        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">) == </span><span class="s6">3</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, (</span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">bounding_circle</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;bounding_circle should only contain numeric data&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s3">*</span><span class="s1">centroid</span><span class="s3">, </span><span class="s1">polygon_radius </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">List</span><span class="s3">[</span><span class="s1">float</span><span class="s3">], </span><span class="s1">list</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">) == </span><span class="s6">2 </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
        <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span>
            <span class="s1">isinstance</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, (</span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">bounding_circle</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s3">) </span><span class="s2">or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">[</span><span class="s6">1</span><span class="s3">], (</span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">)):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;bounding_circle should only contain numeric data&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) != </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;bounding_circle centre should contain 2D coordinates (e.g. (x, y))&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s1">centroid </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">List</span><span class="s3">[</span><span class="s1">float</span><span class="s3">], </span><span class="s1">list</span><span class="s3">(</span><span class="s1">bounding_circle</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">polygon_radius </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">float</span><span class="s3">, </span><span class="s1">bounding_circle</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= (</span>
            <span class="s4">&quot;bounding_circle should contain 2D coordinates &quot;</span>
            <span class="s4">&quot;and a radius (e.g. (x, y, r) or ((x, y), r) )&quot;</span>
        <span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">polygon_radius </span><span class="s3">&lt;= </span><span class="s6">0</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;bounding_circle radius should be &gt; 0&quot;</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s0"># 1.3 Check `rotation` has an appropriate value</span>
    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rotation</span><span class="s3">, (</span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">)):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;rotation should be an int or float&quot;  </span><span class="s0"># type: ignore[unreachable]</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s0"># 2. Define Helper Functions</span>
    <span class="s2">def </span><span class="s1">_apply_rotation</span><span class="s3">(</span><span class="s1">point</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">float</span><span class="s3">], </span><span class="s1">degrees</span><span class="s3">: </span><span class="s1">float</span><span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s3">(</span>
            <span class="s1">round</span><span class="s3">(</span>
                <span class="s1">point</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] * </span><span class="s1">math</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">radians</span><span class="s3">(</span><span class="s6">360 </span><span class="s3">- </span><span class="s1">degrees</span><span class="s3">))</span>
                <span class="s3">- </span><span class="s1">point</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] * </span><span class="s1">math</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">radians</span><span class="s3">(</span><span class="s6">360 </span><span class="s3">- </span><span class="s1">degrees</span><span class="s3">))</span>
                <span class="s3">+ </span><span class="s1">centroid</span><span class="s3">[</span><span class="s6">0</span><span class="s3">],</span>
                <span class="s6">2</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">round</span><span class="s3">(</span>
                <span class="s1">point</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] * </span><span class="s1">math</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">radians</span><span class="s3">(</span><span class="s6">360 </span><span class="s3">- </span><span class="s1">degrees</span><span class="s3">))</span>
                <span class="s3">+ </span><span class="s1">point</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] * </span><span class="s1">math</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">radians</span><span class="s3">(</span><span class="s6">360 </span><span class="s3">- </span><span class="s1">degrees</span><span class="s3">))</span>
                <span class="s3">+ </span><span class="s1">centroid</span><span class="s3">[</span><span class="s6">1</span><span class="s3">],</span>
                <span class="s6">2</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_compute_polygon_vertex</span><span class="s3">(</span><span class="s1">angle</span><span class="s3">: </span><span class="s1">float</span><span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">float</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]:</span>
        <span class="s1">start_point </span><span class="s3">= [</span><span class="s1">polygon_radius</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">_apply_rotation</span><span class="s3">(</span><span class="s1">start_point</span><span class="s3">, </span><span class="s1">angle</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_angles</span><span class="s3">(</span><span class="s1">n_sides</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">rotation</span><span class="s3">: </span><span class="s1">float</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">float</span><span class="s3">]:</span>
        <span class="s1">angles </span><span class="s3">= []</span>
        <span class="s1">degrees </span><span class="s3">= </span><span class="s6">360 </span><span class="s3">/ </span><span class="s1">n_sides</span>
        <span class="s0"># Start with the bottom left polygon vertex</span>
        <span class="s1">current_angle </span><span class="s3">= (</span><span class="s6">270 </span><span class="s3">- </span><span class="s6">0.5 </span><span class="s3">* </span><span class="s1">degrees</span><span class="s3">) + </span><span class="s1">rotation</span>
        <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">n_sides</span><span class="s3">):</span>
            <span class="s1">angles</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">current_angle</span><span class="s3">)</span>
            <span class="s1">current_angle </span><span class="s3">+= </span><span class="s1">degrees</span>
            <span class="s2">if </span><span class="s1">current_angle </span><span class="s3">&gt; </span><span class="s6">360</span><span class="s3">:</span>
                <span class="s1">current_angle </span><span class="s3">-= </span><span class="s6">360</span>
        <span class="s2">return </span><span class="s1">angles</span>

    <span class="s0"># 3. Variable Declarations</span>
    <span class="s1">angles </span><span class="s3">= </span><span class="s1">_get_angles</span><span class="s3">(</span><span class="s1">n_sides</span><span class="s3">, </span><span class="s1">rotation</span><span class="s3">)</span>

    <span class="s0"># 4. Compute Vertices</span>
    <span class="s2">return </span><span class="s3">[</span><span class="s1">_compute_polygon_vertex</span><span class="s3">(</span><span class="s1">angle</span><span class="s3">) </span><span class="s2">for </span><span class="s1">angle </span><span class="s2">in </span><span class="s1">angles</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">_color_diff</span><span class="s3">(</span>
    <span class="s1">color1</span><span class="s3">: </span><span class="s1">float </span><span class="s3">| </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, ...], </span><span class="s1">color2</span><span class="s3">: </span><span class="s1">float </span><span class="s3">| </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, ...]</span>
<span class="s3">) </span><span class="s1">-&gt; float</span><span class="s3">:</span>
    <span class="s5">&quot;&quot;&quot; 
    Uses 1-norm distance to calculate difference between two values. 
    &quot;&quot;&quot;</span>
    <span class="s1">first </span><span class="s3">= </span><span class="s1">color1 </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">color1</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">) </span><span class="s2">else </span><span class="s3">(</span><span class="s1">color1</span><span class="s3">,)</span>
    <span class="s1">second </span><span class="s3">= </span><span class="s1">color2 </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">color2</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">) </span><span class="s2">else </span><span class="s3">(</span><span class="s1">color2</span><span class="s3">,)</span>

    <span class="s2">return </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">first</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] - </span><span class="s1">second</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">second</span><span class="s3">)))</span>
</pre>
</body>
</html>