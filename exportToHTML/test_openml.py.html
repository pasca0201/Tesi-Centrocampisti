<html>
<head>
<title>test_openml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_openml.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Test the openml loader.&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">gzip</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>
<span class="s2">from </span><span class="s1">importlib </span><span class="s2">import </span><span class="s1">resources</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">BytesIO</span>
<span class="s2">from </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error </span><span class="s2">import </span><span class="s1">HTTPError</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse</span>

<span class="s2">import </span><span class="s1">sklearn</span>
<span class="s2">from </span><span class="s1">sklearn </span><span class="s2">import </span><span class="s1">config_context</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s1">fetch_openml </span><span class="s2">as </span><span class="s1">fetch_openml_orig</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_OPENML_PREFIX</span><span class="s3">,</span>
    <span class="s1">_get_local_path</span><span class="s3">,</span>
    <span class="s1">_open_openml_url</span><span class="s3">,</span>
    <span class="s1">_retry_with_clean_cache</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">Bunch</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_optional_dependencies </span><span class="s2">import </span><span class="s1">check_pandas_support</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">SkipTest</span><span class="s3">,</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
    <span class="s1">fails_if_pypy</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s1">OPENML_TEST_DATA_MODULE </span><span class="s3">= </span><span class="s4">&quot;sklearn.datasets.tests.data.openml&quot;</span>
<span class="s5"># if True, urlopen will be monkey patched to only use local files</span>
<span class="s1">test_offline </span><span class="s3">= </span><span class="s2">True</span>


<span class="s2">class </span><span class="s1">_MockHTTPResponse</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">is_gzip</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= </span><span class="s1">data</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">is_gzip </span><span class="s3">= </span><span class="s1">is_gzip</span>

    <span class="s2">def </span><span class="s1">read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">amt</span><span class="s3">=-</span><span class="s6">1</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">amt</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">info</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">is_gzip</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;Content-Encoding&quot;</span><span class="s3">: </span><span class="s4">&quot;gzip&quot;</span><span class="s3">}</span>
        <span class="s2">return </span><span class="s3">{}</span>

    <span class="s2">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__enter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">__exit__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">exc_type</span><span class="s3">, </span><span class="s1">exc_val</span><span class="s3">, </span><span class="s1">exc_tb</span><span class="s3">):</span>
        <span class="s2">return False</span>


<span class="s5"># Disable the disk-based cache when testing `fetch_openml`:</span>
<span class="s5"># the mock data in sklearn/datasets/tests/data/openml/ is not always consistent</span>
<span class="s5"># with the version on openml.org. If one were to load the dataset outside of</span>
<span class="s5"># the tests, it may result in data that does not represent openml.org.</span>
<span class="s1">fetch_openml </span><span class="s3">= </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">fetch_openml_orig</span><span class="s3">, </span><span class="s1">data_home</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">):</span>
    <span class="s5"># monkey patches the urlopen function. Important note: Do NOT use this</span>
    <span class="s5"># in combination with a regular cache directory, as the files that are</span>
    <span class="s5"># stored as cache should not be mixed up with real openml datasets</span>
    <span class="s1">url_prefix_data_description </span><span class="s3">= </span><span class="s4">&quot;https://api.openml.org/api/v1/json/data/&quot;</span>
    <span class="s1">url_prefix_data_features </span><span class="s3">= </span><span class="s4">&quot;https://api.openml.org/api/v1/json/data/features/&quot;</span>
    <span class="s1">url_prefix_download_data </span><span class="s3">= </span><span class="s4">&quot;https://api.openml.org/data/v1/&quot;</span>
    <span class="s1">url_prefix_data_list </span><span class="s3">= </span><span class="s4">&quot;https://api.openml.org/api/v1/json/data/list/&quot;</span>

    <span class="s1">path_suffix </span><span class="s3">= </span><span class="s4">&quot;.gz&quot;</span>
    <span class="s1">read_fn </span><span class="s3">= </span><span class="s1">gzip</span><span class="s3">.</span><span class="s1">open</span>

    <span class="s1">data_module </span><span class="s3">= </span><span class="s1">OPENML_TEST_DATA_MODULE </span><span class="s3">+ </span><span class="s4">&quot;.&quot; </span><span class="s3">+ </span><span class="s4">f&quot;id_</span><span class="s2">{</span><span class="s1">data_id</span><span class="s2">}</span><span class="s4">&quot;</span>

    <span class="s2">def </span><span class="s1">_file_name</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">):</span>
        <span class="s1">output </span><span class="s3">= (</span>
            <span class="s1">re</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span><span class="s4">r&quot;\W&quot;</span><span class="s3">, </span><span class="s4">&quot;-&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s4">&quot;https://api.openml.org/&quot;</span><span class="s3">) :])</span>
            <span class="s3">+ </span><span class="s1">suffix</span>
            <span class="s3">+ </span><span class="s1">path_suffix</span>
        <span class="s3">)</span>
        <span class="s5"># Shorten the filenames to have better compatibility with windows 10</span>
        <span class="s5"># and filenames &gt; 260 characters</span>
        <span class="s2">return </span><span class="s3">(</span>
            <span class="s1">output</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-json-data-list&quot;</span><span class="s3">, </span><span class="s4">&quot;-jdl&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-json-data-features&quot;</span><span class="s3">, </span><span class="s4">&quot;-jdf&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-json-data-qualities&quot;</span><span class="s3">, </span><span class="s4">&quot;-jdq&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-json-data&quot;</span><span class="s3">, </span><span class="s4">&quot;-jd&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-data_name&quot;</span><span class="s3">, </span><span class="s4">&quot;-dn&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-download&quot;</span><span class="s3">, </span><span class="s4">&quot;-dl&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-limit&quot;</span><span class="s3">, </span><span class="s4">&quot;-l&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-data_version&quot;</span><span class="s3">, </span><span class="s4">&quot;-dv&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-status&quot;</span><span class="s3">, </span><span class="s4">&quot;-s&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-deactivated&quot;</span><span class="s3">, </span><span class="s4">&quot;-dact&quot;</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-active&quot;</span><span class="s3">, </span><span class="s4">&quot;-act&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_shared</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">, </span><span class="s1">expected_prefix</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">expected_prefix</span><span class="s3">)</span>

        <span class="s1">data_file_name </span><span class="s3">= </span><span class="s1">_file_name</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">suffix</span><span class="s3">)</span>
        <span class="s1">data_file_path </span><span class="s3">= </span><span class="s1">resources</span><span class="s3">.</span><span class="s1">files</span><span class="s3">(</span><span class="s1">data_module</span><span class="s3">) / </span><span class="s1">data_file_name</span>

        <span class="s2">with </span><span class="s1">data_file_path</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">has_gzip_header </span><span class="s2">and </span><span class="s1">gzip_response</span><span class="s3">:</span>
                <span class="s1">fp </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">decompressed_f </span><span class="s3">= </span><span class="s1">read_fn</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">)</span>
                <span class="s1">fp </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">decompressed_f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_data_description</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">_mock_urlopen_shared</span><span class="s3">(</span>
            <span class="s1">url</span><span class="s3">=</span><span class="s1">url</span><span class="s3">,</span>
            <span class="s1">has_gzip_header</span><span class="s3">=</span><span class="s1">has_gzip_header</span><span class="s3">,</span>
            <span class="s1">expected_prefix</span><span class="s3">=</span><span class="s1">url_prefix_data_description</span><span class="s3">,</span>
            <span class="s1">suffix</span><span class="s3">=</span><span class="s4">&quot;.json&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_data_features</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">_mock_urlopen_shared</span><span class="s3">(</span>
            <span class="s1">url</span><span class="s3">=</span><span class="s1">url</span><span class="s3">,</span>
            <span class="s1">has_gzip_header</span><span class="s3">=</span><span class="s1">has_gzip_header</span><span class="s3">,</span>
            <span class="s1">expected_prefix</span><span class="s3">=</span><span class="s1">url_prefix_data_features</span><span class="s3">,</span>
            <span class="s1">suffix</span><span class="s3">=</span><span class="s4">&quot;.json&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_download_data</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">_mock_urlopen_shared</span><span class="s3">(</span>
            <span class="s1">url</span><span class="s3">=</span><span class="s1">url</span><span class="s3">,</span>
            <span class="s1">has_gzip_header</span><span class="s3">=</span><span class="s1">has_gzip_header</span><span class="s3">,</span>
            <span class="s1">expected_prefix</span><span class="s3">=</span><span class="s1">url_prefix_download_data</span><span class="s3">,</span>
            <span class="s1">suffix</span><span class="s3">=</span><span class="s4">&quot;.arff&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_data_list</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">url_prefix_data_list</span><span class="s3">)</span>

        <span class="s1">data_file_name </span><span class="s3">= </span><span class="s1">_file_name</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s4">&quot;.json&quot;</span><span class="s3">)</span>
        <span class="s1">data_file_path </span><span class="s3">= </span><span class="s1">resources</span><span class="s3">.</span><span class="s1">files</span><span class="s3">(</span><span class="s1">data_module</span><span class="s3">) / </span><span class="s1">data_file_name</span>

        <span class="s5"># load the file itself, to simulate a http error</span>
        <span class="s2">with </span><span class="s1">data_file_path</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">decompressed_f </span><span class="s3">= </span><span class="s1">read_fn</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">)</span>
            <span class="s1">decoded_s </span><span class="s3">= </span><span class="s1">decompressed_f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">)</span>
            <span class="s1">json_data </span><span class="s3">= </span><span class="s1">json</span><span class="s3">.</span><span class="s1">loads</span><span class="s3">(</span><span class="s1">decoded_s</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s4">&quot;error&quot; </span><span class="s2">in </span><span class="s1">json_data</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">HTTPError</span><span class="s3">(</span>
                <span class="s1">url</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">code</span><span class="s3">=</span><span class="s6">412</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s4">&quot;Simulated mock error&quot;</span><span class="s3">, </span><span class="s1">hdrs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">=</span><span class="s1">BytesIO</span><span class="s3">()</span>
            <span class="s3">)</span>

        <span class="s2">with </span><span class="s1">data_file_path</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">has_gzip_header</span><span class="s3">:</span>
                <span class="s1">fp </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">decompressed_f </span><span class="s3">= </span><span class="s1">read_fn</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">)</span>
                <span class="s1">fp </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">decompressed_f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen</span><span class="s3">(</span><span class="s1">request</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">get_full_url</span><span class="s3">()</span>
        <span class="s1">has_gzip_header </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">get_header</span><span class="s3">(</span><span class="s4">&quot;Accept-encoding&quot;</span><span class="s3">) == </span><span class="s4">&quot;gzip&quot;</span>
        <span class="s2">if </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">url_prefix_data_list</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_data_list</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">url_prefix_data_features</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_data_features</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">url_prefix_download_data</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_download_data</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">url_prefix_data_description</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_data_description</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">has_gzip_header</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Unknown mocking URL pattern: %s&quot; </span><span class="s3">% </span><span class="s1">url</span><span class="s3">)</span>

    <span class="s5"># XXX: Global variable</span>
    <span class="s2">if </span><span class="s1">test_offline</span><span class="s3">:</span>
        <span class="s1">context</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">, </span><span class="s4">&quot;urlopen&quot;</span><span class="s3">, </span><span class="s1">_mock_urlopen</span><span class="s3">)</span>


<span class="s5">###############################################################################</span>
<span class="s5"># Test the behaviour of `fetch_openml` depending of the input parameters.</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data_id, dataset_params, n_samples, n_features, n_targets&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s5"># iris</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">61</span><span class="s3">}, </span><span class="s6">150</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}, </span><span class="s6">150</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># anneal</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">}, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">38</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;anneal&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">38</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># cpu</span>
        <span class="s3">(</span><span class="s6">561</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">561</span><span class="s3">}, </span><span class="s6">209</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">561</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;cpu&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}, </span><span class="s6">209</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># emotions</span>
        <span class="s3">(</span><span class="s6">40589</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40589</span><span class="s3">}, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">72</span><span class="s3">, </span><span class="s6">6</span><span class="s3">),</span>
        <span class="s5"># adult-census</span>
        <span class="s3">(</span><span class="s6">1119</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">1119</span><span class="s3">}, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">1119</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;adult-census&quot;</span><span class="s3">}, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># miceprotein</span>
        <span class="s3">(</span><span class="s6">40966</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40966</span><span class="s3">}, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">77</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">40966</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;MiceProtein&quot;</span><span class="s3">}, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">77</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># titanic</span>
        <span class="s3">(</span><span class="s6">40945</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40945</span><span class="s3">}, </span><span class="s6">1309</span><span class="s3">, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_as_frame_true</span><span class="s3">(</span>
    <span class="s1">monkeypatch</span><span class="s3">,</span>
    <span class="s1">data_id</span><span class="s3">,</span>
    <span class="s1">dataset_params</span><span class="s3">,</span>
    <span class="s1">n_samples</span><span class="s3">,</span>
    <span class="s1">n_features</span><span class="s3">,</span>
    <span class="s1">n_targets</span><span class="s3">,</span>
    <span class="s1">parser</span><span class="s3">,</span>
    <span class="s1">gzip_response</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `fetch_openml` with `as_frame=True`. 
 
    Fetch by ID and/or name (depending if the file was previously cached). 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">bunch </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">dataset_params</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">int</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">details</span><span class="s3">[</span><span class="s4">&quot;id&quot;</span><span class="s3">]) == </span><span class="s1">data_id</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">, </span><span class="s1">Bunch</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">+ </span><span class="s1">n_targets</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">n_targets </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">,)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">categories </span><span class="s2">is None</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data_id, dataset_params, n_samples, n_features, n_targets&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s5"># iris</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">61</span><span class="s3">}, </span><span class="s6">150</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;iris&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}, </span><span class="s6">150</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># anneal</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">}, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">38</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;anneal&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">38</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># cpu</span>
        <span class="s3">(</span><span class="s6">561</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">561</span><span class="s3">}, </span><span class="s6">209</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">561</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;cpu&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}, </span><span class="s6">209</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># emotions</span>
        <span class="s3">(</span><span class="s6">40589</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40589</span><span class="s3">}, </span><span class="s6">13</span><span class="s3">, </span><span class="s6">72</span><span class="s3">, </span><span class="s6">6</span><span class="s3">),</span>
        <span class="s5"># adult-census</span>
        <span class="s3">(</span><span class="s6">1119</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">1119</span><span class="s3">}, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">1119</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;adult-census&quot;</span><span class="s3">}, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s5"># miceprotein</span>
        <span class="s3">(</span><span class="s6">40966</span><span class="s3">, {</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40966</span><span class="s3">}, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">77</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">40966</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;MiceProtein&quot;</span><span class="s3">}, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">77</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_as_frame_false</span><span class="s3">(</span>
    <span class="s1">monkeypatch</span><span class="s3">,</span>
    <span class="s1">data_id</span><span class="s3">,</span>
    <span class="s1">dataset_params</span><span class="s3">,</span>
    <span class="s1">n_samples</span><span class="s3">,</span>
    <span class="s1">n_features</span><span class="s3">,</span>
    <span class="s1">n_targets</span><span class="s3">,</span>
    <span class="s1">parser</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `fetch_openml` with `as_frame=False`. 
 
    Fetch both by ID and/or name + version. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">bunch </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">dataset_params</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">int</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">details</span><span class="s3">[</span><span class="s4">&quot;id&quot;</span><span class="s3">]) == </span><span class="s1">data_id</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">, </span><span class="s1">Bunch</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">frame </span><span class="s2">is None</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">n_targets </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">,)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">categories</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;data_id&quot;</span><span class="s3">, [</span><span class="s6">61</span><span class="s3">, </span><span class="s6">1119</span><span class="s3">, </span><span class="s6">40945</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_consistency_parser</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the consistency of the LIAC-ARFF and pandas parsers.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">bunch_liac </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">bunch_pandas </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s5"># The data frames for the input features should match up to some numerical</span>
    <span class="s5"># dtype conversions (e.g. float64 &lt;=&gt; Int64) due to limitations of the</span>
    <span class="s5"># LIAC-ARFF parser.</span>
    <span class="s1">data_liac</span><span class="s3">, </span><span class="s1">data_pandas </span><span class="s3">= </span><span class="s1">bunch_liac</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">bunch_pandas</span><span class="s3">.</span><span class="s1">data</span>

    <span class="s2">def </span><span class="s1">convert_numerical_dtypes</span><span class="s3">(</span><span class="s1">series</span><span class="s3">):</span>
        <span class="s1">pandas_series </span><span class="s3">= </span><span class="s1">data_pandas</span><span class="s3">[</span><span class="s1">series</span><span class="s3">.</span><span class="s1">name</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">api</span><span class="s3">.</span><span class="s1">types</span><span class="s3">.</span><span class="s1">is_numeric_dtype</span><span class="s3">(</span><span class="s1">pandas_series</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">series</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">pandas_series</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">series</span>

    <span class="s1">data_liac_with_fixed_dtypes </span><span class="s3">= </span><span class="s1">data_liac</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">convert_numerical_dtypes</span><span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">data_liac_with_fixed_dtypes</span><span class="s3">, </span><span class="s1">data_pandas</span><span class="s3">)</span>

    <span class="s5"># Let's also check that the .frame attributes also match</span>
    <span class="s1">frame_liac</span><span class="s3">, </span><span class="s1">frame_pandas </span><span class="s3">= </span><span class="s1">bunch_liac</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">, </span><span class="s1">bunch_pandas</span><span class="s3">.</span><span class="s1">frame</span>

    <span class="s5"># Note that the .frame attribute is a superset of the .data attribute:</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">frame_pandas</span><span class="s3">[</span><span class="s1">bunch_pandas</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">], </span><span class="s1">data_pandas</span><span class="s3">)</span>

    <span class="s5"># However the remaining columns, typically the target(s), are not necessarily</span>
    <span class="s5"># dtyped similarly by both parsers due to limitations of the LIAC-ARFF parser.</span>
    <span class="s5"># Therefore, extra dtype conversions are required for those columns:</span>

    <span class="s2">def </span><span class="s1">convert_numerical_and_categorical_dtypes</span><span class="s3">(</span><span class="s1">series</span><span class="s3">):</span>
        <span class="s1">pandas_series </span><span class="s3">= </span><span class="s1">frame_pandas</span><span class="s3">[</span><span class="s1">series</span><span class="s3">.</span><span class="s1">name</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">api</span><span class="s3">.</span><span class="s1">types</span><span class="s3">.</span><span class="s1">is_numeric_dtype</span><span class="s3">(</span><span class="s1">pandas_series</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">series</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">pandas_series</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">pandas_series</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">CategoricalDtype</span><span class="s3">):</span>
            <span class="s5"># Compare categorical features by converting categorical liac uses</span>
            <span class="s5"># strings to denote the categories, we rename the categories to make</span>
            <span class="s5"># them comparable to the pandas parser. Fixing this behavior in</span>
            <span class="s5"># LIAC-ARFF would allow to check the consistency in the future but</span>
            <span class="s5"># we do not plan to maintain the LIAC-ARFF on the long term.</span>
            <span class="s2">return </span><span class="s1">series</span><span class="s3">.</span><span class="s1">cat</span><span class="s3">.</span><span class="s1">rename_categories</span><span class="s3">(</span><span class="s1">pandas_series</span><span class="s3">.</span><span class="s1">cat</span><span class="s3">.</span><span class="s1">categories</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">series</span>

    <span class="s1">frame_liac_with_fixed_dtypes </span><span class="s3">= </span><span class="s1">frame_liac</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span>
        <span class="s1">convert_numerical_and_categorical_dtypes</span>
    <span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">frame_liac_with_fixed_dtypes</span><span class="s3">, </span><span class="s1">frame_pandas</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_equivalence_array_dataframe</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the equivalence of the dataset when using `as_frame=False` and 
    `as_frame=True`. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">bunch_as_frame_true </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">bunch_as_frame_false </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">bunch_as_frame_false</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">bunch_as_frame_true</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">bunch_as_frame_false</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">bunch_as_frame_true</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_iris_pandas</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check fetching on a numerical only dataset with string labels.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">CategoricalDtype </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">api</span><span class="s3">.</span><span class="s1">types</span><span class="s3">.</span><span class="s1">CategoricalDtype</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">data_shape </span><span class="s3">= (</span><span class="s6">150</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)</span>
    <span class="s1">target_shape </span><span class="s3">= (</span><span class="s6">150</span><span class="s3">,)</span>
    <span class="s1">frame_shape </span><span class="s3">= (</span><span class="s6">150</span><span class="s3">, </span><span class="s6">5</span><span class="s3">)</span>

    <span class="s1">target_dtype </span><span class="s3">= </span><span class="s1">CategoricalDtype</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s4">&quot;Iris-setosa&quot;</span><span class="s3">, </span><span class="s4">&quot;Iris-versicolor&quot;</span><span class="s3">, </span><span class="s4">&quot;Iris-virginica&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">data_dtypes </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">] * </span><span class="s6">4</span>
    <span class="s1">data_names </span><span class="s3">= [</span><span class="s4">&quot;sepallength&quot;</span><span class="s3">, </span><span class="s4">&quot;sepalwidth&quot;</span><span class="s3">, </span><span class="s4">&quot;petallength&quot;</span><span class="s3">, </span><span class="s4">&quot;petalwidth&quot;</span><span class="s3">]</span>
    <span class="s1">target_name </span><span class="s3">= </span><span class="s4">&quot;class&quot;</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">bunch </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">target </span><span class="s3">= </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">frame </span><span class="s3">= </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">frame</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s3">== </span><span class="s1">data_dtypes</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">data_shape</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">== </span><span class="s1">data_names</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">feature_names </span><span class="s3">== </span><span class="s1">data_names</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target_names </span><span class="s3">== [</span><span class="s1">target_name</span><span class="s3">]</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">target</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">target_dtype</span>
    <span class="s2">assert </span><span class="s1">target</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">target_shape</span>
    <span class="s2">assert </span><span class="s1">target</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">target_name</span>
    <span class="s2">assert </span><span class="s1">target</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">is_unique</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">frame_shape</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s3">== </span><span class="s1">data_dtypes </span><span class="s3">+ [</span><span class="s1">target_dtype</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">is_unique</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;target_column&quot;</span><span class="s3">, [</span><span class="s4">&quot;petalwidth&quot;</span><span class="s3">, [</span><span class="s4">&quot;petalwidth&quot;</span><span class="s3">, </span><span class="s4">&quot;petallength&quot;</span><span class="s3">]])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_forcing_targets</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">, </span><span class="s1">target_column</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can force the target to not be the default target.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">bunch_forcing_target </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">target_column</span><span class="s3">=</span><span class="s1">target_column</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">bunch_default </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">bunch_forcing_target</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">, </span><span class="s1">bunch_default</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">target_column</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_index_equal</span><span class="s3">(</span>
            <span class="s1">bunch_forcing_target</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">(</span><span class="s1">target_column</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">bunch_forcing_target</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">150</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">bunch_forcing_target</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">target_column</span>
        <span class="s2">assert </span><span class="s1">bunch_forcing_target</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">150</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;data_id&quot;</span><span class="s3">, [</span><span class="s6">61</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">561</span><span class="s3">, </span><span class="s6">40589</span><span class="s3">, </span><span class="s6">1119</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_equivalence_frame_return_X_y</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `return_X_y=True` when `as_frame=True`.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">bunch </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">):</span>
        <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;data_id&quot;</span><span class="s3">, [</span><span class="s6">61</span><span class="s3">, </span><span class="s6">561</span><span class="s3">, </span><span class="s6">40589</span><span class="s3">, </span><span class="s6">1119</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_equivalence_array_return_X_y</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `return_X_y=True` when `as_frame=False`.&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">bunch </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_difference_parsers</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the difference between liac-arff and pandas parser.&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1119</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s5"># When `as_frame=False`, the categories will be ordinally encoded with</span>
    <span class="s5"># liac-arff parser while this is not the case with pandas parser.</span>
    <span class="s1">as_frame </span><span class="s3">= </span><span class="s2">False</span>
    <span class="s1">bunch_liac_arff </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s1">as_frame</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">bunch_pandas </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s1">as_frame</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">bunch_liac_arff</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;f&quot;</span>
    <span class="s2">assert </span><span class="s1">bunch_pandas</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s4">&quot;O&quot;</span>


<span class="s5">###############################################################################</span>
<span class="s5"># Test the ARFF parsing on several dataset to check if detect the correct</span>
<span class="s5"># types (categories, integers, floats).</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">scope</span><span class="s3">=</span><span class="s4">&quot;module&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">datasets_column_names</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Returns the columns names for each dataset.&quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s3">{</span>
        <span class="s6">61</span><span class="s3">: [</span><span class="s4">&quot;sepallength&quot;</span><span class="s3">, </span><span class="s4">&quot;sepalwidth&quot;</span><span class="s3">, </span><span class="s4">&quot;petallength&quot;</span><span class="s3">, </span><span class="s4">&quot;petalwidth&quot;</span><span class="s3">, </span><span class="s4">&quot;class&quot;</span><span class="s3">],</span>
        <span class="s6">2</span><span class="s3">: [</span>
            <span class="s4">&quot;family&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;product-type&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;steel&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;carbon&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;hardness&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;temper_rolling&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;condition&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;formability&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;strength&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;non-ageing&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;surface-finish&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;surface-quality&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;enamelability&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;bc&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;bf&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;bt&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;bw%2Fme&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;bl&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;m&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;chrom&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;phos&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;cbond&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;marvi&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;exptl&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ferro&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;corr&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;blue%2Fbright%2Fvarn%2Fclean&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;lustre&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;jurofm&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;s&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;p&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;shape&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;thick&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;width&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;len&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;oil&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;bore&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;packing&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;class&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s6">561</span><span class="s3">: [</span><span class="s4">&quot;vendor&quot;</span><span class="s3">, </span><span class="s4">&quot;MYCT&quot;</span><span class="s3">, </span><span class="s4">&quot;MMIN&quot;</span><span class="s3">, </span><span class="s4">&quot;MMAX&quot;</span><span class="s3">, </span><span class="s4">&quot;CACH&quot;</span><span class="s3">, </span><span class="s4">&quot;CHMIN&quot;</span><span class="s3">, </span><span class="s4">&quot;CHMAX&quot;</span><span class="s3">, </span><span class="s4">&quot;class&quot;</span><span class="s3">],</span>
        <span class="s6">40589</span><span class="s3">: [</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_Centroid&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_Rolloff&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_Flux&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_4&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_5&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_6&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_7&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_8&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_9&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_10&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_11&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Mean_Mem40_MFCC_12&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_Centroid&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_Rolloff&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_Flux&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_4&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_5&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_6&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_7&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_8&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_9&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_10&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_11&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Mean_Acc1298_Std_Mem40_MFCC_12&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_Centroid&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_Rolloff&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_Flux&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_4&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_5&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_6&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_7&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_8&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_9&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_10&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_11&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Mean_Mem40_MFCC_12&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_Centroid&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_Rolloff&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_Flux&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_4&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_5&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_6&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_7&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_8&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_9&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_10&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_11&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Std_Acc1298_Std_Mem40_MFCC_12&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BH_LowPeakAmp&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BH_LowPeakBPM&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BH_HighPeakAmp&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BH_HighPeakBPM&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BH_HighLowRatio&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BHSUM1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BHSUM2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BHSUM3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;amazed.suprised&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;happy.pleased&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;relaxing.calm&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;quiet.still&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;sad.lonely&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;angry.aggresive&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s6">1119</span><span class="s3">: [</span>
            <span class="s4">&quot;age&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;workclass&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;fnlwgt:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;education:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;education-num:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;marital-status:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;occupation:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;relationship:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;race:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;sex:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;capital-gain:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;capital-loss:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;hours-per-week:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;native-country:&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;class&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s6">40966</span><span class="s3">: [</span>
            <span class="s4">&quot;DYRK1A_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ITSN1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BDNF_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;NR1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;NR2A_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pAKT_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pBRAF_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pCAMKII_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pCREB_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pELK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pERK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pJNK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;PKCA_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pMEK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pNR1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pNR2A_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pNR2B_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pPKCAB_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pRSK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;AKT_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BRAF_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;CAMKII_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;CREB_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ELK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ERK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;GSK3B_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;JNK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;MEK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;TRKA_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;RSK_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;APP_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Bcatenin_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;SOD1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;MTOR_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;P38_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pMTOR_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;DSCR1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;AMPKA_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;NR2B_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pNUMB_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;RAPTOR_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;TIAM1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pP70S6_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;NUMB_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;P70S6_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pGSK3B_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pPKCG_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;CDK5_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;S6_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ADARB1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;AcetylH3K9_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;RRP1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BAX_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ARC_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ERBB4_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;nNOS_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Tau_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;GFAP_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;GluR3_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;GluR4_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;IL1B_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;P3525_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pCASP9_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;PSD95_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;SNCA_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;Ubiquitin_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pGSK3B_Tyr216_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;SHH_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BAD_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;BCL2_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pS6_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pCFOS_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;SYP_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;H3AcK18_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;EGR1_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;H3MeK4_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;CaNA_N&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;class&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s6">40945</span><span class="s3">: [</span>
            <span class="s4">&quot;pclass&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;survived&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;name&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;sex&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;age&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;sibsp&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;parch&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;ticket&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;fare&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;cabin&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;embarked&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;boat&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;body&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;home.dest&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
    <span class="s3">}</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">scope</span><span class="s3">=</span><span class="s4">&quot;module&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">datasets_missing_values</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s3">{</span>
        <span class="s6">61</span><span class="s3">: {},</span>
        <span class="s6">2</span><span class="s3">: {</span>
            <span class="s4">&quot;family&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;temper_rolling&quot;</span><span class="s3">: </span><span class="s6">9</span><span class="s3">,</span>
            <span class="s4">&quot;condition&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">,</span>
            <span class="s4">&quot;formability&quot;</span><span class="s3">: </span><span class="s6">4</span><span class="s3">,</span>
            <span class="s4">&quot;non-ageing&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">,</span>
            <span class="s4">&quot;surface-finish&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;enamelability&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;bc&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;bf&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">,</span>
            <span class="s4">&quot;bt&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;bw%2Fme&quot;</span><span class="s3">: </span><span class="s6">8</span><span class="s3">,</span>
            <span class="s4">&quot;bl&quot;</span><span class="s3">: </span><span class="s6">9</span><span class="s3">,</span>
            <span class="s4">&quot;m&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;chrom&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;phos&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;cbond&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">,</span>
            <span class="s4">&quot;marvi&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;exptl&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;ferro&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;corr&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;blue%2Fbright%2Fvarn%2Fclean&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;lustre&quot;</span><span class="s3">: </span><span class="s6">8</span><span class="s3">,</span>
            <span class="s4">&quot;jurofm&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;s&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;p&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
            <span class="s4">&quot;oil&quot;</span><span class="s3">: </span><span class="s6">10</span><span class="s3">,</span>
            <span class="s4">&quot;packing&quot;</span><span class="s3">: </span><span class="s6">11</span><span class="s3">,</span>
        <span class="s3">},</span>
        <span class="s6">561</span><span class="s3">: {},</span>
        <span class="s6">40589</span><span class="s3">: {},</span>
        <span class="s6">1119</span><span class="s3">: {},</span>
        <span class="s6">40966</span><span class="s3">: {</span><span class="s4">&quot;BCL2_N&quot;</span><span class="s3">: </span><span class="s6">7</span><span class="s3">},</span>
        <span class="s6">40945</span><span class="s3">: {</span>
            <span class="s4">&quot;age&quot;</span><span class="s3">: </span><span class="s6">263</span><span class="s3">,</span>
            <span class="s4">&quot;fare&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">,</span>
            <span class="s4">&quot;cabin&quot;</span><span class="s3">: </span><span class="s6">1014</span><span class="s3">,</span>
            <span class="s4">&quot;embarked&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">,</span>
            <span class="s4">&quot;boat&quot;</span><span class="s3">: </span><span class="s6">823</span><span class="s3">,</span>
            <span class="s4">&quot;body&quot;</span><span class="s3">: </span><span class="s6">1188</span><span class="s3">,</span>
            <span class="s4">&quot;home.dest&quot;</span><span class="s3">: </span><span class="s6">564</span><span class="s3">,</span>
        <span class="s3">},</span>
    <span class="s3">}</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data_id, parser, expected_n_categories, expected_n_floats, expected_n_ints&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s5"># iris dataset</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s5"># anneal dataset</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">33</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">33</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
        <span class="s5"># cpu dataset</span>
        <span class="s3">(</span><span class="s6">561</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">561</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">7</span><span class="s3">),</span>
        <span class="s5"># emotions dataset</span>
        <span class="s3">(</span><span class="s6">40589</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">72</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">40589</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">69</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
        <span class="s5"># adult-census dataset</span>
        <span class="s3">(</span><span class="s6">1119</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">1119</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">9</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">6</span><span class="s3">),</span>
        <span class="s5"># miceprotein</span>
        <span class="s3">(</span><span class="s6">40966</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">77</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">40966</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">77</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s5"># titanic</span>
        <span class="s3">(</span><span class="s6">40945</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s6">40945</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_types_inference</span><span class="s3">(</span>
    <span class="s1">monkeypatch</span><span class="s3">,</span>
    <span class="s1">data_id</span><span class="s3">,</span>
    <span class="s1">parser</span><span class="s3">,</span>
    <span class="s1">expected_n_categories</span><span class="s3">,</span>
    <span class="s1">expected_n_floats</span><span class="s3">,</span>
    <span class="s1">expected_n_ints</span><span class="s3">,</span>
    <span class="s1">gzip_response</span><span class="s3">,</span>
    <span class="s1">datasets_column_names</span><span class="s3">,</span>
    <span class="s1">datasets_missing_values</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that `fetch_openml` infer the right number of categories, integers, and 
    floats.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">CategoricalDtype </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">api</span><span class="s3">.</span><span class="s1">types</span><span class="s3">.</span><span class="s1">CategoricalDtype</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s1">gzip_response</span><span class="s3">)</span>

    <span class="s1">bunch </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">frame </span><span class="s3">= </span><span class="s1">bunch</span><span class="s3">.</span><span class="s1">frame</span>

    <span class="s1">n_categories </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s1">dtype </span><span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">CategoricalDtype</span><span class="s3">)]</span>
    <span class="s3">)</span>
    <span class="s1">n_floats </span><span class="s3">= </span><span class="s1">len</span><span class="s3">([</span><span class="s1">dtype </span><span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s2">if </span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;f&quot;</span><span class="s3">])</span>
    <span class="s1">n_ints </span><span class="s3">= </span><span class="s1">len</span><span class="s3">([</span><span class="s1">dtype </span><span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s2">if </span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;i&quot;</span><span class="s3">])</span>

    <span class="s2">assert </span><span class="s1">n_categories </span><span class="s3">== </span><span class="s1">expected_n_categories</span>
    <span class="s2">assert </span><span class="s1">n_floats </span><span class="s3">== </span><span class="s1">expected_n_floats</span>
    <span class="s2">assert </span><span class="s1">n_ints </span><span class="s3">== </span><span class="s1">expected_n_ints</span>

    <span class="s2">assert </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">() == </span><span class="s1">datasets_column_names</span><span class="s3">[</span><span class="s1">data_id</span><span class="s3">]</span>

    <span class="s1">frame_feature_to_n_nan </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">isna</span><span class="s3">().</span><span class="s1">sum</span><span class="s3">().</span><span class="s1">to_dict</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">n_missing </span><span class="s2">in </span><span class="s1">frame_feature_to_n_nan</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">expected_missing </span><span class="s3">= </span><span class="s1">datasets_missing_values</span><span class="s3">[</span><span class="s1">data_id</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">n_missing </span><span class="s3">== </span><span class="s1">expected_missing</span>


<span class="s5">###############################################################################</span>
<span class="s5"># Test some more specific behaviour</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;params, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;unknown&quot;</span><span class="s3">},</span>
            <span class="s4">&quot;The 'parser' parameter of fetch_openml must be a str among&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s4">&quot;unknown&quot;</span><span class="s3">},</span>
            <span class="s4">&quot;The 'as_frame' parameter of fetch_openml must be an instance&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_validation_parameter</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1119</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;params&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">{</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;auto&quot;</span><span class="s3">},</span>
        <span class="s3">{</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s4">&quot;auto&quot;</span><span class="s3">, </span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;auto&quot;</span><span class="s3">},</span>
        <span class="s3">{</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;pandas&quot;</span><span class="s3">},</span>
        <span class="s3">{</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;auto&quot;</span><span class="s3">},</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_requires_pandas_error</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">params</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise the proper errors when we require pandas.&quot;&quot;&quot;</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1119</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">check_pandas_support</span><span class="s3">(</span><span class="s4">&quot;test_fetch_openml_requires_pandas&quot;</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
        <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">err_msg </span><span class="s3">= </span><span class="s4">&quot;requires pandas to be installed. Alternatively, explicitly&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
            <span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">SkipTest</span><span class="s3">(</span><span class="s4">&quot;This test requires pandas to not be installed.&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s4">&quot;ignore:Version 1 of dataset Australian is inactive&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;params, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;pandas&quot;</span><span class="s3">},</span>
            <span class="s4">&quot;Sparse ARFF datasets cannot be loaded with parser='pandas'&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">},</span>
            <span class="s4">&quot;Sparse ARFF datasets cannot be loaded with as_frame=True.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">},</span>
            <span class="s4">&quot;Sparse ARFF datasets cannot be loaded with as_frame=True.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_sparse_arff_error</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise the expected error for sparse ARFF datasets and 
    a wrong set of incompatible parameters. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">292</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">**</span><span class="s1">params</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s4">&quot;ignore:Version 1 of dataset Australian is inactive&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data_id, data_type&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s6">61</span><span class="s3">, </span><span class="s4">&quot;dataframe&quot;</span><span class="s3">),  </span><span class="s5"># iris dataset version 1</span>
        <span class="s3">(</span><span class="s6">292</span><span class="s3">, </span><span class="s4">&quot;sparse&quot;</span><span class="s3">),  </span><span class="s5"># Australian dataset version 1</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_auto_mode</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">data_type</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the auto mode of `fetch_openml`.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">=</span><span class="s4">&quot;auto&quot;</span><span class="s3">, </span><span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">klass </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame </span><span class="s2">if </span><span class="s1">data_type </span><span class="s3">== </span><span class="s4">&quot;dataframe&quot; </span><span class="s2">else </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">csr_matrix</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">klass</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s2">def </span><span class="s1">test_convert_arff_data_dataframe_warning_low_memory_pandas</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise a warning regarding the working memory when using 
    LIAC-ARFF parser.&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1119</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Could not adhere to working_memory config.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">config_context</span><span class="s3">(</span><span class="s1">working_memory</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">):</span>
            <span class="s1">fetch_openml</span><span class="s3">(</span>
                <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
                <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_iris_warn_multiple_version</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that a warning is raised when multiple versions exist and no version is 
    requested.&quot;&quot;&quot;</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">data_name </span><span class="s3">= </span><span class="s4">&quot;iris&quot;</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Multiple active versions of the dataset matching the name&quot;</span>
        <span class="s4">&quot; iris exist. Versions may be fundamentally different, &quot;</span>
        <span class="s4">&quot;returning version 1. Available versions:</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s4">&quot;- version 1, status: active</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s4">&quot;  url: https://www.openml.org/search?type=data&amp;id=61</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s4">&quot;- version 3, status: active</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s4">&quot;  url: https://www.openml.org/search?type=data&amp;id=969</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">data_name</span><span class="s3">,</span>
            <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_no_target</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can get a dataset without target.&quot;&quot;&quot;</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">target_column </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">expected_observations </span><span class="s3">= </span><span class="s6">150</span>
    <span class="s1">expected_features </span><span class="s3">= </span><span class="s6">5</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">target_column</span><span class="s3">=</span><span class="s1">target_column</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">data</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">expected_observations</span><span class="s3">, </span><span class="s1">expected_features</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">data</span><span class="s3">.</span><span class="s1">target </span><span class="s2">is None</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_missing_values_pandas</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;check that missing values in categories are compatible with pandas 
    categorical&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">42585</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">penguins </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">cat_dtype </span><span class="s3">= </span><span class="s1">penguins</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">[</span><span class="s4">&quot;sex&quot;</span><span class="s3">]</span>
    <span class="s5"># there are nans in the categorical</span>
    <span class="s2">assert </span><span class="s1">penguins</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;sex&quot;</span><span class="s3">].</span><span class="s1">isna</span><span class="s3">().</span><span class="s1">any</span><span class="s3">()</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">cat_dtype</span><span class="s3">.</span><span class="s1">categories</span><span class="s3">, [</span><span class="s4">&quot;FEMALE&quot;</span><span class="s3">, </span><span class="s4">&quot;MALE&quot;</span><span class="s3">, </span><span class="s4">&quot;_&quot;</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;dataset_params&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40675</span><span class="s3">},</span>
        <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;glass2&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">},</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_inactive</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">, </span><span class="s1">dataset_params</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise a warning when the dataset is inactive.&quot;&quot;&quot;</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">40675</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Version 1 of dataset glass2 is inactive,&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">glass2 </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, **</span><span class="s1">dataset_params</span>
        <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">glass2</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">163</span><span class="s3">, </span><span class="s6">9</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">glass2</span><span class="s3">.</span><span class="s1">details</span><span class="s3">[</span><span class="s4">&quot;id&quot;</span><span class="s3">] == </span><span class="s4">&quot;40675&quot;</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data_id, params, err_type, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s6">40675</span><span class="s3">, {</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;glass2&quot;</span><span class="s3">}, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s4">&quot;No active dataset glass2 found&quot;</span><span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s6">61</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">61</span><span class="s3">, </span><span class="s4">&quot;target_column&quot;</span><span class="s3">: [</span><span class="s4">&quot;sepalwidth&quot;</span><span class="s3">, </span><span class="s4">&quot;class&quot;</span><span class="s3">]},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;Can only handle homogeneous multi-target datasets&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s6">40945</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">40945</span><span class="s3">, </span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s3">(</span>
                <span class="s4">&quot;STRING attributes are not supported for array representation. Try&quot;</span>
                <span class="s4">&quot; as_frame=True&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s6">2</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">, </span><span class="s4">&quot;target_column&quot;</span><span class="s3">: </span><span class="s4">&quot;family&quot;</span><span class="s3">, </span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;Target column 'family'&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s6">2</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">, </span><span class="s4">&quot;target_column&quot;</span><span class="s3">: </span><span class="s4">&quot;family&quot;</span><span class="s3">, </span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;Target column 'family'&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s6">61</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">61</span><span class="s3">, </span><span class="s4">&quot;target_column&quot;</span><span class="s3">: </span><span class="s4">&quot;undefined&quot;</span><span class="s3">},</span>
            <span class="s1">KeyError</span><span class="s3">,</span>
            <span class="s4">&quot;Could not find target_column='undefined'&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s6">61</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s6">61</span><span class="s3">, </span><span class="s4">&quot;target_column&quot;</span><span class="s3">: [</span><span class="s4">&quot;undefined&quot;</span><span class="s3">, </span><span class="s4">&quot;class&quot;</span><span class="s3">]},</span>
            <span class="s1">KeyError</span><span class="s3">,</span>
            <span class="s4">&quot;Could not find target_column='undefined'&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, [</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_error</span><span class="s3">(</span>
    <span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">, </span><span class="s1">parser</span>
<span class="s3">):</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">params</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">) </span><span class="s2">or </span><span class="s1">parser </span><span class="s3">== </span><span class="s4">&quot;pandas&quot;</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;params, err_type, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: -</span><span class="s6">1</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s4">&quot;version&quot;</span><span class="s3">},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;The 'version' parameter of fetch_openml must be an int in the range&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: -</span><span class="s6">1</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;nAmE&quot;</span><span class="s3">},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;The 'data_id' parameter of fetch_openml must be an int in the range&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{</span><span class="s4">&quot;data_id&quot;</span><span class="s3">: -</span><span class="s6">1</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;nAmE&quot;</span><span class="s3">, </span><span class="s4">&quot;version&quot;</span><span class="s3">: </span><span class="s4">&quot;version&quot;</span><span class="s3">},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;The 'version' parameter of fetch_openml must be an int&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{},</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">&quot;Neither name nor data_id are provided. Please provide name or data_id.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_raises_illegal_argument</span><span class="s3">(</span><span class="s1">params</span><span class="s3">, </span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_warn_ignore_attribute</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">40966</span>
    <span class="s1">expected_row_id_msg </span><span class="s3">= </span><span class="s4">&quot;target_column='{}' has flag is_row_identifier.&quot;</span>
    <span class="s1">expected_ignore_msg </span><span class="s3">= </span><span class="s4">&quot;target_column='{}' has flag is_ignore.&quot;</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s5"># single column test</span>
    <span class="s1">target_col </span><span class="s3">= </span><span class="s4">&quot;MouseID&quot;</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">expected_row_id_msg</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">target_col</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
            <span class="s1">target_column</span><span class="s3">=</span><span class="s1">target_col</span><span class="s3">,</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s1">target_col </span><span class="s3">= </span><span class="s4">&quot;Genotype&quot;</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">expected_ignore_msg</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">target_col</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
            <span class="s1">target_column</span><span class="s3">=</span><span class="s1">target_col</span><span class="s3">,</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s5"># multi column test</span>
    <span class="s1">target_col </span><span class="s3">= </span><span class="s4">&quot;MouseID&quot;</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">expected_row_id_msg</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">target_col</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
            <span class="s1">target_column</span><span class="s3">=[</span><span class="s1">target_col</span><span class="s3">, </span><span class="s4">&quot;class&quot;</span><span class="s3">],</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s1">target_col </span><span class="s3">= </span><span class="s4">&quot;Genotype&quot;</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">expected_ignore_msg</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">target_col</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
            <span class="s1">target_column</span><span class="s3">=[</span><span class="s1">target_col</span><span class="s3">, </span><span class="s4">&quot;class&quot;</span><span class="s3">],</span>
            <span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_dataset_with_openml_error</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;OpenML registered a problem with the dataset. It might be unusable. Error:&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_dataset_with_openml_warning</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">3</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;OpenML raised a warning on the dataset. It might be unusable. Warning:&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_overwrite_default_params_read_csv</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can overwrite the default parameters of `read_csv`.&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1590</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">common_params </span><span class="s3">= {</span>
        <span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;cache&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;parser&quot;</span><span class="s3">: </span><span class="s4">&quot;pandas&quot;</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s5"># By default, the initial spaces are skipped. We checked that setting the parameter</span>
    <span class="s5"># `skipinitialspace` to False will have an effect.</span>
    <span class="s1">adult_without_spaces </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(**</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">adult_with_spaces </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s3">**</span><span class="s1">common_params</span><span class="s3">, </span><span class="s1">read_csv_kwargs</span><span class="s3">={</span><span class="s4">&quot;skipinitialspace&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span>
        <span class="s1">cat</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot; &quot;</span><span class="s3">) </span><span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">adult_with_spaces</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">].</span><span class="s1">cat</span><span class="s3">.</span><span class="s1">categories</span>
    <span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">any</span><span class="s3">(</span>
        <span class="s1">cat</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot; &quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">adult_without_spaces</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">].</span><span class="s1">cat</span><span class="s3">.</span><span class="s1">categories</span>
    <span class="s3">)</span>


<span class="s5">###############################################################################</span>
<span class="s5"># Test cache, retry mechanisms, checksum, etc.</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_open_openml_url_cache</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>

    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">openml_path </span><span class="s3">= </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">.</span><span class="s1">_DATA_FILE</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">)</span>
    <span class="s1">cache_directory </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s4">&quot;scikit_learn_data&quot;</span><span class="s3">))</span>
    <span class="s5"># first fill the cache</span>
    <span class="s1">response1 </span><span class="s3">= </span><span class="s1">_open_openml_url</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>
    <span class="s5"># assert file exists</span>
    <span class="s1">location </span><span class="s3">= </span><span class="s1">_get_local_path</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">location</span><span class="s3">)</span>
    <span class="s5"># redownload, to utilize cache</span>
    <span class="s1">response2 </span><span class="s3">= </span><span class="s1">_open_openml_url</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">response1</span><span class="s3">.</span><span class="s1">read</span><span class="s3">() == </span><span class="s1">response2</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;write_to_disk&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_open_openml_url_unlinks_local_path</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">write_to_disk</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">openml_path </span><span class="s3">= </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">.</span><span class="s1">_DATA_FILE</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">)</span>
    <span class="s1">cache_directory </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s4">&quot;scikit_learn_data&quot;</span><span class="s3">))</span>
    <span class="s1">location </span><span class="s3">= </span><span class="s1">_get_local_path</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen</span><span class="s3">(</span><span class="s1">request</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">write_to_disk</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">location</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Invalid request&quot;</span><span class="s3">)</span>

    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">, </span><span class="s4">&quot;urlopen&quot;</span><span class="s3">, </span><span class="s1">_mock_urlopen</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Invalid request&quot;</span><span class="s3">):</span>
        <span class="s1">_open_openml_url</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>

    <span class="s2">assert not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">location</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_retry_with_clean_cache</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">openml_path </span><span class="s3">= </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">.</span><span class="s1">_DATA_FILE</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">)</span>
    <span class="s1">cache_directory </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s4">&quot;scikit_learn_data&quot;</span><span class="s3">))</span>
    <span class="s1">location </span><span class="s3">= </span><span class="s1">_get_local_path</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>
    <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">location</span><span class="s3">))</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">location</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">_retry_with_clean_cache</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">_load_data</span><span class="s3">():</span>
        <span class="s5"># The first call will raise an error since location exists</span>
        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">location</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s4">&quot;File exist!&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s6">1</span>

    <span class="s1">warn_msg </span><span class="s3">= </span><span class="s4">&quot;Invalid cache, redownloading file&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">RuntimeWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warn_msg</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">_load_data</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s6">1</span>


<span class="s2">def </span><span class="s1">test_retry_with_clean_cache_http_error</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">):</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">openml_path </span><span class="s3">= </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">.</span><span class="s1">_DATA_FILE</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">data_id</span><span class="s3">)</span>
    <span class="s1">cache_directory </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s4">&quot;scikit_learn_data&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">_retry_with_clean_cache</span><span class="s3">(</span><span class="s1">openml_path</span><span class="s3">, </span><span class="s1">cache_directory</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">_load_data</span><span class="s3">():</span>
        <span class="s2">raise </span><span class="s1">HTTPError</span><span class="s3">(</span>
            <span class="s1">url</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">code</span><span class="s3">=</span><span class="s6">412</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s4">&quot;Simulated mock error&quot;</span><span class="s3">, </span><span class="s1">hdrs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">=</span><span class="s1">BytesIO</span><span class="s3">()</span>
        <span class="s3">)</span>

    <span class="s1">error_msg </span><span class="s3">= </span><span class="s4">&quot;Simulated mock error&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">HTTPError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
        <span class="s1">_load_data</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_cache</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">_mock_urlopen_raise</span><span class="s3">(</span><span class="s1">request</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
            <span class="s4">&quot;This mechanism intends to test correct cache&quot;</span>
            <span class="s4">&quot;handling. As such, urlopen should never be &quot;</span>
            <span class="s4">&quot;accessed. URL: %s&quot; </span><span class="s3">% </span><span class="s1">request</span><span class="s3">.</span><span class="s1">get_full_url</span><span class="s3">()</span>
        <span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">61</span>
    <span class="s1">cache_directory </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s4">&quot;scikit_learn_data&quot;</span><span class="s3">))</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>
    <span class="s1">X_fetched</span><span class="s3">, </span><span class="s1">y_fetched </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">data_home</span><span class="s3">=</span><span class="s1">cache_directory</span><span class="s3">,</span>
        <span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">, </span><span class="s4">&quot;urlopen&quot;</span><span class="s3">, </span><span class="s1">_mock_urlopen_raise</span><span class="s3">)</span>

    <span class="s1">X_cached</span><span class="s3">, </span><span class="s1">y_cached </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">,</span>
        <span class="s1">cache</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">data_home</span><span class="s3">=</span><span class="s1">cache_directory</span><span class="s3">,</span>
        <span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_fetched</span><span class="s3">, </span><span class="s1">X_cached</span><span class="s3">)</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">y_fetched</span><span class="s3">, </span><span class="s1">y_cached</span><span class="s3">)</span>


<span class="s5"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s5"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s3">@</span><span class="s1">fails_if_pypy</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;as_frame, parser&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_verify_checksum</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">, </span><span class="s1">cache</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that the checksum is working as expected.&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">as_frame </span><span class="s2">or </span><span class="s1">parser </span><span class="s3">== </span><span class="s4">&quot;pandas&quot;</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">2</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s5"># create a temporary modified arff file</span>
    <span class="s1">original_data_module </span><span class="s3">= </span><span class="s1">OPENML_TEST_DATA_MODULE </span><span class="s3">+ </span><span class="s4">&quot;.&quot; </span><span class="s3">+ </span><span class="s4">f&quot;id_</span><span class="s2">{</span><span class="s1">data_id</span><span class="s2">}</span><span class="s4">&quot;</span>
    <span class="s1">original_data_file_name </span><span class="s3">= </span><span class="s4">&quot;data-v1-dl-1666876.arff.gz&quot;</span>
    <span class="s1">original_data_path </span><span class="s3">= </span><span class="s1">resources</span><span class="s3">.</span><span class="s1">files</span><span class="s3">(</span><span class="s1">original_data_module</span><span class="s3">) / </span><span class="s1">original_data_file_name</span>
    <span class="s1">corrupt_copy_path </span><span class="s3">= </span><span class="s1">tmpdir </span><span class="s3">/ </span><span class="s4">&quot;test_invalid_checksum.arff&quot;</span>
    <span class="s2">with </span><span class="s1">original_data_path</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">orig_file</span><span class="s3">:</span>
        <span class="s1">orig_gzip </span><span class="s3">= </span><span class="s1">gzip</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">orig_file</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">bytearray</span><span class="s3">(</span><span class="s1">orig_gzip</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
        <span class="s1">data</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) - </span><span class="s6">1</span><span class="s3">] = </span><span class="s6">37</span>

    <span class="s2">with </span><span class="s1">gzip</span><span class="s3">.</span><span class="s1">GzipFile</span><span class="s3">(</span><span class="s1">corrupt_copy_path</span><span class="s3">, </span><span class="s4">&quot;wb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">modified_gzip</span><span class="s3">:</span>
        <span class="s1">modified_gzip</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s5"># Requests are already mocked by monkey_patch_webbased_functions.</span>
    <span class="s5"># We want to reuse that mock for all requests except file download,</span>
    <span class="s5"># hence creating a thin mock over the original mock</span>
    <span class="s1">mocked_openml_url </span><span class="s3">= </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">.</span><span class="s1">urlopen</span>

    <span class="s2">def </span><span class="s1">swap_file_mock</span><span class="s3">(</span><span class="s1">request</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">request</span><span class="s3">.</span><span class="s1">get_full_url</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">url</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;data/v1/download/1666876&quot;</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">corrupt_copy_path</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">corrupted_data </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">_MockHTTPResponse</span><span class="s3">(</span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">corrupted_data</span><span class="s3">), </span><span class="s1">is_gzip</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">mocked_openml_url</span><span class="s3">(</span><span class="s1">request</span><span class="s3">)</span>

    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">, </span><span class="s4">&quot;urlopen&quot;</span><span class="s3">, </span><span class="s1">swap_file_mock</span><span class="s3">)</span>

    <span class="s5"># validate failed checksum</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">) </span><span class="s2">as </span><span class="s1">exc</span><span class="s3">:</span>
        <span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">fetch_openml</span><span class="s3">(</span>
            <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">=</span><span class="s1">as_frame</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span>
        <span class="s3">)</span>
    <span class="s5"># exception message should have file-path</span>
    <span class="s2">assert </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">&quot;1666876&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_open_openml_url_retry_on_network_error</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">_mock_urlopen_network_error</span><span class="s3">(</span><span class="s1">request</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">HTTPError</span><span class="s3">(</span>
            <span class="s1">url</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">code</span><span class="s3">=</span><span class="s6">404</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s4">&quot;Simulated network error&quot;</span><span class="s3">, </span><span class="s1">hdrs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">=</span><span class="s1">BytesIO</span><span class="s3">()</span>
        <span class="s3">)</span>

    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span>
        <span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">_openml</span><span class="s3">, </span><span class="s4">&quot;urlopen&quot;</span><span class="s3">, </span><span class="s1">_mock_urlopen_network_error</span>
    <span class="s3">)</span>

    <span class="s1">invalid_openml_url </span><span class="s3">= </span><span class="s4">&quot;invalid-url&quot;</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span>
        <span class="s1">UserWarning</span><span class="s3">,</span>
        <span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
            <span class="s4">&quot;A network error occurred while downloading&quot;</span>
            <span class="s4">f&quot; </span><span class="s2">{</span><span class="s1">_OPENML_PREFIX </span><span class="s3">+ </span><span class="s1">invalid_openml_url</span><span class="s2">}</span><span class="s4">. Retrying...&quot;</span>
        <span class="s3">),</span>
    <span class="s3">) </span><span class="s2">as </span><span class="s1">record</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">HTTPError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Simulated network error&quot;</span><span class="s3">):</span>
            <span class="s1">_open_openml_url</span><span class="s3">(</span><span class="s1">invalid_openml_url</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">delay</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">record</span><span class="s3">) == </span><span class="s6">3</span>


<span class="s5">###############################################################################</span>
<span class="s5"># Non-regressiont tests</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;gzip_response&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;parser&quot;</span><span class="s3">, (</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s4">&quot;pandas&quot;</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_with_ignored_feature</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can load the &quot;zoo&quot; dataset. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/14340 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">parser </span><span class="s3">== </span><span class="s4">&quot;pandas&quot;</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">62</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">)</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">cache</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">parser</span><span class="s3">=</span><span class="s1">parser</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dataset </span><span class="s2">is not None</span>
    <span class="s5"># The dataset has 17 features, including 1 ignored (animal),</span>
    <span class="s5"># so we assert that we don't have the ignored feature in the final Bunch</span>
    <span class="s2">assert </span><span class="s1">dataset</span><span class="s3">[</span><span class="s4">&quot;data&quot;</span><span class="s3">].</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">101</span><span class="s3">, </span><span class="s6">16</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s4">&quot;animal&quot; </span><span class="s2">not in </span><span class="s1">dataset</span><span class="s3">[</span><span class="s4">&quot;feature_names&quot;</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_strip_quotes</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we strip the single quotes when used as a string delimiter. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/23381 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">40966</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">common_params </span><span class="s3">= {</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;cache&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s1">data_id</span><span class="s3">}</span>
    <span class="s1">mice_pandas </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">mice_liac_arff </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">mice_pandas</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">mice_liac_arff</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">str</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;'&quot;</span><span class="s3">).</span><span class="s1">any</span><span class="s3">()</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">str</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;'&quot;</span><span class="s3">).</span><span class="s1">any</span><span class="s3">()</span>

    <span class="s5"># similar behaviour should be observed when the column is not the target</span>
    <span class="s1">mice_pandas </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">, </span><span class="s1">target_column</span><span class="s3">=</span><span class="s4">&quot;NUMB_N&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">mice_liac_arff </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span>
        <span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, </span><span class="s1">target_column</span><span class="s3">=</span><span class="s4">&quot;NUMB_N&quot;</span><span class="s3">, **</span><span class="s1">common_params</span>
    <span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span>
        <span class="s1">mice_pandas</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">], </span><span class="s1">mice_liac_arff</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">].</span><span class="s1">str</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;'&quot;</span><span class="s3">).</span><span class="s1">any</span><span class="s3">()</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">].</span><span class="s1">str</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;'&quot;</span><span class="s3">).</span><span class="s1">any</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_leading_whitespace</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can strip leading whitespace in pandas parser. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/25311 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">1590</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">common_params </span><span class="s3">= {</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;cache&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s1">data_id</span><span class="s3">}</span>
    <span class="s1">adult_pandas </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">adult_liac_arff </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span>
        <span class="s1">adult_pandas</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">], </span><span class="s1">adult_liac_arff</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">[</span><span class="s4">&quot;class&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_quotechar_escapechar</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can handle escapechar and single/double quotechar. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/25478 
    &quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">data_id </span><span class="s3">= </span><span class="s6">42074</span>
    <span class="s1">_monkey_patch_webbased_functions</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">data_id</span><span class="s3">=</span><span class="s1">data_id</span><span class="s3">, </span><span class="s1">gzip_response</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">common_params </span><span class="s3">= {</span><span class="s4">&quot;as_frame&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;cache&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;data_id&quot;</span><span class="s3">: </span><span class="s1">data_id</span><span class="s3">}</span>
    <span class="s1">adult_pandas </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">adult_liac_arff </span><span class="s3">= </span><span class="s1">fetch_openml</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">=</span><span class="s4">&quot;liac-arff&quot;</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">)</span>
    <span class="s1">pd</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">adult_pandas</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">, </span><span class="s1">adult_liac_arff</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">)</span>
</pre>
</body>
</html>