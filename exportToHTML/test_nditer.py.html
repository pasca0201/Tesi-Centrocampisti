<html>
<head>
<title>test_nditer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_nditer.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">textwrap</span>
<span class="s0">import </span><span class="s1">subprocess</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">umath </span><span class="s0">as </span><span class="s1">ncu</span>
<span class="s0">import </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">_multiarray_tests </span><span class="s0">as </span><span class="s1">_multiarray_tests</span>
<span class="s0">from </span><span class="s1">numpy </span><span class="s0">import </span><span class="s1">array</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">all</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_raises</span><span class="s2">,</span>
    <span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">, </span><span class="s1">break_cycles</span><span class="s2">,</span>
    <span class="s2">)</span>

<span class="s0">def </span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
    <span class="s1">ret </span><span class="s2">= []</span>
    <span class="s0">while not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">finished</span><span class="s2">:</span>
        <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s0">def </span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
    <span class="s1">ret </span><span class="s2">= []</span>
    <span class="s0">while not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">finished</span><span class="s2">:</span>
        <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s0">def </span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
    <span class="s1">ret </span><span class="s2">= []</span>
    <span class="s0">while not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">finished</span><span class="s2">:</span>
        <span class="s1">ret</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">ret</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Python lacks refcounts&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_iter_refcount</span><span class="s2">():</span>
    <span class="s4"># Make sure the iterator doesn't leak</span>

    <span class="s4"># Basic</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">newbyteorder</span><span class="s2">()</span>
    <span class="s1">rc_a </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">rc_dt </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">dt</span><span class="s2">]) </span><span class="s0">as </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">it</span><span class="s2">.</span><span class="s1">iterationneedsapi</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) &gt; </span><span class="s1">rc_a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">) &gt; </span><span class="s1">rc_dt</span><span class="s2">)</span>
    <span class="s4"># del 'it'</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">rc_a</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), </span><span class="s1">rc_dt</span><span class="s2">)</span>

    <span class="s4"># With a copy</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">rc_a </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">rc_dt </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">]],</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">dt</span><span class="s2">])</span>
    <span class="s1">rc2_a </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">rc2_dt </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
    <span class="s1">it2 </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) &gt; </span><span class="s1">rc2_a</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">13</span><span class="s2">):</span>
        <span class="s4"># np.dtype('f4') is immortal after Python 3.13</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">) &gt; </span><span class="s1">rc2_dt</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">rc2_a</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), </span><span class="s1">rc2_dt</span><span class="s2">)</span>
    <span class="s1">it2 </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">rc_a</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">), </span><span class="s1">rc_dt</span><span class="s2">)</span>

    <span class="s0">del </span><span class="s1">it2  </span><span class="s4"># avoid pyflakes unused variable warning</span>

<span class="s0">def </span><span class="s1">test_iter_best_order</span><span class="s2">():</span>
    <span class="s4"># The iterator should always find the iteration order</span>
    <span class="s4"># with increasing memory addresses</span>

    <span class="s4"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">5</span><span class="s2">,), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)]:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s4"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">**</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
            <span class="s1">dirs_index </span><span class="s2">= [</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s2">((</span><span class="s5">2</span><span class="s2">**</span><span class="s1">bit</span><span class="s2">) &amp; </span><span class="s1">dirs</span><span class="s2">):</span>
                    <span class="s1">dirs_index</span><span class="s2">[</span><span class="s1">bit</span><span class="s2">] = </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">dirs_index </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">dirs_index</span><span class="s2">)</span>

            <span class="s1">aview </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[</span><span class="s1">dirs_index</span><span class="s2">]</span>
            <span class="s4"># C-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s4"># Fortran-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s4"># Other order</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) &gt; </span><span class="s5">2</span><span class="s2">:</span>
                <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), [], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
                <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_c_order</span><span class="s2">():</span>
    <span class="s4"># Test forcing C order</span>

    <span class="s4"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">5</span><span class="s2">,), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)]:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s4"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">**</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
            <span class="s1">dirs_index </span><span class="s2">= [</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s2">((</span><span class="s5">2</span><span class="s2">**</span><span class="s1">bit</span><span class="s2">) &amp; </span><span class="s1">dirs</span><span class="s2">):</span>
                    <span class="s1">dirs_index</span><span class="s2">[</span><span class="s1">bit</span><span class="s2">] = </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">dirs_index </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">dirs_index</span><span class="s2">)</span>

            <span class="s1">aview </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[</span><span class="s1">dirs_index</span><span class="s2">]</span>
            <span class="s4"># C-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">aview</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">))</span>
            <span class="s4"># Fortran-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">))</span>
            <span class="s4"># Other order</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) &gt; </span><span class="s5">2</span><span class="s2">:</span>
                <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">],</span>
                                    <span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_f_order</span><span class="s2">():</span>
    <span class="s4"># Test forcing F order</span>

    <span class="s4"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">5</span><span class="s2">,), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)]:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s4"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">**</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
            <span class="s1">dirs_index </span><span class="s2">= [</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s2">((</span><span class="s5">2</span><span class="s2">**</span><span class="s1">bit</span><span class="s2">) &amp; </span><span class="s1">dirs</span><span class="s2">):</span>
                    <span class="s1">dirs_index</span><span class="s2">[</span><span class="s1">bit</span><span class="s2">] = </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">dirs_index </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">dirs_index</span><span class="s2">)</span>

            <span class="s1">aview </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[</span><span class="s1">dirs_index</span><span class="s2">]</span>
            <span class="s4"># C-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">aview</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">))</span>
            <span class="s4"># Fortran-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">))</span>
            <span class="s4"># Other order</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) &gt; </span><span class="s5">2</span><span class="s2">:</span>
                <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">],</span>
                                    <span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_c_or_f_order</span><span class="s2">():</span>
    <span class="s4"># Test forcing any contiguous (C or F) order</span>

    <span class="s4"># Test the ordering for 1-D to 5-D shapes</span>
    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">5</span><span class="s2">,), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)]:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s4"># Test each combination of positive and negative strides</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">**</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
            <span class="s1">dirs_index </span><span class="s2">= [</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s2">((</span><span class="s5">2</span><span class="s2">**</span><span class="s1">bit</span><span class="s2">) &amp; </span><span class="s1">dirs</span><span class="s2">):</span>
                    <span class="s1">dirs_index</span><span class="s2">[</span><span class="s1">bit</span><span class="s2">] = </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">dirs_index </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">dirs_index</span><span class="s2">)</span>

            <span class="s1">aview </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[</span><span class="s1">dirs_index</span><span class="s2">]</span>
            <span class="s4"># C-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">aview</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">))</span>
            <span class="s4"># Fortran-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">))</span>
            <span class="s4"># Other order</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) &gt; </span><span class="s5">2</span><span class="s2">:</span>
                <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">],</span>
                                    <span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_nditer_multi_index_set</span><span class="s2">():</span>
    <span class="s4"># Test the multi_index set</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=[</span><span class="s3">'multi_index'</span><span class="s2">])</span>

    <span class="s4"># Removes the iteration on two first elements of a[0]</span>
    <span class="s1">it</span><span class="s2">.</span><span class="s1">multi_index </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">,)</span>

    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">it</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Python lacks refcounts&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nditer_multi_index_set_refcount</span><span class="s2">():</span>
    <span class="s4"># Test if the reference count on index variable is decreased</span>

    <span class="s1">index </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">111</span><span class="s2">, </span><span class="s5">222</span><span class="s2">, </span><span class="s5">333</span><span class="s2">, </span><span class="s5">444</span><span class="s2">]), </span><span class="s1">flags</span><span class="s2">=[</span><span class="s3">'multi_index'</span><span class="s2">])</span>

    <span class="s1">start_count </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index </span><span class="s2">= (</span><span class="s1">index</span><span class="s2">,)</span>
    <span class="s1">end_count </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">start_count</span><span class="s2">, </span><span class="s1">end_count</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_multi_index_1d</span><span class="s2">():</span>
    <span class="s4"># The multi-indices should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s4"># 1D order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">0</span><span class="s2">,), (</span><span class="s5">1</span><span class="s2">,), (</span><span class="s5">2</span><span class="s2">,), (</span><span class="s5">3</span><span class="s2">,)])</span>
    <span class="s4"># 1D reversed order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">3</span><span class="s2">,), (</span><span class="s5">2</span><span class="s2">,), (</span><span class="s5">1</span><span class="s2">,), (</span><span class="s5">0</span><span class="s2">,)])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_multi_index_2d</span><span class="s2">():</span>
    <span class="s4"># The multi-indices should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s4"># 2D C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>
    <span class="s4"># 2D Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>
    <span class="s4"># 2D reversed C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s4"># 2D reversed Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                                   <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                                   <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_multi_index_3d</span><span class="s2">():</span>
    <span class="s4"># The multi-indices should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">)</span>
    <span class="s4"># 3D C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s4"># 3D Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s4"># 3D reversed C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:,:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s4"># 3D reversed Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">],</span>
                                                    <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                                    <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:,:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                                    <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_c_index_1d</span><span class="s2">():</span>
    <span class="s4"># The C index should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s4"># 1D order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
    <span class="s4"># 1D reversed order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_c_index_2d</span><span class="s2">():</span>
    <span class="s4"># The C index should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s4"># 2D C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s4"># 2D Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">),</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s4"># 2D reversed C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s4"># 2D reversed Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_c_index_3d</span><span class="s2">():</span>
    <span class="s4"># The C index should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">)</span>
    <span class="s4"># 3D C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">])</span>
    <span class="s4"># 3D Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">),</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">11</span><span class="s2">])</span>
    <span class="s4"># 3D reversed C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:,:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s4"># 3D reversed Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:,:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_f_index_1d</span><span class="s2">():</span>
    <span class="s4"># The Fortran index should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s4"># 1D order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
    <span class="s4"># 1D reversed order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_f_index_2d</span><span class="s2">():</span>
    <span class="s4"># The Fortran index should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s4"># 2D C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s4"># 2D Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">),</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s4"># 2D reversed C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s4"># 2D reversed Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_best_order_f_index_3d</span><span class="s2">():</span>
    <span class="s4"># The Fortran index should be correct with any reordering</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">)</span>
    <span class="s4"># 3D C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">11</span><span class="s2">])</span>
    <span class="s4"># 3D Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">),</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">])</span>
    <span class="s4"># 3D reversed C-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[:,:, ::-</span><span class="s5">1</span><span class="s2">], [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s4"># 3D reversed Fortran-order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)[:,:, ::-</span><span class="s5">1</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_indices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">),</span>
                            <span class="s2">[</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_no_inner_full_coalesce</span><span class="s2">():</span>
    <span class="s4"># Check no_inner iterators which coalesce into a single inner loop</span>

    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">5</span><span class="s2">,), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)]:</span>
        <span class="s1">size </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s4"># Test each combination of forward and backwards indexing</span>
        <span class="s0">for </span><span class="s1">dirs </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">**</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
            <span class="s1">dirs_index </span><span class="s2">= [</span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)]*</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">bit </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s2">((</span><span class="s5">2</span><span class="s2">**</span><span class="s1">bit</span><span class="s2">) &amp; </span><span class="s1">dirs</span><span class="s2">):</span>
                    <span class="s1">dirs_index</span><span class="s2">[</span><span class="s1">bit</span><span class="s2">] = </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">dirs_index </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">dirs_index</span><span class="s2">)</span>

            <span class="s1">aview </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)[</span><span class="s1">dirs_index</span><span class="s2">]</span>
            <span class="s4"># C-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">, [</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">size</span><span class="s2">,))</span>
            <span class="s4"># Fortran-order</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">size</span><span class="s2">,))</span>
            <span class="s4"># Other order</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) &gt; </span><span class="s5">2</span><span class="s2">:</span>
                <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">aview</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
                                    <span class="s2">[</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">size</span><span class="s2">,))</span>

<span class="s0">def </span><span class="s1">test_iter_no_inner_dim_coalescing</span><span class="s2">():</span>
    <span class="s4"># Check no_inner iterators whose dimensions may not coalesce completely</span>

    <span class="s4"># Skipping the last element in a dimension prevents coalescing</span>
    <span class="s4"># with the next-bigger dimension</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)[:,:, :-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">,))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)[:, :-</span><span class="s5">1</span><span class="s2">,:]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">8</span><span class="s2">,))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)[:-</span><span class="s5">1</span><span class="s2">,:,:]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">12</span><span class="s2">,))</span>

    <span class="s4"># Even with lots of 1-sized dimensions, should still coalesce</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'external_loop'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">24</span><span class="s2">,))</span>

<span class="s0">def </span><span class="s1">test_iter_dim_coalescing</span><span class="s2">():</span>
    <span class="s4"># Check that the correct number of dimensions are coalesced</span>

    <span class="s4"># Tracking a multi-index disables coalescing</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s4"># A tracked index can allow coalescing if it's compatible with the array</span>
    <span class="s1">a3d </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">, [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), [</span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s4"># When C or F order is forced, coalescing may still occur</span>
    <span class="s1">a3d </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a3d</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'A'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_broadcasting</span><span class="s2">():</span>
    <span class="s4"># Standard NumPy broadcasting rules</span>

    <span class="s4"># 1D with scalar</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">6</span><span class="s2">,))</span>

    <span class="s4"># 2D with scalar</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s4"># 2D with 1D</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s4"># 2D with 2D</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

    <span class="s4"># 3D with scalar</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s4"># 3D with 1D</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">8</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s4"># 3D with 2D</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">8</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s4"># 3D with 3D</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">),</span>
                        <span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_itershape</span><span class="s2">():</span>
    <span class="s4"># Check that allocated outputs work with a specified shape</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i2'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                            <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s0">None</span><span class="s2">],</span>
                            <span class="s1">itershape</span><span class="s2">=(-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">24</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                            <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s0">None</span><span class="s2">],</span>
                            <span class="s1">itershape</span><span class="s2">=(-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">8</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                            <span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">,</span>
                            <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s0">None</span><span class="s2">],</span>
                            <span class="s1">itershape</span><span class="s2">=(-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">12</span><span class="s2">))</span>

    <span class="s4"># If we specify 1 in the itershape, it shouldn't allow broadcasting</span>
    <span class="s4"># of that dimension to a bigger value</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                            <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                            <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s0">None</span><span class="s2">],</span>
                            <span class="s1">itershape</span><span class="s2">=(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s4"># Test bug that for no op_axes but itershape, they are NULLed correctly</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">itershape</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">,))</span>

<span class="s0">def </span><span class="s1">test_iter_broadcasting_errors</span><span class="s2">():</span>
    <span class="s4"># Check that errors are thrown for bad broadcasting shapes</span>

    <span class="s4"># 1D with 1D</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)],</span>
                    <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4"># 2D with 1D</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">,</span>
                    <span class="s2">[</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)],</span>
                    <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4"># 2D with 2D</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">,</span>
                    <span class="s2">[</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
                    <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">,</span>
                    <span class="s2">[</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)],</span>
                    <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4"># 3D with 3D</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">,</span>
                    <span class="s2">[</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">36</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)],</span>
                    <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">,</span>
                    <span class="s2">[</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">8</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)],</span>
                    <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s4"># Verify that the error message mentions the right shapes</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
                <span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">),</span>
                <span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)],</span>
               <span class="s2">[],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'no_broadcast'</span><span class="s2">]])</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">'Should have raised a broadcast error'</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
        <span class="s4"># The message should contain the shape of the 3rd operand</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(2,3)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain operand shape (2,3)' </span><span class="s2">% </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s4"># The message should contain the broadcast shape</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(1,2,3)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain broadcast shape (1,2,3)' </span><span class="s2">% </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">nditer</span><span class="s2">([</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)],</span>
               <span class="s2">[],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]],</span>
               <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]],</span>
               <span class="s1">itershape</span><span class="s2">=(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">'Should have raised a broadcast error'</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
        <span class="s4"># The message should contain &quot;shape-&gt;remappedshape&quot; for each operand</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(2,3)-&gt;(2,3)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
            <span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain operand shape (2,3)-&gt;(2,3)' </span><span class="s2">% </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(2,)-&gt;(2,newaxis)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s2">(</span><span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain remapped operand shape' </span><span class="s2">+</span>
                <span class="s3">'(2,)-&gt;(2,newaxis)'</span><span class="s2">) % </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s4"># The message should contain the itershape parameter</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(4,3)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain itershape parameter (4,3)' </span><span class="s2">% </span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">nditer</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">2</span><span class="s2">,))],</span>
               <span class="s2">[],</span>
               <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'no_broadcast'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">'Should have raised a broadcast error'</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>
        <span class="s4"># The message should contain the shape of the bad operand</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(2,1,1)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
            <span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain operand shape (2,1,1)' </span><span class="s2">% </span><span class="s1">msg</span><span class="s2">)</span>
        <span class="s4"># The message should contain the broadcast shape</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s3">'(2,1,2)'</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">,</span>
                <span class="s3">'Message &quot;%s&quot; doesn</span><span class="s0">\'</span><span class="s3">t contain the broadcast shape (2,1,2)' </span><span class="s2">% </span><span class="s1">msg</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_flags_errors</span><span class="s2">():</span>
    <span class="s4"># Check that bad combinations of flags produce errors</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>

    <span class="s4"># Not enough operands</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [], [], [])</span>
    <span class="s4"># Too many operands</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">]*</span><span class="s5">100</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s4"># Bad global flag</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">], [</span><span class="s3">'bad flag'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s4"># Bad op flag</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'bad flag'</span><span class="s2">]])</span>
    <span class="s4"># Bad order parameter</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'G'</span><span class="s2">)</span>
    <span class="s4"># Bad casting parameter</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">'noon'</span><span class="s2">)</span>
    <span class="s4"># op_flags must match ops</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">]*</span><span class="s5">3</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4"># Cannot track both a C and an F index</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s3">'c_index'</span><span class="s2">, </span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s4"># Inner iteration and multi-indices/indices are incompatible</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'c_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'f_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s4"># Must specify exactly one of readwrite/readonly/writeonly per operand</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [], [[]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'writeonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">,</span>
                <span class="s2">[], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s4"># Python scalars are always readonly</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, [], [[</span><span class="s3">'writeonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s4"># Array scalars are always readonly</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s5">1</span><span class="s2">), [], [[</span><span class="s3">'writeonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s5">1</span><span class="s2">), [], [[</span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s4"># Check readonly array</span>
    <span class="s1">a</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'writeonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s1">a</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s4"># Multi-indices available only with the multi_index flag</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">), [], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s4"># Index available only with an index flag</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s4"># GotoCoords and GotoIndex incompatible with buffering or no_inner</span>

    <span class="s0">def </span><span class="s1">assign_multi_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">,)</span>

    <span class="s0">def </span><span class="s1">assign_index</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">assign_iterindex</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">assign_iterrange</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange </span><span class="s2">= (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">), [</span><span class="s3">'external_loop'</span><span class="s2">])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_multi_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_iterindex</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_iterrange</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">), [</span><span class="s3">'buffered'</span><span class="s2">])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_multi_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_iterrange</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s4"># Can't iterate if size is zero</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([]))</span>

<span class="s0">def </span><span class="s1">test_iter_slice</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3.</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [], [</span><span class="s3">'readwrite'</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">2</span><span class="s2">] = (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s5">12</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">12</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_assign_mapping</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                       <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][...] = </span><span class="s5">3</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][...] = </span><span class="s5">14</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">14</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                       <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][-</span><span class="s5">1</span><span class="s2">:</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">14</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][...] = -</span><span class="s5">1234</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, -</span><span class="s5">1234</span><span class="s2">)</span>
    <span class="s4"># check for no warnings on dealloc</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s0">None</span>

<span class="s0">def </span><span class="s1">test_iter_nbo_align_contig</span><span class="s2">():</span>
    <span class="s4"># Check that byte order, alignment, and contig changes work</span>

    <span class="s4"># Byte order change by requesting a specific dtype</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">!= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                        <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">,</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s4"># context manager triggers WRITEBACKIFCOPY on i at exit</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">byteorder</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = </span><span class="s5">2</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">]*</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">i  </span><span class="s4"># should not raise a warning</span>
    <span class="s4"># Byte order change by requesting NBO</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">!= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">]],</span>
                        <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s4"># context manager triggers UPDATEIFCOPY on i at exit</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">byteorder</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = </span><span class="s5">12345</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = </span><span class="s5">2</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">]*</span><span class="s5">6</span><span class="s2">)</span>

    <span class="s4"># Unaligned input</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">*</span><span class="s5">4</span><span class="s2">+</span><span class="s5">1</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i1'</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:]</span>
    <span class="s1">a</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s3">'f4'</span>
    <span class="s1">a</span><span class="s2">[:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">aligned</span><span class="s2">)</span>
    <span class="s4"># Without 'aligned', shouldn't copy</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">aligned</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s4"># With 'aligned', should make a copy</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">aligned</span><span class="s2">)</span>
        <span class="s4"># context manager triggers UPDATEIFCOPY on i at exit</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = </span><span class="s5">3</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">3</span><span class="s2">]*</span><span class="s5">6</span><span class="s2">)</span>

    <span class="s4"># Discontiguous input</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">)</span>
    <span class="s4"># If it is contiguous, shouldn't copy</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:</span><span class="s5">6</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">contiguous</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[:</span><span class="s5">6</span><span class="s2">])</span>
    <span class="s4"># If it isn't contiguous, should buffer</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'contig'</span><span class="s2">]],</span>
                        <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">contiguous</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_array_cast</span><span class="s2">():</span>
    <span class="s4"># Check that arrays are cast as requested</span>

    <span class="s4"># No cast 'f4' -&gt; 'f4'</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">]], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>

    <span class="s4"># Byte-order cast '&lt;f4' -&gt; '&gt;f4'</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'&lt;f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">,</span>
            <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'&gt;f4'</span><span class="s2">)]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'&gt;f4'</span><span class="s2">))</span>

    <span class="s4"># Safe case 'f4' -&gt; 'f8'</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]],</span>
            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">,</span>
            <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s4"># The memory layout of the temporary should match a (a is (48,4,16))</span>
    <span class="s4"># except negative strides get flipped to positive strides.</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">96</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">32</span><span class="s2">))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">,:, ::-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]],</span>
            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">,</span>
            <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">96</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">32</span><span class="s2">))</span>

    <span class="s4"># Same-kind cast 'f8' -&gt; 'f4' -&gt; 'f8'</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [],</span>
            <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
            <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">48</span><span class="s2">))</span>
        <span class="s4"># Check that WRITEBACKIFCOPY is activated at exit</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] = -</span><span class="s5">12.5</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] != -</span><span class="s5">12.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], -</span><span class="s5">12.5</span><span class="s2">)</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)[::-</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [],</span>
            <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
            <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
        <span class="s4"># Even though the stride was negative in 'a', it</span>
        <span class="s4"># becomes positive in the temporary</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">,))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_array_cast_errors</span><span class="s2">():</span>
    <span class="s4"># Check that invalid casts are caught</span>

    <span class="s4"># Need to enable copying for casts to occur</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s4"># Also need to allow casting for casts to occur</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">'no'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'no'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># '&lt;f4' -&gt; '&gt;f4' should not work with casting='no'</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'&lt;f4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">'no'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'&gt;f4'</span><span class="s2">)])</span>
    <span class="s4"># 'f4' -&gt; 'f8' is a safe cast, but 'f8' -&gt; 'f4' isn't</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># 'f4' -&gt; 'i4' is neither a safe nor a same-kind cast</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">)])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>

<span class="s0">def </span><span class="s1">test_iter_scalar_cast</span><span class="s2">():</span>
    <span class="s4"># Check that scalars are cast as requested</span>

    <span class="s4"># No cast 'f4' -&gt; 'f4'</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s5">2.5</span><span class="s2">), [], [[</span><span class="s3">'readonly'</span><span class="s2">]],</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">)</span>
    <span class="s4"># Safe cast 'f4' -&gt; 'f8'</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s5">2.5</span><span class="s2">), [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">)</span>
    <span class="s4"># Same-kind cast 'f8' -&gt; 'f4'</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s5">2.5</span><span class="s2">), [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">)</span>
    <span class="s4"># Unsafe cast 'f8' -&gt; 'i4'</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s5">3.0</span><span class="s2">), [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s4"># Readonly scalars may be cast even without setting COPY or BUFFERED</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, [], [[</span><span class="s3">'readonly'</span><span class="s2">]], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s5">3.</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_scalar_cast_errors</span><span class="s2">():</span>
    <span class="s4"># Check that invalid casts are caught</span>

    <span class="s4"># Need to allow copying/buffering for write casts of scalars to occur</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">]], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">]], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># 'f8' -&gt; 'f4' isn't a safe cast if the value would overflow</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s5">1e60</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># 'f4' -&gt; 'i4' is neither a safe nor a same-kind cast</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), [],</span>
                <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">)])</span>

<span class="s0">def </span><span class="s1">test_iter_object_arrays_basic</span><span class="s2">():</span>
    <span class="s4"># Check that object arrays work</span>

    <span class="s1">obj </span><span class="s2">= {</span><span class="s3">'a'</span><span class="s2">:</span><span class="s5">3</span><span class="s2">,</span><span class="s3">'b'</span><span class="s2">:</span><span class="s3">'d'</span><span class="s2">}</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s0">None</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">rc </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>

    <span class="s4"># Need to allow references for object arrays</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">), </span><span class="s1">rc</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">])</span>
    <span class="s1">vals </span><span class="s2">= [</span><span class="s1">x_</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">), </span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">vals</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">]*</span><span class="s5">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">), </span><span class="s1">rc</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">T</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterationneedsapi</span><span class="s2">)</span>
    <span class="s1">vals </span><span class="s2">= [</span><span class="s1">x_</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">))</span>
    <span class="s1">vals</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">]*</span><span class="s5">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">), </span><span class="s1">rc</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">T</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">],</span>
                        <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] = </span><span class="s0">None</span>
        <span class="s1">vals</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">]*</span><span class="s5">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">) == </span><span class="s1">rc</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">None</span><span class="s2">]*</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_object_arrays_conversions</span><span class="s2">():</span>
    <span class="s4"># Conversions to/from objects</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] += </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)+</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] += </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)+</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s4"># Non-contiguous object array</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s3">'p'</span><span class="s2">, </span><span class="s3">'i1'</span><span class="s2">), (</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)])</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">]</span>
    <span class="s1">a</span><span class="s2">[:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] += </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)+</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s4">#Non-contiguous value array</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s3">'p'</span><span class="s2">, </span><span class="s3">'i1'</span><span class="s2">), (</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'i4'</span><span class="s2">)])</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">]</span>
    <span class="s1">a</span><span class="s2">[:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">) + </span><span class="s5">98172488</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'refs_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">ob </span><span class="s2">= </span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][()]</span>
        <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
            <span class="s1">rc </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">ob</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] += </span><span class="s5">1</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">ob</span><span class="s2">) == </span><span class="s1">rc</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)+</span><span class="s5">98172489</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_common_dtype</span><span class="s2">():</span>
    <span class="s4"># Check that the iterator finds a common data type correctly</span>
    <span class="s4"># (some checks are somewhat duplicate after adopting NEP 50)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(-</span><span class="s5">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i8'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(-</span><span class="s5">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">),</span>
                 <span class="s1">array</span><span class="s2">([</span><span class="s5">2j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c8'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">([</span><span class="s5">9</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">]]*</span><span class="s5">4</span><span class="s2">,</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">3</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2j</span><span class="s2">, </span><span class="s5">9</span><span class="s2">))</span>

    <span class="s4"># When allocating outputs, other outputs aren't factored in</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s5">2j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c16'</span><span class="s2">)], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i4'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s4"># But, if common data types are requested, they are</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s5">2j</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c16'</span><span class="s2">)],</span>
                    <span class="s2">[</span><span class="s3">'common_dtype'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'safe'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_copy_if_overlap</span><span class="s2">():</span>
    <span class="s4"># Ensure the iterator makes copies on read/write overlap, if requested</span>

    <span class="s4"># Copy not needed, 1 op</span>
    <span class="s0">for </span><span class="s1">flag </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">]:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">], [[</span><span class="s1">flag</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s4"># Copy needed, 2 ops, read-write overlap</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:]</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">]]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(*</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">))</span>

    <span class="s4"># Copy not needed with elementwise, 2 ops, exactly same arrays</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'overlap_assume_elementwise'</span><span class="s2">],</span>
                                             <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'overlap_assume_elementwise'</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">a </span><span class="s0">and </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">]]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">a </span><span class="s0">and not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">b</span><span class="s2">))</span>

    <span class="s4"># Copy not needed, 2 ops, no overlap</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]])</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">a </span><span class="s0">and </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s4"># Copy needed, 2 ops, read-write overlap</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">3</span><span class="s2">:]</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)[:</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(*</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">))</span>

    <span class="s4"># Copy needed, 3 ops, read-write overlap</span>
    <span class="s0">for </span><span class="s1">flag </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">]:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">T</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">x</span>
        <span class="s0">with </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s1">flag</span><span class="s2">]]) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">a2</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">, </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">b2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">))</span>

    <span class="s4"># Copy not needed, 3 ops, read-only overlap</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">T</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">a2</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">, </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a </span><span class="s0">is </span><span class="s1">a2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s0">is </span><span class="s1">b2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">c2</span><span class="s2">)</span>

    <span class="s4"># Copy not needed, 3 ops, read-only overlap</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">T</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">a2</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">, </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a </span><span class="s0">is </span><span class="s1">a2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s0">is </span><span class="s1">b2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">c2</span><span class="s2">)</span>

    <span class="s4"># Copy not needed, 3 ops, write-only overlap</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">7</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:</span><span class="s5">3</span><span class="s2">]</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">3</span><span class="s2">:</span><span class="s5">6</span><span class="s2">]</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s5">4</span><span class="s2">:</span><span class="s5">7</span><span class="s2">]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [</span><span class="s3">'copy_if_overlap'</span><span class="s2">],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]])</span>
    <span class="s1">a2</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">, </span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a </span><span class="s0">is </span><span class="s1">a2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">b </span><span class="s0">is </span><span class="s1">b2</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">c </span><span class="s0">is </span><span class="s1">c2</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_op_axes</span><span class="s2">():</span>
    <span class="s4"># Check that custom axes work</span>

    <span class="s4"># Reverse the axes</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">, </span><span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">all</span><span class="s2">([</span><span class="s1">x </span><span class="s2">== </span><span class="s1">y </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">, </span><span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">all</span><span class="s2">([</span><span class="s1">x </span><span class="s2">== </span><span class="s1">y </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]))</span>

    <span class="s4"># Broadcast 1D to any dimension</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">31</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">, </span><span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">*</span><span class="s1">y </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">*</span><span class="s1">b</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)).</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">, </span><span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">*</span><span class="s1">y </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">*</span><span class="s1">b</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)).</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                            <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">*</span><span class="s1">y </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], (</span><span class="s1">a</span><span class="s2">*</span><span class="s1">b</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)).</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s4"># Inner product-style broadcasting</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">40</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                            <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

    <span class="s4"># Matrix product-style broadcasting</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                            <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_op_axes_errors</span><span class="s2">():</span>
    <span class="s4"># Check that custom axes throws errors for bad inputs</span>

    <span class="s4"># Wrong number of items in op_axes</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s4"># Out of bounds items in op_axes</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s4"># Duplicate items in op_axes</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>

    <span class="s4"># Different sized arrays in op_axes</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>

    <span class="s4"># Non-broadcastable dimensions in the result</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">,</span>
                                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>

<span class="s0">def </span><span class="s1">test_iter_copy</span><span class="s2">():</span>
    <span class="s4"># Check that copying the iterator works correctly</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

    <span class="s4"># Simple iterator</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s4"># Buffered iterator</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'ranged'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange </span><span class="s2">= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">9</span><span class="s2">)</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">18</span><span class="s2">)</span>
    <span class="s1">next</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">next</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">])</span>

    <span class="s4"># Casting iterator</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s5">5</span><span class="s2">) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">], </span><span class="s1">a</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">))</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'&lt;i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'&gt;f8'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s5">5</span><span class="s2">) </span><span class="s0">as </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">i</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">j</span><span class="s2">], </span><span class="s1">a</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s3">&quot;All&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;loop_dtype&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">typecodes</span><span class="s2">[</span><span class="s3">&quot;All&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore::numpy.exceptions.ComplexWarning&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_iter_copy_casts</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">loop_dtype</span><span class="s2">):</span>
    <span class="s4"># Ensure the dtype is never flexible:</span>
    <span class="s0">if </span><span class="s1">loop_dtype</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">&quot;m&quot;</span><span class="s2">:</span>
        <span class="s1">loop_dtype </span><span class="s2">= </span><span class="s1">loop_dtype </span><span class="s2">+ </span><span class="s3">&quot;[ms]&quot;</span>
    <span class="s0">elif </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">loop_dtype</span><span class="s2">).</span><span class="s1">itemsize </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">loop_dtype </span><span class="s2">= </span><span class="s1">loop_dtype </span><span class="s2">+ </span><span class="s3">&quot;50&quot;</span>

    <span class="s4"># Make things a bit more interesting by requiring a byte-swap as well:</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">loop_dtype</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s4"># Some casts are not possible, do not worry about them</span>
        <span class="s0">return</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">arr</span><span class="s2">,), [</span><span class="s3">&quot;buffered&quot;</span><span class="s2">, </span><span class="s3">&quot;external_loop&quot;</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">],</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">loop_dtype</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">loop_dtype</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">number</span><span class="s2">):</span>
        <span class="s4"># Casting to strings may be strange, but for simple dtypes do not rely</span>
        <span class="s4"># on the cast being correct:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">loop_dtype</span><span class="s2">))</span>

    <span class="s1">it_copy </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">it</span>
    <span class="s1">res_copy </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it_copy</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">it_copy</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res_copy</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iter_copy_casts_structured</span><span class="s2">():</span>
    <span class="s4"># Test a complicated structured dtype for casting, as it requires</span>
    <span class="s4"># both multiple steps and a more complex casting setup.</span>
    <span class="s4"># Includes a structured -&gt; unstructured (any to object), and many other</span>
    <span class="s4"># casts, which cause this to require all steps in the casting machinery</span>
    <span class="s4"># one level down as well as the iterator copy (which uses NpyAuxData clone)</span>
    <span class="s1">in_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;i,&quot;</span><span class="s2">)),</span>
                         <span class="s2">(</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;&gt;i,&lt;i,&gt;d,S17,&gt;d,3f,O,i1&quot;</span><span class="s2">))])</span>
    <span class="s1">out_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;O&quot;</span><span class="s2">)),</span>
                          <span class="s2">(</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;&gt;i,&gt;i,S17,&gt;d,&gt;U3,3d,i1,O&quot;</span><span class="s2">))])</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">in_dtype</span><span class="s2">)</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">arr</span><span class="s2">,), [</span><span class="s3">&quot;buffered&quot;</span><span class="s2">, </span><span class="s3">&quot;external_loop&quot;</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">],</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">out_dtype</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>
    <span class="s1">it_copy </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">it</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it_copy</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">it_copy</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">out_dtype</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">field </span><span class="s0">in </span><span class="s1">in_dtype</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">].</span><span class="s1">names</span><span class="s2">:</span>
        <span class="s4"># Note that the .base avoids the subarray field</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s1">field</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">out_dtype</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s1">field</span><span class="s2">].</span><span class="s1">base</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s1">field</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s1">field</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iter_copy_casts_structured2</span><span class="s2">():</span>
    <span class="s4"># Similar to the above, this is a fairly arcane test to cover internals</span>
    <span class="s1">in_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;O,O&quot;</span><span class="s2">)),</span>
                         <span class="s2">(</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;5O,3O,(1,)O,(1,)i,(1,)O&quot;</span><span class="s2">))])</span>
    <span class="s1">out_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;O&quot;</span><span class="s2">)),</span>
                          <span class="s2">(</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;O,3i,4O,4O,4i&quot;</span><span class="s2">))])</span>

    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">in_dtype</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">arr</span><span class="s2">,), [</span><span class="s3">&quot;buffered&quot;</span><span class="s2">, </span><span class="s3">&quot;external_loop&quot;</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">],</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">out_dtype</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>
    <span class="s1">it_copy </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">it</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it_copy</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">it_copy</span>

    <span class="s4"># Array of two structured scalars:</span>
    <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">:</span>
        <span class="s4"># Cast to tuple by getitem, which may be weird and changeable?:</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]) == </span><span class="s1">tuple</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] == (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s3">&quot;f0&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s3">&quot;f1&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;i&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s3">&quot;f2&quot;</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s3">&quot;f2&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s3">&quot;f3&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">][</span><span class="s3">&quot;f3&quot;</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;i&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_iter_allocate_output_simple</span><span class="s2">():</span>
    <span class="s4"># Check that the iterator will properly allocate outputs</span>

    <span class="s4"># Simple case</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_buffered_readwrite</span><span class="s2">():</span>
    <span class="s4"># Allocated output with buffering + delay_bufalloc</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'delay_bufalloc'</span><span class="s2">],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'allocate'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][:] = </span><span class="s5">1</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][...] += </span><span class="s1">x</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][...]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">+</span><span class="s5">1</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_itorder</span><span class="s2">():</span>
    <span class="s4"># The allocated output should match the iteration order</span>

    <span class="s4"># C-order input, best iteration order</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s4"># F-order input, best iteration order</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [], [[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">strides</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s4"># Non-contiguous input, C iteration order</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">,</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">32</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_opaxes</span><span class="s2">():</span>
    <span class="s4"># Specifying op_axes should work</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s0">None</span><span class="s2">, </span><span class="s1">a</span><span class="s2">], [], [[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'u4'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">],</span>
                        <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">48</span><span class="s2">, </span><span class="s5">16</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'u4'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_types_promotion</span><span class="s2">():</span>
    <span class="s4"># Check type promotion of automatic outputs (this was more interesting</span>
    <span class="s4"># before NEP 50...)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">+[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">+[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">+[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">+[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i8'</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u4'</span><span class="s2">), </span><span class="s1">array</span><span class="s2">(-</span><span class="s5">12</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">+[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'i8'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_types_byte_order</span><span class="s2">():</span>
    <span class="s4"># Verify the rules for byte order changes</span>

    <span class="s4"># When there's just one input, the output type exactly matches</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u4'</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s4"># With two or more inputs, the output type is in native byte order</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] != </span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">newbyteorder</span><span class="s2">(</span><span class="s3">'='</span><span class="s2">), </span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_types_scalar</span><span class="s2">():</span>
    <span class="s4"># If the inputs are all scalars, the output should be a scalar</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s0">None</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2.3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s5">12</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)], [],</span>
                <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]] + [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'complex128'</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_subtype</span><span class="s2">():</span>
    <span class="s4"># Make sure that the subtype with priority wins</span>
    <span class="s0">class </span><span class="s1">MyNDArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
        <span class="s1">__array_priority__ </span><span class="s2">= </span><span class="s5">15</span>

    <span class="s4"># subclass vs ndarray</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]]).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">MyNDArray</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">b</span><span class="s2">) </span><span class="s0">is not </span><span class="s1">type</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

    <span class="s4"># If subtypes are disabled, we should get back an ndarray.</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
               <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">, </span><span class="s3">'no_subtype'</span><span class="s2">]])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">b</span><span class="s2">), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]))</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) </span><span class="s0">is not </span><span class="s1">type</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_allocate_output_errors</span><span class="s2">():</span>
    <span class="s4"># Check that the iterator will throw errors for bad output allocations</span>

    <span class="s4"># Need an input if no output data type is specified</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]])</span>
    <span class="s4"># Allocated output should be flagged for writing</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'allocate'</span><span class="s2">, </span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s4"># Allocated output can't have buffering without delayed bufalloc</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                                            <span class="s2">[</span><span class="s3">'allocate'</span><span class="s2">, </span><span class="s3">'readwrite'</span><span class="s2">])</span>
    <span class="s4"># Must specify dtype if there are no inputs (cannot promote existing ones;</span>
    <span class="s4"># maybe this should use the 'f4' here, but it does not historically.)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">],</span>
                         <span class="s2">[</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># If using op_axes, must specify all the axes</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)],</span>
                        <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s4"># If using op_axes, the axes must be within bounds</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)],</span>
                        <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s4"># If using op_axes, there can't be duplicates</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)],</span>
                        <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s4"># Not all axes may be specified if a reduction. If there is a hole</span>
    <span class="s4"># in op_axes, this is an error.</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">&quot;reduce_ok&quot;</span><span class="s2">],</span>
                        <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                        <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)],</span>
                        <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]])</span>

<span class="s0">def </span><span class="s1">test_all_allocated</span><span class="s2">():</span>
    <span class="s4"># When no output and no shape is given, `()` is used as shape.</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s0">None</span><span class="s2">], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;int64&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== ()</span>
    <span class="s0">assert </span><span class="s1">i</span><span class="s2">.</span><span class="s1">dtypes </span><span class="s2">== (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">),)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s0">None</span><span class="s2">], </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;int64&quot;</span><span class="s2">], </span><span class="s1">itershape</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_remove_axis</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'multi_index'</span><span class="s2">])</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">remove_axis</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">,:].</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">,:,:]</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'multi_index'</span><span class="s2">])</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">remove_axis</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s5">0</span><span class="s2">,:,:].</span><span class="s1">ravel</span><span class="s2">())</span>

<span class="s0">def </span><span class="s1">test_iter_remove_multi_index_inner_loop</span><span class="s2">():</span>
    <span class="s4"># Check that removing multi-index support works</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'multi_index'</span><span class="s2">])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itviews</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>

    <span class="s4"># Removing the multi-index tracking causes all dimensions to coalesce</span>
    <span class="s1">before </span><span class="s2">= [</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">remove_multi_index</span><span class="s2">()</span>
    <span class="s1">after </span><span class="s2">= [</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">before</span><span class="s2">, </span><span class="s1">after</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itviews</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">24</span><span class="s2">,))</span>

    <span class="s4"># Removing the inner loop means there's just one iteration</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">())</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">enable_external_loop</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">itersize</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">24</span><span class="s2">,))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">value</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_iterindex</span><span class="s2">():</span>
    <span class="s4"># Make sure iterindex works</span>

    <span class="s1">buffersize </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">flags </span><span class="s0">in </span><span class="s2">([], [</span><span class="s3">'buffered'</span><span class="s2">]):</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">24</span><span class="s2">)))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">2</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)))</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">24</span><span class="s2">)))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">5</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)))</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">24</span><span class="s2">)))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">9</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">9</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)))</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">24</span><span class="s2">)))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">13</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">13</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)))</span>

        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">24</span><span class="s2">)))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">23</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">23</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)))</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s5">2</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">iter_iterindices</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)))</span>

<span class="s0">def </span><span class="s1">test_iter_iterrange</span><span class="s2">():</span>
    <span class="s4"># Make sure getting and resetting the iterrange works</span>

    <span class="s1">buffersize </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">a_fort </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'ranged'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">,</span>
                <span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">24</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a_fort</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">24</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">24</span><span class="s2">), (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">20</span><span class="s2">), (</span><span class="s5">23</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)]:</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange </span><span class="s2">= </span><span class="s1">r</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a_fort</span><span class="s2">[</span><span class="s1">r</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]:</span><span class="s1">r</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]])</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'ranged'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">24</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a_fort</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">24</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">24</span><span class="s2">), (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">20</span><span class="s2">), (</span><span class="s5">23</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)]:</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange </span><span class="s2">= </span><span class="s1">r</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">a_fort</span><span class="s2">[</span><span class="s1">r</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]:</span><span class="s1">r</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">val </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">val</span><span class="s2">, </span><span class="s1">x</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">val</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'ranged'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'F'</span><span class="s2">,</span>
                <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">, </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">24</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">a_fort</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s2">[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">24</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">24</span><span class="s2">), (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">20</span><span class="s2">), (</span><span class="s5">23</span><span class="s2">, </span><span class="s5">24</span><span class="s2">)]:</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange </span><span class="s2">= </span><span class="s1">r</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterrange</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">a_fort</span><span class="s2">[</span><span class="s1">r</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]:</span><span class="s1">r</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]])</span>

<span class="s0">def </span><span class="s1">test_iter_buffering</span><span class="s2">():</span>
    <span class="s4"># Test buffering with several buffer sizes and types</span>
    <span class="s1">arrays </span><span class="s2">= []</span>
    <span class="s4"># F-order swapped array</span>
    <span class="s1">_tmp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c16'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">_tmp </span><span class="s2">= </span><span class="s1">_tmp</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">_tmp</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">arrays</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">_tmp</span><span class="s2">)</span>
    <span class="s4"># Contiguous 1-dimensional array</span>
    <span class="s1">arrays</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">))</span>
    <span class="s4"># Unaligned array</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">4</span><span class="s2">*</span><span class="s5">16</span><span class="s2">+</span><span class="s5">1</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i1'</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">:]</span>
    <span class="s1">a</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s3">'i4'</span>
    <span class="s1">a</span><span class="s2">[:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">16</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)</span>
    <span class="s1">arrays</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s4"># 4-D F-order array</span>
    <span class="s1">arrays</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">120</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">T</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">arrays</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">buffersize </span><span class="s0">in </span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">1024</span><span class="s2">):</span>
            <span class="s1">vals </span><span class="s2">= []</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                           <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                           <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">,</span>
                           <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">,</span>
                           <span class="s1">buffersize</span><span class="s2">=</span><span class="s1">buffersize</span><span class="s2">)</span>
            <span class="s0">while not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">finished</span><span class="s2">:</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">size </span><span class="s2">&lt;= </span><span class="s1">buffersize</span><span class="s2">)</span>
                <span class="s1">vals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">())</span>
                <span class="s1">i</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_write_buffering</span><span class="s2">():</span>
    <span class="s4"># Test that buffering of writes is working</span>

    <span class="s4"># F-order swapped array</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">,</span>
                   <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">,</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">16</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">while not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">finished</span><span class="s2">:</span>
            <span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s1">x</span>
            <span class="s1">x </span><span class="s2">+= </span><span class="s5">1</span>
            <span class="s1">i</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_delayed_alloc</span><span class="s2">():</span>
    <span class="s4"># Test that delaying buffer allocation works</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'delay_bufalloc'</span><span class="s2">, </span><span class="s3">'multi_index'</span><span class="s2">, </span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">has_delayed_bufalloc</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">2</span><span class="s2">], </span><span class="s1">i</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">assign_iter</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s5">0</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">assign_iter</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>

    <span class="s1">i</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">i</span><span class="s2">.</span><span class="s1">has_delayed_bufalloc</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">,))</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s5">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">([[</span><span class="s1">x</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][()], </span><span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][()]] </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">6</span><span class="s2">), [</span><span class="s5">1</span><span class="s2">]*</span><span class="s5">6</span><span class="s2">)))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_simple</span><span class="s2">():</span>
    <span class="s4"># Test that buffering can handle a simple cast</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">)],</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_byteswapped</span><span class="s2">():</span>
    <span class="s4"># Test that buffering can handle a cast which requires swap-&gt;cast-&gt;swap</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">).</span><span class="s1">newbyteorder</span><span class="s2">()],</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">.</span><span class="s1">ComplexWarning</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                       <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                       <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                       <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c8'</span><span class="s2">).</span><span class="s1">newbyteorder</span><span class="s2">()],</span>
                       <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
                <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_byteswapped_complex</span><span class="s2">():</span>
    <span class="s4"># Test that buffering can handle a cast which requires swap-&gt;cast-&gt;copy</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c8'</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">a </span><span class="s2">+= </span><span class="s5">2j</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">)],</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c8'</span><span class="s2">) + </span><span class="s5">4j</span><span class="s2">)</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c8'</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">+= </span><span class="s5">2j</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">).</span><span class="s1">newbyteorder</span><span class="s2">()],</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'c8'</span><span class="s2">) + </span><span class="s5">4j</span><span class="s2">)</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">a </span><span class="s2">+= </span><span class="s5">2j</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'c16'</span><span class="s2">)],</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">clongdouble</span><span class="s2">) + </span><span class="s5">4j</span><span class="s2">)</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">()).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">, </span><span class="s3">'aligned'</span><span class="s2">]],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)],</span>
                   <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">7</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">v</span><span class="s2">[...] *= </span><span class="s5">2</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">longdouble</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffered_cast_structured_type</span><span class="s2">():</span>
    <span class="s4"># Tests buffering of structured types</span>

    <span class="s4"># simple -&gt; struct type (duplicates the value)</span>
    <span class="s1">sdt </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'i8'</span><span class="s2">), (</span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'c8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)), (</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">) + </span><span class="s5">0.5</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt</span><span class="s2">)</span>
    <span class="s1">vals </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">], </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'b'</span><span class="s2">], </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'c'</span><span class="s2">], [[(</span><span class="s5">0.5</span><span class="s2">)]*</span><span class="s5">3</span><span class="s2">]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'d'</span><span class="s2">], </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">], </span><span class="s5">1.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'b'</span><span class="s2">], </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'c'</span><span class="s2">], [[(</span><span class="s5">1.5</span><span class="s2">)]*</span><span class="s5">3</span><span class="s2">]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'d'</span><span class="s2">], </span><span class="s5">1.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt</span><span class="s2">))</span>

    <span class="s4"># object -&gt; struct type</span>
    <span class="s1">sdt </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'i8'</span><span class="s2">), (</span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'c8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)), (</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = (</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]], </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = (</span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, [[</span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">], [</span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">]], </span><span class="s5">1.5</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] = (</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, [[</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">], [</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">]], </span><span class="s5">2.5</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">rc </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt</span><span class="s2">)</span>
    <span class="s1">vals </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">], </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'b'</span><span class="s2">], </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'c'</span><span class="s2">], [[(</span><span class="s5">0.5</span><span class="s2">)]*</span><span class="s5">3</span><span class="s2">]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s3">'d'</span><span class="s2">], </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">], </span><span class="s5">1.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'b'</span><span class="s2">], </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'c'</span><span class="s2">], [[(</span><span class="s5">1.5</span><span class="s2">)]*</span><span class="s5">3</span><span class="s2">]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s3">'d'</span><span class="s2">], </span><span class="s5">1.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt</span><span class="s2">))</span>
    <span class="s1">vals</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">]*</span><span class="s5">3</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]), </span><span class="s1">rc</span><span class="s2">)</span>

    <span class="s4"># single-field struct type -&gt; simple</span>
    <span class="s1">sdt </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">5.5</span><span class="s2">,), (</span><span class="s5">8</span><span class="s2">,)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">x_</span><span class="s2">[()] </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">8</span><span class="s2">])</span>

    <span class="s4"># make sure multi-field struct type -&gt; simple doesn't work</span>
    <span class="s1">sdt </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'i8'</span><span class="s2">), (</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">5.5</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s3">'test'</span><span class="s2">), (</span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: (</span>
        <span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
               <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
               <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">)))</span>

    <span class="s4"># struct type -&gt; struct type (field-wise copy)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'i8'</span><span class="s2">), (</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'u2'</span><span class="s2">), (</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x_</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">),</span>
                  <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)])</span>


<span class="s0">def </span><span class="s1">test_iter_buffered_cast_structured_type_failure_with_cleanup</span><span class="s2">():</span>
    <span class="s4"># make sure struct type -&gt; struct type with different</span>
    <span class="s4"># number of fields fails</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'i8'</span><span class="s2">), (</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">), (</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">intent </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;readwrite&quot;</span><span class="s2">, </span><span class="s3">&quot;readonly&quot;</span><span class="s2">, </span><span class="s3">&quot;writeonly&quot;</span><span class="s2">]:</span>
        <span class="s4"># This test was initially designed to test an error at a different</span>
        <span class="s4"># place, but will now raise earlier to to the cast not being possible:</span>
        <span class="s4"># `assert np.can_cast(a.dtype, sdt2, casting=&quot;unsafe&quot;)` fails.</span>
        <span class="s4"># Without a faulty DType, there is probably no reliable</span>
        <span class="s4"># way to get the initial tested behaviour.</span>
        <span class="s1">simple_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;i,i&quot;</span><span class="s2">)  </span><span class="s4"># requires clean up</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">nditer</span><span class="s2">((</span><span class="s1">simple_arr</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s1">intent</span><span class="s2">, </span><span class="s1">intent</span><span class="s2">],</span>
                   <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;f,f&quot;</span><span class="s2">, </span><span class="s1">sdt2</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_buffered_cast_error_paths</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s4"># The input is cast into an `S3` buffer</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;S1&quot;</span><span class="s2">),), </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;i&quot;</span><span class="s2">],</span>
                  <span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;buffered&quot;</span><span class="s2">])</span>

    <span class="s4"># The `M8[ns]` is cast into the `S3` output</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;i&quot;</span><span class="s2">),), </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;S1&quot;</span><span class="s2">],</span>
                   <span class="s1">op_flags</span><span class="s2">=[</span><span class="s3">&quot;writeonly&quot;</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;buffered&quot;</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">buf </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
            <span class="s1">buf</span><span class="s2">[...] = </span><span class="s3">&quot;a&quot;  </span><span class="s4"># cannot be converted to int.</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Cannot start subprocess&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;PyPy seems to not hit this.&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_buffered_cast_error_paths_unraisable</span><span class="s2">():</span>
    <span class="s4"># The following gives an unraisable error. Pytest sometimes captures that</span>
    <span class="s4"># (depending python and/or pytest version). So with Python&gt;=3.8 this can</span>
    <span class="s4"># probably be cleaned out in the future to check for</span>
    <span class="s4"># pytest.PytestUnraisableExceptionWarning:</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
        import numpy as np 
 
        it = np.nditer((np.array(1, dtype=&quot;i&quot;),), op_dtypes=[&quot;S1&quot;], 
                       op_flags=[&quot;writeonly&quot;], casting=&quot;unsafe&quot;, flags=[&quot;buffered&quot;]) 
        buf = next(it) 
        buf[...] = &quot;a&quot; 
        del buf, it  # Flushing only happens during deallocate right now. 
        &quot;&quot;&quot;</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">check_output</span><span class="s2">([</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s3">&quot;-c&quot;</span><span class="s2">, </span><span class="s1">code</span><span class="s2">],</span>
                                  <span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">STDOUT</span><span class="s2">, </span><span class="s1">text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;ValueError&quot; </span><span class="s0">in </span><span class="s1">res</span>


<span class="s0">def </span><span class="s1">test_iter_buffered_cast_subarray</span><span class="s2">():</span>
    <span class="s4"># Tests buffering of subarrays</span>

    <span class="s4"># one element -&gt; many (copies it to all)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">)]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">count </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">6</span><span class="s2">))):</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] == </span><span class="s1">count</span><span class="s2">))</span>

    <span class="s4"># one element -&gt; many -&gt; back (copies it to all)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] == </span><span class="s1">count</span><span class="s2">))</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][</span><span class="s5">0</span><span class="s2">] += </span><span class="s5">2</span>
            <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)+</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s4"># many -&gt; one element -&gt; back (copies just element 0)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">,))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">count</span><span class="s2">)</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] += </span><span class="s5">2</span>
            <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))+</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s4"># many -&gt; one element -&gt; back (copies just element 0)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">,))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">count</span><span class="s2">)</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># many -&gt; one element (copies just element 0)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">,))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">count</span><span class="s2">)</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># many -&gt; matching shape (straightforward copy)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">*</span><span class="s5">3</span><span class="s2">*</span><span class="s5">2</span><span class="s2">*</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">])</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># vector -&gt; smaller vector (truncates)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">6</span><span class="s2">,))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">,))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">*</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">][:</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># vector -&gt; bigger vector (pads with zeros)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">,))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">6</span><span class="s2">,))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">*</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:</span><span class="s5">2</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][</span><span class="s5">2</span><span class="s2">:], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># vector -&gt; matrix (broadcasts)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">,))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">*</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][</span><span class="s5">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">])</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># vector -&gt; matrix (broadcasts and zero-pads)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">*</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][</span><span class="s5">2</span><span class="s2">,:], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s4"># matrix -&gt; matrix (truncates and zero-pads)</span>
    <span class="s1">sdt1 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))]</span>
    <span class="s1">sdt2 </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">6</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">sdt1</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">*</span><span class="s5">2</span><span class="s2">*</span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">,</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">sdt2</span><span class="s2">))</span>
    <span class="s1">count </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s1">count</span><span class="s2">][</span><span class="s3">'a'</span><span class="s2">][:, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">][</span><span class="s5">2</span><span class="s2">,:], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">count </span><span class="s2">+= </span><span class="s5">1</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_badwriteback</span><span class="s2">():</span>
    <span class="s4"># Writing back from a buffer cannot combine elements</span>

    <span class="s4"># a needs write buffering, but had a broadcast dimension</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                  <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
                  <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>

    <span class="s4"># But if a is readonly, it's fine</span>
    <span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
           <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
           <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>

    <span class="s4"># If a has just one element, it's fine too (constant 0 stride, a reduction)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
           <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
           <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>

    <span class="s4"># check that it fails on other dimensions too</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                  <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
                  <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                  <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">]],</span>
                  <span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_string</span><span class="s2">():</span>
    <span class="s4"># Safe casting disallows shrinking strings</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">'abc'</span><span class="s2">, </span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'abcd'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bytes_</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'S4'</span><span class="s2">))</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                  <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'S2'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'S6'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s6">b'abc'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'S6'</span><span class="s2">))</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">'abc'</span><span class="s2">, </span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'abcd'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'U4'</span><span class="s2">))</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'U2'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'U6'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s3">'abc'</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'U6'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_growinner</span><span class="s2">():</span>
    <span class="s4"># Test that the inner loop grows when no buffering is needed</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">30</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'growinner'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                           <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s4"># Should end up with just one inner loop here</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">size</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s0">def </span><span class="s1">test_iter_buffered_reduce_reuse</span><span class="s2">():</span>
    <span class="s4"># large enough array for all views, including negative strides.</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">*</span><span class="s5">3</span><span class="s2">**</span><span class="s5">5</span><span class="s2">)[</span><span class="s5">3</span><span class="s2">**</span><span class="s5">5</span><span class="s2">:</span><span class="s5">3</span><span class="s2">**</span><span class="s5">5</span><span class="s2">+</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">flags </span><span class="s2">= [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'delay_bufalloc'</span><span class="s2">, </span><span class="s3">'multi_index'</span><span class="s2">, </span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">]</span>
    <span class="s1">op_flags </span><span class="s2">= [(</span><span class="s3">'readonly'</span><span class="s2">,), (</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">)]</span>
    <span class="s1">op_axes_list </span><span class="s2">= [[(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)], [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">)]]</span>
    <span class="s4"># wrong dtype to force buffering</span>
    <span class="s1">op_dtypes </span><span class="s2">= [</span><span class="s1">float</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">get_params</span><span class="s2">():</span>
        <span class="s0">for </span><span class="s1">xs </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(-</span><span class="s5">3</span><span class="s2">**</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">**</span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">ys </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s5">3</span><span class="s2">**</span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">op_axes </span><span class="s0">in </span><span class="s1">op_axes_list</span><span class="s2">:</span>
                    <span class="s4"># last stride is reduced and because of that not</span>
                    <span class="s4"># important for this test, as it is the inner stride.</span>
                    <span class="s1">strides </span><span class="s2">= (</span><span class="s1">xs </span><span class="s2">* </span><span class="s1">a</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">* </span><span class="s1">a</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">)</span>
                    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">stride_tricks</span><span class="s2">.</span><span class="s1">as_strided</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">strides</span><span class="s2">)</span>

                    <span class="s0">for </span><span class="s1">skip </span><span class="s0">in </span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]:</span>
                        <span class="s0">yield </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">op_axes</span><span class="s2">, </span><span class="s1">skip</span>

    <span class="s0">for </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">op_axes</span><span class="s2">, </span><span class="s1">skip </span><span class="s0">in </span><span class="s1">get_params</span><span class="s2">():</span>
        <span class="s1">nditer2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(), </span><span class="s0">None</span><span class="s2">],</span>
                            <span class="s1">op_axes</span><span class="s2">=</span><span class="s1">op_axes</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">op_flags</span><span class="s2">=</span><span class="s1">op_flags</span><span class="s2">,</span>
                            <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">op_dtypes</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">nditer2</span><span class="s2">:</span>
            <span class="s1">nditer2</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">][...] = </span><span class="s5">0</span>
            <span class="s1">nditer2</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
            <span class="s1">nditer2</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s1">skip</span>

            <span class="s0">for </span><span class="s2">(</span><span class="s1">a2_in</span><span class="s2">, </span><span class="s1">b2_in</span><span class="s2">) </span><span class="s0">in </span><span class="s1">nditer2</span><span class="s2">:</span>
                <span class="s1">b2_in </span><span class="s2">+= </span><span class="s1">a2_in</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int_</span><span class="s2">)</span>

            <span class="s1">comp_res </span><span class="s2">= </span><span class="s1">nditer2</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">bufsize </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">**</span><span class="s5">3</span><span class="s2">):</span>
            <span class="s1">nditer1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arr</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                                <span class="s1">op_axes</span><span class="s2">=</span><span class="s1">op_axes</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">op_flags</span><span class="s2">=</span><span class="s1">op_flags</span><span class="s2">,</span>
                                <span class="s1">buffersize</span><span class="s2">=</span><span class="s1">bufsize</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">op_dtypes</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">nditer1</span><span class="s2">:</span>
                <span class="s1">nditer1</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">][...] = </span><span class="s5">0</span>
                <span class="s1">nditer1</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
                <span class="s1">nditer1</span><span class="s2">.</span><span class="s1">iterindex </span><span class="s2">= </span><span class="s1">skip</span>

                <span class="s0">for </span><span class="s2">(</span><span class="s1">a1_in</span><span class="s2">, </span><span class="s1">b1_in</span><span class="s2">) </span><span class="s0">in </span><span class="s1">nditer1</span><span class="s2">:</span>
                    <span class="s1">b1_in </span><span class="s2">+= </span><span class="s1">a1_in</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int_</span><span class="s2">)</span>

                <span class="s1">res </span><span class="s2">= </span><span class="s1">nditer1</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">comp_res</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iter_no_broadcast</span><span class="s2">():</span>
    <span class="s4"># Test that the no_broadcast flag works</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

    <span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [],</span>
           <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'no_broadcast'</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [],</span>
                  <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'no_broadcast'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], [],</span>
                  <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'no_broadcast'</span><span class="s2">]])</span>


<span class="s0">class </span><span class="s1">TestIterNested</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration basic usage</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], [</span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_reorder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration basic usage</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>

        <span class="s4"># In 'K' order (default), it gets reordered</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], [</span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s4"># In 'C' order, it doesn't</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_flip_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration with negative axes</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">]</span>

        <span class="s4"># In 'K' order (default), the axes all get flipped</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], [</span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s4"># In 'C' order, flipping axes is disabled</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">11</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">6</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">11</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">9</span><span class="s2">, </span><span class="s5">8</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">6</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], </span><span class="s1">order</span><span class="s2">=</span><span class="s3">'C'</span><span class="s2">)</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">11</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">7</span><span class="s2">], [</span><span class="s5">10</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_broadcast</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration with broadcasting</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]], [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [[</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]]])</span>

    <span class="s0">def </span><span class="s1">test_dtype_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration with a copy to change dtype</span>

        <span class="s4"># copy</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]],</span>
                            <span class="s1">op_flags</span><span class="s2">=[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'copy'</span><span class="s2">],</span>
                            <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">j</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s4"># writebackifcopy - using context manager</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]],</span>
                            <span class="s1">op_flags</span><span class="s2">=[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">],</span>
                            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                            <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">j</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j</span><span class="s2">:</span>
                    <span class="s1">y</span><span class="s2">[...] += </span><span class="s5">1</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]])</span>

        <span class="s4"># writebackifcopy - using close()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]],</span>
                            <span class="s1">op_flags</span><span class="s2">=[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">],</span>
                            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                            <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">j</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j</span><span class="s2">:</span>
                <span class="s1">y</span><span class="s2">[...] += </span><span class="s5">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]])</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">j</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_dtype_buffered</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration with buffering to change dtype</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]],</span>
                            <span class="s1">flags</span><span class="s2">=[</span><span class="s3">'buffered'</span><span class="s2">],</span>
                            <span class="s1">op_flags</span><span class="s2">=[</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                            <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">j</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j</span><span class="s2">:</span>
                <span class="s1">y</span><span class="s2">[...] += </span><span class="s5">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_0d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], []])</span>
        <span class="s1">vals </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s1">j</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">], [</span><span class="s5">8</span><span class="s2">], [</span><span class="s5">9</span><span class="s2">], [</span><span class="s5">10</span><span class="s2">], [</span><span class="s5">11</span><span class="s2">]])</span>

        <span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [], [</span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">vals </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j</span><span class="s2">:</span>
                <span class="s1">vals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">z </span><span class="s0">for </span><span class="s1">z </span><span class="s0">in </span><span class="s1">k</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">7</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_iter_nested_iters_dtype_buffered</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test nested iteration with buffering to change dtype</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nested_iters</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]],</span>
                            <span class="s1">flags</span><span class="s2">=[</span><span class="s3">'buffered'</span><span class="s2">],</span>
                            <span class="s1">op_flags</span><span class="s2">=[</span><span class="s3">'readwrite'</span><span class="s2">],</span>
                            <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">,</span>
                            <span class="s1">op_dtypes</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">j</span><span class="s2">[</span><span class="s5">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">j</span><span class="s2">:</span>
                    <span class="s1">y</span><span class="s2">[...] += </span><span class="s5">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]])</span>

<span class="s0">def </span><span class="s1">test_iter_reduction_error</span><span class="s2">():</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">]])</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'external_loop'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>

<span class="s0">def </span><span class="s1">test_iter_reduction</span><span class="s2">():</span>
    <span class="s4"># Test doing reductions with the iterator</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s4"># Need to initialize the output operand to the addition unit</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][...] = </span><span class="s5">0</span>
        <span class="s4"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">y</span><span class="s2">[...] += </span><span class="s1">x</span>
        <span class="s4"># Since no axes were specified, should have allocated a scalar</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s4"># Need to initialize the output operand to the addition unit</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][...] = </span><span class="s5">0</span>
        <span class="s4"># Reduction shape/strides for the output</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">6</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">,))</span>
        <span class="s4"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s4"># Use a for loop instead of ``y[...] += x``</span>
            <span class="s4"># (equivalent to ``y[...] = y[...].copy() + x``),</span>
            <span class="s4"># because y has zero strides we use for the reduction</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)):</span>
                <span class="s1">y</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] += </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s4"># Since no axes were specified, should have allocated a scalar</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>

    <span class="s4"># This is a tricky reduction case for the buffering double loop</span>
    <span class="s4"># to handle</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">it1 </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">it2 </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">,</span>
                            <span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'delay_bufalloc'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], </span><span class="s1">buffersize</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">it1</span><span class="s2">, </span><span class="s1">it2</span><span class="s2">:</span>
        <span class="s1">it1</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">fill</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">it2</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">fill</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">it2</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it1</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][...] += </span><span class="s1">x</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it2</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][...] += </span><span class="s1">x</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">it1</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">it2</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">it2</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">(), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_reduction</span><span class="s2">():</span>
    <span class="s4"># Test doing buffered reductions with the iterator</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s5">0.</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f8'</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">!= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s4"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s1">y</span><span class="s2">[...] += </span><span class="s1">x</span>
    <span class="s4"># Since no axes were specified, should have allocated a scalar</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">).</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'nbo'</span><span class="s2">]],</span>
                    <span class="s1">op_axes</span><span class="s2">=[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s4"># Reduction shape/strides for the output</span>
    <span class="s0">with </span><span class="s1">i</span><span class="s2">:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">3</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">strides</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">,))</span>
        <span class="s4"># Do the reduction</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">i</span><span class="s2">:</span>
            <span class="s4"># Use a for loop instead of ``y[...] += x``</span>
            <span class="s4"># (equivalent to ``y[...] = y[...].copy() + x``),</span>
            <span class="s4"># because y has zero strides we use for the reduction</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)):</span>
                <span class="s1">y</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] += </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">))</span>

    <span class="s4"># Iterator inner double loop was wrong on this one</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">) + </span><span class="s5">1</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">p</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">'delay_bufalloc'</span><span class="s2">, </span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">],</span>
            <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'allocate'</span><span class="s2">]],</span>
            <span class="s1">op_axes</span><span class="s2">=[[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]],</span>
            <span class="s1">itershape</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">].</span><span class="s1">fill</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">it</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s4"># Iterator inner loop should take argument contiguity into account</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">7</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">8</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)[</span><span class="s5">4</span><span class="s2">:</span><span class="s5">6</span><span class="s2">,</span><span class="s5">1</span><span class="s2">:</span><span class="s5">11</span><span class="s2">:</span><span class="s5">6</span><span class="s2">,</span><span class="s5">1</span><span class="s2">:</span><span class="s5">5</span><span class="s2">].</span><span class="s1">transpose</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">[...] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">size</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">y_base </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">*</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">y_base_copy </span><span class="s2">= </span><span class="s1">y_base</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y_base</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">,:,</span><span class="s0">None</span><span class="s2">]</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y_base</span><span class="s2">[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">], </span><span class="s1">y_base_copy</span><span class="s2">[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y_base</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">], </span><span class="s5">2</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_buffering_reduction_reuse_reduce_loops</span><span class="s2">():</span>
    <span class="s4"># There was a bug triggering reuse of the reduce loop inappropriately,</span>
    <span class="s4"># which caused processing to happen in unnecessarily small chunks</span>
    <span class="s4"># and overran the buffer.</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], </span><span class="s1">flags</span><span class="s2">=[</span><span class="s3">'reduce_ok'</span><span class="s2">, </span><span class="s3">'external_loop'</span><span class="s2">, </span><span class="s3">'buffered'</span><span class="s2">],</span>
                    <span class="s1">op_flags</span><span class="s2">=[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">]],</span>
                    <span class="s1">buffersize</span><span class="s2">=</span><span class="s5">5</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">bufsizes </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">it</span><span class="s2">]</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">bufsizes</span><span class="s2">, [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">bufsizes</span><span class="s2">), </span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_iter_writemasked_badinput</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">3</span><span class="s2">,))</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]])</span>
    <span class="s1">m2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s1">m3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u1'</span><span class="s2">)</span>
    <span class="s1">mbad1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'i1'</span><span class="s2">)</span>
    <span class="s1">mbad2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>

    <span class="s4"># Need an 'arraymask' if any operand is 'writemasked'</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">m</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">]])</span>

    <span class="s4"># A 'writemasked' operand must not be readonly</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">m</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>

    <span class="s4"># 'writemasked' and 'arraymask' may not be used together</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">m</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">]])</span>

    <span class="s4"># 'arraymask' may only be specified once</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>

    <span class="s4"># An 'arraymask' with nothing 'writemasked' also doesn't make sense</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">m</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>

    <span class="s4"># A writemasked reduction requires a similarly smaller mask</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">m</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>
    <span class="s4"># But this should work with a smaller/equal mask to the reduction operand</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>
    <span class="s4"># The arraymask itself cannot be a reduction</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">], [</span><span class="s3">'reduce_ok'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>

    <span class="s4"># A uint8 mask is ok too</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">m3</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]],</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">'f4'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">)</span>
    <span class="s4"># An int8 mask isn't ok</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mbad1</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]],</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">'f4'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">)</span>
    <span class="s4"># A float32 mask isn't ok</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mbad2</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                    <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]],</span>
                    <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">'f4'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'same_kind'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_is_buffered</span><span class="s2">(</span><span class="s1">iterator</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">iterator</span><span class="s2">.</span><span class="s1">itviews</span>
    <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
        <span class="s0">return True</span>
    <span class="s0">return False</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;a&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">),</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">9876</span><span class="s2">, </span><span class="s5">3</span><span class="s2">*</span><span class="s5">5</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">, :],</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">312</span><span class="s2">, </span><span class="s5">124</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">, :, ::</span><span class="s5">2</span><span class="s2">, :],</span>
         <span class="s4"># Also test with the last dimension strided (so it does not fit if</span>
         <span class="s4"># there is repeated access)</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">9</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)[::</span><span class="s5">3</span><span class="s2">],</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">9876</span><span class="s2">, </span><span class="s5">3</span><span class="s2">*</span><span class="s5">10</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">, ::</span><span class="s5">5</span><span class="s2">],</span>
         <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">312</span><span class="s2">, </span><span class="s5">124</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f8'</span><span class="s2">)[::</span><span class="s5">2</span><span class="s2">, :, ::</span><span class="s5">2</span><span class="s2">, ::-</span><span class="s5">1</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_iter_writemasked</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
    <span class="s4"># Note, the slicing above is to ensure that nditer cannot combine multiple</span>
    <span class="s4"># axes into one.  The repetition is just to make things a bit more</span>
    <span class="s4"># interesting.</span>
    <span class="s1">shape </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s1">reps </span><span class="s2">= </span><span class="s1">shape</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] // </span><span class="s5">3</span>
    <span class="s1">msk </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">msk</span><span class="s2">[...] = [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">] * </span><span class="s1">reps</span>

    <span class="s4"># When buffering is unused, 'writemasked' effectively does nothing.</span>
    <span class="s4"># It's up to the user of the iterator to obey the requested semantics.</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">msk</span><span class="s2">], [],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">m </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">1</span>
    <span class="s4"># Because we violated the semantics, all the values became 1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] * </span><span class="s1">reps</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">))</span>

    <span class="s4"># Even if buffering is enabled, we still may be accessing the array</span>
    <span class="s4"># directly.</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">msk</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]])</span>
    <span class="s4"># @seberg: I honestly don't currently understand why a &quot;buffered&quot; iterator</span>
    <span class="s4"># would end up not using a buffer for the small array here at least when</span>
    <span class="s4"># &quot;writemasked&quot; is used, that seems confusing...  Check by testing for</span>
    <span class="s4"># actual memory overlap!</span>
    <span class="s1">is_buffered </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">m </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">2.5</span>
            <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">may_share_memory</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
                <span class="s1">is_buffered </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">if not </span><span class="s1">is_buffered</span><span class="s2">:</span>
        <span class="s4"># Because we violated the semantics, all the values became 2.5</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">([</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">] * </span><span class="s1">reps</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s4"># For large sizes, the iterator may be buffered:</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">([</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] * </span><span class="s1">reps</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s1">a</span><span class="s2">[...] = </span><span class="s5">2.5</span>

    <span class="s4"># If buffering will definitely happening, for instance because of</span>
    <span class="s4"># a cast, only the items selected by the mask will be copied back from</span>
    <span class="s4"># the buffer.</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">msk</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">],</span>
                <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]],</span>
                <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">'i8'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">m </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">3</span>
    <span class="s4"># Even though we violated the semantics, only the selected values</span>
    <span class="s4"># were copied back</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">] * </span><span class="s1">reps</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">([</span><span class="s3">&quot;mask&quot;</span><span class="s2">, </span><span class="s3">&quot;mask_axes&quot;</span><span class="s2">], [</span>
        <span class="s4"># Allocated operand (only broadcasts with -1)</span>
        <span class="s2">(</span><span class="s0">None</span><span class="s2">, [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s4"># Reduction along the first dimension (with and without op_axes)</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;bool&quot;</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;bool&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s4"># Test 0-D and -1 op_axes</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;bool&quot;</span><span class="s2">), [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;bool&quot;</span><span class="s2">), [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;bool&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_iter_writemasked_broadcast_error</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">mask_axes</span><span class="s2">):</span>
    <span class="s4"># This assumes that a readwrite mask makes sense. This is likely not the</span>
    <span class="s4"># case and should simply be deprecated.</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">itflags </span><span class="s2">= [</span><span class="s3">&quot;reduce_ok&quot;</span><span class="s2">]</span>
    <span class="s1">mask_flags </span><span class="s2">= [</span><span class="s3">&quot;arraymask&quot;</span><span class="s2">, </span><span class="s3">&quot;readwrite&quot;</span><span class="s2">, </span><span class="s3">&quot;allocate&quot;</span><span class="s2">]</span>
    <span class="s1">a_flags </span><span class="s2">= [</span><span class="s3">&quot;writeonly&quot;</span><span class="s2">, </span><span class="s3">&quot;writemasked&quot;</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">mask_axes </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">op_axes </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">op_axes </span><span class="s2">= [</span><span class="s1">mask_axes</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]</span>

    <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">), </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">itflags</span><span class="s2">, </span><span class="s1">op_flags</span><span class="s2">=[</span><span class="s1">mask_flags</span><span class="s2">, </span><span class="s1">a_flags</span><span class="s2">],</span>
                  <span class="s1">op_axes</span><span class="s2">=</span><span class="s1">op_axes</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iter_writemasked_decref</span><span class="s2">():</span>
    <span class="s4"># force casting (to make it interesting) by using a structured dtype.</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10000</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;&gt;i,O&quot;</span><span class="s2">)</span>
    <span class="s1">original </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10000</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">)</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">], [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">],</span>
                   <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'writemasked'</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s3">'readonly'</span><span class="s2">, </span><span class="s3">'arraymask'</span><span class="s2">]],</span>
                   <span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;&lt;i,O&quot;</span><span class="s2">, </span><span class="s3">&quot;?&quot;</span><span class="s2">])</span>
    <span class="s1">singleton </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">singleton</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">buf</span><span class="s2">, </span><span class="s1">mask_buf </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">buf</span><span class="s2">[...] = (</span><span class="s5">3</span><span class="s2">, </span><span class="s1">singleton</span><span class="s2">)</span>

    <span class="s0">del </span><span class="s1">buf</span><span class="s2">, </span><span class="s1">mask_buf</span><span class="s2">, </span><span class="s1">it   </span><span class="s4"># delete everything to ensure correct cleanup</span>

    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s4"># The buffer would have included additional items, they must be</span>
        <span class="s4"># cleared correctly:</span>
        <span class="s0">assert </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">singleton</span><span class="s2">) - </span><span class="s1">count </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">count_nonzero</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[~</span><span class="s1">mask</span><span class="s2">], </span><span class="s1">original</span><span class="s2">[~</span><span class="s1">mask</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">] == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s1">singleton</span><span class="s2">), </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">del </span><span class="s1">arr</span>

    <span class="s0">if </span><span class="s1">HAS_REFCOUNT</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">singleton</span><span class="s2">) == </span><span class="s1">count</span>


<span class="s0">def </span><span class="s1">test_iter_non_writable_attribute_deletion</span><span class="s2">():</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">attr </span><span class="s2">= [</span><span class="s3">&quot;value&quot;</span><span class="s2">, </span><span class="s3">&quot;shape&quot;</span><span class="s2">, </span><span class="s3">&quot;operands&quot;</span><span class="s2">, </span><span class="s3">&quot;itviews&quot;</span><span class="s2">, </span><span class="s3">&quot;has_delayed_bufalloc&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;iterationneedsapi&quot;</span><span class="s2">, </span><span class="s3">&quot;has_multi_index&quot;</span><span class="s2">, </span><span class="s3">&quot;has_index&quot;</span><span class="s2">, </span><span class="s3">&quot;dtypes&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ndim&quot;</span><span class="s2">, </span><span class="s3">&quot;nop&quot;</span><span class="s2">, </span><span class="s3">&quot;itersize&quot;</span><span class="s2">, </span><span class="s3">&quot;finished&quot;</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">attr</span><span class="s2">:</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">delattr</span><span class="s2">, </span><span class="s1">it</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iter_writable_attribute_deletion</span><span class="s2">():</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">attr </span><span class="s2">= [ </span><span class="s3">&quot;multi_index&quot;</span><span class="s2">, </span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s3">&quot;iterrange&quot;</span><span class="s2">, </span><span class="s3">&quot;iterindex&quot;</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">attr</span><span class="s2">:</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">delattr</span><span class="s2">, </span><span class="s1">it</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iter_element_deletion</span><span class="s2">():</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">3</span><span class="s2">))</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">del </span><span class="s1">it</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">del </span><span class="s1">it</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span>

<span class="s0">def </span><span class="s1">test_iter_allocated_array_dtypes</span><span class="s2">():</span>
    <span class="s4"># If the dtype of an allocated output has a shape, the shape gets</span>
    <span class="s4"># tacked onto the end of the result.</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">20</span><span class="s2">], </span><span class="s0">None</span><span class="s2">), </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, (</span><span class="s3">'i4'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">,))])</span>
    <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">- </span><span class="s5">1</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">19</span><span class="s2">, </span><span class="s5">21</span><span class="s2">]])</span>

    <span class="s4"># Check the same (less sensitive) thing when `op_axes` with -1 is given.</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">20</span><span class="s2">]], </span><span class="s0">None</span><span class="s2">), </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, (</span><span class="s3">'i4'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">,))],</span>
                   <span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;reduce_ok&quot;</span><span class="s2">], </span><span class="s1">op_axes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, (-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])</span>
    <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">- </span><span class="s5">1</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">19</span><span class="s2">, </span><span class="s5">21</span><span class="s2">]])</span>

    <span class="s4"># Make sure this works for scalars too</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, (</span><span class="s3">'i4'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))])</span>
    <span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">c</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">- </span><span class="s1">b</span>
        <span class="s1">c</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span>
        <span class="s1">c</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">* </span><span class="s1">b</span>
        <span class="s1">c</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] = </span><span class="s1">a </span><span class="s2">/ </span><span class="s1">b</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">], [[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">12</span><span class="s2">], [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_0d_iter</span><span class="s2">():</span>
    <span class="s4"># Basic test for iteration of 0-d arrays:</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">multi_index</span><span class="s2">, ())</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">iterindex</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">StopIteration</span><span class="s2">, </span><span class="s1">next</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
    <span class="s4"># test reset:</span>
    <span class="s1">i</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">StopIteration</span><span class="s2">, </span><span class="s1">next</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>

    <span class="s4"># test forcing to 0-d</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]], </span><span class="s1">op_axes</span><span class="s2">=[()])</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]],</span>
               <span class="s1">op_axes</span><span class="s2">=[()], </span><span class="s1">itershape</span><span class="s2">=())</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">i</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s4"># passing an itershape alone is not enough, the op_axes are also needed</span>
    <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), [</span><span class="s3">'multi_index'</span><span class="s2">], [[</span><span class="s3">'readonly'</span><span class="s2">]], </span><span class="s1">itershape</span><span class="s2">=())</span>

    <span class="s4"># Test a more complex buffered casting case (same as another test above)</span>
    <span class="s1">sdt </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'f4'</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'i8'</span><span class="s2">), (</span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'c8'</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)), (</span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'O'</span><span class="s2">)]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">'buffered'</span><span class="s2">, </span><span class="s3">'refs_ok'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">],</span>
                    <span class="s1">casting</span><span class="s2">=</span><span class="s3">'unsafe'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=</span><span class="s1">sdt</span><span class="s2">)</span>
    <span class="s1">vals </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s3">'a'</span><span class="s2">], </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s3">'b'</span><span class="s2">], </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s3">'c'</span><span class="s2">], [[(</span><span class="s5">0.5</span><span class="s2">)]*</span><span class="s5">3</span><span class="s2">]*</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">[</span><span class="s3">'d'</span><span class="s2">], </span><span class="s5">0.5</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_object_iter_cleanup</span><span class="s2">():</span>
    <span class="s4"># see gh-18450</span>
    <span class="s4"># object arrays can raise a python exception in ufunc inner loops using</span>
    <span class="s4"># nditer, which should cause iteration to stop &amp; cleanup. There were bugs</span>
    <span class="s4"># in the nditer cleanup when decref'ing object arrays.</span>
    <span class="s4"># This test would trigger valgrind &quot;uninitialized read&quot; before the bugfix.</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">17000</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">) * </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s4"># this more explicit code also triggers the invalid access</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">BUFSIZE </span><span class="s2">* </span><span class="s5">10</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">oarr </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">oarr</span><span class="s2">[:, -</span><span class="s5">1</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">oarr</span><span class="s2">[:, ::-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">arr</span><span class="s2">[:, ::-</span><span class="s5">1</span><span class="s2">]))</span>

    <span class="s4"># followup: this tests for a bug introduced in the first pass of gh-18450,</span>
    <span class="s4"># caused by an incorrect fallthrough of the TypeError</span>
    <span class="s0">class </span><span class="s1">T</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__bool__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s3">&quot;Ambiguous&quot;</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_or</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">,</span>
                             <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">T</span><span class="s2">(), </span><span class="s1">T</span><span class="s2">()], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'O'</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_object_iter_cleanup_reduce</span><span class="s2">():</span>
    <span class="s4"># Similar as above, but a complex reduction case that was previously</span>
    <span class="s4"># missed (see gh-18810).</span>
    <span class="s4"># The following array is special in that it cannot be flattened:</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">None</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])[::</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;arr&quot;</span><span class="s2">, [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">8000</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)[:, ::</span><span class="s5">2</span><span class="s2">, :],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">8000</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s3">&quot;F&quot;</span><span class="s2">)[:, ::</span><span class="s5">2</span><span class="s2">, :],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">8000</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)[:, ::</span><span class="s5">2</span><span class="s2">, :].</span><span class="s1">copy</span><span class="s2">(</span><span class="s3">&quot;F&quot;</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_object_iter_cleanup_large_reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
    <span class="s4"># More complicated calls are possible for large arrays:</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">8000</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
    <span class="s4"># force casting with `dtype=object`</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s5">8000</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_iter_too_large</span><span class="s2">():</span>
    <span class="s4"># The total size of the iterator must not exceed the maximum intp due</span>
    <span class="s4"># to broadcasting. Dividing by 1024 will keep it small enough to</span>
    <span class="s4"># give a legal array.</span>
    <span class="s1">size </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">).</span><span class="s1">max </span><span class="s2">// </span><span class="s5">1024</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">stride_tricks</span><span class="s2">.</span><span class="s1">as_strided</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s5">1</span><span class="s2">), (</span><span class="s1">size</span><span class="s2">,), (</span><span class="s5">0</span><span class="s2">,))</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">, (</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">]))</span>
    <span class="s4"># test the same for multiindex. That may get more interesting when</span>
    <span class="s4"># removing 0 dimensional axis is allowed (since an iterator can grow then)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">nditer</span><span class="s2">,</span>
                  <span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">]), </span><span class="s1">flags</span><span class="s2">=[</span><span class="s3">'multi_index'</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_iter_too_large_with_multiindex</span><span class="s2">():</span>
    <span class="s4"># When a multi index is being tracked, the error is delayed this</span>
    <span class="s4"># checks the delayed error messages and getting below that by</span>
    <span class="s4"># removing an axis.</span>
    <span class="s1">base_size </span><span class="s2">= </span><span class="s5">2</span><span class="s2">**</span><span class="s5">10</span>
    <span class="s1">num </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s0">while </span><span class="s1">base_size</span><span class="s2">**</span><span class="s1">num </span><span class="s2">&lt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">).</span><span class="s1">max</span><span class="s2">:</span>
        <span class="s1">num </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s1">shape_template </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">] * </span><span class="s1">num</span>
    <span class="s1">arrays </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num</span><span class="s2">):</span>
        <span class="s1">shape </span><span class="s2">= </span><span class="s1">shape_template</span><span class="s2">[:]</span>
        <span class="s1">shape</span><span class="s2">[</span><span class="s1">i </span><span class="s2">* </span><span class="s5">2</span><span class="s2">] = </span><span class="s5">2</span><span class="s2">**</span><span class="s5">10</span>
        <span class="s1">arrays</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">))</span>
    <span class="s1">arrays </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">arrays</span><span class="s2">)</span>

    <span class="s4"># arrays are now too large to be broadcast. The different modes test</span>
    <span class="s4"># different nditer functionality with or without GIL.</span>
    <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">6</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">_multiarray_tests</span><span class="s2">.</span><span class="s1">test_nditer_too_large</span><span class="s2">(</span><span class="s1">arrays</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
    <span class="s4"># but if we do nothing with the nditer, it can be constructed:</span>
    <span class="s1">_multiarray_tests</span><span class="s2">.</span><span class="s1">test_nditer_too_large</span><span class="s2">(</span><span class="s1">arrays</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)</span>

    <span class="s4"># When an axis is removed, things should work again (half the time):</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">mode </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">6</span><span class="s2">):</span>
            <span class="s4"># an axis with size 1024 is removed:</span>
            <span class="s1">_multiarray_tests</span><span class="s2">.</span><span class="s1">test_nditer_too_large</span><span class="s2">(</span><span class="s1">arrays</span><span class="s2">, </span><span class="s1">i</span><span class="s2">*</span><span class="s5">2</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>
            <span class="s4"># an axis with size 1 is removed:</span>
            <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s1">_multiarray_tests</span><span class="s2">.</span><span class="s1">test_nditer_too_large</span><span class="s2">(</span><span class="s1">arrays</span><span class="s2">, </span><span class="s1">i</span><span class="s2">*</span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_writebacks</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">!= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">byteorder</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                        <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = </span><span class="s5">100</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, </span><span class="s5">100</span><span class="s2">)</span>
    <span class="s4"># do it again, this time raise an error,</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                        <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][:] = </span><span class="s5">0</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">'exit context manager on exception'</span><span class="s2">)</span>
    <span class="s0">except</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
    <span class="s4"># cannot reuse i outside context manager</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">, </span><span class="s1">it</span><span class="s2">, </span><span class="s3">'operands'</span><span class="s2">)</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                        <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">x</span><span class="s2">[:] = </span><span class="s5">6</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writebackifcopy</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">x</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writebackifcopy</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">[:] = </span><span class="s5">123 </span><span class="s4"># x.data still valid</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, </span><span class="s5">6</span><span class="s2">) </span><span class="s4"># but not connected to au</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [],</span>
                 <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                 <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># reentering works</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
                <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">123</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [],</span>
                 <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                 <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s4"># make sure exiting the inner context manager closes the iterator</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
                <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">123</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">, </span><span class="s1">it</span><span class="s2">, </span><span class="s3">'operands'</span><span class="s2">)</span>
    <span class="s4"># do not crash if original data array is decrefed</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [],</span>
                 <span class="s2">[[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                 <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
    <span class="s0">del </span><span class="s1">au</span>
    <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">[...] = </span><span class="s5">123</span>
    <span class="s4"># make sure we cannot reenter the closed iterator</span>
    <span class="s1">enter </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">__enter__</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">enter</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_close_equivalent</span><span class="s2">():</span>
    <span class="s7">''' using a context amanger and using nditer.close are equivalent 
    '''</span>
    <span class="s0">def </span><span class="s1">add_close</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">addop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span>
        <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">out</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">,</span><span class="s3">'allocate'</span><span class="s2">]])</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">) </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s1">addop</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">ret</span>

    <span class="s0">def </span><span class="s1">add_context</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">addop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span>
        <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">out</span><span class="s2">], [],</span>
                    <span class="s2">[[</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'readonly'</span><span class="s2">], [</span><span class="s3">'writeonly'</span><span class="s2">,</span><span class="s3">'allocate'</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">it</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">) </span><span class="s0">in </span><span class="s1">it</span><span class="s2">:</span>
                <span class="s1">addop</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">c</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">it</span><span class="s2">.</span><span class="s1">operands</span><span class="s2">[</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">add_close</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), </span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">add_context</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), </span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>

<span class="s0">def </span><span class="s1">test_close_raises</span><span class="s2">():</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">assert_equal </span><span class="s2">(</span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">it</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">StopIteration</span><span class="s2">, </span><span class="s1">next</span><span class="s2">, </span><span class="s1">it</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">, </span><span class="s1">it</span><span class="s2">, </span><span class="s3">'operands'</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">test_close_parameters</span><span class="s2">():</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">it</span><span class="s2">.</span><span class="s1">close</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Python lacks refcounts&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_warn_noclose</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'f4'</span><span class="s2">)</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">byteswap</span><span class="s2">()</span>
    <span class="s1">au </span><span class="s2">= </span><span class="s1">au</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">au</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">newbyteorder</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
        <span class="s1">sup</span><span class="s2">.</span><span class="s1">record</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
        <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">au</span><span class="s2">, [], [[</span><span class="s3">'readwrite'</span><span class="s2">, </span><span class="s3">'updateifcopy'</span><span class="s2">]],</span>
                        <span class="s1">casting</span><span class="s2">=</span><span class="s3">'equiv'</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">'f4'</span><span class="s2">)])</span>
        <span class="s0">del </span><span class="s1">it</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sup</span><span class="s2">.</span><span class="s1">log</span><span class="s2">) == </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">([</span><span class="s3">&quot;in_dtype&quot;</span><span class="s2">, </span><span class="s3">&quot;buf_dtype&quot;</span><span class="s2">],</span>
        <span class="s2">[(</span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s3">&quot;O&quot;</span><span class="s2">), (</span><span class="s3">&quot;O&quot;</span><span class="s2">, </span><span class="s3">&quot;i&quot;</span><span class="s2">),  </span><span class="s4"># most simple cases</span>
         <span class="s2">(</span><span class="s3">&quot;i,O&quot;</span><span class="s2">, </span><span class="s3">&quot;O,O&quot;</span><span class="s2">),  </span><span class="s4"># structured partially only copying O</span>
         <span class="s2">(</span><span class="s3">&quot;O,i&quot;</span><span class="s2">, </span><span class="s3">&quot;i,O&quot;</span><span class="s2">),  </span><span class="s4"># structured casting to and from O</span>
         <span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;steps&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_partial_iteration_cleanup</span><span class="s2">(</span><span class="s1">in_dtype</span><span class="s2">, </span><span class="s1">buf_dtype</span><span class="s2">, </span><span class="s1">steps</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot; 
    Checks for reference counting leaks during cleanup.  Using explicit 
    reference counts lead to occasional false positives (at least in parallel 
    test setups).  This test now should still test leaks correctly when 
    run e.g. with pytest-valgrind or pytest-leaks 
    &quot;&quot;&quot;</span>
    <span class="s1">value </span><span class="s2">= </span><span class="s5">2</span><span class="s2">**</span><span class="s5">30 </span><span class="s2">+ </span><span class="s5">1  </span><span class="s4"># just a random value that Python won't intern</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">BUFSIZE </span><span class="s2">* </span><span class="s5">2.5</span><span class="s2">), </span><span class="s1">value</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">in_dtype</span><span class="s2">)</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">buf_dtype</span><span class="s2">)],</span>
            <span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;buffered&quot;</span><span class="s2">, </span><span class="s3">&quot;external_loop&quot;</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">step </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">):</span>
        <span class="s4"># The iteration finishes in 3 steps, the first two are partial</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>

    <span class="s0">del </span><span class="s1">it  </span><span class="s4"># not necessary, but we test the cleanup</span>

    <span class="s4"># Repeat the test with `iternext`</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">buf_dtype</span><span class="s2">)],</span>
                   <span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;buffered&quot;</span><span class="s2">, </span><span class="s3">&quot;external_loop&quot;</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">step </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">steps</span><span class="s2">):</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>

    <span class="s0">del </span><span class="s1">it  </span><span class="s4"># not necessary, but we test the cleanup</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_REFCOUNT</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Python lacks refcounts&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">([</span><span class="s3">&quot;in_dtype&quot;</span><span class="s2">, </span><span class="s3">&quot;buf_dtype&quot;</span><span class="s2">],</span>
         <span class="s2">[(</span><span class="s3">&quot;O&quot;</span><span class="s2">, </span><span class="s3">&quot;i&quot;</span><span class="s2">),  </span><span class="s4"># most simple cases</span>
          <span class="s2">(</span><span class="s3">&quot;O,i&quot;</span><span class="s2">, </span><span class="s3">&quot;i,O&quot;</span><span class="s2">),  </span><span class="s4"># structured casting to and from O</span>
          <span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_partial_iteration_error</span><span class="s2">(</span><span class="s1">in_dtype</span><span class="s2">, </span><span class="s1">buf_dtype</span><span class="s2">):</span>
    <span class="s1">value </span><span class="s2">= </span><span class="s5">123  </span><span class="s4"># relies on python cache (leak-check will still find it)</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">BUFSIZE </span><span class="s2">* </span><span class="s5">2.5</span><span class="s2">), </span><span class="s1">value</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">in_dtype</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">in_dtype </span><span class="s2">== </span><span class="s3">&quot;O&quot;</span><span class="s2">:</span>
        <span class="s1">arr</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">BUFSIZE </span><span class="s2">* </span><span class="s5">1.5</span><span class="s2">)] = </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">arr</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">ncu</span><span class="s2">.</span><span class="s1">BUFSIZE </span><span class="s2">* </span><span class="s5">1.5</span><span class="s2">)][</span><span class="s3">&quot;f0&quot;</span><span class="s2">] = </span><span class="s0">None</span>

    <span class="s1">count </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">buf_dtype</span><span class="s2">)],</span>
            <span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;buffered&quot;</span><span class="s2">, </span><span class="s3">&quot;external_loop&quot;</span><span class="s2">, </span><span class="s3">&quot;refs_ok&quot;</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s4"># pytest.raises seems to have issues with the error originating</span>
        <span class="s4"># in the for loop, so manually unravel:</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)  </span><span class="s4"># raises TypeError</span>

    <span class="s4"># Repeat the test with `iternext` after resetting, the buffers should</span>
    <span class="s4"># already be cleared from any references, so resetting is sufficient.</span>
    <span class="s1">it</span><span class="s2">.</span><span class="s1">reset</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>
        <span class="s1">it</span><span class="s2">.</span><span class="s1">iternext</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">count </span><span class="s2">== </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">getrefcount</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_debug_print</span><span class="s2">(</span><span class="s1">capfd</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot; 
    Matches the expected output of a debug print with the actual output. 
    Note that the iterator dump should not be considered stable API, 
    this test is mainly to ensure the print does not crash. 
 
    Currently uses a subprocess to avoid dealing with the C level `printf`s. 
    &quot;&quot;&quot;</span>
    <span class="s4"># the expected output with all addresses and sizes stripped (they vary</span>
    <span class="s4"># and/or are platform dependent).</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
    ------ BEGIN ITERATOR DUMP ------ 
    | Iterator Address: 
    | ItFlags: BUFFER REDUCE REUSE_REDUCE_LOOPS 
    | NDim: 2 
    | NOp: 2 
    | IterSize: 50 
    | IterStart: 0 
    | IterEnd: 50 
    | IterIndex: 0 
    | Iterator SizeOf: 
    | BufferData SizeOf: 
    | AxisData SizeOf: 
    | 
    | Perm: 0 1 
    | DTypes: 
    | DTypes: dtype('float64') dtype('int32') 
    | InitDataPtrs: 
    | BaseOffsets: 0 0 
    | Operands: 
    | Operand DTypes: dtype('int64') dtype('float64') 
    | OpItFlags: 
    |   Flags[0]: READ CAST ALIGNED 
    |   Flags[1]: READ WRITE CAST ALIGNED REDUCE 
    | 
    | BufferData: 
    |   BufferSize: 50 
    |   Size: 5 
    |   BufIterEnd: 5 
    |   REDUCE Pos: 0 
    |   REDUCE OuterSize: 10 
    |   REDUCE OuterDim: 1 
    |   Strides: 8 4 
    |   Ptrs: 
    |   REDUCE Outer Strides: 40 0 
    |   REDUCE Outer Ptrs: 
    |   ReadTransferFn: 
    |   ReadTransferData: 
    |   WriteTransferFn: 
    |   WriteTransferData: 
    |   Buffers: 
    | 
    | AxisData[0]: 
    |   Shape: 5 
    |   Index: 0 
    |   Strides: 16 8 
    |   Ptrs: 
    | AxisData[1]: 
    |   Shape: 10 
    |   Index: 0 
    |   Strides: 80 0 
    |   Ptrs: 
    ------- END ITERATOR DUMP ------- 
    &quot;&quot;&quot;</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">splitlines</span><span class="s2">()</span>

    <span class="s1">arr1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)[:, ::</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5.</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nditer</span><span class="s2">((</span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">), </span><span class="s1">op_dtypes</span><span class="s2">=[</span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;i4&quot;</span><span class="s2">], </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">,</span>
                   <span class="s1">flags</span><span class="s2">=[</span><span class="s3">&quot;reduce_ok&quot;</span><span class="s2">, </span><span class="s3">&quot;buffered&quot;</span><span class="s2">],</span>
                   <span class="s1">op_flags</span><span class="s2">=[[</span><span class="s3">&quot;readonly&quot;</span><span class="s2">], [</span><span class="s3">&quot;readwrite&quot;</span><span class="s2">]])</span>
    <span class="s1">it</span><span class="s2">.</span><span class="s1">debug_print</span><span class="s2">()</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">capfd</span><span class="s2">.</span><span class="s1">readouterr</span><span class="s2">().</span><span class="s1">out</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">splitlines</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">res_line</span><span class="s2">, </span><span class="s1">expected_line </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s4"># The actual output may have additional pointers listed that are</span>
        <span class="s4"># stripped from the example output:</span>
        <span class="s0">assert </span><span class="s1">res_line</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">expected_line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">())</span>
</pre>
</body>
</html>