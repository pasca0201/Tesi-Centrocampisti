<html>
<head>
<title>capi_maps.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
capi_maps.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Copyright 1999 -- 2011 Pearu Peterson all rights reserved. 
Copyright 2011 -- present NumPy Developers. 
Permission to use, modify, and distribute this software is given under the 
terms of the NumPy License. 
 
NO WARRANTY IS EXPRESSED OR IMPLIED.  USE AT YOUR OWN RISK. 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">__version__</span>
<span class="s1">f2py_version </span><span class="s3">= </span><span class="s1">__version__</span><span class="s3">.</span><span class="s1">version</span>

<span class="s2">import </span><span class="s1">copy</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">crackfortran </span><span class="s2">import </span><span class="s1">markoutercomma</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">cb_rules</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_isocbind </span><span class="s2">import </span><span class="s1">iso_c_binding_map</span><span class="s3">, </span><span class="s1">isoc_c2pycode_map</span><span class="s3">, </span><span class="s1">iso_c2py_map</span>

<span class="s4"># The environment provided by auxfuncs.py is needed for some calls to eval.</span>
<span class="s4"># As the needed functions cannot be determined by static inspection of the</span>
<span class="s4"># code, it is safest to use import * pending a major refactoring of f2py.</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">auxfuncs </span><span class="s2">import </span><span class="s3">*</span>

<span class="s1">__all__ </span><span class="s3">= [</span>
    <span class="s5">'getctype'</span><span class="s3">, </span><span class="s5">'getstrlength'</span><span class="s3">, </span><span class="s5">'getarrdims'</span><span class="s3">, </span><span class="s5">'getpydocsign'</span><span class="s3">,</span>
    <span class="s5">'getarrdocsign'</span><span class="s3">, </span><span class="s5">'getinit'</span><span class="s3">, </span><span class="s5">'sign2map'</span><span class="s3">, </span><span class="s5">'routsign2map'</span><span class="s3">, </span><span class="s5">'modsign2map'</span><span class="s3">,</span>
    <span class="s5">'cb_sign2map'</span><span class="s3">, </span><span class="s5">'cb_routsign2map'</span><span class="s3">, </span><span class="s5">'common_sign2map'</span><span class="s3">, </span><span class="s5">'process_f2cmap_dict'</span>
<span class="s3">]</span>


<span class="s1">depargs </span><span class="s3">= []</span>
<span class="s1">lcb_map </span><span class="s3">= {}</span>
<span class="s1">lcb2_map </span><span class="s3">= {}</span>
<span class="s4"># forced casting: mainly caused by the fact that Python or Numeric</span>
<span class="s4">#                 C/APIs do not support the corresponding C types.</span>
<span class="s1">c2py_map </span><span class="s3">= {</span><span class="s5">'double'</span><span class="s3">: </span><span class="s5">'float'</span><span class="s3">,</span>
            <span class="s5">'float'</span><span class="s3">: </span><span class="s5">'float'</span><span class="s3">,                          </span><span class="s4"># forced casting</span>
            <span class="s5">'long_double'</span><span class="s3">: </span><span class="s5">'float'</span><span class="s3">,                    </span><span class="s4"># forced casting</span>
            <span class="s5">'char'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                             </span><span class="s4"># forced casting</span>
            <span class="s5">'signed_char'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                      </span><span class="s4"># forced casting</span>
            <span class="s5">'unsigned_char'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                    </span><span class="s4"># forced casting</span>
            <span class="s5">'short'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                            </span><span class="s4"># forced casting</span>
            <span class="s5">'unsigned_short'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                   </span><span class="s4"># forced casting</span>
            <span class="s5">'int'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                              </span><span class="s4"># forced casting</span>
            <span class="s5">'long'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,</span>
            <span class="s5">'long_long'</span><span class="s3">: </span><span class="s5">'long'</span><span class="s3">,</span>
            <span class="s5">'unsigned'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,                         </span><span class="s4"># forced casting</span>
            <span class="s5">'complex_float'</span><span class="s3">: </span><span class="s5">'complex'</span><span class="s3">,                </span><span class="s4"># forced casting</span>
            <span class="s5">'complex_double'</span><span class="s3">: </span><span class="s5">'complex'</span><span class="s3">,</span>
            <span class="s5">'complex_long_double'</span><span class="s3">: </span><span class="s5">'complex'</span><span class="s3">,          </span><span class="s4"># forced casting</span>
            <span class="s5">'string'</span><span class="s3">: </span><span class="s5">'string'</span><span class="s3">,</span>
            <span class="s5">'character'</span><span class="s3">: </span><span class="s5">'bytes'</span><span class="s3">,</span>
            <span class="s3">}</span>

<span class="s1">c2capi_map </span><span class="s3">= {</span><span class="s5">'double'</span><span class="s3">: </span><span class="s5">'NPY_DOUBLE'</span><span class="s3">,</span>
                <span class="s5">'float'</span><span class="s3">: </span><span class="s5">'NPY_FLOAT'</span><span class="s3">,</span>
                <span class="s5">'long_double'</span><span class="s3">: </span><span class="s5">'NPY_LONGDOUBLE'</span><span class="s3">,</span>
                <span class="s5">'char'</span><span class="s3">: </span><span class="s5">'NPY_BYTE'</span><span class="s3">,</span>
                <span class="s5">'unsigned_char'</span><span class="s3">: </span><span class="s5">'NPY_UBYTE'</span><span class="s3">,</span>
                <span class="s5">'signed_char'</span><span class="s3">: </span><span class="s5">'NPY_BYTE'</span><span class="s3">,</span>
                <span class="s5">'short'</span><span class="s3">: </span><span class="s5">'NPY_SHORT'</span><span class="s3">,</span>
                <span class="s5">'unsigned_short'</span><span class="s3">: </span><span class="s5">'NPY_USHORT'</span><span class="s3">,</span>
                <span class="s5">'int'</span><span class="s3">: </span><span class="s5">'NPY_INT'</span><span class="s3">,</span>
                <span class="s5">'unsigned'</span><span class="s3">: </span><span class="s5">'NPY_UINT'</span><span class="s3">,</span>
                <span class="s5">'long'</span><span class="s3">: </span><span class="s5">'NPY_LONG'</span><span class="s3">,</span>
                <span class="s5">'unsigned_long'</span><span class="s3">: </span><span class="s5">'NPY_ULONG'</span><span class="s3">,</span>
                <span class="s5">'long_long'</span><span class="s3">: </span><span class="s5">'NPY_LONGLONG'</span><span class="s3">,</span>
                <span class="s5">'unsigned_long_long'</span><span class="s3">: </span><span class="s5">'NPY_ULONGLONG'</span><span class="s3">,</span>
                <span class="s5">'complex_float'</span><span class="s3">: </span><span class="s5">'NPY_CFLOAT'</span><span class="s3">,</span>
                <span class="s5">'complex_double'</span><span class="s3">: </span><span class="s5">'NPY_CDOUBLE'</span><span class="s3">,</span>
                <span class="s5">'complex_long_double'</span><span class="s3">: </span><span class="s5">'NPY_CDOUBLE'</span><span class="s3">,</span>
                <span class="s5">'string'</span><span class="s3">: </span><span class="s5">'NPY_STRING'</span><span class="s3">,</span>
                <span class="s5">'character'</span><span class="s3">: </span><span class="s5">'NPY_STRING'</span><span class="s3">}</span>

<span class="s1">c2pycode_map </span><span class="s3">= {</span><span class="s5">'double'</span><span class="s3">: </span><span class="s5">'d'</span><span class="s3">,</span>
                <span class="s5">'float'</span><span class="s3">: </span><span class="s5">'f'</span><span class="s3">,</span>
                <span class="s5">'long_double'</span><span class="s3">: </span><span class="s5">'g'</span><span class="s3">,</span>
                <span class="s5">'char'</span><span class="s3">: </span><span class="s5">'b'</span><span class="s3">,</span>
                <span class="s5">'unsigned_char'</span><span class="s3">: </span><span class="s5">'B'</span><span class="s3">,</span>
                <span class="s5">'signed_char'</span><span class="s3">: </span><span class="s5">'b'</span><span class="s3">,</span>
                <span class="s5">'short'</span><span class="s3">: </span><span class="s5">'h'</span><span class="s3">,</span>
                <span class="s5">'unsigned_short'</span><span class="s3">: </span><span class="s5">'H'</span><span class="s3">,</span>
                <span class="s5">'int'</span><span class="s3">: </span><span class="s5">'i'</span><span class="s3">,</span>
                <span class="s5">'unsigned'</span><span class="s3">: </span><span class="s5">'I'</span><span class="s3">,</span>
                <span class="s5">'long'</span><span class="s3">: </span><span class="s5">'l'</span><span class="s3">,</span>
                <span class="s5">'unsigned_long'</span><span class="s3">: </span><span class="s5">'L'</span><span class="s3">,</span>
                <span class="s5">'long_long'</span><span class="s3">: </span><span class="s5">'q'</span><span class="s3">,</span>
                <span class="s5">'unsigned_long_long'</span><span class="s3">: </span><span class="s5">'Q'</span><span class="s3">,</span>
                <span class="s5">'complex_float'</span><span class="s3">: </span><span class="s5">'F'</span><span class="s3">,</span>
                <span class="s5">'complex_double'</span><span class="s3">: </span><span class="s5">'D'</span><span class="s3">,</span>
                <span class="s5">'complex_long_double'</span><span class="s3">: </span><span class="s5">'G'</span><span class="s3">,</span>
                <span class="s5">'string'</span><span class="s3">: </span><span class="s5">'S'</span><span class="s3">,</span>
                <span class="s5">'character'</span><span class="s3">: </span><span class="s5">'c'</span><span class="s3">}</span>

<span class="s4"># https://docs.python.org/3/c-api/arg.html#building-values</span>
<span class="s1">c2buildvalue_map </span><span class="s3">= {</span><span class="s5">'double'</span><span class="s3">: </span><span class="s5">'d'</span><span class="s3">,</span>
                    <span class="s5">'float'</span><span class="s3">: </span><span class="s5">'f'</span><span class="s3">,</span>
                    <span class="s5">'char'</span><span class="s3">: </span><span class="s5">'b'</span><span class="s3">,</span>
                    <span class="s5">'signed_char'</span><span class="s3">: </span><span class="s5">'b'</span><span class="s3">,</span>
                    <span class="s5">'short'</span><span class="s3">: </span><span class="s5">'h'</span><span class="s3">,</span>
                    <span class="s5">'int'</span><span class="s3">: </span><span class="s5">'i'</span><span class="s3">,</span>
                    <span class="s5">'long'</span><span class="s3">: </span><span class="s5">'l'</span><span class="s3">,</span>
                    <span class="s5">'long_long'</span><span class="s3">: </span><span class="s5">'L'</span><span class="s3">,</span>
                    <span class="s5">'complex_float'</span><span class="s3">: </span><span class="s5">'N'</span><span class="s3">,</span>
                    <span class="s5">'complex_double'</span><span class="s3">: </span><span class="s5">'N'</span><span class="s3">,</span>
                    <span class="s5">'complex_long_double'</span><span class="s3">: </span><span class="s5">'N'</span><span class="s3">,</span>
                    <span class="s5">'string'</span><span class="s3">: </span><span class="s5">'y'</span><span class="s3">,</span>
                    <span class="s5">'character'</span><span class="s3">: </span><span class="s5">'c'</span><span class="s3">}</span>

<span class="s1">f2cmap_all </span><span class="s3">= {</span><span class="s5">'real'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'float'</span><span class="s3">, </span><span class="s5">'4'</span><span class="s3">: </span><span class="s5">'float'</span><span class="s3">, </span><span class="s5">'8'</span><span class="s3">: </span><span class="s5">'double'</span><span class="s3">,</span>
                       <span class="s5">'12'</span><span class="s3">: </span><span class="s5">'long_double'</span><span class="s3">, </span><span class="s5">'16'</span><span class="s3">: </span><span class="s5">'long_double'</span><span class="s3">},</span>
              <span class="s5">'integer'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">, </span><span class="s5">'1'</span><span class="s3">: </span><span class="s5">'signed_char'</span><span class="s3">, </span><span class="s5">'2'</span><span class="s3">: </span><span class="s5">'short'</span><span class="s3">,</span>
                          <span class="s5">'4'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">, </span><span class="s5">'8'</span><span class="s3">: </span><span class="s5">'long_long'</span><span class="s3">,</span>
                          <span class="s5">'-1'</span><span class="s3">: </span><span class="s5">'unsigned_char'</span><span class="s3">, </span><span class="s5">'-2'</span><span class="s3">: </span><span class="s5">'unsigned_short'</span><span class="s3">,</span>
                          <span class="s5">'-4'</span><span class="s3">: </span><span class="s5">'unsigned'</span><span class="s3">, </span><span class="s5">'-8'</span><span class="s3">: </span><span class="s5">'unsigned_long_long'</span><span class="s3">},</span>
              <span class="s5">'complex'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'complex_float'</span><span class="s3">, </span><span class="s5">'8'</span><span class="s3">: </span><span class="s5">'complex_float'</span><span class="s3">,</span>
                          <span class="s5">'16'</span><span class="s3">: </span><span class="s5">'complex_double'</span><span class="s3">, </span><span class="s5">'24'</span><span class="s3">: </span><span class="s5">'complex_long_double'</span><span class="s3">,</span>
                          <span class="s5">'32'</span><span class="s3">: </span><span class="s5">'complex_long_double'</span><span class="s3">},</span>
              <span class="s5">'complexkind'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'complex_float'</span><span class="s3">, </span><span class="s5">'4'</span><span class="s3">: </span><span class="s5">'complex_float'</span><span class="s3">,</span>
                              <span class="s5">'8'</span><span class="s3">: </span><span class="s5">'complex_double'</span><span class="s3">, </span><span class="s5">'12'</span><span class="s3">: </span><span class="s5">'complex_long_double'</span><span class="s3">,</span>
                              <span class="s5">'16'</span><span class="s3">: </span><span class="s5">'complex_long_double'</span><span class="s3">},</span>
              <span class="s5">'logical'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">, </span><span class="s5">'1'</span><span class="s3">: </span><span class="s5">'char'</span><span class="s3">, </span><span class="s5">'2'</span><span class="s3">: </span><span class="s5">'short'</span><span class="s3">, </span><span class="s5">'4'</span><span class="s3">: </span><span class="s5">'int'</span><span class="s3">,</span>
                          <span class="s5">'8'</span><span class="s3">: </span><span class="s5">'long_long'</span><span class="s3">},</span>
              <span class="s5">'double complex'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'complex_double'</span><span class="s3">},</span>
              <span class="s5">'double precision'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'double'</span><span class="s3">},</span>
              <span class="s5">'byte'</span><span class="s3">: {</span><span class="s5">''</span><span class="s3">: </span><span class="s5">'char'</span><span class="s3">},</span>
              <span class="s3">}</span>

<span class="s4"># Add ISO_C handling</span>
<span class="s1">c2pycode_map</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">isoc_c2pycode_map</span><span class="s3">)</span>
<span class="s1">c2py_map</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">iso_c2py_map</span><span class="s3">)</span>
<span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">process_f2cmap_dict</span><span class="s3">(</span><span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">iso_c_binding_map</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">)</span>
<span class="s4"># End ISO_C handling</span>
<span class="s1">f2cmap_default </span><span class="s3">= </span><span class="s1">copy</span><span class="s3">.</span><span class="s1">deepcopy</span><span class="s3">(</span><span class="s1">f2cmap_all</span><span class="s3">)</span>

<span class="s1">f2cmap_mapped </span><span class="s3">= []</span>

<span class="s2">def </span><span class="s1">load_f2cmap_file</span><span class="s3">(</span><span class="s1">f2cmap_file</span><span class="s3">):</span>
    <span class="s2">global </span><span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">f2cmap_mapped</span>

    <span class="s1">f2cmap_all </span><span class="s3">= </span><span class="s1">copy</span><span class="s3">.</span><span class="s1">deepcopy</span><span class="s3">(</span><span class="s1">f2cmap_default</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">f2cmap_file </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s4"># Default value</span>
        <span class="s1">f2cmap_file </span><span class="s3">= </span><span class="s5">'.f2py_f2cmap'</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">f2cmap_file</span><span class="s3">):</span>
            <span class="s2">return</span>

    <span class="s4"># User defined additions to f2cmap_all.</span>
    <span class="s4"># f2cmap_file must contain a dictionary of dictionaries, only. For</span>
    <span class="s4"># example, {'real':{'low':'float'}} means that Fortran 'real(low)' is</span>
    <span class="s4"># interpreted as C 'float'. This feature is useful for F90/95 users if</span>
    <span class="s4"># they use PARAMETERS in type specifications.</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">outmess</span><span class="s3">(</span><span class="s5">'Reading f2cmap from {!r} ...</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">f2cmap_file</span><span class="s3">))</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">f2cmap_file</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">d </span><span class="s3">= </span><span class="s1">eval</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">().</span><span class="s1">lower</span><span class="s3">(), {}, {})</span>
        <span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">f2cmap_mapped </span><span class="s3">= </span><span class="s1">process_f2cmap_dict</span><span class="s3">(</span><span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">outmess</span><span class="s3">(</span><span class="s5">'Successfully applied user defined f2cmap changes</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">msg</span><span class="s3">:</span>
        <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'Failed to apply user defined f2cmap changes: %s. Skipping.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span><span class="s1">msg</span><span class="s3">))</span>


<span class="s1">cformat_map </span><span class="s3">= {</span><span class="s5">'double'</span><span class="s3">: </span><span class="s5">'%g'</span><span class="s3">,</span>
               <span class="s5">'float'</span><span class="s3">: </span><span class="s5">'%g'</span><span class="s3">,</span>
               <span class="s5">'long_double'</span><span class="s3">: </span><span class="s5">'%Lg'</span><span class="s3">,</span>
               <span class="s5">'char'</span><span class="s3">: </span><span class="s5">'%d'</span><span class="s3">,</span>
               <span class="s5">'signed_char'</span><span class="s3">: </span><span class="s5">'%d'</span><span class="s3">,</span>
               <span class="s5">'unsigned_char'</span><span class="s3">: </span><span class="s5">'%hhu'</span><span class="s3">,</span>
               <span class="s5">'short'</span><span class="s3">: </span><span class="s5">'%hd'</span><span class="s3">,</span>
               <span class="s5">'unsigned_short'</span><span class="s3">: </span><span class="s5">'%hu'</span><span class="s3">,</span>
               <span class="s5">'int'</span><span class="s3">: </span><span class="s5">'%d'</span><span class="s3">,</span>
               <span class="s5">'unsigned'</span><span class="s3">: </span><span class="s5">'%u'</span><span class="s3">,</span>
               <span class="s5">'long'</span><span class="s3">: </span><span class="s5">'%ld'</span><span class="s3">,</span>
               <span class="s5">'unsigned_long'</span><span class="s3">: </span><span class="s5">'%lu'</span><span class="s3">,</span>
               <span class="s5">'long_long'</span><span class="s3">: </span><span class="s5">'%ld'</span><span class="s3">,</span>
               <span class="s5">'complex_float'</span><span class="s3">: </span><span class="s5">'(%g,%g)'</span><span class="s3">,</span>
               <span class="s5">'complex_double'</span><span class="s3">: </span><span class="s5">'(%g,%g)'</span><span class="s3">,</span>
               <span class="s5">'complex_long_double'</span><span class="s3">: </span><span class="s5">'(%Lg,%Lg)'</span><span class="s3">,</span>
               <span class="s5">'string'</span><span class="s3">: </span><span class="s5">'</span><span class="s2">\\</span><span class="s5">&quot;%s</span><span class="s2">\\</span><span class="s5">&quot;'</span><span class="s3">,</span>
               <span class="s5">'character'</span><span class="s3">: </span><span class="s5">&quot;'%c'&quot;</span><span class="s3">,</span>
               <span class="s3">}</span>

<span class="s4"># Auxiliary functions</span>


<span class="s2">def </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Determines C type 
    &quot;&quot;&quot;</span>
    <span class="s1">ctype </span><span class="s3">= </span><span class="s5">'void'</span>
    <span class="s2">if </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'result' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'result'</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">]:</span>
            <span class="s2">return </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getctype: function %s has no return value?!</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% </span><span class="s1">a</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">issubroutine</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">ctype</span>
    <span class="s2">elif </span><span class="s1">ischaracter_or_characterarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">'character'</span>
    <span class="s2">elif </span><span class="s1">isstring_or_stringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">'string'</span>
    <span class="s2">elif </span><span class="s5">'typespec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'typespec'</span><span class="s3">].</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">in </span><span class="s1">f2cmap_all</span><span class="s3">:</span>
        <span class="s1">typespec </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'typespec'</span><span class="s3">].</span><span class="s1">lower</span><span class="s3">()</span>
        <span class="s1">f2cmap </span><span class="s3">= </span><span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">typespec</span><span class="s3">]</span>
        <span class="s1">ctype </span><span class="s3">= </span><span class="s1">f2cmap</span><span class="s3">[</span><span class="s5">''</span><span class="s3">]  </span><span class="s4"># default type</span>
        <span class="s2">if </span><span class="s5">'kindselector' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s5">'*' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">]:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">ctype </span><span class="s3">= </span><span class="s1">f2cmap</span><span class="s3">[</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">][</span><span class="s5">'*'</span><span class="s3">]]</span>
                <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                    <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getctype: &quot;%s %s %s&quot; not supported.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">%</span>
                            <span class="s3">(</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'typespec'</span><span class="s3">], </span><span class="s5">'*'</span><span class="s3">, </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">][</span><span class="s5">'*'</span><span class="s3">]))</span>
            <span class="s2">elif </span><span class="s5">'kind' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">]:</span>
                <span class="s2">if </span><span class="s1">typespec </span><span class="s3">+ </span><span class="s5">'kind' </span><span class="s2">in </span><span class="s1">f2cmap_all</span><span class="s3">:</span>
                    <span class="s1">f2cmap </span><span class="s3">= </span><span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">typespec </span><span class="s3">+ </span><span class="s5">'kind'</span><span class="s3">]</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">ctype </span><span class="s3">= </span><span class="s1">f2cmap</span><span class="s3">[</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">][</span><span class="s5">'kind'</span><span class="s3">]]</span>
                <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">typespec </span><span class="s2">in </span><span class="s1">f2cmap_all</span><span class="s3">:</span>
                        <span class="s1">f2cmap </span><span class="s3">= </span><span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">typespec</span><span class="s3">]</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">ctype </span><span class="s3">= </span><span class="s1">f2cmap</span><span class="s3">[</span><span class="s1">str</span><span class="s3">(</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">][</span><span class="s5">'kind'</span><span class="s3">])]</span>
                    <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                        <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getctype: &quot;%s(kind=%s)&quot; is mapped to C &quot;%s&quot; (to override define dict(%s = dict(%s=&quot;&lt;C typespec&gt;&quot;)) in %s/.f2py_f2cmap file).</span><span class="s2">\n</span><span class="s5">'</span>
                                <span class="s3">% (</span><span class="s1">typespec</span><span class="s3">, </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">][</span><span class="s5">'kind'</span><span class="s3">], </span><span class="s1">ctype</span><span class="s3">,</span>
                                   <span class="s1">typespec</span><span class="s3">, </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'kindselector'</span><span class="s3">][</span><span class="s5">'kind'</span><span class="s3">], </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">()))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getctype: No C-type found in &quot;%s&quot;, assuming void.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% </span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">ctype</span>


<span class="s2">def </span><span class="s1">f2cexpr</span><span class="s3">(</span><span class="s1">expr</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Rewrite Fortran expression as f2py supported C expression. 
 
    Due to the lack of a proper expression parser in f2py, this 
    function uses a heuristic approach that assumes that Fortran 
    arithmetic expressions are valid C arithmetic expressions when 
    mapping Fortran function calls to the corresponding C function/CPP 
    macros calls. 
 
    &quot;&quot;&quot;</span>
    <span class="s4"># TODO: support Fortran `len` function with optional kind parameter</span>
    <span class="s1">expr </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span><span class="s5">r'\blen\b'</span><span class="s3">, </span><span class="s5">'f2py_slen'</span><span class="s3">, </span><span class="s1">expr</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">expr</span>


<span class="s2">def </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isstringfunction</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'result' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'result'</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">]:</span>
            <span class="s2">return </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getstrlength: function %s has no return value?!</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% </span><span class="s1">a</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">errmess</span><span class="s3">(</span>
            <span class="s5">'getstrlength: expected a signature of a string but got: %s</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)))</span>
    <span class="s1">len </span><span class="s3">= </span><span class="s5">'1'</span>
    <span class="s2">if </span><span class="s5">'charselector' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'charselector'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s5">'*' </span><span class="s2">in </span><span class="s1">a</span><span class="s3">:</span>
            <span class="s1">len </span><span class="s3">= </span><span class="s1">a</span><span class="s3">[</span><span class="s5">'*'</span><span class="s3">]</span>
        <span class="s2">elif </span><span class="s5">'len' </span><span class="s2">in </span><span class="s1">a</span><span class="s3">:</span>
            <span class="s1">len </span><span class="s3">= </span><span class="s1">f2cexpr</span><span class="s3">(</span><span class="s1">a</span><span class="s3">[</span><span class="s5">'len'</span><span class="s3">])</span>
    <span class="s2">if </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s5">r'\(\s*(\*|:)\s*\)'</span><span class="s3">, </span><span class="s1">len</span><span class="s3">) </span><span class="s2">or </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s5">r'(\*|:)'</span><span class="s3">, </span><span class="s1">len</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isintent_hide</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getstrlength:intent(hide): expected a string with defined length but got: %s</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span>
                <span class="s1">repr</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)))</span>
        <span class="s1">len </span><span class="s3">= </span><span class="s5">'-1'</span>
    <span class="s2">return </span><span class="s1">len</span>


<span class="s2">def </span><span class="s1">getarrdims</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
    <span class="s1">ret </span><span class="s3">= {}</span>
    <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'size'</span><span class="s3">] = </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rank'</span><span class="s3">] = </span><span class="s5">'0'</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'dims'</span><span class="s3">] = </span><span class="s5">''</span>
    <span class="s2">elif </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'size'</span><span class="s3">] = </span><span class="s5">'1'</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rank'</span><span class="s3">] = </span><span class="s5">'0'</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'dims'</span><span class="s3">] = </span><span class="s5">''</span>
    <span class="s2">elif </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s1">copy</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'dimension'</span><span class="s3">])</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'size'</span><span class="s3">] = </span><span class="s5">'*'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'size'</span><span class="s3">] = </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'size'</span><span class="s3">]))</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'dims'</span><span class="s3">] = </span><span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rank'</span><span class="s3">] = </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rank*[-1]'</span><span class="s3">] = </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">) * [-</span><span class="s6">1</span><span class="s3">])[</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)):  </span><span class="s4"># solve dim for dependencies</span>
            <span class="s1">v </span><span class="s3">= []</span>
            <span class="s2">if </span><span class="s1">dim</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">in </span><span class="s1">depargs</span><span class="s3">:</span>
                <span class="s1">v </span><span class="s3">= [</span><span class="s1">dim</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">va </span><span class="s2">in </span><span class="s1">depargs</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s5">r'.*?\b%s\b.*' </span><span class="s3">% </span><span class="s1">va</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]):</span>
                        <span class="s1">v</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">va</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">va </span><span class="s2">in </span><span class="s1">v</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">depargs</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">va</span><span class="s3">) &gt; </span><span class="s1">depargs</span><span class="s3">.</span><span class="s1">index</span><span class="s3">(</span><span class="s1">a</span><span class="s3">):</span>
                    <span class="s1">dim</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">'*'</span>
                    <span class="s2">break</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'setdims'</span><span class="s3">], </span><span class="s1">i </span><span class="s3">= </span><span class="s5">''</span><span class="s3">, -</span><span class="s6">1</span>
        <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">dim</span><span class="s3">:</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span>
            <span class="s2">if </span><span class="s1">d </span><span class="s2">not in </span><span class="s3">[</span><span class="s5">'*'</span><span class="s3">, </span><span class="s5">':'</span><span class="s3">, </span><span class="s5">'(*)'</span><span class="s3">, </span><span class="s5">'(:)'</span><span class="s3">]:</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'setdims'</span><span class="s3">] = </span><span class="s5">'%s#varname#_Dims[%d]=%s,' </span><span class="s3">% (</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'setdims'</span><span class="s3">], </span><span class="s1">i</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'setdims'</span><span class="s3">]:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'setdims'</span><span class="s3">] = </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'setdims'</span><span class="s3">][:-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">], </span><span class="s1">i </span><span class="s3">= </span><span class="s5">''</span><span class="s3">, -</span><span class="s6">1</span>
        <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'dimension'</span><span class="s3">]:</span>
            <span class="s1">i </span><span class="s3">= </span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span>
            <span class="s2">if </span><span class="s1">d </span><span class="s2">not in </span><span class="s3">[</span><span class="s5">'*'</span><span class="s3">, </span><span class="s5">':'</span><span class="s3">, </span><span class="s5">'(*)'</span><span class="s3">, </span><span class="s5">'(:)'</span><span class="s3">]:</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">] = </span><span class="s5">'%s#varname#_Dims[%d]=%s,' </span><span class="s3">% (</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">], </span><span class="s1">i</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">isintent_in</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
                <span class="s1">outmess</span><span class="s3">(</span><span class="s5">'getarrdims:warning: assumed shape array, using 0 instead of %r</span><span class="s2">\n</span><span class="s5">'</span>
                        <span class="s3">% (</span><span class="s1">d</span><span class="s3">))</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">] = </span><span class="s5">'%s#varname#_Dims[%d]=%s,' </span><span class="s3">% (</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">], </span><span class="s1">i</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">verbose</span><span class="s3">:</span>
                <span class="s1">errmess</span><span class="s3">(</span>
                    <span class="s5">'getarrdims: If in call-back function: array argument %s must have bounded dimensions: got %s</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">d</span><span class="s3">)))</span>
        <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">]:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">] = </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbsetdims'</span><span class="s3">][:-</span><span class="s6">1</span><span class="s3">]</span>
<span class="s4">#         if not isintent_c(var):</span>
<span class="s4">#             var['dimension'].reverse()</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s2">def </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">global </span><span class="s1">lcb_map</span>
    <span class="s2">if </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'result' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">:</span>
            <span class="s1">af </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'result'</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">af </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">af </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">]:</span>
            <span class="s2">return </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">af</span><span class="s3">, </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">af</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'getctype: function %s has no return value?!</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% </span><span class="s1">af</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s5">''</span><span class="s3">, </span><span class="s5">''</span>
    <span class="s1">sig</span><span class="s3">, </span><span class="s1">sigout </span><span class="s3">= </span><span class="s1">a</span><span class="s3">, </span><span class="s1">a</span>
    <span class="s1">opt </span><span class="s3">= </span><span class="s5">''</span>
    <span class="s2">if </span><span class="s1">isintent_in</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">opt </span><span class="s3">= </span><span class="s5">'input'</span>
    <span class="s2">elif </span><span class="s1">isintent_inout</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">opt </span><span class="s3">= </span><span class="s5">'in/output'</span>
    <span class="s1">out_a </span><span class="s3">= </span><span class="s1">a</span>
    <span class="s2">if </span><span class="s1">isintent_out</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'intent'</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">k</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">] == </span><span class="s5">'out='</span><span class="s3">:</span>
                <span class="s1">out_a </span><span class="s3">= </span><span class="s1">k</span><span class="s3">[</span><span class="s6">4</span><span class="s3">:]</span>
                <span class="s2">break</span>
    <span class="s1">init </span><span class="s3">= </span><span class="s5">''</span>
    <span class="s1">ctype </span><span class="s3">= </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">hasinitvalue</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit </span><span class="s3">= </span><span class="s1">getinit</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
        <span class="s1">init </span><span class="s3">= </span><span class="s5">', optional</span><span class="s2">\\</span><span class="s5">n    Default: %s' </span><span class="s3">% </span><span class="s1">showinit</span>
    <span class="s2">if </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isintent_inout</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : %s rank-0 array(%s,</span><span class="s2">\'</span><span class="s5">%s</span><span class="s2">\'</span><span class="s5">)%s' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">],</span>
                                                         <span class="s1">c2pycode_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">], </span><span class="s1">init</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : %s %s%s' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">], </span><span class="s1">init</span><span class="s3">)</span>
        <span class="s1">sigout </span><span class="s3">= </span><span class="s5">'%s : %s' </span><span class="s3">% (</span><span class="s1">out_a</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">])</span>
    <span class="s2">elif </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isintent_inout</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : %s rank-0 array(string(len=%s),</span><span class="s2">\'</span><span class="s5">c</span><span class="s2">\'</span><span class="s5">)%s' </span><span class="s3">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">), </span><span class="s1">init</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : %s string(len=%s)%s' </span><span class="s3">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">), </span><span class="s1">init</span><span class="s3">)</span>
        <span class="s1">sigout </span><span class="s3">= </span><span class="s5">'%s : string(len=%s)' </span><span class="s3">% (</span><span class="s1">out_a</span><span class="s3">, </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'dimension'</span><span class="s3">]</span>
        <span class="s1">rank </span><span class="s3">= </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : %s rank-%s array(</span><span class="s2">\'</span><span class="s5">%s</span><span class="s2">\'</span><span class="s5">) with bounds (%s)%s' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">opt</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">,</span>
                                                                    <span class="s1">c2pycode_map</span><span class="s3">[</span>
                                                                        <span class="s1">ctype</span><span class="s3">],</span>
                                                                    <span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">init</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s3">== </span><span class="s1">out_a</span><span class="s3">:</span>
            <span class="s1">sigout </span><span class="s3">= </span><span class="s5">'%s : rank-%s array(</span><span class="s2">\'</span><span class="s5">%s</span><span class="s2">\'</span><span class="s5">) with bounds (%s)'</span><span class="s1">\</span>
                <span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">, </span><span class="s1">c2pycode_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">], </span><span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">sigout </span><span class="s3">= </span><span class="s5">'%s : rank-%s array(</span><span class="s2">\'</span><span class="s5">%s</span><span class="s2">\'</span><span class="s5">) with bounds (%s) and %s storage'</span><span class="s1">\</span>
                <span class="s3">% (</span><span class="s1">out_a</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">, </span><span class="s1">c2pycode_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">], </span><span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">a</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ua </span><span class="s3">= </span><span class="s5">''</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">lcb_map </span><span class="s2">and </span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">] </span><span class="s2">in </span><span class="s1">lcb2_map </span><span class="s2">and </span><span class="s5">'argname' </span><span class="s2">in </span><span class="s1">lcb2_map</span><span class="s3">[</span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]]:</span>
            <span class="s1">ua </span><span class="s3">= </span><span class="s1">lcb2_map</span><span class="s3">[</span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]][</span><span class="s5">'argname'</span><span class="s3">]</span>
            <span class="s2">if not </span><span class="s1">ua </span><span class="s3">== </span><span class="s1">a</span><span class="s3">:</span>
                <span class="s1">ua </span><span class="s3">= </span><span class="s5">' =&gt; %s' </span><span class="s3">% </span><span class="s1">ua</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">ua </span><span class="s3">= </span><span class="s5">''</span>
        <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : call-back function%s' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">ua</span><span class="s3">)</span>
        <span class="s1">sigout </span><span class="s3">= </span><span class="s1">sig</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">errmess</span><span class="s3">(</span>
            <span class="s5">'getpydocsign: Could not resolve docsignature for &quot;%s&quot;.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% </span><span class="s1">a</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">sig</span><span class="s3">, </span><span class="s1">sigout</span>


<span class="s2">def </span><span class="s1">getarrdocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">):</span>
    <span class="s1">ctype </span><span class="s3">= </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s2">not </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)):</span>
        <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : rank-0 array(string(len=%s),</span><span class="s2">\'</span><span class="s5">c</span><span class="s2">\'</span><span class="s5">)' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">,</span>
                                                           <span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : rank-0 array(%s,</span><span class="s2">\'</span><span class="s5">%s</span><span class="s2">\'</span><span class="s5">)' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">],</span>
                                                <span class="s1">c2pycode_map</span><span class="s3">[</span><span class="s1">ctype</span><span class="s3">],)</span>
    <span class="s2">elif </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'dimension'</span><span class="s3">]</span>
        <span class="s1">rank </span><span class="s3">= </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">sig </span><span class="s3">= </span><span class="s5">'%s : rank-%s array(</span><span class="s2">\'</span><span class="s5">%s</span><span class="s2">\'</span><span class="s5">) with bounds (%s)' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">rank</span><span class="s3">,</span>
                                                               <span class="s1">c2pycode_map</span><span class="s3">[</span>
                                                                   <span class="s1">ctype</span><span class="s3">],</span>
                                                               <span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">sig</span>


<span class="s2">def </span><span class="s1">getinit</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit </span><span class="s3">= </span><span class="s5">'&quot;&quot;'</span><span class="s3">, </span><span class="s5">&quot;''&quot;</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit </span><span class="s3">= </span><span class="s5">''</span><span class="s3">, </span><span class="s5">''</span>
    <span class="s2">if </span><span class="s1">hasinitvalue</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">init </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'='</span><span class="s3">]</span>
        <span class="s1">showinit </span><span class="s3">= </span><span class="s1">init</span>
        <span class="s2">if </span><span class="s1">iscomplex</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">or </span><span class="s1">iscomplexarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">ret </span><span class="s3">= {}</span>

            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">&quot;=&quot;</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s5">',' </span><span class="s2">in </span><span class="s1">v</span><span class="s3">:</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.r'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.i'</span><span class="s3">] = </span><span class="s1">markoutercomma</span><span class="s3">(</span>
                        <span class="s1">v</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">]).</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'@,@'</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">v </span><span class="s3">= </span><span class="s1">eval</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, {}, {})</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.r'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.i'</span><span class="s3">] = </span><span class="s1">str</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">real</span><span class="s3">), </span><span class="s1">str</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                    <span class="s5">'getinit: expected complex number `(r,i)</span><span class="s2">\' </span><span class="s5">but got `%s</span><span class="s2">\' </span><span class="s5">as initial value of %r.' </span><span class="s3">% (</span><span class="s1">init</span><span class="s3">, </span><span class="s1">a</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
                <span class="s1">init </span><span class="s3">= </span><span class="s5">'(capi_c.r=%s,capi_c.i=%s,capi_c)' </span><span class="s3">% (</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.r'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.i'</span><span class="s3">])</span>
        <span class="s2">elif </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">init</span><span class="s3">:</span>
                <span class="s1">init</span><span class="s3">, </span><span class="s1">showinit </span><span class="s3">= </span><span class="s5">'&quot;&quot;'</span><span class="s3">, </span><span class="s5">&quot;''&quot;</span>
            <span class="s2">if </span><span class="s1">init</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;'&quot;</span><span class="s3">:</span>
                <span class="s1">init </span><span class="s3">= </span><span class="s5">'&quot;%s&quot;' </span><span class="s3">% (</span><span class="s1">init</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'&quot;'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\\</span><span class="s5">&quot;'</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">init</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">'&quot;'</span><span class="s3">:</span>
                <span class="s1">showinit </span><span class="s3">= </span><span class="s5">&quot;'%s'&quot; </span><span class="s3">% (</span><span class="s1">init</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">init</span><span class="s3">, </span><span class="s1">showinit</span>


<span class="s2">def </span><span class="s1">get_elsize</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">or </span><span class="s1">isstringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">elsize </span><span class="s3">= </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
        <span class="s4"># override with user-specified length when available:</span>
        <span class="s1">elsize </span><span class="s3">= </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'charselector'</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'f2py_len'</span><span class="s3">, </span><span class="s1">elsize</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">elsize</span>
    <span class="s2">if </span><span class="s1">ischaracter</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">or </span><span class="s1">ischaracterarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">'1'</span>
    <span class="s4"># for numerical types, PyArray_New* functions ignore specified</span>
    <span class="s4"># elsize, so we just return 1 and let elsize be determined at</span>
    <span class="s4"># runtime, see fortranobject.c</span>
    <span class="s2">return </span><span class="s5">'1'</span>


<span class="s2">def </span><span class="s1">sign2map</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    varname,ctype,atype 
    init,init.r,init.i,pytype 
    vardebuginfo,vardebugshowvalue,varshowvalue 
    varrformat 
 
    intent 
    &quot;&quot;&quot;</span>
    <span class="s1">out_a </span><span class="s3">= </span><span class="s1">a</span>
    <span class="s2">if </span><span class="s1">isintent_out</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'intent'</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">k</span><span class="s3">[:</span><span class="s6">4</span><span class="s3">] == </span><span class="s5">'out='</span><span class="s3">:</span>
                <span class="s1">out_a </span><span class="s3">= </span><span class="s1">k</span><span class="s3">[</span><span class="s6">4</span><span class="s3">:]</span>
                <span class="s2">break</span>
    <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'varname'</span><span class="s3">: </span><span class="s1">a</span><span class="s3">, </span><span class="s5">'outvarname'</span><span class="s3">: </span><span class="s1">out_a</span><span class="s3">, </span><span class="s5">'ctype'</span><span class="s3">: </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)}</span>
    <span class="s1">intent_flags </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">f</span><span class="s3">, </span><span class="s1">s </span><span class="s2">in </span><span class="s1">isintent_dict</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">f</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">intent_flags</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">'F2PY_%s' </span><span class="s3">% </span><span class="s1">s</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">intent_flags</span><span class="s3">:</span>
        <span class="s4"># TODO: Evaluate intent_flags here.</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'intent'</span><span class="s3">] = </span><span class="s5">'|'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">intent_flags</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'intent'</span><span class="s3">] = </span><span class="s5">'F2PY_INTENT_IN'</span>
    <span class="s2">if </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'varrformat'</span><span class="s3">] = </span><span class="s5">'N'</span>
    <span class="s2">elif </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">c2buildvalue_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'varrformat'</span><span class="s3">] = </span><span class="s1">c2buildvalue_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'varrformat'</span><span class="s3">] = </span><span class="s5">'O'</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'init'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'showinit'</span><span class="s3">] = </span><span class="s1">getinit</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasinitvalue</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">iscomplex</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.r'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'init.i'</span><span class="s3">] = </span><span class="s1">markoutercomma</span><span class="s3">(</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'init'</span><span class="s3">][</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">]).</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'@,@'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbnamekey'</span><span class="s3">] = </span><span class="s1">a</span>
        <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">lcb_map</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbname'</span><span class="s3">] = </span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'maxnofargs'</span><span class="s3">] = </span><span class="s1">lcb2_map</span><span class="s3">[</span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]][</span><span class="s5">'maxnofargs'</span><span class="s3">]</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'nofoptargs'</span><span class="s3">] = </span><span class="s1">lcb2_map</span><span class="s3">[</span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]][</span><span class="s5">'nofoptargs'</span><span class="s3">]</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbdocstr'</span><span class="s3">] = </span><span class="s1">lcb2_map</span><span class="s3">[</span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]][</span><span class="s5">'docstr'</span><span class="s3">]</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cblatexdocstr'</span><span class="s3">] = </span><span class="s1">lcb2_map</span><span class="s3">[</span><span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">a</span><span class="s3">]][</span><span class="s5">'latexdocstr'</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbname'</span><span class="s3">] = </span><span class="s1">a</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'sign2map: Confused: external %s is not in lcb_map%s.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">list</span><span class="s3">(</span><span class="s1">lcb_map</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())))</span>
    <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'length'</span><span class="s3">] = </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret </span><span class="s3">= </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">getarrdims</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">))</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s1">copy</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">var</span><span class="s3">[</span><span class="s5">'dimension'</span><span class="s3">])</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">c2capi_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'atype'</span><span class="s3">] = </span><span class="s1">c2capi_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'elsize'</span><span class="s3">] = </span><span class="s1">get_elsize</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
    <span class="s4"># Debug info</span>
    <span class="s2">if </span><span class="s1">debugcapi</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">il </span><span class="s3">= [</span><span class="s1">isintent_in</span><span class="s3">, </span><span class="s5">'input'</span><span class="s3">, </span><span class="s1">isintent_out</span><span class="s3">, </span><span class="s5">'output'</span><span class="s3">,</span>
              <span class="s1">isintent_inout</span><span class="s3">, </span><span class="s5">'inoutput'</span><span class="s3">, </span><span class="s1">isrequired</span><span class="s3">, </span><span class="s5">'required'</span><span class="s3">,</span>
              <span class="s1">isoptional</span><span class="s3">, </span><span class="s5">'optional'</span><span class="s3">, </span><span class="s1">isintent_hide</span><span class="s3">, </span><span class="s5">'hidden'</span><span class="s3">,</span>
              <span class="s1">iscomplex</span><span class="s3">, </span><span class="s5">'complex scalar'</span><span class="s3">,</span>
              <span class="s1">l_and</span><span class="s3">(</span><span class="s1">isscalar</span><span class="s3">, </span><span class="s1">l_not</span><span class="s3">(</span><span class="s1">iscomplex</span><span class="s3">)), </span><span class="s5">'scalar'</span><span class="s3">,</span>
              <span class="s1">isstring</span><span class="s3">, </span><span class="s5">'string'</span><span class="s3">, </span><span class="s1">isarray</span><span class="s3">, </span><span class="s5">'array'</span><span class="s3">,</span>
              <span class="s1">iscomplexarray</span><span class="s3">, </span><span class="s5">'complex array'</span><span class="s3">, </span><span class="s1">isstringarray</span><span class="s3">, </span><span class="s5">'string array'</span><span class="s3">,</span>
              <span class="s1">iscomplexfunction</span><span class="s3">, </span><span class="s5">'complex function'</span><span class="s3">,</span>
              <span class="s1">l_and</span><span class="s3">(</span><span class="s1">isfunction</span><span class="s3">, </span><span class="s1">l_not</span><span class="s3">(</span><span class="s1">iscomplexfunction</span><span class="s3">)), </span><span class="s5">'function'</span><span class="s3">,</span>
              <span class="s1">isexternal</span><span class="s3">, </span><span class="s5">'callback'</span><span class="s3">,</span>
              <span class="s1">isintent_callback</span><span class="s3">, </span><span class="s5">'callback'</span><span class="s3">,</span>
              <span class="s1">isintent_aux</span><span class="s3">, </span><span class="s5">'auxiliary'</span><span class="s3">,</span>
              <span class="s3">]</span>
        <span class="s1">rl </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">il</span><span class="s3">), </span><span class="s6">2</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">il</span><span class="s3">[</span><span class="s1">i</span><span class="s3">](</span><span class="s1">var</span><span class="s3">):</span>
                <span class="s1">rl</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">il</span><span class="s3">[</span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">rl</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">'slen(%s)=%s' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'length'</span><span class="s3">]))</span>
        <span class="s2">if </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">ddim </span><span class="s3">= </span><span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
                <span class="s1">map</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s5">'%s|%s' </span><span class="s3">% (</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">), </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'dimension'</span><span class="s3">], </span><span class="s1">dim</span><span class="s3">))</span>
            <span class="s1">rl</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">'dims(%s)' </span><span class="s3">% </span><span class="s1">ddim</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'vardebuginfo'</span><span class="s3">] = </span><span class="s5">'debug-capi:%s=&gt;%s:%s' </span><span class="s3">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'cbname'</span><span class="s3">], </span><span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">rl</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'vardebuginfo'</span><span class="s3">] = </span><span class="s5">'debug-capi:%s %s=%s:%s' </span><span class="s3">% (</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">], </span><span class="s1">a</span><span class="s3">, </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'showinit'</span><span class="s3">], </span><span class="s5">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">rl</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">cformat_map</span><span class="s3">:</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'vardebugshowvalue'</span><span class="s3">] = </span><span class="s5">'debug-capi:%s=%s' </span><span class="s3">% (</span>
                    <span class="s1">a</span><span class="s3">, </span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
        <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'vardebugshowvalue'</span><span class="s3">] = </span><span class="s5">'debug-capi:slen(%s)=%%d %s=</span><span class="s2">\\</span><span class="s5">&quot;%%s</span><span class="s2">\\</span><span class="s5">&quot;' </span><span class="s3">% (</span>
                <span class="s1">a</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'vardebugshowvalue'</span><span class="s3">] = </span><span class="s5">'debug-capi:%s=%%p' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">cformat_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'varshowvalue'</span><span class="s3">] = </span><span class="s5">'#name#:%s=%s' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'showvalueformat'</span><span class="s3">] = </span><span class="s5">'%s' </span><span class="s3">% (</span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
    <span class="s2">if </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'varshowvalue'</span><span class="s3">] = </span><span class="s5">'#name#:slen(%s)=%%d %s=</span><span class="s2">\\</span><span class="s5">&quot;%%s</span><span class="s2">\\</span><span class="s5">&quot;' </span><span class="s3">% (</span><span class="s1">a</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsign'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsignout'</span><span class="s3">] = </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s2">def </span><span class="s1">routsign2map</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    name,NAME,begintitle,endtitle 
    rname,ctype,rformat 
    routdebugshowvalue 
    &quot;&quot;&quot;</span>
    <span class="s2">global </span><span class="s1">lcb_map</span>
    <span class="s1">name </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
    <span class="s1">fname </span><span class="s3">= </span><span class="s1">getfortranname</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">)</span>
    <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'name'</span><span class="s3">: </span><span class="s1">name</span><span class="s3">,</span>
           <span class="s5">'texname'</span><span class="s3">: </span><span class="s1">name</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'_'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\\</span><span class="s5">_'</span><span class="s3">),</span>
           <span class="s5">'name_lower'</span><span class="s3">: </span><span class="s1">name</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(),</span>
           <span class="s5">'NAME'</span><span class="s3">: </span><span class="s1">name</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">(),</span>
           <span class="s5">'begintitle'</span><span class="s3">: </span><span class="s1">gentitle</span><span class="s3">(</span><span class="s1">name</span><span class="s3">),</span>
           <span class="s5">'endtitle'</span><span class="s3">: </span><span class="s1">gentitle</span><span class="s3">(</span><span class="s5">'end of %s' </span><span class="s3">% </span><span class="s1">name</span><span class="s3">),</span>
           <span class="s5">'fortranname'</span><span class="s3">: </span><span class="s1">fname</span><span class="s3">,</span>
           <span class="s5">'FORTRANNAME'</span><span class="s3">: </span><span class="s1">fname</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">(),</span>
           <span class="s5">'callstatement'</span><span class="s3">: </span><span class="s1">getcallstatement</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span><span class="s3">,</span>
           <span class="s5">'usercode'</span><span class="s3">: </span><span class="s1">getusercode</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span><span class="s3">,</span>
           <span class="s5">'usercode1'</span><span class="s3">: </span><span class="s1">getusercode1</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span><span class="s3">,</span>
           <span class="s3">}</span>
    <span class="s2">if </span><span class="s5">'_' </span><span class="s2">in </span><span class="s1">fname</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'F_FUNC'</span><span class="s3">] = </span><span class="s5">'F_FUNC_US'</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'F_FUNC'</span><span class="s3">] = </span><span class="s5">'F_FUNC'</span>
    <span class="s2">if </span><span class="s5">'_' </span><span class="s2">in </span><span class="s1">name</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'F_WRAPPEDFUNC'</span><span class="s3">] = </span><span class="s5">'F_WRAPPEDFUNC_US'</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'F_WRAPPEDFUNC'</span><span class="s3">] = </span><span class="s5">'F_WRAPPEDFUNC'</span>
    <span class="s1">lcb_map </span><span class="s3">= {}</span>
    <span class="s2">if </span><span class="s5">'use' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">u </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'use'</span><span class="s3">].</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">u </span><span class="s2">in </span><span class="s1">cb_rules</span><span class="s3">.</span><span class="s1">cb_map</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">un </span><span class="s2">in </span><span class="s1">cb_rules</span><span class="s3">.</span><span class="s1">cb_map</span><span class="s3">[</span><span class="s1">u</span><span class="s3">]:</span>
                    <span class="s1">ln </span><span class="s3">= </span><span class="s1">un</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
                    <span class="s2">if </span><span class="s5">'map' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'use'</span><span class="s3">][</span><span class="s1">u</span><span class="s3">]:</span>
                        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'use'</span><span class="s3">][</span><span class="s1">u</span><span class="s3">][</span><span class="s5">'map'</span><span class="s3">].</span><span class="s1">keys</span><span class="s3">():</span>
                            <span class="s2">if </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'use'</span><span class="s3">][</span><span class="s1">u</span><span class="s3">][</span><span class="s5">'map'</span><span class="s3">][</span><span class="s1">k</span><span class="s3">] == </span><span class="s1">un</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]:</span>
                                <span class="s1">ln </span><span class="s3">= </span><span class="s1">k</span>
                                <span class="s2">break</span>
                    <span class="s1">lcb_map</span><span class="s3">[</span><span class="s1">ln</span><span class="s3">] = </span><span class="s1">un</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
    <span class="s2">elif </span><span class="s5">'externals' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'externals'</span><span class="s3">]:</span>
        <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'routsign2map: Confused: function %s has externals %s but no &quot;use&quot; statement.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">], </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'externals'</span><span class="s3">])))</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'callprotoargument'</span><span class="s3">] = </span><span class="s1">getcallprotoargument</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s1">lcb_map</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span>
    <span class="s2">if </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'result'</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rname'</span><span class="s3">] = </span><span class="s1">a</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsign'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsignout'</span><span class="s3">] = </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">rout</span><span class="s3">)</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] = </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">hasresultnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'resultnote'</span><span class="s3">] = </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">][</span><span class="s5">'note'</span><span class="s3">]</span>
            <span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">][</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">c2buildvalue_map</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rformat'</span><span class="s3">] = </span><span class="s1">c2buildvalue_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rformat'</span><span class="s3">] = </span><span class="s5">'O'</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'routsign2map: no c2buildvalue key for type %s</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">%</span>
                    <span class="s3">(</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">])))</span>
        <span class="s2">if </span><span class="s1">debugcapi</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">cformat_map</span><span class="s3">:</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'routdebugshowvalue'</span><span class="s3">] = </span><span class="s5">'debug-capi:%s=%s' </span><span class="s3">% (</span>
                    <span class="s1">a</span><span class="s3">, </span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
            <span class="s2">if </span><span class="s1">isstringfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'routdebugshowvalue'</span><span class="s3">] = </span><span class="s5">'debug-capi:slen(%s)=%%d %s=</span><span class="s2">\\</span><span class="s5">&quot;%%s</span><span class="s2">\\</span><span class="s5">&quot;' </span><span class="s3">% (</span>
                    <span class="s1">a</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isstringfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rlength'</span><span class="s3">] = </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'rlength'</span><span class="s3">] == </span><span class="s5">'-1'</span><span class="s3">:</span>
                <span class="s1">errmess</span><span class="s3">(</span><span class="s5">'routsign2map: expected explicit specification of the length of the string returned by the fortran function %s; taking 10.</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">% (</span>
                    <span class="s1">repr</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">])))</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rlength'</span><span class="s3">] = </span><span class="s5">'10'</span>
    <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
        <span class="s1">rout</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s2">def </span><span class="s1">modsign2map</span><span class="s3">(</span><span class="s1">m</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    modulename 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">ismodule</span><span class="s3">(</span><span class="s1">m</span><span class="s3">):</span>
        <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'f90modulename'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">],</span>
               <span class="s5">'F90MODULENAME'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">].</span><span class="s1">upper</span><span class="s3">(),</span>
               <span class="s5">'texf90modulename'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'_'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\\</span><span class="s5">_'</span><span class="s3">)}</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'modulename'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">],</span>
               <span class="s5">'MODULENAME'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">].</span><span class="s1">upper</span><span class="s3">(),</span>
               <span class="s5">'texmodulename'</span><span class="s3">: </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'_'</span><span class="s3">, </span><span class="s5">'</span><span class="s2">\\</span><span class="s5">_'</span><span class="s3">)}</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'restdoc'</span><span class="s3">] = </span><span class="s1">getrestdoc</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) </span><span class="s2">or </span><span class="s3">[]</span>
    <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">m</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'usercode'</span><span class="s3">] = </span><span class="s1">getusercode</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'usercode1'</span><span class="s3">] = </span><span class="s1">getusercode1</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span>
    <span class="s2">if </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'body'</span><span class="s3">]:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'interface_usercode'</span><span class="s3">] = </span><span class="s1">getusercode</span><span class="s3">(</span><span class="s1">m</span><span class="s3">[</span><span class="s5">'body'</span><span class="s3">][</span><span class="s6">0</span><span class="s3">]) </span><span class="s2">or </span><span class="s5">''</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'interface_usercode'</span><span class="s3">] = </span><span class="s5">''</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'pymethoddef'</span><span class="s3">] = </span><span class="s1">getpymethoddef</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) </span><span class="s2">or </span><span class="s5">''</span>
    <span class="s2">if </span><span class="s5">'gil_used' </span><span class="s2">in </span><span class="s1">m</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'gil_used'</span><span class="s3">] = </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'gil_used'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s5">'coutput' </span><span class="s2">in </span><span class="s1">m</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'coutput'</span><span class="s3">] = </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'coutput'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s5">'f2py_wrapper_output' </span><span class="s2">in </span><span class="s1">m</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'f2py_wrapper_output'</span><span class="s3">] = </span><span class="s1">m</span><span class="s3">[</span><span class="s5">'f2py_wrapper_output'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s2">def </span><span class="s1">cb_sign2map</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'varname'</span><span class="s3">: </span><span class="s1">a</span><span class="s3">}</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'varname_i'</span><span class="s3">] = </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'varname'</span><span class="s3">]</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] = </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">c2capi_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'atype'</span><span class="s3">] = </span><span class="s1">c2capi_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'elsize'</span><span class="s3">] = </span><span class="s1">get_elsize</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">cformat_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'showvalueformat'</span><span class="s3">] = </span><span class="s5">'%s' </span><span class="s3">% (</span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
    <span class="s2">if </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret </span><span class="s3">= </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">getarrdims</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">))</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsign'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsignout'</span><span class="s3">] = </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
        <span class="s1">var</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s2">def </span><span class="s1">cb_routsign2map</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s1">um</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    name,begintitle,endtitle,argname 
    ctype,rctype,maxnofargs,nofoptargs,returncptr 
    &quot;&quot;&quot;</span>
    <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'name'</span><span class="s3">: </span><span class="s5">'cb_%s_in_%s' </span><span class="s3">% (</span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">], </span><span class="s1">um</span><span class="s3">),</span>
           <span class="s5">'returncptr'</span><span class="s3">: </span><span class="s5">''</span><span class="s3">}</span>
    <span class="s2">if </span><span class="s1">isintent_callback</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'_' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]:</span>
            <span class="s1">F_FUNC </span><span class="s3">= </span><span class="s5">'F_FUNC_US'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">F_FUNC </span><span class="s3">= </span><span class="s5">'F_FUNC'</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'callbackname'</span><span class="s3">] = </span><span class="s5">'%s(%s,%s)' </span><span class="s1">\</span>
                              <span class="s3">% (</span><span class="s1">F_FUNC</span><span class="s3">,</span>
                                 <span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">].</span><span class="s1">lower</span><span class="s3">(),</span>
                                 <span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">].</span><span class="s1">upper</span><span class="s3">(),</span>
                                 <span class="s3">)</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'static'</span><span class="s3">] = </span><span class="s5">'extern'</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'callbackname'</span><span class="s3">] = </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'static'</span><span class="s3">] = </span><span class="s5">'static'</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'argname'</span><span class="s3">] = </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'begintitle'</span><span class="s3">] = </span><span class="s1">gentitle</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">])</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'endtitle'</span><span class="s3">] = </span><span class="s1">gentitle</span><span class="s3">(</span><span class="s5">'end of %s' </span><span class="s3">% </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">])</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] = </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">)</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rctype'</span><span class="s3">] = </span><span class="s5">'void'</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] == </span><span class="s5">'string'</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rctype'</span><span class="s3">] = </span><span class="s5">'void'</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rctype'</span><span class="s3">] = </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'rctype'</span><span class="s3">] != </span><span class="s5">'void'</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">iscomplexfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'returncptr'</span><span class="s3">] = </span><span class="s5">&quot;&quot;&quot; 
#ifdef F2PY_CB_RETURNCOMPLEX 
return_value= 
#endif 
&quot;&quot;&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'returncptr'</span><span class="s3">] = </span><span class="s5">'return_value='</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">cformat_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'showvalueformat'</span><span class="s3">] = </span><span class="s5">'%s' </span><span class="s3">% (</span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
    <span class="s2">if </span><span class="s1">isstringfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'strlength'</span><span class="s3">] = </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s5">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'result'</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'name'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">]):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">][</span><span class="s5">'note'</span><span class="s3">]</span>
            <span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">][</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rname'</span><span class="s3">] = </span><span class="s1">a</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsign'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsignout'</span><span class="s3">] = </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">rout</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">iscomplexfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rctype'</span><span class="s3">] = </span><span class="s5">&quot;&quot;&quot; 
#ifdef F2PY_CB_RETURNCOMPLEX 
#ctype# 
#else 
void 
#endif 
&quot;&quot;&quot;</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
            <span class="s1">rout</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
    <span class="s1">nofargs </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s1">nofoptargs </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s2">if </span><span class="s5">'args' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s5">'vars' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'args'</span><span class="s3">]:</span>
            <span class="s1">var </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">l_or</span><span class="s3">(</span><span class="s1">isintent_in</span><span class="s3">, </span><span class="s1">isintent_inout</span><span class="s3">)(</span><span class="s1">var</span><span class="s3">):</span>
                <span class="s1">nofargs </span><span class="s3">= </span><span class="s1">nofargs </span><span class="s3">+ </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">isoptional</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
                    <span class="s1">nofoptargs </span><span class="s3">= </span><span class="s1">nofoptargs </span><span class="s3">+ </span><span class="s6">1</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'maxnofargs'</span><span class="s3">] = </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">nofargs</span><span class="s3">)</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'nofoptargs'</span><span class="s3">] = </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">nofoptargs</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">and </span><span class="s5">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'routnote'</span><span class="s3">] = </span><span class="s1">rout</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
        <span class="s1">rout</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">ret</span>


<span class="s2">def </span><span class="s1">common_sign2map</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">):  </span><span class="s4"># obsolute</span>
    <span class="s1">ret </span><span class="s3">= {</span><span class="s5">'varname'</span><span class="s3">: </span><span class="s1">a</span><span class="s3">, </span><span class="s5">'ctype'</span><span class="s3">: </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)}</span>
    <span class="s2">if </span><span class="s1">isstringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] = </span><span class="s5">'char'</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">c2capi_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'atype'</span><span class="s3">] = </span><span class="s1">c2capi_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]]</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'elsize'</span><span class="s3">] = </span><span class="s1">get_elsize</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">] </span><span class="s2">in </span><span class="s1">cformat_map</span><span class="s3">:</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'showvalueformat'</span><span class="s3">] = </span><span class="s5">'%s' </span><span class="s3">% (</span><span class="s1">cformat_map</span><span class="s3">[</span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'ctype'</span><span class="s3">]])</span>
    <span class="s2">if </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret </span><span class="s3">= </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">getarrdims</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'size'</span><span class="s3">] = </span><span class="s1">getstrlength</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'rank'</span><span class="s3">] = </span><span class="s5">'1'</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsign'</span><span class="s3">], </span><span class="s1">ret</span><span class="s3">[</span><span class="s5">'pydocsignout'</span><span class="s3">] = </span><span class="s1">getpydocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">ret</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = </span><span class="s1">var</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">]</span>
        <span class="s1">var</span><span class="s3">[</span><span class="s5">'note'</span><span class="s3">] = [</span><span class="s5">'See elsewhere.'</span><span class="s3">]</span>
    <span class="s4"># for strings this returns 0-rank but actually is 1-rank</span>
    <span class="s1">ret</span><span class="s3">[</span><span class="s5">'arrdocstr'</span><span class="s3">] = </span><span class="s1">getarrdocsign</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">ret</span>
</pre>
</body>
</html>