<html>
<head>
<title>test_figure.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_figure.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">copy</span>
<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">pickle</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">from </span><span class="s1">threading </span><span class="s0">import </span><span class="s1">Timer</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">SimpleNamespace</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">gridspec</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">image_comparison</span><span class="s2">, </span><span class="s1">check_figures_equal</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">axes </span><span class="s0">import </span><span class="s1">Axes</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s1">KeyEvent</span><span class="s2">, </span><span class="s1">MouseEvent</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">import </span><span class="s1">Figure</span><span class="s2">, </span><span class="s1">FigureBase</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">layout_engine </span><span class="s0">import </span><span class="s2">(</span><span class="s1">ConstrainedLayoutEngine</span><span class="s2">,</span>
                                      <span class="s1">TightLayoutEngine</span><span class="s2">,</span>
                                      <span class="s1">PlaceHolderLayoutEngine</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">ticker </span><span class="s0">import </span><span class="s1">AutoMinorLocator</span><span class="s2">, </span><span class="s1">FixedFormatter</span><span class="s2">, </span><span class="s1">ScalarFormatter</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">dates </span><span class="s0">as </span><span class="s1">mdates</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'figure_align_labels'</span><span class="s2">], </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">],</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s4">0 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s3">'x86_64' </span><span class="s0">else </span><span class="s4">0.01</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_align_labels</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'tight'</span><span class="s2">)</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, :</span><span class="s4">2</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1e6</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'Ylabel0 0'</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1e4</span><span class="s2">, </span><span class="s4">100</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'YLabel1 %d' </span><span class="s2">% </span><span class="s1">i</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'XLabel1 %d' </span><span class="s2">% </span><span class="s1">i</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]:</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_label_position</span><span class="s2">(</span><span class="s3">&quot;top&quot;</span><span class="s2">)</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">tick_top</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">():</span>
                <span class="s1">tick</span><span class="s2">.</span><span class="s1">set_rotation</span><span class="s2">(</span><span class="s4">90</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_label_position</span><span class="s2">(</span><span class="s3">&quot;right&quot;</span><span class="s2">)</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">tick_right</span><span class="s2">()</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">f'XLabel2 </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">f'YLabel2 </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">i </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1e4</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_label_position</span><span class="s2">(</span><span class="s3">&quot;right&quot;</span><span class="s2">)</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">tick_right</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">():</span>
                <span class="s1">tick</span><span class="s2">.</span><span class="s1">set_rotation</span><span class="s2">(</span><span class="s4">90</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_labels</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'figure_align_titles_tight.png'</span><span class="s2">,</span>
                   <span class="s3">'figure_align_titles_constrained.png'</span><span class="s2">],</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s4">0 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s3">'x86_64' </span><span class="s0">else </span><span class="s4">0.022</span><span class="s2">,</span>
                  <span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_align_titles</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">layout </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'tight'</span><span class="s2">, </span><span class="s3">'constrained'</span><span class="s2">]:</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s1">layout</span><span class="s2">, </span><span class="s1">width_ratios</span><span class="s2">=[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">ax </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1e6</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">))</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Title0 left'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s3">'left'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Title0 center'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s3">'center'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Title0 right'</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s3">'right'</span><span class="s2">)</span>

        <span class="s1">ax </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1e4</span><span class="s2">, </span><span class="s4">100</span><span class="s2">))</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Title1'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Xlabel0'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_label_position</span><span class="s2">(</span><span class="s3">&quot;top&quot;</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">tick_top</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xticklabels</span><span class="s2">():</span>
            <span class="s1">tick</span><span class="s2">.</span><span class="s1">set_rotation</span><span class="s2">(</span><span class="s4">90</span><span class="s2">)</span>

        <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_titles</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_align_labels_stray_axes</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Boo'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Who'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)**</span><span class="s1">nn</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)**</span><span class="s1">nn</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_ylabels</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_xlabels</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">xn </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">yn </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">):</span>
        <span class="s1">yn</span><span class="s2">[</span><span class="s1">nn</span><span class="s2">] = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xn</span><span class="s2">[</span><span class="s1">nn</span><span class="s2">] = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">xn</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">], </span><span class="s1">xn</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yn</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">], </span><span class="s1">yn</span><span class="s2">[</span><span class="s4">1</span><span class="s2">::</span><span class="s4">2</span><span class="s2">])</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Boo'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'Who'</span><span class="s2">)</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_ylabels</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_xlabels</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">xn </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">yn </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">):</span>
        <span class="s1">yn</span><span class="s2">[</span><span class="s1">nn</span><span class="s2">] = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xn</span><span class="s2">[</span><span class="s1">nn</span><span class="s2">] = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">xn</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">], </span><span class="s1">xn</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yn</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">], </span><span class="s1">yn</span><span class="s2">[</span><span class="s4">1</span><span class="s2">::</span><span class="s4">2</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_figure_label</span><span class="s2">():</span>
    <span class="s5"># pyplot figure creation, selection, and closing with label/number/instance</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s3">'all'</span><span class="s2">)</span>
    <span class="s1">fig_today </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'today'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'tomorrow'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">get_fignums</span><span class="s2">() == [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">get_figlabels</span><span class="s2">() == [</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'today'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">, </span><span class="s3">'tomorrow'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">]</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s3">'tomorrow'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">get_fignums</span><span class="s2">() == [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">get_figlabels</span><span class="s2">() == [</span><span class="s3">''</span><span class="s2">, </span><span class="s3">'today'</span><span class="s2">]</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">fig_today</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">() == </span><span class="s1">fig_today</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">Figure</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_fignum_exists</span><span class="s2">():</span>
    <span class="s5"># pyplot figure creation, selection and closing with fignum_exists</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'one'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'three'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s3">'one'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s3">'three'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s3">'one'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s3">'one'</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_clf_keyword</span><span class="s2">():</span>
    <span class="s5"># test if existing figure is cleared with figure() and subplots()</span>
    <span class="s1">text1 </span><span class="s2">= </span><span class="s3">'A fancy plot'</span>
    <span class="s1">text2 </span><span class="s2">= </span><span class="s3">'Really fancy!'</span>

    <span class="s1">fig0 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">fig0</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s1">text1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">t</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">fig0</span><span class="s2">.</span><span class="s1">texts</span><span class="s2">] == [</span><span class="s1">text1</span><span class="s2">]</span>

    <span class="s1">fig1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">clear</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">fig1</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">text2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig0 </span><span class="s0">is </span><span class="s1">fig1</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">t</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">fig1</span><span class="s2">.</span><span class="s1">texts</span><span class="s2">] == [</span><span class="s1">text1</span><span class="s2">, </span><span class="s1">text2</span><span class="s2">]</span>

    <span class="s1">fig2</span><span class="s2">, </span><span class="s1">ax2 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">clear</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig0 </span><span class="s0">is </span><span class="s1">fig2</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">t</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">fig2</span><span class="s2">.</span><span class="s1">texts</span><span class="s2">] == []</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'figure_today'</span><span class="s2">],</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s4">0.015 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s3">'arm64' </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_figure</span><span class="s2">():</span>
    <span class="s5"># named figure support</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'today'</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_label</span><span class="s2">())</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s5"># plot red line in a different figure.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'tomorrow'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s5"># Return to the original; make sure the red line is not there.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s3">'today'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s3">'tomorrow'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'figure_legend'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_figure_legend</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'x'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'g'</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'y'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'y'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'k'</span><span class="s2">)</span>

    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'_y'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'z'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'b'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_gca</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s5"># test that gca() picks up Axes created via add_axes()</span>
    <span class="s1">ax0 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">() </span><span class="s0">is </span><span class="s1">ax0</span>

    <span class="s5"># test that gca() picks up Axes created via add_subplot()</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">() </span><span class="s0">is </span><span class="s1">ax1</span>

    <span class="s5"># add_axes on an existing Axes should not change stored order, but will</span>
    <span class="s5"># make it current.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">(</span><span class="s1">ax0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== [</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">() </span><span class="s0">is </span><span class="s1">ax0</span>

    <span class="s5"># sca() should not change stored order of Axes, which is order added.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">sca</span><span class="s2">(</span><span class="s1">ax0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== [</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">]</span>

    <span class="s5"># add_subplot on an existing Axes should not change stored order, but will</span>
    <span class="s5"># make it current.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">ax1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== [</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">() </span><span class="s0">is </span><span class="s1">ax1</span>


<span class="s0">def </span><span class="s1">test_add_subplot_subclass</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">axes_class</span><span class="s2">=</span><span class="s1">Axes</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">axes_class</span><span class="s2">=</span><span class="s1">Axes</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">&quot;3d&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">axes_class</span><span class="s2">=</span><span class="s1">Axes</span><span class="s2">, </span><span class="s1">polar</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">projection</span><span class="s2">=</span><span class="s3">&quot;3d&quot;</span><span class="s2">, </span><span class="s1">polar</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">projection</span><span class="s2">=</span><span class="s4">42</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_add_subplot_invalid</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">'Number of columns must be a positive integer'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">'Number of rows must be a positive integer'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'num must be an integer with '</span>
                                         <span class="s3">'1 &lt;= num &lt;= 4'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'num must be an integer with '</span>
                                         <span class="s3">'1 &lt;= num &lt;= 4'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'num must be an integer with '</span>
                                         <span class="s3">'1 &lt;= num &lt;= 4'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'must be a three-digit integer'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">42</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'must be a three-digit integer'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'takes 1 or 3 positional arguments '</span>
                                        <span class="s3">'but 2 were given'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'takes 1 or 3 positional arguments '</span>
                                        <span class="s3">'but 4 were given'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Number of rows must be a positive integer, &quot;</span>
                             <span class="s3">&quot;not '2'&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">'2'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">'Number of columns must be a positive integer, '</span>
                             <span class="s3">'not 2.0'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">'The Axes must have been created in the '</span>
                             <span class="s3">'present figure'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'figure_suptitle'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_suptitle</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'hello'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'title'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'g'</span><span class="s2">, </span><span class="s1">rotation</span><span class="s2">=</span><span class="s4">30</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_suptitle_fontproperties</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">fps </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">font_manager</span><span class="s2">.</span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s3">'large'</span><span class="s2">, </span><span class="s1">weight</span><span class="s2">=</span><span class="s3">'bold'</span><span class="s2">)</span>
    <span class="s1">txt </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'fontprops title'</span><span class="s2">, </span><span class="s1">fontproperties</span><span class="s2">=</span><span class="s1">fps</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">txt</span><span class="s2">.</span><span class="s1">get_fontsize</span><span class="s2">() == </span><span class="s1">fps</span><span class="s2">.</span><span class="s1">get_size_in_points</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">txt</span><span class="s2">.</span><span class="s1">get_weight</span><span class="s2">() == </span><span class="s1">fps</span><span class="s2">.</span><span class="s1">get_weight</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_suptitle_subfigures</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s1">sf1</span><span class="s2">, </span><span class="s1">sf2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">sf2</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'white'</span><span class="s2">)</span>
    <span class="s1">sf1</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">sf2</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">&quot;This is a visible suptitle.&quot;</span><span class="s2">)</span>

    <span class="s5"># verify the first subfigure facecolor is the default transparent</span>
    <span class="s0">assert </span><span class="s1">sf1</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">() == (</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
    <span class="s5"># verify the second subfigure facecolor is white</span>
    <span class="s0">assert </span><span class="s1">sf2</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">() == (</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_suptitle_supxlabel_supylabel</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_suptitle</span><span class="s2">() == </span><span class="s3">&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_supxlabel</span><span class="s2">() == </span><span class="s3">&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_supylabel</span><span class="s2">() == </span><span class="s3">&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'suptitle'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_suptitle</span><span class="s2">() == </span><span class="s3">'suptitle'</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">supxlabel</span><span class="s2">(</span><span class="s3">'supxlabel'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_supxlabel</span><span class="s2">() == </span><span class="s3">'supxlabel'</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">supylabel</span><span class="s2">(</span><span class="s3">'supylabel'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_supylabel</span><span class="s2">() == </span><span class="s3">'supylabel'</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'alpha_background'</span><span class="s2">],</span>
                  <span class="s5"># only test png and svg. The PDF output appears correct,</span>
                  <span class="s5"># but Ghostscript does not preserve the background color.</span>
                  <span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">],</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s3">'facecolor'</span><span class="s2">: (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">),</span>
                                 <span class="s3">'edgecolor'</span><span class="s2">: </span><span class="s3">'none'</span><span class="s2">})</span>
<span class="s0">def </span><span class="s1">test_alpha</span><span class="s2">():</span>
    <span class="s5"># We want an image which has a background color and an alpha of 0.4.</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s4">0.4</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">patches</span><span class="s2">.</span><span class="s1">CirclePolygon</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">], </span><span class="s1">radius</span><span class="s2">=</span><span class="s4">15</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.6</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s3">'red'</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_too_many_figures</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'figure.max_open_warning'</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_iterability_axes_argument</span><span class="s2">():</span>

    <span class="s5"># This is a regression test for matplotlib/matplotlib#3196. If one of the</span>
    <span class="s5"># arguments returned by _as_mpl_axes defines __getitem__ but is not</span>
    <span class="s5"># iterable, this would raise an exception. This is because we check</span>
    <span class="s5"># whether the arguments are iterable, and if so we try and convert them</span>
    <span class="s5"># to a tuple. However, the ``iterable`` function returns True if</span>
    <span class="s5"># __getitem__ is present, but some classes can define __getitem__ without</span>
    <span class="s5"># being iterable. The tuple conversion is now done in a try...except in</span>
    <span class="s5"># case it fails.</span>

    <span class="s0">class </span><span class="s1">MyAxes</span><span class="s2">(</span><span class="s1">Axes</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, </span><span class="s1">myclass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">Axes</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">class </span><span class="s1">MyClass</span><span class="s2">:</span>

        <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">item </span><span class="s2">!= </span><span class="s3">'a'</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;item should be a&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">_as_mpl_axes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">MyAxes</span><span class="s2">, {</span><span class="s3">'myclass'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">}</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s1">MyClass</span><span class="s2">())</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_fig_size</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s5"># check figwidth</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_figwidth</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_figwidth</span><span class="s2">() == </span><span class="s4">5</span>

    <span class="s5"># check figheight</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_figheight</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_figheight</span><span class="s2">() == </span><span class="s4">1</span>

    <span class="s5"># check using set_size_inches</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_figwidth</span><span class="s2">() == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_figheight</span><span class="s2">() == </span><span class="s4">4</span>

    <span class="s5"># check using tuple to first argument</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_figwidth</span><span class="s2">() == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_figheight</span><span class="s2">() == </span><span class="s4">3</span>


<span class="s0">def </span><span class="s1">test_axes_remove</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()[:-</span><span class="s4">1</span><span class="s2">]:</span>
        <span class="s0">assert </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">axs</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">) == </span><span class="s4">3</span>


<span class="s0">def </span><span class="s1">test_figaspect</span><span class="s2">():</span>
    <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figaspect</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) / </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">h </span><span class="s2">/ </span><span class="s1">w </span><span class="s2">== </span><span class="s4">2</span>
    <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figaspect</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">h </span><span class="s2">/ </span><span class="s1">w </span><span class="s2">== </span><span class="s4">2</span>
    <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figaspect</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">h </span><span class="s2">/ </span><span class="s1">w </span><span class="s2">== </span><span class="s4">0.5</span>
    <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figaspect</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">h </span><span class="s2">/ </span><span class="s1">w </span><span class="s2">== </span><span class="s4">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'which'</span><span class="s2">, [</span><span class="s3">'both'</span><span class="s2">, </span><span class="s3">'major'</span><span class="s2">, </span><span class="s3">'minor'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_autofmt_xdate</span><span class="s2">(</span><span class="s1">which</span><span class="s2">):</span>
    <span class="s1">date </span><span class="s2">= [</span><span class="s3">'3 Jan 2013'</span><span class="s2">, </span><span class="s3">'4 Jan 2013'</span><span class="s2">, </span><span class="s3">'5 Jan 2013'</span><span class="s2">, </span><span class="s3">'6 Jan 2013'</span><span class="s2">,</span>
            <span class="s3">'7 Jan 2013'</span><span class="s2">, </span><span class="s3">'8 Jan 2013'</span><span class="s2">, </span><span class="s3">'9 Jan 2013'</span><span class="s2">, </span><span class="s3">'10 Jan 2013'</span><span class="s2">,</span>
            <span class="s3">'11 Jan 2013'</span><span class="s2">, </span><span class="s3">'12 Jan 2013'</span><span class="s2">, </span><span class="s3">'13 Jan 2013'</span><span class="s2">, </span><span class="s3">'14 Jan 2013'</span><span class="s2">]</span>

    <span class="s1">time </span><span class="s2">= [</span><span class="s3">'16:44:00'</span><span class="s2">, </span><span class="s3">'16:45:00'</span><span class="s2">, </span><span class="s3">'16:46:00'</span><span class="s2">, </span><span class="s3">'16:47:00'</span><span class="s2">, </span><span class="s3">'16:48:00'</span><span class="s2">,</span>
            <span class="s3">'16:49:00'</span><span class="s2">, </span><span class="s3">'16:51:00'</span><span class="s2">, </span><span class="s3">'16:52:00'</span><span class="s2">, </span><span class="s3">'16:53:00'</span><span class="s2">, </span><span class="s3">'16:55:00'</span><span class="s2">,</span>
            <span class="s3">'16:56:00'</span><span class="s2">, </span><span class="s3">'16:57:00'</span><span class="s2">]</span>

    <span class="s1">angle </span><span class="s2">= </span><span class="s4">60</span>
    <span class="s1">minors </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">mdates</span><span class="s2">.</span><span class="s1">datestr2num</span><span class="s2">(</span><span class="s1">date</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">mdates</span><span class="s2">.</span><span class="s1">datestr2num</span><span class="s2">(</span><span class="s1">time</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis_date</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis_date</span><span class="s2">()</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_minor_locator</span><span class="s2">(</span><span class="s1">AutoMinorLocator</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
            <span class="s3">'ignore'</span><span class="s2">,</span>
            <span class="s3">'FixedFormatter should only be used together with FixedLocator'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_minor_formatter</span><span class="s2">(</span><span class="s1">FixedFormatter</span><span class="s2">(</span><span class="s1">minors</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">autofmt_xdate</span><span class="s2">(</span><span class="s4">0.2</span><span class="s2">, </span><span class="s1">angle</span><span class="s2">, </span><span class="s3">'right'</span><span class="s2">, </span><span class="s1">which</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">which </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'both'</span><span class="s2">, </span><span class="s3">'major'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">label </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">get_xticklabels</span><span class="s2">(</span><span class="s0">False</span><span class="s2">, </span><span class="s3">'major'</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">int</span><span class="s2">(</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_rotation</span><span class="s2">()) == </span><span class="s1">angle</span>

    <span class="s0">if </span><span class="s1">which </span><span class="s0">in </span><span class="s2">(</span><span class="s3">'both'</span><span class="s2">, </span><span class="s3">'minor'</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">label </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">get_xticklabels</span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">'minor'</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">int</span><span class="s2">(</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_rotation</span><span class="s2">()) == </span><span class="s1">angle</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_change_dpi</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">.</span><span class="s1">height </span><span class="s2">== </span><span class="s4">400</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">.</span><span class="s1">width </span><span class="s2">== </span><span class="s4">400</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">= </span><span class="s4">50</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">.</span><span class="s1">height </span><span class="s2">== </span><span class="s4">200</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">.</span><span class="s1">width </span><span class="s2">== </span><span class="s4">200</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'width, height'</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
    <span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_invalid_figure_size</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">))</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_invalid_figure_add_axes</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;missing 1 required positional argument: 'rect'&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">((</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;multiple values for argument 'rect'&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">rect</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>

    <span class="s1">fig2</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;The Axes must have been created in the present &quot;</span>
                             <span class="s3">&quot;figure&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>

    <span class="s1">fig2</span><span class="s2">.</span><span class="s1">delaxes</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">MatplotlibDeprecationWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Passing more than one positional argument&quot;</span><span class="s2">):</span>
        <span class="s1">fig2</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s3">&quot;extra positional argument&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">MatplotlibDeprecationWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Passing more than one positional argument&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s3">&quot;extra positional argument&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subplots_shareax_loglabels</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">squeeze</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">], [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">])</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s3">&quot;log&quot;</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xscale</span><span class="s2">(</span><span class="s3">&quot;log&quot;</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, :]:</span>
        <span class="s0">assert </span><span class="s4">0 </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">get_ticklabels</span><span class="s2">(</span><span class="s1">which</span><span class="s2">=</span><span class="s3">'both'</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, :]:</span>
        <span class="s0">assert </span><span class="s4">0 </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">get_ticklabels</span><span class="s2">(</span><span class="s1">which</span><span class="s2">=</span><span class="s3">'both'</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">]:</span>
        <span class="s0">assert </span><span class="s4">0 </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">get_ticklabels</span><span class="s2">(</span><span class="s1">which</span><span class="s2">=</span><span class="s3">'both'</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">]:</span>
        <span class="s0">assert </span><span class="s4">0 </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">get_ticklabels</span><span class="s2">(</span><span class="s1">which</span><span class="s2">=</span><span class="s3">'both'</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_savefig</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;savefig\(\) takes 2 positional arguments but 3 were given&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s3">&quot;fname1.png&quot;</span><span class="s2">, </span><span class="s3">&quot;fname2.png&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_savefig_warns</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">format </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'png'</span><span class="s2">, </span><span class="s3">'pdf'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">, </span><span class="s3">'tif'</span><span class="s2">, </span><span class="s3">'jpg'</span><span class="s2">]:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s1">format</span><span class="s2">, </span><span class="s1">non_existent_kwarg</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_savefig_backend</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s5"># Intentionally use an invalid module name.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ModuleNotFoundError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;No module named '@absent'&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">backend</span><span class="s2">=</span><span class="s3">&quot;module://@absent&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;The 'pdf' backend does not support png output&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s3">&quot;test.png&quot;</span><span class="s2">, </span><span class="s1">backend</span><span class="s2">=</span><span class="s3">&quot;pdf&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'backend'</span><span class="s2">, [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'Agg'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'Agg'</span><span class="s2">)]),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'Cairo'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'Cairo'</span><span class="s2">)]),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_savefig_pixel_ratio</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">buf</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'png'</span><span class="s2">)</span>
        <span class="s1">ratio1 </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s1">ratio1</span><span class="s2">.</span><span class="s1">load</span><span class="s2">()</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">_set_device_pixel_ratio</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">buf</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'png'</span><span class="s2">)</span>
        <span class="s1">ratio2 </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s1">ratio2</span><span class="s2">.</span><span class="s1">load</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">ratio1 </span><span class="s2">== </span><span class="s1">ratio2</span>


<span class="s0">def </span><span class="s1">test_savefig_preserve_layout_engine</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'compressed'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">bbox_inches</span><span class="s2">=</span><span class="s3">'tight'</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">_compress</span>


<span class="s0">def </span><span class="s1">test_savefig_locate_colorbar</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">cbar </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s4">40</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">bbox_inches</span><span class="s2">=</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">transforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]]))</span>

    <span class="s5"># Check that an aspect ratio has been applied.</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">cbar</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">original</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">bounds </span><span class="s2">!=</span>
            <span class="s1">cbar</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">(</span><span class="s1">original</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">bounds</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s3">&quot;savefig.transparent&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">})</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_savefig_transparent</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s5"># create two transparent subfigures with corresponding transparent inset</span>
    <span class="s5"># axes. the entire background of the image should be transparent.</span>
    <span class="s1">gs1 </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">left</span><span class="s2">=</span><span class="s4">0.05</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s4">0.05</span><span class="s2">)</span>
    <span class="s1">f1 </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs1</span><span class="s2">[:, :])</span>
    <span class="s1">f2 </span><span class="s2">= </span><span class="s1">f1</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs1</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>

    <span class="s1">ax12 </span><span class="s2">= </span><span class="s1">f2</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs1</span><span class="s2">[:, :])</span>

    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">f1</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs1</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">, :])</span>
    <span class="s1">iax1 </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">inset_axes</span><span class="s2">([</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.2</span><span class="s2">, </span><span class="s4">.3</span><span class="s2">, </span><span class="s4">.4</span><span class="s2">])</span>
    <span class="s1">iax2 </span><span class="s2">= </span><span class="s1">iax1</span><span class="s2">.</span><span class="s1">inset_axes</span><span class="s2">([</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.2</span><span class="s2">, </span><span class="s4">.3</span><span class="s2">, </span><span class="s4">.4</span><span class="s2">])</span>

    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, :-</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s2">[</span><span class="s1">ax12</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">iax1</span><span class="s2">, </span><span class="s1">iax2</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">ax3</span><span class="s2">]:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xticks</span><span class="s2">=[], </span><span class="s1">yticks</span><span class="s2">=[])</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">spines</span><span class="s2">[:].</span><span class="s1">set_visible</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_figure_repr</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">) == </span><span class="s3">&quot;&lt;Figure size 100x200 with 0 Axes&gt;&quot;</span>


<span class="s0">def </span><span class="s1">test_valid_layouts</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tight_layout</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'tight'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tight_layout</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tight_layout</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_invalid_layouts</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
        <span class="s5"># this should warn,</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots_adjust</span><span class="s2">(</span><span class="s1">top</span><span class="s2">=</span><span class="s4">0.8</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">ConstrainedLayoutEngine</span><span class="s2">)</span>

    <span class="s5"># Using layout + (tight|constrained)_layout warns, but the former takes</span>
    <span class="s5"># precedence.</span>
    <span class="s1">wst </span><span class="s2">= </span><span class="s3">&quot;The Figure parameters 'layout' and 'tight_layout'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">wst</span><span class="s2">):</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'tight'</span><span class="s2">, </span><span class="s1">tight_layout</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">TightLayoutEngine</span><span class="s2">)</span>
    <span class="s1">wst </span><span class="s2">= </span><span class="s3">&quot;The Figure parameters 'layout' and 'constrained_layout'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">wst</span><span class="s2">):</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">, </span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">TightLayoutEngine</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">ConstrainedLayoutEngine</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Invalid value for 'layout'&quot;</span><span class="s2">):</span>
        <span class="s1">Figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'foobar'</span><span class="s2">)</span>

    <span class="s5"># test that layouts can be swapped if no colorbar:</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;tight&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">TightLayoutEngine</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">ConstrainedLayoutEngine</span><span class="s2">)</span>

    <span class="s5"># test that layouts cannot be swapped if there is a colorbar:</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Colorbar layout of new layout'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;tight&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;none&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Colorbar layout of new layout'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;tight&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">&quot;tight&quot;</span><span class="s2">)</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Colorbar layout of new layout'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;none&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">PlaceHolderLayoutEngine</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'Colorbar layout of new layout'</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_tightlayout_autolayout_deconflict</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s0">for </span><span class="s1">fig</span><span class="s2">, </span><span class="s1">autolayout </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]):</span>
        <span class="s0">with </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s3">'figure.autolayout'</span><span class="s2">: </span><span class="s1">autolayout</span><span class="s2">}):</span>
            <span class="s1">axes </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">ncols</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">(</span><span class="s1">w_pad</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">(), </span><span class="s1">PlaceHolderLayoutEngine</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'layout'</span><span class="s2">, [</span><span class="s3">'constrained'</span><span class="s2">, </span><span class="s3">'compressed'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_layout_change_warning</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Raise a warning when a previously assigned layout changes to tight using 
    plt.tight_layout(). 
    &quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s1">layout</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'The figure layout has changed to'</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_repeated_tightlayout</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>
    <span class="s5"># subsequent calls should not warn</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s3">&quot;pdf&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_add_artist</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">= </span><span class="s4">100</span>

    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">l1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">([</span><span class="s4">.2</span><span class="s2">, </span><span class="s4">.7</span><span class="s2">], [</span><span class="s4">.7</span><span class="s2">, </span><span class="s4">.7</span><span class="s2">], </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'l1'</span><span class="s2">)</span>
    <span class="s1">l2 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">([</span><span class="s4">.2</span><span class="s2">, </span><span class="s4">.7</span><span class="s2">], [</span><span class="s4">.8</span><span class="s2">, </span><span class="s4">.8</span><span class="s2">], </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'l2'</span><span class="s2">)</span>
    <span class="s1">r1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), </span><span class="s4">100</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'C1'</span><span class="s2">)</span>
    <span class="s1">r2 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s4">.7</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">), </span><span class="s4">.05</span><span class="s2">, </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'C2'</span><span class="s2">)</span>
    <span class="s1">r3 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">.8</span><span class="s2">), </span><span class="s4">.55</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">dpi_scale_trans</span><span class="s2">,</span>
                    <span class="s1">facecolor</span><span class="s2">=</span><span class="s3">'crimson'</span><span class="s2">, </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'C3'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">[</span><span class="s1">l1</span><span class="s2">, </span><span class="s1">l2</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">]:</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s1">l2</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">()</span>

    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">l1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">([</span><span class="s4">.2</span><span class="s2">, </span><span class="s4">.7</span><span class="s2">], [</span><span class="s4">.7</span><span class="s2">, </span><span class="s4">.7</span><span class="s2">], </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">transFigure</span><span class="s2">,</span>
                    <span class="s1">gid</span><span class="s2">=</span><span class="s3">'l1'</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s4">21</span><span class="s2">)</span>
    <span class="s1">r1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">), </span><span class="s4">100</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">clip_on</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s4">20</span><span class="s2">,</span>
                    <span class="s1">gid</span><span class="s2">=</span><span class="s3">'C1'</span><span class="s2">)</span>
    <span class="s1">r2 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s4">.7</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">), </span><span class="s4">.05</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">transFigure</span><span class="s2">, </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'C2'</span><span class="s2">,</span>
                    <span class="s1">zorder</span><span class="s2">=</span><span class="s4">20</span><span class="s2">)</span>
    <span class="s1">r3 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Circle</span><span class="s2">((</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">.8</span><span class="s2">), </span><span class="s4">.55</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">dpi_scale_trans</span><span class="s2">,</span>
                    <span class="s1">facecolor</span><span class="s2">=</span><span class="s3">'crimson'</span><span class="s2">, </span><span class="s1">clip_on</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">gid</span><span class="s2">=</span><span class="s3">'C3'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">[</span><span class="s1">l1</span><span class="s2">, </span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">]:</span>
        <span class="s1">ax2</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;fmt&quot;</span><span class="s2">, [</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s3">&quot;pdf&quot;</span><span class="s2">, </span><span class="s3">&quot;ps&quot;</span><span class="s2">, </span><span class="s3">&quot;eps&quot;</span><span class="s2">, </span><span class="s3">&quot;svg&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_fspath</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">f&quot;test.</span><span class="s0">{</span><span class="s1">fmt</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">out</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">out</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">file</span><span class="s2">:</span>
        <span class="s5"># All the supported formats include the format name (case-insensitive)</span>
        <span class="s5"># in the first 100 bytes.</span>
        <span class="s0">assert </span><span class="s1">fmt</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;ascii&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">file</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s4">100</span><span class="s2">).</span><span class="s1">lower</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_tightbbox</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">'This dangles over end'</span><span class="s2">)</span>
    <span class="s1">renderer </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">()</span>
    <span class="s1">x1Nom0 </span><span class="s2">= </span><span class="s4">9.035  </span><span class="s5"># inches</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x1Nom0 </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span><span class="s2">) &lt; </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x1Nom0 </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span><span class="s2">) &lt; </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x1Nom0</span><span class="s2">) &lt; </span><span class="s4">0.05</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x0 </span><span class="s2">- </span><span class="s4">0.679</span><span class="s2">) &lt; </span><span class="s4">0.05</span>
    <span class="s5"># now exclude t from the tight bbox so now the bbox is quite a bit</span>
    <span class="s5"># smaller</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">set_in_layout</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">x1Nom </span><span class="s2">= </span><span class="s4">7.333</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x1Nom </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span><span class="s2">) &lt; </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x1Nom</span><span class="s2">) &lt; </span><span class="s4">0.05</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">set_in_layout</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">x1Nom </span><span class="s2">= </span><span class="s4">7.333</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">).</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x1Nom0 </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span><span class="s2">) &lt; </span><span class="s4">2</span>
    <span class="s5"># test bbox_extra_artists method...</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">renderer</span><span class="s2">, </span><span class="s1">bbox_extra_artists</span><span class="s2">=[]).</span><span class="s1">x1</span>
               <span class="s2">- </span><span class="s1">x1Nom </span><span class="s2">* </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span><span class="s2">) &lt; </span><span class="s4">2</span>


<span class="s0">def </span><span class="s1">test_axes_removal</span><span class="s2">():</span>
    <span class="s5"># Check that units can set the formatter after an Axes removal</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">get_major_formatter</span><span class="s2">(),</span>
                      <span class="s1">mdates</span><span class="s2">.</span><span class="s1">AutoDateFormatter</span><span class="s2">)</span>

    <span class="s5"># Check that manually setting the formatter, then removing Axes keeps</span>
    <span class="s5"># the set formatter.</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_major_formatter</span><span class="s2">(</span><span class="s1">ScalarFormatter</span><span class="s2">())</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">get_major_formatter</span><span class="s2">(),</span>
                      <span class="s1">ScalarFormatter</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_removed_axis</span><span class="s2">():</span>
    <span class="s5"># Simple smoke test to make sure removing a shared axis works</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'clear_meth'</span><span class="s2">, [</span><span class="s3">'clear'</span><span class="s2">, </span><span class="s3">'clf'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_figure_clear</span><span class="s2">(</span><span class="s1">clear_meth</span><span class="s2">):</span>
    <span class="s5"># we test the following figure clearing scenarios:</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s5"># a) an empty figure</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== []</span>

    <span class="s5"># b) a figure with a single unnested axes</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== []</span>

    <span class="s5"># c) a figure multiple unnested axes</span>
    <span class="s1">axes </span><span class="s2">= [</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)]</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== []</span>

    <span class="s5"># d) a figure with a subfigure</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s1">ncols</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">nrows</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">subfig </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">subaxes </span><span class="s2">= </span><span class="s1">subfig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">subfig </span><span class="s0">not in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== []</span>

    <span class="s5"># e) a figure with a subfigure and a subplot</span>
    <span class="s1">subfig </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">subaxes </span><span class="s2">= </span><span class="s1">subfig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s1">mainaxes </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s5"># e.1) removing just the axes leaves the subplot</span>
    <span class="s1">mainaxes</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== [</span><span class="s1">subaxes</span><span class="s2">]</span>

    <span class="s5"># e.2) removing just the subaxes leaves the subplot</span>
    <span class="s5"># and subfigure</span>
    <span class="s1">mainaxes </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">subaxes</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== [</span><span class="s1">mainaxes</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">subfig </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs</span>

    <span class="s5"># e.3) clearing the subfigure leaves the subplot</span>
    <span class="s1">subaxes </span><span class="s2">= </span><span class="s1">subfig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mainaxes </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">subaxes </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">subfig</span><span class="s2">, </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">subfig </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs</span>
    <span class="s0">assert </span><span class="s1">subaxes </span><span class="s0">not in </span><span class="s1">subfig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">subaxes </span><span class="s0">not in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">mainaxes </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>

    <span class="s5"># e.4) clearing the whole thing</span>
    <span class="s1">subaxes </span><span class="s2">= </span><span class="s1">subfig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== []</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs </span><span class="s2">== []</span>

    <span class="s5"># f) multiple subfigures</span>
    <span class="s1">subfigs </span><span class="s2">= [</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">subaxes </span><span class="s2">= [</span><span class="s1">sfig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">) </span><span class="s0">for </span><span class="s1">sfig </span><span class="s0">in </span><span class="s1">subfigs</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ax </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">subaxes</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">sfig </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs </span><span class="s0">for </span><span class="s1">sfig </span><span class="s0">in </span><span class="s1">subfigs</span><span class="s2">)</span>

    <span class="s5"># f.1) clearing only one subfigure</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">subfigs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">subaxes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">subaxes</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span>
    <span class="s0">assert </span><span class="s1">subfigs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs</span>

    <span class="s5"># f.2) clearing the whole thing</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">subfigs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s1">subfigs </span><span class="s2">= [</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">subaxes </span><span class="s2">= [</span><span class="s1">sfig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">) </span><span class="s0">for </span><span class="s1">sfig </span><span class="s0">in </span><span class="s1">subfigs</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ax </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">subaxes</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">sfig </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs </span><span class="s0">for </span><span class="s1">sfig </span><span class="s0">in </span><span class="s1">subfigs</span><span class="s2">)</span>
    <span class="s1">getattr</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">clear_meth</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs </span><span class="s2">== []</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">== []</span>


<span class="s0">def </span><span class="s1">test_clf_not_redefined</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">klass </span><span class="s0">in </span><span class="s1">FigureBase</span><span class="s2">.</span><span class="s1">__subclasses__</span><span class="s2">():</span>
        <span class="s5"># check that subclasses do not get redefined in our Figure subclasses</span>
        <span class="s0">assert </span><span class="s3">'clf' </span><span class="s0">not in </span><span class="s1">klass</span><span class="s2">.</span><span class="s1">__dict__</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_picking_does_not_stale</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1000</span><span class="s2">], </span><span class="s1">picker</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>

    <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">,</span>
                                  <span class="s1">y</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">y0 </span><span class="s2">+ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">height </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">,</span>
                                  <span class="s1">inaxes</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">guiEvent</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">pick</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>


<span class="s0">def </span><span class="s1">test_add_subplot_twotuple</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">rowspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">colspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">rowspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">colspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax3</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">rowspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax3</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">colspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">ax4 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax4</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">rowspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax4</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">colspan </span><span class="s2">== </span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, (</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'tightbbox_box_aspect.svg'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s3">'bbox_inches'</span><span class="s2">: </span><span class="s3">'tight'</span><span class="s2">,</span>
                                 <span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'teal'</span><span class="s2">},</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_tightbbox_box_aspect</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'3d'</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_box_aspect</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_box_aspect</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;svg&quot;</span><span class="s2">, </span><span class="s3">&quot;pdf&quot;</span><span class="s2">, </span><span class="s3">&quot;eps&quot;</span><span class="s2">, </span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_animated_with_canvas_change</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>

    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s1">animated</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSubplotMosaic</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;x&quot;</span><span class="s2">, [</span>
            <span class="s2">[[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]],</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]],</span>
            <span class="s2">((</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">), (</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">)),</span>
            <span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">grid_axes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">labels </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>

        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">grid_axes</span><span class="s2">)</span>

        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">axA </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">, :</span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">axA</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">axB </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">axB</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">axC </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">axC</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>

        <span class="s1">axD </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">axD</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s4">3</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_all_nested</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]]</span>
        <span class="s1">y </span><span class="s2">= [[</span><span class="s3">&quot;E&quot;</span><span class="s2">, </span><span class="s3">&quot;F&quot;</span><span class="s2">], [</span><span class="s3">&quot;G&quot;</span><span class="s2">, </span><span class="s3">&quot;H&quot;</span><span class="s2">]]</span>

        <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>

        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]])</span>
        <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">grid_axes</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_label</span><span class="s2">())</span>

        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">gs_left </span><span class="s2">= </span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">r </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">label </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
                <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs_left</span><span class="s2">[</span><span class="s1">j</span><span class="s2">, </span><span class="s1">k</span><span class="s2">]).</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>

        <span class="s1">gs_right </span><span class="s2">= </span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">r </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">label </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
                <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs_right</span><span class="s2">[</span><span class="s1">j</span><span class="s2">, </span><span class="s1">k</span><span class="s2">]).</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">label</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_nested</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>

        <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">set_layout_engine</span><span class="s2">(</span><span class="s3">&quot;constrained&quot;</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= [[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]]</span>

        <span class="s1">y </span><span class="s2">= [[</span><span class="s3">&quot;F&quot;</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">]]</span>

        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">grid_axes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">gs_n </span><span class="s2">= </span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

        <span class="s1">axA </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs_n</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">axA</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>

        <span class="s1">axB </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs_n</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">axB</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">&quot;B&quot;</span><span class="s2">)</span>

        <span class="s1">axC </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs_n</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">axC</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">&quot;C&quot;</span><span class="s2">)</span>

        <span class="s1">axD </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs_n</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">axD</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">&quot;D&quot;</span><span class="s2">)</span>

        <span class="s1">axF </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">axF</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">&quot;F&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_nested_tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]]</span>
        <span class="s1">xt </span><span class="s2">= ((</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">), (</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">))</span>

        <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s3">&quot;F&quot;</span><span class="s2">], [</span><span class="s1">x</span><span class="s2">]])</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s3">&quot;F&quot;</span><span class="s2">], [</span><span class="s1">xt</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_nested_width_ratios</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [[</span><span class="s3">&quot;A&quot;</span><span class="s2">, [[</span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s3">&quot;C&quot;</span><span class="s2">]]]]</span>
        <span class="s1">width_ratios </span><span class="s2">= [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>

        <span class="s1">fig</span><span class="s2">, </span><span class="s1">axd </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">width_ratios</span><span class="s2">=</span><span class="s1">width_ratios</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">axd</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">].</span><span class="s1">get_gridspec</span><span class="s2">().</span><span class="s1">get_width_ratios</span><span class="s2">() == </span><span class="s1">width_ratios</span>
        <span class="s0">assert </span><span class="s1">axd</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">].</span><span class="s1">get_gridspec</span><span class="s2">().</span><span class="s1">get_width_ratios</span><span class="s2">() != </span><span class="s1">width_ratios</span>

    <span class="s0">def </span><span class="s1">test_nested_height_ratios</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [[</span><span class="s3">&quot;A&quot;</span><span class="s2">, [[</span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s3">&quot;C&quot;</span><span class="s2">]]], [</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]]</span>
        <span class="s1">height_ratios </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>

        <span class="s1">fig</span><span class="s2">, </span><span class="s1">axd </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">height_ratios</span><span class="s2">=</span><span class="s1">height_ratios</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">axd</span><span class="s2">[</span><span class="s3">&quot;D&quot;</span><span class="s2">].</span><span class="s1">get_gridspec</span><span class="s2">().</span><span class="s1">get_height_ratios</span><span class="s2">() == </span><span class="s1">height_ratios</span>
        <span class="s0">assert </span><span class="s1">axd</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">].</span><span class="s1">get_gridspec</span><span class="s2">().</span><span class="s1">get_height_ratios</span><span class="s2">() != </span><span class="s1">height_ratios</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;x, empty_sentinel&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">([[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]], </span><span class="s0">None</span><span class="s2">),</span>
            <span class="s2">([[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">], [</span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]], </span><span class="s3">&quot;SKIP&quot;</span><span class="s2">),</span>
            <span class="s2">([[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]], </span><span class="s4">0</span><span class="s2">),</span>
            <span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s0">None</span><span class="s2">),</span>
            <span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">], [</span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s3">&quot;SKIP&quot;</span><span class="s2">),</span>
            <span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">empty_sentinel</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">empty_sentinel </span><span class="s2">!= </span><span class="s3">&quot;SKIP&quot;</span><span class="s2">:</span>
            <span class="s1">kwargs </span><span class="s2">= {</span><span class="s3">&quot;empty_sentinel&quot;</span><span class="s2">: </span><span class="s1">empty_sentinel</span><span class="s2">}</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">kwargs </span><span class="s2">= {}</span>
        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">grid_axes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">labels </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s1">name </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">x </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">row</span><span class="s2">} - {</span><span class="s1">empty_sentinel</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">grid_axes</span><span class="s2">)</span>

        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">axA </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">axA</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">axB </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">axB</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_fail_list_of_str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'must be 2D'</span><span class="s2">):</span>
            <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'must be 2D'</span><span class="s2">):</span>
            <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([</span><span class="s3">'foo'</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'must be 2D'</span><span class="s2">):</span>
            <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s3">'foo'</span><span class="s2">, (</span><span class="s3">'bar'</span><span class="s2">,)]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'must be 2D'</span><span class="s2">):</span>
            <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">], [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">), </span><span class="s3">'c'</span><span class="s2">]])</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;subplot_kw&quot;</span><span class="s2">, [{}, {</span><span class="s3">&quot;projection&quot;</span><span class="s2">: </span><span class="s3">&quot;polar&quot;</span><span class="s2">}, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_subplot_kw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">subplot_kw</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]</span>
        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">subplot_kw</span><span class="s2">=</span><span class="s1">subplot_kw</span><span class="s2">)</span>
        <span class="s1">subplot_kw </span><span class="s2">= </span><span class="s1">subplot_kw </span><span class="s0">or </span><span class="s2">{}</span>

        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">axA </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], **</span><span class="s1">subplot_kw</span><span class="s2">)</span>

        <span class="s1">axB </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], **</span><span class="s1">subplot_kw</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;multi_value&quot;</span><span class="s2">, [</span><span class="s3">'BC'</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s3">'BC'</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_per_subplot_kw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">multi_value</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s3">'AB;CD'</span>
        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">,</span>
            <span class="s1">subplot_kw</span><span class="s2">={</span><span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'red'</span><span class="s2">},</span>
            <span class="s1">per_subplot_kw</span><span class="s2">={</span>
                <span class="s3">'D'</span><span class="s2">: {</span><span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'blue'</span><span class="s2">},</span>
                <span class="s1">multi_value</span><span class="s2">: {</span><span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'green'</span><span class="s2">},</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">color</span><span class="s2">, </span><span class="s1">spec </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s3">'red'</span><span class="s2">, </span><span class="s3">'green'</span><span class="s2">, </span><span class="s3">'green'</span><span class="s2">, </span><span class="s3">'blue'</span><span class="s2">], </span><span class="s1">gs</span><span class="s2">):</span>
            <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">spec</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s1">color</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_string_parser</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">normalize </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">.</span><span class="s1">_normalize_grid_string</span>

        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">(</span><span class="s3">'ABC'</span><span class="s2">) == [[</span><span class="s3">'A'</span><span class="s2">, </span><span class="s3">'B'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">]]</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">(</span><span class="s3">'AB;CC'</span><span class="s2">) == [[</span><span class="s3">'A'</span><span class="s2">, </span><span class="s3">'B'</span><span class="s2">], [</span><span class="s3">'C'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">]]</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">(</span><span class="s3">'AB;CC;DE'</span><span class="s2">) == [[</span><span class="s3">'A'</span><span class="s2">, </span><span class="s3">'B'</span><span class="s2">], [</span><span class="s3">'C'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">], [</span><span class="s3">'D'</span><span class="s2">, </span><span class="s3">'E'</span><span class="s2">]]</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
                         ABC 
                         &quot;&quot;&quot;</span><span class="s2">) == [[</span><span class="s3">'A'</span><span class="s2">, </span><span class="s3">'B'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">]]</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
                         AB 
                         CC 
                         &quot;&quot;&quot;</span><span class="s2">) == [[</span><span class="s3">'A'</span><span class="s2">, </span><span class="s3">'B'</span><span class="s2">], [</span><span class="s3">'C'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">]]</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
                         AB 
                         CC 
                         DE 
                         &quot;&quot;&quot;</span><span class="s2">) == [[</span><span class="s3">'A'</span><span class="s2">, </span><span class="s3">'B'</span><span class="s2">], [</span><span class="s3">'C'</span><span class="s2">, </span><span class="s3">'C'</span><span class="s2">], [</span><span class="s3">'D'</span><span class="s2">, </span><span class="s3">'E'</span><span class="s2">]]</span>

    <span class="s0">def </span><span class="s1">test_per_subplot_kw_expander</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">normalize </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">.</span><span class="s1">_norm_per_subplot_kw</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: {}, </span><span class="s3">&quot;B&quot;</span><span class="s2">: {}}) == {</span><span class="s3">&quot;A&quot;</span><span class="s2">: {}, </span><span class="s3">&quot;B&quot;</span><span class="s2">: {}}</span>
        <span class="s0">assert </span><span class="s1">normalize</span><span class="s2">({(</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">): {}}) == {</span><span class="s3">&quot;A&quot;</span><span class="s2">: {}, </span><span class="s3">&quot;B&quot;</span><span class="s2">: {}}</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">f'The key </span><span class="s0">{</span><span class="s3">&quot;B&quot;</span><span class="s0">!r} </span><span class="s3">appears multiple times'</span>
        <span class="s2">):</span>
            <span class="s1">normalize</span><span class="s2">({(</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">): {}, </span><span class="s3">&quot;B&quot;</span><span class="s2">: {}})</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">f'The key </span><span class="s0">{</span><span class="s3">&quot;B&quot;</span><span class="s0">!r} </span><span class="s3">appears multiple times'</span>
        <span class="s2">):</span>
            <span class="s1">normalize</span><span class="s2">({</span><span class="s3">&quot;B&quot;</span><span class="s2">: {}, (</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">): {}})</span>

    <span class="s0">def </span><span class="s1">test_extra_per_subplot_kw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">f'The keys </span><span class="s0">{</span><span class="s1">set</span><span class="s2">(</span><span class="s3">&quot;B&quot;</span><span class="s2">)</span><span class="s0">!r} </span><span class="s3">are in'</span>
        <span class="s2">):</span>
            <span class="s1">Figure</span><span class="s2">().</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s1">per_subplot_kw</span><span class="s2">={</span><span class="s3">&quot;B&quot;</span><span class="s2">: {}})</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;str_pattern&quot;</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s3">&quot;AAA</span><span class="s0">\n</span><span class="s3">BBB&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">AAA</span><span class="s0">\n</span><span class="s3">BBB</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;ABC</span><span class="s0">\n</span><span class="s3">DEF&quot;</span><span class="s2">]</span>
                             <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_single_str_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">str_pattern</span><span class="s2">):</span>
        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">str_pattern</span><span class="s2">)</span>

        <span class="s1">grid_axes </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">list</span><span class="s2">(</span><span class="s1">ln</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ln </span><span class="s0">in </span><span class="s1">str_pattern</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">)]</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;x,match&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span>
                <span class="s2">[[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">], [</span><span class="s3">&quot;.&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">]],</span>
                <span class="s2">(</span>
                    <span class="s3">&quot;(?m)we found that the label .A. specifies a &quot;</span>
                    <span class="s2">+ </span><span class="s3">&quot;non-rectangular or non-contiguous area.&quot;</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s2">(</span>
                <span class="s2">[[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, [[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]]]],</span>
                <span class="s3">&quot;There are duplicate keys .* between the outer layout&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;AAA</span><span class="s0">\n</span><span class="s3">c</span><span class="s0">\n</span><span class="s3">BBB&quot;</span><span class="s2">, </span><span class="s3">&quot;All of the rows must be the same length&quot;</span><span class="s2">),</span>
            <span class="s2">(</span>
                <span class="s2">[[</span><span class="s3">&quot;A&quot;</span><span class="s2">, [[</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">], [</span><span class="s3">&quot;D&quot;</span><span class="s2">]]], [</span><span class="s3">&quot;E&quot;</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">]],</span>
                <span class="s3">&quot;All of the rows must be the same length&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_fail</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">match</span><span class="s2">):</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_hashable_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s1">object</span><span class="s2">(), </span><span class="s1">object</span><span class="s2">()]])</span>
        <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">([[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'str_pattern'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s3">'abc'</span><span class="s2">, </span><span class="s3">'cab'</span><span class="s2">, </span><span class="s3">'bca'</span><span class="s2">, </span><span class="s3">'cba'</span><span class="s2">, </span><span class="s3">'acb'</span><span class="s2">, </span><span class="s3">'bac'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_user_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">str_pattern</span><span class="s2">):</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
        <span class="s1">ax_dict </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">str_pattern</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">str_pattern</span><span class="s2">) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ax_dict</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ax_dict</span><span class="s2">.</span><span class="s1">values</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_nested_user_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">layout </span><span class="s2">= [</span>
            <span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">, [[</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">]]],</span>
            <span class="s2">[</span><span class="s3">&quot;F&quot;</span><span class="s2">, </span><span class="s3">&quot;G&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;.&quot;</span><span class="s2">, [[</span><span class="s3">&quot;H&quot;</span><span class="s2">, [[</span><span class="s3">&quot;I&quot;</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">&quot;.&quot;</span><span class="s2">]]]]]</span>
        <span class="s2">]</span>

        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
        <span class="s1">ax_dict </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ax_dict</span><span class="s2">) == </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCDEFGHI&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">ax_dict</span><span class="s2">.</span><span class="s1">values</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_share_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">layout </span><span class="s2">= [</span>
            <span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">, [[</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">]]],</span>
            <span class="s2">[</span><span class="s3">&quot;F&quot;</span><span class="s2">, </span><span class="s3">&quot;G&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;.&quot;</span><span class="s2">, [[</span><span class="s3">&quot;H&quot;</span><span class="s2">, [[</span><span class="s3">&quot;I&quot;</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">&quot;.&quot;</span><span class="s2">]]]]]</span>
        <span class="s2">]</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
        <span class="s1">ax_dict </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">ax_dict</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">].</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xscale</span><span class="s2">=</span><span class="s3">&quot;log&quot;</span><span class="s2">, </span><span class="s1">yscale</span><span class="s2">=</span><span class="s3">&quot;logit&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xscale</span><span class="s2">() == </span><span class="s3">&quot;log&quot; </span><span class="s0">and </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_yscale</span><span class="s2">() == </span><span class="s3">&quot;logit&quot;</span>
                   <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">ax_dict</span><span class="s2">.</span><span class="s1">values</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_reused_gridspec</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that these all use the same gridspec&quot;&quot;&quot;</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot2grid</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">colspan</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">)</span>

    <span class="s1">gs1 </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">get_gridspec</span><span class="s2">()</span>
    <span class="s1">gs2 </span><span class="s2">= </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">get_gridspec</span><span class="s2">()</span>
    <span class="s1">gs3 </span><span class="s2">= </span><span class="s1">ax3</span><span class="s2">.</span><span class="s1">get_subplotspec</span><span class="s2">().</span><span class="s1">get_gridspec</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">gs1 </span><span class="s2">== </span><span class="s1">gs2</span>
    <span class="s0">assert </span><span class="s1">gs1 </span><span class="s2">== </span><span class="s1">gs3</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'test_subfigure.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'teal'</span><span class="s2">})</span>
<span class="s0">def </span><span class="s1">test_subfigure</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">19680801</span><span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">)</span>
    <span class="s1">sub </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">axs </span><span class="s2">= </span><span class="s1">sub</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">30</span><span class="s2">, </span><span class="s4">30</span><span class="s2">), </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'Left Side'</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'white'</span><span class="s2">)</span>

    <span class="s1">axs </span><span class="s2">= </span><span class="s1">sub</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">30</span><span class="s2">, </span><span class="s4">30</span><span class="s2">), </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s3">'bottom'</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'Right Side'</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'white'</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'Figure suptitle'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">'xx-large'</span><span class="s2">)</span>

    <span class="s5"># below tests for the draw zorder of subfigures.</span>
    <span class="s1">leg </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">(</span><span class="s1">handles</span><span class="s2">=[</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'Line{}'</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>
                     <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)], </span><span class="s1">loc</span><span class="s2">=</span><span class="s3">'center'</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_zorder</span><span class="s2">(</span><span class="s1">leg</span><span class="s2">.</span><span class="s1">get_zorder</span><span class="s2">() - </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">set_zorder</span><span class="s2">(</span><span class="s1">leg</span><span class="s2">.</span><span class="s1">get_zorder</span><span class="s2">() + </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subfigure_tightbbox</span><span class="s2">():</span>
    <span class="s5"># test that we can get the tightbbox with a subfigure...</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">)</span>
    <span class="s1">sub </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">()).</span><span class="s1">width</span><span class="s2">,</span>
            <span class="s4">8.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subfigure_dpi</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">dpi</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>
    <span class="s1">sub_fig </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sub_fig</span><span class="s2">.</span><span class="s1">get_dpi</span><span class="s2">() == </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_dpi</span><span class="s2">()</span>

    <span class="s1">sub_fig</span><span class="s2">.</span><span class="s1">set_dpi</span><span class="s2">(</span><span class="s4">200</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sub_fig</span><span class="s2">.</span><span class="s1">get_dpi</span><span class="s2">() == </span><span class="s4">200</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_dpi</span><span class="s2">() == </span><span class="s4">200</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'test_subfigure_ss.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'teal'</span><span class="s2">}, </span><span class="s1">tol</span><span class="s2">=</span><span class="s4">0.02</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_subfigure_ss</span><span class="s2">():</span>
    <span class="s5"># test assigning the subfigure via subplotspec</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">19680801</span><span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">)</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">sub </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s3">'pink'</span><span class="s2">)</span>

    <span class="s1">axs </span><span class="s2">= </span><span class="s1">sub</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">30</span><span class="s2">, </span><span class="s4">30</span><span class="s2">), </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">)</span>
    <span class="s1">sub</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'Left Side'</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">20</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Axes'</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'Figure suptitle'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">'xx-large'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'test_subfigure_double.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s3">'facecolor'</span><span class="s2">: </span><span class="s3">'teal'</span><span class="s2">})</span>
<span class="s0">def </span><span class="s1">test_subfigure_double</span><span class="s2">():</span>
    <span class="s5"># test assigning the subfigure via subplotspec</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">19680801</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">8</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'fig'</span><span class="s2">)</span>

    <span class="s1">subfigs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s4">0.07</span><span class="s2">)</span>

    <span class="s1">subfigs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'coral'</span><span class="s2">)</span>
    <span class="s1">subfigs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'subfigs[0]'</span><span class="s2">)</span>

    <span class="s1">subfigs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'coral'</span><span class="s2">)</span>
    <span class="s1">subfigs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'subfigs[1]'</span><span class="s2">)</span>

    <span class="s1">subfigsnest </span><span class="s2">= </span><span class="s1">subfigs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">height_ratios</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">])</span>
    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'subfigsnest[0]'</span><span class="s2">)</span>
    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s1">axsnest0 </span><span class="s2">= </span><span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axsnest0</span><span class="s2">:</span>
        <span class="s1">fontsize </span><span class="s2">= </span><span class="s4">12</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">30</span><span class="s2">, </span><span class="s4">30</span><span class="s2">), </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s4">2.5</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s4">2.5</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s3">'x-label'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">'y-label'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Title'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axsnest0</span><span class="s2">)</span>

    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">'subfigsnest[1]'</span><span class="s2">)</span>
    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'g'</span><span class="s2">)</span>
    <span class="s1">axsnest1 </span><span class="s2">= </span><span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axsnest1</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s3">f'ylabel</span><span class="s0">{</span><span class="s1">nn</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">supxlabel</span><span class="s2">(</span><span class="s3">'supxlabel'</span><span class="s2">)</span>
    <span class="s1">subfigsnest</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">supylabel</span><span class="s2">(</span><span class="s3">'supylabel'</span><span class="s2">)</span>

    <span class="s1">axsRight </span><span class="s2">= </span><span class="s1">subfigs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subfigure_spanning</span><span class="s2">():</span>
    <span class="s5"># test that subfigures get laid out properly...</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">sub_figs </span><span class="s2">= [</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]),</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]),</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">:</span><span class="s4">3</span><span class="s2">]),</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:, </span><span class="s4">1</span><span class="s2">:])</span>
    <span class="s2">]</span>

    <span class="s1">w </span><span class="s2">= </span><span class="s4">640</span>
    <span class="s1">h </span><span class="s2">= </span><span class="s4">480</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s4">0.</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">2</span><span class="s2">/</span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">, </span><span class="s1">h</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">, </span><span class="s1">h </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">2</span><span class="s2">/</span><span class="s4">3</span><span class="s2">, </span><span class="s1">h</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">2</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">2</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">/ </span><span class="s4">3</span><span class="s2">])</span>

    <span class="s5"># check here that slicing actually works.  Last sub_fig</span>
    <span class="s5"># with open slices failed, but only on draw...</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">4</span><span class="s2">):</span>
        <span class="s1">sub_figs</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_subfigure_ticks</span><span class="s2">():</span>
    <span class="s5"># This tests a tick-spacing error that only seems applicable</span>
    <span class="s5"># when the subfigures are saved to file.  It is very hard to replicate</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s5"># create left/right subfigs nested in bottom subfig</span>
    <span class="s2">(</span><span class="s1">subfig_bl</span><span class="s2">, </span><span class="s1">subfig_br</span><span class="s2">) = </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s4">0.01</span><span class="s2">,</span>
                                            <span class="s1">width_ratios</span><span class="s2">=[</span><span class="s4">7</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>

    <span class="s5"># put ax1-ax3 in gridspec of bottom-left subfig</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">subfig_bl</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s1">nrows</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ncols</span><span class="s2">=</span><span class="s4">14</span><span class="s2">)</span>

    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">subfig_bl</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, :</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=[-</span><span class="s4">56.46881504821776</span><span class="s2">, </span><span class="s4">24.179891162109396</span><span class="s2">], </span><span class="s1">y</span><span class="s2">=[</span><span class="s4">1500</span><span class="s2">, </span><span class="s4">3600</span><span class="s2">])</span>

    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">subfig_bl</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">:</span><span class="s4">3</span><span class="s2">], </span><span class="s1">sharey</span><span class="s2">=</span><span class="s1">ax1</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=[-</span><span class="s4">126.5357270050049</span><span class="s2">, </span><span class="s4">94.68456736755368</span><span class="s2">], </span><span class="s1">y</span><span class="s2">=[</span><span class="s4">1500</span><span class="s2">, </span><span class="s4">3600</span><span class="s2">])</span>
    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">subfig_bl</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">:</span><span class="s4">14</span><span class="s2">], </span><span class="s1">sharey</span><span class="s2">=</span><span class="s1">ax1</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">= </span><span class="s4">120</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">ticks120 </span><span class="s2">= </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_xticks</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">= </span><span class="s4">300</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">ticks300 </span><span class="s2">= </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_xticks</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ticks120</span><span class="s2">, </span><span class="s1">ticks300</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'test_subfigure_scatter_size.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">,</span>
                   <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_subfigure_scatter_size</span><span class="s2">():</span>
    <span class="s5"># markers in the left- and right-most subplots should be the same</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">ax0 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ax0</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">s</span><span class="s2">=</span><span class="s4">30</span><span class="s2">, </span><span class="s1">marker</span><span class="s2">=</span><span class="s3">'s'</span><span class="s2">)</span>
    <span class="s1">ax0</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">s</span><span class="s2">=[</span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">40</span><span class="s2">], </span><span class="s1">marker</span><span class="s2">=</span><span class="s3">'s'</span><span class="s2">)</span>

    <span class="s1">sfig </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subfigure</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">sfig</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s2">[</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]]:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">s</span><span class="s2">=</span><span class="s4">30</span><span class="s2">, </span><span class="s1">marker</span><span class="s2">=</span><span class="s3">'s'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">s</span><span class="s2">=[</span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">40</span><span class="s2">], </span><span class="s1">marker</span><span class="s2">=</span><span class="s3">'s'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'g'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subfigure_pdf</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s3">'constrained'</span><span class="s2">)</span>
    <span class="s1">sub_fig </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">sub_fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bar</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">bar_label</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
    <span class="s1">buffer </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buffer</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'pdf'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subfigures_wspace_hspace</span><span class="s2">():</span>
    <span class="s1">sub_figs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">().</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">hspace</span><span class="s2">=</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s4">1</span><span class="s2">/</span><span class="s4">6.</span><span class="s2">)</span>

    <span class="s1">w </span><span class="s2">= </span><span class="s4">640</span>
    <span class="s1">h </span><span class="s2">= </span><span class="s4">480</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s4">0.</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">0.6</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.3</span><span class="s2">, </span><span class="s1">h</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.35</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">0.6</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.65</span><span class="s2">, </span><span class="s1">h</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.7</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">0.6</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.3</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">0.4</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.65</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">0.4</span><span class="s2">])</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, [</span><span class="s1">w </span><span class="s2">* </span><span class="s4">0.7</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sub_figs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">].</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, [</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">* </span><span class="s4">0.4</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_subfigure_remove</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">sfs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">sfs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">].</span><span class="s1">remove</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigs</span><span class="s2">) == </span><span class="s4">3</span>


<span class="s0">def </span><span class="s1">test_add_subplot_kwargs</span><span class="s2">():</span>
    <span class="s5"># fig.add_subplot() always creates new axes, even if axes kwargs differ.</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">ax1 </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'polar'</span><span class="s2">)</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'polar'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">ax1 </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'polar'</span><span class="s2">)</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'rectilinear'</span>
    <span class="s0">assert </span><span class="s1">ax1 </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_add_axes_kwargs</span><span class="s2">():</span>
    <span class="s5"># fig.add_axes() always creates new axes, even if axes kwargs differ.</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">ax </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">ax1 </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'polar'</span><span class="s2">)</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'polar'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">ax1 </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">projection</span><span class="s2">=</span><span class="s3">'polar'</span><span class="s2">)</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">ax </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'rectilinear'</span>
    <span class="s0">assert </span><span class="s1">ax1 </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_ginput</span><span class="s2">(</span><span class="s1">recwarn</span><span class="s2">):  </span><span class="s5"># recwarn undoes warn filters at exit.</span>
    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore&quot;</span><span class="s2">, </span><span class="s3">&quot;cannot show the figure&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span>

    <span class="s0">def </span><span class="s1">single_press</span><span class="s2">():</span>
        <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">trans</span><span class="s2">((</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.2</span><span class="s2">)), </span><span class="s4">1</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s1">Timer</span><span class="s2">(</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">single_press</span><span class="s2">).</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ginput</span><span class="s2">() == [(</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.2</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">multi_presses</span><span class="s2">():</span>
        <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">trans</span><span class="s2">((</span><span class="s4">.1</span><span class="s2">, </span><span class="s4">.2</span><span class="s2">)), </span><span class="s4">1</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
        <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;backspace&quot;</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
        <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">trans</span><span class="s2">((</span><span class="s4">.3</span><span class="s2">, </span><span class="s4">.4</span><span class="s2">)), </span><span class="s4">1</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
        <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">trans</span><span class="s2">((</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.6</span><span class="s2">)), </span><span class="s4">1</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
        <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">trans</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), </span><span class="s4">2</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s1">Timer</span><span class="s2">(</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">multi_presses</span><span class="s2">).</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">ginput</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), [(</span><span class="s4">.3</span><span class="s2">, </span><span class="s4">.4</span><span class="s2">), (</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.6</span><span class="s2">)])</span>


<span class="s0">def </span><span class="s1">test_waitforbuttonpress</span><span class="s2">(</span><span class="s1">recwarn</span><span class="s2">):  </span><span class="s5"># recwarn undoes warn filters at exit.</span>
    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore&quot;</span><span class="s2">, </span><span class="s3">&quot;cannot show the figure&quot;</span><span class="s2">)</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">waitforbuttonpress</span><span class="s2">(</span><span class="s1">timeout</span><span class="s2">=</span><span class="s4">.1</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s1">Timer</span><span class="s2">(</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">).</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">waitforbuttonpress</span><span class="s2">() </span><span class="s0">is True</span>
    <span class="s1">Timer</span><span class="s2">(</span><span class="s4">.1</span><span class="s2">, </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">).</span><span class="s1">start</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">waitforbuttonpress</span><span class="s2">() </span><span class="s0">is False</span>


<span class="s0">def </span><span class="s1">test_kwargs_pass</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">label</span><span class="s2">=</span><span class="s3">'whole Figure'</span><span class="s2">)</span>
    <span class="s1">sub_fig </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s3">'sub figure'</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_label</span><span class="s2">() == </span><span class="s3">'whole Figure'</span>
    <span class="s0">assert </span><span class="s1">sub_fig</span><span class="s2">.</span><span class="s1">get_label</span><span class="s2">() == </span><span class="s3">'sub figure'</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_rcparams</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">supxlabel</span><span class="s2">(</span><span class="s3">&quot;xlabel&quot;</span><span class="s2">, </span><span class="s1">weight</span><span class="s2">=</span><span class="s3">'bold'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">15</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">supylabel</span><span class="s2">(</span><span class="s3">&quot;ylabel&quot;</span><span class="s2">, </span><span class="s1">weight</span><span class="s2">=</span><span class="s3">'bold'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">15</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">&quot;Title&quot;</span><span class="s2">, </span><span class="s1">weight</span><span class="s2">=</span><span class="s3">'light'</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">20</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s3">'figure.labelweight'</span><span class="s2">: </span><span class="s3">'bold'</span><span class="s2">,</span>
                         <span class="s3">'figure.labelsize'</span><span class="s2">: </span><span class="s4">15</span><span class="s2">,</span>
                         <span class="s3">'figure.titleweight'</span><span class="s2">: </span><span class="s3">'light'</span><span class="s2">,</span>
                         <span class="s3">'figure.titlesize'</span><span class="s2">: </span><span class="s4">20</span><span class="s2">}):</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">supxlabel</span><span class="s2">(</span><span class="s3">&quot;xlabel&quot;</span><span class="s2">)</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">supylabel</span><span class="s2">(</span><span class="s3">&quot;ylabel&quot;</span><span class="s2">)</span>
        <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">&quot;Title&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_deepcopy</span><span class="s2">():</span>
    <span class="s1">fig1</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s3">'log'</span><span class="s2">)</span>

    <span class="s1">fig2 </span><span class="s2">= </span><span class="s1">copy</span><span class="s2">.</span><span class="s1">deepcopy</span><span class="s2">(</span><span class="s1">fig1</span><span class="s2">)</span>

    <span class="s5"># Make sure it is a new object</span>
    <span class="s0">assert </span><span class="s1">fig2</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is not </span><span class="s1">ax</span>
    <span class="s5"># And that the axis scale got propagated</span>
    <span class="s0">assert </span><span class="s1">fig2</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">get_yscale</span><span class="s2">() == </span><span class="s3">'log'</span>
    <span class="s5"># Update the deepcopy and check the original isn't modified</span>
    <span class="s1">fig2</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s3">'linear'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_yscale</span><span class="s2">() == </span><span class="s3">'log'</span>

    <span class="s5"># And test the limits of the axes don't get propagated</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s4">1e-1</span><span class="s2">, </span><span class="s4">1e2</span><span class="s2">)</span>
    <span class="s5"># Draw these to make sure limits are updated</span>
    <span class="s1">fig1</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">fig2</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == (</span><span class="s4">1e-1</span><span class="s2">, </span><span class="s4">1e2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig2</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">get_xlim</span><span class="s2">() == (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_unpickle_with_device_pixel_ratio</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">dpi</span><span class="s2">=</span><span class="s4">42</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">_set_device_pixel_ratio</span><span class="s2">(</span><span class="s4">7</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">== </span><span class="s4">42</span><span class="s2">*</span><span class="s4">7</span>
    <span class="s1">fig2 </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">fig2</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">== </span><span class="s4">42</span>


<span class="s0">def </span><span class="s1">test_gridspec_no_mutate_input</span><span class="s2">():</span>
    <span class="s1">gs </span><span class="s2">= {</span><span class="s3">'left'</span><span class="s2">: </span><span class="s4">.1</span><span class="s2">}</span>
    <span class="s1">gs_orig </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">width_ratios</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">gridspec_kw</span><span class="s2">=</span><span class="s1">gs</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">gs </span><span class="s2">== </span><span class="s1">gs_orig</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot_mosaic</span><span class="s2">(</span><span class="s3">'AB'</span><span class="s2">, </span><span class="s1">width_ratios</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">gridspec_kw</span><span class="s2">=</span><span class="s1">gs</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'fmt'</span><span class="s2">, [</span><span class="s3">'eps'</span><span class="s2">, </span><span class="s3">'pdf'</span><span class="s2">, </span><span class="s3">'png'</span><span class="s2">, </span><span class="s3">'ps'</span><span class="s2">, </span><span class="s3">'svg'</span><span class="s2">, </span><span class="s3">'svgz'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_savefig_metadata</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">):</span>
    <span class="s1">Figure</span><span class="s2">().</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">={})</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'fmt'</span><span class="s2">, [</span><span class="s3">'jpeg'</span><span class="s2">, </span><span class="s3">'jpg'</span><span class="s2">, </span><span class="s3">'tif'</span><span class="s2">, </span><span class="s3">'tiff'</span><span class="s2">, </span><span class="s3">'webp'</span><span class="s2">, </span><span class="s3">&quot;raw&quot;</span><span class="s2">, </span><span class="s3">&quot;rgba&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_savefig_metadata_error</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;metadata not supported&quot;</span><span class="s2">):</span>
        <span class="s1">Figure</span><span class="s2">().</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">={})</span>


<span class="s0">def </span><span class="s1">test_get_constrained_layout_pads</span><span class="s2">():</span>
    <span class="s1">params </span><span class="s2">= {</span><span class="s3">'w_pad'</span><span class="s2">: </span><span class="s4">0.01</span><span class="s2">, </span><span class="s3">'h_pad'</span><span class="s2">: </span><span class="s4">0.02</span><span class="s2">, </span><span class="s3">'wspace'</span><span class="s2">: </span><span class="s4">0.03</span><span class="s2">, </span><span class="s3">'hspace'</span><span class="s2">: </span><span class="s4">0.04</span><span class="s2">}</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">([*</span><span class="s1">params</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()])</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">layout_engine</span><span class="s2">.</span><span class="s1">ConstrainedLayoutEngine</span><span class="s2">(**</span><span class="s1">params</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PendingDeprecationWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;will be deprecated&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout_pads</span><span class="s2">() == </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_not_visible_figure</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">()</span>

    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">StringIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'svg'</span><span class="s2">)</span>
    <span class="s1">buf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">'&lt;g ' </span><span class="s0">in </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_visible</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">StringIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'svg'</span><span class="s2">)</span>
    <span class="s1">buf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">'&lt;g ' </span><span class="s0">not in </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_warn_colorbar_mismatch</span><span class="s2">():</span>
    <span class="s1">fig1</span><span class="s2">, </span><span class="s1">ax1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">fig2</span><span class="s2">, (</span><span class="s1">ax2_1</span><span class="s2">, </span><span class="s1">ax2_2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">im </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

    <span class="s1">fig1</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">)  </span><span class="s5"># should not warn</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different Figure&quot;</span><span class="s2">):</span>
        <span class="s1">fig2</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">)</span>
    <span class="s5"># warn mismatch even when the host figure is not inferred</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different Figure&quot;</span><span class="s2">):</span>
        <span class="s1">fig2</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different Figure&quot;</span><span class="s2">):</span>
        <span class="s1">fig2</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax2_1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different Figure&quot;</span><span class="s2">):</span>
        <span class="s1">fig2</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">cax</span><span class="s2">=</span><span class="s1">ax2_2</span><span class="s2">)</span>

    <span class="s5"># edge case: only compare top level artist in case of subfigure</span>
    <span class="s1">fig3 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig4 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">subfig3_1 </span><span class="s2">= </span><span class="s1">fig3</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s1">subfig3_2 </span><span class="s2">= </span><span class="s1">fig3</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s1">subfig4_1 </span><span class="s2">= </span><span class="s1">fig4</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s1">ax3_1 </span><span class="s2">= </span><span class="s1">subfig3_1</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax3_2 </span><span class="s2">= </span><span class="s1">subfig3_1</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax4_1 </span><span class="s2">= </span><span class="s1">subfig4_1</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">im3_1 </span><span class="s2">= </span><span class="s1">ax3_1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
    <span class="s1">im3_2 </span><span class="s2">= </span><span class="s1">ax3_2</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
    <span class="s1">im4_1 </span><span class="s2">= </span><span class="s1">ax4_1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

    <span class="s1">fig3</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im3_1</span><span class="s2">)   </span><span class="s5"># should not warn</span>
    <span class="s1">subfig3_1</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im3_1</span><span class="s2">)   </span><span class="s5"># should not warn</span>
    <span class="s1">subfig3_1</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im3_2</span><span class="s2">)   </span><span class="s5"># should not warn</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;different Figure&quot;</span><span class="s2">):</span>
        <span class="s1">subfig3_1</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im4_1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_subfigure_stale_propagation</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>

    <span class="s1">sfig1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>
    <span class="s0">assert not </span><span class="s1">sfig1</span><span class="s2">.</span><span class="s1">stale</span>

    <span class="s1">sfig2 </span><span class="s2">= </span><span class="s1">sfig1</span><span class="s2">.</span><span class="s1">subfigures</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>
    <span class="s0">assert not </span><span class="s1">sfig2</span><span class="s2">.</span><span class="s1">stale</span>

    <span class="s1">sfig2</span><span class="s2">.</span><span class="s1">stale </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">stale</span>
</pre>
</body>
</html>