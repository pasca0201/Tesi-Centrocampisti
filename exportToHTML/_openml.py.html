<html>
<head>
<title>_openml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_openml.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">gzip</span>
<span class="s0">import </span><span class="s1">hashlib</span>
<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">closing</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">wraps</span>
<span class="s0">from </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">join</span>
<span class="s0">from </span><span class="s1">tempfile </span><span class="s0">import </span><span class="s1">TemporaryDirectory</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Callable</span><span class="s2">, </span><span class="s1">Dict</span><span class="s2">, </span><span class="s1">List</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">Tuple</span><span class="s2">, </span><span class="s1">Union</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">error </span><span class="s0">import </span><span class="s1">HTTPError</span><span class="s2">, </span><span class="s1">URLError</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">request </span><span class="s0">import </span><span class="s1">Request</span><span class="s2">, </span><span class="s1">urlopen</span>
<span class="s0">from </span><span class="s1">warnings </span><span class="s0">import </span><span class="s1">warn</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s2">..</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">Bunch</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_optional_dependencies </span><span class="s0">import </span><span class="s1">check_pandas_support  </span><span class="s3"># noqa</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_param_validation </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Integral</span><span class="s2">,</span>
    <span class="s1">Interval</span><span class="s2">,</span>
    <span class="s1">Real</span><span class="s2">,</span>
    <span class="s1">StrOptions</span><span class="s2">,</span>
    <span class="s1">validate_params</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">get_data_home</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">_arff_parser </span><span class="s0">import </span><span class="s1">load_arff_from_gzip_file</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s4">&quot;fetch_openml&quot;</span><span class="s2">]</span>

<span class="s1">_OPENML_PREFIX </span><span class="s2">= </span><span class="s4">&quot;https://api.openml.org/&quot;</span>
<span class="s1">_SEARCH_NAME </span><span class="s2">= </span><span class="s4">&quot;api/v1/json/data/list/data_name/{}/limit/2&quot;</span>
<span class="s1">_DATA_INFO </span><span class="s2">= </span><span class="s4">&quot;api/v1/json/data/{}&quot;</span>
<span class="s1">_DATA_FEATURES </span><span class="s2">= </span><span class="s4">&quot;api/v1/json/data/features/{}&quot;</span>
<span class="s1">_DATA_QUALITIES </span><span class="s2">= </span><span class="s4">&quot;api/v1/json/data/qualities/{}&quot;</span>
<span class="s1">_DATA_FILE </span><span class="s2">= </span><span class="s4">&quot;data/v1/download/{}&quot;</span>

<span class="s1">OpenmlQualitiesType </span><span class="s2">= </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]]</span>
<span class="s1">OpenmlFeaturesType </span><span class="s2">= </span><span class="s1">List</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]]</span>


<span class="s0">def </span><span class="s1">_get_local_path</span><span class="s2">(</span><span class="s1">openml_path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">data_home</span><span class="s2">, </span><span class="s4">&quot;openml.org&quot;</span><span class="s2">, </span><span class="s1">openml_path </span><span class="s2">+ </span><span class="s4">&quot;.gz&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_retry_with_clean_cache</span><span class="s2">(</span>
    <span class="s1">openml_path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">no_retry_exception</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Exception</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;If the first call to the decorated function fails, the local cached 
    file is removed, and the function is called again. If ``data_home`` is 
    ``None``, then the function is called once. We can provide a specific 
    exception to not retry on using `no_retry_exception` parameter. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">data_home </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">URLError</span><span class="s2">:</span>
                <span class="s0">raise</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">no_retry_exception </span><span class="s0">is not None and </span><span class="s1">isinstance</span><span class="s2">(</span>
                    <span class="s1">exc</span><span class="s2">, </span><span class="s1">no_retry_exception</span>
                <span class="s2">):</span>
                    <span class="s0">raise</span>
                <span class="s1">warn</span><span class="s2">(</span><span class="s4">&quot;Invalid cache, redownloading file&quot;</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
                <span class="s1">local_path </span><span class="s2">= </span><span class="s1">_get_local_path</span><span class="s2">(</span><span class="s1">openml_path</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">):</span>
                    <span class="s1">os</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">)</span>
                <span class="s0">return </span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kw</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">wrapper</span>

    <span class="s0">return </span><span class="s1">decorator</span>


<span class="s0">def </span><span class="s1">_retry_on_network_error</span><span class="s2">(</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">, </span><span class="s1">url</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s4">&quot;&quot;</span>
<span class="s2">) </span><span class="s1">-&gt; Callable</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;If the function call results in a network error, call the function again 
    up to ``n_retries`` times with a ``delay`` between each call. If the error 
    has a 412 status code, don't call the function again as this is a specific 
    OpenML error. 
    The url parameter is used to give more information to the user about the 
    error. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
        <span class="s2">@</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">retry_counter </span><span class="s2">= </span><span class="s1">n_retries</span>
            <span class="s0">while True</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s2">(</span><span class="s1">URLError</span><span class="s2">, </span><span class="s1">TimeoutError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                    <span class="s3"># 412 is a specific OpenML error code.</span>
                    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">HTTPError</span><span class="s2">) </span><span class="s0">and </span><span class="s1">e</span><span class="s2">.</span><span class="s1">code </span><span class="s2">== </span><span class="s6">412</span><span class="s2">:</span>
                        <span class="s0">raise</span>
                    <span class="s0">if </span><span class="s1">retry_counter </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
                        <span class="s0">raise</span>
                    <span class="s1">warn</span><span class="s2">(</span>
                        <span class="s4">f&quot;A network error occurred while downloading </span><span class="s0">{</span><span class="s1">url</span><span class="s0">}</span><span class="s4">. Retrying...&quot;</span>
                    <span class="s2">)</span>
                    <span class="s1">retry_counter </span><span class="s2">-= </span><span class="s6">1</span>
                    <span class="s1">time</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s1">delay</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">wrapper</span>

    <span class="s0">return </span><span class="s1">decorator</span>


<span class="s0">def </span><span class="s1">_open_openml_url</span><span class="s2">(</span>
    <span class="s1">openml_path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">], </span><span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Returns a resource from OpenML.org. Caches it to data_home if required. 
 
    Parameters 
    ---------- 
    openml_path : str 
        OpenML URL that will be accessed. This will be prefixes with 
        _OPENML_PREFIX. 
 
    data_home : str 
        Directory to which the files will be cached. If None, no caching will 
        be applied. 
 
    n_retries : int, default=3 
        Number of retries when HTTP errors are encountered. Error with status 
        code 412 won't be retried as they represent OpenML generic errors. 
 
    delay : float, default=1.0 
        Number of seconds between retries. 
 
    Returns 
    ------- 
    result : stream 
        A stream to the OpenML resource. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">is_gzip_encoded</span><span class="s2">(</span><span class="s1">_fsrc</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_fsrc</span><span class="s2">.</span><span class="s1">info</span><span class="s2">().</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;Content-Encoding&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">) == </span><span class="s4">&quot;gzip&quot;</span>

    <span class="s1">req </span><span class="s2">= </span><span class="s1">Request</span><span class="s2">(</span><span class="s1">_OPENML_PREFIX </span><span class="s2">+ </span><span class="s1">openml_path</span><span class="s2">)</span>
    <span class="s1">req</span><span class="s2">.</span><span class="s1">add_header</span><span class="s2">(</span><span class="s4">&quot;Accept-encoding&quot;</span><span class="s2">, </span><span class="s4">&quot;gzip&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">data_home </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">fsrc </span><span class="s2">= </span><span class="s1">_retry_on_network_error</span><span class="s2">(</span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">, </span><span class="s1">req</span><span class="s2">.</span><span class="s1">full_url</span><span class="s2">)(</span><span class="s1">urlopen</span><span class="s2">)(</span><span class="s1">req</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_gzip_encoded</span><span class="s2">(</span><span class="s1">fsrc</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">GzipFile</span><span class="s2">(</span><span class="s1">fileobj</span><span class="s2">=</span><span class="s1">fsrc</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;rb&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">fsrc</span>

    <span class="s1">local_path </span><span class="s2">= </span><span class="s1">_get_local_path</span><span class="s2">(</span><span class="s1">openml_path</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">)</span>
    <span class="s1">dir_name</span><span class="s2">, </span><span class="s1">file_name </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">):</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">makedirs</span><span class="s2">(</span><span class="s1">dir_name</span><span class="s2">, </span><span class="s1">exist_ok</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># Create a tmpdir as a subfolder of dir_name where the final file will</span>
            <span class="s3"># be moved to if the download is successful. This guarantees that the</span>
            <span class="s3"># renaming operation to the final location is atomic to ensure the</span>
            <span class="s3"># concurrence safety of the dataset caching mechanism.</span>
            <span class="s0">with </span><span class="s1">TemporaryDirectory</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">=</span><span class="s1">dir_name</span><span class="s2">) </span><span class="s0">as </span><span class="s1">tmpdir</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span>
                    <span class="s1">_retry_on_network_error</span><span class="s2">(</span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">, </span><span class="s1">req</span><span class="s2">.</span><span class="s1">full_url</span><span class="s2">)(</span><span class="s1">urlopen</span><span class="s2">)(</span>
                        <span class="s1">req</span>
                    <span class="s2">)</span>
                <span class="s2">) </span><span class="s0">as </span><span class="s1">fsrc</span><span class="s2">:</span>
                    <span class="s1">opener</span><span class="s2">: </span><span class="s1">Callable</span>
                    <span class="s0">if </span><span class="s1">is_gzip_encoded</span><span class="s2">(</span><span class="s1">fsrc</span><span class="s2">):</span>
                        <span class="s1">opener </span><span class="s2">= </span><span class="s1">open</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">opener </span><span class="s2">= </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">GzipFile</span>
                    <span class="s0">with </span><span class="s1">opener</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">file_name</span><span class="s2">), </span><span class="s4">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fdst</span><span class="s2">:</span>
                        <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfileobj</span><span class="s2">(</span><span class="s1">fsrc</span><span class="s2">, </span><span class="s1">fdst</span><span class="s2">)</span>
                <span class="s1">shutil</span><span class="s2">.</span><span class="s1">move</span><span class="s2">(</span><span class="s1">fdst</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">local_path</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">):</span>
                <span class="s1">os</span><span class="s2">.</span><span class="s1">unlink</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">)</span>
            <span class="s0">raise</span>

    <span class="s3"># XXX: First time, decompression will not be necessary (by using fsrc), but</span>
    <span class="s3"># it will happen nonetheless</span>
    <span class="s0">return </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">GzipFile</span><span class="s2">(</span><span class="s1">local_path</span><span class="s2">, </span><span class="s4">&quot;rb&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">OpenMLError</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;HTTP 412 is a specific OpenML error code, indicating a generic error&quot;&quot;&quot;</span>

    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">error_message</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Dict</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot; 
    Loads json data from the openml api. 
 
    Parameters 
    ---------- 
    url : str 
        The URL to load from. Should be an official OpenML endpoint. 
 
    error_message : str or None 
        The error message to raise if an acceptable OpenML error is thrown 
        (acceptable error is, e.g., data id not found. Other errors, like 404's 
        will throw the native error message). 
 
    data_home : str or None 
        Location to cache the response. None if no cache is required. 
 
    n_retries : int, default=3 
        Number of retries when HTTP errors are encountered. Error with status 
        code 412 won't be retried as they represent OpenML generic errors. 
 
    delay : float, default=1.0 
        Number of seconds between retries. 
 
    Returns 
    ------- 
    json_data : json 
        the json result from the OpenML server if the call was successful. 
        An exception otherwise. 
    &quot;&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">_retry_with_clean_cache</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">_load_json</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span>
            <span class="s1">_open_openml_url</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">)</span>
        <span class="s2">) </span><span class="s0">as </span><span class="s1">response</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">json</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">response</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">))</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">_load_json</span><span class="s2">()</span>
    <span class="s0">except </span><span class="s1">HTTPError </span><span class="s0">as </span><span class="s1">error</span><span class="s2">:</span>
        <span class="s3"># 412 is an OpenML specific error code, indicating a generic error</span>
        <span class="s3"># (e.g., data not found)</span>
        <span class="s0">if </span><span class="s1">error</span><span class="s2">.</span><span class="s1">code </span><span class="s2">!= </span><span class="s6">412</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">error</span>

    <span class="s3"># 412 error, not in except for nicer traceback</span>
    <span class="s0">raise </span><span class="s1">OpenMLError</span><span class="s2">(</span><span class="s1">error_message</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_get_data_info_by_name</span><span class="s2">(</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">int</span><span class="s2">, </span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Utilizes the openml dataset listing api to find a dataset by 
    name/version 
    OpenML api function: 
    https://www.openml.org/api_docs#!/data/get_data_list_data_name_data_name 
 
    Parameters 
    ---------- 
    name : str 
        name of the dataset 
 
    version : int or str 
        If version is an integer, the exact name/version will be obtained from 
        OpenML. If version is a string (value: &quot;active&quot;) it will take the first 
        version from OpenML that is annotated as active. Any other string 
        values except &quot;active&quot; are treated as integer. 
 
    data_home : str or None 
        Location to cache the response. None if no cache is required. 
 
    n_retries : int, default=3 
        Number of retries when HTTP errors are encountered. Error with status 
        code 412 won't be retried as they represent OpenML generic errors. 
 
    delay : float, default=1.0 
        Number of seconds between retries. 
 
    Returns 
    ------- 
    first_dataset : json 
        json representation of the first dataset object that adhired to the 
        search criteria 
 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">version </span><span class="s2">== </span><span class="s4">&quot;active&quot;</span><span class="s2">:</span>
        <span class="s3"># situation in which we return the oldest active version</span>
        <span class="s1">url </span><span class="s2">= </span><span class="s1">_SEARCH_NAME</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) + </span><span class="s4">&quot;/status/active/&quot;</span>
        <span class="s1">error_msg </span><span class="s2">= </span><span class="s4">&quot;No active dataset {} found.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">json_data </span><span class="s2">= </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
            <span class="s1">url</span><span class="s2">,</span>
            <span class="s1">error_msg</span><span class="s2">,</span>
            <span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">,</span>
            <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
            <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">json_data</span><span class="s2">[</span><span class="s4">&quot;data&quot;</span><span class="s2">][</span><span class="s4">&quot;dataset&quot;</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">first_version </span><span class="s2">= </span><span class="s1">version </span><span class="s2">= </span><span class="s1">res</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][</span><span class="s4">&quot;version&quot;</span><span class="s2">]</span>
            <span class="s1">warning_msg </span><span class="s2">= (</span>
                <span class="s4">&quot;Multiple active versions of the dataset matching the name&quot;</span>
                <span class="s4">f&quot; </span><span class="s0">{</span><span class="s1">name</span><span class="s0">} </span><span class="s4">exist. Versions may be fundamentally different, &quot;</span>
                <span class="s4">f&quot;returning version </span><span class="s0">{</span><span class="s1">first_version</span><span class="s0">}</span><span class="s4">. &quot;</span>
                <span class="s4">&quot;Available versions:</span><span class="s0">\n</span><span class="s4">&quot;</span>
            <span class="s2">)</span>
            <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">res</span><span class="s2">:</span>
                <span class="s1">warning_msg </span><span class="s2">+= </span><span class="s4">f&quot;- version </span><span class="s0">{</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'version'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">, status: </span><span class="s0">{</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'status'</span><span class="s2">]</span><span class="s0">}\n</span><span class="s4">&quot;</span>
                <span class="s1">warning_msg </span><span class="s2">+= (</span>
                    <span class="s4">f&quot;  url: https://www.openml.org/search?type=data&amp;id=</span><span class="s0">{</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'did'</span><span class="s2">]</span><span class="s0">}\n</span><span class="s4">&quot;</span>
                <span class="s2">)</span>
            <span class="s1">warn</span><span class="s2">(</span><span class="s1">warning_msg</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

    <span class="s3"># an integer version has been provided</span>
    <span class="s1">url </span><span class="s2">= (</span><span class="s1">_SEARCH_NAME </span><span class="s2">+ </span><span class="s4">&quot;/data_version/{}&quot;</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">json_data </span><span class="s2">= </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
            <span class="s1">url</span><span class="s2">,</span>
            <span class="s1">error_message</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
            <span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">,</span>
            <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
            <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">OpenMLError</span><span class="s2">:</span>
        <span class="s3"># we can do this in 1 function call if OpenML does not require the</span>
        <span class="s3"># specification of the dataset status (i.e., return datasets with a</span>
        <span class="s3"># given name / version regardless of active, deactivated, etc. )</span>
        <span class="s3"># TODO: feature request OpenML.</span>
        <span class="s1">url </span><span class="s2">+= </span><span class="s4">&quot;/status/deactivated&quot;</span>
        <span class="s1">error_msg </span><span class="s2">= </span><span class="s4">&quot;Dataset {} with version {} not found.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
        <span class="s1">json_data </span><span class="s2">= </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
            <span class="s1">url</span><span class="s2">,</span>
            <span class="s1">error_msg</span><span class="s2">,</span>
            <span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">,</span>
            <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
            <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">return </span><span class="s1">json_data</span><span class="s2">[</span><span class="s4">&quot;data&quot;</span><span class="s2">][</span><span class="s4">&quot;dataset&quot;</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">_get_data_description_by_id</span><span class="s2">(</span>
    <span class="s1">data_id</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">]:</span>
    <span class="s3"># OpenML API function: https://www.openml.org/api_docs#!/data/get_data_id</span>
    <span class="s1">url </span><span class="s2">= </span><span class="s1">_DATA_INFO</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">)</span>
    <span class="s1">error_message </span><span class="s2">= </span><span class="s4">&quot;Dataset with data_id {} not found.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">)</span>
    <span class="s1">json_data </span><span class="s2">= </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
        <span class="s1">url</span><span class="s2">,</span>
        <span class="s1">error_message</span><span class="s2">,</span>
        <span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">,</span>
        <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
        <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">json_data</span><span class="s2">[</span><span class="s4">&quot;data_set_description&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">_get_data_features</span><span class="s2">(</span>
    <span class="s1">data_id</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; OpenmlFeaturesType</span><span class="s2">:</span>
    <span class="s3"># OpenML function:</span>
    <span class="s3"># https://www.openml.org/api_docs#!/data/get_data_features_id</span>
    <span class="s1">url </span><span class="s2">= </span><span class="s1">_DATA_FEATURES</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">)</span>
    <span class="s1">error_message </span><span class="s2">= </span><span class="s4">&quot;Dataset with data_id {} not found.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">)</span>
    <span class="s1">json_data </span><span class="s2">= </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
        <span class="s1">url</span><span class="s2">,</span>
        <span class="s1">error_message</span><span class="s2">,</span>
        <span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">,</span>
        <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
        <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">json_data</span><span class="s2">[</span><span class="s4">&quot;data_features&quot;</span><span class="s2">][</span><span class="s4">&quot;feature&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">_get_data_qualities</span><span class="s2">(</span>
    <span class="s1">data_id</span><span class="s2">: </span><span class="s1">int</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; OpenmlQualitiesType</span><span class="s2">:</span>
    <span class="s3"># OpenML API function:</span>
    <span class="s3"># https://www.openml.org/api_docs#!/data/get_data_qualities_id</span>
    <span class="s1">url </span><span class="s2">= </span><span class="s1">_DATA_QUALITIES</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">)</span>
    <span class="s1">error_message </span><span class="s2">= </span><span class="s4">&quot;Dataset with data_id {} not found.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">)</span>
    <span class="s1">json_data </span><span class="s2">= </span><span class="s1">_get_json_content_from_openml_api</span><span class="s2">(</span>
        <span class="s1">url</span><span class="s2">,</span>
        <span class="s1">error_message</span><span class="s2">,</span>
        <span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">,</span>
        <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
        <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s3"># the qualities might not be available, but we still try to process</span>
    <span class="s3"># the data</span>
    <span class="s0">return </span><span class="s1">json_data</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;data_qualities&quot;</span><span class="s2">, {}).</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;quality&quot;</span><span class="s2">, [])</span>


<span class="s0">def </span><span class="s1">_get_num_samples</span><span class="s2">(</span><span class="s1">data_qualities</span><span class="s2">: </span><span class="s1">OpenmlQualitiesType</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
    <span class="s5">&quot;&quot;&quot;Get the number of samples from data qualities. 
 
    Parameters 
    ---------- 
    data_qualities : list of dict 
        Used to retrieve the number of instances (samples) in the dataset. 
 
    Returns 
    ------- 
    n_samples : int 
        The number of samples in the dataset or -1 if data qualities are 
        unavailable. 
    &quot;&quot;&quot;</span>
    <span class="s3"># If the data qualities are unavailable, we return -1</span>
    <span class="s1">default_n_samples </span><span class="s2">= -</span><span class="s6">1</span>

    <span class="s1">qualities </span><span class="s2">= {</span><span class="s1">d</span><span class="s2">[</span><span class="s4">&quot;name&quot;</span><span class="s2">]: </span><span class="s1">d</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">data_qualities</span><span class="s2">}</span>
    <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">qualities</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;NumberOfInstances&quot;</span><span class="s2">, </span><span class="s1">default_n_samples</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">_load_arff_response</span><span class="s2">(</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">parser</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">output_type</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">openml_columns_info</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">,</span>
    <span class="s1">feature_names_to_select</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">target_names_to_select</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">shape</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">int</span><span class="s2">, </span><span class="s1">int</span><span class="s2">]],</span>
    <span class="s1">md5_checksum</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
    <span class="s1">read_csv_kwargs</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Load the ARFF data associated with the OpenML URL. 
 
    In addition of loading the data, this function will also check the 
    integrity of the downloaded file from OpenML using MD5 checksum. 
 
    Parameters 
    ---------- 
    url : str 
        The URL of the ARFF file on OpenML. 
 
    data_home : str 
        The location where to cache the data. 
 
    parser : {&quot;liac-arff&quot;, &quot;pandas&quot;} 
        The parser used to parse the ARFF file. 
 
    output_type : {&quot;numpy&quot;, &quot;pandas&quot;, &quot;sparse&quot;} 
        The type of the arrays that will be returned. The possibilities are: 
 
        - `&quot;numpy&quot;`: both `X` and `y` will be NumPy arrays; 
        - `&quot;sparse&quot;`: `X` will be sparse matrix and `y` will be a NumPy array; 
        - `&quot;pandas&quot;`: `X` will be a pandas DataFrame and `y` will be either a 
          pandas Series or DataFrame. 
 
    openml_columns_info : dict 
        The information provided by OpenML regarding the columns of the ARFF 
        file. 
 
    feature_names_to_select : list of str 
        The list of the features to be selected. 
 
    target_names_to_select : list of str 
        The list of the target variables to be selected. 
 
    shape : tuple or None 
        With `parser=&quot;liac-arff&quot;`, when using a generator to load the data, 
        one needs to provide the shape of the data beforehand. 
 
    md5_checksum : str 
        The MD5 checksum provided by OpenML to check the data integrity. 
 
    n_retries : int, default=3 
        The number of times to retry downloading the data if it fails. 
 
    delay : float, default=1.0 
        The delay between two consecutive downloads in seconds. 
 
    read_csv_kwargs : dict, default=None 
        Keyword arguments to pass to `pandas.read_csv` when using the pandas parser. 
        It allows to overwrite the default options. 
 
        .. versionadded:: 1.3 
 
    Returns 
    ------- 
    X : {ndarray, sparse matrix, dataframe} 
        The data matrix. 
 
    y : {ndarray, dataframe, series} 
        The target. 
 
    frame : dataframe or None 
        A dataframe containing both `X` and `y`. `None` if 
        `output_array_type != &quot;pandas&quot;`. 
 
    categories : list of str or None 
        The names of the features that are categorical. `None` if 
        `output_array_type == &quot;pandas&quot;`. 
    &quot;&quot;&quot;</span>
    <span class="s1">gzip_file </span><span class="s2">= </span><span class="s1">_open_openml_url</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span><span class="s1">gzip_file</span><span class="s2">):</span>
        <span class="s1">md5 </span><span class="s2">= </span><span class="s1">hashlib</span><span class="s2">.</span><span class="s1">md5</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">iter</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">gzip_file</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s6">4096</span><span class="s2">), </span><span class="s7">b&quot;&quot;</span><span class="s2">):</span>
            <span class="s1">md5</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">)</span>
        <span class="s1">actual_md5_checksum </span><span class="s2">= </span><span class="s1">md5</span><span class="s2">.</span><span class="s1">hexdigest</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">actual_md5_checksum </span><span class="s2">!= </span><span class="s1">md5_checksum</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s4">f&quot;md5 checksum of local file for </span><span class="s0">{</span><span class="s1">url</span><span class="s0">} </span><span class="s4">does not match description: &quot;</span>
            <span class="s4">f&quot;expected: </span><span class="s0">{</span><span class="s1">md5_checksum</span><span class="s0">} </span><span class="s4">but got </span><span class="s0">{</span><span class="s1">actual_md5_checksum</span><span class="s0">}</span><span class="s4">. &quot;</span>
            <span class="s4">&quot;Downloaded file could have been modified / corrupted, clean cache &quot;</span>
            <span class="s4">&quot;and retry...&quot;</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_open_url_and_load_gzip_file</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">, </span><span class="s1">arff_params</span><span class="s2">):</span>
        <span class="s1">gzip_file </span><span class="s2">= </span><span class="s1">_open_openml_url</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span><span class="s1">gzip_file</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">load_arff_from_gzip_file</span><span class="s2">(</span><span class="s1">gzip_file</span><span class="s2">, **</span><span class="s1">arff_params</span><span class="s2">)</span>

    <span class="s1">arff_params</span><span class="s2">: </span><span class="s1">Dict </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">output_type</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">,</span>
        <span class="s1">openml_columns_info</span><span class="s2">=</span><span class="s1">openml_columns_info</span><span class="s2">,</span>
        <span class="s1">feature_names_to_select</span><span class="s2">=</span><span class="s1">feature_names_to_select</span><span class="s2">,</span>
        <span class="s1">target_names_to_select</span><span class="s2">=</span><span class="s1">target_names_to_select</span><span class="s2">,</span>
        <span class="s1">shape</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s1">read_csv_kwargs</span><span class="s2">=</span><span class="s1">read_csv_kwargs </span><span class="s0">or </span><span class="s2">{},</span>
    <span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">categories </span><span class="s2">= </span><span class="s1">_open_url_and_load_gzip_file</span><span class="s2">(</span>
            <span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">, </span><span class="s1">arff_params</span>
        <span class="s2">)</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">parser </span><span class="s2">!= </span><span class="s4">&quot;pandas&quot;</span><span class="s2">:</span>
            <span class="s0">raise</span>

        <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">ParserError</span>

        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ParserError</span><span class="s2">):</span>
            <span class="s0">raise</span>

        <span class="s3"># A parsing error could come from providing the wrong quotechar</span>
        <span class="s3"># to pandas. By default, we use a double quote. Thus, we retry</span>
        <span class="s3"># with a single quote before to raise the error.</span>
        <span class="s1">arff_params</span><span class="s2">[</span><span class="s4">&quot;read_csv_kwargs&quot;</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">quotechar</span><span class="s2">=</span><span class="s4">&quot;'&quot;</span><span class="s2">)</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">categories </span><span class="s2">= </span><span class="s1">_open_url_and_load_gzip_file</span><span class="s2">(</span>
            <span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">, </span><span class="s1">arff_params</span>
        <span class="s2">)</span>

    <span class="s0">return </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">categories</span>


<span class="s0">def </span><span class="s1">_download_data_to_bunch</span><span class="s2">(</span>
    <span class="s1">url</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">sparse</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s2">*,</span>
    <span class="s1">as_frame</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">,</span>
    <span class="s1">openml_columns_info</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">dict</span><span class="s2">],</span>
    <span class="s1">data_columns</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">target_columns</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
    <span class="s1">shape</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">int</span><span class="s2">, </span><span class="s1">int</span><span class="s2">]],</span>
    <span class="s1">md5_checksum</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
    <span class="s1">parser</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">read_csv_kwargs</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Download ARFF data, load it to a specific container and create to Bunch. 
 
    This function has a mechanism to retry/cache/clean the data. 
 
    Parameters 
    ---------- 
    url : str 
        The URL of the ARFF file on OpenML. 
 
    sparse : bool 
        Whether the dataset is expected to use the sparse ARFF format. 
 
    data_home : str 
        The location where to cache the data. 
 
    as_frame : bool 
        Whether or not to return the data into a pandas DataFrame. 
 
    openml_columns_info : list of dict 
        The information regarding the columns provided by OpenML for the 
        ARFF dataset. The information is stored as a list of dictionaries. 
 
    data_columns : list of str 
        The list of the features to be selected. 
 
    target_columns : list of str 
        The list of the target variables to be selected. 
 
    shape : tuple or None 
        With `parser=&quot;liac-arff&quot;`, when using a generator to load the data, 
        one needs to provide the shape of the data beforehand. 
 
    md5_checksum : str 
        The MD5 checksum provided by OpenML to check the data integrity. 
 
    n_retries : int, default=3 
        Number of retries when HTTP errors are encountered. Error with status 
        code 412 won't be retried as they represent OpenML generic errors. 
 
    delay : float, default=1.0 
        Number of seconds between retries. 
 
    parser : {&quot;liac-arff&quot;, &quot;pandas&quot;} 
        The parser used to parse the ARFF file. 
 
    read_csv_kwargs : dict, default=None 
        Keyword arguments to pass to `pandas.read_csv` when using the pandas parser. 
        It allows to overwrite the default options. 
 
        .. versionadded:: 1.3 
 
    Returns 
    ------- 
    data : :class:`~sklearn.utils.Bunch` 
        Dictionary-like object, with the following attributes. 
 
        X : {ndarray, sparse matrix, dataframe} 
            The data matrix. 
        y : {ndarray, dataframe, series} 
            The target. 
        frame : dataframe or None 
            A dataframe containing both `X` and `y`. `None` if 
            `output_array_type != &quot;pandas&quot;`. 
        categories : list of str or None 
            The names of the features that are categorical. `None` if 
            `output_array_type == &quot;pandas&quot;`. 
    &quot;&quot;&quot;</span>
    <span class="s3"># Prepare which columns and data types should be returned for the X and y</span>
    <span class="s1">features_dict </span><span class="s2">= {</span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;name&quot;</span><span class="s2">]: </span><span class="s1">feature </span><span class="s0">for </span><span class="s1">feature </span><span class="s0">in </span><span class="s1">openml_columns_info</span><span class="s2">}</span>

    <span class="s0">if </span><span class="s1">sparse</span><span class="s2">:</span>
        <span class="s1">output_type </span><span class="s2">= </span><span class="s4">&quot;sparse&quot;</span>
    <span class="s0">elif </span><span class="s1">as_frame</span><span class="s2">:</span>
        <span class="s1">output_type </span><span class="s2">= </span><span class="s4">&quot;pandas&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">output_type </span><span class="s2">= </span><span class="s4">&quot;numpy&quot;</span>

    <span class="s3"># XXX: target columns should all be categorical or all numeric</span>
    <span class="s1">_verify_target_data_type</span><span class="s2">(</span><span class="s1">features_dict</span><span class="s2">, </span><span class="s1">target_columns</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">target_columns</span><span class="s2">:</span>
        <span class="s1">column_info </span><span class="s2">= </span><span class="s1">features_dict</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]</span>
        <span class="s1">n_missing_values </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">column_info</span><span class="s2">[</span><span class="s4">&quot;number_of_missing_values&quot;</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">n_missing_values </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s4">f&quot;Target column '</span><span class="s0">{</span><span class="s1">column_info</span><span class="s2">[</span><span class="s4">'name'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">' has </span><span class="s0">{</span><span class="s1">n_missing_values</span><span class="s0">} </span><span class="s4">missing &quot;</span>
                <span class="s4">&quot;values. Missing values are not supported for target columns.&quot;</span>
            <span class="s2">)</span>

    <span class="s1">no_retry_exception </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s1">parser </span><span class="s2">== </span><span class="s4">&quot;pandas&quot;</span><span class="s2">:</span>
        <span class="s3"># If we get a ParserError with pandas, then we don't want to retry and we raise</span>
        <span class="s3"># early.</span>
        <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">ParserError</span>

        <span class="s1">no_retry_exception </span><span class="s2">= </span><span class="s1">ParserError</span>

    <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">categories </span><span class="s2">= </span><span class="s1">_retry_with_clean_cache</span><span class="s2">(</span>
        <span class="s1">url</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">no_retry_exception</span>
    <span class="s2">)(</span><span class="s1">_load_arff_response</span><span class="s2">)(</span>
        <span class="s1">url</span><span class="s2">,</span>
        <span class="s1">data_home</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
        <span class="s1">output_type</span><span class="s2">=</span><span class="s1">output_type</span><span class="s2">,</span>
        <span class="s1">openml_columns_info</span><span class="s2">=</span><span class="s1">features_dict</span><span class="s2">,</span>
        <span class="s1">feature_names_to_select</span><span class="s2">=</span><span class="s1">data_columns</span><span class="s2">,</span>
        <span class="s1">target_names_to_select</span><span class="s2">=</span><span class="s1">target_columns</span><span class="s2">,</span>
        <span class="s1">shape</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s1">md5_checksum</span><span class="s2">=</span><span class="s1">md5_checksum</span><span class="s2">,</span>
        <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
        <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
        <span class="s1">read_csv_kwargs</span><span class="s2">=</span><span class="s1">read_csv_kwargs</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">return </span><span class="s1">Bunch</span><span class="s2">(</span>
        <span class="s1">data</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
        <span class="s1">target</span><span class="s2">=</span><span class="s1">y</span><span class="s2">,</span>
        <span class="s1">frame</span><span class="s2">=</span><span class="s1">frame</span><span class="s2">,</span>
        <span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">,</span>
        <span class="s1">feature_names</span><span class="s2">=</span><span class="s1">data_columns</span><span class="s2">,</span>
        <span class="s1">target_names</span><span class="s2">=</span><span class="s1">target_columns</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_verify_target_data_type</span><span class="s2">(</span><span class="s1">features_dict</span><span class="s2">, </span><span class="s1">target_columns</span><span class="s2">):</span>
    <span class="s3"># verifies the data type of the y array in case there are multiple targets</span>
    <span class="s3"># (throws an error if these targets do not comply with sklearn support)</span>
    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target_columns</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;target_column should be list, got: %s&quot; </span><span class="s2">% </span><span class="s1">type</span><span class="s2">(</span><span class="s1">target_columns</span><span class="s2">))</span>
    <span class="s1">found_types </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">target_column </span><span class="s0">in </span><span class="s1">target_columns</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">target_column </span><span class="s0">not in </span><span class="s1">features_dict</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s4">f&quot;Could not find target_column='</span><span class="s0">{</span><span class="s1">target_column</span><span class="s0">}</span><span class="s4">'&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">features_dict</span><span class="s2">[</span><span class="s1">target_column</span><span class="s2">][</span><span class="s4">&quot;data_type&quot;</span><span class="s2">] == </span><span class="s4">&quot;numeric&quot;</span><span class="s2">:</span>
            <span class="s1">found_types</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">found_types</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">object</span><span class="s2">)</span>

        <span class="s3"># note: we compare to a string, not boolean</span>
        <span class="s0">if </span><span class="s1">features_dict</span><span class="s2">[</span><span class="s1">target_column</span><span class="s2">][</span><span class="s4">&quot;is_ignore&quot;</span><span class="s2">] == </span><span class="s4">&quot;true&quot;</span><span class="s2">:</span>
            <span class="s1">warn</span><span class="s2">(</span><span class="s4">f&quot;target_column='</span><span class="s0">{</span><span class="s1">target_column</span><span class="s0">}</span><span class="s4">' has flag is_ignore.&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">features_dict</span><span class="s2">[</span><span class="s1">target_column</span><span class="s2">][</span><span class="s4">&quot;is_row_identifier&quot;</span><span class="s2">] == </span><span class="s4">&quot;true&quot;</span><span class="s2">:</span>
            <span class="s1">warn</span><span class="s2">(</span><span class="s4">f&quot;target_column='</span><span class="s0">{</span><span class="s1">target_column</span><span class="s0">}</span><span class="s4">' has flag is_row_identifier.&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">found_types</span><span class="s2">) &gt; </span><span class="s6">1</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s4">&quot;Can only handle homogeneous multi-target datasets, &quot;</span>
            <span class="s4">&quot;i.e., all targets are either numeric or &quot;</span>
            <span class="s4">&quot;categorical.&quot;</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_valid_data_column_names</span><span class="s2">(</span><span class="s1">features_list</span><span class="s2">, </span><span class="s1">target_columns</span><span class="s2">):</span>
    <span class="s3"># logic for determining on which columns can be learned. Note that from the</span>
    <span class="s3"># OpenML guide follows that columns that have the `is_row_identifier` or</span>
    <span class="s3"># `is_ignore` flag, these can not be learned on. Also target columns are</span>
    <span class="s3"># excluded.</span>
    <span class="s1">valid_data_column_names </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">feature </span><span class="s0">in </span><span class="s1">features_list</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s2">(</span>
            <span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;name&quot;</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">target_columns</span>
            <span class="s0">and </span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;is_ignore&quot;</span><span class="s2">] != </span><span class="s4">&quot;true&quot;</span>
            <span class="s0">and </span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;is_row_identifier&quot;</span><span class="s2">] != </span><span class="s4">&quot;true&quot;</span>
        <span class="s2">):</span>
            <span class="s1">valid_data_column_names</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;name&quot;</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">valid_data_column_names</span>


<span class="s2">@</span><span class="s1">validate_params</span><span class="s2">(</span>
    <span class="s2">{</span>
        <span class="s4">&quot;name&quot;</span><span class="s2">: [</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s4">&quot;version&quot;</span><span class="s2">: [</span><span class="s1">Interval</span><span class="s2">(</span><span class="s1">Integral</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;left&quot;</span><span class="s2">), </span><span class="s1">StrOptions</span><span class="s2">({</span><span class="s4">&quot;active&quot;</span><span class="s2">})],</span>
        <span class="s4">&quot;data_id&quot;</span><span class="s2">: [</span><span class="s1">Interval</span><span class="s2">(</span><span class="s1">Integral</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;left&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s4">&quot;data_home&quot;</span><span class="s2">: [</span><span class="s1">str</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">PathLike</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s4">&quot;target_column&quot;</span><span class="s2">: [</span><span class="s1">str</span><span class="s2">, </span><span class="s1">list</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s4">&quot;cache&quot;</span><span class="s2">: [</span><span class="s1">bool</span><span class="s2">],</span>
        <span class="s4">&quot;return_X_y&quot;</span><span class="s2">: [</span><span class="s1">bool</span><span class="s2">],</span>
        <span class="s4">&quot;as_frame&quot;</span><span class="s2">: [</span><span class="s1">bool</span><span class="s2">, </span><span class="s1">StrOptions</span><span class="s2">({</span><span class="s4">&quot;auto&quot;</span><span class="s2">})],</span>
        <span class="s4">&quot;n_retries&quot;</span><span class="s2">: [</span><span class="s1">Interval</span><span class="s2">(</span><span class="s1">Integral</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;left&quot;</span><span class="s2">)],</span>
        <span class="s4">&quot;delay&quot;</span><span class="s2">: [</span><span class="s1">Interval</span><span class="s2">(</span><span class="s1">Real</span><span class="s2">, </span><span class="s6">0.0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">closed</span><span class="s2">=</span><span class="s4">&quot;neither&quot;</span><span class="s2">)],</span>
        <span class="s4">&quot;parser&quot;</span><span class="s2">: [</span>
            <span class="s1">StrOptions</span><span class="s2">({</span><span class="s4">&quot;auto&quot;</span><span class="s2">, </span><span class="s4">&quot;pandas&quot;</span><span class="s2">, </span><span class="s4">&quot;liac-arff&quot;</span><span class="s2">}),</span>
        <span class="s2">],</span>
        <span class="s4">&quot;read_csv_kwargs&quot;</span><span class="s2">: [</span><span class="s1">dict</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
    <span class="s2">},</span>
    <span class="s1">prefer_skip_nested_validation</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">fetch_openml</span><span class="s2">(</span>
    <span class="s1">name</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">version</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">int</span><span class="s2">] = </span><span class="s4">&quot;active&quot;</span><span class="s2">,</span>
    <span class="s1">data_id</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">data_home</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">os</span><span class="s2">.</span><span class="s1">PathLike</span><span class="s2">]] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">target_column</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">List</span><span class="s2">]] = </span><span class="s4">&quot;default-target&quot;</span><span class="s2">,</span>
    <span class="s1">cache</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">return_X_y</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">as_frame</span><span class="s2">: </span><span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">bool</span><span class="s2">] = </span><span class="s4">&quot;auto&quot;</span><span class="s2">,</span>
    <span class="s1">n_retries</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">3</span><span class="s2">,</span>
    <span class="s1">delay</span><span class="s2">: </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1.0</span><span class="s2">,</span>
    <span class="s1">parser</span><span class="s2">: </span><span class="s1">str </span><span class="s2">= </span><span class="s4">&quot;auto&quot;</span><span class="s2">,</span>
    <span class="s1">read_csv_kwargs</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Fetch dataset from openml by name or dataset id. 
 
    Datasets are uniquely identified by either an integer ID or by a 
    combination of name and version (i.e. there might be multiple 
    versions of the 'iris' dataset). Please give either name or data_id 
    (not both). In case a name is given, a version can also be 
    provided. 
 
    Read more in the :ref:`User Guide &lt;openml&gt;`. 
 
    .. versionadded:: 0.20 
 
    .. note:: EXPERIMENTAL 
 
        The API is experimental (particularly the return value structure), 
        and might have small backward-incompatible changes without notice 
        or warning in future releases. 
 
    Parameters 
    ---------- 
    name : str, default=None 
        String identifier of the dataset. Note that OpenML can have multiple 
        datasets with the same name. 
 
    version : int or 'active', default='active' 
        Version of the dataset. Can only be provided if also ``name`` is given. 
        If 'active' the oldest version that's still active is used. Since 
        there may be more than one active version of a dataset, and those 
        versions may fundamentally be different from one another, setting an 
        exact version is highly recommended. 
 
    data_id : int, default=None 
        OpenML ID of the dataset. The most specific way of retrieving a 
        dataset. If data_id is not given, name (and potential version) are 
        used to obtain a dataset. 
 
    data_home : str or path-like, default=None 
        Specify another download and cache folder for the data sets. By default 
        all scikit-learn data is stored in '~/scikit_learn_data' subfolders. 
 
    target_column : str, list or None, default='default-target' 
        Specify the column name in the data to use as target. If 
        'default-target', the standard target column a stored on the server 
        is used. If ``None``, all columns are returned as data and the 
        target is ``None``. If list (of strings), all columns with these names 
        are returned as multi-target (Note: not all scikit-learn classifiers 
        can handle all types of multi-output combinations). 
 
    cache : bool, default=True 
        Whether to cache the downloaded datasets into `data_home`. 
 
    return_X_y : bool, default=False 
        If True, returns ``(data, target)`` instead of a Bunch object. See 
        below for more information about the `data` and `target` objects. 
 
    as_frame : bool or 'auto', default='auto' 
        If True, the data is a pandas DataFrame including columns with 
        appropriate dtypes (numeric, string or categorical). The target is 
        a pandas DataFrame or Series depending on the number of target_columns. 
        The Bunch will contain a ``frame`` attribute with the target and the 
        data. If ``return_X_y`` is True, then ``(data, target)`` will be pandas 
        DataFrames or Series as describe above. 
 
        If `as_frame` is 'auto', the data and target will be converted to 
        DataFrame or Series as if `as_frame` is set to True, unless the dataset 
        is stored in sparse format. 
 
        If `as_frame` is False, the data and target will be NumPy arrays and 
        the `data` will only contain numerical values when `parser=&quot;liac-arff&quot;` 
        where the categories are provided in the attribute `categories` of the 
        `Bunch` instance. When `parser=&quot;pandas&quot;`, no ordinal encoding is made. 
 
        .. versionchanged:: 0.24 
           The default value of `as_frame` changed from `False` to `'auto'` 
           in 0.24. 
 
    n_retries : int, default=3 
        Number of retries when HTTP errors or network timeouts are encountered. 
        Error with status code 412 won't be retried as they represent OpenML 
        generic errors. 
 
    delay : float, default=1.0 
        Number of seconds between retries. 
 
    parser : {&quot;auto&quot;, &quot;pandas&quot;, &quot;liac-arff&quot;}, default=&quot;auto&quot; 
        Parser used to load the ARFF file. Two parsers are implemented: 
 
        - `&quot;pandas&quot;`: this is the most efficient parser. However, it requires 
          pandas to be installed and can only open dense datasets. 
        - `&quot;liac-arff&quot;`: this is a pure Python ARFF parser that is much less 
          memory- and CPU-efficient. It deals with sparse ARFF datasets. 
 
        If `&quot;auto&quot;`, the parser is chosen automatically such that `&quot;liac-arff&quot;` 
        is selected for sparse ARFF datasets, otherwise `&quot;pandas&quot;` is selected. 
 
        .. versionadded:: 1.2 
        .. versionchanged:: 1.4 
           The default value of `parser` changes from `&quot;liac-arff&quot;` to 
           `&quot;auto&quot;`. 
 
    read_csv_kwargs : dict, default=None 
        Keyword arguments passed to :func:`pandas.read_csv` when loading the data 
        from a ARFF file and using the pandas parser. It can allow to 
        overwrite some default parameters. 
 
        .. versionadded:: 1.3 
 
    Returns 
    ------- 
    data : :class:`~sklearn.utils.Bunch` 
        Dictionary-like object, with the following attributes. 
 
        data : np.array, scipy.sparse.csr_matrix of floats, or pandas DataFrame 
            The feature matrix. Categorical features are encoded as ordinals. 
        target : np.array, pandas Series or DataFrame 
            The regression target or classification labels, if applicable. 
            Dtype is float if numeric, and object if categorical. If 
            ``as_frame`` is True, ``target`` is a pandas object. 
        DESCR : str 
            The full description of the dataset. 
        feature_names : list 
            The names of the dataset columns. 
        target_names: list 
            The names of the target columns. 
 
        .. versionadded:: 0.22 
 
        categories : dict or None 
            Maps each categorical feature name to a list of values, such 
            that the value encoded as i is ith in the list. If ``as_frame`` 
            is True, this is None. 
        details : dict 
            More metadata from OpenML. 
        frame : pandas DataFrame 
            Only present when `as_frame=True`. DataFrame with ``data`` and 
            ``target``. 
 
    (data, target) : tuple if ``return_X_y`` is True 
 
        .. note:: EXPERIMENTAL 
 
            This interface is **experimental** and subsequent releases may 
            change attributes without notice (although there should only be 
            minor changes to ``data`` and ``target``). 
 
        Missing values in the 'data' are represented as NaN's. Missing values 
        in 'target' are represented as NaN's (numerical target) or None 
        (categorical target). 
 
    Notes 
    ----- 
    The `&quot;pandas&quot;` and `&quot;liac-arff&quot;` parsers can lead to different data types 
    in the output. The notable differences are the following: 
 
    - The `&quot;liac-arff&quot;` parser always encodes categorical features as `str` objects. 
      To the contrary, the `&quot;pandas&quot;` parser instead infers the type while 
      reading and numerical categories will be casted into integers whenever 
      possible. 
    - The `&quot;liac-arff&quot;` parser uses float64 to encode numerical features 
      tagged as 'REAL' and 'NUMERICAL' in the metadata. The `&quot;pandas&quot;` 
      parser instead infers if these numerical features corresponds 
      to integers and uses panda's Integer extension dtype. 
    - In particular, classification datasets with integer categories are 
      typically loaded as such `(0, 1, ...)` with the `&quot;pandas&quot;` parser while 
      `&quot;liac-arff&quot;` will force the use of string encoded class labels such as 
      `&quot;0&quot;`, `&quot;1&quot;` and so on. 
    - The `&quot;pandas&quot;` parser will not strip single quotes - i.e. `'` - from 
      string columns. For instance, a string `'my string'` will be kept as is 
      while the `&quot;liac-arff&quot;` parser will strip the single quotes. For 
      categorical columns, the single quotes are stripped from the values. 
 
    In addition, when `as_frame=False` is used, the `&quot;liac-arff&quot;` parser 
    returns ordinally encoded data where the categories are provided in the 
    attribute `categories` of the `Bunch` instance. Instead, `&quot;pandas&quot;` returns 
    a NumPy array were the categories are not encoded. 
 
    Examples 
    -------- 
    &gt;&gt;&gt; from sklearn.datasets import fetch_openml 
    &gt;&gt;&gt; adult = fetch_openml(&quot;adult&quot;, version=2)  # doctest: +SKIP 
    &gt;&gt;&gt; adult.frame.info()  # doctest: +SKIP 
    &lt;class 'pandas.core.frame.DataFrame'&gt; 
    RangeIndex: 48842 entries, 0 to 48841 
    Data columns (total 15 columns): 
     #   Column          Non-Null Count  Dtype 
    ---  ------          --------------  ----- 
     0   age             48842 non-null  int64 
     1   workclass       46043 non-null  category 
     2   fnlwgt          48842 non-null  int64 
     3   education       48842 non-null  category 
     4   education-num   48842 non-null  int64 
     5   marital-status  48842 non-null  category 
     6   occupation      46033 non-null  category 
     7   relationship    48842 non-null  category 
     8   race            48842 non-null  category 
     9   sex             48842 non-null  category 
     10  capital-gain    48842 non-null  int64 
     11  capital-loss    48842 non-null  int64 
     12  hours-per-week  48842 non-null  int64 
     13  native-country  47985 non-null  category 
     14  class           48842 non-null  category 
    dtypes: category(9), int64(6) 
    memory usage: 2.7 MB 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">cache </span><span class="s0">is False</span><span class="s2">:</span>
        <span class="s3"># no caching will be applied</span>
        <span class="s1">data_home </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">data_home </span><span class="s2">= </span><span class="s1">get_data_home</span><span class="s2">(</span><span class="s1">data_home</span><span class="s2">=</span><span class="s1">data_home</span><span class="s2">)</span>
        <span class="s1">data_home </span><span class="s2">= </span><span class="s1">join</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">data_home</span><span class="s2">), </span><span class="s4">&quot;openml&quot;</span><span class="s2">)</span>

    <span class="s3"># check valid function arguments. data_id XOR (name, version) should be</span>
    <span class="s3"># provided</span>
    <span class="s0">if </span><span class="s1">name </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s3"># OpenML is case-insensitive, but the caching mechanism is not</span>
        <span class="s3"># convert all data names (str) to lower case</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">data_id </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s4">&quot;Dataset data_id={} and name={} passed, but you can only &quot;</span>
                <span class="s4">&quot;specify a numeric data_id or a name, not &quot;</span>
                <span class="s4">&quot;both.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s1">data_info </span><span class="s2">= </span><span class="s1">_get_data_info_by_name</span><span class="s2">(</span>
            <span class="s1">name</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">, </span><span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">, </span><span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span>
        <span class="s2">)</span>
        <span class="s1">data_id </span><span class="s2">= </span><span class="s1">data_info</span><span class="s2">[</span><span class="s4">&quot;did&quot;</span><span class="s2">]</span>
    <span class="s0">elif </span><span class="s1">data_id </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s3"># from the previous if statement, it is given that name is None</span>
        <span class="s0">if </span><span class="s1">version </span><span class="s2">!= </span><span class="s4">&quot;active&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s4">&quot;Dataset data_id={} and version={} passed, but you can only &quot;</span>
                <span class="s4">&quot;specify a numeric data_id or a version, not &quot;</span>
                <span class="s4">&quot;both.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">version</span><span class="s2">)</span>
            <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
            <span class="s4">&quot;Neither name nor data_id are provided. Please provide name or data_id.&quot;</span>
        <span class="s2">)</span>

    <span class="s1">data_description </span><span class="s2">= </span><span class="s1">_get_data_description_by_id</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;status&quot;</span><span class="s2">] != </span><span class="s4">&quot;active&quot;</span><span class="s2">:</span>
        <span class="s1">warn</span><span class="s2">(</span>
            <span class="s4">&quot;Version {} of dataset {} is inactive, meaning that issues have &quot;</span>
            <span class="s4">&quot;been found in the dataset. Try using a newer version from &quot;</span>
            <span class="s4">&quot;this URL: {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
                <span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;version&quot;</span><span class="s2">],</span>
                <span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;name&quot;</span><span class="s2">],</span>
                <span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;url&quot;</span><span class="s2">],</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s4">&quot;error&quot; </span><span class="s0">in </span><span class="s1">data_description</span><span class="s2">:</span>
        <span class="s1">warn</span><span class="s2">(</span>
            <span class="s4">&quot;OpenML registered a problem with the dataset. It might be &quot;</span>
            <span class="s4">&quot;unusable. Error: {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;error&quot;</span><span class="s2">])</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s4">&quot;warning&quot; </span><span class="s0">in </span><span class="s1">data_description</span><span class="s2">:</span>
        <span class="s1">warn</span><span class="s2">(</span>
            <span class="s4">&quot;OpenML raised a warning on the dataset. It might be &quot;</span>
            <span class="s4">&quot;unusable. Warning: {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;warning&quot;</span><span class="s2">])</span>
        <span class="s2">)</span>

    <span class="s1">return_sparse </span><span class="s2">= </span><span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;format&quot;</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">() == </span><span class="s4">&quot;sparse_arff&quot;</span>
    <span class="s1">as_frame </span><span class="s2">= </span><span class="s0">not </span><span class="s1">return_sparse </span><span class="s0">if </span><span class="s1">as_frame </span><span class="s2">== </span><span class="s4">&quot;auto&quot; </span><span class="s0">else </span><span class="s1">as_frame</span>
    <span class="s0">if </span><span class="s1">parser </span><span class="s2">== </span><span class="s4">&quot;auto&quot;</span><span class="s2">:</span>
        <span class="s1">parser_ </span><span class="s2">= </span><span class="s4">&quot;liac-arff&quot; </span><span class="s0">if </span><span class="s1">return_sparse </span><span class="s0">else </span><span class="s4">&quot;pandas&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">parser_ </span><span class="s2">= </span><span class="s1">parser</span>

    <span class="s0">if </span><span class="s1">parser_ </span><span class="s2">== </span><span class="s4">&quot;pandas&quot;</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">check_pandas_support</span><span class="s2">(</span><span class="s4">&quot;`fetch_openml`&quot;</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ImportError </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
                <span class="s1">err_msg </span><span class="s2">= (</span>
                    <span class="s4">&quot;Returning pandas objects requires pandas to be installed. &quot;</span>
                    <span class="s4">&quot;Alternatively, explicitly set `as_frame=False` and &quot;</span>
                    <span class="s4">&quot;`parser='liac-arff'`.&quot;</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">err_msg </span><span class="s2">= (</span>
                    <span class="s4">f&quot;Using `parser=</span><span class="s0">{</span><span class="s1">parser</span><span class="s0">!r}</span><span class="s4">` wit dense data requires pandas to be &quot;</span>
                    <span class="s4">&quot;installed. Alternatively, explicitly set `parser='liac-arff'`.&quot;</span>
                <span class="s2">)</span>
            <span class="s0">raise </span><span class="s1">ImportError</span><span class="s2">(</span><span class="s1">err_msg</span><span class="s2">) </span><span class="s0">from </span><span class="s1">exc</span>

    <span class="s0">if </span><span class="s1">return_sparse</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s4">&quot;Sparse ARFF datasets cannot be loaded with as_frame=True. &quot;</span>
                <span class="s4">&quot;Use as_frame=False or as_frame='auto' instead.&quot;</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">parser_ </span><span class="s2">== </span><span class="s4">&quot;pandas&quot;</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                <span class="s4">f&quot;Sparse ARFF datasets cannot be loaded with parser=</span><span class="s0">{</span><span class="s1">parser</span><span class="s0">!r}</span><span class="s4">. &quot;</span>
                <span class="s4">&quot;Use parser='liac-arff' or parser='auto' instead.&quot;</span>
            <span class="s2">)</span>

    <span class="s3"># download data features, meta-info about column types</span>
    <span class="s1">features_list </span><span class="s2">= </span><span class="s1">_get_data_features</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">as_frame</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">feature </span><span class="s0">in </span><span class="s1">features_list</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s4">&quot;true&quot; </span><span class="s0">in </span><span class="s2">(</span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;is_ignore&quot;</span><span class="s2">], </span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;is_row_identifier&quot;</span><span class="s2">]):</span>
                <span class="s0">continue</span>
            <span class="s0">if </span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;data_type&quot;</span><span class="s2">] == </span><span class="s4">&quot;string&quot;</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span>
                    <span class="s4">&quot;STRING attributes are not supported for &quot;</span>
                    <span class="s4">&quot;array representation. Try as_frame=True&quot;</span>
                <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">target_column </span><span class="s2">== </span><span class="s4">&quot;default-target&quot;</span><span class="s2">:</span>
        <span class="s3"># determines the default target based on the data feature results</span>
        <span class="s3"># (which is currently more reliable than the data description;</span>
        <span class="s3"># see issue: https://github.com/openml/OpenML/issues/768)</span>
        <span class="s1">target_columns </span><span class="s2">= [</span>
            <span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;name&quot;</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">feature </span><span class="s0">in </span><span class="s1">features_list</span>
            <span class="s0">if </span><span class="s1">feature</span><span class="s2">[</span><span class="s4">&quot;is_target&quot;</span><span class="s2">] == </span><span class="s4">&quot;true&quot;</span>
        <span class="s2">]</span>
    <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">target_column</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s3"># for code-simplicity, make target_column by default a list</span>
        <span class="s1">target_columns </span><span class="s2">= [</span><span class="s1">target_column</span><span class="s2">]</span>
    <span class="s0">elif </span><span class="s1">target_column </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">target_columns </span><span class="s2">= []</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># target_column already is of type list</span>
        <span class="s1">target_columns </span><span class="s2">= </span><span class="s1">target_column</span>
    <span class="s1">data_columns </span><span class="s2">= </span><span class="s1">_valid_data_column_names</span><span class="s2">(</span><span class="s1">features_list</span><span class="s2">, </span><span class="s1">target_columns</span><span class="s2">)</span>

    <span class="s1">shape</span><span class="s2">: </span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Tuple</span><span class="s2">[</span><span class="s1">int</span><span class="s2">, </span><span class="s1">int</span><span class="s2">]]</span>
    <span class="s3"># determine arff encoding to return</span>
    <span class="s0">if not </span><span class="s1">return_sparse</span><span class="s2">:</span>
        <span class="s3"># The shape must include the ignored features to keep the right indexes</span>
        <span class="s3"># during the arff data conversion.</span>
        <span class="s1">data_qualities </span><span class="s2">= </span><span class="s1">_get_data_qualities</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">data_home</span><span class="s2">)</span>
        <span class="s1">shape </span><span class="s2">= </span><span class="s1">_get_num_samples</span><span class="s2">(</span><span class="s1">data_qualities</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">features_list</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">shape </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s3"># obtain the data</span>
    <span class="s1">url </span><span class="s2">= </span><span class="s1">_DATA_FILE</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;file_id&quot;</span><span class="s2">])</span>
    <span class="s1">bunch </span><span class="s2">= </span><span class="s1">_download_data_to_bunch</span><span class="s2">(</span>
        <span class="s1">url</span><span class="s2">,</span>
        <span class="s1">return_sparse</span><span class="s2">,</span>
        <span class="s1">data_home</span><span class="s2">,</span>
        <span class="s1">as_frame</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">as_frame</span><span class="s2">),</span>
        <span class="s1">openml_columns_info</span><span class="s2">=</span><span class="s1">features_list</span><span class="s2">,</span>
        <span class="s1">shape</span><span class="s2">=</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s1">target_columns</span><span class="s2">=</span><span class="s1">target_columns</span><span class="s2">,</span>
        <span class="s1">data_columns</span><span class="s2">=</span><span class="s1">data_columns</span><span class="s2">,</span>
        <span class="s1">md5_checksum</span><span class="s2">=</span><span class="s1">data_description</span><span class="s2">[</span><span class="s4">&quot;md5_checksum&quot;</span><span class="s2">],</span>
        <span class="s1">n_retries</span><span class="s2">=</span><span class="s1">n_retries</span><span class="s2">,</span>
        <span class="s1">delay</span><span class="s2">=</span><span class="s1">delay</span><span class="s2">,</span>
        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser_</span><span class="s2">,</span>
        <span class="s1">read_csv_kwargs</span><span class="s2">=</span><span class="s1">read_csv_kwargs</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">return_X_y</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">bunch</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">bunch</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s1">description </span><span class="s2">= </span><span class="s4">&quot;{}</span><span class="s0">\n\n</span><span class="s4">Downloaded from openml.org.&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
        <span class="s1">data_description</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;description&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">bunch</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span>
        <span class="s1">DESCR</span><span class="s2">=</span><span class="s1">description</span><span class="s2">,</span>
        <span class="s1">details</span><span class="s2">=</span><span class="s1">data_description</span><span class="s2">,</span>
        <span class="s1">url</span><span class="s2">=</span><span class="s4">&quot;https://www.openml.org/d/{}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">data_id</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s0">return </span><span class="s1">bunch</span>
</pre>
</body>
</html>