<html>
<head>
<title>test_encoding.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_encoding.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Tests encoding functionality during parsing 
for all of the parsers defined in parsers.py 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">BytesIO</span><span class="s3">,</span>
    <span class="s1">TextIOWrapper</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">tempfile</span>
<span class="s2">import </span><span class="s1">uuid</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">DataFrame</span><span class="s3">,</span>
    <span class="s1">read_csv</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">as </span><span class="s1">tm</span>

<span class="s1">pytestmark </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span>
    <span class="s4">&quot;ignore:Passing a BlockManager to DataFrame:DeprecationWarning&quot;</span>
<span class="s3">)</span>

<span class="s1">skip_pyarrow </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;pyarrow_skip&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_bytes_io_input</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">):</span>
    <span class="s1">encoding </span><span class="s3">= </span><span class="s4">&quot;cp1255&quot;</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>

    <span class="s1">data </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s4">&quot;שלום:1234</span><span class="s2">\n</span><span class="s4">562:123&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">))</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">&quot;:&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">562</span><span class="s3">, </span><span class="s5">123</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;שלום&quot;</span><span class="s3">, </span><span class="s4">&quot;1234&quot;</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_pyarrow  </span><span class="s6"># CSV parse error: Empty CSV file or block</span>
<span class="s2">def </span><span class="s1">test_read_csv_unicode</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\u0141</span><span class="s4">aski, Jan;1&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">())</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">&quot;;&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s4">&quot;</span><span class="s2">\u0141</span><span class="s4">aski, Jan&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_pyarrow</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;sep&quot;</span><span class="s3">, [</span><span class="s4">&quot;,&quot;</span><span class="s3">, </span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;encoding&quot;</span><span class="s3">, [</span><span class="s4">&quot;utf-16&quot;</span><span class="s3">, </span><span class="s4">&quot;utf-16le&quot;</span><span class="s3">, </span><span class="s4">&quot;utf-16be&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_utf16_bom_skiprows</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">):</span>
    <span class="s6"># see gh-2298</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;skip this 
skip this too 
A,B,C 
1,2,3 
4,5,6&quot;&quot;&quot;</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span>
        <span class="s4">&quot;,&quot;</span><span class="s3">, </span><span class="s1">sep</span>
    <span class="s3">)</span>
    <span class="s1">path </span><span class="s3">= </span><span class="s4">f&quot;__</span><span class="s2">{</span><span class="s1">uuid</span><span class="s3">.</span><span class="s1">uuid4</span><span class="s3">()</span><span class="s2">}</span><span class="s4">__.csv&quot;</span>
    <span class="s1">kwargs </span><span class="s3">= {</span><span class="s4">&quot;sep&quot;</span><span class="s3">: </span><span class="s1">sep</span><span class="s3">, </span><span class="s4">&quot;skiprows&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">}</span>
    <span class="s1">utf8 </span><span class="s3">= </span><span class="s4">&quot;utf-8&quot;</span>

    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s1">path</span><span class="s3">) </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s1">bytes_data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">&quot;wb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">bytes_data</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">TextIOWrapper</span><span class="s3">(</span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">utf8</span><span class="s3">)), </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">utf8</span><span class="s3">) </span><span class="s2">as </span><span class="s1">bytes_buffer</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">bytes_buffer</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">utf8</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_utf16_example</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">csv_dir_path</span><span class="s3">):</span>
    <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">csv_dir_path</span><span class="s3">, </span><span class="s4">&quot;utf16_ex.txt&quot;</span><span class="s3">)</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-16&quot;</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">result</span><span class="s3">) == </span><span class="s5">50</span>


<span class="s2">def </span><span class="s1">test_unicode_encoding</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">csv_dir_path</span><span class="s3">):</span>
    <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">csv_dir_path</span><span class="s3">, </span><span class="s4">&quot;unicode_series.csv&quot;</span><span class="s3">)</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;latin-1&quot;</span><span class="s3">)</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">result</span><span class="s3">.</span><span class="s1">set_index</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">got </span><span class="s3">= </span><span class="s1">result</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">1632</span><span class="s3">]</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\xc1 </span><span class="s4">k</span><span class="s2">\xf6</span><span class="s4">ldum klaka (Cold Fever) (1994)&quot;</span>
    <span class="s2">assert </span><span class="s1">got </span><span class="s3">== </span><span class="s1">expected</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data,kwargs,expected&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s6"># Basic test</span>
        <span class="s3">(</span><span class="s4">&quot;a</span><span class="s2">\n</span><span class="s4">1&quot;</span><span class="s3">, {}, </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">]})),</span>
        <span class="s6"># &quot;Regular&quot; quoting</span>
        <span class="s3">(</span><span class="s4">'&quot;a&quot;</span><span class="s2">\n</span><span class="s4">1'</span><span class="s3">, {</span><span class="s4">&quot;quotechar&quot;</span><span class="s3">: </span><span class="s4">'&quot;'</span><span class="s3">}, </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">]})),</span>
        <span class="s6"># Test in a data row instead of header</span>
        <span class="s3">(</span><span class="s4">&quot;b</span><span class="s2">\n</span><span class="s4">1&quot;</span><span class="s3">, {</span><span class="s4">&quot;names&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">]}, </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;1&quot;</span><span class="s3">]})),</span>
        <span class="s6"># Test in empty data row with skipping</span>
        <span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">1&quot;</span><span class="s3">, {</span><span class="s4">&quot;names&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">], </span><span class="s4">&quot;skip_blank_lines&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}, </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">]})),</span>
        <span class="s6"># Test in empty data row without skipping</span>
        <span class="s3">(</span>
            <span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">1&quot;</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;names&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">], </span><span class="s4">&quot;skip_blank_lines&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">},</span>
            <span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]}),</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_utf8_bom</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
    <span class="s6"># see gh-4793</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">bom </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\ufeff</span><span class="s4">&quot;</span>
    <span class="s1">utf8 </span><span class="s3">= </span><span class="s4">&quot;utf-8&quot;</span>

    <span class="s2">def </span><span class="s1">_encode_data_with_bom</span><span class="s3">(</span><span class="s1">_data</span><span class="s3">):</span>
        <span class="s1">bom_data </span><span class="s3">= (</span><span class="s1">bom </span><span class="s3">+ </span><span class="s1">_data</span><span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">utf8</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">bom_data</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s3">(</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">== </span><span class="s4">&quot;pyarrow&quot;</span>
        <span class="s2">and </span><span class="s1">data </span><span class="s3">== </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">1&quot;</span>
        <span class="s2">and </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;skip_blank_lines&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s3">):</span>
        <span class="s6"># CSV parse error: Empty CSV file or block: cannot infer number of columns</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">=</span><span class="s4">&quot;https://github.com/apache/arrow/issues/38676&quot;</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">_encode_data_with_bom</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">utf8</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_csv_utf_aliases</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">utf_value</span><span class="s3">, </span><span class="s1">encoding_fmt</span><span class="s3">):</span>
    <span class="s6"># see gh-13549</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;mb_num&quot;</span><span class="s3">: [</span><span class="s5">4.8</span><span class="s3">], </span><span class="s4">&quot;multibyte&quot;</span><span class="s3">: [</span><span class="s4">&quot;test&quot;</span><span class="s3">]})</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>

    <span class="s1">encoding </span><span class="s3">= </span><span class="s1">encoding_fmt</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">utf_value</span><span class="s3">)</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;mb_num,multibyte</span><span class="s2">\n</span><span class="s4">4.8,test&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;file_path,encoding&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">((</span><span class="s4">&quot;io&quot;</span><span class="s3">, </span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s4">&quot;csv&quot;</span><span class="s3">, </span><span class="s4">&quot;test1.csv&quot;</span><span class="s3">), </span><span class="s4">&quot;utf-8&quot;</span><span class="s3">),</span>
        <span class="s3">((</span><span class="s4">&quot;io&quot;</span><span class="s3">, </span><span class="s4">&quot;parser&quot;</span><span class="s3">, </span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s4">&quot;unicode_series.csv&quot;</span><span class="s3">), </span><span class="s4">&quot;latin-1&quot;</span><span class="s3">),</span>
        <span class="s3">((</span><span class="s4">&quot;io&quot;</span><span class="s3">, </span><span class="s4">&quot;parser&quot;</span><span class="s3">, </span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s4">&quot;sauron.SHIFT_JIS.csv&quot;</span><span class="s3">), </span><span class="s4">&quot;shiftjis&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_binary_mode_file_buffers</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">file_path</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">datapath</span><span class="s3">):</span>
    <span class="s6"># gh-23779: Python csv engine shouldn't error on files opened in binary.</span>
    <span class="s6"># gh-31575: Python csv engine shouldn't error on files opened in raw binary.</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>

    <span class="s1">fpath </span><span class="s3">= </span><span class="s1">datapath</span><span class="s3">(*</span><span class="s1">file_path</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fpath</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">fpath</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fa</span><span class="s3">:</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fa</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">fa</span><span class="s3">.</span><span class="s1">closed</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">fpath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fb</span><span class="s3">:</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fb</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">fb</span><span class="s3">.</span><span class="s1">closed</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">fpath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;rb&quot;</span><span class="s3">, </span><span class="s1">buffering</span><span class="s3">=</span><span class="s5">0</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fb</span><span class="s3">:</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fb</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">fb</span><span class="s3">.</span><span class="s1">closed</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;pass_encoding&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_encoding_temp_file</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">utf_value</span><span class="s3">, </span><span class="s1">encoding_fmt</span><span class="s3">, </span><span class="s1">pass_encoding</span><span class="s3">):</span>
    <span class="s6"># see gh-24130</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">encoding </span><span class="s3">= </span><span class="s1">encoding_fmt</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">utf_value</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">== </span><span class="s4">&quot;pyarrow&quot; </span><span class="s2">and </span><span class="s1">pass_encoding </span><span class="s2">is True and </span><span class="s1">utf_value </span><span class="s2">in </span><span class="s3">[</span><span class="s5">16</span><span class="s3">, </span><span class="s5">32</span><span class="s3">]:</span>
        <span class="s6"># FIXME: this is bad!</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">&quot;These cases freeze&quot;</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;foo&quot;</span><span class="s3">: [</span><span class="s4">&quot;bar&quot;</span><span class="s3">]})</span>

    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">=</span><span class="s4">&quot;w+&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">return_filelike</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;foo</span><span class="s2">\n</span><span class="s4">bar&quot;</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding </span><span class="s2">if </span><span class="s1">pass_encoding </span><span class="s2">else None</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_encoding_named_temp_file</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">):</span>
    <span class="s6"># see gh-31819</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">encoding </span><span class="s3">= </span><span class="s4">&quot;shift-jis&quot;</span>

    <span class="s1">title </span><span class="s3">= </span><span class="s4">&quot;てすと&quot;</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;こむ&quot;</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s1">title</span><span class="s3">: [</span><span class="s1">data</span><span class="s3">]})</span>

    <span class="s2">with </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">NamedTemporaryFile</span><span class="s3">() </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">title</span><span class="s2">}\n{</span><span class="s1">data</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">))</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">f</span><span class="s3">.</span><span class="s1">closed</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;encoding&quot;</span><span class="s3">, [</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s4">&quot;utf-16&quot;</span><span class="s3">, </span><span class="s4">&quot;utf-16-be&quot;</span><span class="s3">, </span><span class="s4">&quot;utf-16-le&quot;</span><span class="s3">, </span><span class="s4">&quot;utf-32&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_parse_encoded_special_characters</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">):</span>
    <span class="s6"># GH16218 Verify parsing of data with encoded special characters</span>
    <span class="s6"># Data contains a Unicode 'FULLWIDTH COLON' (U+FF1A) at position (0,&quot;a&quot;)</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;a</span><span class="s2">\t</span><span class="s4">b</span><span class="s2">\n</span><span class="s4">：foo</span><span class="s2">\t</span><span class="s4">0</span><span class="s2">\n</span><span class="s4">bar</span><span class="s2">\t</span><span class="s4">1</span><span class="s2">\n</span><span class="s4">baz</span><span class="s2">\t</span><span class="s4">2&quot;  </span><span class="s6"># noqa: RUF001</span>
    <span class="s1">encoded_data </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">))</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">encoded_data</span><span class="s3">, </span><span class="s1">delimiter</span><span class="s3">=</span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s1">data</span><span class="s3">=[[</span><span class="s4">&quot;：foo&quot;</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s4">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s4">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]],  </span><span class="s6"># noqa: RUF001</span>
        <span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;encoding&quot;</span><span class="s3">, [</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;utf-16&quot;</span><span class="s3">, </span><span class="s4">&quot;cp1255&quot;</span><span class="s3">, </span><span class="s4">&quot;latin-1&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_encoding_memory_map</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">):</span>
    <span class="s6"># GH40986</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s3">: [</span><span class="s4">&quot;Raphael&quot;</span><span class="s3">, </span><span class="s4">&quot;Donatello&quot;</span><span class="s3">, </span><span class="s4">&quot;Miguel Angel&quot;</span><span class="s3">, </span><span class="s4">&quot;Leonardo&quot;</span><span class="s3">],</span>
            <span class="s4">&quot;mask&quot;</span><span class="s3">: [</span><span class="s4">&quot;red&quot;</span><span class="s3">, </span><span class="s4">&quot;purple&quot;</span><span class="s3">, </span><span class="s4">&quot;orange&quot;</span><span class="s3">, </span><span class="s4">&quot;blue&quot;</span><span class="s3">],</span>
            <span class="s4">&quot;weapon&quot;</span><span class="s3">: [</span><span class="s4">&quot;sai&quot;</span><span class="s3">, </span><span class="s4">&quot;bo staff&quot;</span><span class="s3">, </span><span class="s4">&quot;nunchunk&quot;</span><span class="s3">, </span><span class="s4">&quot;katana&quot;</span><span class="s3">],</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">file</span><span class="s3">:</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">to_csv</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">== </span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;The 'memory_map' option is not supported with the 'pyarrow' engine&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
                <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">memory_map</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">memory_map</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_chunk_splits_multibyte_char</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Chunk splits a multibyte character with memory_map=True 
 
    GH 43540 
    &quot;&quot;&quot;</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s6"># DEFAULT_CHUNKSIZE = 262144, defined in parsers.pyx</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">=[</span><span class="s4">&quot;a&quot; </span><span class="s3">* </span><span class="s5">127</span><span class="s3">] * </span><span class="s5">2048</span><span class="s3">)</span>

    <span class="s6"># Put two-bytes utf-8 encoded character &quot;ą&quot; at the end of chunk</span>
    <span class="s6"># utf-8 encoding of &quot;ą&quot; is b'\xc4\x85'</span>
    <span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">2047</span><span class="s3">] = </span><span class="s4">&quot;a&quot; </span><span class="s3">* </span><span class="s5">127 </span><span class="s3">+ </span><span class="s4">&quot;ą&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s4">&quot;bug-gh43540.csv&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fname</span><span class="s3">:</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_csv</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">== </span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;The 'memory_map' option is not supported with the 'pyarrow' engine&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
                <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">memory_map</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">dfr </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">memory_map</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">dfr</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_readcsv_memmap_utf8</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    GH 43787 
 
    Test correct handling of UTF-8 chars when memory_map=True and encoding is UTF-8 
    &quot;&quot;&quot;</span>
    <span class="s1">lines </span><span class="s3">= []</span>
    <span class="s1">line_length </span><span class="s3">= </span><span class="s5">128</span>
    <span class="s1">start_char </span><span class="s3">= </span><span class="s4">&quot; &quot;</span>
    <span class="s1">end_char </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\U00010080</span><span class="s4">&quot;</span>
    <span class="s6"># This for loop creates a list of 128-char strings</span>
    <span class="s6"># consisting of consecutive Unicode chars</span>
    <span class="s2">for </span><span class="s1">lnum </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ord</span><span class="s3">(</span><span class="s1">start_char</span><span class="s3">), </span><span class="s1">ord</span><span class="s3">(</span><span class="s1">end_char</span><span class="s3">), </span><span class="s1">line_length</span><span class="s3">):</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s1">chr</span><span class="s3">(</span><span class="s1">c</span><span class="s3">) </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">lnum</span><span class="s3">, </span><span class="s1">lnum </span><span class="s3">+ </span><span class="s5">0x80</span><span class="s3">)]) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">line</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">UnicodeEncodeError</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s4">&quot;utf8test.csv&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fname</span><span class="s3">:</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_csv</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">engine </span><span class="s3">== </span><span class="s4">&quot;pyarrow&quot;</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;The 'memory_map' option is not supported with the 'pyarrow' engine&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
                <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">memory_map</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">dfr </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">fname</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">memory_map</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">dfr</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;pyarrow_xfail&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;mode&quot;</span><span class="s3">, [</span><span class="s4">&quot;w+b&quot;</span><span class="s3">, </span><span class="s4">&quot;w+t&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_not_readable</span><span class="s3">(</span><span class="s1">all_parsers</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">):</span>
    <span class="s6"># GH43439</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">all_parsers</span>
    <span class="s1">content </span><span class="s3">= </span><span class="s7">b&quot;abcd&quot;</span>
    <span class="s2">if </span><span class="s4">&quot;t&quot; </span><span class="s2">in </span><span class="s1">mode</span><span class="s3">:</span>
        <span class="s1">content </span><span class="s3">= </span><span class="s4">&quot;abcd&quot;</span>
    <span class="s2">with </span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">SpooledTemporaryFile</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">=</span><span class="s1">mode</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">handle</span><span class="s3">:</span>
        <span class="s1">handle</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">content</span><span class="s3">)</span>
        <span class="s1">handle</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">handle</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;abcd&quot;</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
</pre>
</body>
</html>