<html>
<head>
<title>test_ranking.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_ranking.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">stats</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">datasets</span><span class="s2">, </span><span class="s1">svm</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">make_multilabel_classification</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">UndefinedMetricWarning</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LogisticRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">accuracy_score</span><span class="s2">,</span>
    <span class="s1">auc</span><span class="s2">,</span>
    <span class="s1">average_precision_score</span><span class="s2">,</span>
    <span class="s1">coverage_error</span><span class="s2">,</span>
    <span class="s1">dcg_score</span><span class="s2">,</span>
    <span class="s1">det_curve</span><span class="s2">,</span>
    <span class="s1">label_ranking_average_precision_score</span><span class="s2">,</span>
    <span class="s1">label_ranking_loss</span><span class="s2">,</span>
    <span class="s1">ndcg_score</span><span class="s2">,</span>
    <span class="s1">precision_recall_curve</span><span class="s2">,</span>
    <span class="s1">roc_auc_score</span><span class="s2">,</span>
    <span class="s1">roc_curve</span><span class="s2">,</span>
    <span class="s1">top_k_accuracy_score</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">_ranking </span><span class="s0">import </span><span class="s1">_dcg_sample_scores</span><span class="s2">, </span><span class="s1">_ndcg_sample_scores</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">train_test_split</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">label_binarize</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">random_projection </span><span class="s0">import </span><span class="s1">_sparse_random_matrix</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_convert_container</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">ignore_warnings</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">extmath </span><span class="s0">import </span><span class="s1">softmax</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSR_CONTAINERS</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">validation </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">check_array</span><span class="s2">,</span>
    <span class="s1">check_consistent_length</span><span class="s2">,</span>
    <span class="s1">check_random_state</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s3">###############################################################################</span>
<span class="s3"># Utilities for testing</span>

<span class="s1">CURVE_FUNCS </span><span class="s2">= [</span>
    <span class="s1">det_curve</span><span class="s2">,</span>
    <span class="s1">precision_recall_curve</span><span class="s2">,</span>
    <span class="s1">roc_curve</span><span class="s2">,</span>
<span class="s2">]</span>


<span class="s0">def </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">dataset</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">binary</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Make some classification predictions on a toy dataset using a SVC 
 
    If binary is True restrict to a binary classification problem instead of a 
    multiclass classification problem 
    &quot;&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">dataset </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s3"># import some data to play with</span>
        <span class="s1">dataset </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">()</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">dataset</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">dataset</span><span class="s2">.</span><span class="s1">target</span>

    <span class="s0">if </span><span class="s1">binary</span><span class="s2">:</span>
        <span class="s3"># restrict to a binary classification task</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s5">2</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">y </span><span class="s2">&lt; </span><span class="s5">2</span><span class="s2">]</span>

    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s5">37</span><span class="s2">)</span>
    <span class="s1">rng</span><span class="s2">.</span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s1">p</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">p</span><span class="s2">]</span>
    <span class="s1">half </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">n_samples </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>

    <span class="s3"># add noisy features to make the problem harder and avoid perfect results</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s5">200 </span><span class="s2">* </span><span class="s1">n_features</span><span class="s2">)]</span>

    <span class="s3"># run classifier, get class probabilities and label predictions</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">svm</span><span class="s2">.</span><span class="s1">SVC</span><span class="s2">(</span><span class="s1">kernel</span><span class="s2">=</span><span class="s6">&quot;linear&quot;</span><span class="s2">, </span><span class="s1">probability</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s1">half</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">half</span><span class="s2">]).</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">half</span><span class="s2">:])</span>

    <span class="s0">if </span><span class="s1">binary</span><span class="s2">:</span>
        <span class="s3"># only interested in probabilities of the positive case</span>
        <span class="s3"># XXX: do we really want a special API for the binary case?</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">y_score</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">half</span><span class="s2">:])</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s1">half</span><span class="s2">:]</span>
    <span class="s0">return </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y_score</span>


<span class="s3">###############################################################################</span>
<span class="s3"># Tests</span>


<span class="s0">def </span><span class="s1">_auc</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Alternative implementation to check for correctness of 
    `roc_auc_score`.&quot;&quot;&quot;</span>
    <span class="s1">pos_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s3"># Count the number of times positive samples are correctly ranked above</span>
    <span class="s3"># negative samples.</span>
    <span class="s1">pos </span><span class="s2">= </span><span class="s1">y_score</span><span class="s2">[</span><span class="s1">y_true </span><span class="s2">== </span><span class="s1">pos_label</span><span class="s2">]</span>
    <span class="s1">neg </span><span class="s2">= </span><span class="s1">y_score</span><span class="s2">[</span><span class="s1">y_true </span><span class="s2">!= </span><span class="s1">pos_label</span><span class="s2">]</span>
    <span class="s1">diff_matrix </span><span class="s2">= </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">) - </span><span class="s1">neg</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">n_correct </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">diff_matrix </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">n_correct </span><span class="s2">/ </span><span class="s1">float</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">) * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">neg</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_average_precision</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Alternative implementation to check for correctness of 
    `average_precision_score`. 
 
    Note that this implementation fails on some edge cases. 
    For example, for constant predictions e.g. [0.5, 0.5, 0.5], 
    y_true = [1, 0, 0] returns an average precision of 0.33... 
    but y_true = [0, 0, 1] returns 1.0. 
    &quot;&quot;&quot;</span>
    <span class="s1">pos_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">)[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">n_pos </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">y_true </span><span class="s2">== </span><span class="s1">pos_label</span><span class="s2">)</span>
    <span class="s1">order </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">)[::-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">y_score</span><span class="s2">[</span><span class="s1">order</span><span class="s2">]</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">y_true</span><span class="s2">[</span><span class="s1">order</span><span class="s2">]</span>

    <span class="s1">score </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">)):</span>
        <span class="s0">if </span><span class="s1">y_true</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s1">pos_label</span><span class="s2">:</span>
            <span class="s3"># Compute precision up to document i</span>
            <span class="s3"># i.e, percentage of relevant documents up to document i.</span>
            <span class="s1">prec </span><span class="s2">= </span><span class="s5">0</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">y_true</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] == </span><span class="s1">pos_label</span><span class="s2">:</span>
                    <span class="s1">prec </span><span class="s2">+= </span><span class="s5">1.0</span>
            <span class="s1">prec </span><span class="s2">/= </span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1.0</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s1">prec</span>

    <span class="s0">return </span><span class="s1">score </span><span class="s2">/ </span><span class="s1">n_pos</span>


<span class="s0">def </span><span class="s1">_average_precision_slow</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;A second alternative implementation of average precision that closely 
    follows the Wikipedia article's definition (see References). This should 
    give identical results as `average_precision_score` for all inputs. 
 
    References 
    ---------- 
    .. [1] `Wikipedia entry for the Average precision 
       &lt;https://en.wikipedia.org/wiki/Average_precision&gt;`_ 
    &quot;&quot;&quot;</span>
    <span class="s1">precision</span><span class="s2">, </span><span class="s1">recall</span><span class="s2">, </span><span class="s1">threshold </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">precision </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">))</span>
    <span class="s1">recall </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">recall</span><span class="s2">))</span>
    <span class="s1">average_precision </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">)):</span>
        <span class="s1">average_precision </span><span class="s2">+= </span><span class="s1">precision</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * (</span><span class="s1">recall</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] - </span><span class="s1">recall</span><span class="s2">[</span><span class="s1">i </span><span class="s2">- </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">average_precision</span>


<span class="s0">def </span><span class="s1">_partial_roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_predict</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Alternative implementation to check for correctness of `roc_auc_score` 
    with `max_fpr` set. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">_partial_roc</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_predict</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">):</span>
        <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_predict</span><span class="s2">)</span>
        <span class="s1">new_fpr </span><span class="s2">= </span><span class="s1">fpr</span><span class="s2">[</span><span class="s1">fpr </span><span class="s2">&lt;= </span><span class="s1">max_fpr</span><span class="s2">]</span>
        <span class="s1">new_fpr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">new_fpr</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">)</span>
        <span class="s1">new_tpr </span><span class="s2">= </span><span class="s1">tpr</span><span class="s2">[</span><span class="s1">fpr </span><span class="s2">&lt;= </span><span class="s1">max_fpr</span><span class="s2">]</span>
        <span class="s1">idx_out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">fpr </span><span class="s2">&gt; </span><span class="s1">max_fpr</span><span class="s2">)</span>
        <span class="s1">idx_in </span><span class="s2">= </span><span class="s1">idx_out </span><span class="s2">- </span><span class="s5">1</span>
        <span class="s1">x_interp </span><span class="s2">= [</span><span class="s1">fpr</span><span class="s2">[</span><span class="s1">idx_in</span><span class="s2">], </span><span class="s1">fpr</span><span class="s2">[</span><span class="s1">idx_out</span><span class="s2">]]</span>
        <span class="s1">y_interp </span><span class="s2">= [</span><span class="s1">tpr</span><span class="s2">[</span><span class="s1">idx_in</span><span class="s2">], </span><span class="s1">tpr</span><span class="s2">[</span><span class="s1">idx_out</span><span class="s2">]]</span>
        <span class="s1">new_tpr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">new_tpr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">interp</span><span class="s2">(</span><span class="s1">max_fpr</span><span class="s2">, </span><span class="s1">x_interp</span><span class="s2">, </span><span class="s1">y_interp</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">new_fpr</span><span class="s2">, </span><span class="s1">new_tpr</span><span class="s2">)</span>

    <span class="s1">new_fpr</span><span class="s2">, </span><span class="s1">new_tpr </span><span class="s2">= </span><span class="s1">_partial_roc</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_predict</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">)</span>
    <span class="s1">partial_auc </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">new_fpr</span><span class="s2">, </span><span class="s1">new_tpr</span><span class="s2">)</span>

    <span class="s3"># Formula (5) from McClish 1989</span>
    <span class="s1">fpr1 </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">fpr2 </span><span class="s2">= </span><span class="s1">max_fpr</span>
    <span class="s1">min_area </span><span class="s2">= </span><span class="s5">0.5 </span><span class="s2">* (</span><span class="s1">fpr2 </span><span class="s2">- </span><span class="s1">fpr1</span><span class="s2">) * (</span><span class="s1">fpr2 </span><span class="s2">+ </span><span class="s1">fpr1</span><span class="s2">)</span>
    <span class="s1">max_area </span><span class="s2">= </span><span class="s1">fpr2 </span><span class="s2">- </span><span class="s1">fpr1</span>
    <span class="s0">return </span><span class="s5">0.5 </span><span class="s2">* (</span><span class="s5">1 </span><span class="s2">+ (</span><span class="s1">partial_auc </span><span class="s2">- </span><span class="s1">min_area</span><span class="s2">) / (</span><span class="s1">max_area </span><span class="s2">- </span><span class="s1">min_area</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;drop&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_roc_curve</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s3"># Test Area under Receiver Operating Characteristic (ROC) curve</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">expected_auc </span><span class="s2">= </span><span class="s1">_auc</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>

    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s1">expected_auc</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_end_points</span><span class="s2">():</span>
    <span class="s3"># Make sure that roc_curve returns a curve start at 0 and ending and</span>
    <span class="s3"># 1 even in corner cases</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">] * </span><span class="s5">50 </span><span class="s2">+ [</span><span class="s5">1</span><span class="s2">] * </span><span class="s5">50</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thr </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">] == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thr</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_roc_returns_consistency</span><span class="s2">():</span>
    <span class="s3"># Test whether the returned threshold matches up with tpr</span>
    <span class="s3"># make small toy dataset</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>

    <span class="s3"># use the given thresholds to determine the tpr</span>
    <span class="s1">tpr_correct </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">thresholds</span><span class="s2">:</span>
        <span class="s1">tp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">y_score </span><span class="s2">&gt;= </span><span class="s1">t</span><span class="s2">) &amp; </span><span class="s1">y_true</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">)</span>
        <span class="s1">tpr_correct</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">1.0 </span><span class="s2">* </span><span class="s1">tp </span><span class="s2">/ </span><span class="s1">p</span><span class="s2">)</span>

    <span class="s3"># compare tpr and tpr_correct to see if the thresholds' order was correct</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">tpr_correct</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_multi</span><span class="s2">():</span>
    <span class="s3"># roc_curve not applicable for multi-class problems</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_roc_curve_confidence</span><span class="s2">():</span>
    <span class="s3"># roc_curve for confidence scores</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">- </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.90</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_hard</span><span class="s2">():</span>
    <span class="s3"># roc_curve for hard decisions</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s3"># always predict one</span>
    <span class="s1">trivial_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">trivial_pred</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.50</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s3"># always predict zero</span>
    <span class="s1">trivial_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">trivial_pred</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.50</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s3"># hard decisions</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">pred</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.78</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_one_label</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_pred </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s3"># assert there are warnings</span>
    <span class="s1">expected_message </span><span class="s2">= (</span>
        <span class="s6">&quot;No negative samples in y_true, false positive value should be meaningless&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UndefinedMetricWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>

    <span class="s3"># all true labels, all fpr should be nan</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s3"># assert there are warnings</span>
    <span class="s1">expected_message </span><span class="s2">= (</span>
        <span class="s6">&quot;No positive samples in y_true, true positive value should be meaningless&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UndefinedMetricWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">([</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">y_true</span><span class="s2">], </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s3"># all negative labels, all tpr should be nan</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">tpr</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">fpr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_toydata</span><span class="s2">():</span>
    <span class="s3"># Binary classification</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]</span>
    <span class="s3"># assert UndefinedMetricWarning because of no positive sample in y_true</span>
    <span class="s1">expected_message </span><span class="s2">= (</span>
        <span class="s6">&quot;No positive samples in y_true, true positive value should be meaningless&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UndefinedMetricWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>

    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]</span>
    <span class="s3"># assert UndefinedMetricWarning because of no negative sample in y_true</span>
    <span class="s1">expected_message </span><span class="s2">= (</span>
        <span class="s6">&quot;No negative samples in y_true, false positive value should be meaningless&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UndefinedMetricWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s3"># Multi-label classification task</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_roc_curve_drop_intermediate</span><span class="s2">():</span>
    <span class="s3"># Test that drop_intermediate drops the correct thresholds</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>

    <span class="s3"># Test dropping thresholds with repeating scores</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">tpr</span><span class="s2">, </span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_roc_curve_fpr_tpr_increasing</span><span class="s2">():</span>
    <span class="s3"># Ensure that fpr and tpr returned by roc_curve are increasing.</span>
    <span class="s3"># Construct an edge case with float y_score and sample_weight</span>
    <span class="s3"># when some adjacent values of fpr and tpr are actually the same.</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]</span>
    <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">) &lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">() == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">tpr</span><span class="s2">) &lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">() == </span><span class="s5">0</span>


<span class="s0">def </span><span class="s1">test_auc</span><span class="s2">():</span>
    <span class="s3"># Test Area Under Curve (AUC) computation</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">auc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">auc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">auc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">auc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">auc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_auc_errors</span><span class="s2">():</span>
    <span class="s3"># Incompatible shapes</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">auc</span><span class="s2">([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">])</span>

    <span class="s3"># Too few x values</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">auc</span><span class="s2">([</span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">])</span>

    <span class="s3"># x is not in order</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">]</span>
    <span class="s1">error_message </span><span class="s2">= </span><span class="s6">&quot;x is neither increasing nor decreasing : {}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">error_message</span><span class="s2">)):</span>
        <span class="s1">auc</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, labels&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]), </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], </span><span class="s0">None</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multiclass_ovo_roc_auc_toydata</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">):</span>
    <span class="s3"># Tests the one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s3"># on a small example, representative of an expected use case.</span>
    <span class="s1">y_scores </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">], [</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">], [</span><span class="s5">0.35</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.15</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s3"># Used to compute the expected output.</span>
    <span class="s3"># Consider labels 0 and 1:</span>
    <span class="s3"># positive label is 0, negative label is 1</span>
    <span class="s1">score_01 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.35</span><span class="s2">])</span>
    <span class="s3"># positive label is 1, negative label is 0</span>
    <span class="s1">score_10 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">])</span>
    <span class="s1">average_score_01 </span><span class="s2">= (</span><span class="s1">score_01 </span><span class="s2">+ </span><span class="s1">score_10</span><span class="s2">) / </span><span class="s5">2</span>

    <span class="s3"># Consider labels 0 and 2:</span>
    <span class="s1">score_02 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.35</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">score_20 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.15</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">])</span>
    <span class="s1">average_score_02 </span><span class="s2">= (</span><span class="s1">score_02 </span><span class="s2">+ </span><span class="s1">score_20</span><span class="s2">) / </span><span class="s5">2</span>

    <span class="s3"># Consider labels 1 and 2:</span>
    <span class="s1">score_12 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">])</span>
    <span class="s1">score_21 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">])</span>
    <span class="s1">average_score_12 </span><span class="s2">= (</span><span class="s1">score_12 </span><span class="s2">+ </span><span class="s1">score_21</span><span class="s2">) / </span><span class="s5">2</span>

    <span class="s3"># Unweighted, one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s1">ovo_unweighted_score </span><span class="s2">= (</span><span class="s1">average_score_01 </span><span class="s2">+ </span><span class="s1">average_score_02 </span><span class="s2">+ </span><span class="s1">average_score_12</span><span class="s2">) / </span><span class="s5">3</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovo&quot;</span><span class="s2">),</span>
        <span class="s1">ovo_unweighted_score</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Weighted, one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s3"># Each term is weighted by the prevalence for the positive label.</span>
    <span class="s1">pair_scores </span><span class="s2">= [</span><span class="s1">average_score_01</span><span class="s2">, </span><span class="s1">average_score_02</span><span class="s2">, </span><span class="s1">average_score_12</span><span class="s2">]</span>
    <span class="s1">prevalence </span><span class="s2">= [</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.50</span><span class="s2">]</span>
    <span class="s1">ovo_weighted_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">average</span><span class="s2">(</span><span class="s1">pair_scores</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">=</span><span class="s1">prevalence</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span>
            <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span>
        <span class="s2">),</span>
        <span class="s1">ovo_weighted_score</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Check that average=None raises NotImplemented error</span>
    <span class="s1">error_message </span><span class="s2">= </span><span class="s6">&quot;average=None is not implemented for multi_class='ovo'.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_message</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, labels&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;d&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;d&quot;</span><span class="s2">]), [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;d&quot;</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multiclass_ovo_roc_auc_toydata_binary</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">):</span>
    <span class="s3"># Tests the one-vs-one multiclass ROC AUC algorithm for binary y_true</span>
    <span class="s3">#</span>
    <span class="s3"># on a small example, representative of an expected use case.</span>
    <span class="s1">y_scores </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">], [</span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">], [</span><span class="s5">0.55</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.45</span><span class="s2">], [</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s3"># Used to compute the expected output.</span>
    <span class="s3"># Consider labels 0 and 1:</span>
    <span class="s3"># positive label is 0, negative label is 1</span>
    <span class="s1">score_01 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.55</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">])</span>
    <span class="s3"># positive label is 1, negative label is 0</span>
    <span class="s1">score_10 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.45</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">])</span>
    <span class="s1">ovo_score </span><span class="s2">= (</span><span class="s1">score_01 </span><span class="s2">+ </span><span class="s1">score_10</span><span class="s2">) / </span><span class="s5">2</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovo&quot;</span><span class="s2">), </span><span class="s1">ovo_score</span>
    <span class="s2">)</span>

    <span class="s3"># Weighted, one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span>
            <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span>
        <span class="s2">),</span>
        <span class="s1">ovo_score</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, labels&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]), </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], </span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">], [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multiclass_ovr_roc_auc_toydata</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">):</span>
    <span class="s3"># Tests the unweighted, one-vs-rest multiclass ROC AUC algorithm</span>
    <span class="s3"># on a small example, representative of an expected use case.</span>
    <span class="s1">y_scores </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">], [</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s3"># Compute the expected result by individually computing the 'one-vs-rest'</span>
    <span class="s3"># ROC AUC scores for classes 0, 1, and 2.</span>
    <span class="s1">out_0 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">y_scores</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">out_1 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">y_scores</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">out_2 </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">y_scores</span><span class="s2">[:, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovr&quot;</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s0">None</span><span class="s2">),</span>
        <span class="s2">[</span><span class="s1">out_0</span><span class="s2">, </span><span class="s1">out_1</span><span class="s2">, </span><span class="s1">out_2</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s3"># Compute unweighted results (default behaviour is average=&quot;macro&quot;)</span>
    <span class="s1">result_unweighted </span><span class="s2">= (</span><span class="s1">out_0 </span><span class="s2">+ </span><span class="s1">out_1 </span><span class="s2">+ </span><span class="s1">out_2</span><span class="s2">) / </span><span class="s5">3.0</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovr&quot;</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">),</span>
        <span class="s1">result_unweighted</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Tests the weighted, one-vs-rest multiclass ROC AUC algorithm</span>
    <span class="s3"># on the same input (Provost &amp; Domingos, 2000)</span>
    <span class="s1">result_weighted </span><span class="s2">= </span><span class="s1">out_0 </span><span class="s2">* </span><span class="s5">0.25 </span><span class="s2">+ </span><span class="s1">out_1 </span><span class="s2">* </span><span class="s5">0.25 </span><span class="s2">+ </span><span class="s1">out_2 </span><span class="s2">* </span><span class="s5">0.5</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span>
            <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovr&quot;</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span>
        <span class="s2">),</span>
        <span class="s1">result_weighted</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;multi_class, average&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s6">&quot;ovr&quot;</span><span class="s2">, </span><span class="s6">&quot;macro&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;ovr&quot;</span><span class="s2">, </span><span class="s6">&quot;micro&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s6">&quot;macro&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_perfect_imperfect_chance_multiclass_roc_auc</span><span class="s2">(</span><span class="s1">multi_class</span><span class="s2">, </span><span class="s1">average</span><span class="s2">):</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

    <span class="s3"># Perfect classifier (from a ranking point of view) has roc_auc_score = 1.0</span>
    <span class="s1">y_perfect </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">, </span><span class="s5">0.05</span><span class="s2">, </span><span class="s5">0.15</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_perfect</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s1">multi_class</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s1">average</span><span class="s2">),</span>
        <span class="s5">1.0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Imperfect classifier has roc_auc_score &lt; 1.0</span>
    <span class="s1">y_imperfect </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_imperfect</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s1">multi_class</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s1">average</span><span class="s2">)</span>
        <span class="s2">&lt; </span><span class="s5">1.0</span>
    <span class="s2">)</span>

    <span class="s3"># Chance level classifier has roc_auc_score = 5.0</span>
    <span class="s1">y_chance </span><span class="s2">= </span><span class="s5">0.25 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_chance</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s1">multi_class</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s1">average</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_micro_averaged_ovr_roc_auc</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s1">seed </span><span class="s2">= </span><span class="s1">global_random_seed</span>
    <span class="s3"># Let's generate a set of random predictions and matching true labels such</span>
    <span class="s3"># that the predictions are not perfect. To make the problem more interesting,</span>
    <span class="s3"># we use an imbalanced class distribution (by using different parameters</span>
    <span class="s3"># in the Dirichlet prior (conjugate prior of the multinomial distribution).</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">dirichlet</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">([</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">stats</span><span class="s2">.</span><span class="s1">multinomial</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">p</span><span class="s2">=</span><span class="s1">y_pred_i</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">).</span><span class="s1">argmax</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">y_pred_i </span><span class="s0">in </span><span class="s1">y_pred</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">y_onehot </span><span class="s2">= </span><span class="s1">label_binarize</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_onehot</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">y_pred</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">roc_auc_by_hand </span><span class="s2">= </span><span class="s1">auc</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">tpr</span><span class="s2">)</span>
    <span class="s1">roc_auc_auto </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s6">&quot;ovr&quot;</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">roc_auc_by_hand </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">roc_auc_auto</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;msg, y_true, labels&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s6">&quot;Parameter 'labels' must be unique&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">(</span>
            <span class="s6">&quot;Parameter 'labels' must be unique&quot;</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">&quot;Number of classes in y_true not equal to the number of columns &quot;</span>
                <span class="s6">&quot;in 'y_score'&quot;</span>
            <span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s6">&quot;Parameter 'labels' must be ordered&quot;</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">&quot;Number of given labels, 2, not equal to the number of columns in &quot;</span>
                <span class="s6">&quot;'y_score', 3&quot;</span>
            <span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">&quot;Number of given labels, 2, not equal to the number of columns in &quot;</span>
                <span class="s6">&quot;'y_score', 3&quot;</span>
            <span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">&quot;Number of given labels, 4, not equal to the number of columns in &quot;</span>
                <span class="s6">&quot;'y_score', 3&quot;</span>
            <span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">&quot;Number of given labels, 4, not equal to the number of columns in &quot;</span>
                <span class="s6">&quot;'y_score', 3&quot;</span>
            <span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;d&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s6">&quot;'y_true' contains labels not in parameter 'labels'&quot;</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;e&quot;</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s6">&quot;'y_true' contains labels not in parameter 'labels'&quot;</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;d&quot;</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s6">&quot;'y_true' contains labels not in parameter 'labels'&quot;</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;multi_class&quot;</span><span class="s2">, [</span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s6">&quot;ovr&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_roc_auc_score_multiclass_labels_error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">):</span>
    <span class="s1">y_scores </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">], [</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">], [</span><span class="s5">0.35</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.15</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">multi_class</span><span class="s2">=</span><span class="s1">multi_class</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;msg, kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">r&quot;average must be one of \('macro', 'weighted', None\) for &quot;</span>
                <span class="s6">r&quot;multiclass problems&quot;</span>
            <span class="s2">),</span>
            <span class="s2">{</span><span class="s6">&quot;average&quot;</span><span class="s2">: </span><span class="s6">&quot;samples&quot;</span><span class="s2">, </span><span class="s6">&quot;multi_class&quot;</span><span class="s2">: </span><span class="s6">&quot;ovo&quot;</span><span class="s2">},</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">r&quot;average must be one of \('micro', 'macro', 'weighted', None\) for &quot;</span>
                <span class="s6">r&quot;multiclass problems&quot;</span>
            <span class="s2">),</span>
            <span class="s2">{</span><span class="s6">&quot;average&quot;</span><span class="s2">: </span><span class="s6">&quot;samples&quot;</span><span class="s2">, </span><span class="s6">&quot;multi_class&quot;</span><span class="s2">: </span><span class="s6">&quot;ovr&quot;</span><span class="s2">},</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">r&quot;sample_weight is not supported for multiclass one-vs-one &quot;</span>
                <span class="s6">r&quot;ROC AUC, 'sample_weight' must be None in this case&quot;</span>
            <span class="s2">),</span>
            <span class="s2">{</span><span class="s6">&quot;multi_class&quot;</span><span class="s2">: </span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s2">: []},</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s6">r&quot;Partial AUC computation not available in multiclass setting, &quot;</span>
                <span class="s6">r&quot;'max_fpr' must be set to `None`, received `max_fpr=0.5` &quot;</span>
                <span class="s6">r&quot;instead&quot;</span>
            <span class="s2">),</span>
            <span class="s2">{</span><span class="s6">&quot;multi_class&quot;</span><span class="s2">: </span><span class="s6">&quot;ovo&quot;</span><span class="s2">, </span><span class="s6">&quot;max_fpr&quot;</span><span class="s2">: </span><span class="s5">0.5</span><span class="s2">},</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s6">r&quot;multi_class must be in \('ovo', 'ovr'\)&quot;</span><span class="s2">, {}),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_roc_auc_score_multiclass_error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s3"># Test that roc_auc_score function returns an error when trying</span>
    <span class="s3"># to compute multiclass AUC for parameters where an output</span>
    <span class="s3"># is not defined.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s5">404</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">20</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">y_prob </span><span class="s2">= </span><span class="s1">softmax</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">20</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_prob</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_auc_score_non_binary_class</span><span class="s2">():</span>
    <span class="s3"># Test that roc_auc_score function returns an error when trying</span>
    <span class="s3"># to compute AUC for non-binary class values.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s5">404</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s3"># y_true contains only one class value</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;int&quot;</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">&quot;ROC AUC score is not defined&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;int&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;int&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">(</span><span class="s1">record</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s5">404</span><span class="s2">)</span>
        <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
        <span class="s3"># y_true contains only one class value</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;int&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;int&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;int&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;curve_func&quot;</span><span class="s2">, </span><span class="s1">CURVE_FUNCS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_multiclass_error</span><span class="s2">(</span><span class="s1">curve_func</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s5">404</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s6">&quot;multiclass format is not supported&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">curve_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;curve_func&quot;</span><span class="s2">, </span><span class="s1">CURVE_FUNCS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_implicit_pos_label</span><span class="s2">(</span><span class="s1">curve_func</span><span class="s2">):</span>
    <span class="s3"># Check that using string class labels raises an informative</span>
    <span class="s3"># error for any supported string dtype:</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s6">&quot;y_true takes value in {'a', 'b'} and pos_label is &quot;</span>
        <span class="s6">&quot;not specified: either make y_true take &quot;</span>
        <span class="s6">&quot;value in {0, 1} or {-1, 1} or pass pos_label &quot;</span>
        <span class="s6">&quot;explicitly.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">curve_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">&quot;&lt;U1&quot;</span><span class="s2">), [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">curve_func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">), [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s3"># Check that it is possible to use floating point class labels</span>
    <span class="s3"># that are interpreted similarly to integer class labels:</span>
    <span class="s1">y_pred </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.42</span><span class="s2">]</span>
    <span class="s1">int_curve </span><span class="s2">= </span><span class="s1">curve_func</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s1">float_curve </span><span class="s2">= </span><span class="s1">curve_func</span><span class="s2">([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], </span><span class="s1">y_pred</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">int_curve_part</span><span class="s2">, </span><span class="s1">float_curve_part </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">int_curve</span><span class="s2">, </span><span class="s1">float_curve</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">int_curve_part</span><span class="s2">, </span><span class="s1">float_curve_part</span><span class="s2">)</span>


<span class="s3"># TODO(1.7): Update test to check for error when bytes support is removed.</span>
<span class="s2">@</span><span class="s1">ignore_warnings</span><span class="s2">(</span><span class="s1">category</span><span class="s2">=</span><span class="s1">FutureWarning</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;curve_func&quot;</span><span class="s2">, [</span><span class="s1">precision_recall_curve</span><span class="s2">, </span><span class="s1">roc_curve</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;labels_type&quot;</span><span class="s2">, [</span><span class="s6">&quot;list&quot;</span><span class="s2">, </span><span class="s6">&quot;array&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_implicit_bytes_pos_label</span><span class="s2">(</span><span class="s1">curve_func</span><span class="s2">, </span><span class="s1">labels_type</span><span class="s2">):</span>
    <span class="s3"># Check that using bytes class labels raises an informative</span>
    <span class="s3"># error for any supported string dtype:</span>
    <span class="s1">labels </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">([</span><span class="s7">b&quot;a&quot;</span><span class="s2">, </span><span class="s7">b&quot;b&quot;</span><span class="s2">], </span><span class="s1">labels_type</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s6">&quot;y_true takes value in {b'a', b'b'} and pos_label is not &quot;</span>
        <span class="s6">&quot;specified: either make y_true take value in {0, 1} or &quot;</span>
        <span class="s6">&quot;{-1, 1} or pass pos_label explicitly.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">curve_func</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;curve_func&quot;</span><span class="s2">, </span><span class="s1">CURVE_FUNCS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_zero_sample_weight</span><span class="s2">(</span><span class="s1">curve_func</span><span class="s2">):</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]</span>
    <span class="s1">sample_weight </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>

    <span class="s1">result_1 </span><span class="s2">= </span><span class="s1">curve_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">)</span>
    <span class="s1">result_2 </span><span class="s2">= </span><span class="s1">curve_func</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">y_score</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">])</span>

    <span class="s0">for </span><span class="s1">arr_1</span><span class="s2">, </span><span class="s1">arr_2 </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">result_1</span><span class="s2">, </span><span class="s1">result_2</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">arr_1</span><span class="s2">, </span><span class="s1">arr_2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;drop&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_precision_recall_curve</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">_test_precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">)</span>

    <span class="s3"># Make sure the first point of the Precision-Recall on the right is:</span>
    <span class="s3"># (p=1.0, r=class balance) on a non-balanced dataset [1:]</span>
    <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">t </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">y_score</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">r</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">1.0</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">y_true</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:].</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s3"># Use {-1, 1} for labels; make sure original labels aren't modified</span>
    <span class="s1">y_true</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">y_true </span><span class="s2">== </span><span class="s5">0</span><span class="s2">)] = -</span><span class="s5">1</span>
    <span class="s1">y_true_copy </span><span class="s2">= </span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">_test_precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_true_copy</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">)</span>

    <span class="s1">labels </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">predict_probas </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]</span>
    <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">t </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">predict_probas</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">drop</span><span class="s2">:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.33333333</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.33333333</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">r</span><span class="s2">.</span><span class="s1">size</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">t</span><span class="s2">.</span><span class="s1">size </span><span class="s2">+ </span><span class="s5">1</span>


<span class="s0">def </span><span class="s1">_test_precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s3"># Test Precision-Recall and area under PR curve</span>
    <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">precision_recall_auc </span><span class="s2">= </span><span class="s1">_average_precision_slow</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">precision_recall_auc</span><span class="s2">, </span><span class="s5">0.859</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">precision_recall_auc</span><span class="s2">, </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s3"># `_average_precision` is not very precise in case of 0.5 ties: be tolerant</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">_average_precision</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">), </span><span class="s1">precision_recall_auc</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">r</span><span class="s2">.</span><span class="s1">size</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">size </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s3"># Smoke test in the case of proba having only one value</span>
    <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">), </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">r</span><span class="s2">.</span><span class="s1">size</span>
    <span class="s0">assert </span><span class="s1">p</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">thresholds</span><span class="s2">.</span><span class="s1">size </span><span class="s2">+ </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;drop&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_precision_recall_curve_toydata</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">&quot;raise&quot;</span><span class="s2">):</span>
        <span class="s3"># Binary classification</span>
        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s1">auc_prc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">auc_prc</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s1">auc_prc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
        <span class="s3"># Here we are doing a terrible prediction: we are always getting</span>
        <span class="s3"># it wrong, hence the average_precision_score is the accuracy at</span>
        <span class="s3"># chance: 50%</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">auc_prc</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s1">auc_prc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">auc_prc</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s1">auc_prc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">auc_prc</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s1">auc_prc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">auc_prc</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">auc_prc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">auc_prc</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]</span>
        <span class="s1">p</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>

        <span class="s3"># Multi-label classification task</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
            <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">1.0</span>
            <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">1.0</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
            <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">1.0</span>
            <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0.75</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0.0</span>
            <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">0.0</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0.0</span>
            <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0.0</span>
            <span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">1.0</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">1.0</span>
        <span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">1.0</span><span class="s2">)</span>

        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]])</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;macro&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;samples&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;micro&quot;</span><span class="s2">), </span><span class="s5">0.5</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">&quot;ignore&quot;</span><span class="s2">):</span>
        <span class="s3"># if one class is never present weighted should not be NaN</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;No positive class found in y_true&quot;</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">average</span><span class="s2">=</span><span class="s6">&quot;weighted&quot;</span><span class="s2">), </span><span class="s5">1</span>
            <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_precision_recall_curve_drop_intermediate</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Check the behaviour of the `drop_intermediate` parameter.&quot;&quot;&quot;</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">precision</span><span class="s2">, </span><span class="s1">recall</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s3"># Test dropping thresholds with repeating scores</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">precision</span><span class="s2">, </span><span class="s1">recall</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s3"># Test all false keeps only endpoints</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">]</span>
    <span class="s1">precision</span><span class="s2">, </span><span class="s1">recall</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">])</span>

    <span class="s3"># Test all true keeps all thresholds</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">]</span>
    <span class="s1">precision</span><span class="s2">, </span><span class="s1">recall</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">precision_recall_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">drop_intermediate</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">, [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_average_precision_constant_values</span><span class="s2">():</span>
    <span class="s3"># Check the average_precision_score of a constant predictor is</span>
    <span class="s3"># the TPR</span>

    <span class="s3"># Generate a dataset with 25% of positives</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">y_true</span><span class="s2">[::</span><span class="s5">4</span><span class="s2">] = </span><span class="s5">1</span>
    <span class="s3"># And a constant score</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s3"># The precision is then the fraction of positive whatever the recall</span>
    <span class="s3"># is, as there is only one threshold:</span>
    <span class="s0">assert </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">) == </span><span class="s5">0.25</span>


<span class="s0">def </span><span class="s1">test_average_precision_score_binary_pos_label_errors</span><span class="s2">():</span>
    <span class="s3"># Raise an error when pos_label is not in binary y_true</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s6">r&quot;pos_label=2 is not a valid label. It should be one of \[0, 1\]&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">pos_label</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_average_precision_score_multilabel_pos_label_errors</span><span class="s2">():</span>
    <span class="s3"># Raise an error for multilabel-indicator y_true with</span>
    <span class="s3"># pos_label other than 1</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">], [</span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">], [</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">]])</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s6">&quot;Parameter pos_label is fixed to 1 for multilabel-indicator y_true. &quot;</span>
        <span class="s6">&quot;Do not set pos_label or set pos_label to 1.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">pos_label</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_average_precision_score_multiclass_pos_label_errors</span><span class="s2">():</span>
    <span class="s3"># Raise an error for multiclass y_true with pos_label other than 1</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s6">&quot;Parameter pos_label is fixed to 1 for multiclass y_true. &quot;</span>
        <span class="s6">&quot;Do not set pos_label or set pos_label to 1.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">pos_label</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_score_scale_invariance</span><span class="s2">():</span>
    <span class="s3"># Test that average_precision_score and roc_auc_score are invariant by</span>
    <span class="s3"># the scaling or shifting of probabilities</span>
    <span class="s3"># This test was expanded (added scaled_down) in response to github</span>
    <span class="s3"># issue #3864 (and others), where overly aggressive rounding was causing</span>
    <span class="s3"># problems for users with very small y_score values</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc_scaled_up </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s5">100 </span><span class="s2">* </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc_scaled_down </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s5">1e-6 </span><span class="s2">* </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">roc_auc_shifted </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">- </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">roc_auc </span><span class="s2">== </span><span class="s1">roc_auc_scaled_up</span>
    <span class="s0">assert </span><span class="s1">roc_auc </span><span class="s2">== </span><span class="s1">roc_auc_scaled_down</span>
    <span class="s0">assert </span><span class="s1">roc_auc </span><span class="s2">== </span><span class="s1">roc_auc_shifted</span>

    <span class="s1">pr_auc </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">pr_auc_scaled_up </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s5">100 </span><span class="s2">* </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">pr_auc_scaled_down </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s5">1e-6 </span><span class="s2">* </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">pr_auc_shifted </span><span class="s2">= </span><span class="s1">average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">- </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pr_auc </span><span class="s2">== </span><span class="s1">pr_auc_scaled_up</span>
    <span class="s0">assert </span><span class="s1">pr_auc </span><span class="s2">== </span><span class="s1">pr_auc_scaled_down</span>
    <span class="s0">assert </span><span class="s1">pr_auc </span><span class="s2">== </span><span class="s1">pr_auc_shifted</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true,y_score,expected_fpr,expected_fnr&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_toydata</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">expected_fpr</span><span class="s2">, </span><span class="s1">expected_fnr</span><span class="s2">):</span>
    <span class="s3"># Check on a batch of small examples.</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">fnr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">det_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">expected_fpr</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fnr</span><span class="s2">, </span><span class="s1">expected_fnr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true,y_score,expected_fpr,expected_fnr&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_tie_handling</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">expected_fpr</span><span class="s2">, </span><span class="s1">expected_fnr</span><span class="s2">):</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">fnr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">det_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, </span><span class="s1">expected_fpr</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fnr</span><span class="s2">, </span><span class="s1">expected_fnr</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_det_curve_sanity_check</span><span class="s2">():</span>
    <span class="s3"># Exactly duplicated inputs yield the same result.</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">det_curve</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s1">det_curve</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;y_score&quot;</span><span class="s2">, [(</span><span class="s5">0</span><span class="s2">), (</span><span class="s5">0.25</span><span class="s2">), (</span><span class="s5">0.5</span><span class="s2">), (</span><span class="s5">0.75</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_det_curve_constant_scores</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">fnr</span><span class="s2">, </span><span class="s1">threshold </span><span class="s2">= </span><span class="s1">det_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">y_score</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fnr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">threshold</span><span class="s2">, [</span><span class="s1">y_score</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_perfect_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">):</span>
    <span class="s1">fpr</span><span class="s2">, </span><span class="s1">fnr</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">det_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">=</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">=</span><span class="s1">y_true</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fpr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fnr</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, y_pred, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s6">&quot;inconsistent numbers of samples&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], </span><span class="s6">&quot;inconsistent numbers of samples&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s6">&quot;Only one class present in y_true&quot;</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s6">&quot;Only one class present in y_true&quot;</span><span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s6">&quot;cancer&quot;</span><span class="s2">, </span><span class="s6">&quot;cancer&quot;</span><span class="s2">, </span><span class="s6">&quot;not cancer&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">],</span>
            <span class="s6">&quot;pos_label is not specified&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_bad_input</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s3"># input variables with inconsistent numbers of samples</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">det_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_det_curve_pos_label</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s6">&quot;cancer&quot;</span><span class="s2">] * </span><span class="s5">3 </span><span class="s2">+ [</span><span class="s6">&quot;not cancer&quot;</span><span class="s2">] * </span><span class="s5">7</span>
    <span class="s1">y_pred_pos_not_cancer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">])</span>
    <span class="s1">y_pred_pos_cancer </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">- </span><span class="s1">y_pred_pos_not_cancer</span>

    <span class="s1">fpr_pos_cancer</span><span class="s2">, </span><span class="s1">fnr_pos_cancer</span><span class="s2">, </span><span class="s1">th_pos_cancer </span><span class="s2">= </span><span class="s1">det_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">,</span>
        <span class="s1">y_pred_pos_cancer</span><span class="s2">,</span>
        <span class="s1">pos_label</span><span class="s2">=</span><span class="s6">&quot;cancer&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">fpr_pos_not_cancer</span><span class="s2">, </span><span class="s1">fnr_pos_not_cancer</span><span class="s2">, </span><span class="s1">th_pos_not_cancer </span><span class="s2">= </span><span class="s1">det_curve</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">,</span>
        <span class="s1">y_pred_pos_not_cancer</span><span class="s2">,</span>
        <span class="s1">pos_label</span><span class="s2">=</span><span class="s6">&quot;not cancer&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># check that the first threshold will change depending which label we</span>
    <span class="s3"># consider positive</span>
    <span class="s0">assert </span><span class="s1">th_pos_cancer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">0.4</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">th_pos_not_cancer</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">)</span>

    <span class="s3"># check for the symmetry of the fpr and fnr</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fpr_pos_cancer</span><span class="s2">, </span><span class="s1">fnr_pos_not_cancer</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">fnr_pos_cancer</span><span class="s2">, </span><span class="s1">fpr_pos_not_cancer</span><span class="s2">[::-</span><span class="s5">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">check_lrap_toy</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">):</span>
    <span class="s3"># Check on several small example that it works</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), (</span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">1</span><span class="s2">) / </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), (</span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">2</span>
    <span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), (</span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), (</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), (</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), (</span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s3"># Tie handling</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), (</span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), (</span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">3 </span><span class="s2">/ </span><span class="s5">4</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_zero_or_all_relevant_labels</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">):</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">n_labels </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">):</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>
        <span class="s1">y_score_ties </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">)</span>

        <span class="s3"># No relevant labels</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">) == </span><span class="s5">1.0</span>
        <span class="s0">assert </span><span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score_ties</span><span class="s2">) == </span><span class="s5">1.0</span>

        <span class="s3"># Only relevant labels</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">) == </span><span class="s5">1.0</span>
        <span class="s0">assert </span><span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score_ties</span><span class="s2">) == </span><span class="s5">1.0</span>

    <span class="s3"># Degenerate case: only one label</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1.0</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_lrap_error_raised</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">):</span>
    <span class="s3"># Raise value error if not appropriate format</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">)], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">]]</span>
        <span class="s2">)</span>

    <span class="s3"># Check that y_true.shape != y_score.shape raise the proper exception</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">lrap_score</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">check_lrap_only_ties</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">):</span>
    <span class="s3"># Check tie handling in score</span>
    <span class="s3"># Basic check with only ties and increasing label space</span>
    <span class="s0">for </span><span class="s1">n_labels </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">):</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>

        <span class="s3"># Check for growing number of consecutive relevant</span>
        <span class="s0">for </span><span class="s1">n_relevant </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">):</span>
            <span class="s3"># Check for a bunch of positions</span>
            <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_labels </span><span class="s2">- </span><span class="s1">n_relevant</span><span class="s2">):</span>
                <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>
                <span class="s1">y_true</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">pos </span><span class="s2">: </span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">n_relevant</span><span class="s2">] = </span><span class="s5">1</span>
                <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">), </span><span class="s1">n_relevant </span><span class="s2">/ </span><span class="s1">n_labels</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_lrap_without_tie_and_increasing_score</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">):</span>
    <span class="s3"># Check that Label ranking average precision works for various</span>
    <span class="s3"># Basic check with increasing label space size and decreasing score</span>
    <span class="s0">for </span><span class="s1">n_labels </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">):</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">n_labels </span><span class="s2">- (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n_labels</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">)) + </span><span class="s5">1</span><span class="s2">)</span>

        <span class="s3"># First and last</span>
        <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>
        <span class="s1">y_true</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] = </span><span class="s5">1</span>
        <span class="s1">y_true</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">] = </span><span class="s5">1</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">), (</span><span class="s5">2 </span><span class="s2">/ </span><span class="s1">n_labels </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / </span><span class="s5">2</span><span class="s2">)</span>

        <span class="s3"># Check for growing number of consecutive relevant label</span>
        <span class="s0">for </span><span class="s1">n_relevant </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">):</span>
            <span class="s3"># Check for a bunch of position</span>
            <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_labels </span><span class="s2">- </span><span class="s1">n_relevant</span><span class="s2">):</span>
                <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_labels</span><span class="s2">))</span>
                <span class="s1">y_true</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">pos </span><span class="s2">: </span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">n_relevant</span><span class="s2">] = </span><span class="s5">1</span>
                <span class="s1">assert_almost_equal</span><span class="s2">(</span>
                    <span class="s1">lrap_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">),</span>
                    <span class="s1">sum</span><span class="s2">(</span>
                        <span class="s2">(</span><span class="s1">r </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / ((</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">r </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) * </span><span class="s1">n_relevant</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_relevant</span><span class="s2">)</span>
                    <span class="s2">),</span>
                <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_my_lrap</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Simple implementation of label ranking average precision&quot;&quot;&quot;</span>
    <span class="s1">check_consistent_length</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">check_array</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">check_array</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_labels </span><span class="s2">= </span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s1">score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">n_samples</span><span class="s2">,))</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">):</span>
        <span class="s3"># The best rank correspond to 1. Rank higher than 1 are worse.</span>
        <span class="s3"># The best inverse ranking correspond to n_labels.</span>
        <span class="s1">unique_rank</span><span class="s2">, </span><span class="s1">inv_rank </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">return_inverse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">n_ranks </span><span class="s2">= </span><span class="s1">unique_rank</span><span class="s2">.</span><span class="s1">size</span>
        <span class="s1">rank </span><span class="s2">= </span><span class="s1">n_ranks </span><span class="s2">- </span><span class="s1">inv_rank</span>

        <span class="s3"># Rank need to be corrected to take into account ties</span>
        <span class="s3"># ex: rank 1 ex aequo means that both label are rank 2.</span>
        <span class="s1">corr_rank </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bincount</span><span class="s2">(</span><span class="s1">rank</span><span class="s2">, </span><span class="s1">minlength</span><span class="s2">=</span><span class="s1">n_ranks </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">).</span><span class="s1">cumsum</span><span class="s2">()</span>
        <span class="s1">rank </span><span class="s2">= </span><span class="s1">corr_rank</span><span class="s2">[</span><span class="s1">rank</span><span class="s2">]</span>

        <span class="s1">relevant </span><span class="s2">= </span><span class="s1">y_true</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">nonzero</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">relevant</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s5">0 </span><span class="s0">or </span><span class="s1">relevant</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">n_labels</span><span class="s2">:</span>
            <span class="s1">score</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s5">1</span>
            <span class="s0">continue</span>

        <span class="s1">score</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s5">0.0</span>
        <span class="s0">for </span><span class="s1">label </span><span class="s0">in </span><span class="s1">relevant</span><span class="s2">:</span>
            <span class="s3"># Let's count the number of relevant label with better rank</span>
            <span class="s3"># (smaller rank).</span>
            <span class="s1">n_ranked_above </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">rank</span><span class="s2">[</span><span class="s1">r</span><span class="s2">] &lt;= </span><span class="s1">rank</span><span class="s2">[</span><span class="s1">label</span><span class="s2">] </span><span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">relevant</span><span class="s2">)</span>

            <span class="s3"># Weight by the rank of the actual label</span>
            <span class="s1">score</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] += </span><span class="s1">n_ranked_above </span><span class="s2">/ </span><span class="s1">rank</span><span class="s2">[</span><span class="s1">label</span><span class="s2">]</span>

        <span class="s1">score</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] /= </span><span class="s1">relevant</span><span class="s2">.</span><span class="s1">size</span>

    <span class="s0">return </span><span class="s1">score</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">check_alternative_lrap_implementation</span><span class="s2">(</span>
    <span class="s1">lrap_score</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span>
<span class="s2">):</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">y_true </span><span class="s2">= </span><span class="s1">make_multilabel_classification</span><span class="s2">(</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">allow_unlabeled</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
        <span class="s1">n_classes</span><span class="s2">=</span><span class="s1">n_classes</span><span class="s2">,</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Score with ties</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">_sparse_random_matrix</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">],</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">, </span><span class="s6">&quot;toarray&quot;</span><span class="s2">):</span>
        <span class="s1">y_score </span><span class="s2">= </span><span class="s1">y_score</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">score_lrap </span><span class="s2">= </span><span class="s1">label_ranking_average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">score_my_lrap </span><span class="s2">= </span><span class="s1">_my_lrap</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">score_lrap</span><span class="s2">, </span><span class="s1">score_my_lrap</span><span class="s2">)</span>

    <span class="s3"># Uniform score</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">check_random_state</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">))</span>
    <span class="s1">score_lrap </span><span class="s2">= </span><span class="s1">label_ranking_average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">score_my_lrap </span><span class="s2">= </span><span class="s1">_my_lrap</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">score_lrap</span><span class="s2">, </span><span class="s1">score_my_lrap</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;check&quot;</span><span class="s2">,</span>
    <span class="s2">(</span>
        <span class="s1">check_lrap_toy</span><span class="s2">,</span>
        <span class="s1">check_lrap_without_tie_and_increasing_score</span><span class="s2">,</span>
        <span class="s1">check_lrap_only_ties</span><span class="s2">,</span>
        <span class="s1">check_zero_or_all_relevant_labels</span><span class="s2">,</span>
    <span class="s2">),</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;func&quot;</span><span class="s2">, (</span><span class="s1">label_ranking_average_precision_score</span><span class="s2">, </span><span class="s1">_my_lrap</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_label_ranking_avp</span><span class="s2">(</span><span class="s1">check</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_lrap_error_raised</span><span class="s2">():</span>
    <span class="s1">check_lrap_error_raised</span><span class="s2">(</span><span class="s1">label_ranking_average_precision_score</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;n_samples&quot;</span><span class="s2">, (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">20</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;n_classes&quot;</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;random_state&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_alternative_lrap_implementation</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">):</span>
    <span class="s1">check_alternative_lrap_implementation</span><span class="s2">(</span>
        <span class="s1">label_ranking_average_precision_score</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">random_state</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_lrap_sample_weighting_zero_labels</span><span class="s2">():</span>
    <span class="s3"># Degenerate sample labeling (e.g., zero labels for a sample) is a valid</span>
    <span class="s3"># special case for lrap (the sample is considered to achieve perfect</span>
    <span class="s3"># precision), but this case is not tested in test_common.</span>
    <span class="s3"># For these test samples, the APs are 0.5, 0.75, and 1.0 (default for zero</span>
    <span class="s3"># labels).</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">], [</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">], [</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s1">samplewise_lraps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>
    <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">label_ranking_average_precision_score</span><span class="s2">(</span>
            <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span>
        <span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">sample_weight </span><span class="s2">* </span><span class="s1">samplewise_lraps</span><span class="s2">) / </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">sample_weight</span><span class="s2">),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_coverage_error</span><span class="s2">():</span>
    <span class="s3"># Toy case</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>

    <span class="s3"># Non trivial case</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10.0</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
        <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">2.0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">coverage_error</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">3.0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">coverage_error</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">3</span><span class="s2">) / </span><span class="s5">3.0</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_coverage_tie_handling</span><span class="s2">():</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">coverage_error</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, y_score&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]),</span>
        <span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_coverage_1d_error_message</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s3"># Non-regression test for:</span>
    <span class="s3"># https://github.com/scikit-learn/scikit-learn/issues/23368</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">r&quot;Expected 2D array, got 1D array instead&quot;</span><span class="s2">):</span>
        <span class="s1">coverage_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_label_ranking_loss</span><span class="s2">():</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">]]), </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>

    <span class="s3"># Undefined metrics -  the ranking doesn't matter</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>

    <span class="s3"># Non trivial case</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10.0</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
        <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">2.0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">label_ranking_loss</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">3.0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">label_ranking_loss</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">3.0</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_label_ranking_loss_sparse</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span>
        <span class="s1">label_ranking_loss</span><span class="s2">(</span>
            <span class="s1">csr_container</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])), [[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, -</span><span class="s5">3</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">) / </span><span class="s5">2.0</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ranking_appropriate_input_shape</span><span class="s2">():</span>
    <span class="s3"># Check that y_true.shape != y_score.shape raise the proper exception</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ranking_loss_ties_handling</span><span class="s2">():</span>
    <span class="s3"># Tie handling</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">label_ranking_loss</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [[</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]]), </span><span class="s5">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_dcg_score</span><span class="s2">():</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">y_true </span><span class="s2">= </span><span class="s1">make_multilabel_classification</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= -</span><span class="s1">y_true </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s1">_test_dcg_score_for</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">_test_dcg_score_for</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_test_dcg_score_for</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s1">discount </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]) + </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">ideal </span><span class="s2">= </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">)</span>
    <span class="s1">score </span><span class="s2">= </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">score </span><span class="s2">&lt;= </span><span class="s1">ideal</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s5">5</span><span class="s2">) &lt;= </span><span class="s1">ideal</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ideal</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],)</span>
    <span class="s0">assert </span><span class="s1">score</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],)</span>
    <span class="s0">assert </span><span class="s1">ideal </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">)[:, ::-</span><span class="s5">1</span><span class="s2">] / </span><span class="s1">discount</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_dcg_ties</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">dcg </span><span class="s2">= </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">dcg_ignore_ties </span><span class="s2">= </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">discounts </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">dcg </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">([</span><span class="s1">discounts</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() * </span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()])</span>
    <span class="s0">assert </span><span class="s1">dcg_ignore_ties </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">([(</span><span class="s1">discounts </span><span class="s2">* </span><span class="s1">y_true</span><span class="s2">[:, ::-</span><span class="s5">1</span><span class="s2">]).</span><span class="s1">sum</span><span class="s2">()])</span>
    <span class="s1">y_score</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">:] = </span><span class="s5">1</span>
    <span class="s1">dcg </span><span class="s2">= </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">dcg_ignore_ties </span><span class="s2">= </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dcg_ignore_ties </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">([(</span><span class="s1">discounts </span><span class="s2">* </span><span class="s1">y_true</span><span class="s2">[:, ::-</span><span class="s5">1</span><span class="s2">]).</span><span class="s1">sum</span><span class="s2">()])</span>
    <span class="s0">assert </span><span class="s1">dcg </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">discounts</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">() * </span><span class="s1">y_true</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">:].</span><span class="s1">mean</span><span class="s2">()</span>
            <span class="s2">+ </span><span class="s1">discounts</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:].</span><span class="s1">sum</span><span class="s2">() * </span><span class="s1">y_true</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, :</span><span class="s5">3</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">()</span>
        <span class="s2">]</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_ignore_ties_with_k</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span>
        <span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_negative_ndarray_error</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Check `ndcg_score` exception when `y_true` contains negative values.&quot;&quot;&quot;</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s5">0.89</span><span class="s2">, -</span><span class="s5">0.53</span><span class="s2">, -</span><span class="s5">0.47</span><span class="s2">, </span><span class="s5">0.39</span><span class="s2">, </span><span class="s5">0.56</span><span class="s2">]])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.07</span><span class="s2">, </span><span class="s5">0.31</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.33</span><span class="s2">, </span><span class="s5">0.27</span><span class="s2">]])</span>
    <span class="s1">expected_message </span><span class="s2">= </span><span class="s6">&quot;ndcg_score should not be used on negative y_true values&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_invariant</span><span class="s2">():</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">70</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">7</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">y_true </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">uniform</span><span class="s2">(-</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">ndcg </span><span class="s2">= </span><span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">ndcg_no_ties </span><span class="s2">= </span><span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ndcg </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ndcg_no_ties</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ndcg </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">+= </span><span class="s5">1000</span>
    <span class="s0">assert </span><span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;ignore_ties&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ndcg_toy_examples</span><span class="s2">(</span><span class="s1">ignore_ties</span><span class="s2">):</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s5">3 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s5">7</span><span class="s2">)[:</span><span class="s5">5</span><span class="s2">]</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">), (</span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
    <span class="s1">y_score_noisy </span><span class="s2">= </span><span class="s1">y_score </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">uniform</span><span class="s2">(</span>
        <span class="s2">-</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">y_score</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">3 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score_noisy</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">3 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">_ndcg_sample_scores</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">log_base</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">3 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log10</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s5">1 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s5">3 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))).</span><span class="s1">mean</span><span class="s2">()</span>
    <span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s5">3 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">5</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))</span>
    <span class="s1">expected_dcg_score </span><span class="s2">= (</span><span class="s5">3 </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">9</span><span class="s2">))).</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">expected_dcg_score </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">_ndcg_sample_scores</span><span class="s2">(</span>
        <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span>
    <span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">dcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span>
        <span class="s1">expected_dcg_score</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ndcg_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">ignore_ties</span><span class="s2">=</span><span class="s1">ignore_ties</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_error_single_document</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Check that we raise an informative error message when trying to 
    compute NDCG with a single document.&quot;&quot;&quot;</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s6">&quot;Computing NDCG is only meaningful when there is more than 1 document. &quot;</span>
        <span class="s6">&quot;Got 1 instead.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">ndcg_score</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">]], [[</span><span class="s5">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ndcg_score</span><span class="s2">():</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">y_true </span><span class="s2">= </span><span class="s1">make_multilabel_classification</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">n_classes</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= -</span><span class="s1">y_true </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s1">_test_ndcg_score_for</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">random_sample</span><span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">_test_ndcg_score_for</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_test_ndcg_score_for</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">):</span>
    <span class="s1">ideal </span><span class="s2">= </span><span class="s1">_ndcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">)</span>
    <span class="s1">score </span><span class="s2">= </span><span class="s1">_ndcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">score </span><span class="s2">&lt;= </span><span class="s1">ideal</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s1">all_zero </span><span class="s2">= (</span><span class="s1">y_true </span><span class="s2">== </span><span class="s5">0</span><span class="s2">).</span><span class="s1">all</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ideal</span><span class="s2">[~</span><span class="s1">all_zero</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((~</span><span class="s1">all_zero</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()))</span>
    <span class="s0">assert </span><span class="s1">ideal</span><span class="s2">[</span><span class="s1">all_zero</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">all_zero</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()))</span>
    <span class="s0">assert </span><span class="s1">score</span><span class="s2">[~</span><span class="s1">all_zero</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span>
        <span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)[~</span><span class="s1">all_zero</span><span class="s2">]</span>
        <span class="s2">/ </span><span class="s1">_dcg_sample_scores</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">)[~</span><span class="s1">all_zero</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">score</span><span class="s2">[</span><span class="s1">all_zero</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">all_zero</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()))</span>
    <span class="s0">assert </span><span class="s1">ideal</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],)</span>
    <span class="s0">assert </span><span class="s1">score</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">y_true</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],)</span>


<span class="s0">def </span><span class="s1">test_partial_roc_auc_score</span><span class="s2">():</span>
    <span class="s3"># Check `roc_auc_score` for max_fpr != `None`</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s5">1</span><span class="s2">) == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s5">0.001</span><span class="s2">) == </span><span class="s5">1</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=-</span><span class="s5">0.1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s5">1.1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">y_scores </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">])</span>
    <span class="s1">roc_auc_with_max_fpr_one </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">unconstrained_roc_auc </span><span class="s2">= </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">roc_auc_with_max_fpr_one </span><span class="s2">== </span><span class="s1">unconstrained_roc_auc</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_scores</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s5">0.3</span><span class="s2">) == </span><span class="s5">0.5</span>

    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">max_fpr </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">1e-4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">):</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span>
            <span class="s1">roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">=</span><span class="s1">max_fpr</span><span class="s2">),</span>
            <span class="s1">_partial_roc_auc_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">max_fpr</span><span class="s2">),</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, k, true_score&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">true_score</span><span class="s2">):</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">score </span><span class="s2">= </span><span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">score </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">true_score</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_score, k, true_score&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]), </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]), </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]), </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">]), </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">]), </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">]), </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_binary</span><span class="s2">(</span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">true_score</span><span class="s2">):</span>
    <span class="s1">y_true </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">threshold </span><span class="s2">= </span><span class="s5">0.5 </span><span class="s0">if </span><span class="s1">y_score</span><span class="s2">.</span><span class="s1">min</span><span class="s2">() &gt;= </span><span class="s5">0 </span><span class="s0">and </span><span class="s1">y_score</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() &lt;= </span><span class="s5">1 </span><span class="s0">else </span><span class="s5">0</span>
    <span class="s1">y_pred </span><span class="s2">= (</span><span class="s1">y_score </span><span class="s2">&gt; </span><span class="s1">threshold</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">) </span><span class="s0">if </span><span class="s1">k </span><span class="s2">== </span><span class="s5">1 </span><span class="s0">else </span><span class="s1">y_true</span>

    <span class="s1">score </span><span class="s2">= </span><span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
    <span class="s1">score_acc </span><span class="s2">= </span><span class="s1">accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_pred</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">score </span><span class="s2">== </span><span class="s1">score_acc </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">true_score</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, true_score, labels&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]), </span><span class="s5">0.75</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]), </span><span class="s5">0.5</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]), </span><span class="s5">0.5</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;e&quot;</span><span class="s2">, </span><span class="s6">&quot;e&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">]), </span><span class="s5">0.75</span><span class="s2">, [</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;d&quot;</span><span class="s2">, </span><span class="s6">&quot;e&quot;</span><span class="s2">]),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;labels_as_ndarray&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_multiclass_with_labels</span><span class="s2">(</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">true_score</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">, </span><span class="s1">labels_as_ndarray</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test when labels and y_score are multiclass.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">labels_as_ndarray</span><span class="s2">:</span>
        <span class="s1">labels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">score </span><span class="s2">= </span><span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">score </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">true_score</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_increasing</span><span class="s2">():</span>
    <span class="s3"># Make sure increasing k leads to a higher score</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_classes</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span>
    <span class="s2">)</span>

    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">LogisticRegression</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">y_train</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">((</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">), (</span><span class="s1">y_train</span><span class="s2">, </span><span class="s1">y_test</span><span class="s2">)):</span>
        <span class="s1">scores </span><span class="s2">= [</span>
            <span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
        <span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">scores</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, k, true_score&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_ties</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">true_score</span><span class="s2">):</span>
    <span class="s3"># Make sure highest indices labels are chosen first in case of ties</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">true_score</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, k&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">4</span><span class="s2">),</span>
        <span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s5">5</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_warning</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">expected_message </span><span class="s2">= (</span>
        <span class="s6">r&quot;'k' \(\d+\) greater than or equal to 'n_classes' \(\d+\) will result in a &quot;</span>
        <span class="s6">&quot;perfect score and is therefore meaningless.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UndefinedMetricWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_message</span><span class="s2">):</span>
        <span class="s1">score </span><span class="s2">= </span><span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">score </span><span class="s2">== </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;y_true, y_score, labels, msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.57</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s0">None</span><span class="s2">,</span>
            <span class="s6">&quot;y type must be 'binary' or 'multiclass', got 'continuous'&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s0">None</span><span class="s2">,</span>
            <span class="s6">r&quot;Number of classes in 'y_true' \(4\) not equal to the number of &quot;</span>
            <span class="s6">r&quot;classes in 'y_score' \(3\).&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">],</span>
            <span class="s6">&quot;Parameter 'labels' must be unique.&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s2">[</span><span class="s6">&quot;a&quot;</span><span class="s2">, </span><span class="s6">&quot;c&quot;</span><span class="s2">, </span><span class="s6">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s6">&quot;Parameter 'labels' must be ordered.&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
            <span class="s6">r&quot;Number of given labels \(4\) not equal to the number of classes in &quot;</span>
            <span class="s6">r&quot;'y_score' \(3\).&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
            <span class="s6">&quot;'y_true' contains labels not in parameter 'labels'.&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">], [</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">]],</span>
            <span class="s0">None</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s6">&quot;`y_true` is binary while y_score is 2d with 3 classes. If&quot;</span>
                <span class="s6">&quot; `y_true` does not contain all the labels, `labels` must be provided&quot;</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_error</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">top_k_accuracy_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_label_ranking_avg_precision_score_should_allow_csr_matrix_for_y_true_input</span><span class="s2">(</span>
    <span class="s1">csr_container</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s3"># Test that label_ranking_avg_precision_score accept sparse y_true.</span>
    <span class="s3"># Non-regression test for #22575</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">label_ranking_average_precision_score</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;metric&quot;</span><span class="s2">, [</span><span class="s1">average_precision_score</span><span class="s2">, </span><span class="s1">det_curve</span><span class="s2">, </span><span class="s1">precision_recall_curve</span><span class="s2">, </span><span class="s1">roc_curve</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;classes&quot;</span><span class="s2">, [(</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">), (</span><span class="s6">&quot;zero&quot;</span><span class="s2">, </span><span class="s6">&quot;one&quot;</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ranking_metric_pos_label_types</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Check that the metric works with different types of `pos_label`. 
 
    We can expect `pos_label` to be a bool, an integer, a float, a string. 
    No error should be raised for those types. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">pos_label </span><span class="s2">= </span><span class="s5">10</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">classes</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">y_proba </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">metric</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_proba</span><span class="s2">, </span><span class="s1">pos_label</span><span class="s2">=</span><span class="s1">pos_label</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">float</span><span class="s2">):</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">result</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">metric_1</span><span class="s2">, </span><span class="s1">metric_2</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">result</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">metric_1</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">metric_2</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_roc_curve_with_probablity_estimates</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Check that thresholds do not exceed 1.0 when `y_score` is a probability 
    estimate. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/26193 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">y_true </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y_score </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">thresholds </span><span class="s2">= </span><span class="s1">roc_curve</span><span class="s2">(</span><span class="s1">y_true</span><span class="s2">, </span><span class="s1">y_score</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">thresholds</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s3"># TODO(1.7): remove</span>
<span class="s0">def </span><span class="s1">test_precision_recall_curve_deprecation_warning</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Check the message for future deprecation.&quot;&quot;&quot;</span>
    <span class="s3"># Check precision_recall_curve function</span>
    <span class="s1">y_true</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">y_score </span><span class="s2">= </span><span class="s1">make_prediction</span><span class="s2">(</span><span class="s1">binary</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">warn_msg </span><span class="s2">= </span><span class="s6">&quot;probas_pred was deprecated in version 1.5&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warn_msg</span><span class="s2">):</span>
        <span class="s1">precision_recall_curve</span><span class="s2">(</span>
            <span class="s1">y_true</span><span class="s2">,</span>
            <span class="s1">probas_pred</span><span class="s2">=</span><span class="s1">y_score</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">error_msg </span><span class="s2">= </span><span class="s6">&quot;`probas_pred` and `y_score` cannot be both specified&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_msg</span><span class="s2">):</span>
        <span class="s1">precision_recall_curve</span><span class="s2">(</span>
            <span class="s1">y_true</span><span class="s2">,</span>
            <span class="s1">probas_pred</span><span class="s2">=</span><span class="s1">y_score</span><span class="s2">,</span>
            <span class="s1">y_score</span><span class="s2">=</span><span class="s1">y_score</span><span class="s2">,</span>
        <span class="s2">)</span>
</pre>
</body>
</html>