<html>
<head>
<title>test_estimator_html_repr.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_estimator_html_repr.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">html</span>
<span class="s0">import </span><span class="s1">locale</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">types</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">closing</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>
<span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">patch</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">config_context</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">BaseEstimator</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cluster </span><span class="s0">import </span><span class="s1">AgglomerativeClustering</span><span class="s2">, </span><span class="s1">Birch</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">compose </span><span class="s0">import </span><span class="s1">ColumnTransformer</span><span class="s2">, </span><span class="s1">make_column_transformer</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">load_iris</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">decomposition </span><span class="s0">import </span><span class="s1">PCA</span><span class="s2">, </span><span class="s1">TruncatedSVD</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">ensemble </span><span class="s0">import </span><span class="s1">StackingClassifier</span><span class="s2">, </span><span class="s1">StackingRegressor</span><span class="s2">, </span><span class="s1">VotingClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">feature_selection </span><span class="s0">import </span><span class="s1">SelectPercentile</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">gaussian_process</span><span class="s2">.</span><span class="s1">kernels </span><span class="s0">import </span><span class="s1">ExpSineSquared</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">impute </span><span class="s0">import </span><span class="s1">SimpleImputer</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">kernel_ridge </span><span class="s0">import </span><span class="s1">KernelRidge</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LogisticRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">RandomizedSearchCV</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">multiclass </span><span class="s0">import </span><span class="s1">OneVsOneClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">neural_network </span><span class="s0">import </span><span class="s1">MLPClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">FeatureUnion</span><span class="s2">, </span><span class="s1">Pipeline</span><span class="s2">, </span><span class="s1">make_pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">OneHotEncoder</span><span class="s2">, </span><span class="s1">StandardScaler</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">svm </span><span class="s0">import </span><span class="s1">LinearSVC</span><span class="s2">, </span><span class="s1">LinearSVR</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">tree </span><span class="s0">import </span><span class="s1">DecisionTreeClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_estimator_html_repr </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_get_css_style</span><span class="s2">,</span>
    <span class="s1">_get_visual_block</span><span class="s2">,</span>
    <span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">,</span>
    <span class="s1">_write_label_html</span><span class="s2">,</span>
    <span class="s1">estimator_html_repr</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">parse_version</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;checked&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_write_label_html</span><span class="s2">(</span><span class="s1">checked</span><span class="s2">):</span>
    <span class="s4"># Test checking logic and labeling</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;LogisticRegression&quot;</span>
    <span class="s1">tool_tip </span><span class="s2">= </span><span class="s3">&quot;hello-world&quot;</span>

    <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span><span class="s1">StringIO</span><span class="s2">()) </span><span class="s0">as </span><span class="s1">out</span><span class="s2">:</span>
        <span class="s1">_write_label_html</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">tool_tip</span><span class="s2">, </span><span class="s1">checked</span><span class="s2">=</span><span class="s1">checked</span><span class="s2">)</span>
        <span class="s1">html_label </span><span class="s2">= </span><span class="s1">out</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

        <span class="s1">p </span><span class="s2">= (</span>
            <span class="s3">r'&lt;label for=&quot;sk-estimator-id-[0-9]*&quot;'</span>
            <span class="s3">r' class=&quot;sk-toggleable__label (fitted)? sk-toggleable__label-arrow &quot;&gt;'</span>
            <span class="s3">r&quot;LogisticRegression&quot;</span>
        <span class="s2">)</span>
        <span class="s1">re_compiled </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">re_compiled</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">html_label</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">html_label</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'&lt;div class=&quot;sk-label-container&quot;&gt;'</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s3">&quot;&lt;pre&gt;hello-world&lt;/pre&gt;&quot; </span><span class="s0">in </span><span class="s1">html_label</span>
        <span class="s0">if </span><span class="s1">checked</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s3">&quot;checked&gt;&quot; </span><span class="s0">in </span><span class="s1">html_label</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;est&quot;</span><span class="s2">, [</span><span class="s3">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s3">&quot;drop&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_get_visual_block_single_str_none</span><span class="s2">(</span><span class="s1">est</span><span class="s2">):</span>
    <span class="s4"># Test estimators that are represented by strings</span>
    <span class="s1">est_html_info </span><span class="s2">= </span><span class="s1">_get_visual_block</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;single&quot;</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">estimators </span><span class="s2">== </span><span class="s1">est</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== </span><span class="s1">str</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">name_details </span><span class="s2">== </span><span class="s1">str</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_visual_block_single_estimator</span><span class="s2">():</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">LogisticRegression</span><span class="s2">(</span><span class="s1">C</span><span class="s2">=</span><span class="s5">10.0</span><span class="s2">)</span>
    <span class="s1">est_html_info </span><span class="s2">= </span><span class="s1">_get_visual_block</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;single&quot;</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">estimators </span><span class="s2">== </span><span class="s1">est</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== </span><span class="s1">est</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">name_details </span><span class="s2">== </span><span class="s1">str</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_visual_block_pipeline</span><span class="s2">():</span>
    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s3">&quot;imputer&quot;</span><span class="s2">, </span><span class="s1">SimpleImputer</span><span class="s2">()),</span>
            <span class="s2">(</span><span class="s3">&quot;do_nothing&quot;</span><span class="s2">, </span><span class="s3">&quot;passthrough&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;do_nothing_more&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;classifier&quot;</span><span class="s2">, </span><span class="s1">LogisticRegression</span><span class="s2">()),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">est_html_info </span><span class="s2">= </span><span class="s1">_get_visual_block</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;serial&quot;</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">estimators </span><span class="s2">== </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">step</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">step </span><span class="s0">in </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">steps</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== [</span>
        <span class="s3">&quot;imputer: SimpleImputer&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;do_nothing: passthrough&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;do_nothing_more: passthrough&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;classifier: LogisticRegression&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">name_details </span><span class="s2">== [</span><span class="s1">str</span><span class="s2">(</span><span class="s1">est</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">est </span><span class="s0">in </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">steps</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_get_visual_block_feature_union</span><span class="s2">():</span>
    <span class="s1">f_union </span><span class="s2">= </span><span class="s1">FeatureUnion</span><span class="s2">([(</span><span class="s3">&quot;pca&quot;</span><span class="s2">, </span><span class="s1">PCA</span><span class="s2">()), (</span><span class="s3">&quot;svd&quot;</span><span class="s2">, </span><span class="s1">TruncatedSVD</span><span class="s2">())])</span>
    <span class="s1">est_html_info </span><span class="s2">= </span><span class="s1">_get_visual_block</span><span class="s2">(</span><span class="s1">f_union</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;parallel&quot;</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== (</span><span class="s3">&quot;pca&quot;</span><span class="s2">, </span><span class="s3">&quot;svd&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">estimators </span><span class="s2">== </span><span class="s1">tuple</span><span class="s2">(</span>
        <span class="s1">trans</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">trans </span><span class="s0">in </span><span class="s1">f_union</span><span class="s2">.</span><span class="s1">transformer_list</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">name_details </span><span class="s2">== (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_visual_block_voting</span><span class="s2">():</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">VotingClassifier</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s3">&quot;log_reg&quot;</span><span class="s2">, </span><span class="s1">LogisticRegression</span><span class="s2">()), (</span><span class="s3">&quot;mlp&quot;</span><span class="s2">, </span><span class="s1">MLPClassifier</span><span class="s2">())]</span>
    <span class="s2">)</span>
    <span class="s1">est_html_info </span><span class="s2">= </span><span class="s1">_get_visual_block</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;parallel&quot;</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">estimators </span><span class="s2">== </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">trans </span><span class="s0">in </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">estimators</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== (</span><span class="s3">&quot;log_reg&quot;</span><span class="s2">, </span><span class="s3">&quot;mlp&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">name_details </span><span class="s2">== (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_visual_block_column_transformer</span><span class="s2">():</span>
    <span class="s1">ct </span><span class="s2">= </span><span class="s1">ColumnTransformer</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s3">&quot;pca&quot;</span><span class="s2">, </span><span class="s1">PCA</span><span class="s2">(), [</span><span class="s3">&quot;num1&quot;</span><span class="s2">, </span><span class="s3">&quot;num2&quot;</span><span class="s2">]), (</span><span class="s3">&quot;svd&quot;</span><span class="s2">, </span><span class="s1">TruncatedSVD</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]</span>
    <span class="s2">)</span>
    <span class="s1">est_html_info </span><span class="s2">= </span><span class="s1">_get_visual_block</span><span class="s2">(</span><span class="s1">ct</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;parallel&quot;</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">estimators </span><span class="s2">== </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">trans </span><span class="s0">in </span><span class="s1">ct</span><span class="s2">.</span><span class="s1">transformers</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== (</span><span class="s3">&quot;pca&quot;</span><span class="s2">, </span><span class="s3">&quot;svd&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est_html_info</span><span class="s2">.</span><span class="s1">name_details </span><span class="s2">== ([</span><span class="s3">&quot;num1&quot;</span><span class="s2">, </span><span class="s3">&quot;num2&quot;</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_estimator_html_repr_pipeline</span><span class="s2">():</span>
    <span class="s1">num_trans </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s1">steps</span><span class="s2">=[(</span><span class="s3">&quot;pass&quot;</span><span class="s2">, </span><span class="s3">&quot;passthrough&quot;</span><span class="s2">), (</span><span class="s3">&quot;imputer&quot;</span><span class="s2">, </span><span class="s1">SimpleImputer</span><span class="s2">(</span><span class="s1">strategy</span><span class="s2">=</span><span class="s3">&quot;median&quot;</span><span class="s2">))]</span>
    <span class="s2">)</span>

    <span class="s1">cat_trans </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s1">steps</span><span class="s2">=[</span>
            <span class="s2">(</span><span class="s3">&quot;imputer&quot;</span><span class="s2">, </span><span class="s1">SimpleImputer</span><span class="s2">(</span><span class="s1">strategy</span><span class="s2">=</span><span class="s3">&quot;constant&quot;</span><span class="s2">, </span><span class="s1">missing_values</span><span class="s2">=</span><span class="s3">&quot;empty&quot;</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s3">&quot;one-hot&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s3">&quot;first&quot;</span><span class="s2">)),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">preprocess </span><span class="s2">= </span><span class="s1">ColumnTransformer</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s3">&quot;num&quot;</span><span class="s2">, </span><span class="s1">num_trans</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s3">&quot;cat&quot;</span><span class="s2">, </span><span class="s1">cat_trans</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">feat_u </span><span class="s2">= </span><span class="s1">FeatureUnion</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s3">&quot;pca&quot;</span><span class="s2">, </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)),</span>
            <span class="s2">(</span>
                <span class="s3">&quot;tsvd&quot;</span><span class="s2">,</span>
                <span class="s1">Pipeline</span><span class="s2">(</span>
                    <span class="s2">[</span>
                        <span class="s2">(</span><span class="s3">&quot;first&quot;</span><span class="s2">, </span><span class="s1">TruncatedSVD</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)),</span>
                        <span class="s2">(</span><span class="s3">&quot;select&quot;</span><span class="s2">, </span><span class="s1">SelectPercentile</span><span class="s2">()),</span>
                    <span class="s2">]</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">VotingClassifier</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s3">&quot;lr&quot;</span><span class="s2">, </span><span class="s1">LogisticRegression</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">=</span><span class="s3">&quot;lbfgs&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s3">&quot;mlp&quot;</span><span class="s2">, </span><span class="s1">MLPClassifier</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.001</span><span class="s2">)),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s3">&quot;preprocessor&quot;</span><span class="s2">, </span><span class="s1">preprocess</span><span class="s2">), (</span><span class="s3">&quot;feat_u&quot;</span><span class="s2">, </span><span class="s1">feat_u</span><span class="s2">), (</span><span class="s3">&quot;classifier&quot;</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">)]</span>
    <span class="s2">)</span>
    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">)</span>

    <span class="s4"># top level estimators show estimator with changes</span>
    <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">)) </span><span class="s0">in </span><span class="s1">html_output</span>
    <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">est </span><span class="s0">in </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">steps</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s3">'&lt;div class=&quot;sk-toggleable__content &quot;&gt;&lt;pre&gt;' </span><span class="s2">+ </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">est</span><span class="s2">))</span>
        <span class="s2">) </span><span class="s0">in </span><span class="s1">html_output</span>

    <span class="s4"># low level estimators do not show changes</span>
    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">print_changed_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">num_trans</span><span class="s2">[</span><span class="s3">&quot;pass&quot;</span><span class="s2">])) </span><span class="s0">in </span><span class="s1">html_output</span>
        <span class="s0">assert </span><span class="s3">&quot;passthrough&lt;/label&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>
        <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">num_trans</span><span class="s2">[</span><span class="s3">&quot;imputer&quot;</span><span class="s2">])) </span><span class="s0">in </span><span class="s1">html_output</span>

        <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">cols </span><span class="s0">in </span><span class="s1">preprocess</span><span class="s2">.</span><span class="s1">transformers</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&lt;/pre&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>

        <span class="s4"># feature union</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">feat_u</span><span class="s2">.</span><span class="s1">transformer_list</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s3">f&quot;&lt;label&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&lt;/label&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>

        <span class="s1">pca </span><span class="s2">= </span><span class="s1">feat_u</span><span class="s2">.</span><span class="s1">transformer_list</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&lt;/pre&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>

        <span class="s1">tsvd </span><span class="s2">= </span><span class="s1">feat_u</span><span class="s2">.</span><span class="s1">transformer_list</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">first </span><span class="s2">= </span><span class="s1">tsvd</span><span class="s2">[</span><span class="s3">&quot;first&quot;</span><span class="s2">]</span>
        <span class="s1">select </span><span class="s2">= </span><span class="s1">tsvd</span><span class="s2">[</span><span class="s3">&quot;select&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">first</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&lt;/pre&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>
        <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">select</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&lt;/pre&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>

        <span class="s4"># voting classifier</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">est </span><span class="s0">in </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">estimators</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s3">f&quot;&lt;label&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&lt;/label&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>
            <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">est</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&lt;/pre&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>

    <span class="s4"># verify that prefers-color-scheme is implemented</span>
    <span class="s0">assert </span><span class="s3">&quot;prefers-color-scheme&quot; </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;final_estimator&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s1">LinearSVC</span><span class="s2">()])</span>
<span class="s0">def </span><span class="s1">test_stacking_classifier</span><span class="s2">(</span><span class="s1">final_estimator</span><span class="s2">):</span>
    <span class="s1">estimators </span><span class="s2">= [</span>
        <span class="s2">(</span><span class="s3">&quot;mlp&quot;</span><span class="s2">, </span><span class="s1">MLPClassifier</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.001</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s3">&quot;tree&quot;</span><span class="s2">, </span><span class="s1">DecisionTreeClassifier</span><span class="s2">()),</span>
    <span class="s2">]</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">StackingClassifier</span><span class="s2">(</span><span class="s1">estimators</span><span class="s2">=</span><span class="s1">estimators</span><span class="s2">, </span><span class="s1">final_estimator</span><span class="s2">=</span><span class="s1">final_estimator</span><span class="s2">)</span>

    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">)) </span><span class="s0">in </span><span class="s1">html_output</span>
    <span class="s4"># If final_estimator's default changes from LogisticRegression</span>
    <span class="s4"># this should be updated</span>
    <span class="s0">if </span><span class="s1">final_estimator </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s3">&quot;LogisticRegression(&quot; </span><span class="s0">in </span><span class="s1">html_output</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">final_estimator</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__ </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;final_estimator&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s1">LinearSVR</span><span class="s2">()])</span>
<span class="s0">def </span><span class="s1">test_stacking_regressor</span><span class="s2">(</span><span class="s1">final_estimator</span><span class="s2">):</span>
    <span class="s1">reg </span><span class="s2">= </span><span class="s1">StackingRegressor</span><span class="s2">(</span>
        <span class="s1">estimators</span><span class="s2">=[(</span><span class="s3">&quot;svr&quot;</span><span class="s2">, </span><span class="s1">LinearSVR</span><span class="s2">())], </span><span class="s1">final_estimator</span><span class="s2">=</span><span class="s1">final_estimator</span>
    <span class="s2">)</span>
    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">reg</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">reg</span><span class="s2">.</span><span class="s1">estimators</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">])) </span><span class="s0">in </span><span class="s1">html_output</span>
    <span class="s1">p </span><span class="s2">= (</span>
        <span class="s3">r'&lt;label for=&quot;sk-estimator-id-[0-9]*&quot;'</span>
        <span class="s3">r' class=&quot;sk-toggleable__label (fitted)? sk-toggleable__label-arrow &quot;&gt;'</span>
        <span class="s3">r&quot;&amp;nbsp;LinearSVR&quot;</span>
    <span class="s2">)</span>
    <span class="s1">re_compiled </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">re_compiled</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">html_output</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">final_estimator </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">p </span><span class="s2">= (</span>
            <span class="s3">r'&lt;label for=&quot;sk-estimator-id-[0-9]*&quot;'</span>
            <span class="s3">r' class=&quot;sk-toggleable__label (fitted)? sk-toggleable__label-arrow &quot;&gt;'</span>
            <span class="s3">r&quot;&amp;nbsp;RidgeCV&quot;</span>
        <span class="s2">)</span>
        <span class="s1">re_compiled </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">re_compiled</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">html_output</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">final_estimator</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">) </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s0">def </span><span class="s1">test_birch_duck_typing_meta</span><span class="s2">():</span>
    <span class="s4"># Test duck typing meta estimators with Birch</span>
    <span class="s1">birch </span><span class="s2">= </span><span class="s1">Birch</span><span class="s2">(</span><span class="s1">n_clusters</span><span class="s2">=</span><span class="s1">AgglomerativeClustering</span><span class="s2">(</span><span class="s1">n_clusters</span><span class="s2">=</span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">birch</span><span class="s2">)</span>

    <span class="s4"># inner estimators do not show changes</span>
    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">print_changed_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">birch</span><span class="s2">.</span><span class="s1">n_clusters</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">html_output</span>
        <span class="s0">assert </span><span class="s3">&quot;AgglomerativeClustering&lt;/label&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>

    <span class="s4"># outer estimator contains all changes</span>
    <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">birch</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s0">def </span><span class="s1">test_ovo_classifier_duck_typing_meta</span><span class="s2">():</span>
    <span class="s4"># Test duck typing metaestimators with OVO</span>
    <span class="s1">ovo </span><span class="s2">= </span><span class="s1">OneVsOneClassifier</span><span class="s2">(</span><span class="s1">LinearSVC</span><span class="s2">(</span><span class="s1">penalty</span><span class="s2">=</span><span class="s3">&quot;l1&quot;</span><span class="s2">))</span>
    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">ovo</span><span class="s2">)</span>

    <span class="s4"># inner estimators do not show changes</span>
    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">print_changed_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">ovo</span><span class="s2">.</span><span class="s1">estimator</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">html_output</span>
        <span class="s4"># regex to match the start of the tag</span>
        <span class="s1">p </span><span class="s2">= (</span>
            <span class="s3">r'&lt;label for=&quot;sk-estimator-id-[0-9]*&quot; '</span>
            <span class="s3">r'class=&quot;sk-toggleable__label  sk-toggleable__label-arrow &quot;&gt;&amp;nbsp;LinearSVC'</span>
        <span class="s2">)</span>
        <span class="s1">re_compiled </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">re_compiled</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">html_output</span><span class="s2">)</span>

    <span class="s4"># outer estimator</span>
    <span class="s0">assert </span><span class="s3">f&quot;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">ovo</span><span class="s2">))</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s0">def </span><span class="s1">test_duck_typing_nested_estimator</span><span class="s2">():</span>
    <span class="s4"># Test duck typing metaestimators with random search</span>
    <span class="s1">kernel_ridge </span><span class="s2">= </span><span class="s1">KernelRidge</span><span class="s2">(</span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">ExpSineSquared</span><span class="s2">())</span>
    <span class="s1">param_distributions </span><span class="s2">= {</span><span class="s3">&quot;alpha&quot;</span><span class="s2">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]}</span>

    <span class="s1">kernel_ridge_tuned </span><span class="s2">= </span><span class="s1">RandomizedSearchCV</span><span class="s2">(</span>
        <span class="s1">kernel_ridge</span><span class="s2">,</span>
        <span class="s1">param_distributions</span><span class="s2">=</span><span class="s1">param_distributions</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">kernel_ridge_tuned</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;estimator: KernelRidge&lt;/label&gt;&quot; </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;print_changed_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_estimator_print_change_only</span><span class="s2">(</span><span class="s1">print_changed_only</span><span class="s2">):</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">print_changed_only</span><span class="s2">=</span><span class="s1">print_changed_only</span><span class="s2">):</span>
        <span class="s1">pca_repr </span><span class="s2">= </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">))</span>
        <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">pca_repr </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s0">def </span><span class="s1">test_fallback_exists</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that repr fallback is in the HTML.&quot;&quot;&quot;</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s3">f'&lt;div class=&quot;sk-text-repr-fallback&quot;&gt;&lt;pre&gt;</span><span class="s0">{</span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">))</span><span class="s0">}</span><span class="s3">'</span>
        <span class="s0">in </span><span class="s1">html_output</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_show_arrow_pipeline</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Show arrow in pipeline for top level in pipeline&quot;&quot;&quot;</span>
    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">([(</span><span class="s3">&quot;scale&quot;</span><span class="s2">, </span><span class="s1">StandardScaler</span><span class="s2">()), (</span><span class="s3">&quot;log_Reg&quot;</span><span class="s2">, </span><span class="s1">LogisticRegression</span><span class="s2">())])</span>

    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s3">'class=&quot;sk-toggleable__label  sk-toggleable__label-arrow &quot;&gt;&amp;nbsp;&amp;nbsp;Pipeline'</span>
        <span class="s0">in </span><span class="s1">html_output</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_invalid_parameters_in_stacking</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Invalidate stacking configuration uses default repr. 
 
    Non-regression test for #24009. 
    &quot;&quot;&quot;</span>
    <span class="s1">stacker </span><span class="s2">= </span><span class="s1">StackingClassifier</span><span class="s2">(</span><span class="s1">estimators</span><span class="s2">=[])</span>

    <span class="s1">html_output </span><span class="s2">= </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">stacker</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">html</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">stacker</span><span class="s2">)) </span><span class="s0">in </span><span class="s1">html_output</span>


<span class="s0">def </span><span class="s1">test_estimator_get_params_return_cls</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check HTML repr works where a value in get_params is a class.&quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">MyEstimator</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">get_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">deep</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s3">&quot;inner_cls&quot;</span><span class="s2">: </span><span class="s1">LogisticRegression</span><span class="s2">}</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">MyEstimator</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s3">&quot;MyEstimator&quot; </span><span class="s0">in </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_estimator_html_repr_unfitted_vs_fitted</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that we have the information that the estimator is fitted or not in the 
    HTML representation. 
    &quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">MyEstimator</span><span class="s2">(</span><span class="s1">BaseEstimator</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fitted_ </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">return </span><span class="s1">self</span>

    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">estimator </span><span class="s2">= </span><span class="s1">MyEstimator</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s3">&quot;&lt;span&gt;Not fitted&lt;/span&gt;&quot; </span><span class="s0">in </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">)</span>
    <span class="s1">estimator</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;&lt;span&gt;Fitted&lt;/span&gt;&quot; </span><span class="s0">in </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">LogisticRegression</span><span class="s2">(),</span>
        <span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">StandardScaler</span><span class="s2">(), </span><span class="s1">LogisticRegression</span><span class="s2">()),</span>
        <span class="s1">make_pipeline</span><span class="s2">(</span>
            <span class="s1">make_column_transformer</span><span class="s2">((</span><span class="s1">StandardScaler</span><span class="s2">(), </span><span class="s1">slice</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))),</span>
            <span class="s1">LogisticRegression</span><span class="s2">(),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_estimator_html_repr_fitted_icon</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we are showing the fitted status icon only once.&quot;&quot;&quot;</span>
    <span class="s1">pattern </span><span class="s2">= </span><span class="s3">'&lt;span class=&quot;sk-estimator-doc-link &quot;&gt;i&lt;span&gt;Not fitted&lt;/span&gt;&lt;/span&gt;'</span>
    <span class="s0">assert </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">).</span><span class="s1">count</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">) == </span><span class="s5">1</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">estimator</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">pattern </span><span class="s2">= </span><span class="s3">'&lt;span class=&quot;sk-estimator-doc-link fitted&quot;&gt;i&lt;span&gt;Fitted&lt;/span&gt;&lt;/span&gt;'</span>
    <span class="s0">assert </span><span class="s1">estimator_html_repr</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">).</span><span class="s1">count</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">) == </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;mock_version&quot;</span><span class="s2">, [</span><span class="s3">&quot;1.3.0.dev0&quot;</span><span class="s2">, </span><span class="s3">&quot;1.3.0&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_html_documentation_link_mixin_sklearn</span><span class="s2">(</span><span class="s1">mock_version</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of the `_HTMLDocumentationLinkMixin` class for scikit-learn 
    default. 
    &quot;&quot;&quot;</span>

    <span class="s4"># mock the `__version__` where the mixin is located</span>
    <span class="s0">with </span><span class="s1">patch</span><span class="s2">(</span><span class="s3">&quot;sklearn.utils._estimator_html_repr.__version__&quot;</span><span class="s2">, </span><span class="s1">mock_version</span><span class="s2">):</span>
        <span class="s1">mixin </span><span class="s2">= </span><span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">()</span>

        <span class="s0">assert </span><span class="s1">mixin</span><span class="s2">.</span><span class="s1">_doc_link_module </span><span class="s2">== </span><span class="s3">&quot;sklearn&quot;</span>
        <span class="s1">sklearn_version </span><span class="s2">= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">mock_version</span><span class="s2">)</span>
        <span class="s4"># we need to parse the version manually to be sure that this test is passing in</span>
        <span class="s4"># other branches than `main` (that is &quot;dev&quot;).</span>
        <span class="s0">if </span><span class="s1">sklearn_version</span><span class="s2">.</span><span class="s1">dev </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">sklearn_version</span><span class="s2">.</span><span class="s1">major</span><span class="s0">}</span><span class="s3">.</span><span class="s0">{</span><span class="s1">sklearn_version</span><span class="s2">.</span><span class="s1">minor</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">version </span><span class="s2">= </span><span class="s3">&quot;dev&quot;</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s1">mixin</span><span class="s2">.</span><span class="s1">_doc_link_template</span>
            <span class="s2">== </span><span class="s3">f&quot;https://scikit-learn.org/</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s3">/modules/generated/&quot;</span>
            <span class="s3">&quot;{estimator_module}.{estimator_name}.html&quot;</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s1">mixin</span><span class="s2">.</span><span class="s1">_get_doc_link</span><span class="s2">()</span>
            <span class="s2">== </span><span class="s3">f&quot;https://scikit-learn.org/</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s3">/modules/generated/&quot;</span>
            <span class="s3">&quot;sklearn.utils._HTMLDocumentationLinkMixin.html&quot;</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;module_path,expected_module&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mymodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mymodule&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix._mymodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mypackage._mymodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mypackage&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mypackage._mymodule.submodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mypackage&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mypackage.mymodule.submodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mypackage.mymodule.submodule&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_html_documentation_link_mixin_get_doc_link_instance</span><span class="s2">(</span>
    <span class="s1">module_path</span><span class="s2">, </span><span class="s1">expected_module</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of the `_get_doc_link` with various parameter.&quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">FooBar</span><span class="s2">(</span><span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s1">FooBar</span><span class="s2">.</span><span class="s1">__module__ </span><span class="s2">= </span><span class="s1">module_path</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">FooBar</span><span class="s2">()</span>
    <span class="s4"># if we set `_doc_link`, then we expect to infer a module and name for the estimator</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">_doc_link_module </span><span class="s2">= </span><span class="s3">&quot;prefix&quot;</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">_doc_link_template </span><span class="s2">= (</span>
        <span class="s3">&quot;https://website.com/{estimator_module}.{estimator_name}.html&quot;</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">est</span><span class="s2">.</span><span class="s1">_get_doc_link</span><span class="s2">() == </span><span class="s3">f&quot;https://website.com/</span><span class="s0">{</span><span class="s1">expected_module</span><span class="s0">}</span><span class="s3">.FooBar.html&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;module_path,expected_module&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mymodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mymodule&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix._mymodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mypackage._mymodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mypackage&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mypackage._mymodule.submodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mypackage&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;prefix.mypackage.mymodule.submodule&quot;</span><span class="s2">, </span><span class="s3">&quot;prefix.mypackage.mymodule.submodule&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_html_documentation_link_mixin_get_doc_link_class</span><span class="s2">(</span><span class="s1">module_path</span><span class="s2">, </span><span class="s1">expected_module</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of the `_get_doc_link` when `_doc_link_module` and 
    `_doc_link_template` are defined at the class level and not at the instance 
    level.&quot;&quot;&quot;</span>

    <span class="s0">class </span><span class="s1">FooBar</span><span class="s2">(</span><span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">):</span>
        <span class="s1">_doc_link_module </span><span class="s2">= </span><span class="s3">&quot;prefix&quot;</span>
        <span class="s1">_doc_link_template </span><span class="s2">= (</span>
            <span class="s3">&quot;https://website.com/{estimator_module}.{estimator_name}.html&quot;</span>
        <span class="s2">)</span>

    <span class="s1">FooBar</span><span class="s2">.</span><span class="s1">__module__ </span><span class="s2">= </span><span class="s1">module_path</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">FooBar</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">est</span><span class="s2">.</span><span class="s1">_get_doc_link</span><span class="s2">() == </span><span class="s3">f&quot;https://website.com/</span><span class="s0">{</span><span class="s1">expected_module</span><span class="s0">}</span><span class="s3">.FooBar.html&quot;</span>


<span class="s0">def </span><span class="s1">test_html_documentation_link_mixin_get_doc_link_out_of_library</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of the `_get_doc_link` with various parameter.&quot;&quot;&quot;</span>
    <span class="s1">mixin </span><span class="s2">= </span><span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">()</span>

    <span class="s4"># if the `_doc_link_module` does not refer to the root module of the estimator</span>
    <span class="s4"># (here the mixin), then we should return an empty string.</span>
    <span class="s1">mixin</span><span class="s2">.</span><span class="s1">_doc_link_module </span><span class="s2">= </span><span class="s3">&quot;xxx&quot;</span>
    <span class="s0">assert </span><span class="s1">mixin</span><span class="s2">.</span><span class="s1">_get_doc_link</span><span class="s2">() == </span><span class="s3">&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_html_documentation_link_mixin_doc_link_url_param_generator_instance</span><span class="s2">():</span>
    <span class="s1">mixin </span><span class="s2">= </span><span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">()</span>
    <span class="s4"># we can bypass the generation by providing our own callable</span>
    <span class="s1">mixin</span><span class="s2">.</span><span class="s1">_doc_link_template </span><span class="s2">= (</span>
        <span class="s3">&quot;https://website.com/{my_own_variable}.{another_variable}.html&quot;</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">url_param_generator</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span>
            <span class="s3">&quot;my_own_variable&quot;</span><span class="s2">: </span><span class="s3">&quot;value_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;another_variable&quot;</span><span class="s2">: </span><span class="s3">&quot;value_2&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>

    <span class="s1">mixin</span><span class="s2">.</span><span class="s1">_doc_link_url_param_generator </span><span class="s2">= </span><span class="s1">types</span><span class="s2">.</span><span class="s1">MethodType</span><span class="s2">(</span><span class="s1">url_param_generator</span><span class="s2">, </span><span class="s1">mixin</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">mixin</span><span class="s2">.</span><span class="s1">_get_doc_link</span><span class="s2">() == </span><span class="s3">&quot;https://website.com/value_1.value_2.html&quot;</span>


<span class="s0">def </span><span class="s1">test_html_documentation_link_mixin_doc_link_url_param_generator_class</span><span class="s2">():</span>
    <span class="s4"># we can bypass the generation by providing our own callable</span>

    <span class="s0">def </span><span class="s1">url_param_generator</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span>
            <span class="s3">&quot;my_own_variable&quot;</span><span class="s2">: </span><span class="s3">&quot;value_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;another_variable&quot;</span><span class="s2">: </span><span class="s3">&quot;value_2&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>

    <span class="s0">class </span><span class="s1">FooBar</span><span class="s2">(</span><span class="s1">_HTMLDocumentationLinkMixin</span><span class="s2">):</span>
        <span class="s1">_doc_link_template </span><span class="s2">= (</span>
            <span class="s3">&quot;https://website.com/{my_own_variable}.{another_variable}.html&quot;</span>
        <span class="s2">)</span>
        <span class="s1">_doc_link_url_param_generator </span><span class="s2">= </span><span class="s1">url_param_generator</span>

    <span class="s1">estimator </span><span class="s2">= </span><span class="s1">FooBar</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">_get_doc_link</span><span class="s2">() == </span><span class="s3">&quot;https://website.com/value_1.value_2.html&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">set_non_utf8_locale</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Pytest fixture to set non utf-8 locale during the test. 
 
    The locale is set to the original one after the test has run. 
    &quot;&quot;&quot;</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">locale</span><span class="s2">.</span><span class="s1">setlocale</span><span class="s2">(</span><span class="s1">locale</span><span class="s2">.</span><span class="s1">LC_CTYPE</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">locale</span><span class="s2">.</span><span class="s1">Error</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;'C' locale is not available on this OS&quot;</span><span class="s2">)</span>

    <span class="s0">yield</span>

    <span class="s4"># Resets the locale to the original one. Python calls setlocale(LC_TYPE, &quot;&quot;)</span>
    <span class="s4"># at startup according to</span>
    <span class="s4"># https://docs.python.org/3/library/locale.html#background-details-hints-tips-and-caveats.</span>
    <span class="s4"># This assumes that no other locale changes have been made. For some reason,</span>
    <span class="s4"># on some platforms, trying to restore locale with something like</span>
    <span class="s4"># locale.setlocale(locale.LC_CTYPE, locale.getlocale()) raises a</span>
    <span class="s4"># locale.Error: unsupported locale setting</span>
    <span class="s1">locale</span><span class="s2">.</span><span class="s1">setlocale</span><span class="s2">(</span><span class="s1">locale</span><span class="s2">.</span><span class="s1">LC_CTYPE</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_non_utf8_locale</span><span class="s2">(</span><span class="s1">set_non_utf8_locale</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Checks that utf8 encoding is used when reading the CSS file. 
 
    Non-regression test for https://github.com/scikit-learn/scikit-learn/issues/27725 
    &quot;&quot;&quot;</span>
    <span class="s1">_get_css_style</span><span class="s2">()</span>
</pre>
</body>
</html>