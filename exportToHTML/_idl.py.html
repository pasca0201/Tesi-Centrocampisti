<html>
<head>
<title>_idl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_idl.py</font>
</center></td></tr></table>
<pre><span class="s0"># IDLSave - a python module to read IDL 'save' files</span>
<span class="s0"># Copyright (c) 2010 Thomas P. Robitaille</span>

<span class="s0"># Many thanks to Craig Markwardt for publishing the Unofficial Format</span>
<span class="s0"># Specification for IDL .sav files, without which this Python module would not</span>
<span class="s0"># exist (http://cow.physics.wisc.edu/~craigm/idl/savefmt).</span>

<span class="s0"># This code was developed by with permission from ITT Visual Information</span>
<span class="s0"># Systems. IDL(r) is a registered trademark of ITT Visual Information Systems,</span>
<span class="s0"># Inc. for their Interactive Data Language software.</span>

<span class="s0"># Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="s0"># copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="s0"># to deal in the Software without restriction, including without limitation</span>
<span class="s0"># the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="s0"># and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="s0"># Software is furnished to do so, subject to the following conditions:</span>

<span class="s0"># The above copyright notice and this permission notice shall be included in</span>
<span class="s0"># all copies or substantial portions of the Software.</span>

<span class="s0"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="s0"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="s0"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="s0"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="s0"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="s0"># FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="s0"># DEALINGS IN THE SOFTWARE.</span>

<span class="s1">__all__ </span><span class="s2">= [</span><span class="s3">'readsav'</span><span class="s2">]</span>

<span class="s4">import </span><span class="s1">struct</span>
<span class="s4">import </span><span class="s1">numpy </span><span class="s4">as </span><span class="s1">np</span>
<span class="s4">import </span><span class="s1">tempfile</span>
<span class="s4">import </span><span class="s1">zlib</span>
<span class="s4">import </span><span class="s1">warnings</span>

<span class="s0"># Define the different data types that can be found in an IDL save file</span>
<span class="s1">DTYPE_DICT </span><span class="s2">= {</span><span class="s5">1</span><span class="s2">: </span><span class="s3">'&gt;u1'</span><span class="s2">,</span>
              <span class="s5">2</span><span class="s2">: </span><span class="s3">'&gt;i2'</span><span class="s2">,</span>
              <span class="s5">3</span><span class="s2">: </span><span class="s3">'&gt;i4'</span><span class="s2">,</span>
              <span class="s5">4</span><span class="s2">: </span><span class="s3">'&gt;f4'</span><span class="s2">,</span>
              <span class="s5">5</span><span class="s2">: </span><span class="s3">'&gt;f8'</span><span class="s2">,</span>
              <span class="s5">6</span><span class="s2">: </span><span class="s3">'&gt;c8'</span><span class="s2">,</span>
              <span class="s5">7</span><span class="s2">: </span><span class="s3">'|O'</span><span class="s2">,</span>
              <span class="s5">8</span><span class="s2">: </span><span class="s3">'|O'</span><span class="s2">,</span>
              <span class="s5">9</span><span class="s2">: </span><span class="s3">'&gt;c16'</span><span class="s2">,</span>
              <span class="s5">10</span><span class="s2">: </span><span class="s3">'|O'</span><span class="s2">,</span>
              <span class="s5">11</span><span class="s2">: </span><span class="s3">'|O'</span><span class="s2">,</span>
              <span class="s5">12</span><span class="s2">: </span><span class="s3">'&gt;u2'</span><span class="s2">,</span>
              <span class="s5">13</span><span class="s2">: </span><span class="s3">'&gt;u4'</span><span class="s2">,</span>
              <span class="s5">14</span><span class="s2">: </span><span class="s3">'&gt;i8'</span><span class="s2">,</span>
              <span class="s5">15</span><span class="s2">: </span><span class="s3">'&gt;u8'</span><span class="s2">}</span>

<span class="s0"># Define the different record types that can be found in an IDL save file</span>
<span class="s1">RECTYPE_DICT </span><span class="s2">= {</span><span class="s5">0</span><span class="s2">: </span><span class="s3">&quot;START_MARKER&quot;</span><span class="s2">,</span>
                <span class="s5">1</span><span class="s2">: </span><span class="s3">&quot;COMMON_VARIABLE&quot;</span><span class="s2">,</span>
                <span class="s5">2</span><span class="s2">: </span><span class="s3">&quot;VARIABLE&quot;</span><span class="s2">,</span>
                <span class="s5">3</span><span class="s2">: </span><span class="s3">&quot;SYSTEM_VARIABLE&quot;</span><span class="s2">,</span>
                <span class="s5">6</span><span class="s2">: </span><span class="s3">&quot;END_MARKER&quot;</span><span class="s2">,</span>
                <span class="s5">10</span><span class="s2">: </span><span class="s3">&quot;TIMESTAMP&quot;</span><span class="s2">,</span>
                <span class="s5">12</span><span class="s2">: </span><span class="s3">&quot;COMPILED&quot;</span><span class="s2">,</span>
                <span class="s5">13</span><span class="s2">: </span><span class="s3">&quot;IDENTIFICATION&quot;</span><span class="s2">,</span>
                <span class="s5">14</span><span class="s2">: </span><span class="s3">&quot;VERSION&quot;</span><span class="s2">,</span>
                <span class="s5">15</span><span class="s2">: </span><span class="s3">&quot;HEAP_HEADER&quot;</span><span class="s2">,</span>
                <span class="s5">16</span><span class="s2">: </span><span class="s3">&quot;HEAP_DATA&quot;</span><span class="s2">,</span>
                <span class="s5">17</span><span class="s2">: </span><span class="s3">&quot;PROMOTE64&quot;</span><span class="s2">,</span>
                <span class="s5">19</span><span class="s2">: </span><span class="s3">&quot;NOTICE&quot;</span><span class="s2">,</span>
                <span class="s5">20</span><span class="s2">: </span><span class="s3">&quot;DESCRIPTION&quot;</span><span class="s2">}</span>

<span class="s0"># Define a dictionary to contain structure definitions</span>
<span class="s1">STRUCT_DICT </span><span class="s2">= {}</span>


<span class="s4">def </span><span class="s1">_align_32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Align to the next 32-bit position in a file'''</span>

    <span class="s1">pos </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>
    <span class="s4">if </span><span class="s1">pos </span><span class="s2">% </span><span class="s5">4 </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s5">4 </span><span class="s2">- </span><span class="s1">pos </span><span class="s2">% </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s4">return</span>


<span class="s4">def </span><span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
    <span class="s6">'''Skip `n` bytes'''</span>
    <span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s4">return</span>


<span class="s4">def </span><span class="s1">_read_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
    <span class="s6">'''Read the next `n` bytes'''</span>
    <span class="s4">return </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>


<span class="s4">def </span><span class="s1">_read_byte</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a single byte'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;B'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)[:</span><span class="s5">1</span><span class="s2">])[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a signed 32-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;l'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_int16</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a signed 16-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;h'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">4</span><span class="s2">])[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_int32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a signed 32-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;i'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_int64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a signed 64-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;q'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_uint16</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read an unsigned 16-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;H'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">4</span><span class="s2">])[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_uint32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read an unsigned 32-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_uint64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read an unsigned 64-bit integer'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;Q'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_float32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a 32-bit float'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;f'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">def </span><span class="s1">_read_float64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a 64-bit float'''</span>
    <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'&gt;d'</span><span class="s2">, </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">8</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">])</span>


<span class="s4">class </span><span class="s1">Pointer</span><span class="s2">:</span>
    <span class="s6">'''Class used to define pointers'''</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
        <span class="s4">return</span>


<span class="s4">class </span><span class="s1">ObjectPointer</span><span class="s2">(</span><span class="s1">Pointer</span><span class="s2">):</span>
    <span class="s6">'''Class used to define object pointers'''</span>
    <span class="s4">pass</span>


<span class="s4">def </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a string'''</span>
    <span class="s1">length </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">chars </span><span class="s2">= </span><span class="s1">_read_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">length</span><span class="s2">).</span><span class="s1">decode</span><span class="s2">(</span><span class="s3">'latin1'</span><span class="s2">)</span>
        <span class="s1">_align_32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">chars </span><span class="s2">= </span><span class="s3">''</span>
    <span class="s4">return </span><span class="s1">chars</span>


<span class="s4">def </span><span class="s1">_read_string_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Read a data string (length is specified twice)'''</span>
    <span class="s1">length </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">string_data </span><span class="s2">= </span><span class="s1">_read_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>
        <span class="s1">_align_32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">string_data </span><span class="s2">= </span><span class="s3">''</span>
    <span class="s4">return </span><span class="s1">string_data</span>


<span class="s4">def </span><span class="s1">_read_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s6">'''Read a variable with a specified data type'''</span>
    <span class="s4">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">_read_int32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) != </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Error occurred while reading byte variable&quot;</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">_read_byte</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_int16</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">3</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_int32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">4</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_float32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">5</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_float64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">6</span><span class="s2">:</span>
        <span class="s1">real </span><span class="s2">= </span><span class="s1">_read_float32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">imag </span><span class="s2">= </span><span class="s1">_read_float32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">(</span><span class="s1">real </span><span class="s2">+ </span><span class="s1">imag </span><span class="s2">* </span><span class="s5">1j</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">7</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_string_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">8</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Should not be here - please report this&quot;</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">9</span><span class="s2">:</span>
        <span class="s1">real </span><span class="s2">= </span><span class="s1">_read_float64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">imag </span><span class="s2">= </span><span class="s1">_read_float64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s4">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">(</span><span class="s1">real </span><span class="s2">+ </span><span class="s1">imag </span><span class="s2">* </span><span class="s5">1j</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">10</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">Pointer</span><span class="s2">(</span><span class="s1">_read_int32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">))</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">11</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">ObjectPointer</span><span class="s2">(</span><span class="s1">_read_int32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">))</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">12</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_uint16</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">13</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_uint32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">14</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_int64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">15</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">_read_uint64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Unknown IDL type: %i - please report this&quot; </span><span class="s2">% </span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s4">def </span><span class="s1">_read_structure</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">array_desc</span><span class="s2">, </span><span class="s1">struct_desc</span><span class="s2">):</span>
    <span class="s6">''' 
    Read a structure, with the array and structure descriptors given as 
    `array_desc` and `structure_desc` respectively. 
    '''</span>

    <span class="s1">nrows </span><span class="s2">= </span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'nelements'</span><span class="s2">]</span>
    <span class="s1">columns </span><span class="s2">= </span><span class="s1">struct_desc</span><span class="s2">[</span><span class="s3">'tagtable'</span><span class="s2">]</span>

    <span class="s1">dtype </span><span class="s2">= []</span>
    <span class="s4">for </span><span class="s1">col </span><span class="s4">in </span><span class="s1">columns</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">] </span><span class="s4">or </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">]:</span>
            <span class="s1">dtype</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(((</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">))</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">] </span><span class="s4">in </span><span class="s1">DTYPE_DICT</span><span class="s2">:</span>
                <span class="s1">dtype</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(((</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]),</span>
                                    <span class="s1">DTYPE_DICT</span><span class="s2">[</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">]]))</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Variable type %i not implemented&quot; </span><span class="s2">%</span>
                                                            <span class="s1">col</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">])</span>

    <span class="s1">structure </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">((</span><span class="s1">nrows</span><span class="s2">, ), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nrows</span><span class="s2">):</span>
        <span class="s4">for </span><span class="s1">col </span><span class="s4">in </span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s1">dtype </span><span class="s2">= </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">]</span>
            <span class="s4">if </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">]:</span>
                <span class="s1">structure</span><span class="s2">[</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]][</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">_read_structure</span><span class="s2">(</span><span class="s1">f</span><span class="s2">,</span>
                                      <span class="s1">struct_desc</span><span class="s2">[</span><span class="s3">'arrtable'</span><span class="s2">][</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]],</span>
                                      <span class="s1">struct_desc</span><span class="s2">[</span><span class="s3">'structtable'</span><span class="s2">][</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]])</span>
            <span class="s4">elif </span><span class="s1">col</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">]:</span>
                <span class="s1">structure</span><span class="s2">[</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]][</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">_read_array</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">,</span>
                                      <span class="s1">struct_desc</span><span class="s2">[</span><span class="s3">'arrtable'</span><span class="s2">][</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]])</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">structure</span><span class="s2">[</span><span class="s1">col</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]][</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">_read_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0"># Reshape structure if needed</span>
    <span class="s4">if </span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'ndims'</span><span class="s2">] &gt; </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">dims </span><span class="s2">= </span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'dims'</span><span class="s2">][:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'ndims'</span><span class="s2">])]</span>
        <span class="s1">dims</span><span class="s2">.</span><span class="s1">reverse</span><span class="s2">()</span>
        <span class="s1">structure </span><span class="s2">= </span><span class="s1">structure</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">dims</span><span class="s2">)</span>

    <span class="s4">return </span><span class="s1">structure</span>


<span class="s4">def </span><span class="s1">_read_array</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">typecode</span><span class="s2">, </span><span class="s1">array_desc</span><span class="s2">):</span>
    <span class="s6">''' 
    Read an array of type `typecode`, with the array descriptor given as 
    `array_desc`. 
    '''</span>

    <span class="s4">if </span><span class="s1">typecode </span><span class="s4">in </span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">15</span><span class="s2">]:</span>

        <span class="s4">if </span><span class="s1">typecode </span><span class="s2">== </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">nbytes </span><span class="s2">= </span><span class="s1">_read_int32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">nbytes </span><span class="s2">!= </span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'nbytes'</span><span class="s2">]:</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">&quot;Not able to verify number of bytes from header&quot;</span><span class="s2">,</span>
                              <span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>

        <span class="s0"># Read bytes as numpy array</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'nbytes'</span><span class="s2">]),</span>
                              <span class="s1">dtype</span><span class="s2">=</span><span class="s1">DTYPE_DICT</span><span class="s2">[</span><span class="s1">typecode</span><span class="s2">])</span>

    <span class="s4">elif </span><span class="s1">typecode </span><span class="s4">in </span><span class="s2">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">12</span><span class="s2">]:</span>

        <span class="s0"># These are 2 byte types, need to skip every two as they are not packed</span>

        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'nbytes'</span><span class="s2">]*</span><span class="s5">2</span><span class="s2">),</span>
                              <span class="s1">dtype</span><span class="s2">=</span><span class="s1">DTYPE_DICT</span><span class="s2">[</span><span class="s1">typecode</span><span class="s2">])[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">]</span>

    <span class="s4">else</span><span class="s2">:</span>

        <span class="s0"># Read bytes into list</span>
        <span class="s1">array </span><span class="s2">= []</span>
        <span class="s4">for </span><span class="s1">i </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'nelements'</span><span class="s2">]):</span>
            <span class="s1">dtype </span><span class="s2">= </span><span class="s1">typecode</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">_read_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">array</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s1">array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>

    <span class="s0"># Reshape array if needed</span>
    <span class="s4">if </span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'ndims'</span><span class="s2">] &gt; </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">dims </span><span class="s2">= </span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'dims'</span><span class="s2">][:</span><span class="s1">int</span><span class="s2">(</span><span class="s1">array_desc</span><span class="s2">[</span><span class="s3">'ndims'</span><span class="s2">])]</span>
        <span class="s1">dims</span><span class="s2">.</span><span class="s1">reverse</span><span class="s2">()</span>
        <span class="s1">array </span><span class="s2">= </span><span class="s1">array</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">dims</span><span class="s2">)</span>

    <span class="s0"># Go to next alignment position</span>
    <span class="s1">_align_32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">return </span><span class="s1">array</span>


<span class="s4">def </span><span class="s1">_read_record</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Function to read in a full record'''</span>

    <span class="s1">record </span><span class="s2">= {</span><span class="s3">'rectype'</span><span class="s2">: </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)}</span>

    <span class="s1">nextrec </span><span class="s2">= </span><span class="s1">_read_uint32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">nextrec </span><span class="s2">+= </span><span class="s1">_read_uint32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">) * </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span>

    <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] </span><span class="s4">not in </span><span class="s1">RECTYPE_DICT</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Unknown RECTYPE: %i&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">])</span>

    <span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] = </span><span class="s1">RECTYPE_DICT</span><span class="s2">[</span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">]]</span>

    <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] </span><span class="s4">in </span><span class="s2">[</span><span class="s3">&quot;VARIABLE&quot;</span><span class="s2">, </span><span class="s3">&quot;HEAP_DATA&quot;</span><span class="s2">]:</span>

        <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;VARIABLE&quot;</span><span class="s2">:</span>
            <span class="s1">record</span><span class="s2">[</span><span class="s3">'varname'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">record</span><span class="s2">[</span><span class="s3">'heap_index'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

        <span class="s1">rectypedesc </span><span class="s2">= </span><span class="s1">_read_typedesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">] == </span><span class="s5">0</span><span class="s2">:</span>

            <span class="s4">if </span><span class="s1">nextrec </span><span class="s2">== </span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">():</span>
                <span class="s1">record</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">] = </span><span class="s4">None  </span><span class="s0"># Indicates NULL value</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Unexpected type code: 0&quot;</span><span class="s2">)</span>

        <span class="s4">else</span><span class="s2">:</span>

            <span class="s1">varstart </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">varstart </span><span class="s2">!= </span><span class="s5">7</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;VARSTART is not 7&quot;</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">]:</span>
                <span class="s1">record</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">] = </span><span class="s1">_read_structure</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'array_desc'</span><span class="s2">],</span>
                                                    <span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'struct_desc'</span><span class="s2">])</span>
            <span class="s4">elif </span><span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">]:</span>
                <span class="s1">record</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">] = </span><span class="s1">_read_array</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">],</span>
                                                <span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'array_desc'</span><span class="s2">])</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s1">dtype </span><span class="s2">= </span><span class="s1">rectypedesc</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">]</span>
                <span class="s1">record</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">] = </span><span class="s1">_read_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;TIMESTAMP&quot;</span><span class="s2">:</span>

        <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">4</span><span class="s2">*</span><span class="s5">256</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'date'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'user'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'host'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;VERSION&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'format'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'arch'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'os'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'release'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;IDENTIFICATON&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'author'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'title'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'idcode'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;NOTICE&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'notice'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;DESCRIPTION&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'description'</span><span class="s2">] = </span><span class="s1">_read_string_data</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;HEAP_HEADER&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'nvalues'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'indices'</span><span class="s2">] = [</span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">record</span><span class="s2">[</span><span class="s3">'nvalues'</span><span class="s2">])]</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;COMMONBLOCK&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'nvars'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">record</span><span class="s2">[</span><span class="s3">'varnames'</span><span class="s2">] = [</span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">record</span><span class="s2">[</span><span class="s3">'nvars'</span><span class="s2">])]</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;END_MARKER&quot;</span><span class="s2">:</span>

        <span class="s1">record</span><span class="s2">[</span><span class="s3">'end'</span><span class="s2">] = </span><span class="s4">True</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;UNKNOWN&quot;</span><span class="s2">:</span>

        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">&quot;Skipping UNKNOWN record&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>

    <span class="s4">elif </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;SYSTEM_VARIABLE&quot;</span><span class="s2">:</span>

        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">&quot;Skipping SYSTEM_VARIABLE record&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>

    <span class="s4">else</span><span class="s2">:</span>

        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">f&quot;record['rectype']=</span><span class="s4">{</span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">]</span><span class="s4">} </span><span class="s3">not implemented&quot;</span><span class="s2">)</span>

    <span class="s1">f</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">nextrec</span><span class="s2">)</span>

    <span class="s4">return </span><span class="s1">record</span>


<span class="s4">def </span><span class="s1">_read_typedesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Function to read in a type descriptor'''</span>

    <span class="s1">typedesc </span><span class="s2">= {</span><span class="s3">'typecode'</span><span class="s2">: </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">), </span><span class="s3">'varflags'</span><span class="s2">: </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)}</span>

    <span class="s4">if </span><span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'varflags'</span><span class="s2">] &amp; </span><span class="s5">2 </span><span class="s2">== </span><span class="s5">2</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;System variables not implemented&quot;</span><span class="s2">)</span>

    <span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">] = </span><span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'varflags'</span><span class="s2">] &amp; </span><span class="s5">4 </span><span class="s2">== </span><span class="s5">4</span>
    <span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">] = </span><span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'varflags'</span><span class="s2">] &amp; </span><span class="s5">32 </span><span class="s2">== </span><span class="s5">32</span>

    <span class="s4">if </span><span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">]:</span>
        <span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'array_desc'</span><span class="s2">] = </span><span class="s1">_read_arraydesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'struct_desc'</span><span class="s2">] = </span><span class="s1">_read_structdesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">elif </span><span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">]:</span>
        <span class="s1">typedesc</span><span class="s2">[</span><span class="s3">'array_desc'</span><span class="s2">] = </span><span class="s1">_read_arraydesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s4">return </span><span class="s1">typedesc</span>


<span class="s4">def </span><span class="s1">_read_arraydesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Function to read in an array descriptor'''</span>

    <span class="s1">arraydesc </span><span class="s2">= {</span><span class="s3">'arrstart'</span><span class="s2">: </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)}</span>

    <span class="s4">if </span><span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'arrstart'</span><span class="s2">] == </span><span class="s5">8</span><span class="s2">:</span>

        <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>

        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nbytes'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nelements'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'ndims'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

        <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>

        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nmax'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'dims'</span><span class="s2">] = [</span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nmax'</span><span class="s2">])]</span>

    <span class="s4">elif </span><span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'arrstart'</span><span class="s2">] == </span><span class="s5">18</span><span class="s2">:</span>

        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">&quot;Using experimental 64-bit array read&quot;</span><span class="s2">, </span><span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>

        <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>

        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nbytes'</span><span class="s2">] = </span><span class="s1">_read_uint64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nelements'</span><span class="s2">] = </span><span class="s1">_read_uint64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'ndims'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

        <span class="s1">_skip_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>

        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nmax'</span><span class="s2">] = </span><span class="s5">8</span>

        <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'dims'</span><span class="s2">] = []</span>
        <span class="s4">for </span><span class="s1">d </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'nmax'</span><span class="s2">]):</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">v </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Expected a zero in ARRAY_DESC&quot;</span><span class="s2">)</span>
            <span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'dims'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">))</span>

    <span class="s4">else</span><span class="s2">:</span>

        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Unknown ARRSTART: %i&quot; </span><span class="s2">% </span><span class="s1">arraydesc</span><span class="s2">[</span><span class="s3">'arrstart'</span><span class="s2">])</span>

    <span class="s4">return </span><span class="s1">arraydesc</span>


<span class="s4">def </span><span class="s1">_read_structdesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Function to read in a structure descriptor'''</span>

    <span class="s1">structdesc </span><span class="s2">= {}</span>

    <span class="s1">structstart </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">structstart </span><span class="s2">!= </span><span class="s5">9</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;STRUCTSTART should be 9&quot;</span><span class="s2">)</span>

    <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">predef </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'ntags'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'nbytes'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'predef'</span><span class="s2">] = </span><span class="s1">predef </span><span class="s2">&amp; </span><span class="s5">1</span>
    <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'inherits'</span><span class="s2">] = </span><span class="s1">predef </span><span class="s2">&amp; </span><span class="s5">2</span>
    <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'is_super'</span><span class="s2">] = </span><span class="s1">predef </span><span class="s2">&amp; </span><span class="s5">4</span>

    <span class="s4">if not </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'predef'</span><span class="s2">]:</span>

        <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'tagtable'</span><span class="s2">] = [</span><span class="s1">_read_tagdesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
                                  <span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'ntags'</span><span class="s2">])]</span>

        <span class="s4">for </span><span class="s1">tag </span><span class="s4">in </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'tagtable'</span><span class="s2">]:</span>
            <span class="s1">tag</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

        <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'arrtable'</span><span class="s2">] = {</span><span class="s1">tag</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]: </span><span class="s1">_read_arraydesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
                                  <span class="s4">for </span><span class="s1">tag </span><span class="s4">in </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'tagtable'</span><span class="s2">]</span>
                                  <span class="s4">if </span><span class="s1">tag</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">]}</span>

        <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'structtable'</span><span class="s2">] = {</span><span class="s1">tag</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]: </span><span class="s1">_read_structdesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
                                     <span class="s4">for </span><span class="s1">tag </span><span class="s4">in </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'tagtable'</span><span class="s2">]</span>
                                     <span class="s4">if </span><span class="s1">tag</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">]}</span>

        <span class="s4">if </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'inherits'</span><span class="s2">] </span><span class="s4">or </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'is_super'</span><span class="s2">]:</span>
            <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'classname'</span><span class="s2">] = </span><span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'nsupclasses'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'supclassnames'</span><span class="s2">] = [</span>
                <span class="s1">_read_string</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'nsupclasses'</span><span class="s2">])]</span>
            <span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'supclasstable'</span><span class="s2">] = [</span>
                <span class="s1">_read_structdesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) </span><span class="s4">for </span><span class="s1">_ </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'nsupclasses'</span><span class="s2">])]</span>

        <span class="s1">STRUCT_DICT</span><span class="s2">[</span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]] = </span><span class="s1">structdesc</span>

    <span class="s4">else</span><span class="s2">:</span>

        <span class="s4">if </span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">] </span><span class="s4">not in </span><span class="s1">STRUCT_DICT</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;PREDEF=1 but can't find definition&quot;</span><span class="s2">)</span>

        <span class="s1">structdesc </span><span class="s2">= </span><span class="s1">STRUCT_DICT</span><span class="s2">[</span><span class="s1">structdesc</span><span class="s2">[</span><span class="s3">'name'</span><span class="s2">]]</span>

    <span class="s4">return </span><span class="s1">structdesc</span>


<span class="s4">def </span><span class="s1">_read_tagdesc</span><span class="s2">(</span><span class="s1">f</span><span class="s2">):</span>
    <span class="s6">'''Function to read in a tag descriptor'''</span>

    <span class="s1">tagdesc </span><span class="s2">= {</span><span class="s3">'offset'</span><span class="s2">: </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)}</span>

    <span class="s4">if </span><span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'offset'</span><span class="s2">] == -</span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'offset'</span><span class="s2">] = </span><span class="s1">_read_uint64</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">] = </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
    <span class="s1">tagflags </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'array'</span><span class="s2">] = </span><span class="s1">tagflags </span><span class="s2">&amp; </span><span class="s5">4 </span><span class="s2">== </span><span class="s5">4</span>
    <span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'structure'</span><span class="s2">] = </span><span class="s1">tagflags </span><span class="s2">&amp; </span><span class="s5">32 </span><span class="s2">== </span><span class="s5">32</span>
    <span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'scalar'</span><span class="s2">] = </span><span class="s1">tagdesc</span><span class="s2">[</span><span class="s3">'typecode'</span><span class="s2">] </span><span class="s4">in </span><span class="s1">DTYPE_DICT</span>
    <span class="s0"># Assume '10'x is scalar</span>

    <span class="s4">return </span><span class="s1">tagdesc</span>


<span class="s4">def </span><span class="s1">_replace_heap</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">heap</span><span class="s2">):</span>

    <span class="s4">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">Pointer</span><span class="s2">):</span>

        <span class="s4">while </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">Pointer</span><span class="s2">):</span>

            <span class="s4">if </span><span class="s1">variable</span><span class="s2">.</span><span class="s1">index </span><span class="s2">== </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s1">variable </span><span class="s2">= </span><span class="s4">None</span>
            <span class="s4">else</span><span class="s2">:</span>
                <span class="s4">if </span><span class="s1">variable</span><span class="s2">.</span><span class="s1">index </span><span class="s4">in </span><span class="s1">heap</span><span class="s2">:</span>
                    <span class="s1">variable </span><span class="s2">= </span><span class="s1">heap</span><span class="s2">[</span><span class="s1">variable</span><span class="s2">.</span><span class="s1">index</span><span class="s2">]</span>
                <span class="s4">else</span><span class="s2">:</span>
                    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s3">&quot;Variable referenced by pointer not found &quot;</span>
                                  <span class="s3">&quot;in heap: variable will be set to None&quot;</span><span class="s2">,</span>
                                  <span class="s1">stacklevel</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
                    <span class="s1">variable </span><span class="s2">= </span><span class="s4">None</span>

        <span class="s1">replace</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">_replace_heap</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">heap</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">replace</span><span class="s2">:</span>
            <span class="s1">variable </span><span class="s2">= </span><span class="s1">new</span>

        <span class="s4">return True</span><span class="s2">, </span><span class="s1">variable</span>

    <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">):</span>

        <span class="s0"># Loop over records</span>
        <span class="s4">for </span><span class="s1">ir</span><span class="s2">, </span><span class="s1">record </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">):</span>

            <span class="s1">replace</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">_replace_heap</span><span class="s2">(</span><span class="s1">record</span><span class="s2">, </span><span class="s1">heap</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">replace</span><span class="s2">:</span>
                <span class="s1">variable</span><span class="s2">[</span><span class="s1">ir</span><span class="s2">] = </span><span class="s1">new</span>

        <span class="s4">return False</span><span class="s2">, </span><span class="s1">variable</span>

    <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">):</span>

        <span class="s0"># Loop over values</span>
        <span class="s4">for </span><span class="s1">iv</span><span class="s2">, </span><span class="s1">value </span><span class="s4">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">):</span>

            <span class="s1">replace</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">_replace_heap</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">heap</span><span class="s2">)</span>

            <span class="s4">if </span><span class="s1">replace</span><span class="s2">:</span>
                <span class="s1">variable</span><span class="s2">[</span><span class="s1">iv</span><span class="s2">] = </span><span class="s1">new</span>

        <span class="s4">return False</span><span class="s2">, </span><span class="s1">variable</span>

    <span class="s4">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>

        <span class="s0"># Loop over values if type is np.object_</span>
        <span class="s4">if </span><span class="s1">variable</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type </span><span class="s4">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">:</span>

            <span class="s4">for </span><span class="s1">iv </span><span class="s4">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">.</span><span class="s1">size</span><span class="s2">):</span>

                <span class="s1">replace</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">_replace_heap</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">.</span><span class="s1">item</span><span class="s2">(</span><span class="s1">iv</span><span class="s2">), </span><span class="s1">heap</span><span class="s2">)</span>

                <span class="s4">if </span><span class="s1">replace</span><span class="s2">:</span>
                    <span class="s1">variable</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">)[</span><span class="s1">iv</span><span class="s2">] = </span><span class="s1">new</span>

        <span class="s4">return False</span><span class="s2">, </span><span class="s1">variable</span>

    <span class="s4">else</span><span class="s2">:</span>

        <span class="s4">return False</span><span class="s2">, </span><span class="s1">variable</span>


<span class="s4">class </span><span class="s1">AttrDict</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">):</span>
    <span class="s6">''' 
    A case-insensitive dictionary with access via item, attribute, and call 
    notations: 
 
        &gt;&gt;&gt; from scipy.io._idl import AttrDict 
        &gt;&gt;&gt; d = AttrDict() 
        &gt;&gt;&gt; d['Variable'] = 123 
        &gt;&gt;&gt; d['Variable'] 
        123 
        &gt;&gt;&gt; d.Variable 
        123 
        &gt;&gt;&gt; d.variable 
        123 
        &gt;&gt;&gt; d('VARIABLE') 
        123 
        &gt;&gt;&gt; d['missing'] 
        Traceback (most recent error last): 
        ... 
        KeyError: 'missing' 
        &gt;&gt;&gt; d.missing 
        Traceback (most recent error last): 
        ... 
        AttributeError: 'AttrDict' object has no attribute 'missing' 
    '''</span>

    <span class="s4">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">init</span><span class="s2">={}):</span>
        <span class="s1">dict</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">init</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">())</span>

    <span class="s4">def </span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s4">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__setitem__</span><span class="s2">(</span><span class="s1">key</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">(), </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s4">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s4">try</span><span class="s2">:</span>
            <span class="s4">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s4">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s4">raise </span><span class="s1">AttributeError</span><span class="s2">(</span>
                <span class="s3">f&quot;'</span><span class="s4">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span><span class="s4">}</span><span class="s3">' object has no attribute '</span><span class="s4">{</span><span class="s1">name</span><span class="s4">}</span><span class="s3">'&quot;</span><span class="s2">) </span><span class="s4">from None</span>

    <span class="s1">__setattr__ </span><span class="s2">= </span><span class="s1">__setitem__</span>
    <span class="s1">__call__ </span><span class="s2">= </span><span class="s1">__getitem__</span>


<span class="s4">def </span><span class="s1">readsav</span><span class="s2">(</span><span class="s1">file_name</span><span class="s2">, </span><span class="s1">idict</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">python_dict</span><span class="s2">=</span><span class="s4">False</span><span class="s2">,</span>
            <span class="s1">uncompressed_file_name</span><span class="s2">=</span><span class="s4">None</span><span class="s2">, </span><span class="s1">verbose</span><span class="s2">=</span><span class="s4">False</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Read an IDL .sav file. 
 
    Parameters 
    ---------- 
    file_name : str 
        Name of the IDL save file. 
    idict : dict, optional 
        Dictionary in which to insert .sav file variables. 
    python_dict : bool, optional 
        By default, the object return is not a Python dictionary, but a 
        case-insensitive dictionary with item, attribute, and call access 
        to variables. To get a standard Python dictionary, set this option 
        to True. 
    uncompressed_file_name : str, optional 
        This option only has an effect for .sav files written with the 
        /compress option. If a file name is specified, compressed .sav 
        files are uncompressed to this file. Otherwise, readsav will use 
        the `tempfile` module to determine a temporary filename 
        automatically, and will remove the temporary file upon successfully 
        reading it in. 
    verbose : bool, optional 
        Whether to print out information about the save file, including 
        the records read, and available variables. 
 
    Returns 
    ------- 
    idl_dict : AttrDict or dict 
        If `python_dict` is set to False (default), this function returns a 
        case-insensitive dictionary with item, attribute, and call access 
        to variables. If `python_dict` is set to True, this function 
        returns a Python dictionary with all variable names in lowercase. 
        If `idict` was specified, then variables are written to the 
        dictionary specified, and the updated dictionary is returned. 
 
    Examples 
    -------- 
    &gt;&gt;&gt; from os.path import dirname, join as pjoin 
    &gt;&gt;&gt; import scipy.io as sio 
    &gt;&gt;&gt; from scipy.io import readsav 
 
    Get the filename for an example .sav file from the tests/data directory. 
 
    &gt;&gt;&gt; data_dir = pjoin(dirname(sio.__file__), 'tests', 'data') 
    &gt;&gt;&gt; sav_fname = pjoin(data_dir, 'array_float32_1d.sav') 
 
    Load the .sav file contents. 
 
    &gt;&gt;&gt; sav_data = readsav(sav_fname) 
 
    Get keys of the .sav file contents. 
 
    &gt;&gt;&gt; print(sav_data.keys()) 
    dict_keys(['array1d']) 
 
    Access a content with a key. 
 
    &gt;&gt;&gt; print(sav_data['array1d']) 
    [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 
     0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 
     0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 
     0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 
     0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 
     0. 0. 0.] 
 
    &quot;&quot;&quot;</span>

    <span class="s0"># Initialize record and variable holders</span>
    <span class="s1">records </span><span class="s2">= []</span>
    <span class="s4">if </span><span class="s1">python_dict </span><span class="s4">or </span><span class="s1">idict</span><span class="s2">:</span>
        <span class="s1">variables </span><span class="s2">= {}</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s1">variables </span><span class="s2">= </span><span class="s1">AttrDict</span><span class="s2">()</span>

    <span class="s0"># Open the IDL file</span>
    <span class="s1">f </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file_name</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s2">)</span>

    <span class="s0"># Read the signature, which should be 'SR'</span>
    <span class="s1">signature </span><span class="s2">= </span><span class="s1">_read_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s4">if </span><span class="s1">signature </span><span class="s2">!= </span><span class="s7">b'SR'</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Invalid SIGNATURE: %s&quot; </span><span class="s2">% </span><span class="s1">signature</span><span class="s2">)</span>

    <span class="s0"># Next, the record format, which is '\x00\x04' for normal .sav</span>
    <span class="s0"># files, and '\x00\x06' for compressed .sav files.</span>
    <span class="s1">recfmt </span><span class="s2">= </span><span class="s1">_read_bytes</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">recfmt </span><span class="s2">== </span><span class="s7">b'</span><span class="s4">\x00\x04</span><span class="s7">'</span><span class="s2">:</span>
        <span class="s4">pass</span>

    <span class="s4">elif </span><span class="s1">recfmt </span><span class="s2">== </span><span class="s7">b'</span><span class="s4">\x00\x06</span><span class="s7">'</span><span class="s2">:</span>

        <span class="s4">if </span><span class="s1">verbose</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;IDL Save file is compressed&quot;</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">uncompressed_file_name</span><span class="s2">:</span>
            <span class="s1">fout </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">uncompressed_file_name</span><span class="s2">, </span><span class="s3">'w+b'</span><span class="s2">)</span>
        <span class="s4">else</span><span class="s2">:</span>
            <span class="s1">fout </span><span class="s2">= </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">NamedTemporaryFile</span><span class="s2">(</span><span class="s1">suffix</span><span class="s2">=</span><span class="s3">'.sav'</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s1">verbose</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot; -&gt; expanding to %s&quot; </span><span class="s2">% </span><span class="s1">fout</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s0"># Write header</span>
        <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b'SR</span><span class="s4">\x00\x04</span><span class="s7">'</span><span class="s2">)</span>

        <span class="s0"># Cycle through records</span>
        <span class="s4">while True</span><span class="s2">:</span>

            <span class="s0"># Read record type</span>
            <span class="s1">rectype </span><span class="s2">= </span><span class="s1">_read_long</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;l'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">rectype</span><span class="s2">)))</span>

            <span class="s0"># Read position of next record and return as int</span>
            <span class="s1">nextrec </span><span class="s2">= </span><span class="s1">_read_uint32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
            <span class="s1">nextrec </span><span class="s2">+= </span><span class="s1">_read_uint32</span><span class="s2">(</span><span class="s1">f</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">) * </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span>

            <span class="s0"># Read the unknown 4 bytes</span>
            <span class="s1">unknown </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>

            <span class="s0"># Check if the end of the file has been reached</span>
            <span class="s4">if </span><span class="s1">RECTYPE_DICT</span><span class="s2">[</span><span class="s1">rectype</span><span class="s2">] == </span><span class="s3">'END_MARKER'</span><span class="s2">:</span>
                <span class="s1">modval </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span><span class="s2">)</span>
                <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">nextrec</span><span class="s2">) % </span><span class="s1">modval</span><span class="s2">))</span>
                <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                    <span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">((</span><span class="s1">nextrec </span><span class="s2">- (</span><span class="s1">nextrec </span><span class="s2">% </span><span class="s1">modval</span><span class="s2">)) / </span><span class="s1">modval</span><span class="s2">))</span>
                <span class="s2">)</span>
                <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">unknown</span><span class="s2">)</span>
                <span class="s4">break</span>

            <span class="s0"># Find current position</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">f</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">()</span>

            <span class="s0"># Decompress record</span>
            <span class="s1">rec_string </span><span class="s2">= </span><span class="s1">zlib</span><span class="s2">.</span><span class="s1">decompress</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">nextrec</span><span class="s2">-</span><span class="s1">pos</span><span class="s2">))</span>

            <span class="s0"># Find new position of next record</span>
            <span class="s1">nextrec </span><span class="s2">= </span><span class="s1">fout</span><span class="s2">.</span><span class="s1">tell</span><span class="s2">() + </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rec_string</span><span class="s2">) + </span><span class="s5">12</span>

            <span class="s0"># Write out record</span>
            <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">nextrec </span><span class="s2">% </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span><span class="s2">)))</span>
            <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s3">'&gt;I'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">((</span><span class="s1">nextrec </span><span class="s2">- (</span><span class="s1">nextrec </span><span class="s2">% </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span><span class="s2">)) / </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span><span class="s2">)))</span>
            <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">unknown</span><span class="s2">)</span>
            <span class="s1">fout</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">rec_string</span><span class="s2">)</span>

        <span class="s0"># Close the original compressed file</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s0"># Set f to be the decompressed file, and skip the first four bytes</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">fout</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>

    <span class="s4">else</span><span class="s2">:</span>
        <span class="s4">raise </span><span class="s1">Exception</span><span class="s2">(</span><span class="s3">&quot;Invalid RECFMT: %s&quot; </span><span class="s2">% </span><span class="s1">recfmt</span><span class="s2">)</span>

    <span class="s0"># Loop through records, and add them to the list</span>
    <span class="s4">while True</span><span class="s2">:</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">_read_record</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>
        <span class="s1">records</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">r</span><span class="s2">)</span>
        <span class="s4">if </span><span class="s3">'end' </span><span class="s4">in </span><span class="s1">r</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">r</span><span class="s2">[</span><span class="s3">'end'</span><span class="s2">]:</span>
                <span class="s4">break</span>

    <span class="s0"># Close the file</span>
    <span class="s1">f</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0"># Find heap data variables</span>
    <span class="s1">heap </span><span class="s2">= {}</span>
    <span class="s4">for </span><span class="s1">r </span><span class="s4">in </span><span class="s1">records</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">r</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;HEAP_DATA&quot;</span><span class="s2">:</span>
            <span class="s1">heap</span><span class="s2">[</span><span class="s1">r</span><span class="s2">[</span><span class="s3">'heap_index'</span><span class="s2">]] = </span><span class="s1">r</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">]</span>

    <span class="s0"># Find all variables</span>
    <span class="s4">for </span><span class="s1">r </span><span class="s4">in </span><span class="s1">records</span><span class="s2">:</span>
        <span class="s4">if </span><span class="s1">r</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;VARIABLE&quot;</span><span class="s2">:</span>
            <span class="s1">replace</span><span class="s2">, </span><span class="s1">new </span><span class="s2">= </span><span class="s1">_replace_heap</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">], </span><span class="s1">heap</span><span class="s2">)</span>
            <span class="s4">if </span><span class="s1">replace</span><span class="s2">:</span>
                <span class="s1">r</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">] = </span><span class="s1">new</span>
            <span class="s1">variables</span><span class="s2">[</span><span class="s1">r</span><span class="s2">[</span><span class="s3">'varname'</span><span class="s2">].</span><span class="s1">lower</span><span class="s2">()] = </span><span class="s1">r</span><span class="s2">[</span><span class="s3">'data'</span><span class="s2">]</span>

    <span class="s4">if </span><span class="s1">verbose</span><span class="s2">:</span>

        <span class="s0"># Print out timestamp info about the file</span>
        <span class="s4">for </span><span class="s1">record </span><span class="s4">in </span><span class="s1">records</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;TIMESTAMP&quot;</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Date: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'date'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;User: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'user'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Host: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'host'</span><span class="s2">])</span>
                <span class="s4">break</span>

        <span class="s0"># Print out version info about the file</span>
        <span class="s4">for </span><span class="s1">record </span><span class="s4">in </span><span class="s1">records</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;VERSION&quot;</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Format: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'format'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Architecture: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'arch'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Operating System: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'os'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;IDL Version: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'release'</span><span class="s2">])</span>
                <span class="s4">break</span>

        <span class="s0"># Print out identification info about the file</span>
        <span class="s4">for </span><span class="s1">record </span><span class="s4">in </span><span class="s1">records</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;IDENTIFICATON&quot;</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Author: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'author'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Title: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'title'</span><span class="s2">])</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;ID Code: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'idcode'</span><span class="s2">])</span>
                <span class="s4">break</span>

        <span class="s0"># Print out descriptions saved with the file</span>
        <span class="s4">for </span><span class="s1">record </span><span class="s4">in </span><span class="s1">records</span><span class="s2">:</span>
            <span class="s4">if </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] == </span><span class="s3">&quot;DESCRIPTION&quot;</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Description: %s&quot; </span><span class="s2">% </span><span class="s1">record</span><span class="s2">[</span><span class="s3">'description'</span><span class="s2">])</span>
                <span class="s4">break</span>

        <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Successfully read %i records of which:&quot; </span><span class="s2">%</span>
                                            <span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">records</span><span class="s2">)))</span>

        <span class="s0"># Create convenience list of record types</span>
        <span class="s1">rectypes </span><span class="s2">= [</span><span class="s1">r</span><span class="s2">[</span><span class="s3">'rectype'</span><span class="s2">] </span><span class="s4">for </span><span class="s1">r </span><span class="s4">in </span><span class="s1">records</span><span class="s2">]</span>

        <span class="s4">for </span><span class="s1">rt </span><span class="s4">in </span><span class="s1">set</span><span class="s2">(</span><span class="s1">rectypes</span><span class="s2">):</span>
            <span class="s4">if </span><span class="s1">rt </span><span class="s2">!= </span><span class="s3">'END_MARKER'</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot; - %i are of type %s&quot; </span><span class="s2">% (</span><span class="s1">rectypes</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s1">rt</span><span class="s2">), </span><span class="s1">rt</span><span class="s2">))</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>

        <span class="s4">if </span><span class="s3">'VARIABLE' </span><span class="s4">in </span><span class="s1">rectypes</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Available variables:&quot;</span><span class="s2">)</span>
            <span class="s4">for </span><span class="s1">var </span><span class="s4">in </span><span class="s1">variables</span><span class="s2">:</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot; - </span><span class="s4">{</span><span class="s1">var</span><span class="s4">} </span><span class="s3">[</span><span class="s4">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">variables</span><span class="s2">[</span><span class="s1">var</span><span class="s2">])</span><span class="s4">}</span><span class="s3">]&quot;</span><span class="s2">)</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">*</span><span class="s5">50</span><span class="s2">)</span>

    <span class="s4">if </span><span class="s1">idict</span><span class="s2">:</span>
        <span class="s4">for </span><span class="s1">var </span><span class="s4">in </span><span class="s1">variables</span><span class="s2">:</span>
            <span class="s1">idict</span><span class="s2">[</span><span class="s1">var</span><span class="s2">] = </span><span class="s1">variables</span><span class="s2">[</span><span class="s1">var</span><span class="s2">]</span>
        <span class="s4">return </span><span class="s1">idict</span>
    <span class="s4">else</span><span class="s2">:</span>
        <span class="s4">return </span><span class="s1">variables</span>
</pre>
</body>
</html>