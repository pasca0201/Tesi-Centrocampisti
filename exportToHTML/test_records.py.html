<html>
<head>
<title>test_records.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_records.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc</span>
<span class="s0">import </span><span class="s1">textwrap</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">from </span><span class="s1">os </span><span class="s0">import </span><span class="s1">path</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">pickle</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_raises</span><span class="s2">, </span><span class="s1">temppath</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFromrecords</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_fromrecords</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">([[</span><span class="s3">456</span><span class="s2">, </span><span class="s4">'dbe'</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'de'</span><span class="s2">, </span><span class="s3">1.3</span><span class="s2">]],</span>
                            <span class="s1">names</span><span class="s2">=</span><span class="s4">'col1,col2,col3'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">item</span><span class="s2">(), (</span><span class="s3">456</span><span class="s2">, </span><span class="s4">'dbe'</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'col1'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'col2'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">, </span><span class="s4">'U'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'col2'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'col3'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fromrecords_0len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; Verify fromrecords works with a 0-length input &quot;&quot;&quot;</span>
        <span class="s1">dtype </span><span class="s2">= [(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)]</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s3">0</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">test_fromrecords_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= [</span>
            <span class="s2">[(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), (</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)],</span>
            <span class="s2">[(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)]</span>
        <span class="s2">]</span>
        <span class="s1">expected_a </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
        <span class="s1">expected_b </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>

        <span class="s6"># try with dtype</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">[</span><span class="s4">'a'</span><span class="s2">], </span><span class="s1">expected_a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">[</span><span class="s4">'b'</span><span class="s2">], </span><span class="s1">expected_b</span><span class="s2">)</span>

        <span class="s6"># try with names</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=[</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">[</span><span class="s4">'a'</span><span class="s2">], </span><span class="s1">expected_a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">[</span><span class="s4">'b'</span><span class="s2">], </span><span class="s1">expected_b</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_method_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s7">b'abcdefg' </span><span class="s2">* </span><span class="s3">100</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">=</span><span class="s4">'i2,S3,i4'</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">byteorder</span><span class="s2">=</span><span class="s4">'big'</span>
        <span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">item</span><span class="s2">(), (</span><span class="s3">25444</span><span class="s2">, </span><span class="s7">b'efg'</span><span class="s2">, </span><span class="s3">1633837924</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_method_array2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s4">'a'</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">22</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">33</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">44</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">55</span><span class="s2">, </span><span class="s4">'ex'</span><span class="s2">), (</span><span class="s3">6</span><span class="s2">, </span><span class="s3">66</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">), (</span><span class="s3">7</span><span class="s2">, </span><span class="s3">77</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">)</span>
            <span class="s2">],</span>
            <span class="s1">formats</span><span class="s2">=</span><span class="s4">'u1,f4,S1'</span>
        <span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">item</span><span class="s2">(), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">22.0</span><span class="s2">, </span><span class="s7">b'b'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_recarray_slices</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s4">'a'</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">22</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">33</span><span class="s2">, </span><span class="s4">'c'</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">44</span><span class="s2">, </span><span class="s4">'d'</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">55</span><span class="s2">, </span><span class="s4">'ex'</span><span class="s2">), (</span><span class="s3">6</span><span class="s2">, </span><span class="s3">66</span><span class="s2">, </span><span class="s4">'f'</span><span class="s2">), (</span><span class="s3">7</span><span class="s2">, </span><span class="s3">77</span><span class="s2">, </span><span class="s4">'g'</span><span class="s2">)</span>
            <span class="s2">],</span>
            <span class="s1">formats</span><span class="s2">=</span><span class="s4">'u1,f4,S1'</span>
        <span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">][</span><span class="s3">1</span><span class="s2">].</span><span class="s1">item</span><span class="s2">(), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">44.0</span><span class="s2">, </span><span class="s7">b'd'</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_recarray_fromarrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">x2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'dd'</span><span class="s2">, </span><span class="s4">'xyz'</span><span class="s2">, </span><span class="s4">'12'</span><span class="s2">])</span>
        <span class="s1">x3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromarrays</span><span class="s2">([</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">], </span><span class="s1">names</span><span class="s2">=</span><span class="s4">'a,b,c'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">item</span><span class="s2">(), (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'dd'</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">))</span>
        <span class="s1">x1</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = </span><span class="s3">34</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_recarray_fromfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">data_dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">), </span><span class="s4">'data'</span><span class="s2">)</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">data_dir</span><span class="s2">, </span><span class="s4">'recarray_from_file.fits'</span><span class="s2">)</span>
        <span class="s1">fd </span><span class="s2">= </span><span class="s1">open</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s4">'rb'</span><span class="s2">)</span>
        <span class="s1">fd</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s3">2880 </span><span class="s2">* </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromfile</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">=</span><span class="s4">'f8,i4,S5'</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">byteorder</span><span class="s2">=</span><span class="s4">'big'</span><span class="s2">)</span>
        <span class="s1">fd</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s3">2880 </span><span class="s2">* </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">=</span><span class="s4">'f8,i4,S5'</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">byteorder</span><span class="s2">=</span><span class="s4">'big'</span><span class="s2">)</span>
        <span class="s1">fd</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s3">2880 </span><span class="s2">* </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">bytes_array </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
        <span class="s1">bytes_array</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s1">bytes_array</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">r3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromfile</span><span class="s2">(</span>
            <span class="s1">bytes_array</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">=</span><span class="s4">'f8,i4,S5'</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">byteorder</span><span class="s2">=</span><span class="s4">'big'</span>
        <span class="s2">)</span>
        <span class="s1">fd</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r1</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarray_from_obj</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s3">10</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">count</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'O'</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">count</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">count</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)):</span>
            <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">))</span>

        <span class="s1">mine </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromarrays</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">], </span><span class="s1">names</span><span class="s2">=</span><span class="s4">'date,data1,data2'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)):</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">mine</span><span class="s2">.</span><span class="s1">date</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">mine</span><span class="s2">.</span><span class="s1">data1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s3">0.0</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">mine</span><span class="s2">.</span><span class="s1">data2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s3">0.0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarray_repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'&lt;i4'</span><span class="s2">), (</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s4">'&lt;f8'</span><span class="s2">)])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span>
            <span class="s1">repr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">),</span>
            <span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
            </span><span class="s4">rec.array([(1, 0.1), (2, 0.2)], 
                      dtype=[('foo', '&lt;i4'), ('bar', '&lt;f8')])&quot;&quot;&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s6"># make sure non-structured dtypes also show up as rec.array</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'rec.array'</span><span class="s2">))</span>

        <span class="s6"># check that the 'np.record' part of the dtype isn't shown</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i4,i4'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">find</span><span class="s2">(</span><span class="s4">'numpy.record'</span><span class="s2">), -</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i4'</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">find</span><span class="s2">(</span><span class="s4">'dtype=int32'</span><span class="s2">) != -</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_0d_recarray_repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arr_0d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s4">'2003'</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'&lt;i4,&lt;f8,&lt;M8[Y]'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">arr_0d</span><span class="s2">), </span><span class="s1">textwrap</span><span class="s2">.</span><span class="s1">dedent</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot;</span><span class="s0">\ 
            </span><span class="s4">rec.array((1, 2., '2003'), 
                      dtype=[('f0', '&lt;i4'), ('f1', '&lt;f8'), ('f2', '&lt;M8[Y]')])&quot;&quot;&quot;</span><span class="s2">))</span>

        <span class="s1">record </span><span class="s2">= </span><span class="s1">arr_0d</span><span class="s2">[()]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">record</span><span class="s2">), </span>
            <span class="s4">&quot;np.record((1, 2.0, '2003'), &quot;</span>
            <span class="s4">&quot;dtype=[('f0', '&lt;i4'), ('f1', '&lt;f8'), ('f2', '&lt;M8[Y]')])&quot;</span><span class="s2">)</span>
        <span class="s6"># 1.13 converted to python scalars before the repr</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">set_printoptions</span><span class="s2">(</span><span class="s1">legacy</span><span class="s2">=</span><span class="s4">'1.13'</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">record</span><span class="s2">), </span><span class="s4">'(1, 2.0, datetime.date(2003, 1, 1))'</span><span class="s2">)</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">set_printoptions</span><span class="s2">(</span><span class="s1">legacy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarray_from_repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'ABC'</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">&quot;DEF&quot;</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s4">'S4'</span><span class="s2">)])</span>
        <span class="s1">recordarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">recarr </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">recordview </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">((</span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)))</span>

        <span class="s1">recordarr_r </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s4">&quot;np.&quot; </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">recordarr</span><span class="s2">), {</span><span class="s4">'np'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">})</span>
        <span class="s1">recarr_r </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s4">&quot;np.&quot; </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">recarr</span><span class="s2">), {</span><span class="s4">'np'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">})</span>
        <span class="s6"># Prints the type `numpy.record` as part of the dtype:</span>
        <span class="s1">recordview_r </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s4">&quot;np.&quot; </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">recordview</span><span class="s2">), {</span><span class="s4">'np'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">, </span><span class="s4">'numpy'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">})</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">recordarr_r</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">recordarr_r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">recordarr</span><span class="s2">, </span><span class="s1">recordarr_r</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">recarr_r</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">recarr_r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">recarr</span><span class="s2">, </span><span class="s1">recarr_r</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">recordview_r</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">recordview</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">recordview</span><span class="s2">, </span><span class="s1">recordview_r</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarray_views</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">,</span><span class="s4">'ABC'</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">&quot;DEF&quot;</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s4">'S4'</span><span class="s2">)])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">,</span><span class="s3">5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

        <span class="s6">#check that np.rec.array gives right dtypes</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">b</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>

        <span class="s6">#check that viewing as recarray does the same</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>

        <span class="s6">#check that view to non-structured dtype preserves type=np.recarray</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;f4,i4&quot;</span><span class="s2">))</span>
        <span class="s1">rv </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s4">'f8'</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s4">'f4,i4'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">rv</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rv</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>

        <span class="s6">#check that getitem also preserves np.recarray and np.record</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'i4'</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'i4'</span><span class="s2">),</span>
                                           <span class="s2">(</span><span class="s4">'c'</span><span class="s2">, </span><span class="s4">'i4,i4'</span><span class="s2">)]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'c'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">r</span><span class="s2">[</span><span class="s4">'c'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>

        <span class="s6">#and that it preserves subclasses (gh-6949)</span>
        <span class="s0">class </span><span class="s1">C</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">C</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">c</span><span class="s2">[</span><span class="s4">'c'</span><span class="s2">]), </span><span class="s1">C</span><span class="s2">)</span>

        <span class="s6"># check that accessing nested structures keep record type, but</span>
        <span class="s6"># not for subarrays, non-void structures, non-structured voids</span>
        <span class="s1">test_dtype </span><span class="s2">= [(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'f4,f4'</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'V8'</span><span class="s2">), (</span><span class="s4">'c'</span><span class="s2">, (</span><span class="s4">'f4'</span><span class="s2">,</span><span class="s3">2</span><span class="s2">)),</span>
                      <span class="s2">(</span><span class="s4">'d'</span><span class="s2">, (</span><span class="s4">'i8'</span><span class="s2">, </span><span class="s4">'i4,i4'</span><span class="s2">))]</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([((</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">), </span><span class="s7">b'11111111'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">),</span>
                          <span class="s2">((</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">), </span><span class="s7">b'11111111'</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">test_dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">void</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">d</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s6"># check the same, but for views</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'i4,i4'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s4">'f4,f4'</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">((</span><span class="s4">'i4'</span><span class="s2">,</span><span class="s3">2</span><span class="s2">)).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s4">'V8'</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">void</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">view</span><span class="s2">((</span><span class="s4">'i8'</span><span class="s2">, </span><span class="s4">'i4,i4'</span><span class="s2">)).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>

        <span class="s6">#check that we can undo the view</span>
        <span class="s1">arrs </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f4,i4'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">'f8'</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">arrs</span><span class="s2">:</span>
            <span class="s1">rec </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
            <span class="s6"># recommended way to view as an ndarray:</span>
            <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">rec</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">fields </span><span class="s0">or </span><span class="s1">rec</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">arr2</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">arr2</span><span class="s2">), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_recarray_from_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ra </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s3">3.7000002861022949</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'xy'</span><span class="s2">, </span><span class="s3">6.6999998092651367</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s4">' '</span><span class="s2">, </span><span class="s3">0.40000000596046448</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)],</span>
                       <span class="s1">names</span><span class="s2">=</span><span class="s4">'c1, c2, c3, c4'</span><span class="s2">)</span>
        <span class="s1">pa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s3">3.7000002861022949</span><span class="s2">, </span><span class="s3">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'xy'</span><span class="s2">, </span><span class="s3">6.6999998092651367</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s4">' '</span><span class="s2">, </span><span class="s3">0.40000000596046448</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)],</span>
                       <span class="s1">names</span><span class="s2">=</span><span class="s4">'c1, c2, c3, c4'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">pa</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">pa</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">)):</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">[</span><span class="s1">k</span><span class="s2">].</span><span class="s1">item</span><span class="s2">() == </span><span class="s1">pa</span><span class="s2">[</span><span class="s1">k</span><span class="s2">].</span><span class="s1">item</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_recarray_conflict_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ra </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'abc'</span><span class="s2">, </span><span class="s3">2.3</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'xyz'</span><span class="s2">, </span><span class="s3">4.2</span><span class="s2">),</span>
                        <span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s4">'wrs'</span><span class="s2">, </span><span class="s3">1.3</span><span class="s2">)],</span>
                       <span class="s1">names</span><span class="s2">=</span><span class="s4">'field, shape, mean'</span><span class="s2">)</span>
        <span class="s1">ra</span><span class="s2">.</span><span class="s1">mean </span><span class="s2">= [</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.2</span><span class="s2">, </span><span class="s3">3.3</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">[</span><span class="s4">'mean'</span><span class="s2">], [</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.2</span><span class="s2">, </span><span class="s3">3.3</span><span class="s2">])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">) </span><span class="s0">is </span><span class="s1">type</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">.</span><span class="s1">var</span><span class="s2">))</span>
        <span class="s1">ra</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">ra</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= [</span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'B'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">[</span><span class="s4">'shape'</span><span class="s2">], [[</span><span class="s4">'A'</span><span class="s2">, </span><span class="s4">'B'</span><span class="s2">, </span><span class="s4">'C'</span><span class="s2">]])</span>
        <span class="s1">ra</span><span class="s2">.</span><span class="s1">field </span><span class="s2">= </span><span class="s3">5</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">[</span><span class="s4">'field'</span><span class="s2">], [[</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">.</span><span class="s1">field</span><span class="s2">, </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_fromrecords_with_explicit_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'a'</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'bbb'</span><span class="s2">)],</span>
                                <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">object</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, [</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'bbb'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'bbb'</span><span class="s2">)</span>
        <span class="s6">#</span>
        <span class="s1">ndtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">object</span><span class="s2">)])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'a'</span><span class="s2">), (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'bbb'</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">ndtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">a</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, [</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'bbb'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">].</span><span class="s1">b</span><span class="s2">, </span><span class="s4">'bbb'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarray_stringtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Issue #3993</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">'abc '</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s4">'abc'</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)],</span>
                     <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'S4'</span><span class="s2">), (</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">foo</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s1">a</span><span class="s2">.</span><span class="s1">foo</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_recarray_returntypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">qux_fields </span><span class="s2">= {</span><span class="s4">'C'</span><span class="s2">: (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S5'</span><span class="s2">), </span><span class="s3">0</span><span class="s2">), </span><span class="s4">'D'</span><span class="s2">: (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">'S5'</span><span class="s2">), </span><span class="s3">6</span><span class="s2">)}</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s4">'abc '</span><span class="s2">, (</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, (</span><span class="s4">'abcde'</span><span class="s2">, </span><span class="s4">'fgehi'</span><span class="s2">)),</span>
                          <span class="s2">(</span><span class="s4">'abc'</span><span class="s2">, (</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, (</span><span class="s4">'abcde'</span><span class="s2">, </span><span class="s4">'jklmn'</span><span class="s2">))],</span>
                         <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'S4'</span><span class="s2">),</span>
                                <span class="s2">(</span><span class="s4">'bar'</span><span class="s2">, [(</span><span class="s4">'A'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'B'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]),</span>
                                <span class="s2">(</span><span class="s4">'baz'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'qux'</span><span class="s2">, </span><span class="s1">qux_fields</span><span class="s2">)])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">foo</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'foo'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">bar</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'bar'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">bar</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'qux'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">qux</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">qux</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">), </span><span class="s1">qux_fields</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">baz</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s4">'baz'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">bar</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s4">'bar'</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">bar</span><span class="s2">.</span><span class="s1">A</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">bar</span><span class="s2">[</span><span class="s4">'A'</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s4">'bar'</span><span class="s2">].</span><span class="s1">A</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s4">'bar'</span><span class="s2">][</span><span class="s4">'A'</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">qux</span><span class="s2">.</span><span class="s1">D</span><span class="s2">, </span><span class="s7">b'fgehi'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">qux</span><span class="s2">[</span><span class="s4">'D'</span><span class="s2">], </span><span class="s7">b'fgehi'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s4">'qux'</span><span class="s2">].</span><span class="s1">D</span><span class="s2">, </span><span class="s7">b'fgehi'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s4">'qux'</span><span class="s2">][</span><span class="s4">'D'</span><span class="s2">], </span><span class="s7">b'fgehi'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zero_width_strings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Test for #6430, based on the test case from #1901</span>

        <span class="s1">cols </span><span class="s2">= [[</span><span class="s4">'test'</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">, [</span><span class="s4">''</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s1">rec </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromarrays</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s4">'f0'</span><span class="s2">], [</span><span class="s4">'test'</span><span class="s2">, </span><span class="s4">'test'</span><span class="s2">, </span><span class="s4">'test'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s4">'f1'</span><span class="s2">], [</span><span class="s4">''</span><span class="s2">, </span><span class="s4">''</span><span class="s2">, </span><span class="s4">''</span><span class="s2">])</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'f0'</span><span class="s2">, </span><span class="s4">'|S4'</span><span class="s2">), (</span><span class="s4">'f1'</span><span class="s2">, </span><span class="s4">'|S'</span><span class="s2">)])</span>
        <span class="s1">rec </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromarrays</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s4">'f0'</span><span class="s2">], [</span><span class="s7">b'test'</span><span class="s2">, </span><span class="s7">b'test'</span><span class="s2">, </span><span class="s7">b'test'</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s4">'f1'</span><span class="s2">], [</span><span class="s7">b''</span><span class="s2">, </span><span class="s7">b''</span><span class="s2">, </span><span class="s7">b''</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestPathUsage</span><span class="s2">:</span>
    <span class="s6"># Test that pathlib.Path can be used</span>
    <span class="s0">def </span><span class="s1">test_tofile_fromfile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">temppath</span><span class="s2">(</span><span class="s1">suffix</span><span class="s2">=</span><span class="s4">'.bin'</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">123</span><span class="s2">)</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">'f8,i4,S5'</span><span class="s2">)</span>
            <span class="s1">a</span><span class="s2">[</span><span class="s3">5</span><span class="s2">] = (</span><span class="s3">0.5</span><span class="s2">,</span><span class="s3">10</span><span class="s2">,</span><span class="s4">'abcde'</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">path</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s4">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
                <span class="s1">a</span><span class="s2">.</span><span class="s1">tofile</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">)</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">records</span><span class="s2">.</span><span class="s1">fromfile</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">, </span><span class="s1">formats</span><span class="s2">=</span><span class="s4">'f8,i4,S5'</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">=</span><span class="s3">10</span>
            <span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRecord</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromrecords</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), (</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)],</span>
                            <span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;&lt;i4&quot;</span><span class="s2">),</span>
                                   <span class="s2">(</span><span class="s4">&quot;col2&quot;</span><span class="s2">, </span><span class="s4">&quot;&lt;i4&quot;</span><span class="s2">),</span>
                                   <span class="s2">(</span><span class="s4">&quot;col3&quot;</span><span class="s2">, </span><span class="s4">&quot;&lt;i4&quot;</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_assignment1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">col1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">col1 </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">col1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_assignment2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">col1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">col1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s3">0</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">col1</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_assignment</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

        <span class="s0">def </span><span class="s1">assign_invalid_column</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">col5 </span><span class="s2">= </span><span class="s3">1</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">assign_invalid_column</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nonwriteable_setfield</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># gh-8171</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">0</span><span class="s2">,), (</span><span class="s3">1</span><span class="s2">,)], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'f'</span><span class="s2">, </span><span class="s4">'i4'</span><span class="s2">)])</span>
        <span class="s1">r</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">r</span><span class="s2">.</span><span class="s1">f </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">r</span><span class="s2">.</span><span class="s1">setfield</span><span class="s2">([</span><span class="s3">2</span><span class="s2">,</span><span class="s3">3</span><span class="s2">], *</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">fields</span><span class="s2">[</span><span class="s4">'f'</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_out_of_order_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># names in the same order, padding added to descr</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[[</span><span class="s4">'col1'</span><span class="s2">, </span><span class="s4">'col2'</span><span class="s2">]]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">names</span><span class="s2">, (</span><span class="s4">'col1'</span><span class="s2">, </span><span class="s4">'col2'</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">descr</span><span class="s2">,</span>
                     <span class="s2">[(</span><span class="s4">'col1'</span><span class="s2">, </span><span class="s4">'&lt;i4'</span><span class="s2">), (</span><span class="s4">'col2'</span><span class="s2">, </span><span class="s4">'&lt;i4'</span><span class="s2">), (</span><span class="s4">''</span><span class="s2">, </span><span class="s4">'|V4'</span><span class="s2">)])</span>

        <span class="s6"># names change order to match indexing, as of 1.14 - descr can't</span>
        <span class="s6"># represent that</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[[</span><span class="s4">'col2'</span><span class="s2">, </span><span class="s4">'col1'</span><span class="s2">]]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">names</span><span class="s2">, (</span><span class="s4">'col2'</span><span class="s2">, </span><span class="s4">'col1'</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">y</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">descr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pickle_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Issue #1529</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">1</span><span class="s2">, [])], </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)])</span>
        <span class="s0">for </span><span class="s1">proto </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">HIGHEST_PROTOCOL </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">protocol</span><span class="s2">=</span><span class="s1">proto</span><span class="s2">)))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">],</span>
                                                         <span class="s1">protocol</span><span class="s2">=</span><span class="s1">proto</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_pickle_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s0">for </span><span class="s1">proto </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">HIGHEST_PROTOCOL </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">protocol</span><span class="s2">=</span><span class="s1">proto</span><span class="s2">)))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">],</span>
                                                         <span class="s1">protocol</span><span class="s2">=</span><span class="s1">proto</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_pickle_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># Issue #7140</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>
        <span class="s0">for </span><span class="s1">proto </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">HIGHEST_PROTOCOL </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">pa </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">protocol</span><span class="s2">=</span><span class="s1">proto</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">f_contiguous</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">aligned</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pickle_void</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># issue gh-13593</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'obj'</span><span class="s2">, </span><span class="s4">'O'</span><span class="s2">), (</span><span class="s4">'int'</span><span class="s2">, </span><span class="s4">'i'</span><span class="s2">)])</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s1">bytearray</span><span class="s2">(</span><span class="s7">b'eman'</span><span class="s2">),)</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s4">'obj'</span><span class="s2">] = </span><span class="s1">data</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s4">'int'</span><span class="s2">] = </span><span class="s3">42</span>
        <span class="s1">ctor</span><span class="s2">, </span><span class="s1">args </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">__reduce__</span><span class="s2">()</span>
        <span class="s6"># check the constructor is what we expect before interpreting the arguments</span>
        <span class="s0">assert </span><span class="s1">ctor </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">multiarray</span><span class="s2">.</span><span class="s1">scalar</span>
        <span class="s1">dtype</span><span class="s2">, </span><span class="s1">obj </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s6"># make sure we did not pickle the address</span>
        <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">, </span><span class="s1">ctor</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">13</span><span class="s2">)</span>

        <span class="s6"># Test roundtrip:</span>
        <span class="s1">dump </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">unpickled </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">dump</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] == </span><span class="s1">unpickled</span>

        <span class="s6"># Also check the similar (impossible) &quot;object scalar&quot; path:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">DeprecationWarning</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">ctor</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s4">&quot;O&quot;</span><span class="s2">), </span><span class="s1">data</span><span class="s2">) </span><span class="s0">is </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">test_objview_record</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># https://github.com/numpy/numpy/issues/2599</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'foo'</span><span class="s2">, </span><span class="s4">'i8'</span><span class="s2">), (</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s4">'O'</span><span class="s2">)])</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">.</span><span class="s1">foo </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])  </span><span class="s6"># TypeError?</span>

        <span class="s6"># https://github.com/numpy/numpy/issues/3256</span>
        <span class="s1">ra </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s3">2</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'x'</span><span class="s2">, </span><span class="s1">object</span><span class="s2">), (</span><span class="s4">'y'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">), (</span><span class="s4">'z'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)]</span>
        <span class="s2">)</span>
        <span class="s1">ra</span><span class="s2">[[</span><span class="s4">'x'</span><span class="s2">,</span><span class="s4">'y'</span><span class="s2">]]  </span><span class="s6"># TypeError?</span>

    <span class="s0">def </span><span class="s1">test_record_scalar_setitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># https://github.com/numpy/numpy/issues/3561</span>
        <span class="s1">rec </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'x'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)])</span>
        <span class="s1">rec</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">x </span><span class="s2">= </span><span class="s3">1</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">5</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_missing_field</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6"># https://github.com/numpy/numpy/issues/4806</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'x'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">), (</span><span class="s4">'y'</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">arr</span><span class="s2">[[</span><span class="s4">'nofield'</span><span class="s2">]])</span>

    <span class="s0">def </span><span class="s1">test_fromarrays_nested_structured_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">arrays </span><span class="s2">= [</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=[(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'&lt;u2'</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'&lt;f4'</span><span class="s2">)]),</span>
        <span class="s2">]</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">fromarrays</span><span class="s2">(</span><span class="s1">arrays</span><span class="s2">)  </span><span class="s6"># ValueError?</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'nfields'</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_assign_dtype_attribute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nfields</span><span class="s2">):</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), (</span><span class="s4">'c'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)][:</span><span class="s1">nfields</span><span class="s2">])</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>

        <span class="s6"># the original and resulting dtypes differ on whether they are records</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span>
        <span class="s0">assert </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">type </span><span class="s2">!= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span>

        <span class="s6"># ensure that the dtype remains a record even when assigned</span>
        <span class="s1">data</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">dt</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'nfields'</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_nested_fields_are_records</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nfields</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; Test that nested structured types are treated as records too &quot;&quot;&quot;</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), (</span><span class="s4">'c'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)][:</span><span class="s1">nfields</span><span class="s2">])</span>
        <span class="s1">dt_outer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'inner'</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)])</span>

        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dt_outer</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'inner'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>

        <span class="s1">data0 </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data0</span><span class="s2">[</span><span class="s4">'inner'</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">record</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nested_dtype_padding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5">&quot;&quot;&quot; test that trailing padding is preserved &quot;&quot;&quot;</span>
        <span class="s6"># construct a dtype with padding at the end</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), (</span><span class="s4">'b'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">), (</span><span class="s4">'c'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)])</span>
        <span class="s1">dt_padded_end </span><span class="s2">= </span><span class="s1">dt</span><span class="s2">[[</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">]]</span>
        <span class="s0">assert </span><span class="s1">dt_padded_end</span><span class="s2">.</span><span class="s1">itemsize </span><span class="s2">== </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">itemsize</span>

        <span class="s1">dt_outer </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([(</span><span class="s4">'inner'</span><span class="s2">, </span><span class="s1">dt_padded_end</span><span class="s2">)])</span>

        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dt_outer</span><span class="s2">).</span><span class="s1">view</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">recarray</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">'inner'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt_padded_end</span><span class="s2">)</span>

        <span class="s1">data0 </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">data0</span><span class="s2">[</span><span class="s4">'inner'</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dt_padded_end</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_find_duplicate</span><span class="s2">():</span>
    <span class="s1">l1 </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">find_duplicate</span><span class="s2">(</span><span class="s1">l1</span><span class="s2">) == [])</span>

    <span class="s1">l2 </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">find_duplicate</span><span class="s2">(</span><span class="s1">l2</span><span class="s2">) == [</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s1">l3 </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">find_duplicate</span><span class="s2">(</span><span class="s1">l3</span><span class="s2">) == [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">l3 </span><span class="s2">= [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]</span>
    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">rec</span><span class="s2">.</span><span class="s1">find_duplicate</span><span class="s2">(</span><span class="s1">l3</span><span class="s2">) == [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
</pre>
</body>
</html>