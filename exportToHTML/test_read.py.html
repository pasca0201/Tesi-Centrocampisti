<html>
<head>
<title>test_read.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_read.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">closing</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">re</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_libs</span><span class="s2">.</span><span class="s1">tslibs </span><span class="s0">import </span><span class="s1">Timestamp</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">compat </span><span class="s0">import </span><span class="s1">is_platform_windows</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">HDFStore</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
    <span class="s1">read_hdf</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">pytables</span><span class="s2">.</span><span class="s1">common </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_maybe_remove</span><span class="s2">,</span>
    <span class="s1">ensure_clean_store</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util </span><span class="s0">import </span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">pytables </span><span class="s0">import </span><span class="s1">TableIterator</span>

<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span>


<span class="s0">def </span><span class="s1">test_read_missing_key_close_store</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH 25766</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s4">&quot;b&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;k1&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;'No object named k2 in the file'&quot;</span><span class="s2">):</span>
        <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;k2&quot;</span><span class="s2">)</span>

    <span class="s3"># smoke test to test that file is properly closed after</span>
    <span class="s3"># read with KeyError before another write</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;k2&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_index_error_close_store</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH 25766</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;A&quot;</span><span class="s2">: [], </span><span class="s4">&quot;B&quot;</span><span class="s2">: []}, </span><span class="s1">index</span><span class="s2">=[])</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;k1&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;list index out of range&quot;</span><span class="s2">):</span>
        <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;k1&quot;</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s3"># smoke test to test that file is properly closed after</span>
    <span class="s3"># read with IndexError before another write</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;k1&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_missing_key_opened_store</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH 28699</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">), </span><span class="s4">&quot;b&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;k1&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">HDFStore</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;r&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;'No object named k2 in the file'&quot;</span><span class="s2">):</span>
            <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">store</span><span class="s2">, </span><span class="s4">&quot;k2&quot;</span><span class="s2">)</span>

        <span class="s3"># Test that the file is still open after a KeyError and that we can</span>
        <span class="s3"># still read from it.</span>
        <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">store</span><span class="s2">, </span><span class="s4">&quot;k1&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_column</span><span class="s2">(</span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span><span class="s1">setup_path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">_maybe_remove</span><span class="s2">(</span><span class="s1">store</span><span class="s2">, </span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>

        <span class="s3"># GH 17912</span>
        <span class="s3"># HDFStore.select_column should raise a KeyError</span>
        <span class="s3"># exception if the key is not a valid store</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;No object named df in the file&quot;</span><span class="s2">):</span>
            <span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s4">&quot;index&quot;</span><span class="s2">)</span>

        <span class="s1">store</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>
        <span class="s3"># error</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s4">&quot;'column [foo] not found in the table'&quot;</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s4">&quot;select_column() got an unexpected keyword argument 'where'&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s4">&quot;index&quot;</span><span class="s2">, </span><span class="s1">where</span><span class="s2">=[</span><span class="s4">&quot;index&gt;5&quot;</span><span class="s2">])</span>

        <span class="s3"># valid</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s4">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">).</span><span class="s1">values</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">)</span>

        <span class="s3"># not a data indexable column</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s4">&quot;column [values_block_0] can not be extracted individually; &quot;</span>
            <span class="s4">&quot;it is not data indexable&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s4">&quot;values_block_0&quot;</span><span class="s2">)</span>

        <span class="s3"># a data column</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">df2</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">] = </span><span class="s4">&quot;foo&quot;</span>
        <span class="s1">store</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;df2&quot;</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">data_columns</span><span class="s2">=[</span><span class="s4">&quot;string&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df2&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">)</span>

        <span class="s3"># a data column with NaNs, result excludes the NaNs</span>
        <span class="s1">df3 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">] = </span><span class="s4">&quot;foo&quot;</span>
        <span class="s1">df3</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">df3</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[</span><span class="s5">4</span><span class="s2">:</span><span class="s5">6</span><span class="s2">], </span><span class="s4">&quot;string&quot;</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">store</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">, </span><span class="s1">data_columns</span><span class="s2">=[</span><span class="s4">&quot;string&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">)</span>

        <span class="s3"># start/stop</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:])</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=-</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">[-</span><span class="s5">2</span><span class="s2">:])</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">])</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">=-</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">[:-</span><span class="s5">2</span><span class="s2">])</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">=-</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:-</span><span class="s5">2</span><span class="s2">])</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df3&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=-</span><span class="s5">2</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">df3</span><span class="s2">[</span><span class="s4">&quot;string&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">[-</span><span class="s5">2</span><span class="s2">:</span><span class="s5">2</span><span class="s2">])</span>

        <span class="s3"># GH 10392 - make sure column name is preserved</span>
        <span class="s1">df4 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;A&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s5">10</span><span class="s2">), </span><span class="s4">&quot;B&quot;</span><span class="s2">: </span><span class="s4">&quot;foo&quot;</span><span class="s2">})</span>
        <span class="s1">store</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;df4&quot;</span><span class="s2">, </span><span class="s1">df4</span><span class="s2">, </span><span class="s1">data_columns</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df4</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select_column</span><span class="s2">(</span><span class="s4">&quot;df4&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pytables_native_read</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span>
        <span class="s1">datapath</span><span class="s2">(</span><span class="s4">&quot;io&quot;</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_hdf/pytables_native.h5&quot;</span><span class="s2">), </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">d2 </span><span class="s2">= </span><span class="s1">store</span><span class="s2">[</span><span class="s4">&quot;detector/readout&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">d2</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">is_platform_windows</span><span class="s2">(), </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;native2 read fails oddly on windows&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pytables_native2_read</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span>
        <span class="s1">datapath</span><span class="s2">(</span><span class="s4">&quot;io&quot;</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_hdf&quot;</span><span class="s2">, </span><span class="s4">&quot;pytables_native2.h5&quot;</span><span class="s2">), </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">store</span><span class="s2">)</span>
        <span class="s1">d1 </span><span class="s2">= </span><span class="s1">store</span><span class="s2">[</span><span class="s4">&quot;detector&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_legacy_table_fixed_format_read_py2</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s3"># GH 24510</span>
    <span class="s3"># legacy table with fixed format written in Python 2</span>
    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span>
        <span class="s1">datapath</span><span class="s2">(</span><span class="s4">&quot;io&quot;</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_hdf&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_table_fixed_py2.h5&quot;</span><span class="s2">), </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">]],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;D&quot;</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;ABC&quot;</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;INDEX_NAME&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_legacy_table_fixed_format_read_datetime_py2</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s3"># GH 31750</span>
    <span class="s3"># legacy table with fixed format and datetime64 column written in Python 2</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2020-02-06T18:00&quot;</span><span class="s2">)]],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;date&quot;</span><span class="s2">]),</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;M8[ns]&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span>
        <span class="s1">datapath</span><span class="s2">(</span><span class="s4">&quot;io&quot;</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_hdf&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_table_fixed_datetime_py2.h5&quot;</span><span class="s2">),</span>
        <span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_legacy_table_read_py2</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s3"># issue: 24925</span>
    <span class="s3"># legacy table written in Python 2</span>
    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span>
        <span class="s1">datapath</span><span class="s2">(</span><span class="s4">&quot;io&quot;</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_hdf&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_table_py2.h5&quot;</span><span class="s2">), </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">.</span><span class="s1">select</span><span class="s2">(</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_hdf_open_store</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH10330</span>
    <span class="s3"># No check for non-string path_or-buf, and no test of open store</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCDE&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s4">&quot;letters&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">=</span><span class="s4">&quot;E&quot;</span><span class="s2">, </span><span class="s1">append</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;w&quot;</span><span class="s2">)</span>
    <span class="s1">direct </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">HDFStore</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">indirect </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">store</span><span class="s2">, </span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">direct</span><span class="s2">, </span><span class="s1">indirect</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">store</span><span class="s2">.</span><span class="s1">is_open</span>


<span class="s0">def </span><span class="s1">test_read_hdf_index_not_view</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH 37441</span>
    <span class="s3"># Ensure that the index of the DataFrame is not a view</span>
    <span class="s3"># into the original recarray that pytables reads in</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCDE&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>

    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df2</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">_data</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is None</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_hdf_iterator</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCDE&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s4">&quot;letters&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">=</span><span class="s4">&quot;E&quot;</span><span class="s2">, </span><span class="s1">append</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;w&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;t&quot;</span><span class="s2">)</span>
    <span class="s1">direct </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>
    <span class="s1">iterator </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span><span class="s1">iterator</span><span class="s2">.</span><span class="s1">store</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">iterator</span><span class="s2">, </span><span class="s1">TableIterator</span><span class="s2">)</span>
        <span class="s1">indirect </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">iterator</span><span class="s2">.</span><span class="s1">__iter__</span><span class="s2">())</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">direct</span><span class="s2">, </span><span class="s1">indirect</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_nokey</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH10443</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCDE&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s3"># Categorical dtype not supported for &quot;fixed&quot; format. So no need</span>
    <span class="s3"># to test with that dtype in the dataframe here.</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df2&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;key must be provided when HDF5 file contains multiple datasets.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_nokey_table</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH13231</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;i&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), </span><span class="s4">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abacd&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;category&quot;</span><span class="s2">)})</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>
    <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df2&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;key must be provided when HDF5 file contains multiple datasets.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_nokey_empty</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">store </span><span class="s2">= </span><span class="s1">HDFStore</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
    <span class="s1">store</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;Dataset(s) incompatible with Pandas data types, not table, or no &quot;</span>
        <span class="s4">&quot;datasets found in HDF5 file.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_from_pathlib_path</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH11773</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCDE&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">path_obj </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s1">expected</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path_obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path_obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s4">&quot;py.path&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_from_py_localpath</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH11773</span>
    <span class="s0">from </span><span class="s1">py</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">local </span><span class="s0">as </span><span class="s1">LocalPath</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCDE&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">path_obj </span><span class="s2">= </span><span class="s1">LocalPath</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>

    <span class="s1">expected</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path_obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path_obj</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;df&quot;</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;format&quot;</span><span class="s2">, [</span><span class="s4">&quot;fixed&quot;</span><span class="s2">, </span><span class="s4">&quot;table&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_read_hdf_series_mode_r</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">format</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH 16583</span>
    <span class="s3"># Tests that reading a Series saved to an HDF file</span>
    <span class="s3"># still works if a mode='r' argument is supplied</span>
    <span class="s1">series </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">10</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">series</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s1">format</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">series</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">r&quot;ignore:Period with BDay freq is deprecated:FutureWarning&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s4">r&quot;ignore:PeriodDtype\[B\] is deprecated:FutureWarning&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_py2_hdf_file_in_py3</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s3"># GH 16781</span>

    <span class="s3"># tests reading a PeriodIndex DataFrame written in Python2 in Python3</span>

    <span class="s3"># the file was generated in Python 2.7 like so:</span>
    <span class="s3">#</span>
    <span class="s3"># df = DataFrame([1.,2,3], index=pd.PeriodIndex(</span>
    <span class="s3">#              ['2015-01-01', '2015-01-02', '2015-01-05'], freq='B'))</span>
    <span class="s3"># df.to_hdf('periodindex_0.20.1_x86_64_darwin_2.7.13.h5', 'p')</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">PeriodIndex</span><span class="s2">([</span><span class="s4">&quot;2015-01-01&quot;</span><span class="s2">, </span><span class="s4">&quot;2015-01-02&quot;</span><span class="s2">, </span><span class="s4">&quot;2015-01-05&quot;</span><span class="s2">], </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">ensure_clean_store</span><span class="s2">(</span>
        <span class="s1">datapath</span><span class="s2">(</span>
            <span class="s4">&quot;io&quot;</span><span class="s2">, </span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s4">&quot;legacy_hdf&quot;</span><span class="s2">, </span><span class="s4">&quot;periodindex_0.20.1_x86_64_darwin_2.7.13.h5&quot;</span>
        <span class="s2">),</span>
        <span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">store</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">store</span><span class="s2">[</span><span class="s4">&quot;p&quot;</span><span class="s2">]</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_infer_string</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">, </span><span class="s1">setup_path</span><span class="s2">):</span>
    <span class="s3"># GH#54431</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]})</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s1">setup_path</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;table&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s4">&quot;future.infer_string&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">read_hdf</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s4">&quot;data&quot;</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]},</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string[pyarrow_numpy]&quot;</span><span class="s2">,</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string[pyarrow_numpy]&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>