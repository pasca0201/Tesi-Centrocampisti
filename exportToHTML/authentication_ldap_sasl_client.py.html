<html>
<head>
<title>authentication_ldap_sasl_client.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
authentication_ldap_sasl_client.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2023, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s2">&quot;&quot;&quot;LDAP SASL Authentication Plugin.&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">hmac</span>

<span class="s3">from </span><span class="s1">base64 </span><span class="s3">import </span><span class="s1">b64decode</span><span class="s4">, </span><span class="s1">b64encode</span>
<span class="s3">from </span><span class="s1">hashlib </span><span class="s3">import </span><span class="s1">sha1</span><span class="s4">, </span><span class="s1">sha256</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TYPE_CHECKING</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Callable</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Tuple</span>
<span class="s3">from </span><span class="s1">uuid </span><span class="s3">import </span><span class="s1">uuid4</span>

<span class="s3">from </span><span class="s4">..</span><span class="s1">authentication </span><span class="s3">import </span><span class="s1">ERR_STATUS</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">errors </span><span class="s3">import </span><span class="s1">InterfaceError</span><span class="s4">, </span><span class="s1">ProgrammingError</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">logger </span><span class="s3">import </span><span class="s1">logger</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">types </span><span class="s3">import </span><span class="s1">StrOrBytes</span>

<span class="s3">if </span><span class="s1">TYPE_CHECKING</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">network </span><span class="s3">import </span><span class="s1">MySQLSocket</span>

<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">gssapi</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
    <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
        <span class="s5">&quot;Module gssapi is required for GSSAPI authentication &quot;</span>
        <span class="s5">&quot;mechanism but was not found. Unable to authenticate &quot;</span>
        <span class="s5">&quot;with the server&quot;</span>
    <span class="s4">) </span><span class="s3">from None</span>

<span class="s3">from </span><span class="s4">..</span><span class="s1">utils </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">normalize_unicode_string </span><span class="s3">as </span><span class="s1">norm_ustr</span><span class="s4">,</span>
    <span class="s1">validate_normalized_unicode_string </span><span class="s3">as </span><span class="s1">valid_norm</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">MySQLAuthPlugin</span>

<span class="s1">AUTHENTICATION_PLUGIN_CLASS </span><span class="s4">= </span><span class="s5">&quot;MySQLLdapSaslPasswordAuthPlugin&quot;</span>


<span class="s0"># pylint: disable=c-extension-no-member,no-member</span>
<span class="s3">class </span><span class="s1">MySQLLdapSaslPasswordAuthPlugin</span><span class="s4">(</span><span class="s1">MySQLAuthPlugin</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Class implementing the MySQL ldap sasl authentication plugin. 
 
    The MySQL's ldap sasl authentication plugin support two authentication 
    methods SCRAM-SHA-1 and GSSAPI (using Kerberos). This implementation only 
    support SCRAM-SHA-1 and SCRAM-SHA-256. 
 
    SCRAM-SHA-1 amd SCRAM-SHA-256 
        This method requires 2 messages from client and 2 responses from 
        server. 
 
        The first message from client will be generated by prepare_password(), 
        after receive the response from the server, it is required that this 
        response is passed back to auth_continue() which will return the 
        second message from the client. After send this second message to the 
        server, the second server respond needs to be passed to auth_finalize() 
        to finish the authentication process. 
    &quot;&quot;&quot;</span>

    <span class="s1">sasl_mechanisms</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = [</span><span class="s5">&quot;SCRAM-SHA-1&quot;</span><span class="s4">, </span><span class="s5">&quot;SCRAM-SHA-256&quot;</span><span class="s4">, </span><span class="s5">&quot;GSSAPI&quot;</span><span class="s4">]</span>
    <span class="s1">def_digest_mode</span><span class="s4">: </span><span class="s1">Callable </span><span class="s4">= </span><span class="s1">sha1</span>
    <span class="s1">client_nonce</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">client_salt</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">server_salt</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">krb_service_principal</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">iterations</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">server_auth_var</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">target_name</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">ctx</span><span class="s4">: </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">SecurityContext </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">servers_first</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">server_nonce</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_xor</span><span class="s4">(</span><span class="s1">bytes1</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">bytes2</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">bytes</span><span class="s4">([</span><span class="s1">b1 </span><span class="s4">^ </span><span class="s1">b2 </span><span class="s3">for </span><span class="s1">b1</span><span class="s4">, </span><span class="s1">b2 </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">bytes1</span><span class="s4">, </span><span class="s1">bytes2</span><span class="s4">)])</span>

    <span class="s3">def </span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">password</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">salt</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s1">digest_maker </span><span class="s4">= </span><span class="s1">hmac</span><span class="s4">.</span><span class="s1">new</span><span class="s4">(</span><span class="s1">password</span><span class="s4">, </span><span class="s1">salt</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">def_digest_mode</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">digest_maker</span><span class="s4">.</span><span class="s1">digest</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_hi</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">password</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">salt</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">count</span><span class="s4">: </span><span class="s1">int</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Prepares Hi 
        Hi(password, salt, iterations) where Hi(p,s,i) is defined as 
        PBKDF2 (HMAC, p, s, i, output length of H). 
        &quot;&quot;&quot;</span>
        <span class="s1">pw </span><span class="s4">= </span><span class="s1">password</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">()</span>
        <span class="s1">hi </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">pw</span><span class="s4">, </span><span class="s1">salt </span><span class="s4">+ </span><span class="s7">b&quot;</span><span class="s3">\x00\x00\x00\x01</span><span class="s7">&quot;</span><span class="s4">)</span>
        <span class="s1">aux </span><span class="s4">= </span><span class="s1">hi</span>
        <span class="s3">for </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">count </span><span class="s4">- </span><span class="s6">1</span><span class="s4">):</span>
            <span class="s1">aux </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">pw</span><span class="s4">, </span><span class="s1">aux</span><span class="s4">)</span>
            <span class="s1">hi </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_xor</span><span class="s4">(</span><span class="s1">hi</span><span class="s4">, </span><span class="s1">aux</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">hi</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_normalize</span><span class="s4">(</span><span class="s1">string</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s1">norm_str </span><span class="s4">= </span><span class="s1">norm_ustr</span><span class="s4">(</span><span class="s1">string</span><span class="s4">)</span>
        <span class="s1">broken_rule </span><span class="s4">= </span><span class="s1">valid_norm</span><span class="s4">(</span><span class="s1">norm_str</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">broken_rule </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;broken_rule: </span><span class="s3">{</span><span class="s1">broken_rule</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">norm_str</span>

    <span class="s3">def </span><span class="s1">_first_message</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;This method generates the first message to the server to start the 
 
        The client-first message consists of a gs2-header, 
        the desired username, and a randomly generated client nonce cnonce. 
 
        The first message from the server has the form: 
            b'n,a=&lt;user_name&gt;,n=&lt;user_name&gt;,r=&lt;client_nonce&gt; 
 
        Returns client's first message 
        &quot;&quot;&quot;</span>
        <span class="s1">cfm_fprnat </span><span class="s4">= </span><span class="s5">&quot;n,a={user_name},n={user_name},r={client_nonce}&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">client_nonce </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">uuid4</span><span class="s4">()).</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;-&quot;</span><span class="s4">, </span><span class="s5">&quot;&quot;</span><span class="s4">)</span>
        <span class="s1">cfm</span><span class="s4">: </span><span class="s1">StrOrBytes </span><span class="s4">= </span><span class="s1">cfm_fprnat</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span>
            <span class="s1">user_name</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_normalize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s4">),</span>
            <span class="s1">client_nonce</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">client_nonce</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">cfm</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">cfm </span><span class="s4">= </span><span class="s1">cfm</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf8&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">cfm</span>

    <span class="s3">def </span><span class="s1">_first_message_krb</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Get a TGT Authentication request and initiates security context. 
 
        This method will contact the Kerberos KDC in order of obtain a TGT. 
        &quot;&quot;&quot;</span>
        <span class="s1">user_name </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">names</span><span class="s4">.</span><span class="s1">import_name</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf8&quot;</span><span class="s4">), </span><span class="s1">name_type</span><span class="s4">=</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">NameType</span><span class="s4">.</span><span class="s1">user</span>
        <span class="s4">)</span>

        <span class="s0"># Use defaults store = {'ccache': 'FILE:/tmp/krb5cc_1000'}#,</span>
        <span class="s0">#                       'keytab':'/etc/some.keytab' }</span>
        <span class="s0"># Attempt to retrieve credential from default cache file.</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">cred</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Credentials</span><span class="s4">()</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
                <span class="s5">&quot;# Stored credentials found, if password was given it will be ignored.&quot;</span>
            <span class="s4">)</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s0"># validate credentials has not expired.</span>
                <span class="s1">cred</span><span class="s4">.</span><span class="s1">lifetime</span>
            <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">exceptions</span><span class="s4">.</span><span class="s1">ExpiredCredentialsError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s5">&quot; Credentials has expired: %s&quot;</span><span class="s4">, </span><span class="s1">err</span><span class="s4">)</span>
                <span class="s1">cred</span><span class="s4">.</span><span class="s1">acquire</span><span class="s4">(</span><span class="s1">user_name</span><span class="s4">)</span>
                <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Credentials has expired: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                    <span class="s5">f&quot;Unable to retrieve stored credentials error: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Attempt to retrieve credentials with given password&quot;</span><span class="s4">)</span>
                <span class="s1">acquire_cred_result </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">acquire_cred_with_password</span><span class="s4">(</span>
                    <span class="s1">user_name</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf8&quot;</span><span class="s4">),</span>
                    <span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;initiate&quot;</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s1">cred </span><span class="s4">= </span><span class="s1">acquire_cred_result</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError </span><span class="s3">as </span><span class="s1">err2</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                    <span class="s5">f&quot;Unable to retrieve credentials with the given password: </span><span class="s3">{</span><span class="s1">err2</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">flags_l </span><span class="s4">= (</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">RequirementFlag</span><span class="s4">.</span><span class="s1">mutual_authentication</span><span class="s4">,</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">RequirementFlag</span><span class="s4">.</span><span class="s1">extended_error</span><span class="s4">,</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">RequirementFlag</span><span class="s4">.</span><span class="s1">delegate_to_peer</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">krb_service_principal</span><span class="s4">:</span>
            <span class="s1">service_principal </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">krb_service_principal</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">service_principal </span><span class="s4">= </span><span class="s5">&quot;ldap/ldapauth&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# service principal: %s&quot;</span><span class="s4">, </span><span class="s1">service_principal</span><span class="s4">)</span>
        <span class="s1">servk </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">(</span>
            <span class="s1">service_principal</span><span class="s4">, </span><span class="s1">name_type</span><span class="s4">=</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">NameType</span><span class="s4">.</span><span class="s1">kerberos_principal</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">target_name </span><span class="s4">= </span><span class="s1">servk</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ctx </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">SecurityContext</span><span class="s4">(</span>
            <span class="s1">name</span><span class="s4">=</span><span class="s1">servk</span><span class="s4">, </span><span class="s1">creds</span><span class="s4">=</span><span class="s1">cred</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">=</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">flags_l</span><span class="s4">), </span><span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;initiate&quot;</span>
        <span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s0"># step() returns bytes | None, see documentation,</span>
            <span class="s0"># so this method could return a NULL payload.</span>
            <span class="s0"># ref: https://pythongssapi.github.io/&lt;suffix&gt;</span>
            <span class="s0"># suffix: python-gssapi/latest/gssapi.html#gssapi.sec_contexts.SecurityContext</span>
            <span class="s1">initial_client_token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">step</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Unable to initiate security context: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# initial client token: %s&quot;</span><span class="s4">, </span><span class="s1">initial_client_token</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">initial_client_token</span>

    <span class="s3">def </span><span class="s1">auth_continue_krb</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">], </span><span class="s1">bool</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Continue with the Kerberos TGT service request. 
 
        With the TGT authentication service given response generate a TGT 
        service request. This method must be invoked sequentially (in a loop) 
        until the security context is completed and an empty response needs to 
        be send to acknowledge the server. 
 
        Args: 
            tgt_auth_challenge the challenge for the negotiation. 
 
        Returns: tuple (bytearray TGS service request, 
                        bool True if context is completed otherwise False). 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;tgt_auth challenge: %s&quot;</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">)</span>

        <span class="s1">resp </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">step</span><span class="s4">(</span><span class="s1">tgt_auth_challenge</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# context step response: %s&quot;</span><span class="s4">, </span><span class="s1">resp</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# context completed?: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">complete</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">resp</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">complete</span>

    <span class="s3">def </span><span class="s1">auth_accept_close_handshake</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">message</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Accept handshake and generate closing handshake message for server. 
 
        This method verifies the server authenticity from the given message 
        and included signature and generates the closing handshake for the 
        server. 
 
        When this method is invoked the security context is already established 
        and the client and server can send GSSAPI formated secure messages. 
 
        To finish the authentication handshake the server sends a message 
        with the security layer availability and the maximum buffer size. 
 
        Since the connector only uses the GSSAPI authentication mechanism to 
        authenticate the user with the server, the server will verify clients 
        message signature and terminate the GSSAPI authentication and send two 
        messages; an authentication acceptance b'\x01\x00\x00\x08\x01' and a 
        OK packet (that must be received after sent the returned message from 
        this method). 
 
        Args: 
            message a wrapped hssapi message from the server. 
 
        Returns: bytearray closing handshake message to be send to the server. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">complete</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s5">&quot;Security context is not completed.&quot;</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# servers message: %s&quot;</span><span class="s4">, </span><span class="s1">message</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# GSSAPI flags in use: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">actual_flags</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">unwraped </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">unwrap</span><span class="s4">(</span><span class="s1">message</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# unwraped: %s&quot;</span><span class="s4">, </span><span class="s1">unwraped</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">exceptions</span><span class="s4">.</span><span class="s1">BadMICError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Unable to unwrap server message: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# unwrapped server message: %s&quot;</span><span class="s4">, </span><span class="s1">unwraped</span><span class="s4">)</span>
        <span class="s0"># The message contents for the clients closing message:</span>
        <span class="s0">#   - security level 1 byte, must be always 1.</span>
        <span class="s0">#   - conciliated buffer size 3 bytes, without importance as no</span>
        <span class="s0">#     further GSSAPI messages will be sends.</span>
        <span class="s1">response </span><span class="s4">= </span><span class="s1">bytearray</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\x01\x00\x00\00</span><span class="s7">&quot;</span><span class="s4">)</span>
        <span class="s0"># Closing handshake must not be encrypted.</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# message response: %s&quot;</span><span class="s4">, </span><span class="s1">response</span><span class="s4">)</span>
        <span class="s1">wraped </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">response</span><span class="s4">, </span><span class="s1">encrypt</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
            <span class="s5">&quot;# wrapped message response: %s, length: %d&quot;</span><span class="s4">,</span>
            <span class="s1">wraped</span><span class="s4">[</span><span class="s6">0</span><span class="s4">],</span>
            <span class="s1">len</span><span class="s4">(</span><span class="s1">wraped</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]),</span>
        <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">wraped</span><span class="s4">.</span><span class="s1">message</span>

    <span class="s3">def </span><span class="s1">auth_response</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">auth_data</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
        <span class="s4">**</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;This method will prepare the fist message to the server. 
 
        Returns bytes to send to the server as the first message. 
        &quot;&quot;&quot;</span>
        <span class="s0"># pylint: disable=attribute-defined-outside-init</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_auth_data </span><span class="s4">= </span><span class="s1">auth_data</span>

        <span class="s1">auth_mechanism </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_auth_data</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;read_method_name_from_server: %s&quot;</span><span class="s4">, </span><span class="s1">auth_mechanism</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">auth_mechanism </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sasl_mechanisms</span><span class="s4">:</span>
            <span class="s1">auth_mechanisms </span><span class="s4">= </span><span class="s5">'&quot;, &quot;'</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">sasl_mechanisms</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">])</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">f'The sasl authentication method &quot;</span><span class="s3">{</span><span class="s1">auth_mechanism</span><span class="s3">}</span><span class="s5">&quot; requested '</span>
                <span class="s5">f'from the server is not supported. Only &quot;</span><span class="s3">{</span><span class="s1">auth_mechanisms</span><span class="s3">}</span><span class="s5">&quot; '</span>
                <span class="s5">f'and &quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">sasl_mechanisms</span><span class="s4">[-</span><span class="s6">1</span><span class="s4">]</span><span class="s3">}</span><span class="s5">&quot; are supported'</span>
            <span class="s4">)</span>

        <span class="s3">if </span><span class="s7">b&quot;GSSAPI&quot; </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_auth_data</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_first_message_krb</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_auth_data </span><span class="s4">== </span><span class="s7">b&quot;SCRAM-SHA-256&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">def_digest_mode </span><span class="s4">= </span><span class="s1">sha256</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_first_message</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_second_message</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;This method generates the second message to the server 
 
        Second message consist on the concatenation of the client and the 
        server nonce, and cproof. 
 
        c=&lt;n,a=&lt;user_name&gt;&gt;,r=&lt;server_nonce&gt;,p=&lt;client_proof&gt; 
        where: 
            &lt;client_proof&gt;: xor(&lt;client_key&gt;, &lt;client_signature&gt;) 
 
            &lt;client_key&gt;: hmac(salted_password, b&quot;Client Key&quot;) 
            &lt;client_signature&gt;: hmac(&lt;stored_key&gt;, &lt;auth_msg&gt;) 
            &lt;stored_key&gt;: h(&lt;client_key&gt;) 
            &lt;auth_msg&gt;: &lt;client_first_no_header&gt;,&lt;servers_first&gt;, 
                        c=&lt;client_header&gt;,r=&lt;server_nonce&gt; 
            &lt;client_first_no_header&gt;: n=&lt;username&gt;r=&lt;client_nonce&gt; 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_auth_data</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">&quot;Missing authentication data (seed)&quot;</span><span class="s4">)</span>

        <span class="s1">passw </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_normalize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">)</span>
        <span class="s1">salted_password </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hi</span><span class="s4">(</span><span class="s1">passw</span><span class="s4">, </span><span class="s1">b64decode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_salt</span><span class="s4">), </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterations</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;salted_password: %s&quot;</span><span class="s4">, </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">salted_password</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">())</span>

        <span class="s1">client_key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">salted_password</span><span class="s4">, </span><span class="s7">b&quot;Client Key&quot;</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;client_key: %s&quot;</span><span class="s4">, </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">client_key</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">())</span>

        <span class="s1">stored_key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">def_digest_mode</span><span class="s4">(</span><span class="s1">client_key</span><span class="s4">).</span><span class="s1">digest</span><span class="s4">()</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;stored_key: %s&quot;</span><span class="s4">, </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">stored_key</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">())</span>

        <span class="s1">server_key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">salted_password</span><span class="s4">, </span><span class="s7">b&quot;Server Key&quot;</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;server_key: %s&quot;</span><span class="s4">, </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">server_key</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">())</span>

        <span class="s1">client_first_no_header </span><span class="s4">= </span><span class="s5">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
            <span class="s4">[</span>
                <span class="s5">f&quot;n=</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_normalize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
                <span class="s5">f&quot;r=</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">client_nonce</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
            <span class="s4">]</span>
        <span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;client_first_no_header: %s&quot;</span><span class="s4">, </span><span class="s1">client_first_no_header</span><span class="s4">)</span>

        <span class="s1">client_header </span><span class="s4">= </span><span class="s1">b64encode</span><span class="s4">(</span>
            <span class="s5">f&quot;n,a=</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_normalize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s4">)</span><span class="s3">}</span><span class="s5">,&quot;</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">()</span>
        <span class="s4">).</span><span class="s1">decode</span><span class="s4">()</span>

        <span class="s1">auth_msg </span><span class="s4">= </span><span class="s5">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
            <span class="s4">[</span>
                <span class="s1">client_first_no_header</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">servers_first</span><span class="s4">,</span>
                <span class="s5">f&quot;c=</span><span class="s3">{</span><span class="s1">client_header</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
                <span class="s5">f&quot;r=</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_nonce</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
            <span class="s4">]</span>
        <span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;auth_msg: %s&quot;</span><span class="s4">, </span><span class="s1">auth_msg</span><span class="s4">)</span>

        <span class="s1">client_signature </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">stored_key</span><span class="s4">, </span><span class="s1">auth_msg</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">())</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;client_signature: %s&quot;</span><span class="s4">, </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">client_signature</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">())</span>

        <span class="s1">client_proof </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_xor</span><span class="s4">(</span><span class="s1">client_key</span><span class="s4">, </span><span class="s1">client_signature</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;client_proof: %s&quot;</span><span class="s4">, </span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">client_proof</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">())</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">server_auth_var </span><span class="s4">= </span><span class="s1">b64encode</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_hmac</span><span class="s4">(</span><span class="s1">server_key</span><span class="s4">, </span><span class="s1">auth_msg</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">())</span>
        <span class="s4">).</span><span class="s1">decode</span><span class="s4">()</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;server_auth_var: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_auth_var</span><span class="s4">)</span>

        <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
            <span class="s4">[</span>
                <span class="s5">f&quot;c=</span><span class="s3">{</span><span class="s1">client_header</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
                <span class="s5">f&quot;r=</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_nonce</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
                <span class="s5">f&quot;p=</span><span class="s3">{</span><span class="s1">b64encode</span><span class="s4">(</span><span class="s1">client_proof</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">()</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">,</span>
            <span class="s4">]</span>
        <span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;second_message: %s&quot;</span><span class="s4">, </span><span class="s1">msg</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">msg</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_validate_first_reponse</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">servers_first</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Validates first message from the server. 
 
        Extracts the server's salt and iterations from the servers 1st response. 
        First message from the server is in the form: 
            &lt;server_salt&gt;,i=&lt;iterations&gt; 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">servers_first </span><span class="s3">or not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">servers_first</span><span class="s4">, (</span><span class="s1">bytearray</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">)):</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Unexpected server message: </span><span class="s3">{</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">servers_first</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">servers_first_str </span><span class="s4">= </span><span class="s1">servers_first</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">servers_first </span><span class="s4">= </span><span class="s1">servers_first_str</span>
            <span class="s1">r_server_nonce</span><span class="s4">, </span><span class="s1">s_salt</span><span class="s4">, </span><span class="s1">i_counter </span><span class="s4">= </span><span class="s1">servers_first_str</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;,&quot;</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">ValueError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">f&quot;Unexpected server message: </span><span class="s3">{</span><span class="s1">servers_first_str</span><span class="s3">}</span><span class="s5">&quot;</span>
            <span class="s4">) </span><span class="s3">from None</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s3">not </span><span class="s1">r_server_nonce</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;r=&quot;</span><span class="s4">)</span>
            <span class="s3">or not </span><span class="s1">s_salt</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;s=&quot;</span><span class="s4">)</span>
            <span class="s3">or not </span><span class="s1">i_counter</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s5">&quot;i=&quot;</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">f&quot;Incomplete reponse from the server: </span><span class="s3">{</span><span class="s1">servers_first_str</span><span class="s3">}</span><span class="s5">&quot;</span>
            <span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">client_nonce </span><span class="s3">in </span><span class="s1">r_server_nonce</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">server_nonce </span><span class="s4">= </span><span class="s1">r_server_nonce</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:]</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;server_nonce: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_nonce</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">&quot;Unable to authenticate response: response not well formed &quot;</span>
                <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">servers_first_str</span><span class="s3">}</span><span class="s5">&quot;</span>
            <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">server_salt </span><span class="s4">= </span><span class="s1">s_salt</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:]</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
            <span class="s5">&quot;server_salt: %s length: %s&quot;</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">server_salt</span><span class="s4">,</span>
            <span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_salt</span><span class="s4">),</span>
        <span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">i_counter </span><span class="s4">= </span><span class="s1">i_counter</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:]</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;iterations: %s&quot;</span><span class="s4">, </span><span class="s1">i_counter</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">iterations </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">i_counter</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">f&quot;Unable to authenticate: iterations not found </span><span class="s3">{</span><span class="s1">servers_first_str</span><span class="s3">}</span><span class="s5">&quot;</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

    <span class="s3">def </span><span class="s1">auth_continue</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">servers_first_response</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;return the second message from the client. 
 
        Returns bytes to send to the server as the second message. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_validate_first_reponse</span><span class="s4">(</span><span class="s1">servers_first_response</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_second_message</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_validate_second_reponse</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">servers_second</span><span class="s4">: </span><span class="s1">bytearray</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Validates second message from the server. 
 
        The client and the server prove to each other they have the same Auth 
        variable. 
 
        The second message from the server consist of the server's proof: 
            server_proof = HMAC(&lt;server_key&gt;, &lt;auth_msg&gt;) 
            where: 
                &lt;server_key&gt;: hmac(&lt;salted_password&gt;, b&quot;Server Key&quot;) 
                &lt;auth_msg&gt;: &lt;client_first_no_header&gt;,&lt;servers_first&gt;, 
                            c=&lt;client_header&gt;,r=&lt;server_nonce&gt; 
 
        Our server_proof must be equal to the Auth variable send on this second 
        response. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s3">not </span><span class="s1">servers_second</span>
            <span class="s3">or not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">servers_second</span><span class="s4">, </span><span class="s1">bytearray</span><span class="s4">)</span>
            <span class="s3">or </span><span class="s1">len</span><span class="s4">(</span><span class="s1">servers_second</span><span class="s4">) &lt;= </span><span class="s6">2</span>
            <span class="s3">or not </span><span class="s1">servers_second</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s7">b&quot;v=&quot;</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">&quot;The server's proof is not well formated&quot;</span><span class="s4">)</span>
        <span class="s1">server_var </span><span class="s4">= </span><span class="s1">servers_second</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:].</span><span class="s1">decode</span><span class="s4">()</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;server auth variable: %s&quot;</span><span class="s4">, </span><span class="s1">server_var</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">server_auth_var </span><span class="s4">== </span><span class="s1">server_var</span>

    <span class="s3">def </span><span class="s1">auth_finalize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">servers_second_response</span><span class="s4">: </span><span class="s1">bytearray</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;finalize the authentication process. 
 
        Raises InterfaceError if the ervers_second_response is invalid. 
 
        Returns True in successful authentication False otherwise. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_validate_second_reponse</span><span class="s4">(</span><span class="s1">servers_second_response</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">&quot;Authentication failed: Unable to proof server identity&quot;</span>
            <span class="s4">)</span>
        <span class="s3">return True</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Plugin official name.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s5">&quot;authentication_ldap_sasl_client&quot;</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">requires_ssl</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Signals whether or not SSL is required.&quot;&quot;&quot;</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">auth_switch_response</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">sock</span><span class="s4">: </span><span class="s5">&quot;MySQLSocket&quot;</span><span class="s4">, </span><span class="s1">auth_data</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span>
    <span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handles server's `auth switch request` response. 
 
        Args: 
            sock: Pointer to the socket connection. 
            auth_data: Plugin provided data (extracted from a packet 
                       representing an `auth switch request` response). 
            kwargs: Custom configuration to be passed to the auth plugin 
                    when invoked. The parameters defined here will override the ones 
                    defined in the auth plugin itself. 
 
        Returns: 
            packet: Last server's response after back-and-forth 
                    communication. 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# auth_data: %s&quot;</span><span class="s4">, </span><span class="s1">auth_data</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">krb_service_principal </span><span class="s4">= </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;krb_service_principal&quot;</span><span class="s4">)</span>

        <span class="s1">response </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_response</span><span class="s4">(</span><span class="s1">auth_data</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">response </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">&quot;Got a NULL auth response&quot;</span><span class="s4">)</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# request: %s size: %s&quot;</span><span class="s4">, </span><span class="s1">response</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">response</span><span class="s4">))</span>
        <span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">response</span><span class="s4">)</span>

        <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# server response packet: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">) &gt;= </span><span class="s6">6 </span><span class="s3">and </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">5</span><span class="s4">] == </span><span class="s6">114 </span><span class="s3">and </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">6</span><span class="s4">] == </span><span class="s6">61</span><span class="s4">:  </span><span class="s0"># 'r' and '='</span>
            <span class="s0"># Continue with sasl authentication</span>
            <span class="s1">dec_response </span><span class="s4">= </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">5</span><span class="s4">:]</span>
            <span class="s1">cresponse </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_continue</span><span class="s4">(</span><span class="s1">dec_response</span><span class="s4">)</span>
            <span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">cresponse</span><span class="s4">)</span>
            <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">5</span><span class="s4">] == </span><span class="s6">118 </span><span class="s3">and </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">6</span><span class="s4">] == </span><span class="s6">61</span><span class="s4">:  </span><span class="s0"># 'v' and '='</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_finalize</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">[</span><span class="s6">5</span><span class="s4">:]):</span>
                    <span class="s0"># receive packed OK</span>
                    <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
        <span class="s3">elif </span><span class="s1">auth_data </span><span class="s4">== </span><span class="s7">b&quot;GSSAPI&quot; </span><span class="s3">and </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">4</span><span class="s4">] != </span><span class="s1">ERR_STATUS</span><span class="s4">:</span>
            <span class="s1">rcode_size </span><span class="s4">= </span><span class="s6">5  </span><span class="s0"># header size for the response status code.</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Continue with sasl GSSAPI authentication&quot;</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# response header: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[: </span><span class="s1">rcode_size </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">])</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# response size: %s&quot;</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">))</span>

            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Negotiate a service request&quot;</span><span class="s4">)</span>
            <span class="s1">complete </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s1">tries </span><span class="s4">= </span><span class="s6">0  </span><span class="s0"># To avoid a infinite loop attempt no more than feedback messages</span>
            <span class="s3">while not </span><span class="s1">complete </span><span class="s3">and </span><span class="s1">tries </span><span class="s4">&lt; </span><span class="s6">5</span><span class="s4">:</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;%s Attempt %s %s&quot;</span><span class="s4">, </span><span class="s5">&quot;-&quot; </span><span class="s4">* </span><span class="s6">20</span><span class="s4">, </span><span class="s1">tries </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">, </span><span class="s5">&quot;-&quot; </span><span class="s4">* </span><span class="s6">20</span><span class="s4">)</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;&lt;&lt; server response: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# response code: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[: </span><span class="s1">rcode_size </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">])</span>
                <span class="s1">step</span><span class="s4">, </span><span class="s1">complete </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_continue_krb</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">[</span><span class="s1">rcode_size</span><span class="s4">:])</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot; &gt;&gt; response to server: %s&quot;</span><span class="s4">, </span><span class="s1">step</span><span class="s4">)</span>
                <span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">step </span><span class="s3">or </span><span class="s7">b&quot;&quot;</span><span class="s4">)</span>
                <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
                <span class="s1">tries </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">if not </span><span class="s1">complete</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                    <span class="s5">f&quot;Unable to fulfill server request after </span><span class="s3">{</span><span class="s1">tries</span><span class="s3">} </span><span class="s5">&quot;</span>
                    <span class="s5">f&quot;attempts. Last server response: </span><span class="s3">{</span><span class="s1">packet</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
                <span class="s5">&quot; last GSSAPI response from server: %s length: %d&quot;</span><span class="s4">,</span>
                <span class="s1">packet</span><span class="s4">,</span>
                <span class="s1">len</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">),</span>
            <span class="s4">)</span>
            <span class="s1">last_step </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_accept_close_handshake</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">[</span><span class="s1">rcode_size</span><span class="s4">:])</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
                <span class="s5">&quot; &gt;&gt; last response to server: %s length: %d&quot;</span><span class="s4">,</span>
                <span class="s1">last_step</span><span class="s4">,</span>
                <span class="s1">len</span><span class="s4">(</span><span class="s1">last_step</span><span class="s4">),</span>
            <span class="s4">)</span>
            <span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">last_step</span><span class="s4">)</span>
            <span class="s0"># Receive final handshake from server</span>
            <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;&lt;&lt; final handshake from server: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>

            <span class="s0"># receive OK packet from server.</span>
            <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;&lt;&lt; ok packet from server: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">bytes</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">)</span>


<span class="s0"># pylint: enable=c-extension-no-member,no-member</span>
</pre>
</body>
</html>