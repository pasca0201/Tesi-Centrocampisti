<html>
<head>
<title>test_pairwise_distances_reduction.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pairwise_distances_reduction.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">spatial</span><span class="s2">.</span><span class="s1">distance </span><span class="s0">import </span><span class="s1">cdist</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics </span><span class="s0">import </span><span class="s1">euclidean_distances</span><span class="s2">, </span><span class="s1">pairwise_distances</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">metrics</span><span class="s2">.</span><span class="s1">_pairwise_distances_reduction </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ArgKmin</span><span class="s2">,</span>
    <span class="s1">ArgKminClassMode</span><span class="s2">,</span>
    <span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">,</span>
    <span class="s1">RadiusNeighbors</span><span class="s2">,</span>
    <span class="s1">RadiusNeighborsClassMode</span><span class="s2">,</span>
    <span class="s1">sqeuclidean_row_norms</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">create_memmap_backed_data</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSR_CONTAINERS</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">parallel </span><span class="s0">import </span><span class="s1">_get_threadpool_controller</span>

<span class="s3"># Common supported metric between scipy.spatial.distance.cdist</span>
<span class="s3"># and BaseDistanceReductionDispatcher.</span>
<span class="s3"># This allows constructing tests to check consistency of results</span>
<span class="s3"># of concrete BaseDistanceReductionDispatcher on some metrics using APIs</span>
<span class="s3"># from scipy and numpy.</span>
<span class="s1">CDIST_PAIRWISE_DISTANCES_REDUCTION_COMMON_METRICS </span><span class="s2">= [</span>
    <span class="s4">&quot;braycurtis&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;canberra&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;chebyshev&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;cityblock&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;euclidean&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;minkowski&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;seuclidean&quot;</span><span class="s2">,</span>
<span class="s2">]</span>


<span class="s0">def </span><span class="s1">_get_metric_params_list</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">: </span><span class="s1">int</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">1</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Return list of dummy DistanceMetric kwargs for tests.&quot;&quot;&quot;</span>

    <span class="s3"># Distinguishing on cases not to compute unneeded datastructures.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;minkowski&quot;</span><span class="s2">:</span>
        <span class="s1">minkowski_kwargs </span><span class="s2">= [</span>
            <span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s5">1.5</span><span class="s2">),</span>
            <span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
            <span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s5">3</span><span class="s2">),</span>
            <span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),</span>
            <span class="s1">dict</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">w</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">)),</span>
        <span class="s2">]</span>

        <span class="s0">return </span><span class="s1">minkowski_kwargs</span>

    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;seuclidean&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">V</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">))]</span>

    <span class="s3"># Case of: &quot;euclidean&quot;, &quot;manhattan&quot;, &quot;chebyshev&quot;, &quot;haversine&quot; or any other metric.</span>
    <span class="s3"># In those cases, no kwargs is needed.</span>
    <span class="s0">return </span><span class="s2">[{}]</span>


<span class="s0">def </span><span class="s1">assert_same_distances_for_common_neighbors</span><span class="s2">(</span>
    <span class="s1">query_idx</span><span class="s2">,</span>
    <span class="s1">dist_row_a</span><span class="s2">,</span>
    <span class="s1">dist_row_b</span><span class="s2">,</span>
    <span class="s1">indices_row_a</span><span class="s2">,</span>
    <span class="s1">indices_row_b</span><span class="s2">,</span>
    <span class="s1">rtol</span><span class="s2">,</span>
    <span class="s1">atol</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the distances of common neighbors are equal up to tolerance. 
 
    This does not check if there are missing neighbors in either result set. 
    Missingness is handled by assert_no_missing_neighbors. 
    &quot;&quot;&quot;</span>
    <span class="s3"># Compute a mapping from indices to distances for each result set and</span>
    <span class="s3"># check that the computed neighbors with matching indices are within</span>
    <span class="s3"># the expected distance tolerance.</span>
    <span class="s1">indices_to_dist_a </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">indices_row_a</span><span class="s2">, </span><span class="s1">dist_row_a</span><span class="s2">))</span>
    <span class="s1">indices_to_dist_b </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">indices_row_b</span><span class="s2">, </span><span class="s1">dist_row_b</span><span class="s2">))</span>

    <span class="s1">common_indices </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">indices_row_a</span><span class="s2">).</span><span class="s1">intersection</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">indices_row_b</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">common_indices</span><span class="s2">:</span>
        <span class="s1">dist_a </span><span class="s2">= </span><span class="s1">indices_to_dist_a</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
        <span class="s1">dist_b </span><span class="s2">= </span><span class="s1">indices_to_dist_b</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dist_a</span><span class="s2">, </span><span class="s1">dist_b</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AssertionError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s3"># Wrap exception to provide more context while also including</span>
            <span class="s3"># the original exception with the computed absolute and</span>
            <span class="s3"># relative differences.</span>
            <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
                <span class="s4">f&quot;Query vector with index </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">} </span><span class="s4">lead to different distances&quot;</span>
                <span class="s4">f&quot; for common neighbor with index </span><span class="s0">{</span><span class="s1">idx</span><span class="s0">}</span><span class="s4">:&quot;</span>
                <span class="s4">f&quot; dist_a=</span><span class="s0">{</span><span class="s1">dist_a</span><span class="s0">} </span><span class="s4">vs dist_b=</span><span class="s0">{</span><span class="s1">dist_b</span><span class="s0">} </span><span class="s4">(with atol=</span><span class="s0">{</span><span class="s1">atol</span><span class="s0">} </span><span class="s4">and&quot;</span>
                <span class="s4">f&quot; rtol=</span><span class="s0">{</span><span class="s1">rtol</span><span class="s0">}</span><span class="s4">)&quot;</span>
            <span class="s2">) </span><span class="s0">from </span><span class="s1">e</span>


<span class="s0">def </span><span class="s1">assert_no_missing_neighbors</span><span class="s2">(</span>
    <span class="s1">query_idx</span><span class="s2">,</span>
    <span class="s1">dist_row_a</span><span class="s2">,</span>
    <span class="s1">dist_row_b</span><span class="s2">,</span>
    <span class="s1">indices_row_a</span><span class="s2">,</span>
    <span class="s1">indices_row_b</span><span class="s2">,</span>
    <span class="s1">threshold</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Compare the indices of neighbors in two results sets. 
 
    Any neighbor index with a distance below the precision threshold should 
    match one in the other result set. We ignore the last few neighbors beyond 
    the threshold as those can typically be missing due to rounding errors. 
 
    For radius queries, the threshold is just the radius minus the expected 
    precision level. 
 
    For k-NN queries, it is the maximum distance to the k-th neighbor minus the 
    expected precision level. 
    &quot;&quot;&quot;</span>
    <span class="s1">mask_a </span><span class="s2">= </span><span class="s1">dist_row_a </span><span class="s2">&lt; </span><span class="s1">threshold</span>
    <span class="s1">mask_b </span><span class="s2">= </span><span class="s1">dist_row_b </span><span class="s2">&lt; </span><span class="s1">threshold</span>
    <span class="s1">missing_from_b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">setdiff1d</span><span class="s2">(</span><span class="s1">indices_row_a</span><span class="s2">[</span><span class="s1">mask_a</span><span class="s2">], </span><span class="s1">indices_row_b</span><span class="s2">)</span>
    <span class="s1">missing_from_a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">setdiff1d</span><span class="s2">(</span><span class="s1">indices_row_b</span><span class="s2">[</span><span class="s1">mask_b</span><span class="s2">], </span><span class="s1">indices_row_a</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">missing_from_a</span><span class="s2">) &gt; </span><span class="s5">0 </span><span class="s0">or </span><span class="s1">len</span><span class="s2">(</span><span class="s1">missing_from_b</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
            <span class="s4">f&quot;Query vector with index </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">} </span><span class="s4">lead to mismatched result indices:</span><span class="s0">\n</span><span class="s4">&quot;</span>
            <span class="s4">f&quot;neighbors in b missing from a: </span><span class="s0">{</span><span class="s1">missing_from_a</span><span class="s0">}\n</span><span class="s4">&quot;</span>
            <span class="s4">f&quot;neighbors in a missing from b: </span><span class="s0">{</span><span class="s1">missing_from_b</span><span class="s0">}\n</span><span class="s4">&quot;</span>
            <span class="s4">f&quot;dist_row_a=</span><span class="s0">{</span><span class="s1">dist_row_a</span><span class="s0">}\n</span><span class="s4">&quot;</span>
            <span class="s4">f&quot;dist_row_b=</span><span class="s0">{</span><span class="s1">dist_row_b</span><span class="s0">}\n</span><span class="s4">&quot;</span>
            <span class="s4">f&quot;indices_row_a=</span><span class="s0">{</span><span class="s1">indices_row_a</span><span class="s0">}\n</span><span class="s4">&quot;</span>
            <span class="s4">f&quot;indices_row_b=</span><span class="s0">{</span><span class="s1">indices_row_b</span><span class="s0">}\n</span><span class="s4">&quot;</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
    <span class="s1">neighbors_dists_a</span><span class="s2">,</span>
    <span class="s1">neighbors_dists_b</span><span class="s2">,</span>
    <span class="s1">neighbors_indices_a</span><span class="s2">,</span>
    <span class="s1">neighbors_indices_b</span><span class="s2">,</span>
    <span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-5</span><span class="s2">,</span>
    <span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-6</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Assert that argkmin results are valid up to rounding errors. 
 
    This function asserts that the results of argkmin queries are valid up to: 
    - rounding error tolerance on distance values; 
    - permutations of indices for distances values that differ up to the 
      expected precision level. 
 
    Furthermore, the distances must be sorted. 
 
    To be used for testing neighbors queries on float32 datasets: we accept 
    neighbors rank swaps only if they are caused by small rounding errors on 
    the distance computations. 
    &quot;&quot;&quot;</span>
    <span class="s1">is_sorted </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">] &lt;= </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:])</span>

    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">neighbors_dists_a</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s2">== </span><span class="s1">neighbors_dists_b</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s2">== </span><span class="s1">neighbors_indices_a</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s2">== </span><span class="s1">neighbors_indices_b</span><span class="s2">.</span><span class="s1">shape</span>
    <span class="s2">), </span><span class="s4">&quot;Arrays of results have incompatible shapes.&quot;</span>

    <span class="s1">n_queries</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">neighbors_dists_a</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s3"># Asserting equality results one row at a time</span>
    <span class="s0">for </span><span class="s1">query_idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_queries</span><span class="s2">):</span>
        <span class="s1">dist_row_a </span><span class="s2">= </span><span class="s1">neighbors_dists_a</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>
        <span class="s1">dist_row_b </span><span class="s2">= </span><span class="s1">neighbors_dists_b</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>
        <span class="s1">indices_row_a </span><span class="s2">= </span><span class="s1">neighbors_indices_a</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>
        <span class="s1">indices_row_b </span><span class="s2">= </span><span class="s1">neighbors_indices_b</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">is_sorted</span><span class="s2">(</span><span class="s1">dist_row_a</span><span class="s2">), </span><span class="s4">f&quot;Distances aren't sorted on row </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s0">assert </span><span class="s1">is_sorted</span><span class="s2">(</span><span class="s1">dist_row_b</span><span class="s2">), </span><span class="s4">f&quot;Distances aren't sorted on row </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">}</span><span class="s4">&quot;</span>

        <span class="s1">assert_same_distances_for_common_neighbors</span><span class="s2">(</span>
            <span class="s1">query_idx</span><span class="s2">,</span>
            <span class="s1">dist_row_a</span><span class="s2">,</span>
            <span class="s1">dist_row_b</span><span class="s2">,</span>
            <span class="s1">indices_row_a</span><span class="s2">,</span>
            <span class="s1">indices_row_b</span><span class="s2">,</span>
            <span class="s1">rtol</span><span class="s2">,</span>
            <span class="s1">atol</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s3"># Check that any neighbor with distances below the rounding error</span>
        <span class="s3"># threshold have matching indices. The threshold is the distance to the</span>
        <span class="s3"># k-th neighbors minus the expected precision level:</span>
        <span class="s3">#</span>
        <span class="s3"># (1 - rtol) * dist_k - atol</span>
        <span class="s3">#</span>
        <span class="s3"># Where dist_k is defined as the maximum distance to the kth-neighbor</span>
        <span class="s3"># among the two result sets. This way of defining the threshold is</span>
        <span class="s3"># stricter than taking the minimum of the two.</span>
        <span class="s1">threshold </span><span class="s2">= (</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">rtol</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">maximum</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">dist_row_a</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">dist_row_b</span><span class="s2">)</span>
        <span class="s2">) - </span><span class="s1">atol</span>
        <span class="s1">assert_no_missing_neighbors</span><span class="s2">(</span>
            <span class="s1">query_idx</span><span class="s2">,</span>
            <span class="s1">dist_row_a</span><span class="s2">,</span>
            <span class="s1">dist_row_b</span><span class="s2">,</span>
            <span class="s1">indices_row_a</span><span class="s2">,</span>
            <span class="s1">indices_row_b</span><span class="s2">,</span>
            <span class="s1">threshold</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">_non_trivial_radius</span><span class="s2">(</span>
    <span class="s2">*,</span>
    <span class="s1">X</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">Y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">metric</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">precomputed_dists</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s1">expected_n_neighbors</span><span class="s2">=</span><span class="s5">10</span><span class="s2">,</span>
    <span class="s1">n_subsampled_queries</span><span class="s2">=</span><span class="s5">10</span><span class="s2">,</span>
    <span class="s2">**</span><span class="s1">metric_kwargs</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s3"># Find a non-trivial radius using a small subsample of the pairwise</span>
    <span class="s3"># distances between X and Y: we want to return around expected_n_neighbors</span>
    <span class="s3"># on average. Yielding too many results would make the test slow (because</span>
    <span class="s3"># checking the results is expensive for large result sets), yielding 0 most</span>
    <span class="s3"># of the time would make the test useless.</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">precomputed_dists </span><span class="s0">is not None or </span><span class="s1">metric </span><span class="s0">is not None</span>
    <span class="s2">), </span><span class="s4">&quot;Either metric or precomputed_dists must be provided.&quot;</span>

    <span class="s0">if </span><span class="s1">precomputed_dists </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">X </span><span class="s0">is not None</span>
        <span class="s0">assert </span><span class="s1">Y </span><span class="s0">is not None</span>
        <span class="s1">sampled_dists </span><span class="s2">= </span><span class="s1">pairwise_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, **</span><span class="s1">metric_kwargs</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">sampled_dists </span><span class="s2">= </span><span class="s1">precomputed_dists</span><span class="s2">[:</span><span class="s1">n_subsampled_queries</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">sampled_dists</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">sampled_dists</span><span class="s2">[:, </span><span class="s1">expected_n_neighbors</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
    <span class="s1">neighbors_dists_a</span><span class="s2">,</span>
    <span class="s1">neighbors_dists_b</span><span class="s2">,</span>
    <span class="s1">neighbors_indices_a</span><span class="s2">,</span>
    <span class="s1">neighbors_indices_b</span><span class="s2">,</span>
    <span class="s1">radius</span><span class="s2">,</span>
    <span class="s1">check_sorted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-5</span><span class="s2">,</span>
    <span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-6</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Assert that radius neighborhood results are valid up to: 
 
      - relative and absolute tolerance on computed distance values 
      - permutations of indices for distances values that differ up to 
        a precision level 
      - missing or extra last elements if their distance is 
        close to the radius 
 
    To be used for testing neighbors queries on float32 datasets: we 
    accept neighbors rank swaps only if they are caused by small 
    rounding errors on the distance computations. 
 
    Input arrays must be sorted w.r.t distances. 
    &quot;&quot;&quot;</span>
    <span class="s1">is_sorted </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">] &lt;= </span><span class="s1">a</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:])</span>

    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">len</span><span class="s2">(</span><span class="s1">neighbors_dists_a</span><span class="s2">)</span>
        <span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">neighbors_dists_b</span><span class="s2">)</span>
        <span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">neighbors_indices_a</span><span class="s2">)</span>
        <span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">neighbors_indices_b</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">n_queries </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">neighbors_dists_a</span><span class="s2">)</span>

    <span class="s3"># Asserting equality of results one vector at a time</span>
    <span class="s0">for </span><span class="s1">query_idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_queries</span><span class="s2">):</span>
        <span class="s1">dist_row_a </span><span class="s2">= </span><span class="s1">neighbors_dists_a</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>
        <span class="s1">dist_row_b </span><span class="s2">= </span><span class="s1">neighbors_dists_b</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>
        <span class="s1">indices_row_a </span><span class="s2">= </span><span class="s1">neighbors_indices_a</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>
        <span class="s1">indices_row_b </span><span class="s2">= </span><span class="s1">neighbors_indices_b</span><span class="s2">[</span><span class="s1">query_idx</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">check_sorted</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">is_sorted</span><span class="s2">(</span><span class="s1">dist_row_a</span><span class="s2">), </span><span class="s4">f&quot;Distances aren't sorted on row </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">}</span><span class="s4">&quot;</span>
            <span class="s0">assert </span><span class="s1">is_sorted</span><span class="s2">(</span><span class="s1">dist_row_b</span><span class="s2">), </span><span class="s4">f&quot;Distances aren't sorted on row </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">}</span><span class="s4">&quot;</span>

        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dist_row_a</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">indices_row_a</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dist_row_b</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">indices_row_b</span><span class="s2">)</span>

        <span class="s3"># Check that all distances are within the requested radius</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dist_row_a</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">max_dist_a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">dist_row_a</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">max_dist_a </span><span class="s2">&lt;= </span><span class="s1">radius</span><span class="s2">, (</span>
                <span class="s4">f&quot;Largest returned distance </span><span class="s0">{</span><span class="s1">max_dist_a</span><span class="s0">} </span><span class="s4">not within requested&quot;</span>
                <span class="s4">f&quot; radius </span><span class="s0">{</span><span class="s1">radius</span><span class="s0">} </span><span class="s4">on row </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">}</span><span class="s4">&quot;</span>
            <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">dist_row_b</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">max_dist_b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">dist_row_b</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">max_dist_b </span><span class="s2">&lt;= </span><span class="s1">radius</span><span class="s2">, (</span>
                <span class="s4">f&quot;Largest returned distance </span><span class="s0">{</span><span class="s1">max_dist_b</span><span class="s0">} </span><span class="s4">not within requested&quot;</span>
                <span class="s4">f&quot; radius </span><span class="s0">{</span><span class="s1">radius</span><span class="s0">} </span><span class="s4">on row </span><span class="s0">{</span><span class="s1">query_idx</span><span class="s0">}</span><span class="s4">&quot;</span>
            <span class="s2">)</span>

        <span class="s1">assert_same_distances_for_common_neighbors</span><span class="s2">(</span>
            <span class="s1">query_idx</span><span class="s2">,</span>
            <span class="s1">dist_row_a</span><span class="s2">,</span>
            <span class="s1">dist_row_b</span><span class="s2">,</span>
            <span class="s1">indices_row_a</span><span class="s2">,</span>
            <span class="s1">indices_row_b</span><span class="s2">,</span>
            <span class="s1">rtol</span><span class="s2">,</span>
            <span class="s1">atol</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">threshold </span><span class="s2">= (</span><span class="s5">1 </span><span class="s2">- </span><span class="s1">rtol</span><span class="s2">) * </span><span class="s1">radius </span><span class="s2">- </span><span class="s1">atol</span>
        <span class="s1">assert_no_missing_neighbors</span><span class="s2">(</span>
            <span class="s1">query_idx</span><span class="s2">,</span>
            <span class="s1">dist_row_a</span><span class="s2">,</span>
            <span class="s1">dist_row_b</span><span class="s2">,</span>
            <span class="s1">indices_row_a</span><span class="s2">,</span>
            <span class="s1">indices_row_b</span><span class="s2">,</span>
            <span class="s1">threshold</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s1">FLOAT32_TOLS </span><span class="s2">= {</span>
    <span class="s4">&quot;atol&quot;</span><span class="s2">: </span><span class="s5">1e-7</span><span class="s2">,</span>
    <span class="s4">&quot;rtol&quot;</span><span class="s2">: </span><span class="s5">1e-5</span><span class="s2">,</span>
<span class="s2">}</span>
<span class="s1">FLOAT64_TOLS </span><span class="s2">= {</span>
    <span class="s4">&quot;atol&quot;</span><span class="s2">: </span><span class="s5">1e-9</span><span class="s2">,</span>
    <span class="s4">&quot;rtol&quot;</span><span class="s2">: </span><span class="s5">1e-7</span><span class="s2">,</span>
<span class="s2">}</span>
<span class="s1">ASSERT_RESULT </span><span class="s2">= {</span>
    <span class="s2">(</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">): </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">assert_compatible_argkmin_results</span><span class="s2">, **</span><span class="s1">FLOAT64_TOLS</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">): </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">assert_compatible_argkmin_results</span><span class="s2">, **</span><span class="s1">FLOAT32_TOLS</span><span class="s2">),</span>
    <span class="s2">(</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
    <span class="s2">): </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">assert_compatible_radius_results</span><span class="s2">, **</span><span class="s1">FLOAT64_TOLS</span><span class="s2">),</span>
    <span class="s2">(</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">,</span>
    <span class="s2">): </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">assert_compatible_radius_results</span><span class="s2">, **</span><span class="s1">FLOAT32_TOLS</span><span class="s2">),</span>
<span class="s2">}</span>


<span class="s0">def </span><span class="s1">test_assert_compatible_argkmin_results</span><span class="s2">():</span>
    <span class="s1">atol </span><span class="s2">= </span><span class="s5">1e-7</span>
    <span class="s1">rtol </span><span class="s2">= </span><span class="s5">0.0</span>
    <span class="s1">tols </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s1">eps </span><span class="s2">= </span><span class="s1">atol </span><span class="s2">/ </span><span class="s5">3</span>
    <span class="s1">_1m </span><span class="s2">= </span><span class="s5">1.0 </span><span class="s2">- </span><span class="s1">eps</span>
    <span class="s1">_1p </span><span class="s2">= </span><span class="s5">1.0 </span><span class="s2">+ </span><span class="s1">eps</span>

    <span class="s1">_6_1m </span><span class="s2">= </span><span class="s5">6.1 </span><span class="s2">- </span><span class="s1">eps</span>
    <span class="s1">_6_1p </span><span class="s2">= </span><span class="s5">6.1 </span><span class="s2">+ </span><span class="s1">eps</span>

    <span class="s1">ref_dist </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">_1m</span><span class="s2">, </span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">ref_indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s3"># Sanity check: compare the reference results to themselves.</span>
    <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
        <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">ref_indices</span><span class="s2">, </span><span class="s1">ref_indices</span><span class="s2">, </span><span class="s1">rtol</span>
    <span class="s2">)</span>

    <span class="s3"># Apply valid permutation on indices: the last 3 points are all very close</span>
    <span class="s3"># to one another so we accept any permutation on their rankings.</span>
    <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># The last few indices do not necessarily have to match because of the rounding</span>
    <span class="s3"># errors on the distances: there could be tied results at the boundary.</span>
    <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]]),</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># All points have close distances so any ranking permutation</span>
    <span class="s3"># is valid for this query result.</span>
    <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">7</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">9</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">]]),</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># They could also be nearly truncation of very large nearly tied result</span>
    <span class="s3"># sets hence all indices can also be distinct in this case:</span>
    <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">34</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">24</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">42</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Apply invalid permutation on indices: permuting the ranks of the 2</span>
    <span class="s3"># nearest neighbors is invalid because the distance values are too</span>
    <span class="s3"># different.</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;Query vector with index 0 lead to different distances for common neighbor with&quot;</span>
        <span class="s4">&quot; index 1: dist_a=1.2 vs dist_b=2.5&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># Detect missing indices within the expected precision level, even when the</span>
    <span class="s3"># distances match exactly.</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;neighbors in b missing from a: [12]</span><span class="s0">\n</span><span class="s4">neighbors in a missing from b: [1]&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># Detect missing indices outside the expected precision level.</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;neighbors in b missing from a: []</span><span class="s0">\n</span><span class="s4">neighbors in a missing from b: [3]&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">12</span><span class="s2">]]),</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># Detect missing indices outside the expected precision level, in the other</span>
    <span class="s3"># direction:</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;neighbors in b missing from a: [5]</span><span class="s0">\n</span><span class="s4">neighbors in a missing from b: []&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">12</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]]),</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># Distances aren't properly sorted</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Distances aren't sorted on row 0&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_argkmin_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">1.2</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;check_sorted&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_assert_compatible_radius_results</span><span class="s2">(</span><span class="s1">check_sorted</span><span class="s2">):</span>
    <span class="s1">atol </span><span class="s2">= </span><span class="s5">1e-7</span>
    <span class="s1">rtol </span><span class="s2">= </span><span class="s5">0.0</span>
    <span class="s1">tols </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s1">eps </span><span class="s2">= </span><span class="s1">atol </span><span class="s2">/ </span><span class="s5">3</span>
    <span class="s1">_1m </span><span class="s2">= </span><span class="s5">1.0 </span><span class="s2">- </span><span class="s1">eps</span>
    <span class="s1">_1p </span><span class="s2">= </span><span class="s5">1.0 </span><span class="s2">+ </span><span class="s1">eps</span>
    <span class="s1">_6_1m </span><span class="s2">= </span><span class="s5">6.1 </span><span class="s2">- </span><span class="s1">eps</span>
    <span class="s1">_6_1p </span><span class="s2">= </span><span class="s5">6.1 </span><span class="s2">+ </span><span class="s1">eps</span>

    <span class="s1">ref_dist </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">]),</span>
    <span class="s2">]</span>

    <span class="s1">ref_indices </span><span class="s2">= [</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">]),</span>
    <span class="s2">]</span>

    <span class="s3"># Sanity check: compare the reference results to themselves.</span>
    <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
        <span class="s1">ref_dist</span><span class="s2">,</span>
        <span class="s1">ref_dist</span><span class="s2">,</span>
        <span class="s1">ref_indices</span><span class="s2">,</span>
        <span class="s1">ref_indices</span><span class="s2">,</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s5">7.0</span><span class="s2">,</span>
        <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Apply valid permutation on indices</span>
    <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s5">7.0</span><span class="s2">,</span>
        <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">_1m</span><span class="s2">, </span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">_1m</span><span class="s2">, </span><span class="s1">_1m</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">, </span><span class="s1">_1p</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])]),</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s5">7.0</span><span class="s2">,</span>
        <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Apply invalid permutation on indices</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;Query vector with index 0 lead to different distances for common neighbor with&quot;</span>
        <span class="s4">&quot; index 1: dist_a=1.2 vs dist_b=2.5&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s5">7.0</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># Having extra last or missing elements is valid if they are in the</span>
    <span class="s3"># tolerated rounding error range: [(1 - rtol) * radius - atol, radius]</span>
    <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">])]),</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">_6_1p</span><span class="s2">,</span>
        <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s3"># Any discrepancy outside the tolerated rounding error range is invalid and</span>
    <span class="s3"># indicates a missing neighbor in one of the result sets.</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;Query vector with index 0 lead to mismatched result indices:</span><span class="s0">\n</span><span class="s4">neighbors in b&quot;</span>
        <span class="s4">&quot; missing from a: []</span><span class="s0">\n</span><span class="s4">neighbors in a missing from b: [3]&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])]),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s5">6.1</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;Query vector with index 0 lead to mismatched result indices:</span><span class="s0">\n</span><span class="s4">neighbors in b&quot;</span>
        <span class="s4">&quot; missing from a: [4]</span><span class="s0">\n</span><span class="s4">neighbors in a missing from b: [2]&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.1</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s5">6.1</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># Radius upper bound is strictly checked</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s4">&quot;Largest returned distance 6.100000033333333 not within requested radius 6.1 on&quot;</span>
        <span class="s4">&quot; row 0&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s5">6.1</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s5">6.1</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s1">check_sorted</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">check_sorted</span><span class="s2">:</span>
        <span class="s3"># Distances aren't properly sorted</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Distances aren't sorted on row 0&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">1.2</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
                <span class="s1">radius</span><span class="s2">=</span><span class="s1">_6_1p</span><span class="s2">,</span>
                <span class="s1">check_sorted</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
            <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">assert_compatible_radius_results</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">1.2</span><span class="s2">, </span><span class="s1">_6_1m</span><span class="s2">, </span><span class="s5">6.1</span><span class="s2">, </span><span class="s1">_6_1p</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])]),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">_6_1p</span><span class="s2">,</span>
            <span class="s1">check_sorted</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pairwise_distances_reduction_is_usable_for</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Y_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;manhattan&quot;</span>

    <span class="s3"># Must be usable for all possible pair of {dense, sparse} datasets</span>
    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">), </span><span class="s1">metric</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s1">metric</span>
    <span class="s2">)</span>

    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">), </span><span class="s1">metric</span>
    <span class="s2">)</span>

    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;pyfunc&quot;</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span>
    <span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">metric</span>
    <span class="s2">)</span>

    <span class="s3"># F-ordered arrays are not supported</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;sqeuclidean&quot;</span>
    <span class="s2">)</span>

    <span class="s3"># FIXME: the current Cython implementation is too slow for a large number of</span>
    <span class="s3"># features. We temporarily disable it to fallback on SciPy's implementation.</span>
    <span class="s3"># See: https://github.com/scikit-learn/scikit-learn/issues/28191</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;sqeuclidean&quot;</span>
    <span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span>
        <span class="s1">X_csr</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;euclidean&quot;</span>
    <span class="s2">)</span>

    <span class="s3"># CSR matrices without non-zeros elements aren't currently supported</span>
    <span class="s3"># TODO: support CSR matrices without non-zeros elements</span>
    <span class="s1">X_csr_0_nnz </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X </span><span class="s2">* </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X_csr_0_nnz</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s3"># CSR matrices with int64 indices and indptr (e.g. large nnz, or large n_features)</span>
    <span class="s3"># aren't supported as of now.</span>
    <span class="s3"># See: https://github.com/scikit-learn/scikit-learn/issues/23653</span>
    <span class="s3"># TODO: support CSR matrices with int64 indices and indptr</span>
    <span class="s1">X_csr_int64 </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_csr_int64</span><span class="s2">.</span><span class="s1">indices </span><span class="s2">= </span><span class="s1">X_csr_int64</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">BaseDistancesReductionDispatcher</span><span class="s2">.</span><span class="s1">is_usable_for</span><span class="s2">(</span><span class="s1">X_csr_int64</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_argkmin_factory_method_wrong_usages</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;euclidean&quot;</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float32 and Y.dtype=float64&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float64 and Y.dtype=int32&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;k == -1, must be &gt;= 1.&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;k == 0, must be &gt;= 1.&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unrecognized metric&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;wrong metric&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;Buffer has wrong number of dimensions \(expected 2, got 1\)&quot;</span>
    <span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]), </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;ndarray is not C-contiguous&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s3"># A UserWarning must be raised in this case.</span>
    <span class="s1">unused_metric_kwargs </span><span class="s2">= {</span><span class="s4">&quot;p&quot;</span><span class="s2">: </span><span class="s5">3</span><span class="s2">}</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s4">r&quot;Some metric_kwargs have been passed \({'p': 3}\) but&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">unused_metric_kwargs</span>
        <span class="s2">)</span>

    <span class="s3"># A UserWarning must be raised in this case.</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;p&quot;</span><span class="s2">: </span><span class="s5">3</span><span class="s2">,  </span><span class="s3"># unused</span>
        <span class="s4">&quot;Y_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s4">r&quot;Some metric_kwargs have been passed \({'p': 3, 'Y_norm_squared'&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span><span class="s2">)</span>

    <span class="s3"># No user warning must be raised in this case.</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;X_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">&quot;error&quot;</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span><span class="s2">)</span>

    <span class="s3"># No user warning must be raised in this case.</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;X_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
        <span class="s4">&quot;Y_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">&quot;error&quot;</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
        <span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_argkmin_classmode_factory_method_wrong_usages</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;manhattan&quot;</span>

    <span class="s1">weights </span><span class="s2">= </span><span class="s4">&quot;uniform&quot;</span>
    <span class="s1">Y_labels </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">unique_Y_labels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">Y_labels</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float32 and Y.dtype=float64&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float64 and Y.dtype=int32&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;k == -1, must be &gt;= 1.&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;k == 0, must be &gt;= 1.&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unrecognized metric&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;wrong metric&quot;</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;Buffer has wrong number of dimensions \(expected 2, got 1\)&quot;</span>
    <span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]),</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;ndarray is not C-contiguous&quot;</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">),</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">non_existent_weights_strategy </span><span class="s2">= </span><span class="s4">&quot;non_existent_weights_strategy&quot;</span>
    <span class="s1">message </span><span class="s2">= (</span>
        <span class="s4">&quot;Only the 'uniform' or 'distance' weights options are supported at this time. &quot;</span>
        <span class="s4">f&quot;Got: weights='</span><span class="s0">{</span><span class="s1">non_existent_weights_strategy</span><span class="s0">}</span><span class="s4">'.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">non_existent_weights_strategy</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># TODO: introduce assertions on UserWarnings once the Euclidean specialisation</span>
    <span class="s3"># of ArgKminClassMode is supported.</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_factory_method_wrong_usages</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;euclidean&quot;</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float32 and Y.dtype=float64&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span>
        <span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float64 and Y.dtype=int32&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;radius == -1.0, must be &gt;= 0.&quot;</span><span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unrecognized metric&quot;</span><span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;wrong metric&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;Buffer has wrong number of dimensions \(expected 2, got 1\)&quot;</span>
    <span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]), </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;ndarray is not C-contiguous&quot;</span><span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span>
        <span class="s2">)</span>

    <span class="s1">unused_metric_kwargs </span><span class="s2">= {</span><span class="s4">&quot;p&quot;</span><span class="s2">: </span><span class="s5">3</span><span class="s2">}</span>

    <span class="s3"># A UserWarning must be raised in this case.</span>
    <span class="s1">message </span><span class="s2">= </span><span class="s4">r&quot;Some metric_kwargs have been passed \({'p': 3}\) but&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">unused_metric_kwargs</span>
        <span class="s2">)</span>

    <span class="s3"># A UserWarning must be raised in this case.</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;p&quot;</span><span class="s2">: </span><span class="s5">3</span><span class="s2">,  </span><span class="s3"># unused</span>
        <span class="s4">&quot;Y_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">}</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s4">r&quot;Some metric_kwargs have been passed \({'p': 3, 'Y_norm_squared'&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span>
        <span class="s2">)</span>

    <span class="s3"># No user warning must be raised in this case.</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;X_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
        <span class="s4">&quot;Y_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">&quot;error&quot;</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span>
        <span class="s2">)</span>

    <span class="s3"># No user warning must be raised in this case.</span>
    <span class="s1">metric_kwargs </span><span class="s2">= {</span>
        <span class="s4">&quot;X_norm_squared&quot;</span><span class="s2">: </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">}</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">&quot;error&quot;</span><span class="s2">, </span><span class="s1">category</span><span class="s2">=</span><span class="s1">UserWarning</span><span class="s2">)</span>
        <span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_radius_neighbors_classmode_factory_method_wrong_usages</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;manhattan&quot;</span>
    <span class="s1">weights </span><span class="s2">= </span><span class="s4">&quot;uniform&quot;</span>
    <span class="s1">Y_labels </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">unique_Y_labels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">Y_labels</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float32 and Y.dtype=float64&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only float64 or float32 datasets pairs are supported at this time, &quot;</span>
        <span class="s4">&quot;got: X.dtype=float64 and Y.dtype=int32&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;radius == -1.0, must be &gt;= 0.&quot;</span><span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unrecognized metric&quot;</span><span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;wrong_metric&quot;</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;Buffer has wrong number of dimensions \(expected 2, got 1\)&quot;</span>
    <span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]),</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;ndarray is not C-contiguous&quot;</span><span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">),</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">non_existent_weights_strategy </span><span class="s2">= </span><span class="s4">&quot;non_existent_weights_strategy&quot;</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s4">&quot;Only the 'uniform' or 'distance' weights options are supported at this time. &quot;</span>
        <span class="s4">f&quot;Got: weights='</span><span class="s0">{</span><span class="s1">non_existent_weights_strategy</span><span class="s0">}</span><span class="s4">'.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;wrong_metric&quot;</span><span class="s2">,</span>
            <span class="s1">weights</span><span class="s2">=</span><span class="s1">non_existent_weights_strategy</span><span class="s2">,</span>
            <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
            <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
            <span class="s1">outlier_label</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Dispatcher&quot;</span><span class="s2">, [</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">RadiusNeighbors</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_chunk_size_agnosticism</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">Dispatcher</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s5">100</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that results do not depend on the chunk size.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">n_samples_X</span><span class="s2">, </span><span class="s1">n_samples_Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">97</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">101</span><span class="s2">, </span><span class="s5">500</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples_X</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples_Y</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s0">if </span><span class="s1">Dispatcher </span><span class="s0">is </span><span class="s1">ArgKmin</span><span class="s2">:</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s5">10</span>
        <span class="s1">check_parameters </span><span class="s2">= {}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s1">_non_trivial_radius</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">)</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s1">radius</span>
        <span class="s1">check_parameters </span><span class="s2">= {</span><span class="s4">&quot;radius&quot;</span><span class="s2">: </span><span class="s1">radius</span><span class="s2">}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {</span><span class="s4">&quot;sort_results&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

    <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">ref_indices </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">256</span><span class="s2">,  </span><span class="s3"># default</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;manhattan&quot;</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">dist</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">41</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;manhattan&quot;</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">Dispatcher</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)](</span>
        <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">, </span><span class="s1">ref_indices</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, **</span><span class="s1">check_parameters</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Dispatcher&quot;</span><span class="s2">, [</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">RadiusNeighbors</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_n_threads_agnosticism</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">Dispatcher</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s5">100</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that results do not depend on the number of threads.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">n_samples_X</span><span class="s2">, </span><span class="s1">n_samples_Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">97</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">101</span><span class="s2">, </span><span class="s5">500</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples_X</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples_Y</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s0">if </span><span class="s1">Dispatcher </span><span class="s0">is </span><span class="s1">ArgKmin</span><span class="s2">:</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s5">10</span>
        <span class="s1">check_parameters </span><span class="s2">= {}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s1">_non_trivial_radius</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">)</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s1">radius</span>
        <span class="s1">check_parameters </span><span class="s2">= {</span><span class="s4">&quot;radius&quot;</span><span class="s2">: </span><span class="s1">radius</span><span class="s2">}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {</span><span class="s4">&quot;sort_results&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

    <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">ref_indices </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">25</span><span class="s2">,  </span><span class="s3"># make sure we use multiple threads</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">_get_threadpool_controller</span><span class="s2">().</span><span class="s1">limit</span><span class="s2">(</span><span class="s1">limits</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">user_api</span><span class="s2">=</span><span class="s4">&quot;openmp&quot;</span><span class="s2">):</span>
        <span class="s1">dist</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">,</span>
            <span class="s1">Y</span><span class="s2">,</span>
            <span class="s1">parameter</span><span class="s2">,</span>
            <span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">25</span><span class="s2">,</span>
            <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">Dispatcher</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)](</span>
        <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">, </span><span class="s1">ref_indices</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">, **</span><span class="s1">check_parameters</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;Dispatcher, dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">RadiusNeighbors</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">RadiusNeighbors</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_format_agnosticism</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">Dispatcher</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">csr_container</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that results do not depend on the format (dense, sparse) of the input.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">100</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Y_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">Dispatcher </span><span class="s0">is </span><span class="s1">ArgKmin</span><span class="s2">:</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s5">10</span>
        <span class="s1">check_parameters </span><span class="s2">= {}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># Adjusting the radius to ensure that the expected results is neither</span>
        <span class="s3"># trivially empty nor too large.</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s1">_non_trivial_radius</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s4">&quot;euclidean&quot;</span><span class="s2">)</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s1">radius</span>
        <span class="s1">check_parameters </span><span class="s2">= {</span><span class="s4">&quot;radius&quot;</span><span class="s2">: </span><span class="s1">radius</span><span class="s2">}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {</span><span class="s4">&quot;sort_results&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

    <span class="s1">dist_dense</span><span class="s2">, </span><span class="s1">indices_dense </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">50</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">_X</span><span class="s2">, </span><span class="s1">_Y </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">((</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">), (</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">)):</span>
        <span class="s0">if </span><span class="s1">_X </span><span class="s0">is </span><span class="s1">X </span><span class="s0">and </span><span class="s1">_Y </span><span class="s0">is </span><span class="s1">Y</span><span class="s2">:</span>
            <span class="s0">continue</span>
        <span class="s1">dist</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">_X</span><span class="s2">,</span>
            <span class="s1">_Y</span><span class="s2">,</span>
            <span class="s1">parameter</span><span class="s2">,</span>
            <span class="s1">chunk_size</span><span class="s2">=</span><span class="s5">50</span><span class="s2">,</span>
            <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">Dispatcher</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)](</span>
            <span class="s1">dist_dense</span><span class="s2">,</span>
            <span class="s1">dist</span><span class="s2">,</span>
            <span class="s1">indices_dense</span><span class="s2">,</span>
            <span class="s1">indices</span><span class="s2">,</span>
            <span class="s2">**</span><span class="s1">check_parameters</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Dispatcher&quot;</span><span class="s2">, [</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">RadiusNeighbors</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_strategies_consistency</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
    <span class="s1">Dispatcher</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">=</span><span class="s5">10</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the results do not depend on the strategy used.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s4">&quot;euclidean&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;minkowski&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;manhattan&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;haversine&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">n_samples_X</span><span class="s2">, </span><span class="s1">n_samples_Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">97</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">101</span><span class="s2">, </span><span class="s5">500</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples_X</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples_Y</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s3"># Haversine distance only accepts 2D data</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;haversine&quot;</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, :</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">[:, :</span><span class="s5">2</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">Dispatcher </span><span class="s0">is </span><span class="s1">ArgKmin</span><span class="s2">:</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s5">10</span>
        <span class="s1">check_parameters </span><span class="s2">= {}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s1">_non_trivial_radius</span><span class="s2">(</span><span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">)</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s1">radius</span>
        <span class="s1">check_parameters </span><span class="s2">= {</span><span class="s4">&quot;radius&quot;</span><span class="s2">: </span><span class="s1">radius</span><span class="s2">}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {</span><span class="s4">&quot;sort_results&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

    <span class="s1">dist_par_X</span><span class="s2">, </span><span class="s1">indices_par_X </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s3"># Taking the first</span>
        <span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">_get_metric_params_list</span><span class="s2">(</span>
            <span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">global_random_seed</span>
        <span class="s2">)[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s3"># To be sure to use parallelization</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s1">n_samples_X </span><span class="s2">// </span><span class="s5">4</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;parallel_on_X&quot;</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">dist_par_Y</span><span class="s2">, </span><span class="s1">indices_par_Y </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s3"># Taking the first</span>
        <span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">_get_metric_params_list</span><span class="s2">(</span>
            <span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">global_random_seed</span>
        <span class="s2">)[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s3"># To be sure to use parallelization</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s1">n_samples_Y </span><span class="s2">// </span><span class="s5">4</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;parallel_on_Y&quot;</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">Dispatcher</span><span class="s2">, </span><span class="s1">global_dtype</span><span class="s2">)](</span>
        <span class="s1">dist_par_X</span><span class="s2">, </span><span class="s1">dist_par_Y</span><span class="s2">, </span><span class="s1">indices_par_X</span><span class="s2">, </span><span class="s1">indices_par_Y</span><span class="s2">, **</span><span class="s1">check_parameters</span>
    <span class="s2">)</span>


<span class="s3"># &quot;Concrete Dispatchers&quot;-specific tests</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">CDIST_PAIRWISE_DISTANCES_REDUCTION_COMMON_METRICS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;strategy&quot;</span><span class="s2">, (</span><span class="s4">&quot;parallel_on_X&quot;</span><span class="s2">, </span><span class="s4">&quot;parallel_on_Y&quot;</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pairwise_distances_argkmin</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">strategy</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">csr_container</span><span class="s2">,</span>
    <span class="s1">n_queries</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s5">100</span><span class="s2">,</span>
    <span class="s1">k</span><span class="s2">=</span><span class="s5">10</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">50</span><span class="s2">, </span><span class="s5">500</span><span class="s2">])</span>
    <span class="s1">translation </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1e6</span><span class="s2">])</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">1000</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">translation </span><span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_queries</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">translation </span><span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Y_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s3"># Haversine distance only accepts 2D data</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;haversine&quot;</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, :</span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ascontiguousarray</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">[:, :</span><span class="s5">2</span><span class="s2">])</span>

    <span class="s1">metric_kwargs </span><span class="s2">= </span><span class="s1">_get_metric_params_list</span><span class="s2">(</span><span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s3"># Reference for argkmin results</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;euclidean&quot;</span><span class="s2">:</span>
        <span class="s3"># Compare to scikit-learn GEMM optimized implementation</span>
        <span class="s1">dist_matrix </span><span class="s2">= </span><span class="s1">euclidean_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">dist_matrix </span><span class="s2">= </span><span class="s1">cdist</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, **</span><span class="s1">metric_kwargs</span><span class="s2">)</span>
    <span class="s3"># Taking argkmin (indices of the k smallest values)</span>
    <span class="s1">argkmin_indices_ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">dist_matrix</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)[:, :</span><span class="s1">k</span><span class="s2">]</span>
    <span class="s3"># Getting the associated distances</span>
    <span class="s1">argkmin_distances_ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">argkmin_indices_ref</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">row_idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">argkmin_indices_ref</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]):</span>
        <span class="s1">argkmin_distances_ref</span><span class="s2">[</span><span class="s1">row_idx</span><span class="s2">] = </span><span class="s1">dist_matrix</span><span class="s2">[</span>
            <span class="s1">row_idx</span><span class="s2">, </span><span class="s1">argkmin_indices_ref</span><span class="s2">[</span><span class="s1">row_idx</span><span class="s2">]</span>
        <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">_X</span><span class="s2">, </span><span class="s1">_Y </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">((</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X_csr</span><span class="s2">), (</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y_csr</span><span class="s2">)):</span>
        <span class="s1">argkmin_distances</span><span class="s2">, </span><span class="s1">argkmin_indices </span><span class="s2">= </span><span class="s1">ArgKmin</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
            <span class="s1">_X</span><span class="s2">,</span>
            <span class="s1">_Y</span><span class="s2">,</span>
            <span class="s1">k</span><span class="s2">,</span>
            <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
            <span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span><span class="s2">,</span>
            <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s3"># So as to have more than a chunk, forcing parallelism.</span>
            <span class="s1">chunk_size</span><span class="s2">=</span><span class="s1">n_samples </span><span class="s2">// </span><span class="s5">4</span><span class="s2">,</span>
            <span class="s1">strategy</span><span class="s2">=</span><span class="s1">strategy</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)](</span>
            <span class="s1">argkmin_distances</span><span class="s2">,</span>
            <span class="s1">argkmin_distances_ref</span><span class="s2">,</span>
            <span class="s1">argkmin_indices</span><span class="s2">,</span>
            <span class="s1">argkmin_indices_ref</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric&quot;</span><span class="s2">, </span><span class="s1">CDIST_PAIRWISE_DISTANCES_REDUCTION_COMMON_METRICS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;strategy&quot;</span><span class="s2">, (</span><span class="s4">&quot;parallel_on_X&quot;</span><span class="s2">, </span><span class="s4">&quot;parallel_on_Y&quot;</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pairwise_distances_radius_neighbors</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">strategy</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">n_queries</span><span class="s2">=</span><span class="s5">5</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">=</span><span class="s5">100</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">50</span><span class="s2">, </span><span class="s5">500</span><span class="s2">])</span>
    <span class="s1">translation </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1e6</span><span class="s2">])</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">1000</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">translation </span><span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_queries</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">translation </span><span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s1">metric_kwargs </span><span class="s2">= </span><span class="s1">_get_metric_params_list</span><span class="s2">(</span>
        <span class="s1">metric</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">global_random_seed</span>
    <span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s3"># Reference for argkmin results</span>
    <span class="s0">if </span><span class="s1">metric </span><span class="s2">== </span><span class="s4">&quot;euclidean&quot;</span><span class="s2">:</span>
        <span class="s3"># Compare to scikit-learn GEMM optimized implementation</span>
        <span class="s1">dist_matrix </span><span class="s2">= </span><span class="s1">euclidean_distances</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">dist_matrix </span><span class="s2">= </span><span class="s1">cdist</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">, **</span><span class="s1">metric_kwargs</span><span class="s2">)</span>

    <span class="s1">radius </span><span class="s2">= </span><span class="s1">_non_trivial_radius</span><span class="s2">(</span><span class="s1">precomputed_dists</span><span class="s2">=</span><span class="s1">dist_matrix</span><span class="s2">)</span>

    <span class="s3"># Getting the neighbors for a given radius</span>
    <span class="s1">neigh_indices_ref </span><span class="s2">= []</span>
    <span class="s1">neigh_distances_ref </span><span class="s2">= []</span>

    <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">dist_matrix</span><span class="s2">:</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">row</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])[</span><span class="s1">row </span><span class="s2">&lt;= </span><span class="s1">radius</span><span class="s2">]</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">row</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">]</span>

        <span class="s1">sort </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>
        <span class="s1">ind</span><span class="s2">, </span><span class="s1">dist </span><span class="s2">= </span><span class="s1">ind</span><span class="s2">[</span><span class="s1">sort</span><span class="s2">], </span><span class="s1">dist</span><span class="s2">[</span><span class="s1">sort</span><span class="s2">]</span>

        <span class="s1">neigh_indices_ref</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">)</span>
        <span class="s1">neigh_distances_ref</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">dist</span><span class="s2">)</span>

    <span class="s1">neigh_distances</span><span class="s2">, </span><span class="s1">neigh_indices </span><span class="s2">= </span><span class="s1">RadiusNeighbors</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">radius</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">metric_kwargs</span><span class="s2">=</span><span class="s1">metric_kwargs</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s3"># So as to have more than a chunk, forcing parallelism.</span>
        <span class="s1">chunk_size</span><span class="s2">=</span><span class="s1">n_samples </span><span class="s2">// </span><span class="s5">4</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s1">strategy</span><span class="s2">,</span>
        <span class="s1">sort_results</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">RadiusNeighbors</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)](</span>
        <span class="s1">neigh_distances</span><span class="s2">, </span><span class="s1">neigh_distances_ref</span><span class="s2">, </span><span class="s1">neigh_indices</span><span class="s2">, </span><span class="s1">neigh_indices_ref</span><span class="s2">, </span><span class="s1">radius</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;Dispatcher&quot;</span><span class="s2">, [</span><span class="s1">ArgKmin</span><span class="s2">, </span><span class="s1">RadiusNeighbors</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;metric&quot;</span><span class="s2">, [</span><span class="s4">&quot;manhattan&quot;</span><span class="s2">, </span><span class="s4">&quot;euclidean&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_memmap_backed_data</span><span class="s2">(</span>
    <span class="s1">metric</span><span class="s2">,</span>
    <span class="s1">Dispatcher</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the results do not depend on the datasets writability.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">128</span><span class="s2">, </span><span class="s5">10</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s3"># Create read only datasets</span>
    <span class="s1">X_mm</span><span class="s2">, </span><span class="s1">Y_mm </span><span class="s2">= </span><span class="s1">create_memmap_backed_data</span><span class="s2">([</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">Dispatcher </span><span class="s0">is </span><span class="s1">ArgKmin</span><span class="s2">:</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s5">10</span>
        <span class="s1">check_parameters </span><span class="s2">= {}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s3"># Scaling the radius slightly with the numbers of dimensions</span>
        <span class="s1">radius </span><span class="s2">= </span><span class="s5">10 </span><span class="s2">** </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">)</span>
        <span class="s1">parameter </span><span class="s2">= </span><span class="s1">radius</span>
        <span class="s1">check_parameters </span><span class="s2">= {</span><span class="s4">&quot;radius&quot;</span><span class="s2">: </span><span class="s1">radius</span><span class="s2">}</span>
        <span class="s1">compute_parameters </span><span class="s2">= {</span><span class="s4">&quot;sort_results&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

    <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">ref_indices </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">dist_mm</span><span class="s2">, </span><span class="s1">indices_mm </span><span class="s2">= </span><span class="s1">Dispatcher</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X_mm</span><span class="s2">,</span>
        <span class="s1">Y_mm</span><span class="s2">,</span>
        <span class="s1">parameter</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">return_distance</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">compute_parameters</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">ASSERT_RESULT</span><span class="s2">[(</span><span class="s1">Dispatcher</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)](</span>
        <span class="s1">ref_dist</span><span class="s2">, </span><span class="s1">dist_mm</span><span class="s2">, </span><span class="s1">ref_indices</span><span class="s2">, </span><span class="s1">indices_mm</span><span class="s2">, **</span><span class="s1">check_parameters</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sqeuclidean_row_norms</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">dtype</span><span class="s2">,</span>
    <span class="s1">csr_container</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">spread </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">97</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">101</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">])</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">])</span>
    <span class="s1">num_threads </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">])</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) * </span><span class="s1">spread</span>

    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">sq_row_norm_reference </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">) ** </span><span class="s5">2</span>
    <span class="s1">sq_row_norm </span><span class="s2">= </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s1">num_threads</span><span class="s2">)</span>

    <span class="s1">sq_row_norm_csr </span><span class="s2">= </span><span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s1">num_threads</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sq_row_norm_reference</span><span class="s2">, </span><span class="s1">sq_row_norm</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sq_row_norm_reference</span><span class="s2">, </span><span class="s1">sq_row_norm_csr</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asfortranarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">sqeuclidean_row_norms</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">num_threads</span><span class="s2">=</span><span class="s1">num_threads</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_argkmin_classmode_strategy_consistent</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">k </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;manhattan&quot;</span>

    <span class="s1">weights </span><span class="s2">= </span><span class="s4">&quot;uniform&quot;</span>
    <span class="s1">Y_labels </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">unique_Y_labels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">Y_labels</span><span class="s2">)</span>
    <span class="s1">results_X </span><span class="s2">= </span><span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
        <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;parallel_on_X&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">results_Y </span><span class="s2">= </span><span class="s1">ArgKminClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
        <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;parallel_on_Y&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">results_X</span><span class="s2">, </span><span class="s1">results_Y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;outlier_label&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_radius_neighbors_classmode_strategy_consistent</span><span class="s2">(</span><span class="s1">outlier_label</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">radius </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">metric </span><span class="s2">= </span><span class="s4">&quot;manhattan&quot;</span>

    <span class="s1">weights </span><span class="s2">= </span><span class="s4">&quot;uniform&quot;</span>
    <span class="s1">Y_labels </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s1">unique_Y_labels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">Y_labels</span><span class="s2">)</span>
    <span class="s1">results_X </span><span class="s2">= </span><span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
        <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s1">outlier_label</span><span class="s2">=</span><span class="s1">outlier_label</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;parallel_on_X&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">results_Y </span><span class="s2">= </span><span class="s1">RadiusNeighborsClassMode</span><span class="s2">.</span><span class="s1">compute</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">,</span>
        <span class="s1">Y</span><span class="s2">=</span><span class="s1">Y</span><span class="s2">,</span>
        <span class="s1">radius</span><span class="s2">=</span><span class="s1">radius</span><span class="s2">,</span>
        <span class="s1">metric</span><span class="s2">=</span><span class="s1">metric</span><span class="s2">,</span>
        <span class="s1">weights</span><span class="s2">=</span><span class="s1">weights</span><span class="s2">,</span>
        <span class="s1">Y_labels</span><span class="s2">=</span><span class="s1">Y_labels</span><span class="s2">,</span>
        <span class="s1">unique_Y_labels</span><span class="s2">=</span><span class="s1">unique_Y_labels</span><span class="s2">,</span>
        <span class="s1">outlier_label</span><span class="s2">=</span><span class="s1">outlier_label</span><span class="s2">,</span>
        <span class="s1">strategy</span><span class="s2">=</span><span class="s4">&quot;parallel_on_Y&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">results_X</span><span class="s2">, </span><span class="s1">results_Y</span><span class="s2">)</span>
</pre>
</body>
</html>