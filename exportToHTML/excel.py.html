<html>
<head>
<title>excel.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
excel.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Utilities for conversion to writer-agnostic Excel representation. 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">from </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">Hashable</span><span class="s3">,</span>
    <span class="s1">Iterable</span><span class="s3">,</span>
    <span class="s1">Mapping</span><span class="s3">,</span>
    <span class="s1">Sequence</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">functools</span>
<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">TYPE_CHECKING</span><span class="s3">,</span>
    <span class="s1">Any</span><span class="s3">,</span>
    <span class="s1">Callable</span><span class="s3">,</span>
    <span class="s1">cast</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">warnings</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_libs</span><span class="s3">.</span><span class="s1">lib </span><span class="s2">import </span><span class="s1">is_list_like</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">_decorators </span><span class="s2">import </span><span class="s1">doc</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">_exceptions </span><span class="s2">import </span><span class="s1">find_stack_level</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s2">import </span><span class="s1">missing</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">dtypes</span><span class="s3">.</span><span class="s1">common </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">is_float</span><span class="s3">,</span>
    <span class="s1">is_scalar</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">DataFrame</span><span class="s3">,</span>
    <span class="s1">Index</span><span class="s3">,</span>
    <span class="s1">MultiIndex</span><span class="s3">,</span>
    <span class="s1">PeriodIndex</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">common </span><span class="s2">as </span><span class="s1">com</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">shared_docs </span><span class="s2">import </span><span class="s1">_shared_docs</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">_color_data </span><span class="s2">import </span><span class="s1">CSS4_COLORS</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">css </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">CSSResolver</span><span class="s3">,</span>
    <span class="s1">CSSWarning</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">format </span><span class="s2">import </span><span class="s1">get_level_lengths</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">printing </span><span class="s2">import </span><span class="s1">pprint_thing</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_typing </span><span class="s2">import </span><span class="s3">(</span>
        <span class="s1">FilePath</span><span class="s3">,</span>
        <span class="s1">IndexLabel</span><span class="s3">,</span>
        <span class="s1">StorageOptions</span><span class="s3">,</span>
        <span class="s1">WriteExcelBuffer</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s1">ExcelWriter</span>


<span class="s2">class </span><span class="s1">ExcelCell</span><span class="s3">:</span>
    <span class="s1">__fields__ </span><span class="s3">= (</span><span class="s4">&quot;row&quot;</span><span class="s3">, </span><span class="s4">&quot;col&quot;</span><span class="s3">, </span><span class="s4">&quot;val&quot;</span><span class="s3">, </span><span class="s4">&quot;style&quot;</span><span class="s3">, </span><span class="s4">&quot;mergestart&quot;</span><span class="s3">, </span><span class="s4">&quot;mergeend&quot;</span><span class="s3">)</span>
    <span class="s1">__slots__ </span><span class="s3">= </span><span class="s1">__fields__</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">row</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">col</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">val</span><span class="s3">,</span>
        <span class="s1">style</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">mergestart</span><span class="s3">: </span><span class="s1">int </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">mergeend</span><span class="s3">: </span><span class="s1">int </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">row </span><span class="s3">= </span><span class="s1">row</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">col </span><span class="s3">= </span><span class="s1">col</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">val </span><span class="s3">= </span><span class="s1">val</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">style </span><span class="s3">= </span><span class="s1">style</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mergestart </span><span class="s3">= </span><span class="s1">mergestart</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mergeend </span><span class="s3">= </span><span class="s1">mergeend</span>


<span class="s2">class </span><span class="s1">CssExcelCell</span><span class="s3">(</span><span class="s1">ExcelCell</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">row</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">col</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">val</span><span class="s3">,</span>
        <span class="s1">style</span><span class="s3">: </span><span class="s1">dict </span><span class="s3">| </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">css_styles</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">], </span><span class="s1">list</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">]]] | </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">css_row</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">css_col</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">css_converter</span><span class="s3">: </span><span class="s1">Callable </span><span class="s3">| </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">css_styles </span><span class="s2">and </span><span class="s1">css_converter</span><span class="s3">:</span>
            <span class="s5"># Use dict to get only one (case-insensitive) declaration per property</span>
            <span class="s1">declaration_dict </span><span class="s3">= {</span>
                <span class="s1">prop</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(): </span><span class="s1">val </span><span class="s2">for </span><span class="s1">prop</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">css_styles</span><span class="s3">[</span><span class="s1">css_row</span><span class="s3">, </span><span class="s1">css_col</span><span class="s3">]</span>
            <span class="s3">}</span>
            <span class="s5"># Convert to frozenset for order-invariant caching</span>
            <span class="s1">unique_declarations </span><span class="s3">= </span><span class="s1">frozenset</span><span class="s3">(</span><span class="s1">declaration_dict</span><span class="s3">.</span><span class="s1">items</span><span class="s3">())</span>
            <span class="s1">style </span><span class="s3">= </span><span class="s1">css_converter</span><span class="s3">(</span><span class="s1">unique_declarations</span><span class="s3">)</span>

        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">row</span><span class="s3">=</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">=</span><span class="s1">col</span><span class="s3">, </span><span class="s1">val</span><span class="s3">=</span><span class="s1">val</span><span class="s3">, </span><span class="s1">style</span><span class="s3">=</span><span class="s1">style</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">CSSToExcelConverter</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    A callable for converting CSS declarations to ExcelWriter styles 
 
    Supports parts of CSS 2.2, with minimal CSS 3.0 support (e.g. text-shadow), 
    focusing on font styling, backgrounds, borders and alignment. 
 
    Operates by first computing CSS styles in a fairly generic 
    way (see :meth:`compute_css`) then determining Excel style 
    properties from CSS properties (see :meth:`build_xlstyle`). 
 
    Parameters 
    ---------- 
    inherited : str, optional 
        CSS declarations understood to be the containing scope for the 
        CSS processed by :meth:`__call__`. 
    &quot;&quot;&quot;</span>

    <span class="s1">NAMED_COLORS </span><span class="s3">= </span><span class="s1">CSS4_COLORS</span>

    <span class="s1">VERTICAL_MAP </span><span class="s3">= {</span>
        <span class="s4">&quot;top&quot;</span><span class="s3">: </span><span class="s4">&quot;top&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;text-top&quot;</span><span class="s3">: </span><span class="s4">&quot;top&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;middle&quot;</span><span class="s3">: </span><span class="s4">&quot;center&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;baseline&quot;</span><span class="s3">: </span><span class="s4">&quot;bottom&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;bottom&quot;</span><span class="s3">: </span><span class="s4">&quot;bottom&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;text-bottom&quot;</span><span class="s3">: </span><span class="s4">&quot;bottom&quot;</span><span class="s3">,</span>
        <span class="s5"># OpenXML also has 'justify', 'distributed'</span>
    <span class="s3">}</span>

    <span class="s1">BOLD_MAP </span><span class="s3">= {</span>
        <span class="s4">&quot;bold&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;bolder&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;600&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;700&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;800&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;900&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;normal&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;lighter&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;100&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;200&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;300&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;400&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;500&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s1">ITALIC_MAP </span><span class="s3">= {</span>
        <span class="s4">&quot;normal&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s4">&quot;italic&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s4">&quot;oblique&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s1">FAMILY_MAP </span><span class="s3">= {</span>
        <span class="s4">&quot;serif&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">,  </span><span class="s5"># roman</span>
        <span class="s4">&quot;sans-serif&quot;</span><span class="s3">: </span><span class="s6">2</span><span class="s3">,  </span><span class="s5"># swiss</span>
        <span class="s4">&quot;cursive&quot;</span><span class="s3">: </span><span class="s6">4</span><span class="s3">,  </span><span class="s5"># script</span>
        <span class="s4">&quot;fantasy&quot;</span><span class="s3">: </span><span class="s6">5</span><span class="s3">,  </span><span class="s5"># decorative</span>
    <span class="s3">}</span>

    <span class="s1">BORDER_STYLE_MAP </span><span class="s3">= {</span>
        <span class="s1">style</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(): </span><span class="s1">style</span>
        <span class="s2">for </span><span class="s1">style </span><span class="s2">in </span><span class="s3">[</span>
            <span class="s4">&quot;dashed&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;mediumDashDot&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;dashDotDot&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;hair&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;dotted&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;mediumDashDotDot&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;double&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;dashDot&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;slantDashDot&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;mediumDashed&quot;</span><span class="s3">,</span>
        <span class="s3">]</span>
    <span class="s3">}</span>

    <span class="s5"># NB: Most of the methods here could be classmethods, as only __init__</span>
    <span class="s5">#     and __call__ make use of instance attributes.  We leave them as</span>
    <span class="s5">#     instancemethods so that users can easily experiment with extensions</span>
    <span class="s5">#     without monkey-patching.</span>
    <span class="s1">inherited</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">] | </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">inherited</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">inherited </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">inherited </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">compute_css</span><span class="s3">(</span><span class="s1">inherited</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">inherited </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s5"># We should avoid cache on the __call__ method.</span>
        <span class="s5"># Otherwise once the method __call__ has been called</span>
        <span class="s5"># garbage collection no longer deletes the instance.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_call_cached </span><span class="s3">= </span><span class="s1">functools</span><span class="s3">.</span><span class="s1">cache</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_call_uncached</span><span class="s3">)</span>

    <span class="s1">compute_css </span><span class="s3">= </span><span class="s1">CSSResolver</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">declarations</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">frozenset</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]</span>
    <span class="s3">) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]:</span>
        <span class="s0">&quot;&quot;&quot; 
        Convert CSS declarations to ExcelWriter style. 
 
        Parameters 
        ---------- 
        declarations : str | frozenset[tuple[str, str]] 
            CSS string or set of CSS declaration tuples. 
            e.g. &quot;font-weight: bold; background: blue&quot; or 
            {(&quot;font-weight&quot;, &quot;bold&quot;), (&quot;background&quot;, &quot;blue&quot;)} 
 
        Returns 
        ------- 
        xlstyle : dict 
            A style as interpreted by ExcelWriter when found in 
            ExcelCell.style. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_call_cached</span><span class="s3">(</span><span class="s1">declarations</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_call_uncached</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">declarations</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">frozenset</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]</span>
    <span class="s3">) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]:</span>
        <span class="s1">properties </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">compute_css</span><span class="s3">(</span><span class="s1">declarations</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inherited</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_xlstyle</span><span class="s3">(</span><span class="s1">properties</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">build_xlstyle</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]]:</span>
        <span class="s1">out </span><span class="s3">= {</span>
            <span class="s4">&quot;alignment&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_alignment</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;border&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_border</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;fill&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_fill</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;font&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_font</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;number_format&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_number_format</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
        <span class="s3">}</span>

        <span class="s5"># TODO: handle cell width and height: needs support in pandas.io.excel</span>

        <span class="s2">def </span><span class="s1">remove_none</span><span class="s3">(</span><span class="s1">d</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s0">&quot;&quot;&quot;Remove key where value is None, through nested dicts&quot;&quot;&quot;</span>
            <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">list</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()):</span>
                <span class="s2">if </span><span class="s1">v </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s2">del </span><span class="s1">d</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
                <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
                    <span class="s1">remove_none</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
                    <span class="s2">if not </span><span class="s1">v</span><span class="s3">:</span>
                        <span class="s2">del </span><span class="s1">d</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>

        <span class="s1">remove_none</span><span class="s3">(</span><span class="s1">out</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">out</span>

    <span class="s2">def </span><span class="s1">build_alignment</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool </span><span class="s3">| </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s5"># TODO: text-indent, padding-left -&gt; alignment.indent</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s4">&quot;horizontal&quot;</span><span class="s3">: </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;text-align&quot;</span><span class="s3">),</span>
            <span class="s4">&quot;vertical&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_vertical_alignment</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;wrap_text&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_is_wrap_text</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_get_vertical_alignment</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">vertical_align </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;vertical-align&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">vertical_align</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">VERTICAL_MAP</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">vertical_align</span><span class="s3">)</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_get_is_wrap_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; bool </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;white-space&quot;</span><span class="s3">) </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">props</span><span class="s3">[</span><span class="s4">&quot;white-space&quot;</span><span class="s3">] </span><span class="s2">not in </span><span class="s3">(</span><span class="s4">&quot;nowrap&quot;</span><span class="s3">, </span><span class="s4">&quot;pre&quot;</span><span class="s3">, </span><span class="s4">&quot;pre-line&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">build_border</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]</span>
    <span class="s3">) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]]:</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s1">side</span><span class="s3">: {</span>
                <span class="s4">&quot;style&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_border_style</span><span class="s3">(</span>
                    <span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">f&quot;border-</span><span class="s2">{</span><span class="s1">side</span><span class="s2">}</span><span class="s4">-style&quot;</span><span class="s3">),</span>
                    <span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">f&quot;border-</span><span class="s2">{</span><span class="s1">side</span><span class="s2">}</span><span class="s4">-width&quot;</span><span class="s3">),</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">color_to_excel</span><span class="s3">(</span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">f&quot;border-</span><span class="s2">{</span><span class="s1">side</span><span class="s2">}</span><span class="s4">-color&quot;</span><span class="s3">)),</span>
                <span class="s3">),</span>
                <span class="s4">&quot;color&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">color_to_excel</span><span class="s3">(</span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">f&quot;border-</span><span class="s2">{</span><span class="s1">side</span><span class="s2">}</span><span class="s4">-color&quot;</span><span class="s3">)),</span>
            <span class="s3">}</span>
            <span class="s2">for </span><span class="s1">side </span><span class="s2">in </span><span class="s3">[</span><span class="s4">&quot;top&quot;</span><span class="s3">, </span><span class="s4">&quot;right&quot;</span><span class="s3">, </span><span class="s4">&quot;bottom&quot;</span><span class="s3">, </span><span class="s4">&quot;left&quot;</span><span class="s3">]</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_border_style</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">style</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">, </span><span class="s1">width</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">, </span><span class="s1">color</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">):</span>
        <span class="s5"># convert styles and widths to openxml, one of:</span>
        <span class="s5">#       'dashDot'</span>
        <span class="s5">#       'dashDotDot'</span>
        <span class="s5">#       'dashed'</span>
        <span class="s5">#       'dotted'</span>
        <span class="s5">#       'double'</span>
        <span class="s5">#       'hair'</span>
        <span class="s5">#       'medium'</span>
        <span class="s5">#       'mediumDashDot'</span>
        <span class="s5">#       'mediumDashDotDot'</span>
        <span class="s5">#       'mediumDashed'</span>
        <span class="s5">#       'slantDashDot'</span>
        <span class="s5">#       'thick'</span>
        <span class="s5">#       'thin'</span>
        <span class="s2">if </span><span class="s1">width </span><span class="s2">is None and </span><span class="s1">style </span><span class="s2">is None and </span><span class="s1">color </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s5"># Return None will remove &quot;border&quot; from style dictionary</span>
            <span class="s2">return None</span>

        <span class="s2">if </span><span class="s1">width </span><span class="s2">is None and </span><span class="s1">style </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s5"># Return &quot;none&quot; will keep &quot;border&quot; in style dictionary</span>
            <span class="s2">return </span><span class="s4">&quot;none&quot;</span>

        <span class="s2">if </span><span class="s1">style </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;none&quot;</span><span class="s3">, </span><span class="s4">&quot;hidden&quot;</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s4">&quot;none&quot;</span>

        <span class="s1">width_name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_width_name</span><span class="s3">(</span><span class="s1">width</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">width_name </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">&quot;none&quot;</span>

        <span class="s2">if </span><span class="s1">style </span><span class="s2">in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;groove&quot;</span><span class="s3">, </span><span class="s4">&quot;ridge&quot;</span><span class="s3">, </span><span class="s4">&quot;inset&quot;</span><span class="s3">, </span><span class="s4">&quot;outset&quot;</span><span class="s3">, </span><span class="s4">&quot;solid&quot;</span><span class="s3">):</span>
            <span class="s5"># not handled</span>
            <span class="s2">return </span><span class="s1">width_name</span>

        <span class="s2">if </span><span class="s1">style </span><span class="s3">== </span><span class="s4">&quot;double&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">&quot;double&quot;</span>
        <span class="s2">if </span><span class="s1">style </span><span class="s3">== </span><span class="s4">&quot;dotted&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">width_name </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;hair&quot;</span><span class="s3">, </span><span class="s4">&quot;thin&quot;</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s4">&quot;dotted&quot;</span>
            <span class="s2">return </span><span class="s4">&quot;mediumDashDotDot&quot;</span>
        <span class="s2">if </span><span class="s1">style </span><span class="s3">== </span><span class="s4">&quot;dashed&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">width_name </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;hair&quot;</span><span class="s3">, </span><span class="s4">&quot;thin&quot;</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s4">&quot;dashed&quot;</span>
            <span class="s2">return </span><span class="s4">&quot;mediumDashed&quot;</span>
        <span class="s2">elif </span><span class="s1">style </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">BORDER_STYLE_MAP</span><span class="s3">:</span>
            <span class="s5"># Excel-specific styles</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">BORDER_STYLE_MAP</span><span class="s3">[</span><span class="s1">style</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s4">f&quot;Unhandled border style format: </span><span class="s2">{</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">style</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s1">CSSWarning</span><span class="s3">,</span>
                <span class="s1">stacklevel</span><span class="s3">=</span><span class="s1">find_stack_level</span><span class="s3">(),</span>
            <span class="s3">)</span>
            <span class="s2">return </span><span class="s4">&quot;none&quot;</span>

    <span class="s2">def </span><span class="s1">_get_width_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">width_input</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_width_to_float</span><span class="s3">(</span><span class="s1">width_input</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">width </span><span class="s3">&lt; </span><span class="s6">1e-5</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">elif </span><span class="s1">width </span><span class="s3">&lt; </span><span class="s6">1.3</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">&quot;thin&quot;</span>
        <span class="s2">elif </span><span class="s1">width </span><span class="s3">&lt; </span><span class="s6">2.8</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">&quot;medium&quot;</span>
        <span class="s2">return </span><span class="s4">&quot;thick&quot;</span>

    <span class="s2">def </span><span class="s1">_width_to_float</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">width</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; float</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">width </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">width </span><span class="s3">= </span><span class="s4">&quot;2pt&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pt_to_float</span><span class="s3">(</span><span class="s1">width</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_pt_to_float</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pt_string</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; float</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">pt_string</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">&quot;pt&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">float</span><span class="s3">(</span><span class="s1">pt_string</span><span class="s3">.</span><span class="s1">rstrip</span><span class="s3">(</span><span class="s4">&quot;pt&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">build_fill</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]):</span>
        <span class="s5"># TODO: perhaps allow for special properties</span>
        <span class="s5">#       -excel-pattern-bgcolor and -excel-pattern-type</span>
        <span class="s1">fill_color </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;background-color&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fill_color </span><span class="s2">not in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;transparent&quot;</span><span class="s3">, </span><span class="s4">&quot;none&quot;</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;fgColor&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">color_to_excel</span><span class="s3">(</span><span class="s1">fill_color</span><span class="s3">), </span><span class="s4">&quot;patternType&quot;</span><span class="s3">: </span><span class="s4">&quot;solid&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">build_number_format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s1">fc </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;number-format&quot;</span><span class="s3">)</span>
        <span class="s1">fc </span><span class="s3">= </span><span class="s1">fc</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;ยง&quot;</span><span class="s3">, </span><span class="s4">&quot;;&quot;</span><span class="s3">) </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fc</span><span class="s3">, </span><span class="s1">str</span><span class="s3">) </span><span class="s2">else </span><span class="s1">fc</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;format_code&quot;</span><span class="s3">: </span><span class="s1">fc</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">build_font</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]</span>
    <span class="s3">) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool </span><span class="s3">| </span><span class="s1">float </span><span class="s3">| </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s1">font_names </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_font_names</span><span class="s3">(</span><span class="s1">props</span><span class="s3">)</span>
        <span class="s1">decoration </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_decoration</span><span class="s3">(</span><span class="s1">props</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">font_names</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">if </span><span class="s1">font_names </span><span class="s2">else None</span><span class="s3">,</span>
            <span class="s4">&quot;family&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_select_font_family</span><span class="s3">(</span><span class="s1">font_names</span><span class="s3">),</span>
            <span class="s4">&quot;size&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_font_size</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;bold&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_is_bold</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;italic&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_is_italic</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
            <span class="s4">&quot;underline&quot;</span><span class="s3">: (</span><span class="s4">&quot;single&quot; </span><span class="s2">if </span><span class="s4">&quot;underline&quot; </span><span class="s2">in </span><span class="s1">decoration </span><span class="s2">else None</span><span class="s3">),</span>
            <span class="s4">&quot;strike&quot;</span><span class="s3">: (</span><span class="s4">&quot;line-through&quot; </span><span class="s2">in </span><span class="s1">decoration</span><span class="s3">) </span><span class="s2">or None</span><span class="s3">,</span>
            <span class="s4">&quot;color&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">color_to_excel</span><span class="s3">(</span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;color&quot;</span><span class="s3">)),</span>
            <span class="s5"># shadow if nonzero digit before shadow color</span>
            <span class="s4">&quot;shadow&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_shadow</span><span class="s3">(</span><span class="s1">props</span><span class="s3">),</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_get_is_bold</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; bool </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">weight </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;font-weight&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">weight</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">BOLD_MAP</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">weight</span><span class="s3">)</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_get_is_italic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; bool </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">font_style </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;font-style&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">font_style</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ITALIC_MAP</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">font_style</span><span class="s3">)</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_get_decoration</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s1">decoration </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;text-decoration&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">decoration </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">decoration</span><span class="s3">.</span><span class="s1">split</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_underline</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">decoration</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s4">&quot;underline&quot; </span><span class="s2">in </span><span class="s1">decoration</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">&quot;single&quot;</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_get_shadow</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; bool </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s4">&quot;text-shadow&quot; </span><span class="s2">in </span><span class="s1">props</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s4">&quot;^[^#(]*[1-9]&quot;</span><span class="s3">, </span><span class="s1">props</span><span class="s3">[</span><span class="s4">&quot;text-shadow&quot;</span><span class="s3">]))</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_get_font_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s1">font_names_tmp </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">findall</span><span class="s3">(</span>
            <span class="s4">r&quot;&quot;&quot;(?x) 
            ( 
            &quot;(?:[^&quot;]|\\&quot;)+&quot; 
            | 
            '(?:[^']|\\')+' 
            | 
            [^'&quot;,]+ 
            )(?=,|\s*$) 
        &quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;font-family&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>

        <span class="s1">font_names </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">font_names_tmp</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">name</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">] == </span><span class="s4">'&quot;'</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\\</span><span class="s4">&quot;'</span><span class="s3">, </span><span class="s4">'&quot;'</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">name</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">] == </span><span class="s4">&quot;'&quot;</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[</span><span class="s6">1</span><span class="s3">:-</span><span class="s6">1</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">'&quot;</span><span class="s3">, </span><span class="s4">&quot;'&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">name</span><span class="s3">:</span>
                <span class="s1">font_names</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">font_names</span>

    <span class="s2">def </span><span class="s1">_get_font_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">props</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; float </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">props</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;font-size&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">size </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">size</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_pt_to_float</span><span class="s3">(</span><span class="s1">size</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_select_font_family</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">font_names</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; int </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">family </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">font_names</span><span class="s3">:</span>
            <span class="s1">family </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">FAMILY_MAP</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">family</span><span class="s3">:</span>
                <span class="s2">break</span>

        <span class="s2">return </span><span class="s1">family</span>

    <span class="s2">def </span><span class="s1">color_to_excel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">val</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; str </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">val </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return None</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_hex_color</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_convert_hex_to_excel</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">NAMED_COLORS</span><span class="s3">[</span><span class="s1">val</span><span class="s3">]</span>
        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s4">f&quot;Unhandled color format: </span><span class="s2">{</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">val</span><span class="s3">)</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                <span class="s1">CSSWarning</span><span class="s3">,</span>
                <span class="s1">stacklevel</span><span class="s3">=</span><span class="s1">find_stack_level</span><span class="s3">(),</span>
            <span class="s3">)</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">_is_hex_color</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">color_string</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">color_string</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;#&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_convert_hex_to_excel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">color_string</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s1">code </span><span class="s3">= </span><span class="s1">color_string</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s4">&quot;#&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_shorthand_color</span><span class="s3">(</span><span class="s1">color_string</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">code</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] * </span><span class="s6">2 </span><span class="s3">+ </span><span class="s1">code</span><span class="s3">[</span><span class="s6">1</span><span class="s3">] * </span><span class="s6">2 </span><span class="s3">+ </span><span class="s1">code</span><span class="s3">[</span><span class="s6">2</span><span class="s3">] * </span><span class="s6">2</span><span class="s3">).</span><span class="s1">upper</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">code</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_is_shorthand_color</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">color_string</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Check if color code is shorthand. 
 
        #FFF is a shorthand as opposed to full #FFFFFF. 
        &quot;&quot;&quot;</span>
        <span class="s1">code </span><span class="s3">= </span><span class="s1">color_string</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s4">&quot;#&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">code</span><span class="s3">) == </span><span class="s6">3</span><span class="s3">:</span>
            <span class="s2">return True</span>
        <span class="s2">elif </span><span class="s1">len</span><span class="s3">(</span><span class="s1">code</span><span class="s3">) == </span><span class="s6">6</span><span class="s3">:</span>
            <span class="s2">return False</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;Unexpected color </span><span class="s2">{</span><span class="s1">color_string</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">ExcelFormatter</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Class for formatting a DataFrame to a list of ExcelCells, 
 
    Parameters 
    ---------- 
    df : DataFrame or Styler 
    na_rep: na representation 
    float_format : str, default None 
        Format string for floating point numbers 
    cols : sequence, optional 
        Columns to write 
    header : bool or sequence of str, default True 
        Write out column names. If a list of string is given it is 
        assumed to be aliases for the column names 
    index : bool, default True 
        output row names (index) 
    index_label : str or sequence, default None 
        Column label for index column(s) if desired. If None is given, and 
        `header` and `index` are True, then the index names are used. A 
        sequence should be given if the DataFrame uses MultiIndex. 
    merge_cells : bool, default False 
        Format MultiIndex and Hierarchical Rows as merged cells. 
    inf_rep : str, default `'inf'` 
        representation for np.inf values (which aren't representable in Excel) 
        A `'-'` sign will be added in front of -inf. 
    style_converter : callable, optional 
        This translates Styler styles (CSS) into ExcelWriter styles. 
        Defaults to ``CSSToExcelConverter()``. 
        It should have signature css_declarations string -&gt; excel style. 
        This is only called for body cells. 
    &quot;&quot;&quot;</span>

    <span class="s1">max_rows </span><span class="s3">= </span><span class="s6">2</span><span class="s3">**</span><span class="s6">20</span>
    <span class="s1">max_cols </span><span class="s3">= </span><span class="s6">2</span><span class="s3">**</span><span class="s6">14</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">df</span><span class="s3">,</span>
        <span class="s1">na_rep</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">float_format</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">cols</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Hashable</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">header</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Hashable</span><span class="s3">] | </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">index</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">index_label</span><span class="s3">: </span><span class="s1">IndexLabel </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">merge_cells</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">inf_rep</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;inf&quot;</span><span class="s3">,</span>
        <span class="s1">style_converter</span><span class="s3">: </span><span class="s1">Callable </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">na_rep </span><span class="s3">= </span><span class="s1">na_rep</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">DataFrame</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">styler </span><span class="s3">= </span><span class="s1">df</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">.</span><span class="s1">_compute</span><span class="s3">()  </span><span class="s5"># calculate applied styles</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">data</span>
            <span class="s2">if </span><span class="s1">style_converter </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">style_converter </span><span class="s3">= </span><span class="s1">CSSToExcelConverter</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">: </span><span class="s1">Callable </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s1">style_converter</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">styler </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">df </span><span class="s3">= </span><span class="s1">df</span>
        <span class="s2">if </span><span class="s1">cols </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s5"># all missing, raise</span>
            <span class="s2">if not </span><span class="s1">len</span><span class="s3">(</span><span class="s1">Index</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">).</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)):</span>
                <span class="s2">raise </span><span class="s1">KeyError</span><span class="s3">(</span><span class="s4">&quot;passes columns are not ALL present dataframe&quot;</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">Index</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">).</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)) != </span><span class="s1">len</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">)):</span>
                <span class="s5"># Deprecated in GH#17295, enforced in 1.0.0</span>
                <span class="s2">raise </span><span class="s1">KeyError</span><span class="s3">(</span><span class="s4">&quot;Not all names specified in 'columns' are found&quot;</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">reindex</span><span class="s3">(</span><span class="s1">columns</span><span class="s3">=</span><span class="s1">cols</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">float_format </span><span class="s3">= </span><span class="s1">float_format</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">index_label </span><span class="s3">= </span><span class="s1">index_label</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">header </span><span class="s3">= </span><span class="s1">header</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">merge_cells </span><span class="s3">= </span><span class="s1">merge_cells</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">inf_rep </span><span class="s3">= </span><span class="s1">inf_rep</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">header_style</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bool</span><span class="s3">]]:</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s4">&quot;font&quot;</span><span class="s3">: {</span><span class="s4">&quot;bold&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">},</span>
            <span class="s4">&quot;borders&quot;</span><span class="s3">: {</span>
                <span class="s4">&quot;top&quot;</span><span class="s3">: </span><span class="s4">&quot;thin&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;right&quot;</span><span class="s3">: </span><span class="s4">&quot;thin&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;bottom&quot;</span><span class="s3">: </span><span class="s4">&quot;thin&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;left&quot;</span><span class="s3">: </span><span class="s4">&quot;thin&quot;</span><span class="s3">,</span>
            <span class="s3">},</span>
            <span class="s4">&quot;alignment&quot;</span><span class="s3">: {</span><span class="s4">&quot;horizontal&quot;</span><span class="s3">: </span><span class="s4">&quot;center&quot;</span><span class="s3">, </span><span class="s4">&quot;vertical&quot;</span><span class="s3">: </span><span class="s4">&quot;top&quot;</span><span class="s3">},</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">_format_value</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">val</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">is_scalar</span><span class="s3">(</span><span class="s1">val</span><span class="s3">) </span><span class="s2">and </span><span class="s1">missing</span><span class="s3">.</span><span class="s1">isna</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
            <span class="s1">val </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">na_rep</span>
        <span class="s2">elif </span><span class="s1">is_float</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">missing</span><span class="s3">.</span><span class="s1">isposinf_scalar</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">inf_rep</span>
            <span class="s2">elif </span><span class="s1">missing</span><span class="s3">.</span><span class="s1">isneginf_scalar</span><span class="s3">(</span><span class="s1">val</span><span class="s3">):</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s4">f&quot;-</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">inf_rep</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">float_format </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">val </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">float_format </span><span class="s3">% </span><span class="s1">val</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s4">&quot;tzinfo&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s4">&quot;Excel does not support datetimes with &quot;</span>
                <span class="s4">&quot;timezones. Please ensure that datetimes &quot;</span>
                <span class="s4">&quot;are timezone unaware before writing to Excel.&quot;</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">val</span>

    <span class="s2">def </span><span class="s1">_format_header_mi</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">nlevels </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span>
                    <span class="s4">&quot;Writing to Excel with MultiIndex columns and no &quot;</span>
                    <span class="s4">&quot;index ('index'=False) is not yet implemented.&quot;</span>
                <span class="s3">)</span>

        <span class="s2">if not </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_aliases </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">):</span>
            <span class="s2">return</span>

        <span class="s1">columns </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span>
        <span class="s1">level_strs </span><span class="s3">= </span><span class="s1">columns</span><span class="s3">.</span><span class="s1">_format_multi</span><span class="s3">(</span>
            <span class="s1">sparsify</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">merge_cells</span><span class="s3">, </span><span class="s1">include_names</span><span class="s3">=</span><span class="s2">False</span>
        <span class="s3">)</span>
        <span class="s1">level_lengths </span><span class="s3">= </span><span class="s1">get_level_lengths</span><span class="s3">(</span><span class="s1">level_strs</span><span class="s3">)</span>
        <span class="s1">coloffset </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">lnum </span><span class="s3">= </span><span class="s6">0</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">MultiIndex</span><span class="s3">):</span>
            <span class="s1">coloffset </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]) - </span><span class="s6">1</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">merge_cells</span><span class="s3">:</span>
            <span class="s5"># Format multi-index as a merged cells.</span>
            <span class="s2">for </span><span class="s1">lnum</span><span class="s3">, </span><span class="s1">name </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">names</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">ExcelCell</span><span class="s3">(</span>
                    <span class="s1">row</span><span class="s3">=</span><span class="s1">lnum</span><span class="s3">,</span>
                    <span class="s1">col</span><span class="s3">=</span><span class="s1">coloffset</span><span class="s3">,</span>
                    <span class="s1">val</span><span class="s3">=</span><span class="s1">name</span><span class="s3">,</span>
                    <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                <span class="s3">)</span>

            <span class="s2">for </span><span class="s1">lnum</span><span class="s3">, (</span><span class="s1">spans</span><span class="s3">, </span><span class="s1">levels</span><span class="s3">, </span><span class="s1">level_codes</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span>
                <span class="s1">zip</span><span class="s3">(</span><span class="s1">level_lengths</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">.</span><span class="s1">levels</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">.</span><span class="s1">codes</span><span class="s3">)</span>
            <span class="s3">):</span>
                <span class="s1">values </span><span class="s3">= </span><span class="s1">levels</span><span class="s3">.</span><span class="s1">take</span><span class="s3">(</span><span class="s1">level_codes</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">span_val </span><span class="s2">in </span><span class="s1">spans</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                    <span class="s1">mergestart</span><span class="s3">, </span><span class="s1">mergeend </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>
                    <span class="s2">if </span><span class="s1">span_val </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">:</span>
                        <span class="s1">mergestart</span><span class="s3">, </span><span class="s1">mergeend </span><span class="s3">= </span><span class="s1">lnum</span><span class="s3">, </span><span class="s1">coloffset </span><span class="s3">+ </span><span class="s1">i </span><span class="s3">+ </span><span class="s1">span_val</span>
                    <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                        <span class="s1">row</span><span class="s3">=</span><span class="s1">lnum</span><span class="s3">,</span>
                        <span class="s1">col</span><span class="s3">=</span><span class="s1">coloffset </span><span class="s3">+ </span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">,</span>
                        <span class="s1">val</span><span class="s3">=</span><span class="s1">values</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span>
                        <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                        <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx_columns&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                        <span class="s1">css_row</span><span class="s3">=</span><span class="s1">lnum</span><span class="s3">,</span>
                        <span class="s1">css_col</span><span class="s3">=</span><span class="s1">i</span><span class="s3">,</span>
                        <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                        <span class="s1">mergestart</span><span class="s3">=</span><span class="s1">mergestart</span><span class="s3">,</span>
                        <span class="s1">mergeend</span><span class="s3">=</span><span class="s1">mergeend</span><span class="s3">,</span>
                    <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s5"># Format in legacy format with dots to indicate levels.</span>
            <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">values </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(*</span><span class="s1">level_strs</span><span class="s3">)):</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s4">&quot;.&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">pprint_thing</span><span class="s3">, </span><span class="s1">values</span><span class="s3">))</span>
                <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                    <span class="s1">row</span><span class="s3">=</span><span class="s1">lnum</span><span class="s3">,</span>
                    <span class="s1">col</span><span class="s3">=</span><span class="s1">coloffset </span><span class="s3">+ </span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">,</span>
                    <span class="s1">val</span><span class="s3">=</span><span class="s1">v</span><span class="s3">,</span>
                    <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                    <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx_columns&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                    <span class="s1">css_row</span><span class="s3">=</span><span class="s1">lnum</span><span class="s3">,</span>
                    <span class="s1">css_col</span><span class="s3">=</span><span class="s1">i</span><span class="s3">,</span>
                    <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">= </span><span class="s1">lnum</span>

    <span class="s2">def </span><span class="s1">_format_header_regular</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_aliases </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">:</span>
            <span class="s1">coloffset </span><span class="s3">= </span><span class="s6">0</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">:</span>
                <span class="s1">coloffset </span><span class="s3">= </span><span class="s6">1</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">MultiIndex</span><span class="s3">):</span>
                    <span class="s1">coloffset </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span><span class="s3">)</span>

            <span class="s1">colnames </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_aliases</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">header </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Sequence</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">) != </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">):</span>
                    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                        <span class="s4">f&quot;Writing </span><span class="s2">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)</span><span class="s2">} </span><span class="s4">cols &quot;</span>
                        <span class="s4">f&quot;but got </span><span class="s2">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">)</span><span class="s2">} </span><span class="s4">aliases&quot;</span>
                    <span class="s3">)</span>
                <span class="s1">colnames </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span>

            <span class="s2">for </span><span class="s1">colindex</span><span class="s3">, </span><span class="s1">colname </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">colnames</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                    <span class="s1">row</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter</span><span class="s3">,</span>
                    <span class="s1">col</span><span class="s3">=</span><span class="s1">colindex </span><span class="s3">+ </span><span class="s1">coloffset</span><span class="s3">,</span>
                    <span class="s1">val</span><span class="s3">=</span><span class="s1">colname</span><span class="s3">,</span>
                    <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                    <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx_columns&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                    <span class="s1">css_row</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
                    <span class="s1">css_col</span><span class="s3">=</span><span class="s1">colindex</span><span class="s3">,</span>
                    <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_format_header</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s1">gen</span><span class="s3">: </span><span class="s1">Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">MultiIndex</span><span class="s3">):</span>
            <span class="s1">gen </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_header_mi</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">gen </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_header_regular</span><span class="s3">()</span>

        <span class="s1">gen2</span><span class="s3">: </span><span class="s1">Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">] = ()</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span><span class="s3">:</span>
            <span class="s1">row </span><span class="s3">= [</span><span class="s1">x </span><span class="s2">if </span><span class="s1">x </span><span class="s2">is not None else </span><span class="s4">&quot;&quot; </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span><span class="s3">] + [</span>
                <span class="s4">&quot;&quot;</span>
            <span class="s3">] * </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">functools</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">x </span><span class="s2">and </span><span class="s1">y</span><span class="s3">, (</span><span class="s1">x </span><span class="s3">!= </span><span class="s4">&quot;&quot; </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">row</span><span class="s3">)):</span>
                <span class="s1">gen2 </span><span class="s3">= (</span>
                    <span class="s1">ExcelCell</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter</span><span class="s3">, </span><span class="s1">colindex</span><span class="s3">, </span><span class="s1">val</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">colindex</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">row</span><span class="s3">)</span>
                <span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+= </span><span class="s6">1</span>
        <span class="s2">return </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">chain</span><span class="s3">(</span><span class="s1">gen</span><span class="s3">, </span><span class="s1">gen2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_format_body</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">MultiIndex</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_hierarchical_rows</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_regular_rows</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_format_regular_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_aliases </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+= </span><span class="s6">1</span>

        <span class="s5"># output index and index_label?</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">:</span>
            <span class="s5"># check aliases</span>
            <span class="s5"># if list only take first as this is not a MultiIndex</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">index_label</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">, </span><span class="s1">Index</span><span class="s3">)</span>
            <span class="s3">):</span>
                <span class="s1">index_label </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>
            <span class="s5"># if string good to go</span>
            <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">index_label </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">index_label </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>

            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">MultiIndex</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+= </span><span class="s6">1</span>

            <span class="s2">if </span><span class="s1">index_label </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header </span><span class="s2">is not False</span><span class="s3">:</span>
                <span class="s2">yield </span><span class="s1">ExcelCell</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">index_label</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">)</span>

            <span class="s5"># write index_values</span>
            <span class="s1">index_values </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">PeriodIndex</span><span class="s3">):</span>
                <span class="s1">index_values </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">to_timestamp</span><span class="s3">()</span>

            <span class="s2">for </span><span class="s1">idx</span><span class="s3">, </span><span class="s1">idxval </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">index_values</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                    <span class="s1">row</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+ </span><span class="s1">idx</span><span class="s3">,</span>
                    <span class="s1">col</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
                    <span class="s1">val</span><span class="s3">=</span><span class="s1">idxval</span><span class="s3">,</span>
                    <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                    <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx_index&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                    <span class="s1">css_row</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">,</span>
                    <span class="s1">css_col</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
                    <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s1">coloffset </span><span class="s3">= </span><span class="s6">1</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">coloffset </span><span class="s3">= </span><span class="s6">0</span>

        <span class="s2">yield from </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_generate_body</span><span class="s3">(</span><span class="s1">coloffset</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_format_hierarchical_rows</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_aliases </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+= </span><span class="s6">1</span>

        <span class="s1">gcolidx </span><span class="s3">= </span><span class="s6">0</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">:</span>
            <span class="s1">index_labels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span>
            <span class="s5"># check for aliases</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">index_label</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">, </span><span class="s1">Index</span><span class="s3">)</span>
            <span class="s3">):</span>
                <span class="s1">index_labels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_label</span>

            <span class="s5"># MultiIndex columns require an extra row</span>
            <span class="s5"># with index names (blank if None) for</span>
            <span class="s5"># unambiguous round-trip, unless not merging,</span>
            <span class="s5"># in which case the names all go on one row Issue #11328</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">MultiIndex</span><span class="s3">) </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">merge_cells</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+= </span><span class="s6">1</span>

            <span class="s5"># if index labels are not empty go ahead and dump</span>
            <span class="s2">if </span><span class="s1">com</span><span class="s3">.</span><span class="s1">any_not_none</span><span class="s3">(*</span><span class="s1">index_labels</span><span class="s3">) </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header </span><span class="s2">is not False</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">cidx</span><span class="s3">, </span><span class="s1">name </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">index_labels</span><span class="s3">):</span>
                    <span class="s2">yield </span><span class="s1">ExcelCell</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s1">cidx</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">merge_cells</span><span class="s3">:</span>
                <span class="s5"># Format hierarchical rows as merged cells.</span>
                <span class="s1">level_strs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">_format_multi</span><span class="s3">(</span>
                    <span class="s1">sparsify</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">include_names</span><span class="s3">=</span><span class="s2">False</span>
                <span class="s3">)</span>
                <span class="s1">level_lengths </span><span class="s3">= </span><span class="s1">get_level_lengths</span><span class="s3">(</span><span class="s1">level_strs</span><span class="s3">)</span>

                <span class="s2">for </span><span class="s1">spans</span><span class="s3">, </span><span class="s1">levels</span><span class="s3">, </span><span class="s1">level_codes </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span>
                    <span class="s1">level_lengths</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">levels</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">codes</span>
                <span class="s3">):</span>
                    <span class="s1">values </span><span class="s3">= </span><span class="s1">levels</span><span class="s3">.</span><span class="s1">take</span><span class="s3">(</span>
                        <span class="s1">level_codes</span><span class="s3">,</span>
                        <span class="s1">allow_fill</span><span class="s3">=</span><span class="s1">levels</span><span class="s3">.</span><span class="s1">_can_hold_na</span><span class="s3">,</span>
                        <span class="s1">fill_value</span><span class="s3">=</span><span class="s1">levels</span><span class="s3">.</span><span class="s1">_na_value</span><span class="s3">,</span>
                    <span class="s3">)</span>

                    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">span_val </span><span class="s2">in </span><span class="s1">spans</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                        <span class="s1">mergestart</span><span class="s3">, </span><span class="s1">mergeend </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>
                        <span class="s2">if </span><span class="s1">span_val </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">:</span>
                            <span class="s1">mergestart </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+ </span><span class="s1">i </span><span class="s3">+ </span><span class="s1">span_val </span><span class="s3">- </span><span class="s6">1</span>
                            <span class="s1">mergeend </span><span class="s3">= </span><span class="s1">gcolidx</span>
                        <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                            <span class="s1">row</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">,</span>
                            <span class="s1">col</span><span class="s3">=</span><span class="s1">gcolidx</span><span class="s3">,</span>
                            <span class="s1">val</span><span class="s3">=</span><span class="s1">values</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span>
                            <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                            <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx_index&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                            <span class="s1">css_row</span><span class="s3">=</span><span class="s1">i</span><span class="s3">,</span>
                            <span class="s1">css_col</span><span class="s3">=</span><span class="s1">gcolidx</span><span class="s3">,</span>
                            <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                            <span class="s1">mergestart</span><span class="s3">=</span><span class="s1">mergestart</span><span class="s3">,</span>
                            <span class="s1">mergeend</span><span class="s3">=</span><span class="s1">mergeend</span><span class="s3">,</span>
                        <span class="s3">)</span>
                    <span class="s1">gcolidx </span><span class="s3">+= </span><span class="s6">1</span>

            <span class="s2">else</span><span class="s3">:</span>
                <span class="s5"># Format hierarchical rows with non-merged values.</span>
                <span class="s2">for </span><span class="s1">indexcolvals </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">):</span>
                    <span class="s2">for </span><span class="s1">idx</span><span class="s3">, </span><span class="s1">indexcolval </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">indexcolvals</span><span class="s3">):</span>
                        <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                            <span class="s1">row</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+ </span><span class="s1">idx</span><span class="s3">,</span>
                            <span class="s1">col</span><span class="s3">=</span><span class="s1">gcolidx</span><span class="s3">,</span>
                            <span class="s1">val</span><span class="s3">=</span><span class="s1">indexcolval</span><span class="s3">,</span>
                            <span class="s1">style</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header_style</span><span class="s3">,</span>
                            <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx_index&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                            <span class="s1">css_row</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">,</span>
                            <span class="s1">css_col</span><span class="s3">=</span><span class="s1">gcolidx</span><span class="s3">,</span>
                            <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                        <span class="s3">)</span>
                    <span class="s1">gcolidx </span><span class="s3">+= </span><span class="s6">1</span>

        <span class="s2">yield from </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_generate_body</span><span class="s3">(</span><span class="s1">gcolidx</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_has_aliases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Whether the aliases for column names are present.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">is_list_like</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">header</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_generate_body</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">coloffset</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s5"># Write the body of the frame data series by series.</span>
        <span class="s2">for </span><span class="s1">colidx </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">)):</span>
            <span class="s1">series </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[:, </span><span class="s1">colidx</span><span class="s3">]</span>
            <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">series</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">CssExcelCell</span><span class="s3">(</span>
                    <span class="s1">row</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rowcounter </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">,</span>
                    <span class="s1">col</span><span class="s3">=</span><span class="s1">colidx </span><span class="s3">+ </span><span class="s1">coloffset</span><span class="s3">,</span>
                    <span class="s1">val</span><span class="s3">=</span><span class="s1">val</span><span class="s3">,</span>
                    <span class="s1">style</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                    <span class="s1">css_styles</span><span class="s3">=</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">styler</span><span class="s3">, </span><span class="s4">&quot;ctx&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">),</span>
                    <span class="s1">css_row</span><span class="s3">=</span><span class="s1">i</span><span class="s3">,</span>
                    <span class="s1">css_col</span><span class="s3">=</span><span class="s1">colidx</span><span class="s3">,</span>
                    <span class="s1">css_converter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">style_converter</span><span class="s3">,</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_formatted_cells</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterable</span><span class="s3">[</span><span class="s1">ExcelCell</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">cell </span><span class="s2">in </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">chain</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_header</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_body</span><span class="s3">()):</span>
            <span class="s1">cell</span><span class="s3">.</span><span class="s1">val </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_format_value</span><span class="s3">(</span><span class="s1">cell</span><span class="s3">.</span><span class="s1">val</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s1">cell</span>

    <span class="s3">@</span><span class="s1">doc</span><span class="s3">(</span><span class="s1">storage_options</span><span class="s3">=</span><span class="s1">_shared_docs</span><span class="s3">[</span><span class="s4">&quot;storage_options&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">writer</span><span class="s3">: </span><span class="s1">FilePath </span><span class="s3">| </span><span class="s1">WriteExcelBuffer </span><span class="s3">| </span><span class="s1">ExcelWriter</span><span class="s3">,</span>
        <span class="s1">sheet_name</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;Sheet1&quot;</span><span class="s3">,</span>
        <span class="s1">startrow</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">startcol</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">freeze_panes</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">engine</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">storage_options</span><span class="s3">: </span><span class="s1">StorageOptions </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">engine_kwargs</span><span class="s3">: </span><span class="s1">dict </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot; 
        writer : path-like, file-like, or ExcelWriter object 
            File path or existing ExcelWriter 
        sheet_name : str, default 'Sheet1' 
            Name of sheet which will contain DataFrame 
        startrow : 
            upper left cell row to dump data frame 
        startcol : 
            upper left cell column to dump data frame 
        freeze_panes : tuple of integer (length 2), default None 
            Specifies the one-based bottommost row and rightmost column that 
            is to be frozen 
        engine : string, default None 
            write engine to use if writer is a path - you can also set this 
            via the options ``io.excel.xlsx.writer``, 
            or ``io.excel.xlsm.writer``. 
 
        {storage_options} 
 
        engine_kwargs: dict, optional 
            Arbitrary keyword arguments passed to excel engine. 
        &quot;&quot;&quot;</span>
        <span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">excel </span><span class="s2">import </span><span class="s1">ExcelWriter</span>

        <span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">df</span><span class="s3">.</span><span class="s1">shape</span>
        <span class="s2">if </span><span class="s1">num_rows </span><span class="s3">&gt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">max_rows </span><span class="s2">or </span><span class="s1">num_cols </span><span class="s3">&gt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">max_cols</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s4">f&quot;This sheet is too large! Your sheet size is: </span><span class="s2">{</span><span class="s1">num_rows</span><span class="s2">}</span><span class="s4">, </span><span class="s2">{</span><span class="s1">num_cols</span><span class="s2">} </span><span class="s4">&quot;</span>
                <span class="s4">f&quot;Max sheet size is: </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">max_rows</span><span class="s2">}</span><span class="s4">, </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">max_cols</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">engine_kwargs </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">engine_kwargs </span><span class="s3">= {}</span>

        <span class="s1">formatted_cells </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_formatted_cells</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">writer</span><span class="s3">, </span><span class="s1">ExcelWriter</span><span class="s3">):</span>
            <span class="s1">need_save </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">writer </span><span class="s3">= </span><span class="s1">ExcelWriter</span><span class="s3">(</span>
                <span class="s1">writer</span><span class="s3">,</span>
                <span class="s1">engine</span><span class="s3">=</span><span class="s1">engine</span><span class="s3">,</span>
                <span class="s1">storage_options</span><span class="s3">=</span><span class="s1">storage_options</span><span class="s3">,</span>
                <span class="s1">engine_kwargs</span><span class="s3">=</span><span class="s1">engine_kwargs</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">need_save </span><span class="s3">= </span><span class="s2">True</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">writer</span><span class="s3">.</span><span class="s1">_write_cells</span><span class="s3">(</span>
                <span class="s1">formatted_cells</span><span class="s3">,</span>
                <span class="s1">sheet_name</span><span class="s3">,</span>
                <span class="s1">startrow</span><span class="s3">=</span><span class="s1">startrow</span><span class="s3">,</span>
                <span class="s1">startcol</span><span class="s3">=</span><span class="s1">startcol</span><span class="s3">,</span>
                <span class="s1">freeze_panes</span><span class="s3">=</span><span class="s1">freeze_panes</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s5"># make sure to close opened file handles</span>
            <span class="s2">if </span><span class="s1">need_save</span><span class="s3">:</span>
                <span class="s1">writer</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
</pre>
</body>
</html>