<html>
<head>
<title>test_animation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_animation.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">weakref</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">animation</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">anim</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Create a simple animation (with options).&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">line</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([], [])</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">():</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">([], [])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s2">,</span>

    <span class="s0">def </span><span class="s1">animate</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">i</span><span class="s2">)</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s2">,</span>

    <span class="s5"># &quot;klass&quot; can be passed to determine the class returned by the fixture</span>
    <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s6">'param'</span><span class="s2">, {}))  </span><span class="s5"># make a copy</span>
    <span class="s1">klass </span><span class="s2">= </span><span class="s1">kwargs</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s6">'klass'</span><span class="s2">, </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s6">'frames' </span><span class="s0">not in </span><span class="s1">kwargs</span><span class="s2">:</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s6">'frames'</span><span class="s2">] = </span><span class="s4">5</span>
    <span class="s0">return </span><span class="s1">klass</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">func</span><span class="s2">=</span><span class="s1">animate</span><span class="s2">, </span><span class="s1">init_func</span><span class="s2">=</span><span class="s1">init</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">NullMovieWriter</span><span class="s2">(</span><span class="s1">animation</span><span class="s2">.</span><span class="s1">AbstractMovieWriter</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    A minimal MovieWriter.  It doesn't actually write anything. 
    It just saves the arguments that were given to the setup() and 
    grab_frame() methods as attributes, and counts how many times 
    grab_frame() is called. 
 
    This class doesn't have an __init__ method with the appropriate 
    signature, and it doesn't define an isAvailable() method, so 
    it cannot be added to the 'writers' registry. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">setup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">, </span><span class="s1">outfile</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fig </span><span class="s2">= </span><span class="s1">fig</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">outfile </span><span class="s2">= </span><span class="s1">outfile</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">= </span><span class="s1">dpi</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_count </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">grab_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">savefig_kwargs</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">animation </span><span class="s0">import </span><span class="s1">_validate_grabframe_kwargs</span>
        <span class="s1">_validate_grabframe_kwargs</span><span class="s2">(</span><span class="s1">savefig_kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">savefig_kwargs </span><span class="s2">= </span><span class="s1">savefig_kwargs</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_count </span><span class="s2">+= </span><span class="s4">1</span>

    <span class="s0">def </span><span class="s1">finish</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_null_movie_writer</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s5"># Test running an animation with NullMovieWriter.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">&quot;savefig.facecolor&quot;</span><span class="s2">] = </span><span class="s6">&quot;auto&quot;</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s6">&quot;unused.null&quot;</span>
    <span class="s1">dpi </span><span class="s2">= </span><span class="s4">50</span>
    <span class="s1">savefig_kwargs </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">foo</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">writer </span><span class="s2">= </span><span class="s1">NullMovieWriter</span><span class="s2">()</span>

    <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s1">dpi</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">=</span><span class="s1">writer</span><span class="s2">,</span>
              <span class="s1">savefig_kwargs</span><span class="s2">=</span><span class="s1">savefig_kwargs</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">fig </span><span class="s2">== </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)  </span><span class="s5"># The figure used by anim fixture</span>
    <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">outfile </span><span class="s2">== </span><span class="s1">filename</span>
    <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">== </span><span class="s1">dpi</span>
    <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">args </span><span class="s2">== ()</span>
    <span class="s5"># we enrich the savefig kwargs to ensure we composite transparent</span>
    <span class="s5"># output to an opaque background</span>
    <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">savefig_kwargs</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">savefig_kwargs</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] == </span><span class="s1">v</span>
    <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">_count </span><span class="s2">== </span><span class="s1">anim</span><span class="s2">.</span><span class="s1">_save_count</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_animation_delete</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">python_implementation</span><span class="s2">() == </span><span class="s6">'PyPy'</span><span class="s2">:</span>
        <span class="s5"># Something in the test setup fixture lingers around into the test and</span>
        <span class="s5"># breaks pytest.warns on PyPy. This garbage collection fixes it.</span>
        <span class="s5"># https://foss.heptapod.net/pypy/pypy/-/issues/3536</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>
    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(**</span><span class="s1">anim</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">Warning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">'Animation was deleted'</span><span class="s2">):</span>
        <span class="s0">del </span><span class="s1">anim</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_movie_writer_dpi_default</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">DummyMovieWriter</span><span class="s2">(</span><span class="s1">animation</span><span class="s2">.</span><span class="s1">MovieWriter</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">_run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">pass</span>

    <span class="s5"># Test setting up movie writer with figure.dpi default.</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s1">filename </span><span class="s2">= </span><span class="s6">&quot;unused.null&quot;</span>
    <span class="s1">fps </span><span class="s2">= </span><span class="s4">5</span>
    <span class="s1">codec </span><span class="s2">= </span><span class="s6">&quot;unused&quot;</span>
    <span class="s1">bitrate </span><span class="s2">= </span><span class="s4">1</span>
    <span class="s1">extra_args </span><span class="s2">= [</span><span class="s6">&quot;unused&quot;</span><span class="s2">]</span>

    <span class="s1">writer </span><span class="s2">= </span><span class="s1">DummyMovieWriter</span><span class="s2">(</span><span class="s1">fps</span><span class="s2">, </span><span class="s1">codec</span><span class="s2">, </span><span class="s1">bitrate</span><span class="s2">, </span><span class="s1">extra_args</span><span class="s2">)</span>
    <span class="s1">writer</span><span class="s2">.</span><span class="s1">setup</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">dpi </span><span class="s2">== </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span>


<span class="s2">@</span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">register</span><span class="s2">(</span><span class="s6">'null'</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">RegisteredNullMovieWriter</span><span class="s2">(</span><span class="s1">NullMovieWriter</span><span class="s2">):</span>

    <span class="s5"># To be able to add NullMovieWriter to the 'writers' registry,</span>
    <span class="s5"># we must define an __init__ method with a specific signature,</span>
    <span class="s5"># and we must define the class method isAvailable().</span>
    <span class="s5"># (These methods are not actually required to use an instance</span>
    <span class="s5"># of this class as the 'writer' argument of Animation.save().)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">fps</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">codec</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">bitrate</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                 <span class="s1">extra_args</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">isAvailable</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s0">return True</span>


<span class="s1">WRITER_OUTPUT </span><span class="s2">= [</span>
    <span class="s2">(</span><span class="s6">'ffmpeg'</span><span class="s2">, </span><span class="s6">'movie.mp4'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'ffmpeg_file'</span><span class="s2">, </span><span class="s6">'movie.mp4'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'imagemagick'</span><span class="s2">, </span><span class="s6">'movie.gif'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'imagemagick_file'</span><span class="s2">, </span><span class="s6">'movie.gif'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'pillow'</span><span class="s2">, </span><span class="s6">'movie.gif'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'html'</span><span class="s2">, </span><span class="s6">'movie.html'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'null'</span><span class="s2">, </span><span class="s6">'movie.null'</span><span class="s2">)</span>
<span class="s2">]</span>


<span class="s0">def </span><span class="s1">gen_writers</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">output </span><span class="s0">in </span><span class="s1">WRITER_OUTPUT</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">is_available</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">):</span>
            <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span>
                <span class="s6">f&quot;writer '</span><span class="s0">{</span><span class="s1">writer</span><span class="s0">}</span><span class="s6">' not available on this system&quot;</span><span class="s2">)</span>
            <span class="s0">yield </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">mark</span><span class="s2">])</span>
            <span class="s0">yield </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">output</span><span class="s2">), </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">mark</span><span class="s2">])</span>
            <span class="s0">continue</span>

        <span class="s1">writer_class </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">[</span><span class="s1">writer</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">frame_format </span><span class="s0">in </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">writer_class</span><span class="s2">, </span><span class="s6">'supported_formats'</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">]):</span>
            <span class="s0">yield </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">frame_format</span><span class="s2">, </span><span class="s1">output</span>
            <span class="s0">yield </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">frame_format</span><span class="s2">, </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>


<span class="s5"># Smoke test for saving animations.  In the future, we should probably</span>
<span class="s5"># design more sophisticated tests which compare resulting frames a-la</span>
<span class="s5"># matplotlib.testing.image_comparison</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'writer, frame_format, output'</span><span class="s2">, </span><span class="s1">gen_writers</span><span class="s2">())</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_save_animation_smoketest</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">frame_format</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">frame_format </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">&quot;animation.frame_format&quot;</span><span class="s2">] = </span><span class="s1">frame_format</span>
    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(**</span><span class="s1">anim</span><span class="s2">)</span>
    <span class="s1">dpi </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">codec </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s1">writer </span><span class="s2">== </span><span class="s6">'ffmpeg'</span><span class="s2">:</span>
        <span class="s5"># Issue #8253</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">_fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">((</span><span class="s4">10.85</span><span class="s2">, </span><span class="s4">9.21</span><span class="s2">))</span>
        <span class="s1">dpi </span><span class="s2">= </span><span class="s4">100.</span>
        <span class="s1">codec </span><span class="s2">= </span><span class="s6">'h264'</span>

    <span class="s5"># Use temporary directory for the file-based writers, which produce a file</span>
    <span class="s5"># per frame with known names.</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">fps</span><span class="s2">=</span><span class="s4">30</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">=</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">bitrate</span><span class="s2">=</span><span class="s4">500</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">=</span><span class="s1">dpi</span><span class="s2">,</span>
                  <span class="s1">codec</span><span class="s2">=</span><span class="s1">codec</span><span class="s2">)</span>

    <span class="s0">del </span><span class="s1">anim</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'writer, frame_format, output'</span><span class="s2">, </span><span class="s1">gen_writers</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_grabframe</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">frame_format</span><span class="s2">, </span><span class="s1">output</span><span class="s2">):</span>
    <span class="s1">WriterClass </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">[</span><span class="s1">writer</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">frame_format </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">&quot;animation.frame_format&quot;</span><span class="s2">] = </span><span class="s1">frame_format</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">dpi </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">codec </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s1">writer </span><span class="s2">== </span><span class="s6">'ffmpeg'</span><span class="s2">:</span>
        <span class="s5"># Issue #8253</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">((</span><span class="s4">10.85</span><span class="s2">, </span><span class="s4">9.21</span><span class="s2">))</span>
        <span class="s1">dpi </span><span class="s2">= </span><span class="s4">100.</span>
        <span class="s1">codec </span><span class="s2">= </span><span class="s6">'h264'</span>

    <span class="s1">test_writer </span><span class="s2">= </span><span class="s1">WriterClass</span><span class="s2">()</span>
    <span class="s5"># Use temporary directory for the file-based writers, which produce a file</span>
    <span class="s5"># per frame with known names.</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">test_writer</span><span class="s2">.</span><span class="s1">saving</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">dpi</span><span class="s2">):</span>
            <span class="s5"># smoke test it works</span>
            <span class="s1">test_writer</span><span class="s2">.</span><span class="s1">grab_frame</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">{</span><span class="s6">'dpi'</span><span class="s2">, </span><span class="s6">'bbox_inches'</span><span class="s2">, </span><span class="s6">'format'</span><span class="s2">}:</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                        <span class="s1">TypeError</span><span class="s2">,</span>
                        <span class="s1">match</span><span class="s2">=</span><span class="s6">f&quot;grab_frame got an unexpected keyword argument </span><span class="s0">{</span><span class="s1">k</span><span class="s0">!r}</span><span class="s6">&quot;</span>
                <span class="s2">):</span>
                    <span class="s1">test_writer</span><span class="s2">.</span><span class="s1">grab_frame</span><span class="s2">(**{</span><span class="s1">k</span><span class="s2">: </span><span class="s1">object</span><span class="s2">()})</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'writer'</span><span class="s2">, [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
        <span class="s6">'ffmpeg'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FFMpegWriter</span><span class="s2">.</span><span class="s1">isAvailable</span><span class="s2">(),</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s6">'Requires FFMpeg'</span><span class="s2">)),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
        <span class="s6">'imagemagick'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
            <span class="s0">not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">ImageMagickWriter</span><span class="s2">.</span><span class="s1">isAvailable</span><span class="s2">(),</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s6">'Requires ImageMagick'</span><span class="s2">)),</span>
<span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'html, want'</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s6">'none'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'html5'</span><span class="s2">, </span><span class="s6">'&lt;video width'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s6">'jshtml'</span><span class="s2">, </span><span class="s6">'&lt;script '</span><span class="s2">)</span>
<span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_animation_repr_html</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">html</span><span class="s2">, </span><span class="s1">want</span><span class="s2">, </span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">python_implementation</span><span class="s2">() == </span><span class="s6">'PyPy'</span><span class="s2">:</span>
        <span class="s5"># Something in the test setup fixture lingers around into the test and</span>
        <span class="s5"># breaks pytest.warns on PyPy. This garbage collection fixes it.</span>
        <span class="s5"># https://foss.heptapod.net/pypy/pypy/-/issues/3536</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">writer </span><span class="s2">== </span><span class="s6">'imagemagick' </span><span class="s0">and </span><span class="s1">html </span><span class="s2">== </span><span class="s6">'html5'</span>
            <span class="s5"># ImageMagick delegates to ffmpeg for this format.</span>
            <span class="s0">and not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FFMpegWriter</span><span class="s2">.</span><span class="s1">isAvailable</span><span class="s2">()):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s6">'Requires FFMpeg'</span><span class="s2">)</span>
    <span class="s5"># create here rather than in the fixture otherwise we get __del__ warnings</span>
    <span class="s5"># about producing no output</span>
    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(**</span><span class="s1">anim</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s6">'animation.writer'</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">,</span>
                         <span class="s6">'animation.html'</span><span class="s2">: </span><span class="s1">html</span><span class="s2">}):</span>
        <span class="s1">html </span><span class="s2">= </span><span class="s1">anim</span><span class="s2">.</span><span class="s1">_repr_html_</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">want </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">html </span><span class="s0">is None</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s0">del </span><span class="s1">anim  </span><span class="s5"># Animation was never run, so will warn on cleanup.</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">want </span><span class="s0">in </span><span class="s1">html</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">'anim'</span><span class="s2">,</span>
    <span class="s2">[{</span><span class="s6">'save_count'</span><span class="s2">: </span><span class="s4">10</span><span class="s2">, </span><span class="s6">'frames'</span><span class="s2">: </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))}],</span>
    <span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_no_length_frames</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s6">'unused.null'</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">=</span><span class="s1">NullMovieWriter</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_movie_writer_registry</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">_registered</span><span class="s2">) &gt; </span><span class="s4">0</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">'animation.ffmpeg_path'</span><span class="s2">] = </span><span class="s6">&quot;not_available_ever_xxxx&quot;</span>
    <span class="s0">assert not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">is_available</span><span class="s2">(</span><span class="s6">&quot;ffmpeg&quot;</span><span class="s2">)</span>
    <span class="s5"># something guaranteed to be available in path and exits immediately</span>
    <span class="s1">bin </span><span class="s2">= </span><span class="s6">&quot;true&quot; </span><span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s6">'win32' </span><span class="s0">else </span><span class="s6">&quot;where&quot;</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">'animation.ffmpeg_path'</span><span class="s2">] = </span><span class="s1">bin</span>
    <span class="s0">assert </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">is_available</span><span class="s2">(</span><span class="s6">&quot;ffmpeg&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;method_name&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s6">&quot;to_html5_video&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
        <span class="s0">not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">is_available</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">&quot;animation.writer&quot;</span><span class="s2">]),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;animation writer not installed&quot;</span><span class="s2">)),</span>
     <span class="s6">&quot;to_jshtml&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">frames</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_embed_limit</span><span class="s2">(</span><span class="s1">method_name</span><span class="s2">, </span><span class="s1">caplog</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s1">caplog</span><span class="s2">.</span><span class="s1">set_level</span><span class="s2">(</span><span class="s6">&quot;WARNING&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s6">&quot;animation.embed_limit&quot;</span><span class="s2">: </span><span class="s4">1e-6</span><span class="s2">}):  </span><span class="s5"># ~1 byte.</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">, </span><span class="s1">method_name</span><span class="s2">)()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">caplog</span><span class="s2">.</span><span class="s1">records</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s1">record</span><span class="s2">, = </span><span class="s1">caplog</span><span class="s2">.</span><span class="s1">records</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">record</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s6">&quot;matplotlib.animation&quot;</span>
            <span class="s0">and </span><span class="s1">record</span><span class="s2">.</span><span class="s1">levelname </span><span class="s2">== </span><span class="s6">&quot;WARNING&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s6">&quot;method_name&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s6">&quot;to_html5_video&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
        <span class="s0">not </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">writers</span><span class="s2">.</span><span class="s1">is_available</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s6">&quot;animation.writer&quot;</span><span class="s2">]),</span>
        <span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;animation writer not installed&quot;</span><span class="s2">)),</span>
     <span class="s6">&quot;to_jshtml&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">frames</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_cleanup_temporaries</span><span class="s2">(</span><span class="s1">method_name</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">, </span><span class="s1">method_name</span><span class="s2">)()</span>
        <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">)).</span><span class="s1">iterdir</span><span class="s2">()) == []</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">shutil</span><span class="s2">.</span><span class="s1">which</span><span class="s2">(</span><span class="s6">&quot;/bin/sh&quot;</span><span class="s2">) </span><span class="s0">is None</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;requires a POSIX OS&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_failing_ffmpeg</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Test that we correctly raise a CalledProcessError when ffmpeg fails. 
 
    To do so, mock ffmpeg using a simple executable shell script that 
    succeeds when called with no arguments (so that it gets registered by 
    `isAvailable`), but fails otherwise, and add it to the $PATH. 
    &quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s6">&quot;PATH&quot;</span><span class="s2">, </span><span class="s6">&quot;.:&quot; </span><span class="s2">+ </span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">[</span><span class="s6">&quot;PATH&quot;</span><span class="s2">])</span>
        <span class="s1">exe_path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">str</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">), </span><span class="s6">&quot;ffmpeg&quot;</span><span class="s2">)</span>
        <span class="s1">exe_path</span><span class="s2">.</span><span class="s1">write_bytes</span><span class="s2">(</span><span class="s7">b&quot;#!/bin/sh</span><span class="s0">\n</span><span class="s7">[[ $@ -eq 0 ]]</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s1">os</span><span class="s2">.</span><span class="s1">chmod</span><span class="s2">(</span><span class="s1">exe_path</span><span class="s2">, </span><span class="s4">0o755</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">CalledProcessError</span><span class="s2">):</span>
            <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s6">&quot;test.mpeg&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;cache_frame_data&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_funcanimation_cache_frame_data</span><span class="s2">(</span><span class="s1">cache_frame_data</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">line</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([], [])</span>

    <span class="s0">class </span><span class="s1">Frame</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">):</span>
        <span class="s5"># this subclassing enables to use weakref.ref()</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">():</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">([], [])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s2">,</span>

    <span class="s0">def </span><span class="s1">animate</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">):</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">[</span><span class="s6">'x'</span><span class="s2">], </span><span class="s1">frame</span><span class="s2">[</span><span class="s6">'y'</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s2">,</span>

    <span class="s1">frames_generated </span><span class="s2">= []</span>

    <span class="s0">def </span><span class="s1">frames_generator</span><span class="s2">():</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

            <span class="s1">frame </span><span class="s2">= </span><span class="s1">Frame</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>

            <span class="s5"># collect weak references to frames</span>
            <span class="s5"># to validate their references later</span>
            <span class="s1">frames_generated</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">weakref</span><span class="s2">.</span><span class="s1">ref</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">))</span>

            <span class="s0">yield </span><span class="s1">frame</span>

    <span class="s1">MAX_FRAMES </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">animate</span><span class="s2">, </span><span class="s1">init_func</span><span class="s2">=</span><span class="s1">init</span><span class="s2">,</span>
                                   <span class="s1">frames</span><span class="s2">=</span><span class="s1">frames_generator</span><span class="s2">,</span>
                                   <span class="s1">cache_frame_data</span><span class="s2">=</span><span class="s1">cache_frame_data</span><span class="s2">,</span>
                                   <span class="s1">save_count</span><span class="s2">=</span><span class="s1">MAX_FRAMES</span><span class="s2">)</span>

    <span class="s1">writer </span><span class="s2">= </span><span class="s1">NullMovieWriter</span><span class="s2">()</span>
    <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s6">'unused.null'</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">=</span><span class="s1">writer</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">frames_generated</span><span class="s2">) == </span><span class="s4">5</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">frames_generated</span><span class="s2">:</span>
        <span class="s5"># If cache_frame_data is True, then the weakref should be alive;</span>
        <span class="s5"># if cache_frame_data is False, then the weakref should be dead (None).</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">f</span><span class="s2">() </span><span class="s0">is None</span><span class="s2">) != </span><span class="s1">cache_frame_data</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'return_value'</span><span class="s2">, [</span>
    <span class="s5"># User forgot to return (returns None).</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s5"># User returned a string.</span>
    <span class="s6">'string'</span><span class="s2">,</span>
    <span class="s5"># User returned an int.</span>
    <span class="s4">1</span><span class="s2">,</span>
    <span class="s5"># User returns a sequence of other objects, e.g., string instead of Artist.</span>
    <span class="s2">(</span><span class="s6">'string'</span><span class="s2">, ),</span>
    <span class="s5"># User forgot to return a sequence (handled in `animate` below.)</span>
    <span class="s6">'artist'</span><span class="s2">,</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_draw_frame</span><span class="s2">(</span><span class="s1">return_value</span><span class="s2">):</span>
    <span class="s5"># test _draw_frame method</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">line</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([])</span>

    <span class="s0">def </span><span class="s1">animate</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s5"># general update func</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">return_value </span><span class="s2">== </span><span class="s6">'artist'</span><span class="s2">:</span>
            <span class="s5"># *not* a sequence</span>
            <span class="s0">return </span><span class="s1">line</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">return_value</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
        <span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
            <span class="s1">fig</span><span class="s2">, </span><span class="s1">animate</span><span class="s2">, </span><span class="s1">blit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">cache_frame_data</span><span class="s2">=</span><span class="s0">False</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_exhausted_animation</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[]</span>

    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">update</span><span class="s2">, </span><span class="s1">frames</span><span class="s2">=</span><span class="s1">iter</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)), </span><span class="s1">repeat</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">cache_frame_data</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s6">&quot;test.gif&quot;</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">=</span><span class="s6">'pillow'</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;exhausted&quot;</span><span class="s2">):</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">_start</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_no_frame_warning</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">update</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[]</span>

    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">update</span><span class="s2">, </span><span class="s1">frames</span><span class="s2">=[], </span><span class="s1">repeat</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">cache_frame_data</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s6">&quot;exhausted&quot;</span><span class="s2">):</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">_start</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s6">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_animation_frame</span><span class="s2">(</span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s5"># Test the expected image after iterating through a few frames</span>
    <span class="s5"># we save the animation to get the iteration because we are not</span>
    <span class="s5"># in an interactive framework.</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
    <span class="s1">line</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([], [])</span>

    <span class="s0">def </span><span class="s1">init</span><span class="s2">():</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">([], [])</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s2">,</span>

    <span class="s0">def </span><span class="s1">animate</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
        <span class="s1">line</span><span class="s2">.</span><span class="s1">set_data</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">i </span><span class="s2">/ </span><span class="s4">100</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">line</span><span class="s2">,</span>

    <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
        <span class="s1">fig_test</span><span class="s2">, </span><span class="s1">animate</span><span class="s2">, </span><span class="s1">init_func</span><span class="s2">=</span><span class="s1">init</span><span class="s2">, </span><span class="s1">frames</span><span class="s2">=</span><span class="s4">5</span><span class="s2">,</span>
        <span class="s1">blit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tmpdir</span><span class="s2">.</span><span class="s1">as_cwd</span><span class="s2">():</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s6">&quot;test.gif&quot;</span><span class="s2">)</span>

    <span class="s5"># Reference figure without animation</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s5"># 5th frame's data</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s4">4 </span><span class="s2">/ </span><span class="s4">100</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_save_count_override_warnings_has_length</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>

    <span class="s1">save_count </span><span class="s2">= </span><span class="s4">5</span>
    <span class="s1">frames </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">match_target </span><span class="s2">= (</span>
        <span class="s6">f'You passed in an explicit </span><span class="s0">{</span><span class="s1">save_count</span><span class="s2">=</span><span class="s0">} </span><span class="s6">'</span>
        <span class="s6">&quot;which is being ignored in favor of &quot;</span>
        <span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">len</span><span class="s2">(</span><span class="s1">frames</span><span class="s2">)=</span><span class="s0">}</span><span class="s6">.&quot;</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">match_target</span><span class="s2">)):</span>
        <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
            <span class="s2">**{**</span><span class="s1">anim</span><span class="s2">, </span><span class="s6">'frames'</span><span class="s2">: </span><span class="s1">frames</span><span class="s2">, </span><span class="s6">'save_count'</span><span class="s2">: </span><span class="s1">save_count</span><span class="s2">}</span>
        <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">anim</span><span class="s2">.</span><span class="s1">_save_count </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">frames</span><span class="s2">)</span>
    <span class="s1">anim</span><span class="s2">.</span><span class="s1">_init_draw</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_save_count_override_warnings_scaler</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s1">save_count </span><span class="s2">= </span><span class="s4">5</span>
    <span class="s1">frames </span><span class="s2">= </span><span class="s4">7</span>
    <span class="s1">match_target </span><span class="s2">= (</span>
        <span class="s6">f'You passed in an explicit </span><span class="s0">{</span><span class="s1">save_count</span><span class="s2">=</span><span class="s0">} </span><span class="s6">' </span><span class="s2">+</span>
        <span class="s6">&quot;which is being ignored in favor of &quot; </span><span class="s2">+</span>
        <span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">frames</span><span class="s2">=</span><span class="s0">}</span><span class="s6">.&quot;</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">match_target</span><span class="s2">)):</span>
        <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
            <span class="s2">**{**</span><span class="s1">anim</span><span class="s2">, </span><span class="s6">'frames'</span><span class="s2">: </span><span class="s1">frames</span><span class="s2">, </span><span class="s6">'save_count'</span><span class="s2">: </span><span class="s1">save_count</span><span class="s2">}</span>
        <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">anim</span><span class="s2">.</span><span class="s1">_save_count </span><span class="s2">== </span><span class="s1">frames</span>
    <span class="s1">anim</span><span class="s2">.</span><span class="s1">_init_draw</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'anim'</span><span class="s2">, [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">klass</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">)], </span><span class="s1">indirect</span><span class="s2">=[</span><span class="s6">'anim'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_disable_cache_warning</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s1">cache_frame_data </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">frames </span><span class="s2">= </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">match_target </span><span class="s2">= (</span>
        <span class="s6">f&quot;</span><span class="s0">{</span><span class="s1">frames</span><span class="s2">=</span><span class="s0">!r} </span><span class="s6">which we can infer the length of, &quot;</span>
        <span class="s6">&quot;did not pass an explicit *save_count* &quot;</span>
        <span class="s6">f&quot;and passed </span><span class="s0">{</span><span class="s1">cache_frame_data</span><span class="s2">=</span><span class="s0">}</span><span class="s6">.  To avoid a possibly &quot;</span>
        <span class="s6">&quot;unbounded cache, frame data caching has been disabled. &quot;</span>
        <span class="s6">&quot;To suppress this warning either pass &quot;</span>
        <span class="s6">&quot;`cache_frame_data=False` or `save_count=MAX_FRAMES`.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">match_target</span><span class="s2">)):</span>
        <span class="s1">anim </span><span class="s2">= </span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FuncAnimation</span><span class="s2">(</span>
            <span class="s2">**{**</span><span class="s1">anim</span><span class="s2">, </span><span class="s6">'cache_frame_data'</span><span class="s2">: </span><span class="s1">cache_frame_data</span><span class="s2">, </span><span class="s6">'frames'</span><span class="s2">: </span><span class="s1">frames</span><span class="s2">}</span>
        <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">anim</span><span class="s2">.</span><span class="s1">_cache_frame_data </span><span class="s0">is False</span>
    <span class="s1">anim</span><span class="s2">.</span><span class="s1">_init_draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_movie_writer_invalid_path</span><span class="s2">(</span><span class="s1">anim</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s6">&quot;win32&quot;</span><span class="s2">:</span>
        <span class="s1">match_str </span><span class="s2">= </span><span class="s6">r&quot;\[WinError 3] .*'\\\\foo\\\\bar\\\\aardvark'&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">match_str </span><span class="s2">= </span><span class="s6">r&quot;\[Errno 2] .*'/foo&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">FileNotFoundError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match_str</span><span class="s2">):</span>
        <span class="s1">anim</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s6">&quot;/foo/bar/aardvark/thiscannotreallyexist.mp4&quot;</span><span class="s2">,</span>
                  <span class="s1">writer</span><span class="s2">=</span><span class="s1">animation</span><span class="s2">.</span><span class="s1">FFMpegFileWriter</span><span class="s2">())</span>
</pre>
</body>
</html>