<html>
<head>
<title>otConverters.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
otConverters.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">fixedTools </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">fixedToFloat </span><span class="s0">as </span><span class="s1">fi2fl</span><span class="s2">,</span>
    <span class="s1">floatToFixed </span><span class="s0">as </span><span class="s1">fl2fi</span><span class="s2">,</span>
    <span class="s1">floatToFixedToStr </span><span class="s0">as </span><span class="s1">fl2str</span><span class="s2">,</span>
    <span class="s1">strToFixedToFloat </span><span class="s0">as </span><span class="s1">str2fl</span><span class="s2">,</span>
    <span class="s1">ensureVersionIsLong </span><span class="s0">as </span><span class="s1">fi2ve</span><span class="s2">,</span>
    <span class="s1">versionToFixed </span><span class="s0">as </span><span class="s1">ve2fi</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">ttLib</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">.</span><span class="s1">TupleVariation </span><span class="s0">import </span><span class="s1">TupleVariation</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">roundTools </span><span class="s0">import </span><span class="s1">nearestMultipleShortestRepr</span><span class="s2">, </span><span class="s1">otRound</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">textTools </span><span class="s0">import </span><span class="s1">bytesjoin</span><span class="s2">, </span><span class="s1">tobytes</span><span class="s2">, </span><span class="s1">tostr</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">, </span><span class="s1">safeEval</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">lazyTools </span><span class="s0">import </span><span class="s1">LazyList</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">ttLib </span><span class="s0">import </span><span class="s1">getSearchRange</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">otBase </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">CountReference</span><span class="s2">,</span>
    <span class="s1">FormatSwitchingBaseTable</span><span class="s2">,</span>
    <span class="s1">OTTableReader</span><span class="s2">,</span>
    <span class="s1">OTTableWriter</span><span class="s2">,</span>
    <span class="s1">ValueRecordFactory</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">otTables </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">lookupTypes</span><span class="s2">,</span>
    <span class="s1">VarCompositeGlyph</span><span class="s2">,</span>
    <span class="s1">AATStateTable</span><span class="s2">,</span>
    <span class="s1">AATState</span><span class="s2">,</span>
    <span class="s1">AATAction</span><span class="s2">,</span>
    <span class="s1">ContextualMorphAction</span><span class="s2">,</span>
    <span class="s1">LigatureMorphAction</span><span class="s2">,</span>
    <span class="s1">InsertionMorphAction</span><span class="s2">,</span>
    <span class="s1">MorxSubtable</span><span class="s2">,</span>
    <span class="s1">ExtendMode </span><span class="s0">as </span><span class="s1">_ExtendMode</span><span class="s2">,</span>
    <span class="s1">CompositeMode </span><span class="s0">as </span><span class="s1">_CompositeMode</span><span class="s2">,</span>
    <span class="s1">NO_VARIATION_INDEX</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">zip_longest</span><span class="s2">, </span><span class="s1">accumulate</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">SimpleNamespace</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Optional</span>
<span class="s0">import </span><span class="s1">logging</span>


<span class="s1">log </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s1">__name__</span><span class="s2">)</span>
<span class="s1">istuple </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">t</span><span class="s2">: </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">buildConverters</span><span class="s2">(</span><span class="s1">tableSpec</span><span class="s2">, </span><span class="s1">tableNamespace</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Given a table spec from otData.py, build a converter object for each 
    field of the table. This is called for each table in otData.py, and 
    the results are assigned to the corresponding class in otTables.py.&quot;&quot;&quot;</span>
    <span class="s1">converters </span><span class="s2">= []</span>
    <span class="s1">convertersByName </span><span class="s2">= {}</span>
    <span class="s0">for </span><span class="s1">tp</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">descr </span><span class="s0">in </span><span class="s1">tableSpec</span><span class="s2">:</span>
        <span class="s1">tableName </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s0">if </span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;ValueFormat&quot;</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">tp </span><span class="s2">== </span><span class="s4">&quot;uint16&quot;</span>
            <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">ValueFormat</span>
        <span class="s0">elif </span><span class="s1">name</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;Count&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;StructLength&quot;</span><span class="s2">, </span><span class="s4">&quot;MorphType&quot;</span><span class="s2">):</span>
            <span class="s1">converterClass </span><span class="s2">= {</span>
                <span class="s4">&quot;uint8&quot;</span><span class="s2">: </span><span class="s1">ComputedUInt8</span><span class="s2">,</span>
                <span class="s4">&quot;uint16&quot;</span><span class="s2">: </span><span class="s1">ComputedUShort</span><span class="s2">,</span>
                <span class="s4">&quot;uint32&quot;</span><span class="s2">: </span><span class="s1">ComputedULong</span><span class="s2">,</span>
            <span class="s2">}[</span><span class="s1">tp</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;SubTable&quot;</span><span class="s2">:</span>
            <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">SubTable</span>
        <span class="s0">elif </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;ExtSubTable&quot;</span><span class="s2">:</span>
            <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">ExtSubTable</span>
        <span class="s0">elif </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;SubStruct&quot;</span><span class="s2">:</span>
            <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">SubStruct</span>
        <span class="s0">elif </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;FeatureParams&quot;</span><span class="s2">:</span>
            <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">FeatureParams</span>
        <span class="s0">elif </span><span class="s1">name </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;CIDGlyphMapping&quot;</span><span class="s2">, </span><span class="s4">&quot;GlyphCIDMapping&quot;</span><span class="s2">):</span>
            <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">StructWithLength</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">tp </span><span class="s0">in </span><span class="s1">converterMapping </span><span class="s0">and </span><span class="s4">&quot;(&quot; </span><span class="s0">not in </span><span class="s1">tp</span><span class="s2">:</span>
                <span class="s1">tableName </span><span class="s2">= </span><span class="s1">tp</span>
                <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">Struct</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">converterClass </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tableNamespace</span><span class="s2">, </span><span class="s1">converterMapping</span><span class="s2">)</span>

        <span class="s1">conv </span><span class="s2">= </span><span class="s1">converterClass</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">description</span><span class="s2">=</span><span class="s1">descr</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">:</span>
            <span class="s5"># A &quot;template&quot; such as OffsetTo(AType) knows the table class already</span>
            <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">tableClass</span>
        <span class="s0">elif </span><span class="s1">tp </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;MortChain&quot;</span><span class="s2">, </span><span class="s4">&quot;MortSubtable&quot;</span><span class="s2">, </span><span class="s4">&quot;MorxChain&quot;</span><span class="s2">):</span>
            <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">tableNamespace</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tp</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">tableNamespace</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">tableName</span><span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">:</span>
            <span class="s1">conv</span><span class="s2">.</span><span class="s1">tableClass </span><span class="s2">= </span><span class="s1">tableClass</span>

        <span class="s0">if </span><span class="s1">name </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;SubTable&quot;</span><span class="s2">, </span><span class="s4">&quot;ExtSubTable&quot;</span><span class="s2">, </span><span class="s4">&quot;SubStruct&quot;</span><span class="s2">]:</span>
            <span class="s1">conv</span><span class="s2">.</span><span class="s1">lookupTypes </span><span class="s2">= </span><span class="s1">tableNamespace</span><span class="s2">[</span><span class="s4">&quot;lookupTypes&quot;</span><span class="s2">]</span>
            <span class="s5"># also create reverse mapping</span>
            <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">lookupTypes</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s0">for </span><span class="s1">cls </span><span class="s0">in </span><span class="s1">t</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                    <span class="s1">convertersByName</span><span class="s2">[</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">] = </span><span class="s1">Table</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;FeatureParams&quot;</span><span class="s2">:</span>
            <span class="s1">conv</span><span class="s2">.</span><span class="s1">featureParamTypes </span><span class="s2">= </span><span class="s1">tableNamespace</span><span class="s2">[</span><span class="s4">&quot;featureParamTypes&quot;</span><span class="s2">]</span>
            <span class="s1">conv</span><span class="s2">.</span><span class="s1">defaultFeatureParams </span><span class="s2">= </span><span class="s1">tableNamespace</span><span class="s2">[</span><span class="s4">&quot;FeatureParams&quot;</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">cls </span><span class="s0">in </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">featureParamTypes</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s1">convertersByName</span><span class="s2">[</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">] = </span><span class="s1">Table</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">)</span>
        <span class="s1">converters</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">conv</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">convertersByName</span><span class="s2">, </span><span class="s1">name</span>
        <span class="s1">convertersByName</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">conv</span>
    <span class="s0">return </span><span class="s1">converters</span><span class="s2">, </span><span class="s1">convertersByName</span>


<span class="s0">class </span><span class="s1">BaseConverter</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Base class for converter objects. Apart from the constructor, this 
    is an abstract class.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *, </span><span class="s1">description</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">repeat </span><span class="s2">= </span><span class="s1">repeat</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">aux </span><span class="s2">= </span><span class="s1">aux</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aux </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">aux </span><span class="s2">= </span><span class="s1">compile</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">aux</span><span class="s2">, </span><span class="s4">&quot;&lt;string&gt;&quot;</span><span class="s2">, </span><span class="s4">&quot;eval&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass </span><span class="s2">= </span><span class="s1">tableClass</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">isCount </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;Count&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">name </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s4">&quot;DesignAxisRecordSize&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;ValueRecordSize&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">isLookupType </span><span class="s2">= </span><span class="s1">name</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;LookupType&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;MorphType&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">isPropagated </span><span class="s2">= </span><span class="s1">name </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s4">&quot;ClassCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;Class2Count&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;FeatureTag&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;SettingsCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;VarRegionCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;MappingCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;RegionAxisCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;DesignAxisCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;DesignAxisRecordSize&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;AxisValueCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;ValueRecordSize&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;AxisCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;BaseGlyphRecordCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;LayerRecordCount&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;AxisIndicesList&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">description </span><span class="s2">= </span><span class="s1">description</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Read an array of values from the reader.&quot;&quot;&quot;</span>
        <span class="s1">lazy </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">lazy </span><span class="s0">and </span><span class="s1">count </span><span class="s2">&gt; </span><span class="s6">8</span>
        <span class="s0">if </span><span class="s1">lazy</span><span class="s2">:</span>
            <span class="s1">recordSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">getRecordSize</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">recordSize </span><span class="s0">is </span><span class="s1">NotImplemented</span><span class="s2">:</span>
                <span class="s1">lazy </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if not </span><span class="s1">lazy</span><span class="s2">:</span>
            <span class="s1">l </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">):</span>
                <span class="s1">l</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">))</span>
            <span class="s0">return </span><span class="s1">l</span>
        <span class="s0">else</span><span class="s2">:</span>

            <span class="s0">def </span><span class="s1">get_read_item</span><span class="s2">():</span>
                <span class="s1">reader_copy </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span>

                <span class="s0">def </span><span class="s1">read_item</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
                    <span class="s1">reader_copy</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">i </span><span class="s2">* </span><span class="s1">recordSize</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">reader_copy</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, {})</span>

                <span class="s0">return </span><span class="s1">read_item</span>

            <span class="s1">read_item </span><span class="s2">= </span><span class="s1">get_read_item</span><span class="s2">()</span>
            <span class="s1">l </span><span class="s2">= </span><span class="s1">LazyList</span><span class="s2">(</span><span class="s1">read_item </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">))</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">advance</span><span class="s2">(</span><span class="s1">count </span><span class="s2">* </span><span class="s1">recordSize</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s1">l</span>

    <span class="s0">def </span><span class="s1">getRecordSize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;staticSize&quot;</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s0">return </span><span class="s1">NotImplemented</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Read a value from the reader.&quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">values</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s1">e</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= </span><span class="s1">e</span><span class="s2">.</span><span class="s1">args </span><span class="s2">+ (</span><span class="s1">i</span><span class="s2">,)</span>
            <span class="s0">raise</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Write a value to the writer.&quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Read a value from XML.&quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Write a value to XML.&quot;&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s1">varIndexBasePlusOffsetRE </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s4">r&quot;VarIndexBase\s*\+\s*(\d+)&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">getVarIndexOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Optional</span><span class="s2">[</span><span class="s1">int</span><span class="s2">]:</span>
        <span class="s3">&quot;&quot;&quot;If description has `VarIndexBase + {offset}`, return the offset else None.&quot;&quot;&quot;</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">varIndexBasePlusOffsetRE</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">description</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">m</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">group</span><span class="s2">(</span><span class="s6">1</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">SimpleValue</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">toString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))])</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">OptionalValue</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s1">DEFAULT </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DEFAULT</span><span class="s2">:</span>
            <span class="s1">attrs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)))</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s4">&quot;value&quot; </span><span class="s0">in </span><span class="s1">attrs</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">DEFAULT</span>


<span class="s0">class </span><span class="s1">IntValue</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">int</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s6">0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Long</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readLong</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readLongArray</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeLong</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeLongArray</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ULong</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULongArray</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULongArray</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Flags32</span><span class="s2">(</span><span class="s1">ULong</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">toString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">&quot;0x%08X&quot; </span><span class="s2">% </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">VarIndex</span><span class="s2">(</span><span class="s1">OptionalValue</span><span class="s2">, </span><span class="s1">ULong</span><span class="s2">):</span>
    <span class="s1">DEFAULT </span><span class="s2">= </span><span class="s1">NO_VARIATION_INDEX</span>


<span class="s0">class </span><span class="s1">Short</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readShort</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readShortArray</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeShort</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeShortArray</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">UShort</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShortArray</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Int8</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readInt8</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readInt8Array</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeInt8</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeInt8Array</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">UInt8</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">1</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8Array</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt8</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt8Array</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">UInt24</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">3</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt24</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt24</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ComputedInt</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot;%s=%s&quot; </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">value</span><span class="s2">))</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">ComputedUInt8</span><span class="s2">(</span><span class="s1">ComputedInt</span><span class="s2">, </span><span class="s1">UInt8</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ComputedUShort</span><span class="s2">(</span><span class="s1">ComputedInt</span><span class="s2">, </span><span class="s1">UShort</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">ComputedULong</span><span class="s2">(</span><span class="s1">ComputedInt</span><span class="s2">, </span><span class="s1">ULong</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">Tag</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readTag</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeTag</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">GlyphID</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>
    <span class="s1">typecode </span><span class="s2">= </span><span class="s4">&quot;H&quot;</span>

    <span class="s0">def </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">count</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphNameMany</span><span class="s2">(</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typecode</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">, </span><span class="s1">count</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readValue</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typecode</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeArray</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typecode</span><span class="s2">, </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphIDMany</span><span class="s2">(</span><span class="s1">values</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeValue</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">typecode</span><span class="s2">, </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">GlyphID32</span><span class="s2">(</span><span class="s1">GlyphID</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>
    <span class="s1">typecode </span><span class="s2">= </span><span class="s4">&quot;L&quot;</span>


<span class="s0">class </span><span class="s1">NameID</span><span class="s2">(</span><span class="s1">UShort</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)])</span>
        <span class="s0">if </span><span class="s1">font </span><span class="s0">and </span><span class="s1">value</span><span class="s2">:</span>
            <span class="s1">nameTable </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;name&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">nameTable</span><span class="s2">:</span>
                <span class="s1">name </span><span class="s2">= </span><span class="s1">nameTable</span><span class="s2">.</span><span class="s1">getDebugName</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">&quot;  &quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">name</span><span class="s2">:</span>
                    <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot;missing from name table&quot;</span><span class="s2">)</span>
                    <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;name id %d missing from name table&quot; </span><span class="s2">% </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">STATFlags</span><span class="s2">(</span><span class="s1">UShort</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)])</span>
        <span class="s1">flags </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x01</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;OlderSiblingFontAttribute&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x02</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;ElidableAxisValueName&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">flags</span><span class="s2">:</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">&quot;  &quot;</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">))</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">FloatValue</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">float</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">DeciPoints</span><span class="s2">(</span><span class="s1">FloatValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">() / </span><span class="s6">10</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">value </span><span class="s2">* </span><span class="s6">10</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">BaseFixedValue</span><span class="s2">(</span><span class="s1">FloatValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s1">NotImplemented</span>
    <span class="s1">precisionBits </span><span class="s2">= </span><span class="s1">NotImplemented</span>
    <span class="s1">readerMethod </span><span class="s2">= </span><span class="s1">NotImplemented</span>
    <span class="s1">writerMethod </span><span class="s2">= </span><span class="s1">NotImplemented</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fromInt</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readerMethod</span><span class="s2">)())</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">writerMethod</span><span class="s2">)(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">toInt</span><span class="s2">(</span><span class="s1">value</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">fromInt</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fi2fl</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">precisionBits</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">toInt</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fl2fi</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">precisionBits</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">str2fl</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">precisionBits</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">toString</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fl2str</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">precisionBits</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Fixed</span><span class="s2">(</span><span class="s1">BaseFixedValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>
    <span class="s1">precisionBits </span><span class="s2">= </span><span class="s6">16</span>
    <span class="s1">readerMethod </span><span class="s2">= </span><span class="s4">&quot;readLong&quot;</span>
    <span class="s1">writerMethod </span><span class="s2">= </span><span class="s4">&quot;writeLong&quot;</span>


<span class="s0">class </span><span class="s1">F2Dot14</span><span class="s2">(</span><span class="s1">BaseFixedValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>
    <span class="s1">precisionBits </span><span class="s2">= </span><span class="s6">14</span>
    <span class="s1">readerMethod </span><span class="s2">= </span><span class="s4">&quot;readShort&quot;</span>
    <span class="s1">writerMethod </span><span class="s2">= </span><span class="s4">&quot;writeShort&quot;</span>


<span class="s0">class </span><span class="s1">Angle</span><span class="s2">(</span><span class="s1">F2Dot14</span><span class="s2">):</span>
    <span class="s5"># angles are specified in degrees, and encoded as F2Dot14 fractions of half</span>
    <span class="s5"># circle: e.g. 1.0 =&gt; 180, -0.5 =&gt; -90, -2.0 =&gt; -360, etc.</span>
    <span class="s1">bias </span><span class="s2">= </span><span class="s6">0.0</span>
    <span class="s1">factor </span><span class="s2">= </span><span class="s6">1.0 </span><span class="s2">/ (</span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s6">14</span><span class="s2">) * </span><span class="s6">180  </span><span class="s5"># 0.010986328125</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">fromInt</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">super</span><span class="s2">().</span><span class="s1">fromInt</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) + </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">bias</span><span class="s2">) * </span><span class="s6">180</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">toInt</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">super</span><span class="s2">().</span><span class="s1">toInt</span><span class="s2">((</span><span class="s1">value </span><span class="s2">/ </span><span class="s6">180</span><span class="s2">) - </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">bias</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s5"># quantize to nearest multiples of minimum fixed-precision angle</span>
        <span class="s0">return </span><span class="s1">otRound</span><span class="s2">(</span><span class="s1">float</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) / </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">factor</span><span class="s2">) * </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">factor</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">toString</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">nearestMultipleShortestRepr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">factor</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BiasedAngle</span><span class="s2">(</span><span class="s1">Angle</span><span class="s2">):</span>
    <span class="s5"># A bias of 1.0 is used in the representation of start and end angles</span>
    <span class="s5"># of COLRv1 PaintSweepGradients to allow for encoding +360deg</span>
    <span class="s1">bias </span><span class="s2">= </span><span class="s6">1.0</span>


<span class="s0">class </span><span class="s1">Version</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readLong</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= </span><span class="s1">fi2ve</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeLong</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ve2fi</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">toString</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">&quot;0x%08x&quot; </span><span class="s2">% </span><span class="s1">value</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">fromFloat</span><span class="s2">(</span><span class="s1">v</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">fl2fi</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s6">16</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Char64</span><span class="s2">(</span><span class="s1">SimpleValue</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;An ASCII string with up to 64 characters. 
 
    Unused character positions are filled with 0x00 bytes. 
    Used in Apple AAT fonts in the `gcid` table. 
    &quot;&quot;&quot;</span>

    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">64</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readData</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">)</span>
        <span class="s1">zeroPos </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\0</span><span class="s7">&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">zeroPos </span><span class="s2">&gt;= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s1">zeroPos</span><span class="s2">]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">tostr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ascii&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;replace&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">s </span><span class="s2">!= </span><span class="s1">tostr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ascii&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">'replaced non-ASCII characters in &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">s</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">tobytes</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ascii&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;replace&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">data </span><span class="s2">!= </span><span class="s1">tobytes</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;ascii&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;ignore&quot;</span><span class="s2">):</span>
            <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">'replacing non-ASCII characters in &quot;%s&quot;' </span><span class="s2">% </span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) &gt; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">:</span>
            <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span>
                <span class="s4">'truncating overlong &quot;%s&quot; to %d bytes' </span><span class="s2">% (</span><span class="s1">value</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s1">data </span><span class="s2">+ </span><span class="s7">b&quot;</span><span class="s0">\0</span><span class="s7">&quot; </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">)[: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">]</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Struct</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">getRecordSize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">.</span><span class="s1">getRecordSize</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
        <span class="s1">table</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">attrs</span><span class="s2">:</span>
                <span class="s5"># If there are attributes (probably index), then</span>
                <span class="s5"># don't drop this even if it's NULL.  It will mess</span>
                <span class="s5"># up the array indices of the containing element.</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;empty&quot;</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)])</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">pass  </span><span class="s5"># NULL table, ignore</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s4">&quot;empty&quot; </span><span class="s0">in </span><span class="s1">attrs </span><span class="s0">and </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s4">&quot;empty&quot;</span><span class="s2">]):</span>
            <span class="s0">return None</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
        <span class="s1">Format </span><span class="s2">= </span><span class="s1">attrs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;Format&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">Format </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">Format </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">Format</span><span class="s2">)</span>

        <span class="s1">noPostRead </span><span class="s2">= </span><span class="s0">not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s4">&quot;postRead&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">noPostRead</span><span class="s2">:</span>
            <span class="s5"># TODO Cache table.hasPropagated.</span>
            <span class="s1">cleanPropagation </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">for </span><span class="s1">conv </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">getConverters</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">isPropagated</span><span class="s2">:</span>
                    <span class="s1">cleanPropagation </span><span class="s2">= </span><span class="s0">True</span>
                    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s4">&quot;_propagator&quot;</span><span class="s2">):</span>
                        <span class="s1">font</span><span class="s2">.</span><span class="s1">_propagator </span><span class="s2">= {}</span>
                    <span class="s1">propagator </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">_propagator</span>
                    <span class="s0">assert </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name </span><span class="s0">not in </span><span class="s1">propagator</span><span class="s2">, (</span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">propagator</span><span class="s2">)</span>
                    <span class="s1">setattr</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
                    <span class="s1">propagator</span><span class="s2">[</span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">CountReference</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">, </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content </span><span class="s2">= </span><span class="s1">element</span>
                <span class="s1">table</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">pass</span>

        <span class="s1">table</span><span class="s2">.</span><span class="s1">populateDefaults</span><span class="s2">(</span><span class="s1">propagator</span><span class="s2">=</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s4">&quot;_propagator&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">noPostRead</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">cleanPropagation</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">conv </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">getConverters</span><span class="s2">():</span>
                    <span class="s0">if </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">isPropagated</span><span class="s2">:</span>
                        <span class="s1">propagator </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">_propagator</span>
                        <span class="s0">del </span><span class="s1">propagator</span><span class="s2">[</span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
                        <span class="s0">if not </span><span class="s1">propagator</span><span class="s2">:</span>
                            <span class="s0">del </span><span class="s1">font</span><span class="s2">.</span><span class="s1">_propagator</span>

        <span class="s0">return </span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s4">&quot;Struct of &quot; </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">StructWithLength</span><span class="s2">(</span><span class="s1">Struct</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
        <span class="s1">table</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">reader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">table</span><span class="s2">.</span><span class="s1">StructLength</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">convIndex</span><span class="s2">, </span><span class="s1">conv </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">getConverters</span><span class="s2">()):</span>
            <span class="s0">if </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;StructLength&quot;</span><span class="s2">:</span>
                <span class="s0">break</span>
        <span class="s1">lengthIndex </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">.</span><span class="s1">items</span><span class="s2">) + </span><span class="s1">convIndex</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">FormatSwitchingBaseTable</span><span class="s2">):</span>
            <span class="s1">lengthIndex </span><span class="s2">+= </span><span class="s6">1  </span><span class="s5"># implicit Format field</span>
        <span class="s1">deadbeef </span><span class="s2">= {</span><span class="s6">1</span><span class="s2">: </span><span class="s6">0xDE</span><span class="s2">, </span><span class="s6">2</span><span class="s2">: </span><span class="s6">0xDEAD</span><span class="s2">, </span><span class="s6">4</span><span class="s2">: </span><span class="s6">0xDEADBEEF</span><span class="s2">}[</span><span class="s1">conv</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">]</span>

        <span class="s1">before </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getDataLength</span><span class="s2">()</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">StructLength </span><span class="s2">= </span><span class="s1">deadbeef</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getDataLength</span><span class="s2">() - </span><span class="s1">before</span>
        <span class="s1">lengthWriter </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getSubWriter</span><span class="s2">()</span>
        <span class="s1">conv</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">lengthWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">items</span><span class="s2">[</span><span class="s1">lengthIndex</span><span class="s2">] == </span><span class="s7">b&quot;</span><span class="s0">\xde\xad\xbe\xef</span><span class="s7">&quot;</span><span class="s2">[: </span><span class="s1">conv</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">]</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">items</span><span class="s2">[</span><span class="s1">lengthIndex</span><span class="s2">] = </span><span class="s1">lengthWriter</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">Table</span><span class="s2">(</span><span class="s1">Struct</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>

    <span class="s0">def </span><span class="s1">readOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">writeNullOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readOffset</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">offset </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
        <span class="s1">reader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">font</span><span class="s2">.</span><span class="s1">lazy</span><span class="s2">:</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">reader </span><span class="s2">= </span><span class="s1">reader</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">font </span><span class="s2">= </span><span class="s1">font</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">writeNullOffset</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">subWriter </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getSubWriter</span><span class="s2">()</span>
            <span class="s1">subWriter</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span>
            <span class="s0">if </span><span class="s1">repeatIndex </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">subWriter</span><span class="s2">.</span><span class="s1">repeatIndex </span><span class="s2">= </span><span class="s1">repeatIndex</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeSubTable</span><span class="s2">(</span><span class="s1">subWriter</span><span class="s2">, </span><span class="s1">offsetSize</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">)</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">subWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">LTable</span><span class="s2">(</span><span class="s1">Table</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">4</span>

    <span class="s0">def </span><span class="s1">readOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">writeNullOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>


<span class="s5"># Table pointed to by a 24-bit, 3-byte long offset</span>
<span class="s0">class </span><span class="s1">Table24</span><span class="s2">(</span><span class="s1">Table</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">3</span>

    <span class="s0">def </span><span class="s1">readOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt24</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">writeNullOffset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt24</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>


<span class="s5"># TODO Clean / merge the SubTable and SubStruct</span>


<span class="s0">class </span><span class="s1">SubStruct</span><span class="s2">(</span><span class="s1">Struct</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">getConverter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tableType</span><span class="s2">, </span><span class="s1">lookupType</span><span class="s2">):</span>
        <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lookupTypes</span><span class="s2">[</span><span class="s1">tableType</span><span class="s2">][</span><span class="s1">lookupType</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">SubStruct</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SubTable</span><span class="s2">(</span><span class="s1">Table</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">getConverter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tableType</span><span class="s2">, </span><span class="s1">lookupType</span><span class="s2">):</span>
        <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lookupTypes</span><span class="s2">[</span><span class="s1">tableType</span><span class="s2">][</span><span class="s1">lookupType</span><span class="s2">]</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">(</span><span class="s1">SubTable</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ExtSubTable</span><span class="s2">(</span><span class="s1">LTable</span><span class="s2">, </span><span class="s1">SubTable</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">Extension </span><span class="s2">= </span><span class="s0">True  </span><span class="s5"># actually, mere presence of the field flags it as an Ext Subtable writer.</span>
        <span class="s1">Table</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">FeatureParams</span><span class="s2">(</span><span class="s1">Table</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">getConverter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">featureTag</span><span class="s2">):</span>
        <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">featureParamTypes</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">featureTag</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">defaultFeatureParams</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ValueFormat</span><span class="s2">(</span><span class="s1">IntValue</span><span class="s2">):</span>
    <span class="s1">staticSize </span><span class="s2">= </span><span class="s6">2</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *, </span><span class="s1">description</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s1">BaseConverter</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">description</span><span class="s2">=</span><span class="s1">description</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">which </span><span class="s2">= </span><span class="s4">&quot;ValueFormat&quot; </span><span class="s2">+ (</span><span class="s4">&quot;2&quot; </span><span class="s0">if </span><span class="s1">name</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">] == </span><span class="s4">&quot;2&quot; </span><span class="s0">else </span><span class="s4">&quot;1&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">format </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s1">reader</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">which</span><span class="s2">] = </span><span class="s1">ValueRecordFactory</span><span class="s2">(</span><span class="s1">format</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">format</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">format</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">format</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">which</span><span class="s2">] = </span><span class="s1">ValueRecordFactory</span><span class="s2">(</span><span class="s1">format</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">ValueRecord</span><span class="s2">(</span><span class="s1">ValueFormat</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">getRecordSize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s6">2 </span><span class="s2">* </span><span class="s1">len</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">which</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">reader</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">which</span><span class="s2">].</span><span class="s1">readValueRecord</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">which</span><span class="s2">].</span><span class="s1">writeValueRecord</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">pass  </span><span class="s5"># NULL table, ignore</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s2">.</span><span class="s1">otBase </span><span class="s0">import </span><span class="s1">ValueRecord</span>

        <span class="s1">value </span><span class="s2">= </span><span class="s1">ValueRecord</span><span class="s2">()</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>


<span class="s0">class </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s1">BIN_SEARCH_HEADER_SIZE </span><span class="s2">= </span><span class="s6">10</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, *, </span><span class="s1">description</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s1">BaseConverter</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">description</span><span class="s2">=</span><span class="s1">description</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">SimpleValue</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Value&quot;</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter </span><span class="s2">= </span><span class="s1">Table</span><span class="s2">(</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Value&quot;</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">format </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">format </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readFormat0</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">format </span><span class="s2">== </span><span class="s6">2</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readFormat2</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">format </span><span class="s2">== </span><span class="s6">4</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readFormat4</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">format </span><span class="s2">== </span><span class="s6">6</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readFormat6</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">format </span><span class="s2">== </span><span class="s6">8</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">readFormat8</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert False</span><span class="s2">, </span><span class="s4">&quot;unsupported lookup format: %d&quot; </span><span class="s2">% </span><span class="s1">format</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span>
            <span class="s1">sorted</span><span class="s2">([(</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">glyph</span><span class="s2">), </span><span class="s1">val</span><span class="s2">) </span><span class="s0">for </span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()])</span>
        <span class="s2">)</span>
        <span class="s5"># TODO: Also implement format 4.</span>
        <span class="s1">formats </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span>
            <span class="s1">sorted</span><span class="s2">(</span>
                <span class="s1">filter</span><span class="s2">(</span>
                    <span class="s0">None</span><span class="s2">,</span>
                    <span class="s2">[</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">buildFormat0</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">buildFormat2</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">buildFormat6</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">buildFormat8</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
                    <span class="s2">],</span>
                <span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s5"># We use the format ID as secondary sort key to make the output</span>
        <span class="s5"># deterministic when multiple formats have same encoded size.</span>
        <span class="s1">dataSize</span><span class="s2">, </span><span class="s1">lookupFormat</span><span class="s2">, </span><span class="s1">writeMethod </span><span class="s2">= </span><span class="s1">formats</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getDataLength</span><span class="s2">()</span>
        <span class="s1">writeMethod</span><span class="s2">()</span>
        <span class="s1">actualSize </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getDataLength</span><span class="s2">() - </span><span class="s1">pos</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s1">actualSize </span><span class="s2">== </span><span class="s1">dataSize</span>
        <span class="s2">), </span><span class="s4">&quot;AATLookup format %d claimed to write %d bytes, but wrote %d&quot; </span><span class="s2">% (</span>
            <span class="s1">lookupFormat</span><span class="s2">,</span>
            <span class="s1">dataSize</span><span class="s2">,</span>
            <span class="s1">actualSize</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">writeBinSearchHeader</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">unitSize</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">numUnits</span><span class="s2">)</span>
        <span class="s1">searchRange</span><span class="s2">, </span><span class="s1">entrySelector</span><span class="s2">, </span><span class="s1">rangeShift </span><span class="s2">= </span><span class="s1">getSearchRange</span><span class="s2">(</span>
            <span class="s1">n</span><span class="s2">=</span><span class="s1">numUnits</span><span class="s2">, </span><span class="s1">itemSize</span><span class="s2">=</span><span class="s1">unitSize</span>
        <span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">searchRange</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">entrySelector</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">rangeShift</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">buildFormat0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">numGlyphs </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphOrder</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">) != </span><span class="s1">numGlyphs</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s1">valueSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s6">2 </span><span class="s2">+ </span><span class="s1">numGlyphs </span><span class="s2">* </span><span class="s1">valueSize</span><span class="s2">,</span>
            <span class="s6">0</span><span class="s2">,</span>
            <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">writeFormat0</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeFormat0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">glyphID_</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">values</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                <span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">buildFormat2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">segStart</span><span class="s2">, </span><span class="s1">segValue </span><span class="s2">= </span><span class="s1">values</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">segEnd </span><span class="s2">= </span><span class="s1">segStart</span>
        <span class="s1">segments </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">glyphID</span><span class="s2">, </span><span class="s1">curValue </span><span class="s0">in </span><span class="s1">values</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]:</span>
            <span class="s0">if </span><span class="s1">glyphID </span><span class="s2">!= </span><span class="s1">segEnd </span><span class="s2">+ </span><span class="s6">1 </span><span class="s0">or </span><span class="s1">curValue </span><span class="s2">!= </span><span class="s1">segValue</span><span class="s2">:</span>
                <span class="s1">segments</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">segStart</span><span class="s2">, </span><span class="s1">segEnd</span><span class="s2">, </span><span class="s1">segValue</span><span class="s2">))</span>
                <span class="s1">segStart </span><span class="s2">= </span><span class="s1">segEnd </span><span class="s2">= </span><span class="s1">glyphID</span>
                <span class="s1">segValue </span><span class="s2">= </span><span class="s1">curValue</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">segEnd </span><span class="s2">= </span><span class="s1">glyphID</span>
        <span class="s1">segments</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">segStart</span><span class="s2">, </span><span class="s1">segEnd</span><span class="s2">, </span><span class="s1">segValue</span><span class="s2">))</span>
        <span class="s1">valueSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">segments</span><span class="s2">) + </span><span class="s6">1</span><span class="s2">, </span><span class="s1">valueSize </span><span class="s2">+ </span><span class="s6">4</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s6">2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">BIN_SEARCH_HEADER_SIZE </span><span class="s2">+ </span><span class="s1">numUnits </span><span class="s2">* </span><span class="s1">unitSize</span><span class="s2">,</span>
            <span class="s6">2</span><span class="s2">,</span>
            <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">writeFormat2</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">segments</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeFormat2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">segments</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
        <span class="s1">valueSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">segments</span><span class="s2">), </span><span class="s1">valueSize </span><span class="s2">+ </span><span class="s6">4</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeBinSearchHeader</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">firstGlyph</span><span class="s2">, </span><span class="s1">lastGlyph</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">segments</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">lastGlyph</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">firstGlyph</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                <span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span>
            <span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">0xFFFF</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">0xFFFF</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\x00</span><span class="s7">&quot; </span><span class="s2">* </span><span class="s1">valueSize</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">buildFormat6</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">valueSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">), </span><span class="s1">valueSize </span><span class="s2">+ </span><span class="s6">2</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s6">2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">BIN_SEARCH_HEADER_SIZE </span><span class="s2">+ (</span><span class="s1">numUnits </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">) * </span><span class="s1">unitSize</span><span class="s2">,</span>
            <span class="s6">6</span><span class="s2">,</span>
            <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">writeFormat6</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeFormat6</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">6</span><span class="s2">)</span>
        <span class="s1">valueSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">), </span><span class="s1">valueSize </span><span class="s2">+ </span><span class="s6">2</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">writeBinSearchHeader</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">numUnits</span><span class="s2">, </span><span class="s1">unitSize</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">glyphID</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">values</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">glyphID</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                <span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span>
            <span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">0xFFFF</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s7">b&quot;</span><span class="s0">\x00</span><span class="s7">&quot; </span><span class="s2">* </span><span class="s1">valueSize</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">buildFormat8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">minGlyphID</span><span class="s2">, </span><span class="s1">maxGlyphID </span><span class="s2">= </span><span class="s1">values</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][</span><span class="s6">0</span><span class="s2">], </span><span class="s1">values</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">) != </span><span class="s1">maxGlyphID </span><span class="s2">- </span><span class="s1">minGlyphID </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s0">return None</span>
        <span class="s1">valueSize </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s6">6 </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">) * </span><span class="s1">valueSize</span><span class="s2">,</span>
            <span class="s6">8</span><span class="s2">,</span>
            <span class="s0">lambda</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">writeFormat8</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">writeFormat8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">values</span><span class="s2">):</span>
        <span class="s1">firstGlyphID </span><span class="s2">= </span><span class="s1">values</span><span class="s2">[</span><span class="s6">0</span><span class="s2">][</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s6">8</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">firstGlyphID</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">values</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
                <span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">readFormat0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">numGlyphs </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphOrder</span><span class="s2">())</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s1">numGlyphs</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">k</span><span class="s2">): </span><span class="s1">value </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)}</span>

    <span class="s0">def </span><span class="s1">readFormat2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">mapping </span><span class="s2">= {}</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">- </span><span class="s6">2  </span><span class="s5"># start of table is at UShort for format</span>
        <span class="s1">unitSize</span><span class="s2">, </span><span class="s1">numUnits </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">(), </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">unitSize </span><span class="s2">&gt;= </span><span class="s6">4 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">, </span><span class="s1">unitSize</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numUnits</span><span class="s2">):</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">i </span><span class="s2">* </span><span class="s1">unitSize </span><span class="s2">+ </span><span class="s6">12</span><span class="s2">)</span>
            <span class="s1">last </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
            <span class="s1">first </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">last </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">first</span><span class="s2">, </span><span class="s1">last </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">):</span>
                    <span class="s1">mapping</span><span class="s2">[</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)] = </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">mapping</span>

    <span class="s0">def </span><span class="s1">readFormat4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">mapping </span><span class="s2">= {}</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">- </span><span class="s6">2  </span><span class="s5"># start of table is at UShort for format</span>
        <span class="s1">unitSize </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">unitSize </span><span class="s2">&gt;= </span><span class="s6">6</span><span class="s2">, </span><span class="s1">unitSize</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()):</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">i </span><span class="s2">* </span><span class="s1">unitSize </span><span class="s2">+ </span><span class="s6">12</span><span class="s2">)</span>
            <span class="s1">last </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
            <span class="s1">first </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">last </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s1">dataReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)  </span><span class="s5"># relative to current position</span>
                <span class="s1">dataReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">offset</span><span class="s2">)  </span><span class="s5"># relative to start of table</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">readArray</span><span class="s2">(</span>
                    <span class="s1">dataReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s1">last </span><span class="s2">- </span><span class="s1">first </span><span class="s2">+ </span><span class="s6">1</span>
                <span class="s2">)</span>
                <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">data</span><span class="s2">):</span>
                    <span class="s1">mapping</span><span class="s2">[</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">first </span><span class="s2">+ </span><span class="s1">k</span><span class="s2">)] = </span><span class="s1">v</span>
        <span class="s0">return </span><span class="s1">mapping</span>

    <span class="s0">def </span><span class="s1">readFormat6</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">mapping </span><span class="s2">= {}</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">- </span><span class="s6">2  </span><span class="s5"># start of table is at UShort for format</span>
        <span class="s1">unitSize </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">unitSize </span><span class="s2">&gt;= </span><span class="s6">2 </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">, </span><span class="s1">unitSize</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()):</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">i </span><span class="s2">* </span><span class="s1">unitSize </span><span class="s2">+ </span><span class="s6">12</span><span class="s2">)</span>
            <span class="s1">glyphID </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">glyphID </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s1">mapping</span><span class="s2">[</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">glyphID</span><span class="s2">)] = </span><span class="s1">value</span>
        <span class="s0">return </span><span class="s1">mapping</span>

    <span class="s0">def </span><span class="s1">readFormat8</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">first </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s1">count</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">first </span><span class="s2">+ </span><span class="s1">k</span><span class="s2">): </span><span class="s1">value </span><span class="s0">for </span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)}</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">value </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">content</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">element</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">):</span>
                <span class="s1">name</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">eltContent </span><span class="s2">= </span><span class="s1">element</span>
                <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;Lookup&quot;</span><span class="s2">:</span>
                    <span class="s1">value</span><span class="s2">[</span><span class="s1">a</span><span class="s2">[</span><span class="s4">&quot;glyph&quot;</span><span class="s2">]] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">value</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">converter</span><span class="s2">.</span><span class="s1">xmlWrite</span><span class="s2">(</span>
                <span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Lookup&quot;</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">=[(</span><span class="s4">&quot;glyph&quot;</span><span class="s2">, </span><span class="s1">glyph</span><span class="s2">)]</span>
            <span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s5"># The AAT 'ankr' table has an unusual structure: An offset to an AATLookup</span>
<span class="s5"># followed by an offset to a glyph data table. Other than usual, the</span>
<span class="s5"># offsets in the AATLookup are not relative to the beginning of</span>
<span class="s5"># the beginning of the 'ankr' table, but relative to the glyph data table.</span>
<span class="s5"># So, to find the anchor data for a glyph, one needs to add the offset</span>
<span class="s5"># to the data table to the offset found in the AATLookup, and then use</span>
<span class="s5"># the sum of these two offsets to find the actual data.</span>
<span class="s0">class </span><span class="s1">AATLookupWithDataOffset</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">lookupOffset </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>
        <span class="s1">dataOffset </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>
        <span class="s1">lookupReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s1">lookupOffset</span><span class="s2">)</span>
        <span class="s1">lookup </span><span class="s2">= </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s4">&quot;DataOffsets&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">UShort</span><span class="s2">)</span>
        <span class="s1">offsets </span><span class="s2">= </span><span class="s1">lookup</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">lookupReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">offset </span><span class="s0">in </span><span class="s1">offsets</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">dataReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s1">offset </span><span class="s2">+ </span><span class="s1">dataOffset</span><span class="s2">)</span>
            <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
            <span class="s1">item</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">dataReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
            <span class="s1">result</span><span class="s2">[</span><span class="s1">glyph</span><span class="s2">] = </span><span class="s1">item</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s5"># We do not work with OTTableWriter sub-writers because</span>
        <span class="s5"># the offsets in our AATLookup are relative to our data</span>
        <span class="s5"># table, for which we need to provide an offset value itself.</span>
        <span class="s5"># It might have been possible to somehow make a kludge for</span>
        <span class="s5"># performing this indirect offset computation directly inside</span>
        <span class="s5"># OTTableWriter. But this would have made the internal logic</span>
        <span class="s5"># of OTTableWriter even more complex than it already is,</span>
        <span class="s5"># so we decided to roll our own offset computation for the</span>
        <span class="s5"># contents of the AATLookup and associated data table.</span>
        <span class="s1">offsetByGlyph</span><span class="s2">, </span><span class="s1">offsetByData</span><span class="s2">, </span><span class="s1">dataLen </span><span class="s2">= {}, {}, </span><span class="s6">0</span>
        <span class="s1">compiledData </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">glyph </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">):</span>
            <span class="s1">subWriter </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
            <span class="s1">value</span><span class="s2">[</span><span class="s1">glyph</span><span class="s2">].</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">subWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">subWriter</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">()</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">offsetByData</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">offset </span><span class="s2">== </span><span class="s0">None</span><span class="s2">:</span>
                <span class="s1">offset </span><span class="s2">= </span><span class="s1">dataLen</span>
                <span class="s1">dataLen </span><span class="s2">= </span><span class="s1">dataLen </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
                <span class="s1">offsetByData</span><span class="s2">[</span><span class="s1">data</span><span class="s2">] = </span><span class="s1">offset</span>
                <span class="s1">compiledData</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s1">offsetByGlyph</span><span class="s2">[</span><span class="s1">glyph</span><span class="s2">] = </span><span class="s1">offset</span>
        <span class="s5"># For calculating the offsets to our AATLookup and data table,</span>
        <span class="s5"># we can use the regular OTTableWriter infrastructure.</span>
        <span class="s1">lookupWriter </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getSubWriter</span><span class="s2">()</span>
        <span class="s1">lookup </span><span class="s2">= </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s4">&quot;DataOffsets&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">UShort</span><span class="s2">)</span>
        <span class="s1">lookup</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">lookupWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">offsetByGlyph</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s1">dataWriter </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getSubWriter</span><span class="s2">()</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeSubTable</span><span class="s2">(</span><span class="s1">lookupWriter</span><span class="s2">, </span><span class="s1">offsetSize</span><span class="s2">=</span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeSubTable</span><span class="s2">(</span><span class="s1">dataWriter</span><span class="s2">, </span><span class="s1">offsetSize</span><span class="s2">=</span><span class="s6">4</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">compiledData</span><span class="s2">:</span>
            <span class="s1">dataWriter</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">lookup </span><span class="s2">= </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s4">&quot;DataOffsets&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">lookup</span><span class="s2">.</span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">lookup </span><span class="s2">= </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s4">&quot;DataOffsets&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">)</span>
        <span class="s1">lookup</span><span class="s2">.</span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">MorxSubtableConverter</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s1">_PROCESSING_ORDERS </span><span class="s2">= {</span>
        <span class="s5"># bits 30 and 28 of morx.CoverageFlags; see morx spec</span>
        <span class="s2">(</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">): </span><span class="s4">&quot;LayoutOrder&quot;</span><span class="s2">,</span>
        <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">): </span><span class="s4">&quot;ReversedLayoutOrder&quot;</span><span class="s2">,</span>
        <span class="s2">(</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">): </span><span class="s4">&quot;LogicalOrder&quot;</span><span class="s2">,</span>
        <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">): </span><span class="s4">&quot;ReversedLogicalOrder&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>

    <span class="s1">_PROCESSING_ORDERS_REVERSED </span><span class="s2">= {</span><span class="s1">val</span><span class="s2">: </span><span class="s1">key </span><span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">_PROCESSING_ORDERS</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *, </span><span class="s1">description</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s1">BaseConverter</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">description</span><span class="s2">=</span><span class="s1">description</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_setTextDirectionFromCoverageFlags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">, </span><span class="s1">subtable</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s6">0x20</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">subtable</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s2">= </span><span class="s4">&quot;Any&quot;</span>
        <span class="s0">elif </span><span class="s2">(</span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s6">0x80</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">subtable</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s2">= </span><span class="s4">&quot;Vertical&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">subtable</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s2">= </span><span class="s4">&quot;Horizontal&quot;</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">MorxSubtable</span><span class="s2">()</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">StructLength </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8</span><span class="s2">()</span>
        <span class="s1">orderKey </span><span class="s2">= ((</span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s6">0x40</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">, (</span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s6">0x10</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">ProcessingOrder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_PROCESSING_ORDERS</span><span class="s2">[</span><span class="s1">orderKey</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_setTextDirectionFromCoverageFlags</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">|= (</span><span class="s1">flags </span><span class="s2">&amp; </span><span class="s6">0xF</span><span class="s2">) &lt;&lt; </span><span class="s6">16</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">MorphType </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8</span><span class="s2">()</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">SubFeatureFlags </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>
        <span class="s1">tableClass </span><span class="s2">= </span><span class="s1">lookupTypes</span><span class="s2">[</span><span class="s4">&quot;morx&quot;</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">MorphType</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">tableClass </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">assert False</span><span class="s2">, </span><span class="s4">&quot;unsupported 'morx' lookup type %s&quot; </span><span class="s2">% </span><span class="s1">m</span><span class="s2">.</span><span class="s1">MorphType</span>
        <span class="s5"># To decode AAT ligatures, we need to know the subtable size.</span>
        <span class="s5"># The easiest way to pass this along is to create a new reader</span>
        <span class="s5"># that works on just the subtable as its data.</span>
        <span class="s1">headerLength </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">- </span><span class="s1">pos</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">data</span><span class="s2">[</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">m</span><span class="s2">.</span><span class="s1">StructLength </span><span class="s2">- </span><span class="s1">headerLength</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) == </span><span class="s1">m</span><span class="s2">.</span><span class="s1">StructLength </span><span class="s2">- </span><span class="s1">headerLength</span>
        <span class="s1">subReader </span><span class="s2">= </span><span class="s1">OTTableReader</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s1">data</span><span class="s2">, </span><span class="s1">tableTag</span><span class="s2">=</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">tableTag</span><span class="s2">)</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">SubStruct </span><span class="s2">= </span><span class="s1">tableClass</span><span class="s2">()</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">SubStruct</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">subReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">reader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">m</span><span class="s2">.</span><span class="s1">StructLength</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">m</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot;StructLength=%d&quot; </span><span class="s2">% </span><span class="s1">value</span><span class="s2">.</span><span class="s1">StructLength</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;TextDirection&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">.</span><span class="s1">TextDirection</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;ProcessingOrder&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">value</span><span class="s2">.</span><span class="s1">ProcessingOrder</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">!= </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;Reserved&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">&quot;0x%04x&quot; </span><span class="s2">% </span><span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot;MorphType=%d&quot; </span><span class="s2">% </span><span class="s1">value</span><span class="s2">.</span><span class="s1">MorphType</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;SubFeatureFlags&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">&quot;0x%08x&quot; </span><span class="s2">% </span><span class="s1">value</span><span class="s2">.</span><span class="s1">SubFeatureFlags</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">SubStruct</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">MorxSubtable</span><span class="s2">()</span>
        <span class="s1">covFlags </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s0">for </span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;CoverageFlags&quot;</span><span class="s2">:</span>
                <span class="s5"># Only in XML from old versions of fonttools.</span>
                <span class="s1">covFlags </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>
                <span class="s1">orderKey </span><span class="s2">= ((</span><span class="s1">covFlags </span><span class="s2">&amp; </span><span class="s6">0x40</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">, (</span><span class="s1">covFlags </span><span class="s2">&amp; </span><span class="s6">0x10</span><span class="s2">) != </span><span class="s6">0</span><span class="s2">)</span>
                <span class="s1">m</span><span class="s2">.</span><span class="s1">ProcessingOrder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_PROCESSING_ORDERS</span><span class="s2">[</span><span class="s1">orderKey</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_setTextDirectionFromCoverageFlags</span><span class="s2">(</span><span class="s1">covFlags</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;ProcessingOrder&quot;</span><span class="s2">:</span>
                <span class="s1">m</span><span class="s2">.</span><span class="s1">ProcessingOrder </span><span class="s2">= </span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>
                <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">ProcessingOrder </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_PROCESSING_ORDERS_REVERSED</span><span class="s2">, (</span>
                    <span class="s4">&quot;unknown ProcessingOrder: %s&quot; </span><span class="s2">% </span><span class="s1">m</span><span class="s2">.</span><span class="s1">ProcessingOrder</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;TextDirection&quot;</span><span class="s2">:</span>
                <span class="s1">m</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s2">= </span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>
                <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s0">in </span><span class="s2">{</span><span class="s4">&quot;Horizontal&quot;</span><span class="s2">, </span><span class="s4">&quot;Vertical&quot;</span><span class="s2">, </span><span class="s4">&quot;Any&quot;</span><span class="s2">}, (</span>
                    <span class="s4">&quot;unknown TextDirection %s&quot; </span><span class="s2">% </span><span class="s1">m</span><span class="s2">.</span><span class="s1">TextDirection</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;Reserved&quot;</span><span class="s2">:</span>
                <span class="s1">m</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;SubFeatureFlags&quot;</span><span class="s2">:</span>
                <span class="s1">m</span><span class="s2">.</span><span class="s1">SubFeatureFlags </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>
            <span class="s0">elif </span><span class="s1">eltName</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;Morph&quot;</span><span class="s2">):</span>
                <span class="s1">m</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert False</span><span class="s2">, </span><span class="s1">eltName</span>
        <span class="s1">m</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">= (</span><span class="s1">covFlags </span><span class="s2">&amp; </span><span class="s6">0xF</span><span class="s2">) &lt;&lt; </span><span class="s6">16 </span><span class="s2">| </span><span class="s1">m</span><span class="s2">.</span><span class="s1">Reserved</span>
        <span class="s0">return </span><span class="s1">m</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">covFlags </span><span class="s2">= (</span><span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">&amp; </span><span class="s6">0x000F0000</span><span class="s2">) &gt;&gt; </span><span class="s6">16</span>
        <span class="s1">reverseOrder</span><span class="s2">, </span><span class="s1">logicalOrder </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_PROCESSING_ORDERS_REVERSED</span><span class="s2">[</span>
            <span class="s1">value</span><span class="s2">.</span><span class="s1">ProcessingOrder</span>
        <span class="s2">]</span>
        <span class="s1">covFlags </span><span class="s2">|= </span><span class="s6">0x80 </span><span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s2">== </span><span class="s4">&quot;Vertical&quot; </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s1">covFlags </span><span class="s2">|= </span><span class="s6">0x40 </span><span class="s0">if </span><span class="s1">reverseOrder </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s1">covFlags </span><span class="s2">|= </span><span class="s6">0x20 </span><span class="s0">if </span><span class="s1">value</span><span class="s2">.</span><span class="s1">TextDirection </span><span class="s2">== </span><span class="s4">&quot;Any&quot; </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s1">covFlags </span><span class="s2">|= </span><span class="s6">0x10 </span><span class="s0">if </span><span class="s1">logicalOrder </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">CoverageFlags </span><span class="s2">= </span><span class="s1">covFlags</span>
        <span class="s1">lengthIndex </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">.</span><span class="s1">items</span><span class="s2">)</span>
        <span class="s1">before </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getDataLength</span><span class="s2">()</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">StructLength </span><span class="s2">= </span><span class="s6">0xDEADBEEF</span>
        <span class="s5"># The high nibble of value.Reserved is actuallly encoded</span>
        <span class="s5"># into coverageFlags, so we need to clear it here.</span>
        <span class="s1">origReserved </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved  </span><span class="s5"># including high nibble</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">&amp; </span><span class="s6">0xFFFF  </span><span class="s5"># without high nibble</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">value</span><span class="s2">.</span><span class="s1">Reserved </span><span class="s2">= </span><span class="s1">origReserved  </span><span class="s5"># restore original value</span>
        <span class="s0">assert </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">items</span><span class="s2">[</span><span class="s1">lengthIndex</span><span class="s2">] == </span><span class="s7">b&quot;</span><span class="s0">\xde\xad\xbe\xef</span><span class="s7">&quot;</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getDataLength</span><span class="s2">() - </span><span class="s1">before</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">items</span><span class="s2">[</span><span class="s1">lengthIndex</span><span class="s2">] = </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">pack</span><span class="s2">(</span><span class="s4">&quot;&gt;L&quot;</span><span class="s2">, </span><span class="s1">length</span><span class="s2">)</span>


<span class="s5"># https://developer.apple.com/fonts/TrueType-Reference-Manual/RM06/Chap6Tables.html#ExtendedStateHeader</span>
<span class="s5"># TODO: Untangle the implementation of the various lookup-specific formats.</span>
<span class="s0">class </span><span class="s1">STXHeader</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, *, </span><span class="s1">description</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">):</span>
        <span class="s1">BaseConverter</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">description</span><span class="s2">=</span><span class="s1">description</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">AATAction</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">classLookup </span><span class="s2">= </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s4">&quot;GlyphClasses&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">UShort</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">ContextualMorphAction</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s2">= </span><span class="s1">AATLookup</span><span class="s2">(</span><span class="s4">&quot;PerGlyphLookup&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">GlyphID</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">AATStateTable</span><span class="s2">()</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span>
        <span class="s1">classTableReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">stateArrayReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">entryTableReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">actionReader </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">ligaturesReader </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClassCount </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>
        <span class="s1">classTableReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
        <span class="s1">stateArrayReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
        <span class="s1">entryTableReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">perGlyphTableReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">perGlyphTableReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">LigatureMorphAction</span><span class="s2">):</span>
            <span class="s1">actionReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">actionReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
            <span class="s1">ligComponentReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">ligComponentReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
            <span class="s1">ligaturesReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">ligaturesReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
            <span class="s1">numLigComponents </span><span class="s2">= (</span><span class="s1">ligaturesReader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">- </span><span class="s1">ligComponentReader</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">) // </span><span class="s6">2</span>
            <span class="s0">assert </span><span class="s1">numLigComponents </span><span class="s2">&gt;= </span><span class="s6">0</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">LigComponents </span><span class="s2">= </span><span class="s1">ligComponentReader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">(</span><span class="s1">numLigComponents</span><span class="s2">)</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">Ligatures </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readLigatures</span><span class="s2">(</span><span class="s1">ligaturesReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">InsertionMorphAction</span><span class="s2">):</span>
            <span class="s1">actionReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">actionReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
        <span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClasses </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">classLookup</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">classTableReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">)</span>
        <span class="s1">numStates </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span>
            <span class="s2">(</span><span class="s1">entryTableReader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">- </span><span class="s1">stateArrayReader</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">) / (</span><span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClassCount </span><span class="s2">* </span><span class="s6">2</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">stateIndex </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">numStates</span><span class="s2">):</span>
            <span class="s1">state </span><span class="s2">= </span><span class="s1">AATState</span><span class="s2">()</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">States</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">state</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">glyphClass </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClassCount</span><span class="s2">):</span>
                <span class="s1">entryIndex </span><span class="s2">= </span><span class="s1">stateArrayReader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
                <span class="s1">state</span><span class="s2">.</span><span class="s1">Transitions</span><span class="s2">[</span><span class="s1">glyphClass</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readTransition</span><span class="s2">(</span>
                    <span class="s1">entryTableReader</span><span class="s2">, </span><span class="s1">entryIndex</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">actionReader</span>
                <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">table</span><span class="s2">.</span><span class="s1">PerGlyphLookups </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_readPerGlyphLookups</span><span class="s2">(</span>
                <span class="s1">table</span><span class="s2">, </span><span class="s1">perGlyphTableReader</span><span class="s2">, </span><span class="s1">font</span>
            <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">_readTransition</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">entryIndex</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">actionReader</span><span class="s2">):</span>
        <span class="s1">transition </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
        <span class="s1">entryReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">entryIndex </span><span class="s2">* </span><span class="s1">transition</span><span class="s2">.</span><span class="s1">staticSize</span>
        <span class="s2">)</span>
        <span class="s1">transition</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">entryReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">actionReader</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">transition</span>

    <span class="s0">def </span><span class="s1">_readLigatures</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">limit </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">numLigatureGlyphs </span><span class="s2">= (</span><span class="s1">limit </span><span class="s2">- </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">) // </span><span class="s6">2</span>
        <span class="s0">return </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphNameMany</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">(</span><span class="s1">numLigatureGlyphs</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_countPerGlyphLookups</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">):</span>
        <span class="s5"># Somewhat annoyingly, the morx table does not encode</span>
        <span class="s5"># the size of the per-glyph table. So we need to find</span>
        <span class="s5"># the maximum value that MorphActions use as index</span>
        <span class="s5"># into this table.</span>
        <span class="s1">numLookups </span><span class="s2">= </span><span class="s6">0</span>
        <span class="s0">for </span><span class="s1">state </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">States</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">state</span><span class="s2">.</span><span class="s1">Transitions</span><span class="s2">.</span><span class="s1">values</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">ContextualMorphAction</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">t</span><span class="s2">.</span><span class="s1">MarkIndex </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                        <span class="s1">numLookups </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">numLookups</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">MarkIndex </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">t</span><span class="s2">.</span><span class="s1">CurrentIndex </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                        <span class="s1">numLookups </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">numLookups</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">CurrentIndex </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">numLookups</span>

    <span class="s0">def </span><span class="s1">_readPerGlyphLookups</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span>
        <span class="s1">lookups </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_countPerGlyphLookups</span><span class="s2">(</span><span class="s1">table</span><span class="s2">)):</span>
            <span class="s1">lookupReader </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">getSubReader</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">lookupReader</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">())</span>
            <span class="s1">lookups</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">lookupReader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, {}))</span>
        <span class="s0">return </span><span class="s1">lookups</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">glyphClassWriter </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">classLookup</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span>
            <span class="s1">glyphClassWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">GlyphClasses</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span>
        <span class="s2">)</span>
        <span class="s1">glyphClassData </span><span class="s2">= </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">glyphClassWriter</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">(), </span><span class="s6">2</span><span class="s2">)</span>
        <span class="s1">glyphClassCount </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">GlyphClasses</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()) + </span><span class="s6">1</span>
        <span class="s1">glyphClassTableOffset </span><span class="s2">= </span><span class="s6">16  </span><span class="s5"># size of STXHeader</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">glyphClassTableOffset </span><span class="s2">+= </span><span class="s6">4</span>

        <span class="s1">glyphClassTableOffset </span><span class="s2">+= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">.</span><span class="s1">actionHeaderSize</span>
        <span class="s1">actionData</span><span class="s2">, </span><span class="s1">actionIndex </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">.</span><span class="s1">compileActions</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">States</span><span class="s2">)</span>
        <span class="s1">stateArrayData</span><span class="s2">, </span><span class="s1">entryTableData </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compileStates</span><span class="s2">(</span>
            <span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">States</span><span class="s2">, </span><span class="s1">glyphClassCount</span><span class="s2">, </span><span class="s1">actionIndex</span>
        <span class="s2">)</span>
        <span class="s1">stateArrayOffset </span><span class="s2">= </span><span class="s1">glyphClassTableOffset </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">glyphClassData</span><span class="s2">)</span>
        <span class="s1">entryTableOffset </span><span class="s2">= </span><span class="s1">stateArrayOffset </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">stateArrayData</span><span class="s2">)</span>
        <span class="s1">perGlyphOffset </span><span class="s2">= </span><span class="s1">entryTableOffset </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">entryTableData</span><span class="s2">)</span>
        <span class="s1">perGlyphData </span><span class="s2">= </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compilePerGlyphLookups</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">font</span><span class="s2">), </span><span class="s6">4</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">actionData </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">actionOffset </span><span class="s2">= </span><span class="s1">entryTableOffset </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">entryTableData</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">actionOffset </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">ligaturesOffset</span><span class="s2">, </span><span class="s1">ligComponentsOffset </span><span class="s2">= </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span>
        <span class="s1">ligComponentsData </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compileLigComponents</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">ligaturesData </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_compileLigatures</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ligComponentsData </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">perGlyphData</span><span class="s2">) == </span><span class="s6">0</span>
            <span class="s1">ligComponentsOffset </span><span class="s2">= </span><span class="s1">actionOffset </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">actionData</span><span class="s2">)</span>
            <span class="s1">ligaturesOffset </span><span class="s2">= </span><span class="s1">ligComponentsOffset </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ligComponentsData</span><span class="s2">)</span>

        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">glyphClassCount</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">glyphClassTableOffset</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">stateArrayOffset</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">entryTableOffset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">perGlyphOffset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">actionOffset </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">actionOffset</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ligComponentsOffset </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">ligComponentsOffset</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">ligaturesOffset</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">glyphClassData</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">stateArrayData</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">entryTableData</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">perGlyphData</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">actionData </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">actionData</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ligComponentsData </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">ligComponentsData</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ligaturesData </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">ligaturesData</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_compileStates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">states</span><span class="s2">, </span><span class="s1">glyphClassCount</span><span class="s2">, </span><span class="s1">actionIndex</span><span class="s2">):</span>
        <span class="s1">stateArrayWriter </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
        <span class="s1">entries</span><span class="s2">, </span><span class="s1">entryIDs </span><span class="s2">= [], {}</span>
        <span class="s0">for </span><span class="s1">state </span><span class="s0">in </span><span class="s1">states</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">glyphClass </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">glyphClassCount</span><span class="s2">):</span>
                <span class="s1">transition </span><span class="s2">= </span><span class="s1">state</span><span class="s2">.</span><span class="s1">Transitions</span><span class="s2">[</span><span class="s1">glyphClass</span><span class="s2">]</span>
                <span class="s1">entryWriter </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
                <span class="s1">transition</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">entryWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">actionIndex</span><span class="s2">)</span>
                <span class="s1">entryData </span><span class="s2">= </span><span class="s1">entryWriter</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">()</span>
                <span class="s0">assert </span><span class="s2">(</span>
                    <span class="s1">len</span><span class="s2">(</span><span class="s1">entryData</span><span class="s2">) == </span><span class="s1">transition</span><span class="s2">.</span><span class="s1">staticSize</span>
                <span class="s2">), </span><span class="s4">&quot;%s has staticSize %d, &quot; &quot;but actually wrote %d bytes&quot; </span><span class="s2">% (</span>
                    <span class="s1">repr</span><span class="s2">(</span><span class="s1">transition</span><span class="s2">),</span>
                    <span class="s1">transition</span><span class="s2">.</span><span class="s1">staticSize</span><span class="s2">,</span>
                    <span class="s1">len</span><span class="s2">(</span><span class="s1">entryData</span><span class="s2">),</span>
                <span class="s2">)</span>
                <span class="s1">entryIndex </span><span class="s2">= </span><span class="s1">entryIDs</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">entryData</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">entryIndex </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s1">entryIndex </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">entries</span><span class="s2">)</span>
                    <span class="s1">entryIDs</span><span class="s2">[</span><span class="s1">entryData</span><span class="s2">] = </span><span class="s1">entryIndex</span>
                    <span class="s1">entries</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">entryData</span><span class="s2">)</span>
                <span class="s1">stateArrayWriter</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">entryIndex</span><span class="s2">)</span>
        <span class="s1">stateArrayData </span><span class="s2">= </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">stateArrayWriter</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">(), </span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">entryTableData </span><span class="s2">= </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">bytesjoin</span><span class="s2">(</span><span class="s1">entries</span><span class="s2">), </span><span class="s6">4</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">stateArrayData</span><span class="s2">, </span><span class="s1">entryTableData</span>

    <span class="s0">def </span><span class="s1">_compilePerGlyphLookups</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s7">b&quot;&quot;</span>
        <span class="s1">numLookups </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_countPerGlyphLookups</span><span class="s2">(</span><span class="s1">table</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">PerGlyphLookups</span><span class="s2">) == </span><span class="s1">numLookups</span><span class="s2">, (</span>
            <span class="s4">&quot;len(AATStateTable.PerGlyphLookups) is %d, &quot;</span>
            <span class="s4">&quot;but the actions inside the table refer to %d&quot;</span>
            <span class="s2">% (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">PerGlyphLookups</span><span class="s2">), </span><span class="s1">numLookups</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">writer </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">lookup </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">PerGlyphLookups</span><span class="s2">:</span>
            <span class="s1">lookupWriter </span><span class="s2">= </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getSubWriter</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">lookupWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, {}, </span><span class="s1">lookup</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeSubTable</span><span class="s2">(</span><span class="s1">lookupWriter</span><span class="s2">, </span><span class="s1">offsetSize</span><span class="s2">=</span><span class="s6">4</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_compileLigComponents</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s4">&quot;LigComponents&quot;</span><span class="s2">):</span>
            <span class="s0">return None</span>
        <span class="s1">writer </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">component </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">LigComponents</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">component</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_compileLigatures</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s4">&quot;Ligatures&quot;</span><span class="s2">):</span>
            <span class="s0">return None</span>
        <span class="s1">writer </span><span class="s2">= </span><span class="s1">OTTableWriter</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">glyphName </span><span class="s0">in </span><span class="s1">table</span><span class="s2">.</span><span class="s1">Ligatures</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">glyphName</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">getAllData</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot;GlyphClassCount=%s&quot; </span><span class="s2">% </span><span class="s1">value</span><span class="s2">.</span><span class="s1">GlyphClassCount</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">g</span><span class="s2">, </span><span class="s1">klass </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">GlyphClasses</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;GlyphClass&quot;</span><span class="s2">, </span><span class="s1">glyph</span><span class="s2">=</span><span class="s1">g</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">klass</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">stateIndex</span><span class="s2">, </span><span class="s1">state </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">States</span><span class="s2">):</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s4">&quot;State&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">stateIndex</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">glyphClass</span><span class="s2">, </span><span class="s1">trans </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">state</span><span class="s2">.</span><span class="s1">Transitions</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
                <span class="s1">trans</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span>
                    <span class="s1">xmlWriter</span><span class="s2">,</span>
                    <span class="s1">font</span><span class="s2">=</span><span class="s1">font</span><span class="s2">,</span>
                    <span class="s1">attrs</span><span class="s2">={</span><span class="s4">&quot;onGlyphClass&quot;</span><span class="s2">: </span><span class="s1">glyphClass</span><span class="s2">},</span>
                    <span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;Transition&quot;</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s4">&quot;State&quot;</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">lookup </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">PerGlyphLookups</span><span class="s2">):</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s4">&quot;PerGlyphLookup&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">lookup</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;Lookup&quot;</span><span class="s2">, </span><span class="s1">glyph</span><span class="s2">=</span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">val</span><span class="s2">)</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s4">&quot;PerGlyphLookup&quot;</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s4">&quot;LigComponents&quot;</span><span class="s2">):</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s4">&quot;LigComponents&quot;</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s4">&quot;LigComponents&quot;</span><span class="s2">)):</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;LigComponent&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">i</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">val</span><span class="s2">)</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s4">&quot;LigComponents&quot;</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_xmlWriteLigatures</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_xmlWriteLigatures</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s4">&quot;Ligatures&quot;</span><span class="s2">):</span>
            <span class="s0">return</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s4">&quot;Ligatures&quot;</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">g </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s4">&quot;Ligatures&quot;</span><span class="s2">)):</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;Ligature&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">i</span><span class="s2">, </span><span class="s1">glyph</span><span class="s2">=</span><span class="s1">g</span><span class="s2">)</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s4">&quot;Ligatures&quot;</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">AATStateTable</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;GlyphClass&quot;</span><span class="s2">:</span>
                <span class="s1">glyph </span><span class="s2">= </span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;glyph&quot;</span><span class="s2">]</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>
                <span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClasses</span><span class="s2">[</span><span class="s1">glyph</span><span class="s2">] = </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;State&quot;</span><span class="s2">:</span>
                <span class="s1">state </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_xmlReadState</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
                <span class="s1">table</span><span class="s2">.</span><span class="s1">States</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">state</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;PerGlyphLookup&quot;</span><span class="s2">:</span>
                <span class="s1">lookup </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">perGlyphLookup</span><span class="s2">.</span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
                <span class="s1">table</span><span class="s2">.</span><span class="s1">PerGlyphLookups</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">lookup</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;LigComponents&quot;</span><span class="s2">:</span>
                <span class="s1">table</span><span class="s2">.</span><span class="s1">LigComponents </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_xmlReadLigComponents</span><span class="s2">(</span>
                    <span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span>
                <span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;Ligatures&quot;</span><span class="s2">:</span>
                <span class="s1">table</span><span class="s2">.</span><span class="s1">Ligatures </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_xmlReadLigatures</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClassCount </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">GlyphClasses</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()) + </span><span class="s6">1</span>
        <span class="s0">return </span><span class="s1">table</span>

    <span class="s0">def </span><span class="s1">_xmlReadState</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">state </span><span class="s2">= </span><span class="s1">AATState</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;Transition&quot;</span><span class="s2">:</span>
                <span class="s1">glyphClass </span><span class="s2">= </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;onGlyphClass&quot;</span><span class="s2">])</span>
                <span class="s1">transition </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">tableClass</span><span class="s2">()</span>
                <span class="s1">transition</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">eltContent</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
                <span class="s1">state</span><span class="s2">.</span><span class="s1">Transitions</span><span class="s2">[</span><span class="s1">glyphClass</span><span class="s2">] = </span><span class="s1">transition</span>
        <span class="s0">return </span><span class="s1">state</span>

    <span class="s0">def </span><span class="s1">_xmlReadLigComponents</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">ligComponents </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">_eltContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;LigComponent&quot;</span><span class="s2">:</span>
                <span class="s1">ligComponents</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">]))</span>
        <span class="s0">return </span><span class="s1">ligComponents</span>

    <span class="s0">def </span><span class="s1">_xmlReadLigatures</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">ligs </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">eltName</span><span class="s2">, </span><span class="s1">eltAttrs</span><span class="s2">, </span><span class="s1">_eltContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eltName </span><span class="s2">== </span><span class="s4">&quot;Ligature&quot;</span><span class="s2">:</span>
                <span class="s1">ligs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">eltAttrs</span><span class="s2">[</span><span class="s4">&quot;glyph&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">ligs</span>


<span class="s0">class </span><span class="s1">CIDGlyphMap</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">numCIDs </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">cid</span><span class="s2">, </span><span class="s1">glyphID </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">(</span><span class="s1">numCIDs</span><span class="s2">)):</span>
            <span class="s0">if </span><span class="s1">glyphID </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">cid</span><span class="s2">] = </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphName</span><span class="s2">(</span><span class="s1">glyphID</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">items </span><span class="s2">= {</span><span class="s1">cid</span><span class="s2">: </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">glyph</span><span class="s2">) </span><span class="s0">for </span><span class="s1">cid</span><span class="s2">, </span><span class="s1">glyph </span><span class="s0">in </span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">items</span><span class="s2">) + </span><span class="s6">1 </span><span class="s0">if </span><span class="s1">items </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">cid </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">):</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">items</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">cid</span><span class="s2">, </span><span class="s6">0xFFFF</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">eName</span><span class="s2">, </span><span class="s1">eAttrs</span><span class="s2">, </span><span class="s1">_eContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eName </span><span class="s2">== </span><span class="s4">&quot;CID&quot;</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eAttrs</span><span class="s2">[</span><span class="s4">&quot;cid&quot;</span><span class="s2">])] = </span><span class="s1">eAttrs</span><span class="s2">[</span><span class="s4">&quot;glyph&quot;</span><span class="s2">].</span><span class="s1">strip</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">cid</span><span class="s2">, </span><span class="s1">glyph </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s0">if </span><span class="s1">glyph </span><span class="s0">is not None and </span><span class="s1">glyph </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;CID&quot;</span><span class="s2">, </span><span class="s1">cid</span><span class="s2">=</span><span class="s1">cid</span><span class="s2">, </span><span class="s1">glyph</span><span class="s2">=</span><span class="s1">glyph</span><span class="s2">)</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">GlyphCIDMap</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">glyphOrder </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphOrder</span><span class="s2">()</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">()</span>
        <span class="s1">cids </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">count </span><span class="s2">&gt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">glyphOrder</span><span class="s2">):</span>
            <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span>
                <span class="s4">&quot;GlyphCIDMap has %d elements, &quot;</span>
                <span class="s4">&quot;but the font has only %d glyphs; &quot;</span>
                <span class="s4">&quot;ignoring the rest&quot; </span><span class="s2">% (</span><span class="s1">count</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">glyphOrder</span><span class="s2">))</span>
            <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">glyphID </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">cids</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">glyphOrder</span><span class="s2">))):</span>
            <span class="s1">cid </span><span class="s2">= </span><span class="s1">cids</span><span class="s2">[</span><span class="s1">glyphID</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">cid </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">glyphOrder</span><span class="s2">[</span><span class="s1">glyphID</span><span class="s2">]] = </span><span class="s1">cid</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">items </span><span class="s2">= {</span>
            <span class="s1">font</span><span class="s2">.</span><span class="s1">getGlyphID</span><span class="s2">(</span><span class="s1">g</span><span class="s2">): </span><span class="s1">cid</span>
            <span class="s0">for </span><span class="s1">g</span><span class="s2">, </span><span class="s1">cid </span><span class="s0">in </span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">cid </span><span class="s0">is not None and </span><span class="s1">cid </span><span class="s2">!= </span><span class="s6">0xFFFF</span>
        <span class="s2">}</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">items</span><span class="s2">) + </span><span class="s6">1 </span><span class="s0">if </span><span class="s1">items </span><span class="s0">else </span><span class="s6">0</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">count</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">glyphID </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">count</span><span class="s2">):</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">items</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">glyphID</span><span class="s2">, </span><span class="s6">0xFFFF</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">eName</span><span class="s2">, </span><span class="s1">eAttrs</span><span class="s2">, </span><span class="s1">_eContent </span><span class="s0">in </span><span class="s1">filter</span><span class="s2">(</span><span class="s1">istuple</span><span class="s2">, </span><span class="s1">content</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">eName </span><span class="s2">== </span><span class="s4">&quot;CID&quot;</span><span class="s2">:</span>
                <span class="s1">result</span><span class="s2">[</span><span class="s1">eAttrs</span><span class="s2">[</span><span class="s4">&quot;glyph&quot;</span><span class="s2">]] = </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">eAttrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">begintag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">cid </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s0">if </span><span class="s1">cid </span><span class="s0">is not None and </span><span class="s1">cid </span><span class="s2">!= </span><span class="s6">0xFFFF</span><span class="s2">:</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s4">&quot;CID&quot;</span><span class="s2">, </span><span class="s1">glyph</span><span class="s2">=</span><span class="s1">glyph</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">cid</span><span class="s2">)</span>
                <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">endtag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">DeltaValue</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">StartSize </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;StartSize&quot;</span><span class="s2">]</span>
        <span class="s1">EndSize </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;EndSize&quot;</span><span class="s2">]</span>
        <span class="s1">DeltaFormat </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;DeltaFormat&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">DeltaFormat </span><span class="s0">in </span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">), </span><span class="s4">&quot;illegal DeltaFormat&quot;</span>
        <span class="s1">nItems </span><span class="s2">= </span><span class="s1">EndSize </span><span class="s2">- </span><span class="s1">StartSize </span><span class="s2">+ </span><span class="s6">1</span>
        <span class="s1">nBits </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">DeltaFormat</span>
        <span class="s1">minusOffset </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">nBits</span>
        <span class="s1">mask </span><span class="s2">= (</span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">nBits</span><span class="s2">) - </span><span class="s6">1</span>
        <span class="s1">signMask </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">&lt;&lt; (</span><span class="s1">nBits </span><span class="s2">- </span><span class="s6">1</span><span class="s2">)</span>

        <span class="s1">DeltaValue </span><span class="s2">= []</span>
        <span class="s1">tmp</span><span class="s2">, </span><span class="s1">shift </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nItems</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">shift </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">tmp</span><span class="s2">, </span><span class="s1">shift </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShort</span><span class="s2">(), </span><span class="s6">16</span>
            <span class="s1">shift </span><span class="s2">= </span><span class="s1">shift </span><span class="s2">- </span><span class="s1">nBits</span>
            <span class="s1">value </span><span class="s2">= (</span><span class="s1">tmp </span><span class="s2">&gt;&gt; </span><span class="s1">shift</span><span class="s2">) &amp; </span><span class="s1">mask</span>
            <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s1">signMask</span><span class="s2">:</span>
                <span class="s1">value </span><span class="s2">= </span><span class="s1">value </span><span class="s2">- </span><span class="s1">minusOffset</span>
            <span class="s1">DeltaValue</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">DeltaValue</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">StartSize </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;StartSize&quot;</span><span class="s2">]</span>
        <span class="s1">EndSize </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;EndSize&quot;</span><span class="s2">]</span>
        <span class="s1">DeltaFormat </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;DeltaFormat&quot;</span><span class="s2">]</span>
        <span class="s1">DeltaValue </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s0">assert </span><span class="s1">DeltaFormat </span><span class="s0">in </span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">), </span><span class="s4">&quot;illegal DeltaFormat&quot;</span>
        <span class="s1">nItems </span><span class="s2">= </span><span class="s1">EndSize </span><span class="s2">- </span><span class="s1">StartSize </span><span class="s2">+ </span><span class="s6">1</span>
        <span class="s1">nBits </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">DeltaFormat</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">DeltaValue</span><span class="s2">) == </span><span class="s1">nItems</span>
        <span class="s1">mask </span><span class="s2">= (</span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">nBits</span><span class="s2">) - </span><span class="s6">1</span>

        <span class="s1">tmp</span><span class="s2">, </span><span class="s1">shift </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s6">16</span>
        <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s1">DeltaValue</span><span class="s2">:</span>
            <span class="s1">shift </span><span class="s2">= </span><span class="s1">shift </span><span class="s2">- </span><span class="s1">nBits</span>
            <span class="s1">tmp </span><span class="s2">= </span><span class="s1">tmp </span><span class="s2">| ((</span><span class="s1">value </span><span class="s2">&amp; </span><span class="s1">mask</span><span class="s2">) &lt;&lt; </span><span class="s1">shift</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">shift </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
                <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">)</span>
                <span class="s1">tmp</span><span class="s2">, </span><span class="s1">shift </span><span class="s2">= </span><span class="s6">0</span><span class="s2">, </span><span class="s6">16</span>
        <span class="s0">if </span><span class="s1">shift </span><span class="s2">!= </span><span class="s6">16</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShort</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)])</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">VarIdxMapValue</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">fmt </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;EntryFormat&quot;</span><span class="s2">]</span>
        <span class="s1">nItems </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;MappingCount&quot;</span><span class="s2">]</span>

        <span class="s1">innerBits </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">+ (</span><span class="s1">fmt </span><span class="s2">&amp; </span><span class="s6">0x000F</span><span class="s2">)</span>
        <span class="s1">innerMask </span><span class="s2">= (</span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">innerBits</span><span class="s2">) - </span><span class="s6">1</span>
        <span class="s1">outerMask </span><span class="s2">= </span><span class="s6">0xFFFFFFFF </span><span class="s2">- </span><span class="s1">innerMask</span>
        <span class="s1">outerShift </span><span class="s2">= </span><span class="s6">16 </span><span class="s2">- </span><span class="s1">innerBits</span>

        <span class="s1">entrySize </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">+ ((</span><span class="s1">fmt </span><span class="s2">&amp; </span><span class="s6">0x0030</span><span class="s2">) &gt;&gt; </span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">readArray </span><span class="s2">= {</span>
            <span class="s6">1</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8Array</span><span class="s2">,</span>
            <span class="s6">2</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">,</span>
            <span class="s6">3</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt24Array</span><span class="s2">,</span>
            <span class="s6">4</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULongArray</span><span class="s2">,</span>
        <span class="s2">}[</span><span class="s1">entrySize</span><span class="s2">]</span>

        <span class="s0">return </span><span class="s2">[</span>
            <span class="s2">(((</span><span class="s1">raw </span><span class="s2">&amp; </span><span class="s1">outerMask</span><span class="s2">) &lt;&lt; </span><span class="s1">outerShift</span><span class="s2">) | (</span><span class="s1">raw </span><span class="s2">&amp; </span><span class="s1">innerMask</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">raw </span><span class="s0">in </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">nItems</span><span class="s2">)</span>
        <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">fmt </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;EntryFormat&quot;</span><span class="s2">]</span>
        <span class="s1">mapping </span><span class="s2">= </span><span class="s1">value</span>
        <span class="s1">writer</span><span class="s2">[</span><span class="s4">&quot;MappingCount&quot;</span><span class="s2">].</span><span class="s1">setValue</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">mapping</span><span class="s2">))</span>

        <span class="s1">innerBits </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">+ (</span><span class="s1">fmt </span><span class="s2">&amp; </span><span class="s6">0x000F</span><span class="s2">)</span>
        <span class="s1">innerMask </span><span class="s2">= (</span><span class="s6">1 </span><span class="s2">&lt;&lt; </span><span class="s1">innerBits</span><span class="s2">) - </span><span class="s6">1</span>
        <span class="s1">outerShift </span><span class="s2">= </span><span class="s6">16 </span><span class="s2">- </span><span class="s1">innerBits</span>

        <span class="s1">entrySize </span><span class="s2">= </span><span class="s6">1 </span><span class="s2">+ ((</span><span class="s1">fmt </span><span class="s2">&amp; </span><span class="s6">0x0030</span><span class="s2">) &gt;&gt; </span><span class="s6">4</span><span class="s2">)</span>
        <span class="s1">writeArray </span><span class="s2">= {</span>
            <span class="s6">1</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt8Array</span><span class="s2">,</span>
            <span class="s6">2</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShortArray</span><span class="s2">,</span>
            <span class="s6">3</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt24Array</span><span class="s2">,</span>
            <span class="s6">4</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULongArray</span><span class="s2">,</span>
        <span class="s2">}[</span><span class="s1">entrySize</span><span class="s2">]</span>

        <span class="s1">writeArray</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">(((</span><span class="s1">idx </span><span class="s2">&amp; </span><span class="s6">0xFFFF0000</span><span class="s2">) &gt;&gt; </span><span class="s1">outerShift</span><span class="s2">) | (</span><span class="s1">idx </span><span class="s2">&amp; </span><span class="s1">innerMask</span><span class="s2">))</span>
                <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">mapping</span>
            <span class="s2">]</span>
        <span class="s2">)</span>


<span class="s0">class </span><span class="s1">VarDataValue</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">values </span><span class="s2">= []</span>

        <span class="s1">regionCount </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;VarRegionCount&quot;</span><span class="s2">]</span>
        <span class="s1">wordCount </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;NumShorts&quot;</span><span class="s2">]</span>

        <span class="s5"># https://github.com/fonttools/fonttools/issues/2279</span>
        <span class="s1">longWords </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">wordCount </span><span class="s2">&amp; </span><span class="s6">0x8000</span><span class="s2">)</span>
        <span class="s1">wordCount </span><span class="s2">= </span><span class="s1">wordCount </span><span class="s2">&amp; </span><span class="s6">0x7FFF</span>

        <span class="s0">if </span><span class="s1">longWords</span><span class="s2">:</span>
            <span class="s1">readBigArray</span><span class="s2">, </span><span class="s1">readSmallArray </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readLongArray</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readShortArray</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">readBigArray</span><span class="s2">, </span><span class="s1">readSmallArray </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readShortArray</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readInt8Array</span>

        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">regionCount</span><span class="s2">, </span><span class="s1">wordCount</span><span class="s2">), </span><span class="s1">max</span><span class="s2">(</span><span class="s1">regionCount</span><span class="s2">, </span><span class="s1">wordCount</span><span class="s2">)</span>
        <span class="s1">values</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">readBigArray</span><span class="s2">(</span><span class="s1">n1</span><span class="s2">))</span>
        <span class="s1">values</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">readSmallArray</span><span class="s2">(</span><span class="s1">n2 </span><span class="s2">- </span><span class="s1">n1</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">n2 </span><span class="s2">&gt; </span><span class="s1">regionCount</span><span class="s2">:  </span><span class="s5"># Padding</span>
            <span class="s0">del </span><span class="s1">values</span><span class="s2">[</span><span class="s1">regionCount</span><span class="s2">:]</span>

        <span class="s0">return </span><span class="s1">values</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">regionCount </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;VarRegionCount&quot;</span><span class="s2">]</span>
        <span class="s1">wordCount </span><span class="s2">= </span><span class="s1">tableDict</span><span class="s2">[</span><span class="s4">&quot;NumShorts&quot;</span><span class="s2">]</span>

        <span class="s5"># https://github.com/fonttools/fonttools/issues/2279</span>
        <span class="s1">longWords </span><span class="s2">= </span><span class="s1">bool</span><span class="s2">(</span><span class="s1">wordCount </span><span class="s2">&amp; </span><span class="s6">0x8000</span><span class="s2">)</span>
        <span class="s1">wordCount </span><span class="s2">= </span><span class="s1">wordCount </span><span class="s2">&amp; </span><span class="s6">0x7FFF</span>

        <span class="s2">(</span><span class="s1">writeBigArray</span><span class="s2">, </span><span class="s1">writeSmallArray</span><span class="s2">) = {</span>
            <span class="s0">False</span><span class="s2">: (</span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeShortArray</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeInt8Array</span><span class="s2">),</span>
            <span class="s0">True</span><span class="s2">: (</span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeLongArray</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeShortArray</span><span class="s2">),</span>
        <span class="s2">}[</span><span class="s1">longWords</span><span class="s2">]</span>

        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">regionCount</span><span class="s2">, </span><span class="s1">wordCount</span><span class="s2">), </span><span class="s1">max</span><span class="s2">(</span><span class="s1">regionCount</span><span class="s2">, </span><span class="s1">wordCount</span><span class="s2">)</span>
        <span class="s1">writeBigArray</span><span class="s2">(</span><span class="s1">values</span><span class="s2">[:</span><span class="s1">n1</span><span class="s2">])</span>
        <span class="s1">writeSmallArray</span><span class="s2">(</span><span class="s1">values</span><span class="s2">[</span><span class="s1">n1</span><span class="s2">:</span><span class="s1">regionCount</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">n2 </span><span class="s2">&gt; </span><span class="s1">regionCount</span><span class="s2">:  </span><span class="s5"># Padding</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeSmallArray</span><span class="s2">([</span><span class="s6">0</span><span class="s2">] * (</span><span class="s1">n2 </span><span class="s2">- </span><span class="s1">regionCount</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)])</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TupleValues</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">TupleVariation</span><span class="s2">.</span><span class="s1">decompileDeltas_</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)[</span><span class="s6">0</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">TupleVariation</span><span class="s2">.</span><span class="s1">compileDeltaValues_</span><span class="s2">(</span><span class="s1">values</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">safeEval</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">[</span><span class="s4">&quot;value&quot;</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)])</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">CFF2Index</span><span class="s2">(</span><span class="s1">BaseConverter</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">,</span>
        <span class="s1">repeat</span><span class="s2">,</span>
        <span class="s1">aux</span><span class="s2">,</span>
        <span class="s1">tableClass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">itemClass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">itemConverterClass</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">description</span><span class="s2">=</span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">BaseConverter</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">repeat</span><span class="s2">, </span><span class="s1">aux</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">, </span><span class="s1">description</span><span class="s2">=</span><span class="s1">description</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass </span><span class="s2">= </span><span class="s1">itemClass</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s2">= (</span>
            <span class="s1">itemConverterClass</span><span class="s2">() </span><span class="s0">if </span><span class="s1">itemConverterClass </span><span class="s0">is not None else None</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s1">count </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULong</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">count </span><span class="s2">== </span><span class="s6">0</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s2">[]</span>
        <span class="s1">offSize </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">getReadArray</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">offSize</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">{</span>
                <span class="s6">1</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt8Array</span><span class="s2">,</span>
                <span class="s6">2</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUShortArray</span><span class="s2">,</span>
                <span class="s6">3</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readUInt24Array</span><span class="s2">,</span>
                <span class="s6">4</span><span class="s2">: </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readULongArray</span><span class="s2">,</span>
            <span class="s2">}[</span><span class="s1">offSize</span><span class="s2">]</span>

        <span class="s1">readArray </span><span class="s2">= </span><span class="s1">getReadArray</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">offSize</span><span class="s2">)</span>

        <span class="s1">lazy </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">lazy </span><span class="s0">is not False and </span><span class="s1">count </span><span class="s2">&gt; </span><span class="s6">8</span>
        <span class="s0">if not </span><span class="s1">lazy</span><span class="s2">:</span>
            <span class="s1">offsets </span><span class="s2">= </span><span class="s1">readArray</span><span class="s2">(</span><span class="s1">count </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">)</span>
            <span class="s1">items </span><span class="s2">= []</span>
            <span class="s1">lastOffset </span><span class="s2">= </span><span class="s1">offsets</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
            <span class="s1">reader</span><span class="s2">.</span><span class="s1">readData</span><span class="s2">(</span><span class="s1">lastOffset </span><span class="s2">- </span><span class="s6">1</span><span class="s2">)  </span><span class="s5"># In case first offset is not 1</span>

            <span class="s0">for </span><span class="s1">offset </span><span class="s0">in </span><span class="s1">offsets</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">lastOffset </span><span class="s2">&lt;= </span><span class="s1">offset</span>
                <span class="s1">item </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">readData</span><span class="s2">(</span><span class="s1">offset </span><span class="s2">- </span><span class="s1">lastOffset</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass</span><span class="s2">()</span>
                    <span class="s1">obj</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">localState</span><span class="s2">)</span>
                    <span class="s1">item </span><span class="s2">= </span><span class="s1">obj</span>
                <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>

                <span class="s1">items</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
                <span class="s1">lastOffset </span><span class="s2">= </span><span class="s1">offset</span>
            <span class="s0">return </span><span class="s1">items</span>
        <span class="s0">else</span><span class="s2">:</span>

            <span class="s0">def </span><span class="s1">get_read_item</span><span class="s2">():</span>
                <span class="s1">reader_copy </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">offset_pos </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">pos</span>
                <span class="s1">data_pos </span><span class="s2">= </span><span class="s1">offset_pos </span><span class="s2">+ (</span><span class="s1">count </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">) * </span><span class="s1">offSize </span><span class="s2">- </span><span class="s6">1</span>
                <span class="s1">readArray </span><span class="s2">= </span><span class="s1">getReadArray</span><span class="s2">(</span><span class="s1">reader_copy</span><span class="s2">, </span><span class="s1">offSize</span><span class="s2">)</span>

                <span class="s0">def </span><span class="s1">read_item</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
                    <span class="s1">reader_copy</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">offset_pos </span><span class="s2">+ </span><span class="s1">i </span><span class="s2">* </span><span class="s1">offSize</span><span class="s2">)</span>
                    <span class="s1">offsets </span><span class="s2">= </span><span class="s1">readArray</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
                    <span class="s1">reader_copy</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s1">data_pos </span><span class="s2">+ </span><span class="s1">offsets</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
                    <span class="s1">item </span><span class="s2">= </span><span class="s1">reader_copy</span><span class="s2">.</span><span class="s1">readData</span><span class="s2">(</span><span class="s1">offsets</span><span class="s2">[</span><span class="s6">1</span><span class="s2">] - </span><span class="s1">offsets</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

                    <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass </span><span class="s0">is not None</span><span class="s2">:</span>
                        <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass</span><span class="s2">()</span>
                        <span class="s1">obj</span><span class="s2">.</span><span class="s1">decompile</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">reader_copy</span><span class="s2">.</span><span class="s1">localState</span><span class="s2">)</span>
                        <span class="s1">item </span><span class="s2">= </span><span class="s1">obj</span>
                    <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s0">is not None</span><span class="s2">:</span>
                        <span class="s1">item </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">item</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">item</span>

                <span class="s0">return </span><span class="s1">read_item</span>

            <span class="s1">read_item </span><span class="s2">= </span><span class="s1">get_read_item</span><span class="s2">()</span>
            <span class="s1">l </span><span class="s2">= </span><span class="s1">LazyList</span><span class="s2">([</span><span class="s1">read_item</span><span class="s2">] * </span><span class="s1">count</span><span class="s2">)</span>

            <span class="s5"># TODO: Advance reader</span>

            <span class="s0">return </span><span class="s1">l</span>

    <span class="s0">def </span><span class="s1">write</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">repeatIndex</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">items </span><span class="s2">= </span><span class="s1">values</span>

        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULong</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">items</span><span class="s2">))</span>
        <span class="s0">if not </span><span class="s1">len</span><span class="s2">(</span><span class="s1">items</span><span class="s2">):</span>
            <span class="s0">return</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">items </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">font</span><span class="s2">) </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">items</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">items </span><span class="s2">= [</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_converter</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">item </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">items</span><span class="s2">)</span>
            <span class="s2">]</span>

        <span class="s1">offsets </span><span class="s2">= [</span><span class="s1">len</span><span class="s2">(</span><span class="s1">item</span><span class="s2">) </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">items</span><span class="s2">]</span>
        <span class="s1">offsets </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">accumulate</span><span class="s2">(</span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">initial</span><span class="s2">=</span><span class="s6">1</span><span class="s2">))</span>

        <span class="s1">lastOffset </span><span class="s2">= </span><span class="s1">offsets</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s1">offSize </span><span class="s2">= (</span>
            <span class="s6">1</span>
            <span class="s0">if </span><span class="s1">lastOffset </span><span class="s2">&lt; </span><span class="s6">0x100</span>
            <span class="s0">else </span><span class="s6">2 </span><span class="s0">if </span><span class="s1">lastOffset </span><span class="s2">&lt; </span><span class="s6">0x10000 </span><span class="s0">else </span><span class="s6">3 </span><span class="s0">if </span><span class="s1">lastOffset </span><span class="s2">&lt; </span><span class="s6">0x1000000 </span><span class="s0">else </span><span class="s6">4</span>
        <span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt8</span><span class="s2">(</span><span class="s1">offSize</span><span class="s2">)</span>

        <span class="s1">writeArray </span><span class="s2">= {</span>
            <span class="s6">1</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt8Array</span><span class="s2">,</span>
            <span class="s6">2</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUShortArray</span><span class="s2">,</span>
            <span class="s6">3</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeUInt24Array</span><span class="s2">,</span>
            <span class="s6">4</span><span class="s2">: </span><span class="s1">writer</span><span class="s2">.</span><span class="s1">writeULongArray</span><span class="s2">,</span>
        <span class="s2">}[</span><span class="s1">offSize</span><span class="s2">]</span>

        <span class="s1">writeArray</span><span class="s2">(</span><span class="s1">offsets</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">items</span><span class="s2">:</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writeData</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">obj </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass</span><span class="s2">()</span>
            <span class="s1">obj</span><span class="s2">.</span><span class="s1">fromXML</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">obj</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter</span><span class="s2">.</span><span class="s1">xmlRead</span><span class="s2">(</span><span class="s1">attrs</span><span class="s2">, </span><span class="s1">content</span><span class="s2">, </span><span class="s1">font</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_itemClass </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">item </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
                <span class="s1">item</span><span class="s2">.</span><span class="s1">toXML</span><span class="s2">(</span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, [(</span><span class="s4">&quot;index&quot;</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)], </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_converter </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">item </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_converter</span><span class="s2">.</span><span class="s1">xmlWrite</span><span class="s2">(</span>
                    <span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;index&quot;</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)]</span>
                <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">LookupFlag</span><span class="s2">(</span><span class="s1">UShort</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">xmlWrite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xmlWriter</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs</span><span class="s2">):</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">simpletag</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">attrs </span><span class="s2">+ [(</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)])</span>
        <span class="s1">flags </span><span class="s2">= []</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x01</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;rightToLeft&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x02</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;ignoreBaseGlyphs&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x04</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;ignoreLigatures&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x08</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;ignoreMarks&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0x10</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;useMarkFilteringSet&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">value </span><span class="s2">&amp; </span><span class="s6">0xFF00</span><span class="s2">:</span>
            <span class="s1">flags</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;markAttachmentType[%i]&quot; </span><span class="s2">% (</span><span class="s1">value </span><span class="s2">&gt;&gt; </span><span class="s6">8</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">flags</span><span class="s2">:</span>
            <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">comment</span><span class="s2">(</span><span class="s4">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">flags</span><span class="s2">))</span>
        <span class="s1">xmlWriter</span><span class="s2">.</span><span class="s1">newline</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">_UInt8Enum</span><span class="s2">(</span><span class="s1">UInt8</span><span class="s2">):</span>
    <span class="s1">enumClass </span><span class="s2">= </span><span class="s1">NotImplemented</span>

    <span class="s0">def </span><span class="s1">read</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">enumClass</span><span class="s2">(</span><span class="s1">super</span><span class="s2">().</span><span class="s1">read</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">font</span><span class="s2">, </span><span class="s1">tableDict</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">fromString</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">enumClass</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">())</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">toString</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">, </span><span class="s1">value</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">enumClass</span><span class="s2">(</span><span class="s1">value</span><span class="s2">).</span><span class="s1">name</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">ExtendMode</span><span class="s2">(</span><span class="s1">_UInt8Enum</span><span class="s2">):</span>
    <span class="s1">enumClass </span><span class="s2">= </span><span class="s1">_ExtendMode</span>


<span class="s0">class </span><span class="s1">CompositeMode</span><span class="s2">(</span><span class="s1">_UInt8Enum</span><span class="s2">):</span>
    <span class="s1">enumClass </span><span class="s2">= </span><span class="s1">_CompositeMode</span>


<span class="s1">converterMapping </span><span class="s2">= {</span>
    <span class="s5"># type      class</span>
    <span class="s4">&quot;int8&quot;</span><span class="s2">: </span><span class="s1">Int8</span><span class="s2">,</span>
    <span class="s4">&quot;int16&quot;</span><span class="s2">: </span><span class="s1">Short</span><span class="s2">,</span>
    <span class="s4">&quot;uint8&quot;</span><span class="s2">: </span><span class="s1">UInt8</span><span class="s2">,</span>
    <span class="s4">&quot;uint16&quot;</span><span class="s2">: </span><span class="s1">UShort</span><span class="s2">,</span>
    <span class="s4">&quot;uint24&quot;</span><span class="s2">: </span><span class="s1">UInt24</span><span class="s2">,</span>
    <span class="s4">&quot;uint32&quot;</span><span class="s2">: </span><span class="s1">ULong</span><span class="s2">,</span>
    <span class="s4">&quot;char64&quot;</span><span class="s2">: </span><span class="s1">Char64</span><span class="s2">,</span>
    <span class="s4">&quot;Flags32&quot;</span><span class="s2">: </span><span class="s1">Flags32</span><span class="s2">,</span>
    <span class="s4">&quot;VarIndex&quot;</span><span class="s2">: </span><span class="s1">VarIndex</span><span class="s2">,</span>
    <span class="s4">&quot;Version&quot;</span><span class="s2">: </span><span class="s1">Version</span><span class="s2">,</span>
    <span class="s4">&quot;Tag&quot;</span><span class="s2">: </span><span class="s1">Tag</span><span class="s2">,</span>
    <span class="s4">&quot;GlyphID&quot;</span><span class="s2">: </span><span class="s1">GlyphID</span><span class="s2">,</span>
    <span class="s4">&quot;GlyphID32&quot;</span><span class="s2">: </span><span class="s1">GlyphID32</span><span class="s2">,</span>
    <span class="s4">&quot;NameID&quot;</span><span class="s2">: </span><span class="s1">NameID</span><span class="s2">,</span>
    <span class="s4">&quot;DeciPoints&quot;</span><span class="s2">: </span><span class="s1">DeciPoints</span><span class="s2">,</span>
    <span class="s4">&quot;Fixed&quot;</span><span class="s2">: </span><span class="s1">Fixed</span><span class="s2">,</span>
    <span class="s4">&quot;F2Dot14&quot;</span><span class="s2">: </span><span class="s1">F2Dot14</span><span class="s2">,</span>
    <span class="s4">&quot;Angle&quot;</span><span class="s2">: </span><span class="s1">Angle</span><span class="s2">,</span>
    <span class="s4">&quot;BiasedAngle&quot;</span><span class="s2">: </span><span class="s1">BiasedAngle</span><span class="s2">,</span>
    <span class="s4">&quot;struct&quot;</span><span class="s2">: </span><span class="s1">Struct</span><span class="s2">,</span>
    <span class="s4">&quot;Offset&quot;</span><span class="s2">: </span><span class="s1">Table</span><span class="s2">,</span>
    <span class="s4">&quot;LOffset&quot;</span><span class="s2">: </span><span class="s1">LTable</span><span class="s2">,</span>
    <span class="s4">&quot;Offset24&quot;</span><span class="s2">: </span><span class="s1">Table24</span><span class="s2">,</span>
    <span class="s4">&quot;ValueRecord&quot;</span><span class="s2">: </span><span class="s1">ValueRecord</span><span class="s2">,</span>
    <span class="s4">&quot;DeltaValue&quot;</span><span class="s2">: </span><span class="s1">DeltaValue</span><span class="s2">,</span>
    <span class="s4">&quot;VarIdxMapValue&quot;</span><span class="s2">: </span><span class="s1">VarIdxMapValue</span><span class="s2">,</span>
    <span class="s4">&quot;VarDataValue&quot;</span><span class="s2">: </span><span class="s1">VarDataValue</span><span class="s2">,</span>
    <span class="s4">&quot;LookupFlag&quot;</span><span class="s2">: </span><span class="s1">LookupFlag</span><span class="s2">,</span>
    <span class="s4">&quot;ExtendMode&quot;</span><span class="s2">: </span><span class="s1">ExtendMode</span><span class="s2">,</span>
    <span class="s4">&quot;CompositeMode&quot;</span><span class="s2">: </span><span class="s1">CompositeMode</span><span class="s2">,</span>
    <span class="s4">&quot;STATFlags&quot;</span><span class="s2">: </span><span class="s1">STATFlags</span><span class="s2">,</span>
    <span class="s4">&quot;TupleList&quot;</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">CFF2Index</span><span class="s2">, </span><span class="s1">itemConverterClass</span><span class="s2">=</span><span class="s1">TupleValues</span><span class="s2">),</span>
    <span class="s4">&quot;VarCompositeGlyphList&quot;</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">CFF2Index</span><span class="s2">, </span><span class="s1">itemClass</span><span class="s2">=</span><span class="s1">VarCompositeGlyph</span><span class="s2">),</span>
    <span class="s5"># AAT</span>
    <span class="s4">&quot;CIDGlyphMap&quot;</span><span class="s2">: </span><span class="s1">CIDGlyphMap</span><span class="s2">,</span>
    <span class="s4">&quot;GlyphCIDMap&quot;</span><span class="s2">: </span><span class="s1">GlyphCIDMap</span><span class="s2">,</span>
    <span class="s4">&quot;MortChain&quot;</span><span class="s2">: </span><span class="s1">StructWithLength</span><span class="s2">,</span>
    <span class="s4">&quot;MortSubtable&quot;</span><span class="s2">: </span><span class="s1">StructWithLength</span><span class="s2">,</span>
    <span class="s4">&quot;MorxChain&quot;</span><span class="s2">: </span><span class="s1">StructWithLength</span><span class="s2">,</span>
    <span class="s4">&quot;MorxSubtable&quot;</span><span class="s2">: </span><span class="s1">MorxSubtableConverter</span><span class="s2">,</span>
    <span class="s5"># &quot;Template&quot; types</span>
    <span class="s4">&quot;AATLookup&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">C</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">AATLookup</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">C</span><span class="s2">),</span>
    <span class="s4">&quot;AATLookupWithDataOffset&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">C</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">AATLookupWithDataOffset</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">C</span><span class="s2">),</span>
    <span class="s4">&quot;STXHeader&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">C</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">STXHeader</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">C</span><span class="s2">),</span>
    <span class="s4">&quot;OffsetTo&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">C</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">Table</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">C</span><span class="s2">),</span>
    <span class="s4">&quot;LOffsetTo&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">C</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">LTable</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">C</span><span class="s2">),</span>
    <span class="s4">&quot;LOffset24To&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">C</span><span class="s2">: </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">Table24</span><span class="s2">, </span><span class="s1">tableClass</span><span class="s2">=</span><span class="s1">C</span><span class="s2">),</span>
<span class="s2">}</span>
</pre>
</body>
</html>