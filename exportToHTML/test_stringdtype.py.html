<html>
<head>
<title>test_stringdtype.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_stringdtype.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">concurrent</span><span class="s2">.</span><span class="s1">futures</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">pickle</span>
<span class="s0">import </span><span class="s1">string</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">tempfile</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">dtypes </span><span class="s0">import </span><span class="s1">StringDType</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">_natype </span><span class="s0">import </span><span class="s1">pd_NA</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">IS_PYPY</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">string_list</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s3">&quot;abc&quot;</span><span class="s2">, </span><span class="s3">&quot;def&quot;</span><span class="s2">, </span><span class="s3">&quot;ghi&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">, </span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot; </span><span class="s2">* </span><span class="s4">100</span><span class="s2">, </span><span class="s3">&quot;Abc&quot; </span><span class="s2">* </span><span class="s4">1000</span><span class="s2">, </span><span class="s3">&quot;DEF&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">random_string_list</span><span class="s2">():</span>
    <span class="s1">chars </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">string</span><span class="s2">.</span><span class="s1">ascii_letters </span><span class="s2">+ </span><span class="s1">string</span><span class="s2">.</span><span class="s1">digits</span><span class="s2">)</span>
    <span class="s1">chars </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">chars</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;U1&quot;</span><span class="s2">)</span>
    <span class="s1">ret </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">chars</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">100 </span><span class="s2">* </span><span class="s4">10</span><span class="s2">, </span><span class="s1">replace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ret</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(</span><span class="s3">&quot;U100&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">coerce</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span>
    <span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;unset&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">pd_NA</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s3">&quot;nan&quot;</span><span class="s2">), </span><span class="s3">&quot;__nan__&quot;</span><span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;unset&quot;</span><span class="s2">, </span><span class="s3">&quot;None&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas.NA&quot;</span><span class="s2">, </span><span class="s3">&quot;np.nan&quot;</span><span class="s2">, </span><span class="s3">&quot;float('nan')&quot;</span><span class="s2">, </span><span class="s3">&quot;string nan&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">na_object</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s0">def </span><span class="s1">get_dtype</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
    <span class="s5"># explicit is check for pd_NA because != with pd_NA returns pd_NA</span>
    <span class="s0">if </span><span class="s1">na_object </span><span class="s0">is </span><span class="s1">pd_NA </span><span class="s0">or </span><span class="s1">na_object </span><span class="s2">!= </span><span class="s3">&quot;unset&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">=</span><span class="s1">coerce</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s1">coerce</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">get_dtype</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">)</span>


<span class="s5"># second copy for cast tests to do a cartesian product over dtypes</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">coerce2</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span>
    <span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;unset&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">pd_NA</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s3">&quot;nan&quot;</span><span class="s2">), </span><span class="s3">&quot;__nan__&quot;</span><span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;unset&quot;</span><span class="s2">, </span><span class="s3">&quot;None&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas.NA&quot;</span><span class="s2">, </span><span class="s3">&quot;np.nan&quot;</span><span class="s2">, </span><span class="s3">&quot;float('nan')&quot;</span><span class="s2">, </span><span class="s3">&quot;string nan&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">na_object2</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">dtype2</span><span class="s2">(</span><span class="s1">na_object2</span><span class="s2">, </span><span class="s1">coerce2</span><span class="s2">):</span>
    <span class="s5"># explicit is check for pd_NA because != with pd_NA returns pd_NA</span>
    <span class="s0">if </span><span class="s1">na_object2 </span><span class="s0">is </span><span class="s1">pd_NA </span><span class="s0">or </span><span class="s1">na_object2 </span><span class="s2">!= </span><span class="s3">&quot;unset&quot;</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">na_object2</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">=</span><span class="s1">coerce2</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s1">coerce2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_dtype_creation</span><span class="s2">():</span>
    <span class="s1">hashes </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">coerce </span><span class="s0">is True</span>
    <span class="s1">hashes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s1">dt </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">na_object </span><span class="s0">is None and </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">coerce </span><span class="s0">is True</span>
    <span class="s1">hashes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s1">dt </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">coerce </span><span class="s0">is False</span>
    <span class="s1">hashes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s1">dt </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">na_object </span><span class="s0">is None and </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">coerce </span><span class="s0">is False</span>
    <span class="s1">hashes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">hashes</span><span class="s2">) == </span><span class="s4">4</span>

    <span class="s1">dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dt </span><span class="s2">== </span><span class="s1">StringDType</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;T&quot;</span>
    <span class="s0">assert </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">char </span><span class="s2">== </span><span class="s3">&quot;T&quot;</span>

    <span class="s1">hashes</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">hash</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">hashes</span><span class="s2">) == </span><span class="s4">4</span>


<span class="s0">def </span><span class="s1">test_dtype_equality</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">assert </span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
    <span class="s0">for </span><span class="s1">ch </span><span class="s0">in </span><span class="s3">&quot;SU&quot;</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">dtype </span><span class="s2">!= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">ch</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">dtype </span><span class="s2">!= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">ch</span><span class="s0">}</span><span class="s3">8&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_dtype_repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">coerce</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) == </span><span class="s3">&quot;StringDType()&quot;</span>
    <span class="s0">elif </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">coerce</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) == </span><span class="s3">f&quot;StringDType(na_object=</span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span><span class="s0">}</span><span class="s3">)&quot;</span>
    <span class="s0">elif not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">) == </span><span class="s3">&quot;StringDType(coerce=False)&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s1">repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s2">== </span><span class="s3">f&quot;StringDType(na_object=</span><span class="s0">{</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span><span class="s0">}</span><span class="s3">, coerce=False)&quot;</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_create_with_na</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;does not have an na object&quot;</span><span class="s2">)</span>
    <span class="s1">na_val </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
    <span class="s1">string_list </span><span class="s2">= [</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s1">na_val</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">]</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">) == </span><span class="s3">&quot;[&quot; </span><span class="s2">+ </span><span class="s3">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">string_list</span><span class="s2">]) + </span><span class="s3">&quot;]&quot;</span>
    <span class="s0">assert </span><span class="s1">arr</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)))</span>
<span class="s0">def </span><span class="s1">test_set_replace_na</span><span class="s2">(</span><span class="s1">i</span><span class="s2">):</span>
    <span class="s5"># Test strings of various lengths can be set to NaN and then replaced.</span>
    <span class="s1">s_empty </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s1">s_short </span><span class="s2">= </span><span class="s3">&quot;0123456789&quot;</span>
    <span class="s1">s_medium </span><span class="s2">= </span><span class="s3">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
    <span class="s1">s_long </span><span class="s2">= </span><span class="s3">&quot;-=+&quot; </span><span class="s2">* </span><span class="s4">100</span>
    <span class="s1">strings </span><span class="s2">= [</span><span class="s1">s_medium</span><span class="s2">, </span><span class="s1">s_empty</span><span class="s2">, </span><span class="s1">s_short</span><span class="s2">, </span><span class="s1">s_medium</span><span class="s2">, </span><span class="s1">s_long</span><span class="s2">]</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s2">[</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">s_medium</span><span class="s2">+</span><span class="s1">s_short</span><span class="s2">, </span><span class="s1">s_short</span><span class="s2">, </span><span class="s1">s_empty</span><span class="s2">, </span><span class="s1">s_long</span><span class="s2">]:</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s1">s</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">[:</span><span class="s1">i</span><span class="s2">] + [</span><span class="s1">s</span><span class="s2">] + </span><span class="s1">strings</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:])</span>


<span class="s0">def </span><span class="s1">test_null_roundtripping</span><span class="s2">():</span>
    <span class="s1">data </span><span class="s2">= [</span><span class="s3">&quot;hello</span><span class="s0">\0</span><span class="s3">world&quot;</span><span class="s2">, </span><span class="s3">&quot;ABC</span><span class="s0">\0</span><span class="s3">DEF</span><span class="s0">\0\0</span><span class="s3">&quot;</span><span class="s2">]</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">arr</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">arr</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_string_too_large_error</span><span class="s2">():</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MemoryError</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">* (</span><span class="s4">2</span><span class="s2">**</span><span class="s4">63 </span><span class="s2">- </span><span class="s4">2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;data&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;abc&quot;</span><span class="s2">, </span><span class="s3">&quot;def&quot;</span><span class="s2">, </span><span class="s3">&quot;ghi&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ¤£&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ“µ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜°&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸšœ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ™ƒ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜¾&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ˜¹&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸš &quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸšŒ&quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_array_creation_utf8</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">) == </span><span class="s3">&quot;[&quot; </span><span class="s2">+ </span><span class="s3">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">&quot;'&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">d</span><span class="s2">) + </span><span class="s3">&quot;'&quot; </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]) + </span><span class="s3">&quot;]&quot;</span>
    <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;data&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s6">b&quot;abc&quot;</span><span class="s2">, </span><span class="s6">b&quot;def&quot;</span><span class="s2">, </span><span class="s6">b&quot;ghi&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s1">object</span><span class="s2">, </span><span class="s1">object</span><span class="s2">, </span><span class="s1">object</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_scalars_string_conversion</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">coerce</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">str</span><span class="s2">(</span><span class="s1">d</span><span class="s2">) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">data</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;strings&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;this&quot;</span><span class="s2">, </span><span class="s3">&quot;is&quot;</span><span class="s2">, </span><span class="s3">&quot;an&quot;</span><span class="s2">, </span><span class="s3">&quot;array&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;â‚¬&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Š&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot; Aâ˜ƒâ‚¬Â¢ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot;â˜ƒâ‚¬ðŸ˜Š AÂ¢&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Šâ˜ƒAÂ¢ â‚¬&quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_self_casts</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype2</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s1">strings </span><span class="s2">= </span><span class="s1">strings </span><span class="s2">+ [</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">]</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s1">strings </span><span class="s2">= </span><span class="s1">strings </span><span class="s2">+ [</span><span class="s3">&quot;&quot;</span><span class="s2">]</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">newarr </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">newarr</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">str</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;safe&quot;</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">newarr</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype2</span><span class="s2">.</span><span class="s1">na_object</span>
        <span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;safe&quot;</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">newarr</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s3">&quot;&quot;</span>
        <span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;safe&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;safe&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype2</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s1">na1 </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
        <span class="s1">na2 </span><span class="s2">= </span><span class="s1">dtype2</span><span class="s2">.</span><span class="s1">na_object</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">na1 </span><span class="s0">is not </span><span class="s1">na2 </span><span class="s0">and</span>
             <span class="s5"># check for pd_NA first because bool(pd_NA) is an error</span>
             <span class="s2">((</span><span class="s1">na1 </span><span class="s0">is </span><span class="s1">pd_NA </span><span class="s0">or </span><span class="s1">na2 </span><span class="s0">is </span><span class="s1">pd_NA</span><span class="s2">) </span><span class="s0">or</span>
              <span class="s5"># the second check is a NaN check, spelled this way</span>
              <span class="s5"># to avoid errors from math.isnan and np.isnan</span>
              <span class="s2">(</span><span class="s1">na1 </span><span class="s2">!= </span><span class="s1">na2 </span><span class="s0">and not </span><span class="s2">(</span><span class="s1">na1 </span><span class="s2">!= </span><span class="s1">na1 </span><span class="s0">and </span><span class="s1">na2 </span><span class="s2">!= </span><span class="s1">na2</span><span class="s2">)))):</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s1">arr</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">newarr</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s0">return</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">newarr</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;strings&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;this&quot;</span><span class="s2">, </span><span class="s3">&quot;is&quot;</span><span class="s2">, </span><span class="s3">&quot;an&quot;</span><span class="s2">, </span><span class="s3">&quot;array&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;â‚¬&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Š&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot; Aâ˜ƒâ‚¬Â¢ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot;â˜ƒâ‚¬ðŸ˜Š AÂ¢&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Šâ˜ƒAÂ¢ â‚¬&quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestStringLikeCasts</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_unicode_casts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">arr_as_U8 </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;U8&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr_as_U8</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;U8&quot;</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr_as_U8</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">arr_as_U3 </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;U3&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr_as_U3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;U3&quot;</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">arr_as_U3</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">s</span><span class="s2">[:</span><span class="s4">3</span><span class="s2">] </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">strings</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_void_casts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">):</span>
        <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">utf8_bytes </span><span class="s2">= [</span><span class="s1">s</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">strings</span><span class="s2">]</span>
        <span class="s1">void_dtype </span><span class="s2">= </span><span class="s3">f&quot;V</span><span class="s0">{</span><span class="s1">max</span><span class="s2">([</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">utf8_bytes</span><span class="s2">])</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s1">varr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">utf8_bytes</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">void_dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">varr</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">void_dtype</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">varr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">sarr</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bytes_casts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">):</span>
        <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">utf8_bytes </span><span class="s2">= [</span><span class="s1">s</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;ascii&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">strings</span><span class="s2">]</span>
            <span class="s1">bytes_dtype </span><span class="s2">= </span><span class="s3">f&quot;S</span><span class="s0">{</span><span class="s1">max</span><span class="s2">([</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">utf8_bytes</span><span class="s2">])</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">barr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">utf8_bytes</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bytes_dtype</span><span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">barr</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bytes_dtype</span><span class="s2">))</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">barr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">sarr</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">UnicodeEncodeError</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UnicodeEncodeError</span><span class="s2">):</span>
                <span class="s1">sarr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;S20&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_additional_unicode_cast</span><span class="s2">(</span><span class="s1">random_string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">random_string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s5"># test that this short-circuits correctly</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s5"># tests the casts via the comparison promoter</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">random_string_list</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_insert_scalar</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Test that inserting a scalar works.&quot;&quot;&quot;</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">scalar_instance </span><span class="s2">= </span><span class="s3">&quot;what&quot;</span>
    <span class="s1">arr</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">scalar_instance</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">arr</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">] + [</span><span class="s3">&quot;what&quot;</span><span class="s2">] + </span><span class="s1">string_list</span><span class="s2">[</span><span class="s4">2</span><span class="s2">:], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
    <span class="s2">)</span>


<span class="s1">comparison_operators </span><span class="s2">= [</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">,</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">,</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">greater</span><span class="s2">,</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">greater_equal</span><span class="s2">,</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">less</span><span class="s2">,</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">less_equal</span><span class="s2">,</span>
<span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;op&quot;</span><span class="s2">, </span><span class="s1">comparison_operators</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;o_dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">, </span><span class="s1">object</span><span class="s2">, </span><span class="s1">StringDType</span><span class="s2">()])</span>
<span class="s0">def </span><span class="s1">test_comparisons</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">o_dtype</span><span class="s2">):</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">oarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">o_dtype</span><span class="s2">)</span>

    <span class="s5"># test that comparison operators work</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">)</span>
    <span class="s1">ores </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">oarr</span><span class="s2">, </span><span class="s1">oarr</span><span class="s2">)</span>
    <span class="s5"># test that promotion works as well</span>
    <span class="s1">orres </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">oarr</span><span class="s2">)</span>
    <span class="s1">olres </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">oarr</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">ores</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">orres</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">olres</span><span class="s2">)</span>

    <span class="s5"># test we get the correct answer for unequal length strings</span>
    <span class="s1">sarr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">s </span><span class="s2">+ </span><span class="s3">&quot;2&quot; </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">string_list</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">oarr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">s </span><span class="s2">+ </span><span class="s3">&quot;2&quot; </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">string_list</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">o_dtype</span><span class="s2">)</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">sarr2</span><span class="s2">)</span>
    <span class="s1">ores </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">oarr</span><span class="s2">, </span><span class="s1">oarr2</span><span class="s2">)</span>
    <span class="s1">olres </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">oarr</span><span class="s2">, </span><span class="s1">sarr2</span><span class="s2">)</span>
    <span class="s1">orres </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">oarr2</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">ores</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">olres</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">orres</span><span class="s2">)</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">sarr2</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">)</span>
    <span class="s1">ores </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">oarr2</span><span class="s2">, </span><span class="s1">oarr</span><span class="s2">)</span>
    <span class="s1">olres </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">oarr2</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">)</span>
    <span class="s1">orres </span><span class="s2">= </span><span class="s1">op</span><span class="s2">(</span><span class="s1">sarr2</span><span class="s2">, </span><span class="s1">oarr</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">ores</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">olres</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">orres</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_isnan</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;no na support&quot;</span><span class="s2">)</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list </span><span class="s2">+ [</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">is_nan </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">float</span><span class="s2">) </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s1">bool_errors </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">bool</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s1">bool_errors </span><span class="s2">= </span><span class="s4">1</span>
    <span class="s0">if </span><span class="s1">is_nan </span><span class="s0">or </span><span class="s1">bool_errors</span><span class="s2">:</span>
        <span class="s5"># isnan is only true when na_object is a NaN</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">) + [</span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">),</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_pickle</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">NamedTemporaryFile</span><span class="s2">(</span><span class="s3">&quot;wb&quot;</span><span class="s2">, </span><span class="s1">delete</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">pickle</span><span class="s2">.</span><span class="s1">dump</span><span class="s2">([</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">], </span><span class="s1">f</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">f</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">f</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">dtype</span>

    <span class="s1">os</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;strings&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;left&quot;</span><span class="s2">, </span><span class="s3">&quot;right&quot;</span><span class="s2">, </span><span class="s3">&quot;leftovers&quot;</span><span class="s2">, </span><span class="s3">&quot;righty&quot;</span><span class="s2">, </span><span class="s3">&quot;up&quot;</span><span class="s2">, </span><span class="s3">&quot;down&quot;</span><span class="s2">],</span>
        <span class="s2">[</span>
            <span class="s3">&quot;left&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">,</span>
            <span class="s3">&quot;right&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">,</span>
            <span class="s3">&quot;leftovers&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">,</span>
            <span class="s3">&quot;righty&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">,</span>
            <span class="s3">&quot;up&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ¤£ðŸ¤£&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ¤£&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ“µ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜°&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸšœ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ™ƒ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜¾&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ˜¹&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸš &quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸšŒ&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot; Aâ˜ƒâ‚¬Â¢ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot;â˜ƒâ‚¬ðŸ˜Š AÂ¢&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Šâ˜ƒAÂ¢ â‚¬&quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">strings</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Test that sorting matches python's internal sorting.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_sort</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">arr_sorted</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">().</span><span class="s1">shuffle</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">na_object </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">na_object </span><span class="s0">is None and None in </span><span class="s1">strings</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">ValueError</span><span class="s2">,</span>
                <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Cannot compare null that is not a nan-like value&quot;</span><span class="s2">,</span>
            <span class="s2">):</span>
                <span class="s1">arr</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">arr</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr_sorted</span><span class="s2">, </span><span class="s1">equal_nan</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s5"># make a copy so we don't mutate the lists in the fixture</span>
    <span class="s1">strings </span><span class="s2">= </span><span class="s1">strings</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">arr_sorted </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">test_sort</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">arr_sorted</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s5"># make sure NAs get sorted to the end of the array and string NAs get</span>
    <span class="s5"># sorted like normal strings</span>
    <span class="s1">strings</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s1">strings</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s5"># can't use append because doing that with NA converts</span>
    <span class="s5"># the result to object dtype</span>
    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s1">arr_sorted </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s1">arr_sorted</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() + [</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">],</span>
            <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">arr_sorted </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">test_sort</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">arr_sorted</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;strings&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot; Aâ˜ƒâ‚¬Â¢ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot;â˜ƒâ‚¬ðŸ˜Š AÂ¢&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Šâ˜ƒAÂ¢ â‚¬&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot; &quot;</span><span class="s2">, </span><span class="s3">&quot;ï€ &quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜¸&quot;</span><span class="s2">, </span><span class="s3">&quot;Ã¡Ã¡Ã°fÃ¡Ã­Ã³Ã¥Ã©Ã«&quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nonzero</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">na_object</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">get_dtype</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">is_nonzero </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">item </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">) </span><span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">item</span><span class="s2">) != </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">is_nonzero</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">na_object </span><span class="s0">is not </span><span class="s1">pd_NA </span><span class="s0">and </span><span class="s1">na_object </span><span class="s2">== </span><span class="s3">'unset'</span><span class="s2">:</span>
        <span class="s0">return</span>

    <span class="s1">strings_with_na </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings </span><span class="s2">+ [</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">is_nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))[</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">is_nan</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">strings_with_na</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">][-</span><span class="s4">1</span><span class="s2">] == </span><span class="s4">4</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">strings_with_na</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">][-</span><span class="s4">1</span><span class="s2">] == </span><span class="s4">3</span>

    <span class="s5"># check that the casting to bool and nonzero give consistent results</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">strings_with_na</span><span class="s2">[</span><span class="s1">strings_with_na</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">()],</span>
                       <span class="s1">strings_with_na</span><span class="s2">[</span><span class="s1">strings_with_na</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">)])</span>


<span class="s0">def </span><span class="s1">test_where</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">na_object</span><span class="s2">):</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">get_dtype</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, [</span><span class="s1">a</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s4">3</span><span class="s2">], </span><span class="s1">a</span><span class="s2">[</span><span class="s4">4</span><span class="s2">], </span><span class="s1">b</span><span class="s2">[</span><span class="s4">5</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_fancy_indexing</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">sarr</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])])</span>

    <span class="s5"># see gh-27003 and gh-27053</span>
    <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s2">[[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], ...]:</span>
        <span class="s0">for </span><span class="s1">lop </span><span class="s0">in </span><span class="s2">[[</span><span class="s3">'a'</span><span class="s2">*</span><span class="s4">16</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">*</span><span class="s4">16</span><span class="s2">], [</span><span class="s3">''</span><span class="s2">, </span><span class="s3">''</span><span class="s2">]]:</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">lop</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
            <span class="s1">rop </span><span class="s2">= [</span><span class="s3">'d'</span><span class="s2">*</span><span class="s4">16</span><span class="s2">, </span><span class="s3">'e'</span><span class="s2">*</span><span class="s4">16</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s2">[</span><span class="s1">rop</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">rop</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)]:</span>
                <span class="s1">a</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">] = </span><span class="s1">b</span>
                <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">a</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">'d'</span><span class="s2">*</span><span class="s4">16</span>


<span class="s0">def </span><span class="s1">test_creation_functions</span><span class="s2">():</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">), [</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">), [</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_concatenate</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">sarr_cat </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list </span><span class="s2">+ </span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">sarr</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">sarr</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_resize_method</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">IS_PYPY</span><span class="s2">:</span>
        <span class="s1">sarr</span><span class="s2">.</span><span class="s1">resize</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">)+</span><span class="s4">3</span><span class="s2">, </span><span class="s1">refcheck</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">sarr</span><span class="s2">.</span><span class="s1">resize</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">)+</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list </span><span class="s2">+ [</span><span class="s3">''</span><span class="s2">]*</span><span class="s4">3</span><span class="s2">,  </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_create_with_copy_none</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s5"># create another stringdtype array with an arena that has a different</span>
    <span class="s5"># in-memory layout than the first array</span>
    <span class="s1">arr_rev </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>

    <span class="s5"># this should create a copy and the resulting array</span>
    <span class="s5"># shouldn't share an allocator or arena with arr_rev, despite</span>
    <span class="s5"># explicitly passing arr_rev.dtype</span>
    <span class="s1">arr_copy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">arr_rev</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr_copy</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">arr_copy</span><span class="s2">.</span><span class="s1">base </span><span class="s0">is None</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Unable to avoid copy&quot;</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">arr_rev</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s5"># because we're using arr's dtype instance, the view is safe</span>
    <span class="s1">arr_view </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr_view</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">arr_rev</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">arr_view </span><span class="s0">is </span><span class="s1">arr</span>


<span class="s0">def </span><span class="s1">test_astype_copy_false</span><span class="s2">():</span>
    <span class="s1">orig_dt </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">()</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s0">assert not </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">coerce</span>

    <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">orig_dt</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">dtype </span><span class="s0">is </span><span class="s1">orig_dt</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;strings&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;left&quot;</span><span class="s2">, </span><span class="s3">&quot;right&quot;</span><span class="s2">, </span><span class="s3">&quot;leftovers&quot;</span><span class="s2">, </span><span class="s3">&quot;righty&quot;</span><span class="s2">, </span><span class="s3">&quot;up&quot;</span><span class="s2">, </span><span class="s3">&quot;down&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ¤£ðŸ¤£&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ¤£&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ“µ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜°&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸšœ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ™ƒ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜¾&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ˜¹&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸš &quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸšŒ&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;AÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot; Aâ˜ƒâ‚¬Â¢ðŸ˜Š&quot;</span><span class="s2">, </span><span class="s3">&quot;â˜ƒâ‚¬ðŸ˜Š AÂ¢&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜Šâ˜ƒAÂ¢ â‚¬&quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_argmax</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Test that argmax/argmin matches what python calculates.&quot;&quot;&quot;</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">) == </span><span class="s1">strings</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">) == </span><span class="s1">strings</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">min</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;arrfunc,expected&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int_</span><span class="s2">),)],</span>
        <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_arrfuncs_zeros</span><span class="s2">(</span><span class="s1">arrfunc</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">arrfunc</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">expected </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">arr</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;strings&quot;</span><span class="s2">, </span><span class="s3">&quot;cast_answer&quot;</span><span class="s2">, </span><span class="s3">&quot;any_answer&quot;</span><span class="s2">, </span><span class="s3">&quot;all_answer&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">[[</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">],</span>
        <span class="s2">[[</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">],</span>
        <span class="s2">[[</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">],</span>
        <span class="s2">[[</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_cast_to_bool</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">cast_answer</span><span class="s2">, </span><span class="s1">any_answer</span><span class="s2">, </span><span class="s1">all_answer</span><span class="s2">):</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;bool&quot;</span><span class="s2">), </span><span class="s1">cast_answer</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">) == </span><span class="s1">any_answer</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">) == </span><span class="s1">all_answer</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">(</span><span class="s3">&quot;strings&quot;</span><span class="s2">, </span><span class="s3">&quot;cast_answer&quot;</span><span class="s2">),</span>
    <span class="s2">[</span>
        <span class="s2">[[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], [</span><span class="s3">&quot;True&quot;</span><span class="s2">, </span><span class="s3">&quot;True&quot;</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s3">&quot;False&quot;</span><span class="s2">, </span><span class="s3">&quot;False&quot;</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s3">&quot;True&quot;</span><span class="s2">, </span><span class="s3">&quot;False&quot;</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], [</span><span class="s3">&quot;False&quot;</span><span class="s2">, </span><span class="s3">&quot;True&quot;</span><span class="s2">]],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_cast_from_bool</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">cast_answer</span><span class="s2">):</span>
    <span class="s1">barr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">barr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">cast_answer</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;bitsize&quot;</span><span class="s2">, [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">64</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;signed&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_sized_integer_casts</span><span class="s2">(</span><span class="s1">bitsize</span><span class="s2">, </span><span class="s1">signed</span><span class="s2">):</span>
    <span class="s1">idtype </span><span class="s2">= </span><span class="s3">f&quot;int</span><span class="s0">{</span><span class="s1">bitsize</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s0">if </span><span class="s1">signed</span><span class="s2">:</span>
        <span class="s1">inp </span><span class="s2">= [-(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">p </span><span class="s2">- </span><span class="s4">1</span><span class="s2">) </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">bitsize </span><span class="s2">- </span><span class="s4">1</span><span class="s2">))]</span>
        <span class="s1">inp </span><span class="s2">+= [</span><span class="s4">2</span><span class="s2">**</span><span class="s1">p </span><span class="s2">- </span><span class="s4">1 </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">bitsize </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">idtype </span><span class="s2">= </span><span class="s3">&quot;u&quot; </span><span class="s2">+ </span><span class="s1">idtype</span>
        <span class="s1">inp </span><span class="s2">= [</span><span class="s4">2</span><span class="s2">**</span><span class="s1">p </span><span class="s2">- </span><span class="s4">1 </span><span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">bitsize</span><span class="s2">)]</span>
    <span class="s1">ainp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">idtype</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ainp</span><span class="s2">, </span><span class="s1">ainp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">idtype</span><span class="s2">))</span>

    <span class="s5"># safe casting works</span>
    <span class="s1">ainp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;safe&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">ainp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">idtype</span><span class="s2">, </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;safe&quot;</span><span class="s2">)</span>

    <span class="s1">oob </span><span class="s2">= [</span><span class="s1">str</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">bitsize</span><span class="s2">), </span><span class="s1">str</span><span class="s2">(-(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">bitsize</span><span class="s2">))]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OverflowError</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">oob</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">idtype</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;3&quot;</span><span class="s2">],</span>
                 <span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">idtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;typename&quot;</span><span class="s2">, [</span><span class="s3">&quot;byte&quot;</span><span class="s2">, </span><span class="s3">&quot;short&quot;</span><span class="s2">, </span><span class="s3">&quot;int&quot;</span><span class="s2">, </span><span class="s3">&quot;longlong&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;signed&quot;</span><span class="s2">, [</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;u&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_unsized_integer_casts</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">, </span><span class="s1">signed</span><span class="s2">):</span>
    <span class="s1">idtype </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">signed</span><span class="s0">}{</span><span class="s1">typename</span><span class="s0">}</span><span class="s3">&quot;</span>

    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
    <span class="s1">ainp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">idtype</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ainp</span><span class="s2">, </span><span class="s1">ainp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">idtype</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;typename&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
            <span class="s3">&quot;longdouble&quot;</span><span class="s2">,</span>
            <span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">LongDoubleDType</span><span class="s2">() != </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">Float64DType</span><span class="s2">(),</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;numpy lacks an ld2a implementation&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
        <span class="s3">&quot;float64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;float32&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;float16&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_float_casts</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">):</span>
    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.8</span><span class="s2">, -</span><span class="s4">3.2</span><span class="s2">, </span><span class="s4">2.7e4</span><span class="s2">]</span>
    <span class="s1">ainp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ainp</span><span class="s2">, </span><span class="s1">ainp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">))</span>

    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">0.1</span><span class="s2">]</span>
    <span class="s1">sres </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sres</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">), </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sres</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">&quot;0.1&quot;</span>

    <span class="s0">if </span><span class="s1">typename </span><span class="s2">== </span><span class="s3">&quot;longdouble&quot;</span><span class="s2">:</span>
        <span class="s5"># let's not worry about platform-dependent rounding of longdouble</span>
        <span class="s0">return</span>

    <span class="s1">fi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">)</span>

    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">1e-324</span><span class="s2">, </span><span class="s1">fi</span><span class="s2">.</span><span class="s1">smallest_subnormal</span><span class="s2">, -</span><span class="s4">1e-324</span><span class="s2">, -</span><span class="s1">fi</span><span class="s2">.</span><span class="s1">smallest_subnormal</span><span class="s2">]</span>
    <span class="s1">eres </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s1">fi</span><span class="s2">.</span><span class="s1">smallest_subnormal</span><span class="s2">, -</span><span class="s4">0</span><span class="s2">, -</span><span class="s1">fi</span><span class="s2">.</span><span class="s1">smallest_subnormal</span><span class="s2">]</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">eres</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">2e308</span><span class="s2">, </span><span class="s1">fi</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, -</span><span class="s4">2e308</span><span class="s2">, </span><span class="s1">fi</span><span class="s2">.</span><span class="s1">min</span><span class="s2">]</span>
    <span class="s1">eres </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">fi</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">fi</span><span class="s2">.</span><span class="s1">min</span><span class="s2">]</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">eres</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;typename&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s3">&quot;csingle&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;cdouble&quot;</span><span class="s2">,</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
            <span class="s3">&quot;clongdouble&quot;</span><span class="s2">,</span>
            <span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">CLongDoubleDType</span><span class="s2">() != </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">Complex128DType</span><span class="s2">(),</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;numpy lacks an ld2a implementation&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_cfloat_casts</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">):</span>
    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">1.1 </span><span class="s2">+ </span><span class="s4">1.1j</span><span class="s2">, </span><span class="s4">2.8 </span><span class="s2">+ </span><span class="s4">2.8j</span><span class="s2">, -</span><span class="s4">3.2 </span><span class="s2">- </span><span class="s4">3.2j</span><span class="s2">, </span><span class="s4">2.7e4 </span><span class="s2">+ </span><span class="s4">2.7e4j</span><span class="s2">]</span>
    <span class="s1">ainp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ainp</span><span class="s2">, </span><span class="s1">ainp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">))</span>

    <span class="s1">inp </span><span class="s2">= [</span><span class="s4">0.1 </span><span class="s2">+ </span><span class="s4">0.1j</span><span class="s2">]</span>
    <span class="s1">sres </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sres</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">typename</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">typename</span><span class="s2">), </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sres</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">&quot;(0.1+0.1j)&quot;</span>


<span class="s0">def </span><span class="s1">test_take</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">sarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sarr</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">)))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s5"># make sure it also works for out</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">out</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s3">&quot;hello&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sarr</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">)), </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res </span><span class="s0">is </span><span class="s1">out</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sarr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;use_out&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;ufunc_name,func&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;min&quot;</span><span class="s2">, </span><span class="s1">min</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;max&quot;</span><span class="s2">, </span><span class="s1">max</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ufuncs_minmax</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">ufunc_name</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">use_out</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Test that the min/max ufuncs match Python builtin min/max behavior.&quot;&quot;&quot;</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">uarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">func</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">ufunc_name</span><span class="s2">)(), </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s1">ufunc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">, </span><span class="s1">ufunc_name </span><span class="s2">+ </span><span class="s3">&quot;imum&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">use_out</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">ufunc</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">uarr</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">ufunc_name</span><span class="s2">)(), </span><span class="s1">func</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_max_regression</span><span class="s2">():</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">'y'</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">, </span><span class="s3">'z'</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() == </span><span class="s3">'z'</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;use_out&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;other_strings&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s3">&quot;abc&quot;</span><span class="s2">, </span><span class="s3">&quot;def&quot; </span><span class="s2">* </span><span class="s4">500</span><span class="s2">, </span><span class="s3">&quot;ghi&quot; </span><span class="s2">* </span><span class="s4">16</span><span class="s2">, </span><span class="s3">&quot;ðŸ¤£&quot; </span><span class="s2">* </span><span class="s4">100</span><span class="s2">, </span><span class="s3">&quot;ðŸ“µ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜°&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸšœ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ™ƒ&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜¾&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ˜¹&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸš &quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸšŒ&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">&quot;ðŸ¥¦&quot;</span><span class="s2">, </span><span class="s3">&quot;Â¨&quot;</span><span class="s2">, </span><span class="s3">&quot;â¨¯&quot;</span><span class="s2">, </span><span class="s3">&quot;âˆ° &quot;</span><span class="s2">, </span><span class="s3">&quot;â¨Œ &quot;</span><span class="s2">, </span><span class="s3">&quot;âŽ¶ &quot;</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ufunc_add</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">other_strings</span><span class="s2">, </span><span class="s1">use_out</span><span class="s2">):</span>
    <span class="s1">arr1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">other_strings</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">use_out</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">arr1</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s1">is_nan </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">float</span><span class="s2">) </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s1">is_str </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">bool_errors </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">bool</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s1">bool_errors </span><span class="s2">= </span><span class="s4">1</span>

    <span class="s1">arr1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">] + </span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">arr2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">other_strings </span><span class="s2">+ [</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">is_nan </span><span class="s0">or </span><span class="s1">bool_errors </span><span class="s0">or </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">arr1</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">arr2</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">if not </span><span class="s1">is_str</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object </span><span class="s0">and </span><span class="s1">res</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object </span><span class="s2">+ </span><span class="s1">arr2</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">arr1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr1</span><span class="s2">, </span><span class="s1">arr2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ufunc_add_reduce</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">values </span><span class="s2">= [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;this is a long string&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">values</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">out</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_add_promoter</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s1">lresult </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;hello&quot; </span><span class="s2">+ </span><span class="s1">s </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">string_list</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s1">rresult </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">s </span><span class="s2">+ </span><span class="s3">&quot;hello&quot; </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">string_list</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">())</span>

    <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">(</span><span class="s3">&quot;hello&quot;</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;hello&quot;</span><span class="s2">])]:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">op </span><span class="s2">+ </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">lresult</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr </span><span class="s2">+ </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rresult</span><span class="s2">)</span>

    <span class="s5"># The promoter should be able to handle things if users pass `dtype=`</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">StringDType</span><span class="s2">()</span>

    <span class="s5"># The promoter should not kick in if users override the input,</span>
    <span class="s5"># which means arr is cast, this fails because of the unknown length.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;cannot cast dtype&quot;</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s3">&quot;add&quot;</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">=(</span><span class="s3">&quot;U&quot;</span><span class="s2">, </span><span class="s3">&quot;U&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">casting</span><span class="s2">=</span><span class="s3">&quot;unsafe&quot;</span><span class="s2">)</span>

    <span class="s5"># But it must simply reject the following:</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;.*did not contain a loop&quot;</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s3">&quot;add&quot;</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;U&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;.*did not contain a loop&quot;</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">signature</span><span class="s2">=(</span><span class="s3">&quot;U&quot;</span><span class="s2">, </span><span class="s3">&quot;U&quot;</span><span class="s2">, </span><span class="s1">StringDType</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_add_no_legacy_promote_with_signature</span><span class="s2">():</span>
    <span class="s5"># Possibly misplaced, but useful to test with string DType.  We check that</span>
    <span class="s5"># if there is clearly no loop found, a stray `dtype=` doesn't break things</span>
    <span class="s5"># Regression test for the bad error in gh-26735</span>
    <span class="s5"># (If legacy promotion is gone, this can be deleted...)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;.*did not contain a loop&quot;</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s3">&quot;3&quot;</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_add_promoter_reduce</span><span class="s2">():</span>
    <span class="s5"># Exact TypeError could change, but ensure StringDtype doesn't match</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;the resolved dtypes are not&quot;</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;U&quot;</span><span class="s2">))</span>

    <span class="s5"># On the other hand, using `dtype=T` in the *ufunc* should work.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;U&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">StringDType</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiply_reduce</span><span class="s2">():</span>
    <span class="s5"># At the time of writing (NumPy 2.0) this is very limited (and rather</span>
    <span class="s5"># ridiculous anyway).  But it works and actually makes some sense...</span>
    <span class="s5"># (NumPy does not allow non-scalar initial values)</span>
    <span class="s1">repeats </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
    <span class="s1">val </span><span class="s2">= </span><span class="s3">&quot;school-ðŸšŒ&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">.</span><span class="s1">reduce</span><span class="s2">(</span><span class="s1">repeats</span><span class="s2">, </span><span class="s1">initial</span><span class="s2">=</span><span class="s1">val</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">StringDType</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res </span><span class="s2">== </span><span class="s1">val </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">(</span><span class="s1">repeats</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_multiply_two_string_raises</span><span class="s2">():</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">_exceptions</span><span class="s2">.</span><span class="s1">_UFuncNoLoopError</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;use_out&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;other&quot;</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;other_dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">None</span><span class="s2">,</span>
        <span class="s3">&quot;int8&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;int16&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;int32&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;uint8&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;uint16&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;uint32&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;uint64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;short&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;int&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;intp&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;long&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;longlong&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ushort&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;uint&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;uintp&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ulong&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;ulonglong&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ufunc_multiply</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">other</span><span class="s2">, </span><span class="s1">other_dtype</span><span class="s2">, </span><span class="s1">use_out</span><span class="s2">):</span>
    <span class="s7">&quot;&quot;&quot;Test the two-argument ufuncs match python builtin behavior.&quot;&quot;&quot;</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">other_dtype </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">other_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">other_dtype</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= [</span><span class="s1">s </span><span class="s2">* </span><span class="s1">o </span><span class="s0">for </span><span class="s1">s</span><span class="s2">, </span><span class="s1">o </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">string_list</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)]</span>
        <span class="s1">other </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">other_dtype </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">other_dtype</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">other_dtype </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">other_dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= [</span><span class="s1">s </span><span class="s2">* </span><span class="s1">other </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">string_list</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">use_out</span><span class="s2">:</span>
        <span class="s1">arr_cache </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">lres </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">other</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">lres</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
        <span class="s1">arr</span><span class="s2">[:] = </span><span class="s1">arr_cache</span>
        <span class="s0">assert </span><span class="s1">lres </span><span class="s0">is </span><span class="s1">arr</span>
        <span class="s1">arr </span><span class="s2">*= </span><span class="s1">other</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
        <span class="s1">arr</span><span class="s2">[:] = </span><span class="s1">arr_cache</span>
        <span class="s1">rres </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">rres </span><span class="s0">is </span><span class="s1">arr</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">rres</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">lres </span><span class="s2">= </span><span class="s1">arr </span><span class="s2">* </span><span class="s1">other</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">lres</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
        <span class="s1">rres </span><span class="s2">= </span><span class="s1">other </span><span class="s2">* </span><span class="s1">arr</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">rres</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s1">is_nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">is_str </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">bool_errors </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">bool</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s1">bool_errors </span><span class="s2">= </span><span class="s4">1</span>

    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">string_list </span><span class="s2">+ [</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>
        <span class="s1">other </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">other_dtype </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">other_dtype</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
        <span class="s0">pass</span>

    <span class="s0">if </span><span class="s1">is_nan </span><span class="s0">or </span><span class="s1">bool_errors </span><span class="s0">or </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s2">[</span><span class="s1">arr </span><span class="s2">* </span><span class="s1">other</span><span class="s2">, </span><span class="s1">other </span><span class="s2">* </span><span class="s1">arr</span><span class="s2">]:</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">result</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">is_str</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">res</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s0">assert </span><span class="s1">res</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object </span><span class="s2">* </span><span class="s1">other</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
                <span class="s0">except </span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">):</span>
                    <span class="s0">assert </span><span class="s1">res</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object </span><span class="s2">* </span><span class="s1">other</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">* </span><span class="s1">other</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">other </span><span class="s2">* </span><span class="s1">arr</span>


<span class="s1">DATETIME_INPUT </span><span class="s2">= [</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;1923-04-14T12:43:12&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;1994-06-21T14:43:15&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;2001-10-15T04:10:32&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;NaT&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;1995-11-25T16:02:16&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;2005-01-04T03:14:12&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;2041-12-03T14:05:03&quot;</span><span class="s2">),</span>
<span class="s2">]</span>


<span class="s1">TIMEDELTA_INPUT </span><span class="s2">= [</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">12358</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">23</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">74</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">&quot;NaT&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">23</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">73</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s4">7</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">),</span>
<span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;input_data, input_dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">DATETIME_INPUT</span><span class="s2">, </span><span class="s3">&quot;M8[s]&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">TIMEDELTA_INPUT</span><span class="s2">, </span><span class="s3">&quot;m8[s]&quot;</span><span class="s2">)</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_timedelta_cast</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">input_data</span><span class="s2">, </span><span class="s1">input_dtype</span><span class="s2">):</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">input_data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span><span class="s2">)</span>

    <span class="s1">has_na </span><span class="s2">= </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">)</span>
    <span class="s1">is_str </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), </span><span class="s1">str</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">has_na </span><span class="s0">or </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

    <span class="s1">sa </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">ra </span><span class="s2">= </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">has_na </span><span class="s0">and not </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">sa</span><span class="s2">[</span><span class="s4">3</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnat</span><span class="s2">(</span><span class="s1">ra</span><span class="s2">[</span><span class="s4">3</span><span class="s2">])</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">ra</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">has_na </span><span class="s0">and not </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s5"># don't worry about comparing how NaT is converted</span>
        <span class="s1">sa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">input_dtype</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;M&quot;</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;U&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># The timedelta to unicode cast produces strings</span>
        <span class="s5"># that aren't round-trippable and we don't want to</span>
        <span class="s5"># reproduce that behavior in stringdtype</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;U&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_nat_casts</span><span class="s2">():</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s3">'nat'</span>
    <span class="s1">all_nats </span><span class="s2">= </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">(), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()))</span>
    <span class="s1">all_nats </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s3">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">, </span><span class="s1">all_nats</span><span class="s2">))</span>
    <span class="s1">NaT_dt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">'NaT'</span><span class="s2">)</span>
    <span class="s1">NaT_td </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">'NaT'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">na_object </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">_NoValue</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">'nat'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">]:</span>
        <span class="s5"># numpy treats empty string and all case combinations of 'nat' as NaT</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">na_object</span><span class="s2">)</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">''</span><span class="s2">] + </span><span class="s1">all_nats</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">dt_array </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'M8[s]'</span><span class="s2">)</span>
        <span class="s1">td_array </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">'m8[s]'</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dt_array</span><span class="s2">, </span><span class="s1">NaT_dt</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">td_array</span><span class="s2">, </span><span class="s1">NaT_td</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">na_object </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">_NoValue</span><span class="s2">:</span>
            <span class="s1">output_object </span><span class="s2">= </span><span class="s3">'NaT'</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">output_object </span><span class="s2">= </span><span class="s1">na_object</span>

        <span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s2">[</span><span class="s1">dt_array</span><span class="s2">, </span><span class="s1">td_array</span><span class="s2">]:</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span>
                <span class="s1">arr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">output_object</span><span class="s2">]*</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_nat_conversion</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">nat </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;NaT&quot;</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s3">&quot;NaT&quot;</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">)]:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;string coercion is disabled&quot;</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">nat</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_growing_strings</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s5"># growing a string leads to a heap allocation, this tests to make sure</span>
    <span class="s5"># we do that bookkeeping correctly for all possible starting cases</span>
    <span class="s1">data </span><span class="s2">= [</span>
        <span class="s3">&quot;hello&quot;</span><span class="s2">,  </span><span class="s5"># a short string</span>
        <span class="s3">&quot;abcdefghijklmnopqestuvwxyz&quot;</span><span class="s2">,  </span><span class="s5"># a medium heap-allocated string</span>
        <span class="s3">&quot;hello&quot; </span><span class="s2">* </span><span class="s4">200</span><span class="s2">,  </span><span class="s5"># a long heap-allocated string</span>
    <span class="s2">]</span>

    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">uarr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">str</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">arr </span><span class="s2">+ </span><span class="s1">arr</span>
        <span class="s1">uarr </span><span class="s2">= </span><span class="s1">uarr </span><span class="s2">+ </span><span class="s1">uarr</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">uarr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">IS_WASM</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;no threading support in wasm&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_threaded_access_and_mutation</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">random_string_list</span><span class="s2">):</span>
    <span class="s5"># this test uses an RNG and may crash or cause deadlocks if there is a</span>
    <span class="s5"># threading bug</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">0x4D3D3D3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">):</span>
        <span class="s1">rnd </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">()</span>
        <span class="s5"># either write to random locations in the array, compute a ufunc, or</span>
        <span class="s5"># re-initialize the array</span>
        <span class="s0">if </span><span class="s1">rnd </span><span class="s2">&lt; </span><span class="s4">0.25</span><span class="s2">:</span>
            <span class="s1">num </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)</span>
            <span class="s1">arr</span><span class="s2">[</span><span class="s1">num</span><span class="s2">] = </span><span class="s1">arr</span><span class="s2">[</span><span class="s1">num</span><span class="s2">] + </span><span class="s3">&quot;hello&quot;</span>
        <span class="s0">elif </span><span class="s1">rnd </span><span class="s2">&lt; </span><span class="s4">0.5</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">rnd </span><span class="s2">&lt; </span><span class="s4">0.375</span><span class="s2">:</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">, </span><span class="s1">out</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">rnd </span><span class="s2">&lt; </span><span class="s4">0.75</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">rnd </span><span class="s2">&lt; </span><span class="s4">0.875</span><span class="s2">:</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">out</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">arr</span><span class="s2">[:] = </span><span class="s1">random_string_list</span>

    <span class="s0">with </span><span class="s1">concurrent</span><span class="s2">.</span><span class="s1">futures</span><span class="s2">.</span><span class="s1">ThreadPoolExecutor</span><span class="s2">(</span><span class="s1">max_workers</span><span class="s2">=</span><span class="s4">8</span><span class="s2">) </span><span class="s0">as </span><span class="s1">tpe</span><span class="s2">:</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">random_string_list</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">futures </span><span class="s2">= [</span><span class="s1">tpe</span><span class="s2">.</span><span class="s1">submit</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">arr</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">500</span><span class="s2">)]</span>

        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">futures</span><span class="s2">:</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">result</span><span class="s2">()</span>


<span class="s1">UFUNC_TEST_DATA </span><span class="s2">= [</span>
    <span class="s3">&quot;hello&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">,</span>
    <span class="s3">&quot;AeÂ¢â˜ƒâ‚¬ ðŸ˜Š&quot; </span><span class="s2">* </span><span class="s4">20</span><span class="s2">,</span>
    <span class="s3">&quot;entry</span><span class="s0">\n</span><span class="s3">with</span><span class="s0">\n</span><span class="s3">newlines&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;entry</span><span class="s0">\t</span><span class="s3">with</span><span class="s0">\t</span><span class="s3">tabs&quot;</span><span class="s2">,</span>
<span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">string_array</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">UFUNC_TEST_DATA</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">unicode_array</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">UFUNC_TEST_DATA</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">)</span>


<span class="s1">NAN_PRESERVING_FUNCTIONS </span><span class="s2">= [</span>
    <span class="s3">&quot;capitalize&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;expandtabs&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;lower&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;lstrip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;rstrip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;splitlines&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;strip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;swapcase&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;title&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;upper&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">BOOL_OUTPUT_FUNCTIONS </span><span class="s2">= [</span>
    <span class="s3">&quot;isalnum&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isalpha&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isdigit&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;islower&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isspace&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;istitle&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isupper&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isnumeric&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isdecimal&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">UNARY_FUNCTIONS </span><span class="s2">= [</span>
    <span class="s3">&quot;str_len&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;capitalize&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;expandtabs&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isalnum&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isalpha&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isdigit&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;islower&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isspace&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;istitle&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isupper&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;lower&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;lstrip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;rstrip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;splitlines&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;strip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;swapcase&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;title&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;upper&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isnumeric&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isdecimal&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isalnum&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;islower&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;istitle&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;isupper&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">UNIMPLEMENTED_VEC_STRING_FUNCTIONS </span><span class="s2">= [</span>
    <span class="s3">&quot;capitalize&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;expandtabs&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;lower&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;splitlines&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;swapcase&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;title&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;upper&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">ONLY_IN_NP_CHAR </span><span class="s2">= [</span>
    <span class="s3">&quot;join&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;split&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;rsplit&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;splitlines&quot;</span>
<span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;function_name&quot;</span><span class="s2">, </span><span class="s1">UNARY_FUNCTIONS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_unary</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s1">unicode_array</span><span class="s2">, </span><span class="s1">function_name</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">ONLY_IN_NP_CHAR</span><span class="s2">:</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">, </span><span class="s1">function_name</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">function_name</span><span class="s2">)</span>
    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">string_array</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">sres </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">)</span>
    <span class="s1">ures </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">unicode_array</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sres</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">StringDType</span><span class="s2">():</span>
        <span class="s1">ures </span><span class="s2">= </span><span class="s1">ures</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sres</span><span class="s2">, </span><span class="s1">ures</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s1">is_nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">is_str </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">na_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">UNIMPLEMENTED_VEC_STRING_FUNCTIONS</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">is_str</span><span class="s2">:</span>
            <span class="s5"># to avoid these errors we'd need to add NA support to _vec_string</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">)):</span>
                <span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">function_name </span><span class="s2">== </span><span class="s3">&quot;splitlines&quot;</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">func</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)[()]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">func</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s0">if </span><span class="s1">function_name </span><span class="s2">== </span><span class="s3">&quot;str_len&quot; </span><span class="s0">and not </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s5"># str_len always errors for any non-string null, even NA ones because</span>
        <span class="s5"># it has an integer result</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s0">if </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">BOOL_OUTPUT_FUNCTIONS</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">is_nan</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">False_</span>
        <span class="s0">elif </span><span class="s1">is_str</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">func</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s0">if not </span><span class="s2">(</span><span class="s1">is_nan </span><span class="s0">or </span><span class="s1">is_str</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">na_arr</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">is_nan </span><span class="s0">and </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">NAN_PRESERVING_FUNCTIONS</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
    <span class="s0">elif </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">func</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>


<span class="s1">unicode_bug_fail </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;unicode output width is buggy&quot;</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span>
<span class="s2">)</span>

<span class="s5"># None means that the argument is a string array</span>
<span class="s1">BINARY_FUNCTIONS </span><span class="s2">= [</span>
    <span class="s2">(</span><span class="s3">&quot;add&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;multiply&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;mod&quot;</span><span class="s2">, (</span><span class="s3">&quot;format: %s&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;center&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">25</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;encode&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;UTF-8&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;endswith&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;lo&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;find&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;join&quot;</span><span class="s2">, (</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;ljust&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;lstrip&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;partition&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;replace&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;rfind&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;rindex&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;rjust&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;rsplit&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;rstrip&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;rpartition&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;split&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;strip&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;startswith&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;zfill&quot;</span><span class="s2">, (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)),</span>
<span class="s2">]</span>

<span class="s1">PASSES_THROUGH_NAN_NULLS </span><span class="s2">= [</span>
    <span class="s3">&quot;add&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;center&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;ljust&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;multiply&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;rjust&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;strip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;lstrip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;rstrip&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;replace&quot;</span>
    <span class="s3">&quot;zfill&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">NULLS_ARE_FALSEY </span><span class="s2">= [</span>
    <span class="s3">&quot;startswith&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;endswith&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">NULLS_ALWAYS_ERROR </span><span class="s2">= [</span>
    <span class="s3">&quot;count&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;find&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;rfind&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">SUPPORTS_NULLS </span><span class="s2">= (</span>
    <span class="s1">PASSES_THROUGH_NAN_NULLS </span><span class="s2">+</span>
    <span class="s1">NULLS_ARE_FALSEY </span><span class="s2">+</span>
    <span class="s1">NULLS_ALWAYS_ERROR</span>
<span class="s2">)</span>


<span class="s0">def </span><span class="s1">call_func</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">array</span><span class="s2">, </span><span class="s1">sanitize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">args </span><span class="s2">== (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">func</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">array</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">sanitize</span><span class="s2">:</span>
            <span class="s1">san_args </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">array</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">) </span><span class="s0">else</span>
                <span class="s1">arg </span><span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">san_args </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>
        <span class="s0">return </span><span class="s1">func</span><span class="s2">(</span><span class="s1">array</span><span class="s2">, *</span><span class="s1">san_args</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">func</span><span class="s2">(</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">array</span><span class="s2">)</span>
    <span class="s5"># shouldn't ever happen</span>
    <span class="s0">assert </span><span class="s4">0</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;function_name, args&quot;</span><span class="s2">, </span><span class="s1">BINARY_FUNCTIONS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_binary</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s1">unicode_array</span><span class="s2">, </span><span class="s1">function_name</span><span class="s2">, </span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">ONLY_IN_NP_CHAR</span><span class="s2">:</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">, </span><span class="s1">function_name</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">func </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">, </span><span class="s1">function_name</span><span class="s2">)</span>
    <span class="s1">sres </span><span class="s2">= </span><span class="s1">call_func</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">string_array</span><span class="s2">)</span>
    <span class="s1">ures </span><span class="s2">= </span><span class="s1">call_func</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">unicode_array</span><span class="s2">, </span><span class="s1">sanitize</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sres</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">) </span><span class="s0">and </span><span class="s1">sres</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">StringDType</span><span class="s2">():</span>
        <span class="s1">ures </span><span class="s2">= </span><span class="s1">ures</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">())</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sres</span><span class="s2">, </span><span class="s1">ures</span><span class="s2">)</span>

    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">string_array</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s0">if </span><span class="s1">function_name </span><span class="s0">not in </span><span class="s1">SUPPORTS_NULLS </span><span class="s0">or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s3">&quot;na_object&quot;</span><span class="s2">):</span>
        <span class="s0">return</span>

    <span class="s1">na_arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">)</span>
    <span class="s1">is_nan </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">))[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">is_str </span><span class="s2">= </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>
    <span class="s1">should_error </span><span class="s2">= </span><span class="s0">not </span><span class="s2">(</span><span class="s1">is_nan </span><span class="s0">or </span><span class="s1">is_str</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">NULLS_ALWAYS_ERROR </span><span class="s0">and not </span><span class="s1">is_str</span><span class="s2">)</span>
        <span class="s0">or </span><span class="s2">(</span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">PASSES_THROUGH_NAN_NULLS </span><span class="s0">and </span><span class="s1">should_error</span><span class="s2">)</span>
        <span class="s0">or </span><span class="s2">(</span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">NULLS_ARE_FALSEY </span><span class="s0">and </span><span class="s1">should_error</span><span class="s2">)</span>
    <span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">TypeError</span><span class="s2">)):</span>
            <span class="s1">call_func</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">na_arr</span><span class="s2">)</span>
        <span class="s0">return</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">call_func</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">na_arr</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">is_str</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">call_func</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">na_arr</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">elif </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">NULLS_ARE_FALSEY</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">np</span><span class="s2">.</span><span class="s1">False_</span>
    <span class="s0">elif </span><span class="s1">function_name </span><span class="s0">in </span><span class="s1">PASSES_THROUGH_NAN_NULLS</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">na_object</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># shouldn't ever get here</span>
        <span class="s0">assert </span><span class="s4">0</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;function, expected&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">find</span><span class="s2">, [[</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">]]),</span>
    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">, [[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]])])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;start, stop&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">(</span><span class="s4">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u2'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">'u2'</span><span class="s2">))])</span>
<span class="s0">def </span><span class="s1">test_non_default_start_stop</span><span class="s2">(</span><span class="s1">function</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">&quot;--ðŸ--&quot;</span><span class="s2">, </span><span class="s3">&quot;--ðŸ¦œ--&quot;</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s3">&quot;-ðŸ---&quot;</span><span class="s2">, </span><span class="s3">&quot;-ðŸ¦œ---&quot;</span><span class="s2">]], </span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">indx </span><span class="s2">= </span><span class="s1">function</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;ðŸ&quot;</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">stop</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">indx</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;count&quot;</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">'u2'</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_replace_non_default_repeat</span><span class="s2">(</span><span class="s1">count</span><span class="s2">):</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;ðŸ--&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ¦œ-ðŸ¦œ-&quot;</span><span class="s2">], </span><span class="s3">&quot;T&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;ðŸ¦œ-&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ¦œâ€ &quot;</span><span class="s2">, </span><span class="s1">count</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;ðŸ--&quot;</span><span class="s2">, </span><span class="s3">&quot;ðŸ¦œâ€ ðŸ¦œâ€ &quot;</span><span class="s2">], </span><span class="s3">&quot;T&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_strip_ljust_rjust_consistency</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s1">unicode_array</span><span class="s2">):</span>
    <span class="s1">rjs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">rjust</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>
    <span class="s1">rju </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">rjust</span><span class="s2">(</span><span class="s1">unicode_array</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>

    <span class="s1">ljs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">ljust</span><span class="s2">(</span><span class="s1">string_array</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>
    <span class="s1">lju </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">ljust</span><span class="s2">(</span><span class="s1">unicode_array</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s1">rjs</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s1">rju</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">()),</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s1">ljs</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s1">lju</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">()),</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s1">ljs</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s1">lju</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">()),</span>
    <span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s1">rjs</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">char</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s1">rju</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">StringDType</span><span class="s2">()),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_unset_na_coercion</span><span class="s2">():</span>
    <span class="s5"># a dtype instance with an unset na object is compatible</span>
    <span class="s5"># with a dtype that has one set</span>

    <span class="s5"># this test uses the &quot;add&quot; and &quot;equal&quot; ufunc but all ufuncs that</span>
    <span class="s5"># accept more than one string argument and produce a string should</span>
    <span class="s5"># behave this way</span>
    <span class="s5"># TODO: generalize to more ufuncs</span>
    <span class="s1">inp </span><span class="s2">= [</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">]</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s0">None</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">op_dtype </span><span class="s0">in </span><span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">StringDType</span><span class="s2">(), </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
                     <span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)]:</span>
        <span class="s0">if </span><span class="s1">op_dtype </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s3">&quot;2&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">&quot;2&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">op_dtype</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">arr </span><span class="s2">+ </span><span class="s1">op</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, [</span><span class="s3">&quot;hello2&quot;</span><span class="s2">, </span><span class="s3">&quot;world2&quot;</span><span class="s2">])</span>

    <span class="s5"># dtype instances with distinct explicitly set NA objects are incompatible</span>
    <span class="s0">for </span><span class="s1">op_dtype </span><span class="s0">in </span><span class="s2">[</span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">pd_NA</span><span class="s2">), </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">)]:</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">&quot;2&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">op_dtype</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">+ </span><span class="s1">op</span>

    <span class="s5"># comparisons only consider the na_object</span>
    <span class="s0">for </span><span class="s1">op_dtype </span><span class="s0">in </span><span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s1">StringDType</span><span class="s2">(), </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">coerce</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                     <span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)]:</span>
        <span class="s0">if </span><span class="s1">op_dtype </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">inp</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">op_dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">op</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">op_dtype </span><span class="s0">in </span><span class="s2">[</span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">pd_NA</span><span class="s2">),</span>
                     <span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)]:</span>
        <span class="s1">op </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">op_dtype</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">arr </span><span class="s2">== </span><span class="s1">op</span>


<span class="s0">class </span><span class="s1">TestImplementation</span><span class="s2">:</span>
    <span class="s7">&quot;&quot;&quot;Check that strings are stored in the arena when possible. 
 
    This tests implementation details, so should be adjusted if 
    the implementation changes. 
    &quot;&quot;&quot;</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">MISSING </span><span class="s2">= </span><span class="s4">0x80</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">INITIALIZED </span><span class="s2">= </span><span class="s4">0x40</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">OUTSIDE_ARENA </span><span class="s2">= </span><span class="s4">0x20</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">LONG </span><span class="s2">= </span><span class="s4">0x10</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">= </span><span class="s1">StringDType</span><span class="s2">(</span><span class="s1">na_object</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sizeofstr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize</span>
        <span class="s1">sp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize </span><span class="s2">// </span><span class="s4">2  </span><span class="s5"># pointer size = sizeof(size_t)</span>
        <span class="s5"># Below, size is not strictly correct, since it really uses</span>
        <span class="s5"># 7 (or 3) bytes, but good enough for the tests here.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">view_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">([</span>
            <span class="s2">(</span><span class="s3">'offset'</span><span class="s2">, </span><span class="s3">f'u</span><span class="s0">{</span><span class="s1">sp</span><span class="s0">}</span><span class="s3">'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s3">f'u</span><span class="s0">{</span><span class="s1">sp </span><span class="s2">// </span><span class="s4">2</span><span class="s0">}</span><span class="s3">'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'xsiz'</span><span class="s2">, </span><span class="s3">f'V</span><span class="s0">{</span><span class="s1">sp </span><span class="s2">// </span><span class="s4">2 </span><span class="s2">- </span><span class="s4">1</span><span class="s0">}</span><span class="s3">'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'size_and_flags'</span><span class="s2">, </span><span class="s3">'u1'</span><span class="s2">),</span>
        <span class="s2">] </span><span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">byteorder </span><span class="s2">== </span><span class="s3">'little' </span><span class="s0">else </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s3">'size_and_flags'</span><span class="s2">, </span><span class="s3">'u1'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'xsiz'</span><span class="s2">, </span><span class="s3">f'V</span><span class="s0">{</span><span class="s1">sp </span><span class="s2">// </span><span class="s4">2 </span><span class="s2">- </span><span class="s4">1</span><span class="s0">}</span><span class="s3">'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'size'</span><span class="s2">, </span><span class="s3">f'u</span><span class="s0">{</span><span class="s1">sp </span><span class="s2">// </span><span class="s4">2</span><span class="s0">}</span><span class="s3">'</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">'offset'</span><span class="s2">, </span><span class="s3">f'u</span><span class="s0">{</span><span class="s1">sp</span><span class="s0">}</span><span class="s3">'</span><span class="s2">),</span>
        <span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_empty </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_short </span><span class="s2">= </span><span class="s3">&quot;01234&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium </span><span class="s2">= </span><span class="s3">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">s_long </span><span class="s2">= </span><span class="s3">&quot;-=+&quot; </span><span class="s2">* </span><span class="s4">100</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_empty</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_short</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_long</span><span class="s2">],</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s5"># Cannot view a StringDType as anything else directly, since</span>
        <span class="s5"># it has references. So, we use a stride trick hack.</span>
        <span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">_stride_tricks_impl </span><span class="s0">import </span><span class="s1">DummyArray</span>
        <span class="s1">interface </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">__array_interface__</span><span class="s2">)</span>
        <span class="s1">interface</span><span class="s2">[</span><span class="s3">'descr'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_dtype</span><span class="s2">.</span><span class="s1">descr</span>
        <span class="s1">interface</span><span class="s2">[</span><span class="s3">'typestr'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">view_dtype</span><span class="s2">.</span><span class="s1">str</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">DummyArray</span><span class="s2">(</span><span class="s1">interface</span><span class="s2">, </span><span class="s1">base</span><span class="s2">=</span><span class="s1">a</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_view</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)[</span><span class="s3">'size_and_flags'</span><span class="s2">] &amp; </span><span class="s4">0xf0</span>

    <span class="s0">def </span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) == </span><span class="s1">self</span><span class="s2">.</span><span class="s1">INITIALIZED </span><span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">OUTSIDE_ARENA</span>

    <span class="s0">def </span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) == (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">INITIALIZED</span>
                                     <span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">OUTSIDE_ARENA</span>
                                     <span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">LONG</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">is_missing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) &amp; </span><span class="s1">self</span><span class="s2">.</span><span class="s1">MISSING </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">MISSING</span>

    <span class="s0">def </span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) &amp; (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">INITIALIZED </span><span class="s2">| </span><span class="s1">self</span><span class="s2">.</span><span class="s1">OUTSIDE_ARENA</span><span class="s2">)</span>
                <span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">INITIALIZED</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_setup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">is_short </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">length </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">str_len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">is_short</span><span class="s2">, (</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">length </span><span class="s2">&lt;= </span><span class="s4">15</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">), [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_missing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">view </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_view</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">sizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">is_short</span><span class="s2">, </span><span class="s1">view</span><span class="s2">[</span><span class="s3">'size_and_flags'</span><span class="s2">] &amp; </span><span class="s4">0xf</span><span class="s2">,</span>
                         <span class="s1">view</span><span class="s2">[</span><span class="s3">'size'</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">str_len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">[</span><span class="s3">'xsiz'</span><span class="s2">][</span><span class="s4">2</span><span class="s2">:],</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">void</span><span class="s2">(</span><span class="s6">b'</span><span class="s0">\x00</span><span class="s6">' </span><span class="s2">* (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sizeofstr </span><span class="s2">// </span><span class="s4">4 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)))</span>
        <span class="s5"># Check that the medium string uses only 1 byte for its length</span>
        <span class="s5"># in the arena, while the long string takes 8 (or 4).</span>
        <span class="s1">offsets </span><span class="s2">= </span><span class="s1">view</span><span class="s2">[</span><span class="s3">'offset'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">offsets</span><span class="s2">[</span><span class="s4">2</span><span class="s2">] == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">offsets</span><span class="s2">[</span><span class="s4">3</span><span class="s2">] == </span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium</span><span class="s2">) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sizeofstr </span><span class="s2">// </span><span class="s4">2</span>

    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">e </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">3</span><span class="s2">,), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">e</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zeros</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">2</span><span class="s2">,), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">z</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">offsets </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_view</span><span class="s2">(</span><span class="s1">c</span><span class="s2">)[</span><span class="s3">'offset'</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">offsets</span><span class="s2">[</span><span class="s4">2</span><span class="s2">] == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">offsets</span><span class="s2">[</span><span class="s4">3</span><span class="s2">] == </span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium</span><span class="s2">) + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sizeofstr </span><span class="s2">// </span><span class="s4">2</span>

    <span class="s0">def </span><span class="s1">test_arena_use_with_setting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arena_reuse_with_setting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arena_reuse_after_missing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_missing</span><span class="s2">(</span><span class="s1">c</span><span class="s2">))</span>
        <span class="s5"># Replacing with the original strings, the arena should be reused.</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arena_reuse_after_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s3">&quot;&quot;</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
        <span class="s5"># Replacing with the original strings, the arena should be reused.</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arena_reuse_for_shorter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s5"># A string slightly shorter than the shortest in the arena</span>
        <span class="s5"># should be used for all strings in the arena.</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s5"># first empty string in original was never initialized, so</span>
        <span class="s5"># filling it in now leaves it initialized inside the arena.</span>
        <span class="s5"># second string started as a short string so it can never live</span>
        <span class="s5"># in the arena.</span>
        <span class="s1">in_arena </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">in_arena</span><span class="s2">)</span>
        <span class="s5"># But when a short string is replaced, it will go on the heap.</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), ~</span><span class="s1">in_arena</span><span class="s2">)</span>
        <span class="s5"># We can put the originals back, and they'll still fit,</span>
        <span class="s5"># and short strings are back as short strings</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">in_arena</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arena_reuse_if_possible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s5"># A slightly longer string will not fit in the arena for</span>
        <span class="s5"># the medium string, but will fit for the longer one.</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium </span><span class="s2">+ </span><span class="s3">&quot;Â±&quot;</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium </span><span class="s2">+ </span><span class="s3">&quot;Â±&quot;</span><span class="s2">)</span>
        <span class="s1">in_arena_exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">str_len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">) &gt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_medium</span><span class="s2">) + </span><span class="s4">1</span>
        <span class="s5"># first entry started uninitialized and empty, so filling it leaves</span>
        <span class="s5"># it in the arena</span>
        <span class="s1">in_arena_exp</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s0">True</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">in_arena_exp </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">in_arena_exp</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), ~</span><span class="s1">in_arena_exp</span><span class="s2">)</span>
        <span class="s5"># And once outside arena, it stays outside, since offset is lost.</span>
        <span class="s5"># But short strings are used again.</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">is_short_exp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">in_arena_exp</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_short</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">is_short_exp</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), ~</span><span class="s1">in_arena_exp </span><span class="s2">&amp; ~</span><span class="s1">is_short_exp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_arena_no_reuse_after_short</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s5"># If we replace a string with a short string, it cannot</span>
        <span class="s5"># go into the arena after because the offset is lost.</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_short</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">s_short</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">[:] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">is_on_heap</span><span class="s2">(</span><span class="s1">c</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">in_arena</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">a</span><span class="s2">))</span>
</pre>
</body>
</html>