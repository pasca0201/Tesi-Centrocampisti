<html>
<head>
<title>test_from_model.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_from_model.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">Mock</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">datasets</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">BaseEstimator</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cross_decomposition </span><span class="s0">import </span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">PLSRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">make_friedman1</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">decomposition </span><span class="s0">import </span><span class="s1">PCA</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">ensemble </span><span class="s0">import </span><span class="s1">HistGradientBoostingClassifier</span><span class="s2">, </span><span class="s1">RandomForestClassifier</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">NotFittedError</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">feature_selection </span><span class="s0">import </span><span class="s1">SelectFromModel</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ElasticNet</span><span class="s2">,</span>
    <span class="s1">ElasticNetCV</span><span class="s2">,</span>
    <span class="s1">Lasso</span><span class="s2">,</span>
    <span class="s1">LassoCV</span><span class="s2">,</span>
    <span class="s1">LinearRegression</span><span class="s2">,</span>
    <span class="s1">LogisticRegression</span><span class="s2">,</span>
    <span class="s1">PassiveAggressiveClassifier</span><span class="s2">,</span>
    <span class="s1">SGDClassifier</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">make_pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">svm </span><span class="s0">import </span><span class="s1">LinearSVC</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">MinimalClassifier</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">skip_if_32bit</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s0">class </span><span class="s1">NaNTag</span><span class="s2">(</span><span class="s1">BaseEstimator</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_more_tags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s3">&quot;allow_nan&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>


<span class="s0">class </span><span class="s1">NoNaNTag</span><span class="s2">(</span><span class="s1">BaseEstimator</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_more_tags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s3">&quot;allow_nan&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">}</span>


<span class="s0">class </span><span class="s1">NaNTagRandomForest</span><span class="s2">(</span><span class="s1">RandomForestClassifier</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">_more_tags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s3">&quot;allow_nan&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>


<span class="s1">iris </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">()</span>
<span class="s1">data</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span>
<span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_invalid_input</span><span class="s2">():</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span>
        <span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s0">None</span>
    <span class="s2">)</span>
    <span class="s0">for </span><span class="s1">threshold </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;gobbledigook&quot;</span><span class="s2">, </span><span class="s3">&quot;.5 * gobbledigook&quot;</span><span class="s2">]:</span>
        <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s1">threshold</span><span class="s2">)</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_input_estimator_unchanged</span><span class="s2">():</span>
    <span class="s5"># Test that SelectFromModel fits on a clone of the estimator.</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">()</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator </span><span class="s0">is </span><span class="s1">est</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;max_features, err_type, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;max_features ==&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">,</span>
            <span class="s1">TypeError</span><span class="s2">,</span>
            <span class="s3">&quot;max_features must be an instance of int, not float.&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;max_features ==&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s0">lambda </span><span class="s1">X</span><span class="s2">: -</span><span class="s4">1</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;max_features ==&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_max_features_error</span><span class="s2">(</span><span class="s1">max_features</span><span class="s2">, </span><span class="s1">err_type</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">err_msg</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">err_type</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;max_features&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_inferred_max_features_integer</span><span class="s2">(</span><span class="s1">max_features</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check max_features_ and output shape for integer max_features.&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">max_features </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">max_features_ </span><span class="s2">== </span><span class="s1">max_features</span>
        <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">max_features_</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">transformer</span><span class="s2">, </span><span class="s3">&quot;max_features_&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;max_features&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">min</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s4">10000</span><span class="s2">)],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_inferred_max_features_callable</span><span class="s2">(</span><span class="s1">max_features</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check max_features_ and output shape for callable max_features.&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">max_features_ </span><span class="s2">== </span><span class="s1">max_features</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">max_features_</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;max_features&quot;</span><span class="s2">, [</span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">round</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) / </span><span class="s4">2</span><span class="s2">), </span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_max_features_array_like</span><span class="s2">(</span><span class="s1">max_features</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s4">0.87</span><span class="s2">, -</span><span class="s4">1.34</span><span class="s2">, </span><span class="s4">0.31</span><span class="s2">],</span>
        <span class="s2">[-</span><span class="s4">2.79</span><span class="s2">, -</span><span class="s4">0.02</span><span class="s2">, -</span><span class="s4">0.85</span><span class="s2">],</span>
        <span class="s2">[-</span><span class="s4">1.34</span><span class="s2">, -</span><span class="s4">0.48</span><span class="s2">, -</span><span class="s4">2.55</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">1.92</span><span class="s2">, </span><span class="s4">1.48</span><span class="s2">, </span><span class="s4">0.65</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">max_features_</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;max_features&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">min</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s4">10000</span><span class="s2">), </span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s4">1</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_max_features_callable_data</span><span class="s2">(</span><span class="s1">max_features</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Tests that the callable passed to `fit` is called on X.&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">side_effect</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">m</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">m</span><span class="s2">.</span><span class="s1">assert_called_with</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">FixedImportanceEstimator</span><span class="s2">(</span><span class="s1">BaseEstimator</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">importances</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">importances </span><span class="s2">= </span><span class="s1">importances</span>

    <span class="s0">def </span><span class="s1">fit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">feature_importances_ </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">importances</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_max_features</span><span class="s2">():</span>
    <span class="s5"># Test max_features parameter using various values</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">max_features </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">transformer1 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
    <span class="s1">transformer2 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
    <span class="s2">)</span>
    <span class="s1">X_new1 </span><span class="s2">= </span><span class="s1">transformer1</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_new2 </span><span class="s2">= </span><span class="s1">transformer2</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_new1</span><span class="s2">, </span><span class="s1">X_new2</span><span class="s2">)</span>

    <span class="s5"># Test max_features against actual model.</span>
    <span class="s1">transformer1 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">Lasso</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.025</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">42</span><span class="s2">))</span>
    <span class="s1">X_new1 </span><span class="s2">= </span><span class="s1">transformer1</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">scores1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">transformer1</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">)</span>
    <span class="s1">candidate_indices1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(-</span><span class="s1">scores1</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s3">&quot;mergesort&quot;</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">n_features </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">X_new1</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">):</span>
        <span class="s1">transformer2 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
            <span class="s1">estimator</span><span class="s2">=</span><span class="s1">Lasso</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.025</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">42</span><span class="s2">),</span>
            <span class="s1">max_features</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
            <span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">X_new2 </span><span class="s2">= </span><span class="s1">transformer2</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">scores2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">transformer2</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">)</span>
        <span class="s1">candidate_indices2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(-</span><span class="s1">scores2</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s3">&quot;mergesort&quot;</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">X</span><span class="s2">[:, </span><span class="s1">candidate_indices1</span><span class="s2">[:</span><span class="s1">n_features</span><span class="s2">]], </span><span class="s1">X</span><span class="s2">[:, </span><span class="s1">candidate_indices2</span><span class="s2">[:</span><span class="s1">n_features</span><span class="s2">]]</span>
        <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">transformer1</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">, </span><span class="s1">transformer2</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_max_features_tiebreak</span><span class="s2">():</span>
    <span class="s5"># Test if max_features can break tie among feature importance</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">max_features </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>

    <span class="s1">feature_importances </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">n_features </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">max_features </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">):</span>
        <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
            <span class="s1">FixedImportanceEstimator</span><span class="s2">(</span><span class="s1">feature_importances</span><span class="s2">),</span>
            <span class="s1">max_features</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
            <span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">X_new </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">selected_feature_indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">_get_support_mask</span><span class="s2">())[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">selected_feature_indices</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">X_new</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">n_features</span>


<span class="s0">def </span><span class="s1">test_threshold_and_max_features</span><span class="s2">():</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">transformer1 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
    <span class="s1">X_new1 </span><span class="s2">= </span><span class="s1">transformer1</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">transformer2 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s4">0.04</span><span class="s2">)</span>
    <span class="s1">X_new2 </span><span class="s2">= </span><span class="s1">transformer2</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">transformer3 </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s4">0.04</span><span class="s2">)</span>
    <span class="s1">X_new3 </span><span class="s2">= </span><span class="s1">transformer3</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_new3</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">min</span><span class="s2">(</span><span class="s1">X_new1</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">X_new2</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">selected_indices </span><span class="s2">= </span><span class="s1">transformer3</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, :])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_new3</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[:, </span><span class="s1">selected_indices</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">skip_if_32bit</span>
<span class="s0">def </span><span class="s1">test_feature_importances</span><span class="s2">():</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">threshold</span><span class="s2">, </span><span class="s1">func </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s3">&quot;mean&quot;</span><span class="s2">, </span><span class="s3">&quot;median&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">median</span><span class="s2">]):</span>
        <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s1">threshold</span><span class="s2">)</span>
        <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">, </span><span class="s3">&quot;feature_importances_&quot;</span><span class="s2">)</span>

        <span class="s1">X_new </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">X_new</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &lt; </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">importances </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">feature_importances_</span>

        <span class="s1">feature_mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">importances</span><span class="s2">) &gt; </span><span class="s1">func</span><span class="s2">(</span><span class="s1">importances</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X_new</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[:, </span><span class="s1">feature_mask</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_sample_weight</span><span class="s2">():</span>
    <span class="s5"># Ensure sample weights are passed to underlying estimator</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s5"># Check with sample weights</span>
    <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">sample_weight</span><span class="s2">[</span><span class="s1">y </span><span class="s2">== </span><span class="s4">1</span><span class="s2">] *= </span><span class="s4">100</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">LogisticRegression</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">fit_intercept</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">_get_support_mask</span><span class="s2">()</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">)</span>
    <span class="s1">weighted_mask </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">_get_support_mask</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">weighted_mask </span><span class="s2">== </span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s4">3 </span><span class="s2">* </span><span class="s1">sample_weight</span><span class="s2">)</span>
    <span class="s1">reweighted_mask </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">_get_support_mask</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">weighted_mask </span><span class="s2">== </span><span class="s1">reweighted_mask</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">Lasso</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">42</span><span class="s2">),</span>
        <span class="s1">LassoCV</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">42</span><span class="s2">),</span>
        <span class="s1">ElasticNet</span><span class="s2">(</span><span class="s1">l1_ratio</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">42</span><span class="s2">),</span>
        <span class="s1">ElasticNetCV</span><span class="s2">(</span><span class="s1">l1_ratio</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">42</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_coef_default_threshold</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">):</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s5"># For the Lasso and related models, the threshold defaults to 1e-5</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">estimator</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_new </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">) &gt; </span><span class="s4">1e-5</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X_new</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[:, </span><span class="s1">mask</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">skip_if_32bit</span>
<span class="s0">def </span><span class="s1">test_2d_coef</span><span class="s2">():</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">n_classes</span><span class="s2">=</span><span class="s4">4</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">LogisticRegression</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">threshold</span><span class="s2">, </span><span class="s1">func </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">([</span><span class="s3">&quot;mean&quot;</span><span class="s2">, </span><span class="s3">&quot;median&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">median</span><span class="s2">]):</span>
        <span class="s0">for </span><span class="s1">order </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]:</span>
            <span class="s5"># Fit SelectFromModel a multi-class problem</span>
            <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
                <span class="s1">estimator</span><span class="s2">=</span><span class="s1">LogisticRegression</span><span class="s2">(), </span><span class="s1">threshold</span><span class="s2">=</span><span class="s1">threshold</span><span class="s2">, </span><span class="s1">norm_order</span><span class="s2">=</span><span class="s1">order</span>
            <span class="s2">)</span>
            <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">, </span><span class="s3">&quot;coef_&quot;</span><span class="s2">)</span>
            <span class="s1">X_new </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">X_new</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &lt; </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>

            <span class="s5"># Manually check that the norm is correctly performed</span>
            <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">importances </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">est</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ord</span><span class="s2">=</span><span class="s1">order</span><span class="s2">)</span>
            <span class="s1">feature_mask </span><span class="s2">= </span><span class="s1">importances </span><span class="s2">&gt; </span><span class="s1">func</span><span class="s2">(</span><span class="s1">importances</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X_new</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[:, </span><span class="s1">feature_mask</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_partial_fit</span><span class="s2">():</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">PassiveAggressiveClassifier</span><span class="s2">(</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s0">None</span>
    <span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y</span><span class="s2">))</span>
    <span class="s1">old_model </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y</span><span class="s2">))</span>
    <span class="s1">new_model </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span>
    <span class="s0">assert </span><span class="s1">old_model </span><span class="s0">is </span><span class="s1">new_model</span>

    <span class="s1">X_transform </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">((</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">((</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X_transform</span><span class="s2">, </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>

    <span class="s5"># check that if est doesn't have partial_fit, neither does SelectFromModel</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">RandomForestClassifier</span><span class="s2">())</span>
    <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">transformer</span><span class="s2">, </span><span class="s3">&quot;partial_fit&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_calling_fit_reinitializes</span><span class="s2">():</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">LinearSVC</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">estimator__C</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>
    <span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">C </span><span class="s2">== </span><span class="s4">100</span>


<span class="s0">def </span><span class="s1">test_prefit</span><span class="s2">():</span>
    <span class="s5"># Test all possible combinations of the prefit parameter.</span>

    <span class="s5"># Passing a prefit parameter with the selected model</span>
    <span class="s5"># and fitting a unfit model with prefit=False should give same results.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_transform </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">prefit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">X_transform</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">estimator_ </span><span class="s0">is not </span><span class="s1">clf</span>

    <span class="s5"># Check that the model is rewritten if prefit=False and a fitted model is</span>
    <span class="s5"># passed</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">prefit</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">X_transform</span><span class="s2">)</span>

    <span class="s5"># Check that passing an unfitted estimator with `prefit=True` raises a</span>
    <span class="s5"># `ValueError`</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">prefit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s3">&quot;When `prefit=True`, `estimator` is expected to be a fitted estimator.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s5"># Check that the internal parameters of prefitted model are not changed</span>
    <span class="s5"># when calling `fit` or `partial_fit` with `prefit=True`</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">prefit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">model</span><span class="s2">.</span><span class="s1">estimator_</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">coef_</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_prefit_max_features</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check the interaction between `prefit` and `max_features`.&quot;&quot;&quot;</span>
    <span class="s5"># case 1: an error should be raised at `transform` if `fit` was not called to</span>
    <span class="s5"># validate the attributes</span>
    <span class="s1">estimator </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">estimator</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">prefit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">X</span><span class="s2">: </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s3">&quot;When `prefit=True` and `max_features` is a callable, call `fit` &quot;</span>
        <span class="s3">&quot;before calling `transform`.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s5"># case 2: `max_features` is not validated and different from an integer</span>
    <span class="s5"># FIXME: we cannot validate the upper bound of the attribute at transform</span>
    <span class="s5"># and we should force calling `fit` if we intend to force the attribute</span>
    <span class="s5"># to have such an upper bound.</span>
    <span class="s1">max_features </span><span class="s2">= </span><span class="s4">2.5</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;`max_features` must be an integer&quot;</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_prefit_get_feature_names_out</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check the interaction between prefit and the feature names.&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">prefit</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">name </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">model</span><span class="s2">).</span><span class="s1">__name__</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s3">f&quot;This </span><span class="s0">{</span><span class="s1">name</span><span class="s0">} </span><span class="s3">instance is not fitted yet. Call 'fit' with &quot;</span>
        <span class="s3">&quot;appropriate arguments before using this estimator.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">model</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>

    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">feature_names </span><span class="s2">== [</span><span class="s3">&quot;x3&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_threshold_string</span><span class="s2">():</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">RandomForestClassifier</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">est</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s3">&quot;0.5*mean&quot;</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_transform </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s5"># Calculate the threshold from the estimator directly.</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">threshold </span><span class="s2">= </span><span class="s4">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">est</span><span class="s2">.</span><span class="s1">feature_importances_</span><span class="s2">)</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">feature_importances_ </span><span class="s2">&gt; </span><span class="s1">threshold</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">X_transform</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[:, </span><span class="s1">mask</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_threshold_without_refitting</span><span class="s2">():</span>
    <span class="s5"># Test that the threshold can be set without refitting the model.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">SGDClassifier</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">shuffle</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s3">&quot;0.1 * mean&quot;</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">X_transform </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s5"># Set a higher threshold to filter out more features.</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">threshold </span><span class="s2">= </span><span class="s3">&quot;1.0 * mean&quot;</span>
    <span class="s0">assert </span><span class="s1">X_transform</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &gt; </span><span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_fit_accepts_nan_inf</span><span class="s2">():</span>
    <span class="s5"># Test that fit doesn't check for np.inf and np.nan values.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">HistGradientBoostingClassifier</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">)</span>

    <span class="s1">nan_data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">nan_data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s1">nan_data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>

    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transform_accepts_nan_inf</span><span class="s2">():</span>
    <span class="s5"># Test that transform doesn't check for np.inf and np.nan values.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">NaNTagRandomForest</span><span class="s2">(</span><span class="s1">n_estimators</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">nan_data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">clf</span><span class="s2">)</span>
    <span class="s1">model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">nan_data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">nan_data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s1">nan_data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>

    <span class="s1">model</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">nan_data</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_allow_nan_tag_comes_from_estimator</span><span class="s2">():</span>
    <span class="s1">allow_nan_est </span><span class="s2">= </span><span class="s1">NaNTag</span><span class="s2">()</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">allow_nan_est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_get_tags</span><span class="s2">()[</span><span class="s3">&quot;allow_nan&quot;</span><span class="s2">] </span><span class="s0">is True</span>

    <span class="s1">no_nan_est </span><span class="s2">= </span><span class="s1">NoNaNTag</span><span class="s2">()</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">no_nan_est</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">_get_tags</span><span class="s2">()[</span><span class="s3">&quot;allow_nan&quot;</span><span class="s2">] </span><span class="s0">is False</span>


<span class="s0">def </span><span class="s1">_pca_importances</span><span class="s2">(</span><span class="s1">pca_estimator</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pca_estimator</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;estimator, importance_getter&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">LogisticRegression</span><span class="s2">()),</span>
            <span class="s3">&quot;named_steps.logisticregression.coef_&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">), </span><span class="s1">_pca_importances</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_importance_getter</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">importance_getter</span><span class="s2">):</span>
    <span class="s1">selector </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">estimator</span><span class="s2">, </span><span class="s1">threshold</span><span class="s2">=</span><span class="s3">&quot;mean&quot;</span><span class="s2">, </span><span class="s1">importance_getter</span><span class="s2">=</span><span class="s1">importance_getter</span>
    <span class="s2">)</span>
    <span class="s1">selector</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">selector</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s4">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;PLSEstimator&quot;</span><span class="s2">, [</span><span class="s1">CCA</span><span class="s2">, </span><span class="s1">PLSCanonical</span><span class="s2">, </span><span class="s1">PLSRegression</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_select_from_model_pls</span><span class="s2">(</span><span class="s1">PLSEstimator</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of SelectFromModel with PLS estimators. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/12410 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_friedman1</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">estimator </span><span class="s2">= </span><span class="s1">PLSEstimator</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">model </span><span class="s2">= </span><span class="s1">make_pipeline</span><span class="s2">(</span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">), </span><span class="s1">estimator</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">model</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) &gt; </span><span class="s4">0.5</span>


<span class="s0">def </span><span class="s1">test_estimator_does_not_support_feature_names</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;SelectFromModel works with estimators that do not support feature_names_in_. 
 
    Non-regression test for #21949. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">(</span><span class="s1">as_frame</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">all_feature_names </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">importance_getter</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s1">selector </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span>
        <span class="s1">MinimalClassifier</span><span class="s2">(), </span><span class="s1">importance_getter</span><span class="s2">=</span><span class="s1">importance_getter</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># selector learns the feature names itself</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">feature_names_in_</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s1">feature_names_out </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">feature_names_out </span><span class="s2">&lt; </span><span class="s1">all_feature_names</span>

    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s1">UserWarning</span><span class="s2">)</span>

        <span class="s1">selector</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:</span><span class="s4">3</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;error, err_msg, max_features&quot;</span><span class="s2">,</span>
    <span class="s2">(</span>
        <span class="s2">[</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s3">&quot;max_features == 10, must be &lt;= 4&quot;</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s3">&quot;max_features == 5, must be &lt;= 4&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">],</span>
    <span class="s2">),</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_partial_fit_validate_max_features</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">, </span><span class="s1">max_features</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that partial_fit from SelectFromModel validates `max_features`.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_samples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s4">4</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">SelectFromModel</span><span class="s2">(</span>
            <span class="s1">estimator</span><span class="s2">=</span><span class="s1">SGDClassifier</span><span class="s2">(), </span><span class="s1">max_features</span><span class="s2">=</span><span class="s1">max_features</span>
        <span class="s2">).</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;as_frame&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_partial_fit_validate_feature_names</span><span class="s2">(</span><span class="s1">as_frame</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that partial_fit from SelectFromModel validates `feature_names_in_`.&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">(</span><span class="s1">as_frame</span><span class="s2">=</span><span class="s1">as_frame</span><span class="s2">, </span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">selector </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">SGDClassifier</span><span class="s2">(), </span><span class="s1">max_features</span><span class="s2">=</span><span class="s4">4</span><span class="s2">).</span><span class="s1">partial_fit</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">.</span><span class="s1">feature_names_in_</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">selector</span><span class="s2">, </span><span class="s3">&quot;feature_names_in_&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_from_model_estimator_attribute_error</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise the proper AttributeError when the estimator 
    does not implement the `partial_fit` method, which is decorated with 
    `available_if`. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/28108 
    &quot;&quot;&quot;</span>
    <span class="s5"># `LinearRegression` does not implement 'partial_fit' and should raise an</span>
    <span class="s5"># AttributeError</span>
    <span class="s1">from_model </span><span class="s2">= </span><span class="s1">SelectFromModel</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">=</span><span class="s1">LinearRegression</span><span class="s2">())</span>

    <span class="s1">outer_msg </span><span class="s2">= </span><span class="s3">&quot;This 'SelectFromModel' has no attribute 'partial_fit'&quot;</span>
    <span class="s1">inner_msg </span><span class="s2">= </span><span class="s3">&quot;'LinearRegression' object has no attribute 'partial_fit'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">outer_msg</span><span class="s2">) </span><span class="s0">as </span><span class="s1">exec_info</span><span class="s2">:</span>
        <span class="s1">from_model</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">AttributeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inner_msg </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">exec_info</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>
</pre>
</body>
</html>