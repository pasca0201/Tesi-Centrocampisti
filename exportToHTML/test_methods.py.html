<html>
<head>
<title>test_methods.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_methods.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s1">SettingWithCopyWarning</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">MultiIndex</span><span class="s2">,</span>
    <span class="s1">Period</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">Timestamp</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
    <span class="s1">option_context</span><span class="s2">,</span>
    <span class="s1">period_range</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">copy_view</span><span class="s2">.</span><span class="s1">util </span><span class="s0">import </span><span class="s1">get_array</span>


<span class="s0">def </span><span class="s1">test_copy</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_copy </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s5"># the deep copy by defaults takes a shallow copy of the Index</span>
    <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">index </span><span class="s0">is not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
    <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">columns </span><span class="s0">is not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span>
    <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">is_</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">is_</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>

    <span class="s5"># the deep copy doesn't share memory</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df_copy</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">refs</span><span class="s2">.</span><span class="s1">has_reference</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">refs</span><span class="s2">.</span><span class="s1">has_reference</span><span class="s2">()</span>

    <span class="s5"># mutating copy doesn't mutate original</span>
    <span class="s1">df_copy</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">1</span>


<span class="s0">def </span><span class="s1">test_copy_shallow</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_copy </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">deep</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s5"># the shallow copy also makes a shallow copy of the index</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">index </span><span class="s0">is not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">columns </span><span class="s0">is not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">is_</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">is_</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">index </span><span class="s0">is </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">columns </span><span class="s0">is </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span>

    <span class="s5"># the shallow copy still shares memory</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df_copy</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">refs</span><span class="s2">.</span><span class="s1">has_reference</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">df_copy</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">blocks</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">refs</span><span class="s2">.</span><span class="s1">has_reference</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># mutating shallow copy doesn't mutate original</span>
        <span class="s1">df_copy</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">1</span>
        <span class="s5"># mutating triggered a copy-on-write -&gt; no longer shares memory</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df_copy</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s5"># but still shares memory for the other columns/blocks</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df_copy</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># mutating shallow copy does mutate original</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
            <span class="s1">df_copy</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">0</span>
        <span class="s5"># and still shares memory</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df_copy</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;copy&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;method&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">str</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reindex</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reindex_like</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">],</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_axis</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename_axis</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename_axis</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;int64&quot;</span><span class="s2">}, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s5"># lambda df, copy: df.swaplevel(0, 0, copy=copy),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">truncate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">infer_objects</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_period</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s3">&quot;US/Central&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">tz_convert</span><span class="s2">(</span><span class="s3">&quot;US/Central&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_flags</span><span class="s2">(</span><span class="s1">allows_duplicate_labels</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s3">&quot;rename&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;reindex&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;reindex_like&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;align&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;set_axis&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;rename_axis0&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;rename_axis1&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;astype&quot;</span><span class="s2">,</span>
        <span class="s5"># &quot;swaplevel&quot;,  # only series</span>
        <span class="s3">&quot;swapaxes&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;truncate&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;infer_objects&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;to_timestamp&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;to_period&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;tz_localize&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;tz_convert&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;set_flags&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_methods_copy_keyword</span><span class="s2">(</span>
    <span class="s1">request</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">, </span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">using_array_manager</span>
<span class="s2">):</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s3">&quot;to_timestamp&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">period_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;to_period&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;tz_localize&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;tz_convert&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;Europe/Brussels&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;swapaxes&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)</span>

    <span class="s1">share_memory </span><span class="s2">= </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s1">copy </span><span class="s0">is False</span>

    <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;reindex-&quot;</span><span class="s2">):</span>
        <span class="s5"># TODO copy=False without CoW still returns a copy in this case</span>
        <span class="s0">if not </span><span class="s1">using_copy_on_write </span><span class="s0">and not </span><span class="s1">using_array_manager </span><span class="s0">and </span><span class="s1">copy </span><span class="s0">is False</span><span class="s2">:</span>
            <span class="s1">share_memory </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">if </span><span class="s1">share_memory</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;copy&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;method&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">index</span><span class="s2">={</span><span class="s4">0</span><span class="s2">: </span><span class="s4">100</span><span class="s2">}, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">reindex</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">reindex_like</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">],</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">set_axis</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">rename_axis</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">swaplevel</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">truncate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">infer_objects</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">to_timestamp</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">to_period</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s3">&quot;US/Central&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">tz_convert</span><span class="s2">(</span><span class="s3">&quot;US/Central&quot;</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">set_flags</span><span class="s2">(</span><span class="s1">allows_duplicate_labels</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s3">&quot;rename (dict)&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;rename&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;reindex&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;reindex_like&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;align&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;set_axis&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;rename_axis0&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;astype&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;swaplevel&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;swapaxes&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;truncate&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;infer_objects&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;to_timestamp&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;to_period&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;tz_localize&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;tz_convert&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;set_flags&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_methods_series_copy_keyword</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">, </span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s3">&quot;to_timestamp&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">period_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;to_period&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;tz_localize&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;tz_convert&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2012-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;Europe/Brussels&quot;</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;swaplevel&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>

    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;swapaxes&quot; </span><span class="s0">in </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;'Series.swapaxes' is deprecated&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)</span>

    <span class="s1">share_memory </span><span class="s2">= </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s1">copy </span><span class="s0">is False</span>

    <span class="s0">if </span><span class="s1">share_memory</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;copy&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_transpose_copy_keyword</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">, </span><span class="s1">using_array_manager</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)</span>
    <span class="s1">share_memory </span><span class="s2">= </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s1">copy </span><span class="s0">is False or </span><span class="s1">copy </span><span class="s0">is None</span>
    <span class="s1">share_memory </span><span class="s2">= </span><span class="s1">share_memory </span><span class="s0">and not </span><span class="s1">using_array_manager</span>

    <span class="s0">if </span><span class="s1">share_memory</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>


<span class="s5"># -----------------------------------------------------------------------------</span>
<span class="s5"># DataFrame methods returning new DataFrame using shallow copy</span>


<span class="s0">def </span><span class="s1">test_reset_index</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: resetting the index (i.e. adding a new column) + mutating the</span>
    <span class="s5"># resulting dataframe</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">()</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_verify_integrity</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># still shares memory (df2 is a shallow copy)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s5"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, [</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">RangeIndex</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">Index</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])])</span>
<span class="s0">def </span><span class="s1">test_reset_index_series_drop</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">index</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">))</span>

    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_groupby_column_index_in_references</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s3">&quot;C&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;A&quot;</span><span class="s2">)</span>
    <span class="s1">key </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C&quot;</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">observed</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">groupby</span><span class="s2">(</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s1">observed</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_rename_columns</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: renaming columns returns a new dataframe</span>
    <span class="s5"># + afterwards modifying the result</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">str</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;C&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_rename_columns_modify_parent</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: renaming columns returns a new dataframe</span>
    <span class="s5"># + afterwards modifying the original (parent) dataframe</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">str</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">)</span>
    <span class="s1">df2_orig </span><span class="s2">= </span><span class="s1">df2</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">df2_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pipe</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">testfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">df</span>

    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">(</span><span class="s1">testfunc</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_pipe_modify_df</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">testfunc</span><span class="s2">(</span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
        <span class="s0">return </span><span class="s1">df</span>

    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">(</span><span class="s1">testfunc</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">100</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_reindex_columns</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: reindexing the column returns a new dataframe</span>
    <span class="s5"># + afterwards modifying the result</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reindex</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># still shares memory (df2 is a shallow copy)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s5"># mutating df2 triggers a copy-on-write for that column</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;index&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">idx</span><span class="s2">: </span><span class="s1">idx</span><span class="s2">,</span>
        <span class="s0">lambda </span><span class="s1">idx</span><span class="s2">: </span><span class="s1">idx</span><span class="s2">.</span><span class="s1">view</span><span class="s2">(),</span>
        <span class="s0">lambda </span><span class="s1">idx</span><span class="s2">: </span><span class="s1">idx</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(),</span>
        <span class="s0">lambda </span><span class="s1">idx</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s1">idx</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;identical&quot;</span><span class="s2">, </span><span class="s3">&quot;view&quot;</span><span class="s2">, </span><span class="s3">&quot;copy&quot;</span><span class="s2">, </span><span class="s3">&quot;values&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_reindex_rows</span><span class="s2">(</span><span class="s1">index</span><span class="s2">, </span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: reindexing the rows with an index that matches the current index</span>
    <span class="s5"># can use a shallow copy</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reindex</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># still shares memory (df2 is a shallow copy)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s5"># mutating df2 triggers a copy-on-write for that column</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_drop_on_column</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_verify_integrity</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_select_dtypes</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: selecting columns using `select_dtypes()` returns a new dataframe</span>
    <span class="s5"># + afterwards modifying the result</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">select_dtypes</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_verify_integrity</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;filter_kwargs&quot;</span><span class="s2">, [{</span><span class="s3">&quot;items&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">]}, {</span><span class="s3">&quot;like&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">}, {</span><span class="s3">&quot;regex&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">}]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_filter</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">filter_kwargs</span><span class="s2">):</span>
    <span class="s5"># Case: selecting columns using `filter()` returns a new dataframe</span>
    <span class="s5"># + afterwards modifying the result</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(**</span><span class="s1">filter_kwargs</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_shift_no_op</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-03&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_shift_index</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-03&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_shift_rows_freq</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-03&quot;</span><span class="s2">),</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df_orig</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-02&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-04&quot;</span><span class="s2">)</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;1D&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_shift_columns</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-02&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;2020-01-02&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span>
            <span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;2020-01-02&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]],</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-01-01&quot;</span><span class="s2">, </span><span class="s3">&quot;2020-01-02&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pop</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">view_original </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view_original</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view_original</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view_original</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view_original</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view_original</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view_original</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;func&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">y</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_align_frame</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df_changed </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">]].</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_changed</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_align_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser_other </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2</span><span class="s2">, </span><span class="s1">ser_other_result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">ser_other</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser_other_result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser_other</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser_other_result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser_other</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">ser_other_result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser_other_result</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser_other</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser_other</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_align_copy_false</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2</span><span class="s2">, </span><span class="s1">df3 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)  </span><span class="s5"># Original is unchanged</span>

        <span class="s1">df3</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)  </span><span class="s5"># Original is unchanged</span>


<span class="s0">def </span><span class="s1">test_align_with_series_copy_false</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]})</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;x&quot;</span><span class="s2">)</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2</span><span class="s2">, </span><span class="s1">ser2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">align</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)  </span><span class="s5"># Original is unchanged</span>

        <span class="s1">ser2</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)  </span><span class="s5"># Original is unchanged</span>


<span class="s0">def </span><span class="s1">test_to_frame</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: converting a Series to a DataFrame with to_frame</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">[:].</span><span class="s1">to_frame</span><span class="s2">()</span>

    <span class="s5"># currently this always returns a &quot;view&quot;</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># mutating df triggers a copy-on-write for that column</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># but currently select_dtypes() actually returns a view -&gt; mutates parent</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser_orig</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s5"># modify original series -&gt; don't modify dataframe</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">[:].</span><span class="s1">to_frame</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">())</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser_orig</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">().</span><span class="s1">to_frame</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;ax&quot;</span><span class="s2">, [</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s3">&quot;columns&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_swapaxes_noop</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_swapaxes_single_block</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">])</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s3">&quot;columns&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_swapaxes_read_only_array</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">})</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">swapaxes</span><span class="s2">(</span><span class="s1">axis1</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">axis2</span><span class="s2">=</span><span class="s3">&quot;columns&quot;</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">0</span><span class="s2">: [</span><span class="s4">100</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s4">1</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;method, idx&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">deep</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">deep</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">().</span><span class="s1">reset_index</span><span class="s2">(), </span><span class="s4">2</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">str</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">).</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=</span><span class="s1">str</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">), </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">deep</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">select_dtypes</span><span class="s2">(</span><span class="s1">include</span><span class="s2">=</span><span class="s3">&quot;number&quot;</span><span class="s2">), </span><span class="s4">0</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;shallow-copy&quot;</span><span class="s2">, </span><span class="s3">&quot;reset_index&quot;</span><span class="s2">, </span><span class="s3">&quot;rename&quot;</span><span class="s2">, </span><span class="s3">&quot;select_dtypes&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_chained_methods</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s5"># when not using CoW, only the copy() variant actually gives a view</span>
    <span class="s1">df2_is_view </span><span class="s2">= </span><span class="s0">not </span><span class="s1">using_copy_on_write </span><span class="s0">and </span><span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">callspec</span><span class="s2">.</span><span class="s1">id </span><span class="s2">== </span><span class="s3">&quot;shallow-copy&quot;</span>

    <span class="s5"># modify df2 -&gt; don't modify df</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write </span><span class="s0">and </span><span class="s1">df2_is_view</span><span class="s2">):</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if not </span><span class="s1">df2_is_view</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>

    <span class="s5"># modify df -&gt; don't modify df2</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write </span><span class="s0">and </span><span class="s1">df2_is_view</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if not </span><span class="s1">df2_is_view</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:, </span><span class="s1">idx</span><span class="s2">:], </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;obj&quot;</span><span class="s2">, [</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})])</span>
<span class="s0">def </span><span class="s1">test_to_timestamp</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
    <span class="s1">obj</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">([</span><span class="s1">Period</span><span class="s2">(</span><span class="s3">&quot;2012-1-1&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">), </span><span class="s1">Period</span><span class="s2">(</span><span class="s3">&quot;2012-1-2&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">)])</span>

    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">obj2 </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">to_timestamp</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating obj2 triggers a copy-on-write for that column / block</span>
    <span class="s1">obj2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;obj&quot;</span><span class="s2">, [</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})])</span>
<span class="s0">def </span><span class="s1">test_to_period</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
    <span class="s1">obj</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">([</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2019-12-31&quot;</span><span class="s2">), </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s2">)])</span>

    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">obj2 </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">to_period</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;Y&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating obj2 triggers a copy-on-write for that column / block</span>
    <span class="s1">obj2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_index</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_index_mutating_parent_does_not_mutate_index</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_add_prefix</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">add_prefix</span><span class="s2">(</span><span class="s3">&quot;CoW_&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;CoW_a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;CoW_a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;CoW_c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;CoW_a&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;CoW_b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;CoW_c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_add_suffix</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">add_suffix</span><span class="s2">(</span><span class="s3">&quot;_CoW&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a_CoW&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a_CoW&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c_CoW&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;a_CoW&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b_CoW&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c_CoW&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis, val&quot;</span><span class="s2">, [(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_dropna</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;d&quot;</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dropna</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;val&quot;</span><span class="s2">, [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_dropna_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">dropna</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;method&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">head</span><span class="s2">(),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">head</span><span class="s2">(</span><span class="s4">2</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">tail</span><span class="s2">(),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">tail</span><span class="s2">(</span><span class="s4">3</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_head_tail</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_verify_integrity</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># We are explicitly deviating for CoW here to make an eager copy (avoids</span>
        <span class="s5"># tracking references for very cheap ops)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s5"># modify df2 to trigger CoW for that block</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># without CoW enabled, head and tail return views. Mutating df2 also mutates df.</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
            <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">1</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_infer_objects</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s3">&quot;x&quot;</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">infer_objects</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s3">&quot;d&quot;</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_infer_objects_no_reference</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2019-12-31&quot;</span><span class="s2">), </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;object&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;e&quot;</span><span class="s2">: </span><span class="s3">&quot;b&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">infer_objects</span><span class="s2">()</span>

    <span class="s1">arr_a </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">arr_b </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>
    <span class="s1">arr_d </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">)</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s3">&quot;d&quot;</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">] = </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2018-12-31&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_a</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s5"># TODO(CoW): Block splitting causes references here</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_b</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_d</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_infer_objects_reference</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2019-12-31&quot;</span><span class="s2">), </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;object&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:]  </span><span class="s5"># noqa: F841</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">infer_objects</span><span class="s2">()</span>

    <span class="s1">arr_a </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">arr_b </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>
    <span class="s1">arr_d </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">)</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s3">&quot;d&quot;</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">] = </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2018-12-31&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_a</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_b</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_d</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s3">&quot;before&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;after&quot;</span><span class="s2">: </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;axis&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s3">&quot;before&quot;</span><span class="s2">: </span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;after&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;axis&quot;</span><span class="s2">: </span><span class="s4">0</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_truncate</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">truncate</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_verify_integrity</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;assign&quot;</span><span class="s2">, </span><span class="s3">&quot;drop_duplicates&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_assign_drop_duplicates</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">method</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)()</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_verify_integrity</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;obj&quot;</span><span class="s2">, [</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]), </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})])</span>
<span class="s0">def </span><span class="s1">test_take</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
    <span class="s5"># Check that no copy is made when we take all rows in original order</span>
    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">obj2 </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s1">obj2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;obj&quot;</span><span class="s2">, [</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]), </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})])</span>
<span class="s0">def </span><span class="s1">test_between_time</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
    <span class="s1">obj</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2018-04-09&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;1D20min&quot;</span><span class="s2">)</span>
    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">obj2 </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">between_time</span><span class="s2">(</span><span class="s3">&quot;0:00&quot;</span><span class="s2">, </span><span class="s3">&quot;1:00&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s1">obj2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reindex_like</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">})</span>
    <span class="s1">other </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>

    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reindex_like</span><span class="s2">(</span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sort_index</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s5"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;obj, kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">), {}), (</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}), {</span><span class="s3">&quot;by&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">})],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort_values</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">obj2 </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df triggers a copy-on-write for the column / block</span>
    <span class="s1">obj2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;obj, kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">), {}), (</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}), {</span><span class="s3">&quot;by&quot;</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">})],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sort_values_inplace</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">[:]</span>
    <span class="s1">obj</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating obj triggers a copy-on-write for the column / block</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">obj</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;decimals&quot;</span><span class="s2">, [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_round</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">, </span><span class="s1">decimals</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;c&quot;</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s1">decimals</span><span class="s2">=</span><span class="s1">decimals</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s5"># TODO: Make inplace by using out parameter of ndarray.round?</span>
        <span class="s0">if </span><span class="s1">decimals </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s5"># Ensure lazy copy if no-op</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s3">&quot;d&quot;</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">4</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reorder_levels</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reorder_levels</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=[</span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_series_reorder_levels</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">reorder_levels</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=[</span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;obj&quot;</span><span class="s2">, [</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})])</span>
<span class="s0">def </span><span class="s1">test_swaplevel</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">])</span>
    <span class="s1">obj</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">index</span>
    <span class="s1">obj_orig </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">obj2 </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">swaplevel</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s1">obj2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">obj2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">obj_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_frame_set_axis</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_axis</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_series_set_axis</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">set_axis</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">)</span>

    <span class="s5"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_flags</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">set_flags</span><span class="s2">(</span><span class="s1">allows_duplicate_labels</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">)</span>

    <span class="s5"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;kwargs&quot;</span><span class="s2">, [{</span><span class="s3">&quot;mapper&quot;</span><span class="s2">: </span><span class="s3">&quot;test&quot;</span><span class="s2">}, {</span><span class="s3">&quot;index&quot;</span><span class="s2">: </span><span class="s3">&quot;test&quot;</span><span class="s2">}])</span>
<span class="s0">def </span><span class="s1">test_rename_axis</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">rename_axis</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;func, tz&quot;</span><span class="s2">, [(</span><span class="s3">&quot;tz_convert&quot;</span><span class="s2">, </span><span class="s3">&quot;Europe/Berlin&quot;</span><span class="s2">), (</span><span class="s3">&quot;tz_localize&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_tz_convert_localize</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2014-08-01 09:00&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;h&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s1">tz</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span><span class="s3">&quot;US/Central&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>

    <span class="s5"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">values</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_droplevel</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH 49473</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">])</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">droplevel</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_squeeze</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">series </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">squeeze</span><span class="s2">()</span>

    <span class="s5"># Should share memory regardless of CoW since squeeze is just an iloc</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">series</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating squeezed df triggers a copy-on-write for that column/block</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">series</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">series</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># Without CoW the original will be modified</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">series</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">] == </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">test_items</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s5"># Test this twice, since the second time, the item cache will be</span>
    <span class="s5"># triggered, and we want to make sure it still works then.</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">ser </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">name</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>

            <span class="s5"># mutating df triggers a copy-on-write for that column / block</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
                <span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

            <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
                <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">name</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">name</span><span class="s2">))</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># Original frame will be modified</span>
                <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">name</span><span class="s2">] == </span><span class="s4">0</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;Int64&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_putmask</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:]</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s1">df </span><span class="s2">== </span><span class="s1">df</span><span class="s2">] = </span><span class="s4">5</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># Without CoW the original will be modified</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">view</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">5</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;Int64&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_putmask_no_reference</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">arr_a </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s1">df </span><span class="s2">== </span><span class="s1">df</span><span class="s2">] = </span><span class="s4">5</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_a</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;float64&quot;</span><span class="s2">, </span><span class="s3">&quot;Float64&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_putmask_aligns_rhs_no_reference</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">arr_a </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s1">df </span><span class="s2">== </span><span class="s1">df</span><span class="s2">] = </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">5.5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]})</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">arr_a</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;val, exp, warn&quot;</span><span class="s2">, [(</span><span class="s4">5.5</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">FutureWarning</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_putmask_dont_copy_some_blocks</span><span class="s2">(</span>
    <span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">, </span><span class="s1">warn</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span>
<span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">})</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:]</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">indexer </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">warn_copy_on_write</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">():</span>
            <span class="s1">df</span><span class="s2">[</span><span class="s1">indexer</span><span class="s2">] = </span><span class="s1">val</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warn</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;incompatible dtype&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">[</span><span class="s1">indexer</span><span class="s2">] = </span><span class="s1">val</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s5"># TODO(CoW): Could split blocks to avoid copying the whole block</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">)) </span><span class="s0">is </span><span class="s1">exp</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) </span><span class="s0">is not </span><span class="s1">exp</span>
        <span class="s0">assert not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">val </span><span class="s2">== </span><span class="s4">5</span><span class="s2">:</span>
        <span class="s5"># Without CoW the original will be modified, the other case upcasts, e.g. copy</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">view</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">5</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;Int64&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;func&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">ser </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(</span><span class="s1">ser </span><span class="s2">&lt;= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_where_mask_noop</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">))</span>

    <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">10</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;Int64&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;func&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">ser </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s2">: </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(</span><span class="s1">ser </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_where_mask</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">)</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype, val&quot;</span><span class="s2">, [(</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s4">10.5</span><span class="s2">), (</span><span class="s3">&quot;Int64&quot;</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;func&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">val</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">df </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">, </span><span class="s1">val</span><span class="s2">),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s2">, </span><span class="s1">val</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(</span><span class="s1">df </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">val</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_where_mask_noop_on_single_column</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">val</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [-</span><span class="s4">4</span><span class="s2">, -</span><span class="s4">5</span><span class="s2">, -</span><span class="s4">6</span><span class="s2">]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">val</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s4">10</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;func&quot;</span><span class="s2">, [</span><span class="s3">&quot;mask&quot;</span><span class="s2">, </span><span class="s3">&quot;where&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_chained_where_mask</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">func</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">raises_chained_assignment_error</span><span class="s2">():</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">raises_chained_assignment_error</span><span class="s2">():</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[[</span><span class="s3">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;inplace method&quot;</span><span class="s2">):</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.chained_assignment&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
                <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[[</span><span class="s3">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.chained_assignment&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
                <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">1</span><span class="s2">], </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_asfreq_noop</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2000&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;min&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">asfreq</span><span class="s2">(</span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;min&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s5"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_iterrows</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">sub </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iterrows</span><span class="s2">():</span>
        <span class="s1">sub</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_interpolate_creates_copy</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># GH#51126</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">ffill</span><span class="s2">(</span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100.5</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">100.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_isetitem</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">deep</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)  </span><span class="s5"># Trigger a CoW</span>
    <span class="s1">df2</span><span class="s2">.</span><span class="s1">isetitem</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">]))  </span><span class="s5"># This is inplace</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)  </span><span class="s5"># Original is unchanged</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;float64&quot;</span><span class="s2">], </span><span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;single-block&quot;</span><span class="s2">, </span><span class="s3">&quot;mixed-block&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_isetitem_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)})</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">isetitem</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s5"># mutating dataframe doesn't update series</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>

    <span class="s5"># mutating series doesn't update dataframe</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)})</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">])</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">isetitem</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">)</span>

    <span class="s1">ser</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_isetitem_frame</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">})</span>
    <span class="s1">rhs </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">isetitem</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">rhs</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">rhs</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">rhs</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">rhs</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;key&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_get</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">, </span><span class="s1">key</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># for non-CoW it depends on whether we got a Series or DataFrame if it</span>
        <span class="s5"># is a view or copy or triggers a warning or not</span>
        <span class="s0">if </span><span class="s1">warn_copy_on_write</span><span class="s2">:</span>
            <span class="s1">warn </span><span class="s2">= </span><span class="s1">FutureWarning </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">str</span><span class="s2">) </span><span class="s0">else None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">warn </span><span class="s2">= </span><span class="s1">SettingWithCopyWarning </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">list</span><span class="s2">) </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;chained_assignment&quot;</span><span class="s2">, </span><span class="s3">&quot;warn&quot;</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warn</span><span class="s2">):</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">0</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis, key&quot;</span><span class="s2">, [(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;float64&quot;</span><span class="s2">], </span><span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;single-block&quot;</span><span class="s2">, </span><span class="s3">&quot;mixed-block&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_xs</span><span class="s2">(</span>
    <span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">, </span><span class="s1">using_array_manager</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">dtype</span>
<span class="s2">):</span>
    <span class="s1">single_block </span><span class="s2">= (</span><span class="s1">dtype </span><span class="s2">== </span><span class="s3">&quot;int64&quot;</span><span class="s2">) </span><span class="s0">and not </span><span class="s1">using_array_manager</span>
    <span class="s1">is_view </span><span class="s2">= </span><span class="s1">single_block </span><span class="s0">or </span><span class="s2">(</span><span class="s1">using_array_manager </span><span class="s0">and </span><span class="s1">axis </span><span class="s2">== </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">xs</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">axis </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">or </span><span class="s1">single_block</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">))</span>
    <span class="s0">elif </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s2">(</span><span class="s1">is_view </span><span class="s0">and not </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">elif </span><span class="s1">warn_copy_on_write</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">single_block </span><span class="s0">or </span><span class="s1">axis </span><span class="s2">== </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;chained_assignment&quot;</span><span class="s2">, </span><span class="s3">&quot;warn&quot;</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">SettingWithCopyWarning</span><span class="s2">):</span>
                <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s2">(</span><span class="s0">not </span><span class="s1">single_block </span><span class="s0">and </span><span class="s1">axis </span><span class="s2">== </span><span class="s4">0</span><span class="s2">):</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] == </span><span class="s4">0</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;key, level&quot;</span><span class="s2">, [(</span><span class="s3">&quot;l1&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_xs_multiindex</span><span class="s2">(</span>
    <span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">, </span><span class="s1">using_array_manager</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">level</span><span class="s2">, </span><span class="s1">axis</span>
<span class="s2">):</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">18</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">([[</span><span class="s3">&quot;l1&quot;</span><span class="s2">, </span><span class="s3">&quot;l2&quot;</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;lev1&quot;</span><span class="s2">, </span><span class="s3">&quot;lev2&quot;</span><span class="s2">])</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">axis </span><span class="s2">== </span><span class="s4">1</span><span class="s2">:</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">().</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">xs</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">level</span><span class="s2">=</span><span class="s1">level</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">level </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span>
            <span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
        <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">warn_copy_on_write</span><span class="s2">:</span>
        <span class="s1">warn </span><span class="s2">= </span><span class="s1">FutureWarning </span><span class="s0">if </span><span class="s1">level </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">else None</span>
    <span class="s0">elif not </span><span class="s1">using_copy_on_write </span><span class="s0">and not </span><span class="s1">using_array_manager</span><span class="s2">:</span>
        <span class="s1">warn </span><span class="s2">= </span><span class="s1">SettingWithCopyWarning</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">warn </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;chained_assignment&quot;</span><span class="s2">, </span><span class="s3">&quot;warn&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warn</span><span class="s2">):</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_update_frame</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df1 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">]})</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">100.0</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">df1_orig </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">[:]</span>

    <span class="s5"># TODO(CoW) better warning message?</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df1</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">100.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># df1 is updated, but its view not</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">df1_orig</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_update_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">ser1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">])</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">100.0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">ser1_orig </span><span class="s2">= </span><span class="s1">ser1</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">ser1</span><span class="s2">[:]</span>

    <span class="s0">if </span><span class="s1">warn_copy_on_write</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">():</span>
            <span class="s1">ser1</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">ser1</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">100.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser1</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># ser1 is updated, but its view not</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">ser1_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_update_chained_assignment</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">100.0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">raises_chained_assignment_error</span><span class="s2">():</span>
            <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">raises_chained_assignment_error</span><span class="s2">():</span>
            <span class="s1">df</span><span class="s2">[[</span><span class="s3">&quot;a&quot;</span><span class="s2">]].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">())</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;inplace method&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.chained_assignment&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">[[</span><span class="s3">&quot;a&quot;</span><span class="s2">]].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">())</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.chained_assignment&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] &gt; </span><span class="s4">1</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_inplace_arithmetic_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">)</span>
    <span class="s1">ser </span><span class="s2">*= </span><span class="s4">2</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/pull/55745</span>
        <span class="s5"># changed to NOT update inplace because there is no benefit (actual</span>
        <span class="s5"># operation already done non-inplace). This was only for the optics</span>
        <span class="s5"># of updating the backing array inplace, but we no longer want to make</span>
        <span class="s5"># that guarantee</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser_orig</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_inplace_arithmetic_series_with_reference</span><span class="s2">(</span>
    <span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span>
<span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">view </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">[:]</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">ser </span><span class="s2">*= </span><span class="s4">2</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser_orig</span><span class="s2">, </span><span class="s1">view</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">view</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;copy&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_transpose</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">, </span><span class="s1">using_array_manager</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">copy </span><span class="s0">and not </span><span class="s1">using_array_manager </span><span class="s0">or </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transpose_different_dtypes</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1.5</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">T</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transpose_ea_single_column</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">T</span>

    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_transform_frame</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">):</span>
        <span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
        <span class="s0">return </span><span class="s1">ser</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_transform_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">):</span>
        <span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
        <span class="s0">return </span><span class="s1">ser</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">ser</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_count_read_only_array</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">count</span><span class="s2">()</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">100</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_series_view</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;is deprecated&quot;</span><span class="s2">):</span>
        <span class="s1">ser2 </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">view</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser2</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">ser2</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">ser2</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser_orig</span><span class="s2">, </span><span class="s1">ser</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">100</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_insert_series</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">ser </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">column</span><span class="s2">=</span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>
        <span class="s0">assert not </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_mgr</span><span class="s2">.</span><span class="s1">_has_no_reference</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">))</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_eval</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;c = a+b&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_eval_inplace</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df_view </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:]</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;c = a+b&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shares_memory</span><span class="s2">(</span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">), </span><span class="s1">get_array</span><span class="s2">(</span><span class="s1">df_view</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df_view</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_modify_row</span><span class="s2">(</span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s5"># Case: applying a function on each row as a Series object, where the</span>
    <span class="s5"># function mutates the row object (which needs to trigger CoW if row is a view)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">transform</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">row</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">] = </span><span class="s4">100</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">] == </span><span class="s4">100</span>

    <span class="s5"># row Series is a copy</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
</pre>
</body>
</html>