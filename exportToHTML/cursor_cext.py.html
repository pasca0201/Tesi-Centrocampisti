<html>
<head>
<title>cursor_cext.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
cursor_cext.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2014, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s0"># mypy: disable-error-code=&quot;assignment,override,union-attr&quot;</span>

<span class="s2">&quot;&quot;&quot;Cursor classes using the C Extension.&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">annotations</span>

<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">warnings</span>

<span class="s3">from </span><span class="s1">collections </span><span class="s3">import </span><span class="s1">namedtuple</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">TYPE_CHECKING</span><span class="s4">,</span>
    <span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">Dict</span><span class="s4">,</span>
    <span class="s1">Generator</span><span class="s4">,</span>
    <span class="s1">Iterator</span><span class="s4">,</span>
    <span class="s1">List</span><span class="s4">,</span>
    <span class="s1">NoReturn</span><span class="s4">,</span>
    <span class="s1">Optional</span><span class="s4">,</span>
    <span class="s1">Sequence</span><span class="s4">,</span>
    <span class="s1">Tuple</span><span class="s4">,</span>
    <span class="s1">Union</span><span class="s4">,</span>
    <span class="s1">cast</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s0"># pylint: disable=import-error,no-name-in-module</span>
<span class="s3">from </span><span class="s1">_mysql_connector </span><span class="s3">import </span><span class="s1">MySQLInterfaceError</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">types </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">CextEofPacketType</span><span class="s4">,</span>
    <span class="s1">CextResultType</span><span class="s4">,</span>
    <span class="s1">DescriptionType</span><span class="s4">,</span>
    <span class="s1">ParamsSequenceOrDictType</span><span class="s4">,</span>
    <span class="s1">ParamsSequenceType</span><span class="s4">,</span>
    <span class="s1">RowItemType</span><span class="s4">,</span>
    <span class="s1">RowType</span><span class="s4">,</span>
    <span class="s1">StrOrBytes</span><span class="s4">,</span>
    <span class="s1">WarningType</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s0"># pylint: enable=import-error,no-name-in-module</span>
<span class="s0"># isort: split</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">abstracts </span><span class="s3">import </span><span class="s1">NAMED_TUPLE_CACHE</span><span class="s4">, </span><span class="s1">CMySQLPrepStmt</span><span class="s4">, </span><span class="s1">MySQLCursorAbstract</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">cursor </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">RE_PY_PARAM</span><span class="s4">,</span>
    <span class="s1">RE_SQL_COMMENT</span><span class="s4">,</span>
    <span class="s1">RE_SQL_FIND_PARAM</span><span class="s4">,</span>
    <span class="s1">RE_SQL_INSERT_STMT</span><span class="s4">,</span>
    <span class="s1">RE_SQL_INSERT_VALUES</span><span class="s4">,</span>
    <span class="s1">RE_SQL_ON_DUPLICATE</span><span class="s4">,</span>
    <span class="s1">RE_SQL_PYTHON_CAPTURE_PARAM_NAME</span><span class="s4">,</span>
    <span class="s1">RE_SQL_PYTHON_REPLACE_PARAM</span><span class="s4">,</span>
    <span class="s1">is_eol_comment</span><span class="s4">,</span>
    <span class="s1">parse_multi_statement_query</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">errorcode </span><span class="s3">import </span><span class="s1">CR_NO_RESULT_SET</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">errors </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">Error</span><span class="s4">,</span>
    <span class="s1">InterfaceError</span><span class="s4">,</span>
    <span class="s1">NotSupportedError</span><span class="s4">,</span>
    <span class="s1">ProgrammingError</span><span class="s4">,</span>
    <span class="s1">get_mysql_exception</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s3">if </span><span class="s1">TYPE_CHECKING</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">connection_cext </span><span class="s3">import </span><span class="s1">CMySQLConnection</span>

<span class="s1">ERR_NO_RESULT_TO_FETCH </span><span class="s4">= </span><span class="s5">&quot;No result set to fetch from&quot;</span>


<span class="s3">class </span><span class="s1">_ParamSubstitutor</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot; 
    Substitutes parameters into SQL statement. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">params</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">params</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s1">params</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">index</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>

    <span class="s3">def </span><span class="s1">__call__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">matchobj</span><span class="s4">: </span><span class="s1">object</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s1">index </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">index </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">params</span><span class="s4">[</span><span class="s1">index</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">IndexError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                <span class="s5">&quot;Not enough parameters for the SQL statement&quot;</span>
            <span class="s4">) </span><span class="s3">from None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">remaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns number of parameters remaining to be substituted&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">params</span><span class="s4">) - </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index</span>


<span class="s3">class </span><span class="s1">CMySQLCursor</span><span class="s4">(</span><span class="s1">MySQLCursorAbstract</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Default cursor for interacting with MySQL using C Extension&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">connection</span><span class="s4">: </span><span class="s1">CMySQLConnection</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Initialize&quot;&quot;&quot;</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">connection</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_affected_rows</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_raw_as_string</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_buffered</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">: </span><span class="s1">CMySQLConnection </span><span class="s4">= </span><span class="s1">cast</span><span class="s4">(</span><span class="s5">&quot;CMySQLConnection&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">free</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Reset the cursor 
 
        When free is True (default) the result will be freed. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_affected_rows </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_insert_id</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warnings</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">WarningType</span><span class="s4">]] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warnings </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_description</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">]] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed_list</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">StrOrBytes</span><span class="s4">] = []</span>
        <span class="s3">if </span><span class="s1">free </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">free_result</span><span class="s4">()</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">reset</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_check_executed</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Check if the statement has been executed. 
 
        Raises an error if the statement has not been executed. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s1">ERR_NO_RESULT_TO_FETCH</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_fetch_warnings</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">WarningType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Fetch warnings 
 
        Fetch warnings doing a SHOW WARNINGS. Can be called after getting 
        the result. 
 
        Returns a result set or None when there were no warnings. 
 
        Raises Error (or subclass) on errors. 
 
        Returns list of tuples or None. 
        &quot;&quot;&quot;</span>
        <span class="s1">warns </span><span class="s4">= []</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s0"># force freeing result</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">consume_results</span><span class="s4">()</span>
            <span class="s1">_ </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_query</span><span class="s4">(</span><span class="s5">&quot;SHOW WARNINGS&quot;</span><span class="s4">)</span>
            <span class="s1">warns </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_rows</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">consume_results</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">MySQLInterfaceError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">get_mysql_exception</span><span class="s4">(</span>
                <span class="s1">msg</span><span class="s4">=</span><span class="s1">err</span><span class="s4">.</span><span class="s1">msg</span><span class="s4">, </span><span class="s1">errno</span><span class="s4">=</span><span class="s1">err</span><span class="s4">.</span><span class="s1">errno</span><span class="s4">, </span><span class="s1">sqlstate</span><span class="s4">=</span><span class="s1">err</span><span class="s4">.</span><span class="s1">sqlstate</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Failed getting warnings; </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from None</span>

        <span class="s3">if </span><span class="s1">warns</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">warns  </span><span class="s0"># type: ignore[return-value]</span>

        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">_handle_warnings</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handle possible warnings after all results are consumed. 
 
        Raises: 
            Error: Also raises exceptions if raise_on_warnings is set. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_warnings </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_warnings </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fetch_warnings</span><span class="s4">()</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_warnings</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s1">err </span><span class="s4">= </span><span class="s1">get_mysql_exception</span><span class="s4">(</span>
            <span class="s4">*</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_warnings</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">1</span><span class="s4">:</span><span class="s6">3</span><span class="s4">], </span><span class="s1">warning</span><span class="s4">=</span><span class="s3">not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">raise_on_warnings</span>
        <span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">raise_on_warnings</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">err</span>

        <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">err</span><span class="s4">), </span><span class="s1">stacklevel</span><span class="s4">=</span><span class="s6">4</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_handle_result</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">result</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">CextEofPacketType</span><span class="s4">, </span><span class="s1">CextResultType</span><span class="s4">]) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handles the result after statement execution&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s5">&quot;columns&quot; </span><span class="s3">in </span><span class="s1">result</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_description </span><span class="s4">= </span><span class="s1">result</span><span class="s4">[</span><span class="s5">&quot;columns&quot;</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_resultset</span><span class="s4">()</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_last_insert_id </span><span class="s4">= </span><span class="s1">result</span><span class="s4">[</span><span class="s5">&quot;insert_id&quot;</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count </span><span class="s4">= </span><span class="s1">result</span><span class="s4">[</span><span class="s5">&quot;warning_count&quot;</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_affected_rows </span><span class="s4">= </span><span class="s1">result</span><span class="s4">[</span><span class="s5">&quot;affected_rows&quot;</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= -</span><span class="s6">1</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_warnings</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_handle_resultset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a result set&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">_handle_eof</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handle end of reading the result 
 
        Raises an Error on errors. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">warning_count</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_warnings</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">more_results</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">free_result</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_execute_iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Generator</span><span class="s4">[</span><span class="s1">CMySQLCursor</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Generator returns MySQLCursor objects for multiple statements. 
 
        This method is only used when multiple statements are executed 
        by the `cursor.execute(multi_stmt_query, multi=True)` method. 
 
        How does this method work? To properly map each statement (stmt) to a result, 
        the following facts must be considered: 
 
        1. Read operations such as `SELECT` produce a non-empty result 
            (calling `next(query_iter)` gets a result that includes at least one column). 
        2. Write operatios such as `INSERT` produce an empty result 
            (calling `next(query_iter)` gets a result with no columns - aka empty). 
        3. End-of-line (EOL) comments do not produce a result, unless is the last stmt 
            in which case produces an empty result. 
        4. Calling procedures such as `CALL my_proc` produce a sequence `(1)*0` which 
            means it may produce zero or more non-empty results followed by just one 
            empty result. In other words, a callproc stmt always terminates with an 
            empty result. E.g., `my_proc` includes an update + select + select + update, 
            then the result sequence will be `110` - note how the write ops results get 
            annulated, just the read ops results are produced. Other examples: 
                * insert + insert -&gt; 0 
                * select + select + insert + select -&gt; 1110 
                * select -&gt; 10 
            Observe how 0 indicates the end of the result sequence. This property is 
            vital to know what result corresponds to what callproc stmt. 
 
        In this regard, the implementation is composed of: 
        1. Parsing: the multi-statement is broken down into single statements, and then 
            for each of these, leading white spaces are removed (including 
            jumping line, vertical line, tab, etc.). Also, EOL comments are removed from 
            the stream, except when the comment is the last statement of the 
            multi-statement string. 
        2. Mapping: the facts described above as used as &quot;game rules&quot; to properly match 
        statements and results. In case, if we run out of statements before running out 
        of results we use a sentinel named &quot;stmt_overflow!&quot; to indicate that the mapping 
        went wrong. 
 
        Acronyms 
            1: a non-empty result 
            2: an empty result 
        &quot;&quot;&quot;</span>
        <span class="s1">executed_list </span><span class="s4">= </span><span class="s1">parse_multi_statement_query</span><span class="s4">(</span><span class="s1">multi_stmt</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">stmt </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
        <span class="s1">result</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s3">while True</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">if not </span><span class="s1">stmt</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">().</span><span class="s1">startswith</span><span class="s4">(</span><span class="s7">b&quot;CALL&quot;</span><span class="s4">) </span><span class="s3">or not </span><span class="s1">result</span><span class="s4">:</span>
                    <span class="s1">stmt </span><span class="s4">= (</span>
                        <span class="s1">executed_list</span><span class="s4">.</span><span class="s1">popleft</span><span class="s4">() </span><span class="s3">if </span><span class="s1">executed_list </span><span class="s3">else </span><span class="s7">b&quot;stmt_overflow!&quot;</span>
                    <span class="s4">)</span>

                <span class="s0"># at this point the result has been fetched already</span>
                <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">result_set_available</span>

                <span class="s3">if </span><span class="s1">is_eol_comment</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">):</span>
                    <span class="s3">continue</span>

                <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s1">stmt</span><span class="s4">.</span><span class="s1">rstrip</span><span class="s4">()</span>
                <span class="s3">yield </span><span class="s1">self</span>

                <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nextset</span><span class="s4">():</span>
                    <span class="s3">raise </span><span class="s1">StopIteration</span>
            <span class="s3">except </span><span class="s1">InterfaceError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s0"># Result without result set</span>
                <span class="s3">if </span><span class="s1">err</span><span class="s4">.</span><span class="s1">errno </span><span class="s4">!= </span><span class="s1">CR_NO_RESULT_SET</span><span class="s4">:</span>
                    <span class="s3">raise</span>
            <span class="s3">except </span><span class="s1">StopIteration</span><span class="s4">:</span>
                <span class="s3">return</span>

    <span class="s3">def </span><span class="s1">execute</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">operation</span><span class="s4">: </span><span class="s1">StrOrBytes</span><span class="s4">,</span>
        <span class="s1">params</span><span class="s4">: </span><span class="s1">ParamsSequenceOrDictType </span><span class="s4">= (),</span>
        <span class="s1">multi</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Generator</span><span class="s4">[</span><span class="s1">CMySQLCursor</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Execute given statement using given parameters 
 
        Deprecated: The multi argument is not needed and nextset() should 
        be used to handle multiple result sets. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">operation</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">is_closed</span><span class="s4">():</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ProgrammingError</span><span class="s4">, </span><span class="s1">ReferenceError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s5">&quot;Cursor is not connected&quot;</span><span class="s4">, </span><span class="s6">2055</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">handle_unread_result</span><span class="s4">()</span>

        <span class="s1">stmt </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">()</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">operation</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
                <span class="s1">stmt </span><span class="s4">= </span><span class="s1">operation</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">python_charset</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">stmt </span><span class="s4">= </span><span class="s1">operation</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">UnicodeDecodeError</span><span class="s4">, </span><span class="s1">UnicodeEncodeError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">err</span><span class="s4">)) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s3">if </span><span class="s1">params</span><span class="s4">:</span>
            <span class="s1">prepared </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">prepare_for_mysql</span><span class="s4">(</span><span class="s1">params</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">):</span>
                <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">prepared</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                    <span class="s1">stmt </span><span class="s4">= </span><span class="s1">stmt</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">f&quot;%(</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s5">)s&quot;</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(), </span><span class="s1">value</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">, (</span><span class="s1">list</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)):</span>
                <span class="s1">psub </span><span class="s4">= </span><span class="s1">_ParamSubstitutor</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">)</span>
                <span class="s1">stmt </span><span class="s4">= </span><span class="s1">RE_PY_PARAM</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span><span class="s1">psub</span><span class="s4">, </span><span class="s1">stmt</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">psub</span><span class="s4">.</span><span class="s1">remaining </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
                    <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                        <span class="s5">&quot;Not all parameters were used in the SQL statement&quot;</span>
                    <span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_query</span><span class="s4">(</span>
                <span class="s1">stmt</span><span class="s4">,</span>
                <span class="s1">raw</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_raw</span><span class="s4">,</span>
                <span class="s1">buffered</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_buffered</span><span class="s4">,</span>
                <span class="s1">raw_as_string</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_raw_as_string</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">except </span><span class="s1">MySQLInterfaceError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">get_mysql_exception</span><span class="s4">(</span>
                <span class="s1">msg</span><span class="s4">=</span><span class="s1">err</span><span class="s4">.</span><span class="s1">msg</span><span class="s4">, </span><span class="s1">errno</span><span class="s4">=</span><span class="s1">err</span><span class="s4">.</span><span class="s1">errno</span><span class="s4">, </span><span class="s1">sqlstate</span><span class="s4">=</span><span class="s1">err</span><span class="s4">.</span><span class="s1">sqlstate</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s1">stmt</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_result</span><span class="s4">(</span><span class="s1">result</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">multi</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_execute_iter</span><span class="s4">()</span>

        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">_batch_insert</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">operation</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">seq_params</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">ParamsSequenceOrDictType</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Implements multi row insert&quot;&quot;&quot;</span>

        <span class="s3">def </span><span class="s1">remove_comments</span><span class="s4">(</span><span class="s1">match</span><span class="s4">: </span><span class="s1">re</span><span class="s4">.</span><span class="s1">Match</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
            <span class="s2">&quot;&quot;&quot;Remove comments from INSERT statements. 
 
            This function is used while removing comments from INSERT 
            statements. If the matched string is a comment not enclosed 
            by quotes, it returns an empty string, else the string itself. 
            &quot;&quot;&quot;</span>
            <span class="s3">if </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">1</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s5">&quot;&quot;</span>
            <span class="s3">return </span><span class="s1">match</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">2</span><span class="s4">)</span>

        <span class="s1">tmp </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span>
            <span class="s1">RE_SQL_ON_DUPLICATE</span><span class="s4">,</span>
            <span class="s5">&quot;&quot;</span><span class="s4">,</span>
            <span class="s1">re</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span><span class="s1">RE_SQL_COMMENT</span><span class="s4">, </span><span class="s1">remove_comments</span><span class="s4">, </span><span class="s1">operation</span><span class="s4">),</span>
        <span class="s4">)</span>

        <span class="s1">matches </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">search</span><span class="s4">(</span><span class="s1">RE_SQL_INSERT_VALUES</span><span class="s4">, </span><span class="s1">tmp</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">matches</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">&quot;Failed rewriting statement for multi-row INSERT. Check SQL syntax&quot;</span>
            <span class="s4">)</span>
        <span class="s1">fmt </span><span class="s4">= </span><span class="s1">matches</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s6">1</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">python_charset</span><span class="s4">)</span>
        <span class="s1">values </span><span class="s4">= []</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">stmt </span><span class="s4">= </span><span class="s1">operation</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">python_charset</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">params </span><span class="s3">in </span><span class="s1">seq_params</span><span class="s4">:</span>
                <span class="s1">tmp </span><span class="s4">= </span><span class="s1">fmt</span>
                <span class="s1">prepared </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">prepare_for_mysql</span><span class="s4">(</span><span class="s1">params</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">):</span>
                    <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">prepared</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                        <span class="s1">tmp </span><span class="s4">= </span><span class="s1">tmp</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span>
                            <span class="s5">f&quot;%(</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s5">)s&quot;</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(), </span><span class="s1">value  </span><span class="s0"># type: ignore[arg-type]</span>
                        <span class="s4">)</span>
                <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">, (</span><span class="s1">list</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)):</span>
                    <span class="s1">psub </span><span class="s4">= </span><span class="s1">_ParamSubstitutor</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">)</span>
                    <span class="s1">tmp </span><span class="s4">= </span><span class="s1">RE_PY_PARAM</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span><span class="s1">psub</span><span class="s4">, </span><span class="s1">tmp</span><span class="s4">)  </span><span class="s0"># type: ignore[call-overload]</span>
                    <span class="s3">if </span><span class="s1">psub</span><span class="s4">.</span><span class="s1">remaining </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
                        <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                            <span class="s5">&quot;Not all parameters were used in the SQL statement&quot;</span>
                        <span class="s4">)</span>
                <span class="s1">values</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">tmp</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s1">fmt </span><span class="s3">in </span><span class="s1">stmt</span><span class="s4">:</span>
                <span class="s1">stmt </span><span class="s4">= </span><span class="s1">stmt</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s1">fmt</span><span class="s4">, </span><span class="s7">b&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">values</span><span class="s4">), </span><span class="s6">1</span><span class="s4">)  </span><span class="s0"># type: ignore[arg-type]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s1">stmt</span>
                <span class="s3">return </span><span class="s1">stmt</span>
            <span class="s3">return None</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">UnicodeDecodeError</span><span class="s4">, </span><span class="s1">UnicodeEncodeError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">err</span><span class="s4">)) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Failed executing the operation; </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from None</span>

    <span class="s3">def </span><span class="s1">executemany</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">operation</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">seq_params</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">ParamsSequenceOrDictType</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Generator</span><span class="s4">[</span><span class="s1">CMySQLCursor</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Execute the given operation multiple times 
 
        The executemany() method will execute the operation iterating 
        over the list of parameters in seq_params. 
 
        Example: Inserting 3 new employees and their phone number 
 
        data = [ 
            ('Jane','555-001'), 
            ('Joe', '555-001'), 
            ('John', '555-003') 
            ] 
        stmt = &quot;INSERT INTO employees (name, phone) VALUES ('%s','%s)&quot; 
        cursor.executemany(stmt, data) 
 
        INSERT statements are optimized by batching the data, that is 
        using the MySQL multiple rows syntax. 
 
        Results are discarded! If they are needed, consider looping over 
        data using the execute() method. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">operation </span><span class="s3">or not </span><span class="s1">seq_params</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ProgrammingError</span><span class="s4">, </span><span class="s1">ReferenceError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s5">&quot;Cursor is not connected&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">handle_unread_result</span><span class="s4">()</span>

        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">seq_params</span><span class="s4">, (</span><span class="s1">list</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)):</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s5">&quot;Parameters for query must be list or tuple.&quot;</span><span class="s4">)</span>

        <span class="s0"># Optimize INSERTs by batching them</span>
        <span class="s3">if </span><span class="s1">re</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">RE_SQL_INSERT_STMT</span><span class="s4">, </span><span class="s1">operation</span><span class="s4">):</span>
            <span class="s3">if not </span><span class="s1">seq_params</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= </span><span class="s6">0</span>
                <span class="s3">return None</span>
            <span class="s1">stmt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_batch_insert</span><span class="s4">(</span><span class="s1">operation</span><span class="s4">, </span><span class="s1">seq_params</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">stmt </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s1">stmt</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">stmt</span><span class="s4">)</span>

        <span class="s1">rowcnt </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s0"># When processing read ops (e.g., SELECT), rowcnt is updated</span>
            <span class="s0"># based on self._rowcount. For write ops (e.g., INSERT) is</span>
            <span class="s0"># updated based on self._affected_rows.</span>
            <span class="s0"># The variable self._description is None for write ops, that's</span>
            <span class="s0"># why we use it as indicator for updating rowcnt.</span>
            <span class="s3">for </span><span class="s1">params </span><span class="s3">in </span><span class="s1">seq_params</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">operation</span><span class="s4">, </span><span class="s1">params</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_rows </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">unread_result</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">()</span>
                <span class="s1">rowcnt </span><span class="s4">+= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">description </span><span class="s3">else </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_affected_rows</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Failed executing the operation; </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from None</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= </span><span class="s1">rowcnt</span>
        <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">description</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Returns description of columns in a result&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_description</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">rowcount</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns the number of rows produced or affected&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">== -</span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_affected_rows</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount</span>

    <span class="s3">def </span><span class="s1">close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Close the cursor 
 
        The result will be freed. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">:</span>
            <span class="s3">return False</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">handle_unread_result</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warnings </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">callproc</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">procname</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
        <span class="s1">args</span><span class="s4">: </span><span class="s1">Sequence </span><span class="s4">= (),</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">RowItemType</span><span class="s4">], </span><span class="s1">RowType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Calls a stored procedure with the given arguments&quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">procname </span><span class="s3">or not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">procname</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;procname must be a string&quot;</span><span class="s4">)</span>

        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">args</span><span class="s4">, (</span><span class="s1">tuple</span><span class="s4">, </span><span class="s1">list</span><span class="s4">)):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;args must be a sequence&quot;</span><span class="s4">)</span>

        <span class="s1">argfmt </span><span class="s4">= </span><span class="s5">&quot;@_{name}_arg{index}&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_stored_results </span><span class="s4">= []</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">argnames </span><span class="s4">= []</span>
            <span class="s1">argtypes </span><span class="s4">= []</span>

            <span class="s0"># MySQL itself does support calling procedures with their full</span>
            <span class="s0"># name &lt;database&gt;.&lt;procedure_name&gt;. It's necessary to split</span>
            <span class="s0"># by '.' and grab the procedure name from procname.</span>
            <span class="s1">procname_abs </span><span class="s4">= </span><span class="s1">procname</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;.&quot;</span><span class="s4">)[-</span><span class="s6">1</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">args</span><span class="s4">:</span>
                <span class="s1">argvalues </span><span class="s4">= []</span>
                <span class="s3">for </span><span class="s1">idx</span><span class="s4">, </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">args</span><span class="s4">):</span>
                    <span class="s1">argname </span><span class="s4">= </span><span class="s1">argfmt</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s1">procname_abs</span><span class="s4">, </span><span class="s1">index</span><span class="s4">=</span><span class="s1">idx </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">)</span>
                    <span class="s1">argnames</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">argname</span><span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                        <span class="s1">argtypes</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s5">f&quot; CAST(</span><span class="s3">{</span><span class="s1">argname</span><span class="s3">} </span><span class="s5">AS </span><span class="s3">{</span><span class="s1">arg</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span><span class="s3">}</span><span class="s5">)&quot;</span><span class="s4">)</span>
                        <span class="s1">argvalues</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">argtypes</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">argname</span><span class="s4">)</span>
                        <span class="s1">argvalues</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">arg</span><span class="s4">)</span>

                <span class="s1">placeholders </span><span class="s4">= </span><span class="s5">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">arg</span><span class="s3">}</span><span class="s5">=%s&quot; </span><span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">argnames</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s5">f&quot;SET </span><span class="s3">{</span><span class="s1">placeholders</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s1">argvalues</span><span class="s4">)</span>

            <span class="s1">call </span><span class="s4">= </span><span class="s5">f&quot;CALL </span><span class="s3">{</span><span class="s1">procname</span><span class="s3">}</span><span class="s5">(</span><span class="s3">{</span><span class="s5">','</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">argnames</span><span class="s4">)</span><span class="s3">}</span><span class="s5">)&quot;</span>

            <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_query</span><span class="s4">(</span>
                <span class="s1">call</span><span class="s4">, </span><span class="s1">raw</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_raw</span><span class="s4">, </span><span class="s1">raw_as_string</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_raw_as_string</span>
            <span class="s4">)</span>

            <span class="s1">results </span><span class="s4">= []</span>
            <span class="s3">while </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">result_set_available</span><span class="s4">:</span>
                <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">fetch_eof_columns</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, (</span><span class="s1">CMySQLCursorDict</span><span class="s4">, </span><span class="s1">CMySQLCursorBufferedDict</span><span class="s4">)):</span>
                    <span class="s1">cursor_class </span><span class="s4">= </span><span class="s1">CMySQLCursorBufferedDict</span>
                <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">,</span>
                    <span class="s4">(</span><span class="s1">CMySQLCursorNamedTuple</span><span class="s4">, </span><span class="s1">CMySQLCursorBufferedNamedTuple</span><span class="s4">),</span>
                <span class="s4">):</span>
                    <span class="s1">cursor_class </span><span class="s4">= </span><span class="s1">CMySQLCursorBufferedNamedTuple</span>
                <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_raw</span><span class="s4">:</span>
                    <span class="s1">cursor_class </span><span class="s4">= </span><span class="s1">CMySQLCursorBufferedRaw</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">cursor_class </span><span class="s4">= </span><span class="s1">CMySQLCursorBuffered</span>
                <span class="s0"># pylint: disable=protected-access</span>
                <span class="s1">cur </span><span class="s4">= </span><span class="s1">cursor_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_self</span><span class="s4">())  </span><span class="s0"># type: ignore[arg-type]</span>
                <span class="s1">cur</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s5">f&quot;(a result of </span><span class="s3">{</span><span class="s1">call</span><span class="s3">}</span><span class="s5">)&quot;</span>
                <span class="s1">cur</span><span class="s4">.</span><span class="s1">_handle_result</span><span class="s4">(</span><span class="s1">result</span><span class="s4">)</span>
                <span class="s0"># pylint: enable=protected-access</span>
                <span class="s1">results</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">next_result</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_stored_results </span><span class="s4">= </span><span class="s1">results</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>

            <span class="s3">if </span><span class="s1">argnames</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">()</span>
                <span class="s0"># Create names aliases to be compatible with namedtuples</span>
                <span class="s1">args </span><span class="s4">= [</span>
                    <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">name</span><span class="s3">} </span><span class="s5">AS </span><span class="s3">{</span><span class="s1">alias</span><span class="s3">}</span><span class="s5">&quot;</span>
                    <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">alias </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span>
                        <span class="s1">argtypes</span><span class="s4">, [</span><span class="s1">arg</span><span class="s4">.</span><span class="s1">lstrip</span><span class="s4">(</span><span class="s5">&quot;@_&quot;</span><span class="s4">) </span><span class="s3">for </span><span class="s1">arg </span><span class="s3">in </span><span class="s1">argnames</span><span class="s4">]</span>
                    <span class="s4">)</span>
                <span class="s4">]</span>
                <span class="s1">select </span><span class="s4">= </span><span class="s5">f&quot;SELECT </span><span class="s3">{</span><span class="s5">','</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">args</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">select</span><span class="s4">)</span>

                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">fetchone</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s1">tuple</span><span class="s4">()</span>

        <span class="s3">except </span><span class="s1">Error</span><span class="s4">:</span>
            <span class="s3">raise</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Failed calling stored routine; </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from None</span>

    <span class="s3">def </span><span class="s1">nextset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Skip to the next available result set&quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">next_result</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">(</span><span class="s1">free</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s3">return None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">(</span><span class="s1">free</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">result_set_available</span><span class="s4">:</span>
            <span class="s1">eof </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">fetch_eof_status</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_result</span><span class="s4">(</span><span class="s1">eof</span><span class="s4">)</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s1">errno</span><span class="s4">=</span><span class="s1">CR_NO_RESULT_SET</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_result</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">fetch_eof_columns</span><span class="s4">())</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of tuples with all rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">unread_result</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s1">rows </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_rows</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
            <span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">insert</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>

        <span class="s3">if not </span><span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">+= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
        <span class="s0"># self._connection.handle_unread_result()</span>
        <span class="s3">return </span><span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">1</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the next set of rows of a query result set. 
 
        When no more rows are available, it returns an empty list. 
        The number of rows returned can be specified using the size argument, 
        which defaults to one. 
 
        Returns: 
            list: The next set of rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
            <span class="s1">rows </span><span class="s4">= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]]</span>
            <span class="s1">size </span><span class="s4">-= </span><span class="s6">1</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">rows </span><span class="s4">= []</span>

        <span class="s3">if </span><span class="s1">size </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">unread_result</span><span class="s4">:</span>
            <span class="s1">rows</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_rows</span><span class="s4">(</span><span class="s1">size</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">])</span>

        <span class="s3">if </span><span class="s1">size</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">unread_result</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_row</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span>
                    <span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
                    <span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">more_results</span>
                <span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">free_result</span><span class="s4">()</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">= (</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

        <span class="s3">if not </span><span class="s1">rows</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">+= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rows</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">rows</span>

    <span class="s3">def </span><span class="s1">fetchone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return next row of a query result set. 
 
        Returns: 
            tuple or None: A row from query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span>
        <span class="s3">if not </span><span class="s1">row </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">unread_result</span><span class="s4">:</span>
            <span class="s1">row </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_row</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s1">row </span><span class="s3">and </span><span class="s1">row</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_row</span><span class="s4">()</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">more_results</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">free_result</span><span class="s4">()</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
            <span class="s3">return None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">row</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Iteration over the result set 
 
        Iteration over the result set which calls self.fetchone() 
        and returns the next row. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">fetchone</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">stored_results</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Generator</span><span class="s4">[</span><span class="s1">CMySQLCursor</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Returns an iterator for stored results 
 
        This method returns an iterator over results which are stored when 
        callproc() is called. The iterator will provide MySQLCursorBuffered 
        instances. 
 
        Returns a iterator. 
        &quot;&quot;&quot;</span>
        <span class="s0"># pylint: disable=use-yield-from</span>
        <span class="s3">for </span><span class="s1">result </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stored_results</span><span class="s4">:</span>
            <span class="s3">yield </span><span class="s1">result  </span><span class="s0"># type: ignore[misc]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_stored_results </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">__next__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; RowType</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Iteration over the result set 
        Used for iterating over the result set. Calls self.fetchone() 
        to get the next row. 
 
        Raises StopIteration when no more rows are available. 
        &quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">row </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">fetchone</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">InterfaceError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">StopIteration </span><span class="s3">from None</span>
        <span class="s3">if not </span><span class="s1">row</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">StopIteration </span><span class="s3">from None</span>
        <span class="s3">return </span><span class="s1">row</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">column_names</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, ...]:</span>
        <span class="s2">&quot;&quot;&quot;Returns column names 
 
        This property returns the columns names as a tuple. 
 
        Returns a tuple. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">description</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">d</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">description</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">statement</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns the executed statement 
 
        This property returns the executed statement. When multiple 
        statements were executed, the current statement in the iterator 
        will be returned. 
        &quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf8&quot;</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()  </span><span class="s0"># type: ignore[return-value]</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">with_rows</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns whether the cursor could have rows returned 
 
        This property returns True when column descriptions are available 
        and possibly also rows, which will need to be fetched. 
 
        Returns True or False. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">description</span><span class="s4">:</span>
            <span class="s3">return True</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">__str__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;{class_name}: {stmt}&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">executed </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
                <span class="s1">executed </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">executed</span><span class="s4">) &gt; </span><span class="s6">40</span><span class="s4">:</span>
                <span class="s1">executed </span><span class="s4">= </span><span class="s1">executed</span><span class="s4">[:</span><span class="s6">40</span><span class="s4">] + </span><span class="s5">&quot;..&quot;</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">executed </span><span class="s4">= </span><span class="s5">&quot;(Nothing executed yet)&quot;</span>

        <span class="s3">return </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">class_name</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">, </span><span class="s1">stmt</span><span class="s4">=</span><span class="s1">executed</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">CMySQLCursorBuffered</span><span class="s4">(</span><span class="s1">CMySQLCursor</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension buffering results&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">connection</span><span class="s4">: </span><span class="s1">CMySQLConnection</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Initialize&quot;&quot;&quot;</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">connection</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rows</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>

    <span class="s3">def </span><span class="s1">_handle_resultset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a result set&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rows </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_rows</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rows</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">free</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Reset the cursor to default&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rows </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">reset</span><span class="s4">(</span><span class="s1">free</span><span class="s4">=</span><span class="s1">free</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_fetch_row</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Returns the next row in the result set 
 
        Returns a tuple or None. 
        &quot;&quot;&quot;</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">row </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rows</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">IndexError</span><span class="s4">:</span>
            <span class="s3">return None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">row</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of tuples with all rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rows</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row </span><span class="s4">:]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rows</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">res</span>

    <span class="s3">def </span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">1</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the next set of rows of a query result set. 
 
        When no more rows are available, it returns an empty list. 
        The number of rows returned can be specified using the size argument, 
        which defaults to one. 
 
        Returns: 
            list: The next set of rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s1">res </span><span class="s4">= []</span>
        <span class="s1">cnt </span><span class="s4">= </span><span class="s1">size </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">arraysize</span>
        <span class="s3">while </span><span class="s1">cnt </span><span class="s4">&gt; </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">cnt </span><span class="s4">-= </span><span class="s6">1</span>
            <span class="s1">row </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fetch_row</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">row</span><span class="s4">:</span>
                <span class="s1">res</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">row</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">break</span>
        <span class="s3">return </span><span class="s1">res</span>

    <span class="s3">def </span><span class="s1">fetchone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return next row of a query result set. 
 
        Returns: 
            tuple or None: A row from query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fetch_row</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">with_rows</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns whether the cursor could have rows returned 
 
        This property returns True when rows are available, 
        which will need to be fetched. 
 
        Returns True or False. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rows </span><span class="s3">is not None</span>


<span class="s3">class </span><span class="s1">CMySQLCursorRaw</span><span class="s4">(</span><span class="s1">CMySQLCursor</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension return raw results&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">connection</span><span class="s4">: </span><span class="s1">CMySQLConnection</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">connection</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_raw </span><span class="s4">= </span><span class="s3">True</span>


<span class="s3">class </span><span class="s1">CMySQLCursorBufferedRaw</span><span class="s4">(</span><span class="s1">CMySQLCursorBuffered</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension buffering raw results&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">connection</span><span class="s4">: </span><span class="s1">CMySQLConnection</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">connection</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_raw </span><span class="s4">= </span><span class="s3">True</span>


<span class="s3">class </span><span class="s1">CMySQLCursorDict</span><span class="s4">(</span><span class="s1">CMySQLCursor</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension returning rows as dictionaries&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">fetchone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">RowItemType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return next row of a query result set. 
 
        Returns: 
            dict or None: A dict from query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchone</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">, </span><span class="s1">row</span><span class="s4">)) </span><span class="s3">if </span><span class="s1">row </span><span class="s3">else None</span>

    <span class="s3">def </span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">1</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">RowItemType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return the next set of rows of a query result set. 
 
        When no more rows are available, it returns an empty list. 
        The number of rows returned can be specified using the size argument, 
        which defaults to one. 
 
        Returns: 
            list: The next set of rows of a query result set represented 
                  as a list of dictionaries where column names are used as keys. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">size</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">, </span><span class="s1">row</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">res</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">RowItemType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of dictionaries with all rows of a query 
                  result set where column names are used as keys. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchall</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">, </span><span class="s1">row</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">res</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">CMySQLCursorBufferedDict</span><span class="s4">(</span><span class="s1">CMySQLCursorBuffered</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension buffering and returning rows as dictionaries&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">_fetch_row</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">RowItemType</span><span class="s4">]]:</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">_fetch_row</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">row</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">, </span><span class="s1">row</span><span class="s4">))</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">RowItemType</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of tuples with all rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchall</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">, </span><span class="s1">row</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">res</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">CMySQLCursorNamedTuple</span><span class="s4">(</span><span class="s1">CMySQLCursor</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension returning rows as named tuples&quot;&quot;&quot;</span>

    <span class="s1">named_tuple</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">_handle_resultset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a result set&quot;&quot;&quot;</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">_handle_resultset</span><span class="s4">()</span>
        <span class="s1">columns </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple </span><span class="s4">= </span><span class="s1">NAMED_TUPLE_CACHE</span><span class="s4">[</span><span class="s1">columns</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple </span><span class="s4">= </span><span class="s1">namedtuple</span><span class="s4">(</span><span class="s5">&quot;Row&quot;</span><span class="s4">, </span><span class="s1">columns</span><span class="s4">)  </span><span class="s0"># type: ignore[misc]</span>
            <span class="s1">NAMED_TUPLE_CACHE</span><span class="s4">[</span><span class="s1">columns</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple</span>

    <span class="s3">def </span><span class="s1">fetchone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return next row of a query result set. 
 
        Returns: 
            tuple or None: A row from query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchone</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">row</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple</span><span class="s4">(*</span><span class="s1">row</span><span class="s4">)</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">1</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the next set of rows of a query result set. 
 
        When no more rows are available, it returns an empty list. 
        The number of rows returned can be specified using the size argument, 
        which defaults to one. 
 
        Returns: 
            list: The next set of rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">size</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">res</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">[]</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple</span><span class="s4">(*</span><span class="s1">row</span><span class="s4">) </span><span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">res</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of tuples with all rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchall</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple</span><span class="s4">(*</span><span class="s1">row</span><span class="s4">) </span><span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">res</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">CMySQLCursorBufferedNamedTuple</span><span class="s4">(</span><span class="s1">CMySQLCursorBuffered</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using C Extension buffering and returning rows as named tuples&quot;&quot;&quot;</span>

    <span class="s1">named_tuple</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">_handle_resultset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">_handle_resultset</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple </span><span class="s4">= </span><span class="s1">namedtuple</span><span class="s4">(</span><span class="s5">&quot;Row&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">column_names</span><span class="s4">)  </span><span class="s0"># type: ignore[misc]</span>

    <span class="s3">def </span><span class="s1">_fetch_row</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">_fetch_row</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">row</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple</span><span class="s4">(*</span><span class="s1">row</span><span class="s4">)</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of tuples with all rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">fetchall</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">named_tuple</span><span class="s4">(*</span><span class="s1">row</span><span class="s4">) </span><span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">res</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">CMySQLCursorPrepared</span><span class="s4">(</span><span class="s1">CMySQLCursor</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Cursor using MySQL Prepared Statements&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">connection</span><span class="s4">: </span><span class="s1">CMySQLConnection</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">connection</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rows</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_next_row</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_binary</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">CMySQLPrepStmt</span><span class="s4">] = </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">_handle_eof</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handle EOF packet&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">= (</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_warnings</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_fetch_row</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">raw</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Returns the next row in the result set 
 
        Returns a tuple or None. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt </span><span class="s3">or not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">.</span><span class="s1">have_result_set</span><span class="s4">:</span>
            <span class="s3">return None</span>
        <span class="s1">row </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">== (</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">):</span>
            <span class="s4">(</span><span class="s1">row</span><span class="s4">, </span><span class="s1">eof</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_row</span><span class="s4">(</span>
                <span class="s1">binary</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_binary</span><span class="s4">,</span>
                <span class="s1">columns</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                <span class="s1">raw</span><span class="s4">=</span><span class="s1">raw</span><span class="s4">,</span>
                <span class="s1">prep_stmt</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">row</span><span class="s4">, </span><span class="s1">eof</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span>

        <span class="s3">if </span><span class="s1">row</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_row</span><span class="s4">(</span>
                <span class="s1">binary</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_binary</span><span class="s4">,</span>
                <span class="s1">columns</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">description</span><span class="s4">,</span>
                <span class="s1">raw</span><span class="s4">=</span><span class="s1">raw</span><span class="s4">,</span>
                <span class="s1">prep_stmt</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s1">eof </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">eof </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count </span><span class="s4">= </span><span class="s1">eof</span><span class="s4">[</span><span class="s5">&quot;warning_count&quot;</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">== -</span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= </span><span class="s6">1</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">if </span><span class="s1">eof</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_warning_count </span><span class="s4">= </span><span class="s1">eof</span><span class="s4">[</span><span class="s5">&quot;warning_count&quot;</span><span class="s4">]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>

        <span class="s3">return </span><span class="s1">row</span>

    <span class="s3">def </span><span class="s1">callproc</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">procname</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">args</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; NoReturn</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Calls a stored procedue 
 
        Not supported with CMySQLCursorPrepared. 
        &quot;&quot;&quot;</span>
        <span class="s3">raise </span><span class="s1">NotSupportedError</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Close the cursor 
 
        This method will try to deallocate the prepared statement and close 
        the cursor. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_stmt_close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">close</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">free</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Resets the prepared statement.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_stmt_reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">)</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">reset</span><span class="s4">(</span><span class="s1">free</span><span class="s4">=</span><span class="s1">free</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">execute</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">operation</span><span class="s4">: </span><span class="s1">StrOrBytes</span><span class="s4">,</span>
        <span class="s1">params</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ParamsSequenceOrDictType</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">multi</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:  </span><span class="s0"># multi is unused</span>
        <span class="s2">&quot;&quot;&quot;Prepare and execute a MySQL Prepared Statement 
 
        This method will prepare the given operation and execute it using 
        the given parameters. 
 
        If the cursor instance already had a prepared statement, it is 
        first closed. 
 
        Note: argument &quot;multi&quot; is unused. 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">operation</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">is_closed</span><span class="s4">():</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ProgrammingError</span><span class="s4">, </span><span class="s1">ReferenceError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s5">&quot;Cursor is not connected&quot;</span><span class="s4">, </span><span class="s6">2055</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">handle_unread_result</span><span class="s4">(</span><span class="s1">prepared</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

        <span class="s1">charset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">charset</span>
        <span class="s3">if </span><span class="s1">charset </span><span class="s4">== </span><span class="s5">&quot;utf8mb4&quot;</span><span class="s4">:</span>
            <span class="s1">charset </span><span class="s4">= </span><span class="s5">&quot;utf8&quot;</span>

        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">operation</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">operation </span><span class="s4">= </span><span class="s1">operation</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">charset</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">UnicodeDecodeError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">err</span><span class="s4">)) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">params</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">):</span>
            <span class="s1">replacement_keys </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">findall</span><span class="s4">(</span><span class="s1">RE_SQL_PYTHON_CAPTURE_PARAM_NAME</span><span class="s4">, </span><span class="s1">operation</span><span class="s4">)</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s0"># Replace params dict with params tuple in correct order.</span>
                <span class="s1">params </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">params</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] </span><span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">replacement_keys</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">KeyError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                    <span class="s5">&quot;Not all placeholders were found in the parameters dict&quot;</span>
                <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
            <span class="s0"># Convert %(name)s to ? before sending it to MySQL</span>
            <span class="s1">operation </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span><span class="s1">RE_SQL_PYTHON_REPLACE_PARAM</span><span class="s4">, </span><span class="s5">&quot;?&quot;</span><span class="s4">, </span><span class="s1">operation</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">operation </span><span class="s3">is not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_executed</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_stmt_close</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s1">operation</span>

            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">operation </span><span class="s4">= </span><span class="s1">operation</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s1">charset</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">UnicodeEncodeError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">err</span><span class="s4">)) </span><span class="s3">from </span><span class="s1">err</span>

            <span class="s3">if </span><span class="s7">b&quot;%s&quot; </span><span class="s3">in </span><span class="s1">operation</span><span class="s4">:</span>
                <span class="s0"># Convert %s to ? before sending it to MySQL</span>
                <span class="s1">operation </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">(</span><span class="s1">RE_SQL_FIND_PARAM</span><span class="s4">, </span><span class="s7">b&quot;?&quot;</span><span class="s4">, </span><span class="s1">operation</span><span class="s4">)</span>

            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_stmt_prepare</span><span class="s4">(</span><span class="s1">operation</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">Error</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_executed </span><span class="s4">= </span><span class="s3">None</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt </span><span class="s4">= </span><span class="s3">None</span>
                <span class="s3">raise</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_stmt_reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">.</span><span class="s1">param_count </span><span class="s4">&gt; </span><span class="s6">0 </span><span class="s3">and not </span><span class="s1">params</span><span class="s4">:</span>
            <span class="s3">return</span>
        <span class="s3">if </span><span class="s1">params</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">params</span><span class="s4">, (</span><span class="s1">tuple</span><span class="s4">, </span><span class="s1">list</span><span class="s4">)):</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                    <span class="s1">errno</span><span class="s4">=</span><span class="s6">1210</span><span class="s4">,</span>
                    <span class="s1">msg</span><span class="s4">=</span><span class="s5">f&quot;Incorrect type of argument: </span><span class="s3">{</span><span class="s1">type</span><span class="s4">(</span><span class="s1">params</span><span class="s4">).</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">(</span><span class="s3">{</span><span class="s1">params</span><span class="s3">}</span><span class="s5">)&quot;</span>
                    <span class="s5">&quot;, it must be of type tuple or list the argument given to &quot;</span>
                    <span class="s5">&quot;the prepared statement&quot;</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">.</span><span class="s1">param_count </span><span class="s4">!= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">params</span><span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                    <span class="s1">errno</span><span class="s4">=</span><span class="s6">1210</span><span class="s4">,</span>
                    <span class="s1">msg</span><span class="s4">=</span><span class="s5">&quot;Incorrect number of arguments executing prepared statement&quot;</span><span class="s4">,</span>
                <span class="s4">)</span>

        <span class="s3">if </span><span class="s1">params </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">params </span><span class="s4">= ()</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">cmd_stmt_execute</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">, *</span><span class="s1">params</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">res</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_result</span><span class="s4">(</span><span class="s1">res</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">executemany</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">operation</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">seq_params</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">ParamsSequenceType</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Prepare and execute a MySQL Prepared Statement many times 
 
        This method will prepare the given operation and execute with each 
        tuple found the list seq_params. 
 
        If the cursor instance already had a prepared statement, it is 
        first closed. 
        &quot;&quot;&quot;</span>
        <span class="s1">rowcnt </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">params </span><span class="s3">in </span><span class="s1">seq_params</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">execute</span><span class="s4">(</span><span class="s1">operation</span><span class="s4">, </span><span class="s1">params</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">with_rows</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">fetchall</span><span class="s4">()</span>
                <span class="s1">rowcnt </span><span class="s4">+= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Failed executing the operation; </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">= </span><span class="s1">rowcnt</span>

    <span class="s3">def </span><span class="s1">fetchone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return next row of a query result set. 
 
        Returns: 
            tuple or None: A row from query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fetch_row</span><span class="s4">() </span><span class="s3">or None</span>

    <span class="s3">def </span><span class="s1">fetchmany</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">size</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the next set of rows of a query result set. 
 
        When no more rows are available, it returns an empty list. 
        The number of rows returned can be specified using the size argument, 
        which defaults to one. 
 
        Returns: 
            list: The next set of rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s1">res </span><span class="s4">= []</span>
        <span class="s1">cnt </span><span class="s4">= </span><span class="s1">size </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">arraysize</span>
        <span class="s3">while </span><span class="s1">cnt </span><span class="s4">&gt; </span><span class="s6">0 </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">.</span><span class="s1">have_result_set</span><span class="s4">:</span>
            <span class="s1">cnt </span><span class="s4">-= </span><span class="s6">1</span>
            <span class="s1">row </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_fetch_row</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">row</span><span class="s4">:</span>
                <span class="s1">res</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">row</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">res</span>

    <span class="s3">def </span><span class="s1">fetchall</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">RowType</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return all rows of a query result set. 
 
        Returns: 
            list: A list of tuples with all rows of a query result set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_check_executed</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">.</span><span class="s1">have_result_set</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s1">rows </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_connection</span><span class="s4">.</span><span class="s1">get_rows</span><span class="s4">(</span><span class="s1">prep_stmt</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_stmt</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
            <span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">insert</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nextrow</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>

        <span class="s3">if not </span><span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">_rowcount </span><span class="s4">+= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">])</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_handle_eof</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">rows</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">CMySQLCursorPreparedDict</span><span class="s4">(</span><span class="s1">CMySQLCursorDict</span><span class="s4">, </span><span class="s1">CMySQLCursorPrepared</span><span class="s4">):  </span><span class="s0"># type: ignore[misc]</span>
    <span class="s2">&quot;&quot;&quot;This class is a blend of features from CMySQLCursorDict and CMySQLCursorPrepared 
 
    Multiple inheritance in python is allowed but care must be taken 
    when assuming methods resolution. In the case of multiple 
    inheritance, a given attribute is first searched in the current 
    class if it's not found then it's searched in the parent classes. 
    The parent classes are searched in a left-right fashion and each 
    class is searched once. 
    Based on python's attribute resolution, in this case, attributes 
    are searched as follows: 
    1. CMySQLCursorPreparedDict (current class) 
    2. CMySQLCursorDict (left parent class) 
    3. CMySQLCursorPrepared (right parent class) 
    4. CMySQLCursor (base class) 
    &quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">CMySQLCursorPreparedNamedTuple</span><span class="s4">(</span><span class="s1">CMySQLCursorNamedTuple</span><span class="s4">, </span><span class="s1">CMySQLCursorPrepared</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;This class is a blend of features from CMySQLCursorNamedTuple and CMySQLCursorPrepared&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">CMySQLCursorPreparedRaw</span><span class="s4">(</span><span class="s1">CMySQLCursorPrepared</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;This class is a blend of features from CMySQLCursorRaw and CMySQLCursorPrepared&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">connection</span><span class="s4">: </span><span class="s1">CMySQLConnection</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">connection</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_raw </span><span class="s4">= </span><span class="s3">True</span>
</pre>
</body>
</html>