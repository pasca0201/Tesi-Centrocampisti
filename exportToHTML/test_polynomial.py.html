<html>
<head>
<title>test_polynomial.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_polynomial.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sys</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_array_equal</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate </span><span class="s0">import </span><span class="s1">BSpline</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse </span><span class="s0">import </span><span class="s1">random </span><span class="s0">as </span><span class="s1">sparse_random</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">linear_model </span><span class="s0">import </span><span class="s1">LinearRegression</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">pipeline </span><span class="s0">import </span><span class="s1">Pipeline</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">KBinsDiscretizer</span><span class="s2">,</span>
    <span class="s1">PolynomialFeatures</span><span class="s2">,</span>
    <span class="s1">SplineTransformer</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing</span><span class="s2">.</span><span class="s1">_csr_polynomial_expansion </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_calc_expanded_nnz</span><span class="s2">,</span>
    <span class="s1">_calc_total_nnz</span><span class="s2">,</span>
    <span class="s1">_get_sizeof_LARGEST_INT_t</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s1">assert_array_almost_equal</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s2">,</span>
    <span class="s1">parse_version</span><span class="s2">,</span>
    <span class="s1">sp_version</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;est&quot;</span><span class="s2">, (</span><span class="s1">PolynomialFeatures</span><span class="s2">, </span><span class="s1">SplineTransformer</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_polynomial_and_spline_array_order</span><span class="s2">(</span><span class="s1">est</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that output array has the given order.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">is_c_contiguous</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfortran</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">is_c_contiguous</span><span class="s2">(</span><span class="s1">est</span><span class="s2">().</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">is_c_contiguous</span><span class="s2">(</span><span class="s1">est</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">&quot;C&quot;</span><span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfortran</span><span class="s2">(</span><span class="s1">est</span><span class="s2">(</span><span class="s1">order</span><span class="s2">=</span><span class="s3">&quot;F&quot;</span><span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;params, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s3">&quot;knots&quot;</span><span class="s2">: [[</span><span class="s5">1</span><span class="s2">]]}, </span><span class="s3">r&quot;Number of knots, knots.shape\[0\], must be &gt;= 2.&quot;</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s3">&quot;knots&quot;</span><span class="s2">: [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]]}, </span><span class="s3">r&quot;knots.shape\[1\] == n_features is violated&quot;</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s3">&quot;knots&quot;</span><span class="s2">: [[</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">]]}, </span><span class="s3">&quot;knots must be sorted without duplicates.&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_input_validation</span><span class="s2">(</span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that we raise errors for invalid input in SplineTransformer.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]]</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">SplineTransformer</span><span class="s2">(**</span><span class="s1">params</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;extrapolation&quot;</span><span class="s2">, [</span><span class="s3">&quot;continue&quot;</span><span class="s2">, </span><span class="s3">&quot;periodic&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_integer_knots</span><span class="s2">(</span><span class="s1">extrapolation</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that SplineTransformer accepts integer value knot positions.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">knots </span><span class="s2">= [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">11</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">12</span><span class="s2">, </span><span class="s5">11</span><span class="s2">]]</span>
    <span class="s1">_ </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">knots</span><span class="s2">=</span><span class="s1">knots</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">=</span><span class="s1">extrapolation</span>
    <span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_spline_transformer_feature_names</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test that SplineTransformer generates correct features name.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span><span class="s1">n_knots</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s3">&quot;x0_sp_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x0_sp_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x0_sp_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x0_sp_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x0_sp_4&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x1_sp_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x1_sp_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x1_sp_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x1_sp_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;x1_sp_4&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span><span class="s1">n_knots</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s3">&quot;a_sp_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a_sp_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a_sp_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a_sp_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b_sp_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b_sp_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b_sp_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b_sp_3&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;extrapolation&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s3">&quot;constant&quot;</span><span class="s2">, </span><span class="s3">&quot;linear&quot;</span><span class="s2">, </span><span class="s3">&quot;continue&quot;</span><span class="s2">, </span><span class="s3">&quot;periodic&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;degree&quot;</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_split_transform_feature_names_extrapolation_degree</span><span class="s2">(</span><span class="s1">extrapolation</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test feature names are correct for different extrapolations and degree. 
 
    Non-regression test for gh-25292. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">=</span><span class="s1">extrapolation</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">feature_names</span><span class="s2">) == </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">n_features_out_</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;degree&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n_knots&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;knots&quot;</span><span class="s2">, [</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s3">&quot;quantile&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;extrapolation&quot;</span><span class="s2">, [</span><span class="s3">&quot;constant&quot;</span><span class="s2">, </span><span class="s3">&quot;periodic&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_unity_decomposition</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">, </span><span class="s1">n_knots</span><span class="s2">, </span><span class="s1">knots</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that B-splines are indeed a decomposition of unity. 
 
    Splines basis functions must sum up to 1 per row, if we stay in between boundaries. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">100</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s6"># make the boundaries 0 and 1 part of X_train, for sure.</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[[[</span><span class="s5">0</span><span class="s2">]], </span><span class="s1">X</span><span class="s2">[::</span><span class="s5">2</span><span class="s2">, :], [[</span><span class="s5">1</span><span class="s2">]]]</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">, :]</span>

    <span class="s0">if </span><span class="s1">extrapolation </span><span class="s2">== </span><span class="s3">&quot;periodic&quot;</span><span class="s2">:</span>
        <span class="s1">n_knots </span><span class="s2">= </span><span class="s1">n_knots </span><span class="s2">+ </span><span class="s1">degree  </span><span class="s6"># periodic splines require degree &lt; n_knots</span>

    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">n_knots</span><span class="s2">=</span><span class="s1">n_knots</span><span class="s2">,</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">knots</span><span class="s2">=</span><span class="s1">knots</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s1">extrapolation</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">X </span><span class="s0">in </span><span class="s2">[</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">]:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">splt</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">), </span><span class="s5">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">([</span><span class="s3">&quot;bias&quot;</span><span class="s2">, </span><span class="s3">&quot;intercept&quot;</span><span class="s2">], [(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_linear_regression</span><span class="s2">(</span><span class="s1">bias</span><span class="s2">, </span><span class="s1">intercept</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that B-splines fit a sinusodial curve pretty well.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">]) + </span><span class="s5">2  </span><span class="s6"># +2 to avoid the value 0 in assert_allclose</span>
    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s1">steps</span><span class="s2">=[</span>
            <span class="s2">(</span>
                <span class="s3">&quot;spline&quot;</span><span class="s2">,</span>
                <span class="s1">SplineTransformer</span><span class="s2">(</span>
                    <span class="s1">n_knots</span><span class="s2">=</span><span class="s5">15</span><span class="s2">,</span>
                    <span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                    <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">bias</span><span class="s2">,</span>
                    <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;constant&quot;</span><span class="s2">,</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;ols&quot;</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">(</span><span class="s1">fit_intercept</span><span class="s2">=</span><span class="s1">intercept</span><span class="s2">)),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">pipe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">y</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;knots&quot;</span><span class="s2">, </span><span class="s3">&quot;n_knots&quot;</span><span class="s2">, </span><span class="s3">&quot;sample_weight&quot;</span><span class="s2">, </span><span class="s3">&quot;expected_knots&quot;</span><span class="s2">],</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">8</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">14</span><span class="s2">]])),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;uniform&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">8</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">14</span><span class="s2">]]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">14</span><span class="s2">]])),</span>
        <span class="s2">(</span><span class="s3">&quot;quantile&quot;</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">14</span><span class="s2">]])),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;quantile&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">8</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">14</span><span class="s2">]]),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_get_base_knot_positions</span><span class="s2">(</span>
    <span class="s1">knots</span><span class="s2">, </span><span class="s1">n_knots</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">, </span><span class="s1">expected_knots</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Check the behaviour to find knot positions with and without sample_weight.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">8</span><span class="s2">], [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">14</span><span class="s2">]])</span>
    <span class="s1">base_knots </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">.</span><span class="s1">_get_base_knot_positions</span><span class="s2">(</span>
        <span class="s1">X</span><span class="s2">=</span><span class="s1">X</span><span class="s2">, </span><span class="s1">knots</span><span class="s2">=</span><span class="s1">knots</span><span class="s2">, </span><span class="s1">n_knots</span><span class="s2">=</span><span class="s1">n_knots</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">base_knots</span><span class="s2">, </span><span class="s1">expected_knots</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">([</span><span class="s3">&quot;bias&quot;</span><span class="s2">, </span><span class="s3">&quot;intercept&quot;</span><span class="s2">], [(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_periodic_linear_regression</span><span class="s2">(</span><span class="s1">bias</span><span class="s2">, </span><span class="s1">intercept</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that B-splines fit a periodic curve pretty well.&quot;&quot;&quot;</span>

    <span class="s6"># &quot;+ 3&quot; to avoid the value 0 in assert_allclose</span>
    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">x</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s5">8 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">x</span><span class="s2">) + </span><span class="s5">3</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">101</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s1">steps</span><span class="s2">=[</span>
            <span class="s2">(</span>
                <span class="s3">&quot;spline&quot;</span><span class="s2">,</span>
                <span class="s1">SplineTransformer</span><span class="s2">(</span>
                    <span class="s1">n_knots</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
                    <span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
                    <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">bias</span><span class="s2">,</span>
                    <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;periodic&quot;</span><span class="s2">,</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;ols&quot;</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">(</span><span class="s1">fit_intercept</span><span class="s2">=</span><span class="s1">intercept</span><span class="s2">)),</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">pipe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">f</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">]))</span>

    <span class="s6"># Generate larger array to check periodic extrapolation</span>
    <span class="s1">X_ </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">301</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s1">predictions </span><span class="s2">= </span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">predictions</span><span class="s2">, </span><span class="s1">f</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">0.01</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">0.01</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">predictions</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">100</span><span class="s2">], </span><span class="s1">predictions</span><span class="s2">[</span><span class="s5">100</span><span class="s2">:</span><span class="s5">200</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_spline_transformer_periodic_spline_backport</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test that the backport of extrapolate=&quot;periodic&quot; works correctly&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3.5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s1">degree </span><span class="s2">= </span><span class="s5">2</span>

    <span class="s6"># Use periodic extrapolation backport in SplineTransformer</span>
    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;periodic&quot;</span><span class="s2">, </span><span class="s1">knots</span><span class="s2">=[[-</span><span class="s5">1.0</span><span class="s2">], [</span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">1.0</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s6"># Use periodic extrapolation in BSpline</span>
    <span class="s1">coef </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">], [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]])</span>
    <span class="s1">spl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), </span><span class="s1">coef</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">, </span><span class="s3">&quot;periodic&quot;</span><span class="s2">)</span>
    <span class="s1">Xspl </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">, </span><span class="s1">Xspl</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_spline_transformer_periodic_splines_periodicity</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test if shifted knots result in the same transformation up to permutation.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">101</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>

    <span class="s1">transformer_1 </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;periodic&quot;</span><span class="s2">,</span>
        <span class="s1">knots</span><span class="s2">=[[</span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">1.0</span><span class="s2">], [</span><span class="s5">3.0</span><span class="s2">], [</span><span class="s5">4.0</span><span class="s2">], [</span><span class="s5">5.0</span><span class="s2">], [</span><span class="s5">8.0</span><span class="s2">]],</span>
    <span class="s2">)</span>

    <span class="s1">transformer_2 </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;periodic&quot;</span><span class="s2">,</span>
        <span class="s1">knots</span><span class="s2">=[[</span><span class="s5">1.0</span><span class="s2">], [</span><span class="s5">3.0</span><span class="s2">], [</span><span class="s5">4.0</span><span class="s2">], [</span><span class="s5">5.0</span><span class="s2">], [</span><span class="s5">8.0</span><span class="s2">], [</span><span class="s5">9.0</span><span class="s2">]],</span>
    <span class="s2">)</span>

    <span class="s1">Xt_1 </span><span class="s2">= </span><span class="s1">transformer_1</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Xt_2 </span><span class="s2">= </span><span class="s1">transformer_2</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xt_1</span><span class="s2">, </span><span class="s1">Xt_2</span><span class="s2">[:, [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;degree&quot;</span><span class="s2">, [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_periodic_splines_smoothness</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that spline transformation is smooth at first / last knot.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">10_000</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>

    <span class="s1">transformer </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;periodic&quot;</span><span class="s2">,</span>
        <span class="s1">knots</span><span class="s2">=[[</span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">1.0</span><span class="s2">], [</span><span class="s5">3.0</span><span class="s2">], [</span><span class="s5">4.0</span><span class="s2">], [</span><span class="s5">5.0</span><span class="s2">], [</span><span class="s5">8.0</span><span class="s2">]],</span>
    <span class="s2">)</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s1">transformer</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">delta </span><span class="s2">= (</span><span class="s1">X</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() - </span><span class="s1">X</span><span class="s2">.</span><span class="s1">min</span><span class="s2">()) / </span><span class="s1">len</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">tol </span><span class="s2">= </span><span class="s5">10 </span><span class="s2">* </span><span class="s1">delta</span>

    <span class="s1">dXt </span><span class="s2">= </span><span class="s1">Xt</span>
    <span class="s6"># We expect splines of degree `degree` to be (`degree`-1) times</span>
    <span class="s6"># continuously differentiable. I.e. for d = 0, ..., `degree` - 1 the d-th</span>
    <span class="s6"># derivative should be continuous. This is the case if the (d+1)-th</span>
    <span class="s6"># numerical derivative is reasonably small (smaller than `tol` in absolute</span>
    <span class="s6"># value). We thus compute d-th numeric derivatives for d = 1, ..., `degree`</span>
    <span class="s6"># and compare them to `tol`.</span>
    <span class="s6">#</span>
    <span class="s6"># Note that the 0-th derivative is the function itself, such that we are</span>
    <span class="s6"># also checking its continuity.</span>
    <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">degree </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
        <span class="s6"># Check continuity of the (d-1)-th derivative</span>
        <span class="s1">diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">dXt</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diff</span><span class="s2">).</span><span class="s1">max</span><span class="s2">() &lt; </span><span class="s1">tol</span>
        <span class="s6"># Compute d-th numeric derivative</span>
        <span class="s1">dXt </span><span class="s2">= </span><span class="s1">diff </span><span class="s2">/ </span><span class="s1">delta</span>

    <span class="s6"># As degree `degree` splines are not `degree` times continuously</span>
    <span class="s6"># differentiable at the knots, the `degree + 1`-th numeric derivative</span>
    <span class="s6"># should have spikes at the knots.</span>
    <span class="s1">diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">dXt</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diff</span><span class="s2">).</span><span class="s1">max</span><span class="s2">() &gt; </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">([</span><span class="s3">&quot;bias&quot;</span><span class="s2">, </span><span class="s3">&quot;intercept&quot;</span><span class="s2">], [(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;degree&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_extrapolation</span><span class="s2">(</span><span class="s1">bias</span><span class="s2">, </span><span class="s1">intercept</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that B-spline extrapolation works correctly.&quot;&quot;&quot;</span>
    <span class="s6"># we use a straight line for that</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">100</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">squeeze</span><span class="s2">()</span>

    <span class="s6"># 'constant'</span>
    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span>
                <span class="s3">&quot;spline&quot;</span><span class="s2">,</span>
                <span class="s1">SplineTransformer</span><span class="s2">(</span>
                    <span class="s1">n_knots</span><span class="s2">=</span><span class="s5">4</span><span class="s2">,</span>
                    <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
                    <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">bias</span><span class="s2">,</span>
                    <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;constant&quot;</span><span class="s2">,</span>
                <span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;ols&quot;</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">(</span><span class="s1">fit_intercept</span><span class="s2">=</span><span class="s1">intercept</span><span class="s2">)],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">pipe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[-</span><span class="s5">10</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">]]), [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s6"># 'linear'</span>
    <span class="s1">pipe </span><span class="s2">= </span><span class="s1">Pipeline</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span>
                <span class="s3">&quot;spline&quot;</span><span class="s2">,</span>
                <span class="s1">SplineTransformer</span><span class="s2">(</span>
                    <span class="s1">n_knots</span><span class="s2">=</span><span class="s5">4</span><span class="s2">,</span>
                    <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
                    <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">bias</span><span class="s2">,</span>
                    <span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;linear&quot;</span><span class="s2">,</span>
                <span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;ols&quot;</span><span class="s2">, </span><span class="s1">LinearRegression</span><span class="s2">(</span><span class="s1">fit_intercept</span><span class="s2">=</span><span class="s1">intercept</span><span class="s2">)],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">pipe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pipe</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[-</span><span class="s5">10</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">]]), [-</span><span class="s5">10</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>

    <span class="s6"># 'error'</span>
    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">n_knots</span><span class="s2">=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">bias</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">=</span><span class="s3">&quot;error&quot;</span>
    <span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;X contains values beyond the limits of the knots&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">splt</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[-</span><span class="s5">10</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">splt</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s5">5</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_spline_transformer_kbindiscretizer</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test that a B-spline of degree=0 is equivalent to KBinsDiscretizer.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">97531</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">200</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">200</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">n_bins </span><span class="s2">= </span><span class="s5">5</span>
    <span class="s1">n_knots </span><span class="s2">= </span><span class="s1">n_bins </span><span class="s2">+ </span><span class="s5">1</span>

    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">n_knots</span><span class="s2">=</span><span class="s1">n_knots</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">knots</span><span class="s2">=</span><span class="s3">&quot;quantile&quot;</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>
    <span class="s1">splines </span><span class="s2">= </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">kbd </span><span class="s2">= </span><span class="s1">KBinsDiscretizer</span><span class="s2">(</span><span class="s1">n_bins</span><span class="s2">=</span><span class="s1">n_bins</span><span class="s2">, </span><span class="s1">encode</span><span class="s2">=</span><span class="s3">&quot;onehot-dense&quot;</span><span class="s2">, </span><span class="s1">strategy</span><span class="s2">=</span><span class="s3">&quot;quantile&quot;</span><span class="s2">)</span>
    <span class="s1">kbins </span><span class="s2">= </span><span class="s1">kbd</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s6"># Though they should be exactly equal, we test approximately with high</span>
    <span class="s6"># accuracy.</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splines</span><span class="s2">, </span><span class="s1">kbins</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-13</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s3">&quot;1.8.0&quot;</span><span class="s2">),</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;The option `sparse_output` is available as of scipy 1.8.0&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;degree&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;knots&quot;</span><span class="s2">, [</span><span class="s3">&quot;uniform&quot;</span><span class="s2">, </span><span class="s3">&quot;quantile&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;extrapolation&quot;</span><span class="s2">, [</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s3">&quot;constant&quot;</span><span class="s2">, </span><span class="s3">&quot;linear&quot;</span><span class="s2">, </span><span class="s3">&quot;continue&quot;</span><span class="s2">, </span><span class="s3">&quot;periodic&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_sparse_output</span><span class="s2">(</span>
    <span class="s1">degree</span><span class="s2">, </span><span class="s1">knots</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">global_random_seed</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">200</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">40</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>

    <span class="s1">splt_dense </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">knots</span><span class="s2">=</span><span class="s1">knots</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s1">extrapolation</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">splt_sparse </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">knots</span><span class="s2">=</span><span class="s1">knots</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s1">extrapolation</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">splt_dense</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">splt_sparse</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_trans_sparse </span><span class="s2">= </span><span class="s1">splt_sparse</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_trans_dense </span><span class="s2">= </span><span class="s1">splt_dense</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">X_trans_sparse</span><span class="s2">) </span><span class="s0">and </span><span class="s1">X_trans_sparse</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csr&quot;</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans_dense</span><span class="s2">, </span><span class="s1">X_trans_sparse</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">())</span>

    <span class="s6"># extrapolation regime</span>
    <span class="s1">X_min </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">amin</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X_max </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">amax</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X_extra </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">X_min </span><span class="s2">- </span><span class="s5">5</span><span class="s2">, </span><span class="s1">X_min</span><span class="s2">, </span><span class="s5">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">X_max</span><span class="s2">, </span><span class="s1">X_max </span><span class="s2">+ </span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s2">]</span>
    <span class="s0">if </span><span class="s1">extrapolation </span><span class="s2">== </span><span class="s3">&quot;error&quot;</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;X contains values beyond the limits of the knots&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">splt_dense</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_extra</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Out of bounds&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">splt_sparse</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_extra</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">splt_dense</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_extra</span><span class="s2">), </span><span class="s1">splt_sparse</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_extra</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sp_version </span><span class="s2">&gt;= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s3">&quot;1.8.0&quot;</span><span class="s2">),</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;The option `sparse_output` is available as of scipy 1.8.0&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_sparse_output_raise_error_for_old_scipy</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Test that SplineTransformer with sparse=True raises for scipy&lt;1.8.0.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;scipy&gt;=1.8.0&quot;</span><span class="s2">):</span>
        <span class="s1">SplineTransformer</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n_knots&quot;</span><span class="s2">, [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;degree&quot;</span><span class="s2">, [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;extrapolation&quot;</span><span class="s2">, [</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s3">&quot;constant&quot;</span><span class="s2">, </span><span class="s3">&quot;linear&quot;</span><span class="s2">, </span><span class="s3">&quot;continue&quot;</span><span class="s2">, </span><span class="s3">&quot;periodic&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;sparse_output&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spline_transformer_n_features_out</span><span class="s2">(</span>
    <span class="s1">n_knots</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">, </span><span class="s1">extrapolation</span><span class="s2">, </span><span class="s1">sparse_output</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that transform results in n_features_out_ features.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">sparse_output </span><span class="s0">and </span><span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s3">&quot;1.8.0&quot;</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;The option `sparse_output` is available as of scipy 1.8.0&quot;</span><span class="s2">)</span>

    <span class="s1">splt </span><span class="s2">= </span><span class="s1">SplineTransformer</span><span class="s2">(</span>
        <span class="s1">n_knots</span><span class="s2">=</span><span class="s1">n_knots</span><span class="s2">,</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">,</span>
        <span class="s1">extrapolation</span><span class="s2">=</span><span class="s1">extrapolation</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">sparse_output</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] == </span><span class="s1">splt</span><span class="s2">.</span><span class="s1">n_features_out_</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;params, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s3">&quot;degree&quot;</span><span class="s2">: (-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)}, </span><span class="s3">r&quot;degree=\(min_degree, max_degree\) must&quot;</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s3">&quot;degree&quot;</span><span class="s2">: (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">)}, </span><span class="s3">r&quot;degree=\(min_degree, max_degree\) must&quot;</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s3">&quot;degree&quot;</span><span class="s2">: (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)}, </span><span class="s3">r&quot;degree=\(min_degree, max_degree\) must&quot;</span><span class="s2">),</span>
        <span class="s2">({</span><span class="s3">&quot;degree&quot;</span><span class="s2">: (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)}, </span><span class="s3">r&quot;int or tuple \(min_degree, max_degree\)&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_input_validation</span><span class="s2">(</span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test that we raise errors for invalid input in PolynomialFeatures.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]]</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">PolynomialFeatures</span><span class="s2">(**</span><span class="s1">params</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">single_feature_degree3</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
    <span class="s1">P </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">**</span><span class="s5">2</span><span class="s2">, </span><span class="s1">X</span><span class="s2">**</span><span class="s5">3</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">X</span><span class="s2">, </span><span class="s1">P</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;degree, include_bias, interaction_only, indices&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, []),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;X_container&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">] + </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_one_feature</span><span class="s2">(</span>
    <span class="s1">single_feature_degree3</span><span class="s2">,</span>
    <span class="s1">degree</span><span class="s2">,</span>
    <span class="s1">include_bias</span><span class="s2">,</span>
    <span class="s1">interaction_only</span><span class="s2">,</span>
    <span class="s1">indices</span><span class="s2">,</span>
    <span class="s1">X_container</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test PolynomialFeatures on single feature up to degree 3.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">P </span><span class="s2">= </span><span class="s1">single_feature_degree3</span>
    <span class="s0">if </span><span class="s1">X_container </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">X_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">tf </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">X_container </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">out</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">P</span><span class="s2">[:, </span><span class="s1">indices</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">n_output_features_ </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">powers_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">tf</span><span class="s2">.</span><span class="s1">n_output_features_</span><span class="s2">, </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">n_features_in_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">two_features_degree3</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">x1 </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:, :</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">x2 </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">:]</span>
    <span class="s1">P </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">0 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">0</span><span class="s2">,  </span><span class="s6"># 0</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">1 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">0</span><span class="s2">,  </span><span class="s6"># 1</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">0 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">1</span><span class="s2">,  </span><span class="s6"># 2</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">0</span><span class="s2">,  </span><span class="s6"># 3</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">1 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">1</span><span class="s2">,  </span><span class="s6"># 4</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">0 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">2</span><span class="s2">,  </span><span class="s6"># 5</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">3 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">0</span><span class="s2">,  </span><span class="s6"># 6</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">1</span><span class="s2">,  </span><span class="s6"># 7</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">1 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">2</span><span class="s2">,  </span><span class="s6"># 8</span>
            <span class="s1">x1</span><span class="s2">**</span><span class="s5">0 </span><span class="s2">* </span><span class="s1">x2</span><span class="s2">**</span><span class="s5">3</span><span class="s2">,  </span><span class="s6"># 9</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">X</span><span class="s2">, </span><span class="s1">P</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;degree, include_bias, interaction_only, indices&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">slice</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, [</span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, [</span><span class="s5">0</span><span class="s2">]),</span>
        <span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, []),  </span><span class="s6"># would need 3 input features</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;X_container&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">] + </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_two_features</span><span class="s2">(</span>
    <span class="s1">two_features_degree3</span><span class="s2">,</span>
    <span class="s1">degree</span><span class="s2">,</span>
    <span class="s1">include_bias</span><span class="s2">,</span>
    <span class="s1">interaction_only</span><span class="s2">,</span>
    <span class="s1">indices</span><span class="s2">,</span>
    <span class="s1">X_container</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Test PolynomialFeatures on 2 features up to degree 3.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">P </span><span class="s2">= </span><span class="s1">two_features_degree3</span>
    <span class="s0">if </span><span class="s1">X_container </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">X_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">tf </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">out </span><span class="s2">= </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">X_container </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">out </span><span class="s2">= </span><span class="s1">out</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">out</span><span class="s2">, </span><span class="s1">P</span><span class="s2">[:, </span><span class="s1">indices</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">n_output_features_ </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">powers_</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">tf</span><span class="s2">.</span><span class="s1">n_output_features_</span><span class="s2">, </span><span class="s1">tf</span><span class="s2">.</span><span class="s1">n_features_in_</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_polynomial_feature_names</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">30</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s3">&quot;x0&quot;</span><span class="s2">, </span><span class="s3">&quot;x1&quot;</span><span class="s2">, </span><span class="s3">&quot;x2&quot;</span><span class="s2">, </span><span class="s3">&quot;x0^2&quot;</span><span class="s2">, </span><span class="s3">&quot;x0 x1&quot;</span><span class="s2">, </span><span class="s3">&quot;x0 x2&quot;</span><span class="s2">, </span><span class="s3">&quot;x1^2&quot;</span><span class="s2">, </span><span class="s3">&quot;x1 x2&quot;</span><span class="s2">, </span><span class="s3">&quot;x2^2&quot;</span><span class="s2">],</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">feature_names</span><span class="s2">) == </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a b&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^2 b&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^2 c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a b^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a b c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a c^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b^3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b^2 c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b c^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c^3&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">feature_names</span><span class="s2">) == </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s3">&quot;a^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a b&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^2 b&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a^2 c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a b^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a b c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;a c^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b^3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b^2 c&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b c^2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c^3&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">feature_names</span><span class="s2">) == </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s3">&quot;a b c&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">feature_names</span><span class="s2">) == </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s6"># test some unicode</span>
    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s3">&quot;</span><span class="s0">\u0001</span><span class="s3">F40D&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u262e</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u05d0</span><span class="s3">&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u0001</span><span class="s3">F40D&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u262e</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u05d0</span><span class="s3">&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;deg&quot;</span><span class="s2">, </span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, </span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, </span><span class="s3">&quot;dtype&quot;</span><span class="s2">],</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csc_container&quot;</span><span class="s2">, </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_csc_X</span><span class="s2">(</span>
    <span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">csc_container</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">100</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">X_csc </span><span class="s2">= </span><span class="s1">csc_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span>
    <span class="s2">)</span>
    <span class="s1">Xt_csc </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_csc</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">Xt_dense </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xt_csc</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xt_csc</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csc&quot;</span>
    <span class="s0">assert </span><span class="s1">Xt_csc</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">Xt_dense</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt_csc</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xt_dense</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;deg&quot;</span><span class="s2">, </span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, </span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, </span><span class="s3">&quot;dtype&quot;</span><span class="s2">],</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">int</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_csr_X</span><span class="s2">(</span>
    <span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, (</span><span class="s5">100</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span>
    <span class="s2">)</span>
    <span class="s1">Xt_csr </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">Xt_dense </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csr&quot;</span>
    <span class="s0">assert </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">Xt_dense</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xt_dense</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n_features&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;min_degree, max_degree&quot;</span><span class="s2">, [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">), (</span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">), (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_num_combinations</span><span class="s2">(</span>
    <span class="s1">n_features</span><span class="s2">, </span><span class="s1">min_degree</span><span class="s2">, </span><span class="s1">max_degree</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Test that n_output_features_ is calculated correctly. 
    &quot;&quot;&quot;</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(([</span><span class="s5">1</span><span class="s2">], ([</span><span class="s5">0</span><span class="s2">], [</span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">])))</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">degree</span><span class="s2">=</span><span class="s1">max_degree</span><span class="s2">,</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">num_combos </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">n_output_features_</span>

    <span class="s1">combos </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">.</span><span class="s1">_combinations</span><span class="s2">(</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
        <span class="s1">min_degree</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_degree</span><span class="s2">=</span><span class="s1">max_degree</span><span class="s2">,</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">num_combos </span><span class="s2">== </span><span class="s1">sum</span><span class="s2">([</span><span class="s5">1 </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">combos</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;deg&quot;</span><span class="s2">, </span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, </span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, </span><span class="s3">&quot;dtype&quot;</span><span class="s2">],</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_csr_X_floats</span><span class="s2">(</span>
    <span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">sparse_random</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span>
    <span class="s2">)</span>
    <span class="s1">Xt_csr </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>
    <span class="s1">Xt_dense </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csr&quot;</span>
    <span class="s0">assert </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">Xt_dense</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xt_dense</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;zero_row_index&quot;</span><span class="s2">, </span><span class="s3">&quot;deg&quot;</span><span class="s2">, </span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">],</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_csr_X_zero_row</span><span class="s2">(</span>
    <span class="s1">zero_row_index</span><span class="s2">, </span><span class="s1">deg</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">sparse_random</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">X_csr</span><span class="s2">[</span><span class="s1">zero_row_index</span><span class="s2">, :] = </span><span class="s5">0.0</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">deg</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">)</span>
    <span class="s1">Xt_csr </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">)</span>
    <span class="s1">Xt_dense </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csr&quot;</span>
    <span class="s0">assert </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">Xt_dense</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xt_dense</span><span class="s2">)</span>


<span class="s6"># This degree should always be one more than the highest degree supported by</span>
<span class="s6"># _csr_expansion.</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, </span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">],</span>
    <span class="s2">[(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), (</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), (</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_csr_X_degree_4</span><span class="s2">(</span>
    <span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">sparse_random</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s5">4</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span>
    <span class="s2">)</span>
    <span class="s1">Xt_csr </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">)</span>
    <span class="s1">Xt_dense </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csr&quot;</span>
    <span class="s0">assert </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">Xt_dense</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xt_dense</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s2">[</span><span class="s3">&quot;deg&quot;</span><span class="s2">, </span><span class="s3">&quot;dim&quot;</span><span class="s2">, </span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">],</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_csr_X_dim_edges</span><span class="s2">(</span><span class="s1">deg</span><span class="s2">, </span><span class="s1">dim</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s1">X_csr </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">sparse_random</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s1">dim</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">deg</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">)</span>
    <span class="s1">Xt_csr </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_csr</span><span class="s2">)</span>
    <span class="s1">Xt_dense </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s3">&quot;csr&quot;</span>
    <span class="s0">assert </span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">Xt_dense</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Xt_csr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xt_dense</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_csr_polynomial_expansion_index_overflow_non_regression</span><span class="s2">(</span>
    <span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Check the automatic index dtype promotion to `np.int64` when needed. 
 
    This ensures that sufficiently large input configurations get 
    properly promoted to use `np.int64` for index and indptr representation 
    while preserving data integrity. Non-regression test for gh-16803. 
 
    Note that this is only possible for Python runtimes with a 64 bit address 
    space. On 32 bit platforms, a `ValueError` is raised instead. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">degree_2_calc</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">interaction_only</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">d </span><span class="s2">* </span><span class="s1">i </span><span class="s2">- (</span><span class="s1">i</span><span class="s2">**</span><span class="s5">2 </span><span class="s2">+ </span><span class="s5">3 </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) // </span><span class="s5">2 </span><span class="s2">- </span><span class="s5">1 </span><span class="s2">+ </span><span class="s1">j</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">d </span><span class="s2">* </span><span class="s1">i </span><span class="s2">- (</span><span class="s1">i</span><span class="s2">**</span><span class="s5">2 </span><span class="s2">+ </span><span class="s1">i</span><span class="s2">) // </span><span class="s5">2 </span><span class="s2">+ </span><span class="s1">j</span>

    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">13</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">120001</span>
    <span class="s1">data_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
    <span class="s1">row </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">2</span><span class="s2">, </span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">2</span><span class="s2">, </span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s6"># An int64 dtype is required to avoid overflow error on Windows within the</span>
    <span class="s6"># `degree_2_calc` function.</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">2</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">2</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span>
    <span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">data</span><span class="s2">, (</span><span class="s1">row</span><span class="s2">, </span><span class="s1">col</span><span class="s2">)),</span>
        <span class="s1">shape</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">),</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">data_dtype</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">pf </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s5">2</span>
    <span class="s2">)</span>

    <span class="s6"># Calculate the number of combinations a-priori, and if needed check for</span>
    <span class="s6"># the correct ValueError and terminate the test early.</span>
    <span class="s1">num_combinations </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">_num_combinations</span><span class="s2">(</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
        <span class="s1">min_degree</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_degree</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">pf</span><span class="s2">.</span><span class="s1">interaction_only</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">pf</span><span class="s2">.</span><span class="s1">include_bias</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">num_combinations </span><span class="s2">&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">).</span><span class="s1">max</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">r&quot;The output that would result from the current configuration would have&quot;</span>
            <span class="s3">r&quot; \d* features which is too large to be indexed&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">pf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">row_nonzero</span><span class="s2">, </span><span class="s1">col_nonzero </span><span class="s2">= </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">nonzero</span><span class="s2">()</span>
    <span class="s1">n_degree_1_features_out </span><span class="s2">= </span><span class="s1">n_features </span><span class="s2">+ </span><span class="s1">include_bias</span>
    <span class="s1">max_degree_2_idx </span><span class="s2">= (</span>
        <span class="s1">degree_2_calc</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">col</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s0">not </span><span class="s1">interaction_only</span><span class="s2">)], </span><span class="s1">col</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
        <span class="s2">+ </span><span class="s1">n_degree_1_features_out</span>
    <span class="s2">)</span>

    <span class="s6"># Account for bias of all samples except last one which will be handled</span>
    <span class="s6"># separately since there are distinct data values before it</span>
    <span class="s1">data_target </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">] * (</span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">2</span><span class="s2">) </span><span class="s0">if </span><span class="s1">include_bias </span><span class="s0">else </span><span class="s2">[]</span>
    <span class="s1">col_nonzero_target </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">] * (</span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">2</span><span class="s2">) </span><span class="s0">if </span><span class="s1">include_bias </span><span class="s0">else </span><span class="s2">[]</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">x_idx </span><span class="s2">= </span><span class="s1">col</span><span class="s2">[</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">y_idx </span><span class="s2">= </span><span class="s1">col</span><span class="s2">[</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">include_bias</span><span class="s2">:</span>
            <span class="s1">data_target</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">col_nonzero_target</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s1">data_target</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>
        <span class="s1">col_nonzero_target</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">x_idx </span><span class="s2">+ </span><span class="s1">int</span><span class="s2">(</span><span class="s1">include_bias</span><span class="s2">), </span><span class="s1">y_idx </span><span class="s2">+ </span><span class="s1">int</span><span class="s2">(</span><span class="s1">include_bias</span><span class="s2">)]</span>
        <span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">interaction_only</span><span class="s2">:</span>
            <span class="s1">data_target</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">x </span><span class="s2">* </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x </span><span class="s2">* </span><span class="s1">y</span><span class="s2">, </span><span class="s1">y </span><span class="s2">* </span><span class="s1">y</span><span class="s2">])</span>
            <span class="s1">col_nonzero_target</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span>
                <span class="s2">[</span>
                    <span class="s1">degree_2_calc</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">x_idx</span><span class="s2">, </span><span class="s1">x_idx</span><span class="s2">) + </span><span class="s1">n_degree_1_features_out</span><span class="s2">,</span>
                    <span class="s1">degree_2_calc</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">x_idx</span><span class="s2">, </span><span class="s1">y_idx</span><span class="s2">) + </span><span class="s1">n_degree_1_features_out</span><span class="s2">,</span>
                    <span class="s1">degree_2_calc</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">y_idx</span><span class="s2">, </span><span class="s1">y_idx</span><span class="s2">) + </span><span class="s1">n_degree_1_features_out</span><span class="s2">,</span>
                <span class="s2">]</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">data_target</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">x </span><span class="s2">* </span><span class="s1">y</span><span class="s2">])</span>
            <span class="s1">col_nonzero_target</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s1">degree_2_calc</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">x_idx</span><span class="s2">, </span><span class="s1">y_idx</span><span class="s2">) + </span><span class="s1">n_degree_1_features_out</span>
            <span class="s2">)</span>

    <span class="s1">nnz_per_row </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">include_bias</span><span class="s2">) + </span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">int</span><span class="s2">(</span><span class="s0">not </span><span class="s1">interaction_only</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">n_output_features_ </span><span class="s2">== </span><span class="s1">max_degree_2_idx </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">data_dtype</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">max_degree_2_idx </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">indptr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span>
    <span class="s6"># Ensure that dtype promotion was actually required:</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() &gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">).</span><span class="s1">max</span>

    <span class="s1">row_nonzero_target </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">2</span><span class="s2">)) </span><span class="s0">if </span><span class="s1">include_bias </span><span class="s0">else </span><span class="s2">[]</span>
    <span class="s1">row_nonzero_target</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">2</span><span class="s2">] * </span><span class="s1">nnz_per_row </span><span class="s2">+ [</span><span class="s1">n_samples </span><span class="s2">- </span><span class="s5">1</span><span class="s2">] * </span><span class="s1">nnz_per_row</span>
    <span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data_target</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">row_nonzero</span><span class="s2">, </span><span class="s1">row_nonzero_target</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">col_nonzero</span><span class="s2">, </span><span class="s1">col_nonzero_target</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;degree, n_features&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s6"># Needs promotion to int64 when interaction_only=False</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">65535</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2344</span><span class="s2">),</span>
        <span class="s6"># This guarantees that the intermediate operation when calculating</span>
        <span class="s6"># output columns would overflow a C-long, hence checks that python-</span>
        <span class="s6"># longs are being used.</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">).</span><span class="s1">max</span><span class="s2">) + </span><span class="s5">1</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">65535</span><span class="s2">),</span>
        <span class="s6"># This case tests the second clause of the overflow check which</span>
        <span class="s6"># takes into account the value of `n_features` itself.</span>
        <span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">).</span><span class="s1">max</span><span class="s2">))),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_csr_polynomial_expansion_index_overflow</span><span class="s2">(</span>
    <span class="s1">degree</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Tests known edge-cases to the dtype promotion strategy and custom 
    Cython code, including a current bug in the upstream 
    `scipy.sparse.hstack`. 
    &quot;&quot;&quot;</span>
    <span class="s1">data </span><span class="s2">= [</span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">row </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">col </span><span class="s2">= [</span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s6"># First degree index</span>
    <span class="s1">expected_indices </span><span class="s2">= [</span>
        <span class="s1">n_features </span><span class="s2">- </span><span class="s5">1 </span><span class="s2">+ </span><span class="s1">int</span><span class="s2">(</span><span class="s1">include_bias</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s6"># Second degree index</span>
    <span class="s1">expected_indices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">n_features </span><span class="s2">* (</span><span class="s1">n_features </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) // </span><span class="s5">2 </span><span class="s2">+ </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s6"># Third degree index</span>
    <span class="s1">expected_indices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
        <span class="s1">n_features </span><span class="s2">* (</span><span class="s1">n_features </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">n_features </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">) // </span><span class="s5">6 </span><span class="s2">+ </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">((</span><span class="s1">data</span><span class="s2">, (</span><span class="s1">row</span><span class="s2">, </span><span class="s1">col</span><span class="s2">)))</span>
    <span class="s1">pf </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span>
    <span class="s2">)</span>

    <span class="s6"># Calculate the number of combinations a-priori, and if needed check for</span>
    <span class="s6"># the correct ValueError and terminate the test early.</span>
    <span class="s1">num_combinations </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">_num_combinations</span><span class="s2">(</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
        <span class="s1">min_degree</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">max_degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">pf</span><span class="s2">.</span><span class="s1">interaction_only</span><span class="s2">,</span>
        <span class="s1">include_bias</span><span class="s2">=</span><span class="s1">pf</span><span class="s2">.</span><span class="s1">include_bias</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">num_combinations </span><span class="s2">&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">).</span><span class="s1">max</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">r&quot;The output that would result from the current configuration would have&quot;</span>
            <span class="s3">r&quot; \d* features which is too large to be indexed&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">pf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">return</span>

    <span class="s6"># In SciPy &lt; 1.8, a bug occurs when an intermediate matrix in</span>
    <span class="s6"># `to_stack` in `hstack` fits within int32 however would require int64 when</span>
    <span class="s6"># combined with all previous matrices in `to_stack`.</span>
    <span class="s0">if </span><span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s3">&quot;1.8.0&quot;</span><span class="s2">):</span>
        <span class="s1">has_bug </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">max_int32 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">).</span><span class="s1">max</span>
        <span class="s1">cumulative_size </span><span class="s2">= </span><span class="s1">n_features </span><span class="s2">+ </span><span class="s1">include_bias</span>
        <span class="s0">for </span><span class="s1">deg </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">degree </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">max_indptr </span><span class="s2">= </span><span class="s1">_calc_total_nnz</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">indptr</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">deg</span><span class="s2">)</span>
            <span class="s1">max_indices </span><span class="s2">= </span><span class="s1">_calc_expanded_nnz</span><span class="s2">(</span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">deg</span><span class="s2">) - </span><span class="s5">1</span>
            <span class="s1">cumulative_size </span><span class="s2">+= </span><span class="s1">max_indices </span><span class="s2">+ </span><span class="s5">1</span>
            <span class="s1">needs_int64 </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">max_indices</span><span class="s2">, </span><span class="s1">max_indptr</span><span class="s2">) &gt; </span><span class="s1">max_int32</span>
            <span class="s1">has_bug </span><span class="s2">|= </span><span class="s0">not </span><span class="s1">needs_int64 </span><span class="s0">and </span><span class="s1">cumulative_size </span><span class="s2">&gt; </span><span class="s1">max_int32</span>
        <span class="s0">if </span><span class="s1">has_bug</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;In scipy versions `&lt;1.8.0`, the function `scipy.sparse.hstack`&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
            <span class="s0">return</span>

    <span class="s6"># When `n_features&gt;=65535`, `scipy.sparse.hstack` may not use the right</span>
    <span class="s6"># dtype for representing indices and indptr if `n_features` is still</span>
    <span class="s6"># small enough so that each block matrix's indices and indptr arrays</span>
    <span class="s6"># can be represented with `np.int32`. We test `n_features==65535`</span>
    <span class="s6"># since it is guaranteed to run into this bug.</span>
    <span class="s0">if </span><span class="s2">(</span>
        <span class="s1">sp_version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s3">&quot;1.9.2&quot;</span><span class="s2">)</span>
        <span class="s0">and </span><span class="s1">n_features </span><span class="s2">== </span><span class="s5">65535</span>
        <span class="s0">and </span><span class="s1">degree </span><span class="s2">== </span><span class="s5">2</span>
        <span class="s0">and not </span><span class="s1">interaction_only</span>
    <span class="s2">):  </span><span class="s6"># pragma: no cover</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;In scipy versions `&lt;1.9.2`, the function `scipy.sparse.hstack`&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">return</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">expected_dtype </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64 </span><span class="s0">if </span><span class="s1">num_combinations </span><span class="s2">&gt; </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">).</span><span class="s1">max </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span>
    <span class="s6"># Terms higher than first degree</span>
    <span class="s1">non_bias_terms </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">+ (</span><span class="s1">degree </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) * </span><span class="s1">int</span><span class="s2">(</span><span class="s0">not </span><span class="s1">interaction_only</span><span class="s2">)</span>
    <span class="s1">expected_nnz </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">include_bias</span><span class="s2">) + </span><span class="s1">non_bias_terms</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">n_output_features_</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">indptr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">indices</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">expected_dtype</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">nnz </span><span class="s2">== </span><span class="s1">expected_nnz</span>

    <span class="s0">if </span><span class="s1">include_bias</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">non_bias_terms</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>

    <span class="s1">offset </span><span class="s2">= </span><span class="s1">interaction_only </span><span class="s2">* </span><span class="s1">n_features</span>
    <span class="s0">if </span><span class="s1">degree </span><span class="s2">== </span><span class="s5">3</span><span class="s2">:</span>
        <span class="s1">offset </span><span class="s2">*= </span><span class="s5">1 </span><span class="s2">+ </span><span class="s1">n_features</span>
    <span class="s0">assert </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">n_output_features_ </span><span class="s2">== </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s1">degree </span><span class="s2">- </span><span class="s5">1</span><span class="s2">] + </span><span class="s5">1 </span><span class="s2">- </span><span class="s1">offset</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;interaction_only&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;include_bias&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_csr_polynomial_expansion_too_large_to_index</span><span class="s2">(</span>
    <span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">csr_container</span>
<span class="s2">):</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">).</span><span class="s1">max </span><span class="s2">// </span><span class="s5">2</span>
    <span class="s1">data </span><span class="s2">= [</span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">row </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">col </span><span class="s2">= [</span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">((</span><span class="s1">data</span><span class="s2">, (</span><span class="s1">row</span><span class="s2">, </span><span class="s1">col</span><span class="s2">)))</span>
    <span class="s1">pf </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span>
        <span class="s1">interaction_only</span><span class="s2">=</span><span class="s1">interaction_only</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s1">include_bias</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s3">r&quot;The output that would result from the current configuration would have \d*&quot;</span>
        <span class="s3">r&quot; features which is too large to be indexed&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">pf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polynomial_features_behaviour_on_zero_degree</span><span class="s2">(</span><span class="s1">sparse_container</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot;Check that PolynomialFeatures raises error when degree=0 and include_bias=False, 
    and output a single constant column when include_bias=True 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s3">&quot;Setting degree to zero and include_bias to False would result in&quot;</span>
        <span class="s3">&quot; an empty output array.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">poly</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s3">&quot;Setting both min_degree and max_degree to zero and include_bias to&quot;</span>
        <span class="s3">&quot; False would result in an empty output array.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">poly</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">_X </span><span class="s0">in </span><span class="s2">[</span><span class="s1">X</span><span class="s2">, </span><span class="s1">sparse_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)]:</span>
        <span class="s1">poly </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">degree</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">poly</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">_X</span><span class="s2">)</span>
        <span class="s6"># convert to dense array if needed</span>
        <span class="s0">if </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">output</span><span class="s2">):</span>
            <span class="s1">output </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">output</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s5">1</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">test_sizeof_LARGEST_INT_t</span><span class="s2">():</span>
    <span class="s6"># On Windows, scikit-learn is typically compiled with MSVC that</span>
    <span class="s6"># does not support int128 arithmetic (at the time of writing):</span>
    <span class="s6"># https://stackoverflow.com/a/6761962/163740</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;win32&quot; </span><span class="s0">or </span><span class="s2">(</span>
        <span class="s1">sys</span><span class="s2">.</span><span class="s1">maxsize </span><span class="s2">&lt;= </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32 </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s3">&quot;emscripten&quot;</span>
    <span class="s2">):</span>
        <span class="s1">expected_size </span><span class="s2">= </span><span class="s5">8</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected_size </span><span class="s2">= </span><span class="s5">16</span>

    <span class="s0">assert </span><span class="s1">_get_sizeof_LARGEST_INT_t</span><span class="s2">() == </span><span class="s1">expected_size</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s3">&quot;win32&quot;</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=(</span>
        <span class="s3">&quot;On Windows, scikit-learn is typically compiled with MSVC that does not support&quot;</span>
        <span class="s3">&quot; int128 arithmetic (at the time of writing)&quot;</span>
    <span class="s2">),</span>
    <span class="s1">run</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_csr_polynomial_expansion_windows_fail</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s6"># Minimum needed to ensure integer overflow occurs while guaranteeing an</span>
    <span class="s6"># int64-indexable output.</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">iinfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">).</span><span class="s1">max </span><span class="s2">** (</span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">) + </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= [</span><span class="s5">1.0</span><span class="s2">]</span>
    <span class="s1">row </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">col </span><span class="s2">= [</span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">]</span>

    <span class="s6"># First degree index</span>
    <span class="s1">expected_indices </span><span class="s2">= [</span>
        <span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s6"># Second degree index</span>
    <span class="s1">expected_indices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
        <span class="s1">int</span><span class="s2">(</span><span class="s1">n_features </span><span class="s2">* (</span><span class="s1">n_features </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) // </span><span class="s5">2 </span><span class="s2">+ </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s2">)</span>
    <span class="s6"># Third degree index</span>
    <span class="s1">expected_indices</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
        <span class="s1">int</span><span class="s2">(</span><span class="s1">n_features </span><span class="s2">* (</span><span class="s1">n_features </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) * (</span><span class="s1">n_features </span><span class="s2">+ </span><span class="s5">2</span><span class="s2">) // </span><span class="s5">6 </span><span class="s2">+ </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">((</span><span class="s1">data</span><span class="s2">, (</span><span class="s1">row</span><span class="s2">, </span><span class="s1">col</span><span class="s2">)))</span>
    <span class="s1">pf </span><span class="s2">= </span><span class="s1">PolynomialFeatures</span><span class="s2">(</span><span class="s1">interaction_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">include_bias</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">maxsize </span><span class="s2">&lt;= </span><span class="s5">2</span><span class="s2">**</span><span class="s5">32</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">r&quot;The output that would result from the current configuration would&quot;</span>
            <span class="s3">r&quot; have \d*&quot;</span>
            <span class="s3">r&quot; features which is too large to be indexed&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pf</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">3</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">expected_indices</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">]] == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">1.0</span><span class="s2">)</span>
</pre>
</body>
</html>