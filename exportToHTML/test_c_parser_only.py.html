<html>
<head>
<title>test_c_parser_only.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_c_parser_only.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Tests that apply specifically to the CParser. Unless specifically stated 
as a CParser-specific issue, the goal is to eventually move as many of 
these tests out of this module as soon as the Python parser can accept 
further arguments when parsing. 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">decimal </span><span class="s2">import </span><span class="s1">Decimal</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">BytesIO</span><span class="s3">,</span>
    <span class="s1">StringIO</span><span class="s3">,</span>
    <span class="s1">TextIOWrapper</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">mmap</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">tarfile</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">compat</span><span class="s3">.</span><span class="s1">numpy </span><span class="s2">import </span><span class="s1">np_version_gte1p24</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ParserError</span><span class="s3">,</span>
    <span class="s1">ParserWarning</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">_test_decorators </span><span class="s2">as </span><span class="s1">td</span>

<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">DataFrame</span><span class="s3">,</span>
    <span class="s1">concat</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">as </span><span class="s1">tm</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;malformed&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s4">&quot;1</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r </span><span class="s4">1</span><span class="s2">\r </span><span class="s4">1</span><span class="s2">\r</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;1</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r </span><span class="s4">1</span><span class="s2">\r </span><span class="s4">1</span><span class="s2">\r</span><span class="s4">11</span><span class="s2">\r</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;1</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r </span><span class="s4">1</span><span class="s2">\r </span><span class="s4">1</span><span class="s2">\r</span><span class="s4">11</span><span class="s2">\r</span><span class="s4">1</span><span class="s2">\r</span><span class="s4">&quot;</span><span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s4">&quot;words pointer&quot;</span><span class="s3">, </span><span class="s4">&quot;stream pointer&quot;</span><span class="s3">, </span><span class="s4">&quot;lines pointer&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_buffer_overflow</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">malformed</span><span class="s3">):</span>
    <span class="s5"># see gh-9205: test certain malformed input files that cause</span>
    <span class="s5"># buffer overflows in tokenizer.c</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Buffer overflow caught - possible malformed input file.&quot;</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ParserError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">malformed</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_delim_whitespace_custom_terminator</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># See gh-12912</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;a b c~1 2 3~4 5 6~7 8 9&quot;</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s1">depr_msg </span><span class="s3">= </span><span class="s4">&quot;The 'delim_whitespace' keyword in pd.read_csv is deprecated&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span>
        <span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">depr_msg</span><span class="s3">, </span><span class="s1">check_stacklevel</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">lineterminator</span><span class="s3">=</span><span class="s4">&quot;~&quot;</span><span class="s3">, </span><span class="s1">delim_whitespace</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_dtype_and_names_error</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-8833: passing both dtype and names</span>
    <span class="s5"># resulting in an error reporting issue</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
1.0 1 
2.0 2 
3.0 3 
&quot;&quot;&quot;</span>
    <span class="s5"># base cases</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">r&quot;\s+&quot;</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3.0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">r&quot;\s+&quot;</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3.0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s5"># fallback casting</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">r&quot;\s+&quot;</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">])</span>
    <span class="s1">expected</span><span class="s3">[</span><span class="s4">&quot;a&quot;</span><span class="s3">] = </span><span class="s1">expected</span><span class="s3">[</span><span class="s4">&quot;a&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot; 
1.0 1 
nan 2 
3.0 3 
&quot;&quot;&quot;</span>
    <span class="s5"># fallback casting, but not castable</span>
    <span class="s1">warning </span><span class="s3">= </span><span class="s1">RuntimeWarning </span><span class="s2">if </span><span class="s1">np_version_gte1p24 </span><span class="s2">else None</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;cannot safely convert&quot;</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">warning</span><span class="s3">, </span><span class="s1">check_stacklevel</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
            <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
                <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">),</span>
                <span class="s1">sep</span><span class="s3">=</span><span class="s4">r&quot;\s+&quot;</span><span class="s3">,</span>
                <span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                <span class="s1">names</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">],</span>
                <span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">},</span>
            <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;match,kwargs&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s5"># For each of these cases, all of the dtypes are valid, just unsupported.</span>
        <span class="s3">(</span>
            <span class="s3">(</span>
                <span class="s4">&quot;the dtype datetime64 is not supported for parsing, &quot;</span>
                <span class="s4">&quot;pass this column using parse_dates instead&quot;</span>
            <span class="s3">),</span>
            <span class="s3">{</span><span class="s4">&quot;dtype&quot;</span><span class="s3">: {</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s4">&quot;datetime64&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s4">&quot;float64&quot;</span><span class="s3">}},</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">(</span>
                <span class="s4">&quot;the dtype datetime64 is not supported for parsing, &quot;</span>
                <span class="s4">&quot;pass this column using parse_dates instead&quot;</span>
            <span class="s3">),</span>
            <span class="s3">{</span><span class="s4">&quot;dtype&quot;</span><span class="s3">: {</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s4">&quot;datetime64&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s4">&quot;float64&quot;</span><span class="s3">}, </span><span class="s4">&quot;parse_dates&quot;</span><span class="s3">: [</span><span class="s4">&quot;B&quot;</span><span class="s3">]},</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;the dtype timedelta64 is not supported for parsing&quot;</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;dtype&quot;</span><span class="s3">: {</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s4">&quot;timedelta64&quot;</span><span class="s3">, </span><span class="s4">&quot;B&quot;</span><span class="s3">: </span><span class="s4">&quot;float64&quot;</span><span class="s3">}},</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">f&quot;the dtype </span><span class="s2">{</span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ENDIAN</span><span class="s2">}</span><span class="s4">U8 is not supported for parsing&quot;</span><span class="s3">,</span>
            <span class="s3">{</span><span class="s4">&quot;dtype&quot;</span><span class="s3">: {</span><span class="s4">&quot;A&quot;</span><span class="s3">: </span><span class="s4">&quot;U8&quot;</span><span class="s3">}},</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s4">&quot;dt64-0&quot;</span><span class="s3">, </span><span class="s4">&quot;dt64-1&quot;</span><span class="s3">, </span><span class="s4">&quot;td64&quot;</span><span class="s3">, </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ENDIAN</span><span class="s2">}</span><span class="s4">U8&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_unsupported_dtype</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">match</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">random</span><span class="s3">((</span><span class="s6">5</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)),</span>
        <span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s4">&quot;AB&quot;</span><span class="s3">),</span>
        <span class="s1">index</span><span class="s3">=[</span><span class="s4">&quot;1A&quot;</span><span class="s3">, </span><span class="s4">&quot;1B&quot;</span><span class="s3">, </span><span class="s4">&quot;1C&quot;</span><span class="s3">, </span><span class="s4">&quot;1D&quot;</span><span class="s3">, </span><span class="s4">&quot;1E&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s4">&quot;__unsupported_dtype__.csv&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_csv</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
            <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">index_col</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">td</span><span class="s3">.</span><span class="s1">skip_if_32bit</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s5"># test numbers between 1 and 2</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;num&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s6">21</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_precise_conversion</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">num</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s1">normal_errors </span><span class="s3">= []</span>
    <span class="s1">precise_errors </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">error</span><span class="s3">(</span><span class="s1">val</span><span class="s3">: </span><span class="s1">float</span><span class="s3">, </span><span class="s1">actual_val</span><span class="s3">: </span><span class="s1">Decimal</span><span class="s3">) </span><span class="s1">-&gt; Decimal</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">Decimal</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">val</span><span class="s2">:</span><span class="s4">.100</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">) - </span><span class="s1">actual_val</span><span class="s3">)</span>

    <span class="s5"># 25 decimal digits of precision</span>
    <span class="s1">text </span><span class="s3">= </span><span class="s4">f&quot;a</span><span class="s2">\n{</span><span class="s1">num</span><span class="s2">:</span><span class="s4">.25</span><span class="s2">}</span><span class="s4">&quot;</span>

    <span class="s1">normal_val </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">text</span><span class="s3">), </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;legacy&quot;</span><span class="s3">)[</span><span class="s4">&quot;a&quot;</span><span class="s3">][</span><span class="s6">0</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">precise_val </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">text</span><span class="s3">), </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;high&quot;</span><span class="s3">)[</span><span class="s4">&quot;a&quot;</span><span class="s3">][</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">roundtrip_val </span><span class="s3">= </span><span class="s1">float</span><span class="s3">(</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">text</span><span class="s3">), </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;round_trip&quot;</span><span class="s3">)[</span><span class="s4">&quot;a&quot;</span><span class="s3">][</span><span class="s6">0</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">actual_val </span><span class="s3">= </span><span class="s1">Decimal</span><span class="s3">(</span><span class="s1">text</span><span class="s3">[</span><span class="s6">2</span><span class="s3">:])</span>

    <span class="s1">normal_errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">error</span><span class="s3">(</span><span class="s1">normal_val</span><span class="s3">, </span><span class="s1">actual_val</span><span class="s3">))</span>
    <span class="s1">precise_errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">error</span><span class="s3">(</span><span class="s1">precise_val</span><span class="s3">, </span><span class="s1">actual_val</span><span class="s3">))</span>

    <span class="s5"># round-trip should match float()</span>
    <span class="s2">assert </span><span class="s1">roundtrip_val </span><span class="s3">== </span><span class="s1">float</span><span class="s3">(</span><span class="s1">text</span><span class="s3">[</span><span class="s6">2</span><span class="s3">:])</span>

    <span class="s2">assert </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">precise_errors</span><span class="s3">) &lt;= </span><span class="s1">sum</span><span class="s3">(</span><span class="s1">normal_errors</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">max</span><span class="s3">(</span><span class="s1">precise_errors</span><span class="s3">) &lt;= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">normal_errors</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_usecols_dtypes</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s2">\ 
</span><span class="s4">1,2,3 
4,5,6 
7,8,9 
10,11,12&quot;&quot;&quot;</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">usecols</span><span class="s3">=(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
        <span class="s1">names</span><span class="s3">=(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">),</span>
        <span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">converters</span><span class="s3">={</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">},</span>
        <span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">: </span><span class="s1">float</span><span class="s3">},</span>
    <span class="s3">)</span>
    <span class="s1">result2 </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">usecols</span><span class="s3">=(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
        <span class="s1">names</span><span class="s3">=(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">),</span>
        <span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">converters</span><span class="s3">={</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">},</span>
        <span class="s1">dtype</span><span class="s3">={</span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">: </span><span class="s1">float</span><span class="s3">},</span>
    <span class="s3">)</span>

    <span class="s2">assert </span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s3">== [</span><span class="s1">object</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s1">result2</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s3">== [</span><span class="s1">object</span><span class="s3">, </span><span class="s1">float</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_disable_bool_parsing</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-2090</span>

    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;A,B,C 
Yes,No,Yes 
No,Yes,Yes 
Yes,,Yes 
No,No,No&quot;&quot;&quot;</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">dtypes </span><span class="s3">== </span><span class="s1">object</span><span class="s3">).</span><span class="s1">all</span><span class="s3">()</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">, </span><span class="s1">na_filter</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;B&quot;</span><span class="s3">][</span><span class="s6">2</span><span class="s3">] == </span><span class="s4">&quot;&quot;</span>


<span class="s2">def </span><span class="s1">test_custom_lineterminator</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;a,b,c~1,2,3~4,5,6&quot;</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">lineterminator</span><span class="s3">=</span><span class="s4">&quot;~&quot;</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;~&quot;</span><span class="s3">, </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">)))</span>

    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_parse_ragged_csv</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;1,2,3 
1,2,3,4 
1,2,3,4,5 
1,2 
1,2,3,4&quot;&quot;&quot;</span>

    <span class="s1">nice_data </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;1,2,3,, 
1,2,3,4, 
1,2,3,4,5 
1,2,,, 
1,2,3,4,&quot;&quot;&quot;</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">, </span><span class="s4">&quot;d&quot;</span><span class="s3">, </span><span class="s4">&quot;e&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">nice_data</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">, </span><span class="s4">&quot;d&quot;</span><span class="s3">, </span><span class="s4">&quot;e&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s5"># too many columns, cause segfault if not careful</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;1,2</span><span class="s2">\n</span><span class="s4">3,4,5&quot;</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=</span><span class="s1">range</span><span class="s3">(</span><span class="s6">50</span><span class="s3">))</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">names</span><span class="s3">=</span><span class="s1">range</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)).</span><span class="s1">reindex</span><span class="s3">(</span>
        <span class="s1">columns</span><span class="s3">=</span><span class="s1">range</span><span class="s3">(</span><span class="s6">50</span><span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_tokenize_CR_with_quoting</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-3453</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">' a,b,c</span><span class="s2">\r</span><span class="s4">&quot;a,b&quot;,&quot;e,d&quot;,&quot;f,f&quot;'</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\r</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">)), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">))</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\r</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">)))</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;count&quot;</span><span class="s3">, [</span><span class="s6">3 </span><span class="s3">* </span><span class="s6">2</span><span class="s3">**</span><span class="s1">n </span><span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">6</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_grow_boundary_at_cap</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">count</span><span class="s3">):</span>
    <span class="s5"># See gh-12494</span>
    <span class="s5">#</span>
    <span class="s5"># Cause of error was that the C parser</span>
    <span class="s5"># was not increasing the buffer size when</span>
    <span class="s5"># the desired space would fill the buffer</span>
    <span class="s5"># to capacity, which would later cause a</span>
    <span class="s5"># buffer overflow error when checking the</span>
    <span class="s5"># EOF terminator of the CSV stream.</span>
    <span class="s5"># 3 * 2^n commas was observed to break the parser</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s2">with </span><span class="s1">StringIO</span><span class="s3">(</span><span class="s4">&quot;,&quot; </span><span class="s3">* </span><span class="s1">count</span><span class="s3">) </span><span class="s2">as </span><span class="s1">s</span><span class="s3">:</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">f&quot;Unnamed: </span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">count </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">)])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;encoding&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;utf-8&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_parse_trim_buffers</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">):</span>
    <span class="s5"># This test is part of a bugfix for gh-13703. It attempts to</span>
    <span class="s5"># to stress the system memory allocator, to cause it to move the</span>
    <span class="s5"># stream buffer and either let the OS reclaim the region, or let</span>
    <span class="s5"># other memory requests of parser otherwise modify the contents</span>
    <span class="s5"># of memory space, where it was formally located.</span>
    <span class="s5"># This test is designed to cause a `segfault` with unpatched</span>
    <span class="s5"># `tokenizer.c`. Sometimes the test fails on `segfault`, other</span>
    <span class="s5"># times it fails due to memory corruption, which causes the</span>
    <span class="s5"># loaded DataFrame to differ from the expected one.</span>

    <span class="s5"># Also force 'utf-8' encoding, so that `_string_convert` would take</span>
    <span class="s5"># a different execution branch.</span>

    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s5"># Generate a large mixed-type CSV file on-the-fly (one record is</span>
    <span class="s5"># approx 1.5KiB).</span>
    <span class="s1">record_ </span><span class="s3">= (</span>
        <span class="s4">&quot;&quot;&quot;9999-9,99:99,,,,ZZ,ZZ,,,ZZZ-ZZZZ,.Z-ZZZZ,-9.99,,,9.99,Z&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZZZ,,-99,9,ZZZ-ZZZZ,ZZ-ZZZZ,,9.99,ZZZ-ZZZZZ,ZZZ-ZZZZZ,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZZ-ZZZZ,ZZZ-ZZZZ,ZZZ-ZZZZ,ZZZ-ZZZZ,ZZZ-ZZZZ,ZZZ-ZZZZ,9&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;99,ZZZ-ZZZZ,,ZZ-ZZZZ,,,,,ZZZZ,ZZZ-ZZZZZ,ZZZ-ZZZZ,,,9,9,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;9,9,99,99,999,999,ZZZZZ,ZZZ-ZZZZZ,ZZZ-ZZZZ,9,ZZ-ZZZZ,9.&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;99,ZZ-ZZZZ,ZZ-ZZZZ,,,,ZZZZ,,,ZZ,ZZ,,,,,,,,,,,,,9,,,999.&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;99,999.99,,,ZZZZZ,,,Z9,,,,,,,ZZZ,ZZZ,,,,,,,,,,,ZZZZZ,ZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZZ,ZZZ-ZZZZZZ,ZZZ-ZZZZZZ,ZZ-ZZZZ,ZZ-ZZZZ,ZZ-ZZZZ,ZZ-ZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZ,,,999999,999999,ZZZ,ZZZ,,,ZZZ,ZZZ,999.99,999.99,,,,Z&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZ-ZZZ,ZZZ-ZZZ,-9.99,-9.99,9,9,,99,,9.99,9.99,9,9,9.99,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;9.99,,,,9.99,9.99,,99,,99,9.99,9.99,,,ZZZ,ZZZ,,999.99,,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;999.99,ZZZ,ZZZ-ZZZZ,ZZZ-ZZZZ,,,ZZZZZ,ZZZZZ,ZZZ,ZZZ,9,9,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,,,,,ZZZ-ZZZZ,ZZZ999Z,,,999.99,,999.99,ZZZ-ZZZZ,,,9.999&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,9.999,9.999,9.999,-9.999,-9.999,-9.999,-9.999,9.999,9.&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;999,9.999,9.999,9.999,9.999,9.999,9.999,99999,ZZZ-ZZZZ,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,9.99,ZZZ,,,,,,,,ZZZ,,,,,9,,,,9,,,,,,,,,,ZZZ-ZZZZ,ZZZ-Z&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZZ,,ZZZZZ,ZZZZZ,ZZZZZ,ZZZZZ,,,9.99,,ZZ-ZZZZ,ZZ-ZZZZ,ZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,999,,,,ZZ-ZZZZ,ZZZ,ZZZ,ZZZ-ZZZZ,ZZZ-ZZZZ,,,99.99,99.99&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,,,9.99,9.99,9.99,9.99,ZZZ-ZZZZ,,,ZZZ-ZZZZZ,,,,,-9.99,-&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;9.99,-9.99,-9.99,,,,,,,,,ZZZ-ZZZZ,,9,9.99,9.99,99ZZ,,-9&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;.99,-9.99,ZZZ-ZZZZ,,,,,,,ZZZ-ZZZZ,9.99,9.99,9999,,,,,,,&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,,,-9.9,Z/Z-ZZZZ,999.99,9.99,,999.99,ZZ-ZZZZ,ZZ-ZZZZ,9.&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;99,9.99,9.99,9.99,9.99,9.99,,ZZZ-ZZZZZ,ZZZ-ZZZZZ,ZZZ-ZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZZ,ZZZ-ZZZZZ,ZZZ-ZZZZZ,ZZZ,ZZZ,ZZZ,ZZZ,9.99,,,-9.99,ZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;-ZZZZ,-999.99,,-9999,,999.99,,,,999.99,99.99,,,ZZ-ZZZZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;ZZZ,ZZ-ZZZZ-ZZZZZZZ,,,,ZZ-ZZ-ZZZZZZZZ,ZZZZZZZZ,ZZZ-ZZZZ&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,9999,999.99,ZZZ-ZZZZ,-9.99,-9.99,ZZZ-ZZZZ,99:99:99,,99&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;,99,,9.99,,-99.99,,,,,,9.99,ZZZ-ZZZZ,-9.99,-9.99,9.99,9&quot;&quot;&quot;</span>
        <span class="s4">&quot;&quot;&quot;.99,,ZZZ,,,,,,,ZZZ,ZZZ,,,,,&quot;&quot;&quot;</span>
    <span class="s3">)</span>

    <span class="s5"># Set the number of lines so that a call to `parser_trim_buffers`</span>
    <span class="s5"># is triggered: after a couple of full chunks are consumed a</span>
    <span class="s5"># relatively small 'residual' chunk would cause reallocation</span>
    <span class="s5"># within the parser.</span>
    <span class="s1">chunksize</span><span class="s3">, </span><span class="s1">n_lines </span><span class="s3">= </span><span class="s6">128</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">* </span><span class="s6">128 </span><span class="s3">+ </span><span class="s6">15</span>
    <span class="s1">csv_data </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s1">record_</span><span class="s3">] * </span><span class="s1">n_lines</span><span class="s3">) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>

    <span class="s5"># We will use StringIO to load the CSV from this text buffer.</span>
    <span class="s5"># pd.read_csv() will iterate over the file in chunks and will</span>
    <span class="s5"># finally read a residual chunk of really small size.</span>

    <span class="s5"># Generate the expected output: manually create the dataframe</span>
    <span class="s5"># by splitting by comma and repeating the `n_lines` times.</span>
    <span class="s1">row </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">val_ </span><span class="s2">if </span><span class="s1">val_ </span><span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan </span><span class="s2">for </span><span class="s1">val_ </span><span class="s2">in </span><span class="s1">record_</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;,&quot;</span><span class="s3">))</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s1">row </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_lines</span><span class="s3">)], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s2">None</span>
    <span class="s3">)</span>

    <span class="s5"># Iterate over the CSV file in chunks of `chunksize` lines</span>
    <span class="s2">with </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">csv_data</span><span class="s3">),</span>
        <span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">,</span>
        <span class="s1">chunksize</span><span class="s3">=</span><span class="s1">chunksize</span><span class="s3">,</span>
        <span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s2">as </span><span class="s1">chunks_</span><span class="s3">:</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">concat</span><span class="s3">(</span><span class="s1">chunks_</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">ignore_index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s5"># Check for data corruption if there was no segfault</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_internal_null_byte</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-14012</span>
    <span class="s5">#</span>
    <span class="s5"># The null byte ('\x00') should not be used as a</span>
    <span class="s5"># true line terminator, escape character, or comment</span>
    <span class="s5"># character, only as a placeholder to indicate that</span>
    <span class="s5"># none was specified.</span>
    <span class="s5">#</span>
    <span class="s5"># This test should be moved to test_common.py ONLY when</span>
    <span class="s5"># Python's csv class supports parsing '\x00'.</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s1">names </span><span class="s3">= [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">]</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;1,2,3</span><span class="s2">\n</span><span class="s4">4,</span><span class="s2">\x00</span><span class="s4">,6</span><span class="s2">\n</span><span class="s4">7,8,9&quot;</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">6</span><span class="s3">], [</span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">, </span><span class="s6">9</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">names</span><span class="s3">)</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">names</span><span class="s3">=</span><span class="s1">names</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_nrows_large</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># gh-7626 - Read only nrows of data in for large inputs (&gt;262144b)</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">header_narrow </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s4">&quot;COL_HEADER_&quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)]) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">data_narrow </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s4">&quot;somedatasomedatasomedata1&quot; </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)]) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">header_wide </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s4">&quot;COL_HEADER_&quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">15</span><span class="s3">)]) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">data_wide </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s4">&quot;somedatasomedatasomedata2&quot; </span><span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">15</span><span class="s3">)]) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">test_input </span><span class="s3">= </span><span class="s1">header_narrow </span><span class="s3">+ </span><span class="s1">data_narrow </span><span class="s3">* </span><span class="s6">1050 </span><span class="s3">+ </span><span class="s1">header_wide </span><span class="s3">+ </span><span class="s1">data_wide </span><span class="s3">* </span><span class="s6">2</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">test_input</span><span class="s3">), </span><span class="s1">sep</span><span class="s3">=</span><span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">nrows</span><span class="s3">=</span><span class="s6">1010</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">size </span><span class="s3">== </span><span class="s6">1010 </span><span class="s3">* </span><span class="s6">10</span>


<span class="s2">def </span><span class="s1">test_float_precision_round_trip_with_text</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-15140</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s4">&quot;a&quot;</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;round_trip&quot;</span><span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">0</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">]}))</span>


<span class="s2">def </span><span class="s1">test_large_difference_in_columns</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-14125</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s1">count </span><span class="s3">= </span><span class="s6">10000</span>
    <span class="s1">large_row </span><span class="s3">= (</span><span class="s4">&quot;X,&quot; </span><span class="s3">* </span><span class="s1">count</span><span class="s3">)[:-</span><span class="s6">1</span><span class="s3">] + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">normal_row </span><span class="s3">= </span><span class="s4">&quot;XXXXXX XXXXXX,111111111111111</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">test_input </span><span class="s3">= (</span><span class="s1">large_row </span><span class="s3">+ </span><span class="s1">normal_row </span><span class="s3">* </span><span class="s6">6</span><span class="s3">)[:-</span><span class="s6">1</span><span class="s3">]</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">test_input</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">usecols</span><span class="s3">=[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">rows </span><span class="s3">= </span><span class="s1">test_input</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s1">row</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot;,&quot;</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">row </span><span class="s2">in </span><span class="s1">rows</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_data_after_quote</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-15910</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s1">data </span><span class="s3">= </span><span class="s4">'a</span><span class="s2">\n</span><span class="s4">1</span><span class="s2">\n</span><span class="s4">&quot;b&quot;a'</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s4">&quot;1&quot;</span><span class="s3">, </span><span class="s4">&quot;ba&quot;</span><span class="s3">]})</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_comment_whitespace_delimited</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">test_input </span><span class="s3">= </span><span class="s4">&quot;&quot;&quot;</span><span class="s2">\ 
</span><span class="s4">1 2 
2 2 3 
3 2 3 # 3 fields 
4 2 3# 3 fields 
5 2 # 2 fields 
6 2# 2 fields 
7 # 1 field, NaN 
8# 1 field, NaN 
9 2 3 # skipped line 
# comment&quot;&quot;&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span>
        <span class="s1">ParserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Skipping line&quot;</span><span class="s3">, </span><span class="s1">check_stacklevel</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
            <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">test_input</span><span class="s3">),</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;#&quot;</span><span class="s3">,</span>
            <span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">delimiter</span><span class="s3">=</span><span class="s4">&quot;</span><span class="s2">\\</span><span class="s4">s+&quot;</span><span class="s3">,</span>
            <span class="s1">skiprows</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
            <span class="s1">on_bad_lines</span><span class="s3">=</span><span class="s4">&quot;warn&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">6</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">7</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">], [</span><span class="s6">8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_file_like_no_next</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># gh-16530: the file-like need not have a &quot;next&quot; or &quot;__next__&quot;</span>
    <span class="s5"># attribute despite having an &quot;__iter__&quot; attribute.</span>
    <span class="s5">#</span>
    <span class="s5"># NOTE: This is only true for the C engine, not Python engine.</span>
    <span class="s2">class </span><span class="s1">NoNextBuffer</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">__next__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">AttributeError</span><span class="s3">(</span><span class="s4">&quot;No next method&quot;</span><span class="s3">)</span>

        <span class="s1">next </span><span class="s3">= </span><span class="s1">__next__</span>

    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">data </span><span class="s3">= </span><span class="s4">&quot;a</span><span class="s2">\n</span><span class="s4">1&quot;</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">]})</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">NoNextBuffer</span><span class="s3">(</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_buffer_rd_bytes_bad_unicode</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-22748</span>
    <span class="s1">t </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s7">b&quot;</span><span class="s2">\xB0</span><span class="s7">&quot;</span><span class="s3">)</span>
    <span class="s1">t </span><span class="s3">= </span><span class="s1">TextIOWrapper</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;ascii&quot;</span><span class="s3">, </span><span class="s1">errors</span><span class="s3">=</span><span class="s4">&quot;surrogateescape&quot;</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'utf-8' codec can't encode character&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">UnicodeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">c_parser_only</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;UTF-8&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;tar_suffix&quot;</span><span class="s3">, [</span><span class="s4">&quot;.tar&quot;</span><span class="s3">, </span><span class="s4">&quot;.tar.gz&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_read_tarfile</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">csv_dir_path</span><span class="s3">, </span><span class="s1">tar_suffix</span><span class="s3">):</span>
    <span class="s5"># see gh-16530</span>
    <span class="s5">#</span>
    <span class="s5"># Unfortunately, Python's CSV library can't handle</span>
    <span class="s5"># tarfile objects (expects string, not bytes when</span>
    <span class="s5"># iterating through a file-like).</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">tar_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">csv_dir_path</span><span class="s3">, </span><span class="s4">&quot;tar_csv&quot; </span><span class="s3">+ </span><span class="s1">tar_suffix</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">tarfile</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">tar_path</span><span class="s3">, </span><span class="s4">&quot;r&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">tar</span><span class="s3">:</span>
        <span class="s1">data_file </span><span class="s3">= </span><span class="s1">tar</span><span class="s3">.</span><span class="s1">extractfile</span><span class="s3">(</span><span class="s4">&quot;tar_data.csv&quot;</span><span class="s3">)</span>

        <span class="s1">out </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">data_file</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">]})</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">out</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_chunk_whitespace_on_boundary</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-9735: this issue is C parser-specific (bug when</span>
    <span class="s5"># parsing whitespace and characters at chunk boundary)</span>
    <span class="s5">#</span>
    <span class="s5"># This test case has a field too large for the Python parser / CSV library.</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s1">chunk1 </span><span class="s3">= </span><span class="s4">&quot;a&quot; </span><span class="s3">* (</span><span class="s6">1024 </span><span class="s3">* </span><span class="s6">256 </span><span class="s3">- </span><span class="s6">2</span><span class="s3">) + </span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">a&quot;</span>
    <span class="s1">chunk2 </span><span class="s3">= </span><span class="s4">&quot;</span><span class="s2">\n </span><span class="s4">a&quot;</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">chunk1 </span><span class="s3">+ </span><span class="s1">chunk2</span><span class="s3">), </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s4">&quot;a&quot; </span><span class="s3">* (</span><span class="s6">1024 </span><span class="s3">* </span><span class="s6">256 </span><span class="s3">- </span><span class="s6">2</span><span class="s3">), </span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot; a&quot;</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_file_handles_mmap</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">csv1</span><span class="s3">):</span>
    <span class="s5"># gh-14418</span>
    <span class="s5">#</span>
    <span class="s5"># Don't close user provided file handles.</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>

    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">csv1</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">mmap</span><span class="s3">.</span><span class="s1">mmap</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">fileno</span><span class="s3">(), </span><span class="s6">0</span><span class="s3">, </span><span class="s1">access</span><span class="s3">=</span><span class="s1">mmap</span><span class="s3">.</span><span class="s1">ACCESS_READ</span><span class="s3">) </span><span class="s2">as </span><span class="s1">m</span><span class="s3">:</span>
            <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
            <span class="s2">assert not </span><span class="s1">m</span><span class="s3">.</span><span class="s1">closed</span>


<span class="s2">def </span><span class="s1">test_file_binary_mode</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># see gh-23779</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]])</span>

    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;1,2,3</span><span class="s2">\n</span><span class="s4">4,5,6&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_unix_style_breaks</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># GH 11020</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">, </span><span class="s1">newline</span><span class="s3">=</span><span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s4">&quot;blah</span><span class="s2">\n\n</span><span class="s4">col_1,col_2,col_3</span><span class="s2">\n\n</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">skiprows</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s4">&quot;c&quot;</span><span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;col_1&quot;</span><span class="s3">, </span><span class="s4">&quot;col_2&quot;</span><span class="s3">, </span><span class="s4">&quot;col_3&quot;</span><span class="s3">])</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;float_precision&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;legacy&quot;</span><span class="s3">, </span><span class="s4">&quot;high&quot;</span><span class="s3">, </span><span class="s4">&quot;round_trip&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;data,thousands,decimal&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot;A|B|C 
1|2,334.01|5 
10|13|10. 
&quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;,&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;&quot;&quot;A|B|C 
1|2.334,01|5 
10|13|10, 
&quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;.&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;,&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_1000_sep_with_decimal</span><span class="s3">(</span>
    <span class="s1">c_parser_only</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">thousands</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">, </span><span class="s1">float_precision</span>
<span class="s3">):</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s4">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">], </span><span class="s4">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">2334.01</span><span class="s3">, </span><span class="s6">13</span><span class="s3">], </span><span class="s4">&quot;C&quot;</span><span class="s3">: [</span><span class="s6">5</span><span class="s3">, </span><span class="s6">10.0</span><span class="s3">]})</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span>
        <span class="s1">StringIO</span><span class="s3">(</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">sep</span><span class="s3">=</span><span class="s4">&quot;|&quot;</span><span class="s3">,</span>
        <span class="s1">thousands</span><span class="s3">=</span><span class="s1">thousands</span><span class="s3">,</span>
        <span class="s1">decimal</span><span class="s3">=</span><span class="s1">decimal</span><span class="s3">,</span>
        <span class="s1">float_precision</span><span class="s3">=</span><span class="s1">float_precision</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_float_precision_options</span><span class="s3">(</span><span class="s1">c_parser_only</span><span class="s3">):</span>
    <span class="s5"># GH 17154, 36228</span>
    <span class="s1">parser </span><span class="s3">= </span><span class="s1">c_parser_only</span>
    <span class="s1">s </span><span class="s3">= </span><span class="s4">&quot;foo</span><span class="s2">\n</span><span class="s4">243.164</span><span class="s2">\n</span><span class="s4">&quot;</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">s</span><span class="s3">))</span>
    <span class="s1">df2 </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">s</span><span class="s3">), </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;high&quot;</span><span class="s3">)</span>

    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">df2</span><span class="s3">)</span>

    <span class="s1">df3 </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">s</span><span class="s3">), </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;legacy&quot;</span><span class="s3">)</span>

    <span class="s2">assert not </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">] == </span><span class="s1">df3</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Unrecognized float_precision option: junk&quot;</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">parser</span><span class="s3">.</span><span class="s1">read_csv</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">s</span><span class="s3">), </span><span class="s1">float_precision</span><span class="s3">=</span><span class="s4">&quot;junk&quot;</span><span class="s3">)</span>
</pre>
</body>
</html>