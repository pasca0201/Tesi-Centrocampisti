<html>
<head>
<title>test_reflection.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_reflection.py</font>
</center></td></tr></table>
<pre><span class="s0"># testing/suite/test_reflection.py</span>
<span class="s0"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="s0"># &lt;see AUTHORS file&gt;</span>
<span class="s0">#</span>
<span class="s0"># This module is part of SQLAlchemy and is released under</span>
<span class="s0"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="s0"># mypy: ignore-errors</span>

<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">import </span><span class="s1">operator</span>
<span class="s2">import </span><span class="s1">re</span>

<span class="s2">import </span><span class="s1">sqlalchemy </span><span class="s2">as </span><span class="s1">sa</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">config</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">engines</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">eq_</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">expect_raises</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">expect_raises_message</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">expect_warnings</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">fixtures</span>
<span class="s2">from </span><span class="s3">.. </span><span class="s2">import </span><span class="s1">is_</span>
<span class="s2">from </span><span class="s3">..</span><span class="s1">provision </span><span class="s2">import </span><span class="s1">get_temp_table_name</span>
<span class="s2">from </span><span class="s3">..</span><span class="s1">provision </span><span class="s2">import </span><span class="s1">temp_table_keyword_args</span>
<span class="s2">from </span><span class="s3">..</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">Column</span>
<span class="s2">from </span><span class="s3">..</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">Table</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">event</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">ForeignKey</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">func</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">Identity</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">inspect</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">Integer</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">MetaData</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">String</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">testing</span>
<span class="s2">from </span><span class="s3">... </span><span class="s2">import </span><span class="s1">types </span><span class="s2">as </span><span class="s1">sql_types</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">Inspector</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">ObjectKind</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">engine </span><span class="s2">import </span><span class="s1">ObjectScope</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">exc </span><span class="s2">import </span><span class="s1">NoSuchTableError</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">exc </span><span class="s2">import </span><span class="s1">UnreflectableTableError</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">DDL</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">Index</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">elements </span><span class="s2">import </span><span class="s1">quoted_name</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">sql</span><span class="s3">.</span><span class="s1">schema </span><span class="s2">import </span><span class="s1">BLANK_SCHEMA</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">ComparesIndexes</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">ComparesTables</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">is_false</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">is_true</span>
<span class="s2">from </span><span class="s3">...</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">mock</span>


<span class="s1">metadata</span><span class="s3">, </span><span class="s1">users </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>


<span class="s2">class </span><span class="s1">OneConnectionTablesTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TablesTest</span><span class="s3">):</span>
    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">setup_bind</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s0"># TODO: when temp tables are subject to server reset,</span>
        <span class="s0"># this will also have to disable that server reset from</span>
        <span class="s0"># happening</span>
        <span class="s2">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">requirements</span><span class="s3">.</span><span class="s1">independent_connections</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s2">from </span><span class="s1">sqlalchemy </span><span class="s2">import </span><span class="s1">pool</span>

            <span class="s2">return </span><span class="s1">engines</span><span class="s3">.</span><span class="s1">testing_engine</span><span class="s3">(</span>
                <span class="s1">options</span><span class="s3">=</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">poolclass</span><span class="s3">=</span><span class="s1">pool</span><span class="s3">.</span><span class="s1">StaticPool</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">=</span><span class="s4">&quot;class&quot;</span><span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span>


<span class="s2">class </span><span class="s1">HasTableTest</span><span class="s3">(</span><span class="s1">OneConnectionTablesTest</span><span class="s3">):</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;test_table&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;test_table_s&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span><span class="s3">:</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">define_views</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">has_temp_table</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">define_temp_tables</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_views</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s4">&quot;CREATE VIEW vv AS SELECT id, data FROM test_table&quot;</span>

        <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;after_create&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s1">query</span><span class="s3">))</span>
        <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;before_drop&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;DROP VIEW vv&quot;</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">query </span><span class="s3">= (</span>
                <span class="s4">&quot;CREATE VIEW %s.vv AS SELECT id, data FROM %s.test_table_s&quot;</span>
                <span class="s3">% (</span>
                    <span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
                    <span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;after_create&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s1">query</span><span class="s3">))</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s4">&quot;before_drop&quot;</span><span class="s3">,</span>
                <span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;DROP VIEW %s.vv&quot; </span><span class="s3">% (</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)),</span>
            <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">temp_table_name</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">get_temp_table_name</span><span class="s3">(</span>
            <span class="s1">config</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">, </span><span class="s4">f&quot;user_tmp_</span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_temp_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">kw </span><span class="s3">= </span><span class="s1">temp_table_keyword_args</span><span class="s3">(</span><span class="s1">config</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s1">table_name </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">user_tmp </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">table_name</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">INT</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">VARCHAR</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
            <span class="s3">**</span><span class="s1">kw</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span><span class="s3">.</span><span class="s1">enabled</span>
            <span class="s2">and </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temporary_views</span><span class="s3">.</span><span class="s1">enabled</span>
        <span class="s3">):</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
                <span class="s1">user_tmp</span><span class="s3">,</span>
                <span class="s4">&quot;after_create&quot;</span><span class="s3">,</span>
                <span class="s1">DDL</span><span class="s3">(</span>
                    <span class="s4">&quot;create temporary view user_tmp_v as &quot;</span>
                    <span class="s4">&quot;select * from user_tmp_%s&quot; </span><span class="s3">% </span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">user_tmp</span><span class="s3">, </span><span class="s4">&quot;before_drop&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;drop view user_tmp_v&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_has_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_table&quot;</span><span class="s3">))</span>
            <span class="s1">is_false</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_table_s&quot;</span><span class="s3">))</span>
            <span class="s1">is_false</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;nonexistent_table&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_has_table_cache</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">))</span>
        <span class="s1">nt </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;new_table&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;col&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">))</span>
        <span class="s1">is_false</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;new_table&quot;</span><span class="s3">))</span>
        <span class="s1">nt</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">is_false</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;new_table&quot;</span><span class="s3">))</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;new_table&quot;</span><span class="s3">))</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">nt</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_has_table_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s1">is_false</span><span class="s3">(</span>
                <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span>
                    <span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
                <span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s1">is_true</span><span class="s3">(</span>
                <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span>
                    <span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_table_s&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
                <span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s1">is_false</span><span class="s3">(</span>
                <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span>
                    <span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;nonexistent_table&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_has_table_nonexistent_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">begin</span><span class="s3">() </span><span class="s2">as </span><span class="s1">conn</span><span class="s3">:</span>
            <span class="s1">is_false</span><span class="s3">(</span>
                <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span>
                    <span class="s1">conn</span><span class="s3">, </span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s4">&quot;nonexistent_schema&quot;</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">views</span>
    <span class="s2">def </span><span class="s1">test_has_table_view</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;vv&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">has_temp_table</span>
    <span class="s2">def </span><span class="s1">test_has_table_temp_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">temp_table_name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s1">temp_table_name</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">has_temp_table</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temporary_views</span>
    <span class="s2">def </span><span class="s1">test_has_table_temp_view</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">views</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_has_table_view_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_table</span><span class="s3">(</span><span class="s4">&quot;vv&quot;</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">HasIndexTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TablesTest</span><span class="s3">):</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">tt </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;test_table&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data2&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
        <span class="s3">)</span>
        <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;my_idx&quot;</span><span class="s3">, </span><span class="s1">tt</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">tt </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;test_table&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;my_idx_s&quot;</span><span class="s3">, </span><span class="s1">tt</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s1">kind </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span><span class="s4">&quot;dialect&quot;</span><span class="s3">, </span><span class="s4">&quot;inspector&quot;</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;kind&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_has_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">conn</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;dialect&quot;</span><span class="s3">:</span>
            <span class="s2">return lambda </span><span class="s3">*</span><span class="s1">a</span><span class="s3">, **</span><span class="s1">k</span><span class="s3">: </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">has_index</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">, *</span><span class="s1">a</span><span class="s3">, **</span><span class="s1">k</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">conn</span><span class="s3">).</span><span class="s1">has_index</span>

    <span class="s3">@</span><span class="s1">kind</span>
    <span class="s2">def </span><span class="s1">test_has_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">meth </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_index</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx&quot;</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_s&quot;</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;nonexistent_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx&quot;</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;nonexistent_idx&quot;</span><span class="s3">)</span>

        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_2&quot;</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table_2&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_3&quot;</span><span class="s3">)</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;my_idx_2&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">test_table</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">data2</span><span class="s3">)</span>
        <span class="s1">tbl </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;test_table_2&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;foo&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;my_idx_3&quot;</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">idx</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">tbl</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">kind </span><span class="s3">== </span><span class="s4">&quot;inspector&quot;</span><span class="s3">:</span>
                <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_2&quot;</span><span class="s3">)</span>
                <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table_2&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_3&quot;</span><span class="s3">)</span>
                <span class="s1">meth</span><span class="s3">.</span><span class="s1">__self__</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s2">assert </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_2&quot;</span><span class="s3">) </span><span class="s2">is True</span>
            <span class="s2">assert </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table_2&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_3&quot;</span><span class="s3">) </span><span class="s2">is True</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">tbl</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
            <span class="s1">idx</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s3">@</span><span class="s1">kind</span>
    <span class="s2">def </span><span class="s1">test_has_index_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">meth </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_index</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_s&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span>
            <span class="s4">&quot;nonexistent_table&quot;</span><span class="s3">, </span><span class="s4">&quot;my_idx_s&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">meth</span><span class="s3">(</span>
            <span class="s4">&quot;test_table&quot;</span><span class="s3">, </span><span class="s4">&quot;nonexistent_idx_s&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s3">)</span>


<span class="s2">class </span><span class="s1">BizarroCharacterFKResolutionTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TestBase</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;tests for #10275&quot;&quot;&quot;</span>

    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">,), (</span><span class="s4">&quot;(3)&quot;</span><span class="s3">,), (</span><span class="s4">&quot;col%p&quot;</span><span class="s3">,), (</span><span class="s4">&quot;[brack]&quot;</span><span class="s3">,), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;columnname&quot;</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">variation</span><span class="s3">(</span><span class="s4">&quot;use_composite&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s4">&quot;plain&quot;</span><span class="s3">,),</span>
        <span class="s3">(</span><span class="s4">&quot;(2)&quot;</span><span class="s3">,),</span>
        <span class="s3">(</span><span class="s4">&quot;per % cent&quot;</span><span class="s3">,),</span>
        <span class="s3">(</span><span class="s4">&quot;[brackets]&quot;</span><span class="s3">,),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;tablename&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_fk_ref</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">use_composite</span><span class="s3">, </span><span class="s1">tablename</span><span class="s3">, </span><span class="s1">columnname</span>
    <span class="s3">):</span>
        <span class="s1">tt </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">tablename</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s1">columnname</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">use_composite</span><span class="s3">:</span>
            <span class="s1">tt</span><span class="s3">.</span><span class="s1">append_column</span><span class="s3">(</span><span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id2&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">use_composite</span><span class="s3">:</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;other&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;ref&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;ref2&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">ForeignKeyConstraint</span><span class="s3">([</span><span class="s4">&quot;ref&quot;</span><span class="s3">, </span><span class="s4">&quot;ref2&quot;</span><span class="s3">], [</span><span class="s1">tt</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">id</span><span class="s3">, </span><span class="s1">tt</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">id2</span><span class="s3">]),</span>
                <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;other&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;ref&quot;</span><span class="s3">, </span><span class="s1">ForeignKey</span><span class="s3">(</span><span class="s1">tt</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">id</span><span class="s3">)),</span>
                <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>

        <span class="s1">o2 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;other&quot;</span><span class="s3">, </span><span class="s1">m2</span><span class="s3">, </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">t1 </span><span class="s3">= </span><span class="s1">m2</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s1">tablename</span><span class="s3">]</span>

        <span class="s2">assert </span><span class="s1">o2</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">references</span><span class="s3">(</span><span class="s1">t1</span><span class="s3">.</span><span class="s1">c</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">use_composite</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">o2</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">ref2</span><span class="s3">.</span><span class="s1">references</span><span class="s3">(</span><span class="s1">t1</span><span class="s3">.</span><span class="s1">c</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>


<span class="s2">class </span><span class="s1">QuotedNameArgumentTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TablesTest</span><span class="s3">):</span>
    <span class="s1">run_create_tables </span><span class="s3">= </span><span class="s4">&quot;once&quot;</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;quote ' one&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;related_id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">PrimaryKeyConstraint</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;pk quote ' one&quot;</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;ix quote ' one&quot;</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(</span>
                <span class="s4">&quot;data&quot;</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;uq quote' one&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">ForeignKeyConstraint</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s4">&quot;id&quot;</span><span class="s3">], [</span><span class="s4">&quot;related.id&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;fk quote ' one&quot;</span>
            <span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span><span class="s4">&quot;name != 'foo'&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;ck quote ' one&quot;</span><span class="s3">),</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s4">r&quot;&quot;&quot;quote ' one comment&quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">symbol_names_w_double_quote</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">'quote &quot; two'</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;related_id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">PrimaryKeyConstraint</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">'pk quote &quot; two'</span><span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">(</span><span class="s4">'ix quote &quot; two'</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(</span>
                    <span class="s4">&quot;data&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">'uq quote&quot; two'</span><span class="s3">,</span>
                <span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">ForeignKeyConstraint</span><span class="s3">(</span>
                    <span class="s3">[</span><span class="s4">&quot;id&quot;</span><span class="s3">], [</span><span class="s4">&quot;related.id&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s4">'fk quote &quot; two'</span>
                <span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span><span class="s4">&quot;name != 'foo'&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">'ck quote &quot; two '</span><span class="s3">),</span>
                <span class="s1">comment</span><span class="s3">=</span><span class="s4">r&quot;&quot;&quot;quote &quot; two comment&quot;&quot;&quot;</span><span class="s3">,</span>
                <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;related&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;related&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_column_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">symbol_names_w_double_quote</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
                <span class="s1">names </span><span class="s3">= [</span>
                    <span class="s4">&quot;quote ' one&quot;</span><span class="s3">,</span>
                    <span class="s4">'quote &quot; two'</span><span class="s3">,</span>
                <span class="s3">]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">names </span><span class="s3">= [</span>
                    <span class="s4">&quot;quote ' one&quot;</span><span class="s3">,</span>
                <span class="s3">]</span>
            <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">names</span><span class="s3">:</span>
                <span class="s1">query </span><span class="s3">= </span><span class="s4">&quot;CREATE VIEW %s AS SELECT * FROM %s&quot; </span><span class="s3">% (</span>
                    <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">identifier_preparer</span><span class="s3">.</span><span class="s1">quote</span><span class="s3">(</span>
                        <span class="s4">&quot;view %s&quot; </span><span class="s3">% </span><span class="s1">name</span>
                    <span class="s3">),</span>
                    <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">identifier_preparer</span><span class="s3">.</span><span class="s1">quote</span><span class="s3">(</span><span class="s1">name</span><span class="s3">),</span>
                <span class="s3">)</span>

                <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;after_create&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s1">query</span><span class="s3">))</span>
                <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
                    <span class="s1">metadata</span><span class="s3">,</span>
                    <span class="s4">&quot;before_drop&quot;</span><span class="s3">,</span>
                    <span class="s1">DDL</span><span class="s3">(</span>
                        <span class="s4">&quot;DROP VIEW %s&quot;</span>
                        <span class="s3">% </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">identifier_preparer</span><span class="s3">.</span><span class="s1">quote</span><span class="s3">(</span>
                            <span class="s4">&quot;view %s&quot; </span><span class="s3">% </span><span class="s1">name</span>
                        <span class="s3">)</span>
                    <span class="s3">),</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">quote_fixtures</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
            <span class="s3">(</span><span class="s4">&quot;quote ' one&quot;</span><span class="s3">,),</span>
            <span class="s3">(</span><span class="s4">'quote &quot; two'</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">symbol_names_w_double_quote</span><span class="s3">),</span>
        <span class="s3">)(</span><span class="s1">fn</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s2">def </span><span class="s1">test_get_table_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_table_options</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">expect_raises</span><span class="s3">(</span><span class="s1">NotImplementedError</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_column_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_view_definition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_view_definition</span><span class="s3">(</span><span class="s4">&quot;view %s&quot; </span><span class="s3">% </span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s2">def </span><span class="s1">test_get_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s2">def </span><span class="s1">test_get_pk_constraint</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_pk_constraint</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s2">def </span><span class="s1">test_get_foreign_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s2">def </span><span class="s1">test_get_indexes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_unique_constraints</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_unique_constraints</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_table_comment</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">quote_fixtures</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">check_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_check_constraints</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_check_constraints</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_multi_combination</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
    <span class="s1">schema </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s2">None</span><span class="s3">,</span>
        <span class="s3">(</span>
            <span class="s2">lambda</span><span class="s3">: </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;schema&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">scope </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">DEFAULT</span><span class="s3">,</span>
        <span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">TEMPORARY</span><span class="s3">,</span>
        <span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;scope&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">kind </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">TABLE</span><span class="s3">,</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">VIEW</span><span class="s3">,</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">MATERIALIZED_VIEW</span><span class="s3">,</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY_VIEW</span><span class="s3">,</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">TABLE </span><span class="s3">| </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">VIEW</span><span class="s3">,</span>
        <span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">TABLE </span><span class="s3">| </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">MATERIALIZED_VIEW</span><span class="s3">,</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;kind&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">filter_names </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_filter&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">schema</span><span class="s3">(</span><span class="s1">scope</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">(</span><span class="s1">filter_names</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">))))</span>


<span class="s2">class </span><span class="s1">ComponentReflectionTest</span><span class="s3">(</span><span class="s1">ComparesTables</span><span class="s3">, </span><span class="s1">OneConnectionTablesTest</span><span class="s3">):</span>
    <span class="s1">run_inserts </span><span class="s3">= </span><span class="s1">run_deletes </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">cls</span><span class="s3">.</span><span class="s1">define_reflected_tables</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">define_reflected_tables</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_reflected_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">schema</span><span class="s3">:</span>
            <span class="s1">schema_prefix </span><span class="s3">= </span><span class="s1">schema </span><span class="s3">+ </span><span class="s4">&quot;.&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema_prefix </span><span class="s3">= </span><span class="s4">&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">self_referential_foreign_keys</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">parent_id_args </span><span class="s3">= (</span>
                <span class="s1">ForeignKey</span><span class="s3">(</span>
                    <span class="s4">&quot;%susers.user_id&quot; </span><span class="s3">% </span><span class="s1">schema_prefix</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;user_id_fk&quot;</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">parent_id_args </span><span class="s3">= ()</span>
        <span class="s1">users </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;users&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;user_id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">INT</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;test1&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">CHAR</span><span class="s3">(</span><span class="s5">5</span><span class="s3">), </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;test2&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Float</span><span class="s3">(), </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;parent_user_id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, *</span><span class="s1">parent_id_args</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span>
                <span class="s4">&quot;test2 &gt; 0&quot;</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;zz_test2_gt_zero&quot;</span><span class="s3">,</span>
                <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;users check constraint&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span><span class="s4">&quot;test2 &lt;= 1000&quot;</span><span class="s3">),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;dingalings&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;dingaling_id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span>
                <span class="s4">&quot;address_id&quot;</span><span class="s3">,</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">,</span>
                <span class="s1">ForeignKey</span><span class="s3">(</span>
                    <span class="s4">&quot;%semail_addresses.address_id&quot; </span><span class="s3">% </span><span class="s1">schema_prefix</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;zz_email_add_id_fg&quot;</span><span class="s3">,</span>
                    <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;di fk comment&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span>
                <span class="s4">&quot;id_user&quot;</span><span class="s3">,</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">,</span>
                <span class="s1">ForeignKey</span><span class="s3">(</span><span class="s4">&quot;%susers.user_id&quot; </span><span class="s3">% </span><span class="s1">schema_prefix</span><span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">), </span><span class="s1">unique</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span>
                <span class="s4">&quot;address_id &gt; 0 AND address_id &lt; 1000&quot;</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;address_id_gt_zero&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(</span>
                <span class="s4">&quot;address_id&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;dingaling_id&quot;</span><span class="s3">,</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;zz_dingalings_multiple&quot;</span><span class="s3">,</span>
                <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;di unique comment&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;email_addresses&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;address_id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;remote_user_id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">ForeignKey</span><span class="s3">(</span><span class="s1">users</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">user_id</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;email_address&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">PrimaryKeyConstraint</span><span class="s3">(</span>
                <span class="s4">&quot;address_id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;email_ad_pk&quot;</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;ea pk comment&quot;</span>
            <span class="s3">),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;comment_test&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;id comment&quot;</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">), </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;data % comment&quot;</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span>
                <span class="s4">&quot;d2&quot;</span><span class="s3">,</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">),</span>
                <span class="s1">comment</span><span class="s3">=</span><span class="s4">r&quot;&quot;&quot;Comment types type speedily ' &quot; \ '' Fun!&quot;&quot;&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;d3&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">42</span><span class="s3">), </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;Comment</span><span class="s2">\n</span><span class="s4">with</span><span class="s2">\r</span><span class="s4">escapes&quot;</span><span class="s3">),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s4">r&quot;&quot;&quot;the test % ' &quot; \ table comment&quot;&quot;&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;no_constraints&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;no</span><span class="s2">\n</span><span class="s4">constraints</span><span class="s2">\r</span><span class="s4">has</span><span class="s2">\f</span><span class="s4">escaped</span><span class="s2">\v</span><span class="s4">comment&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">cross_schema_fk_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">schema </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">Table</span><span class="s3">(</span>
                    <span class="s4">&quot;local_table&quot;</span><span class="s3">,</span>
                    <span class="s1">metadata</span><span class="s3">,</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
                    <span class="s1">Column</span><span class="s3">(</span>
                        <span class="s4">&quot;remote_id&quot;</span><span class="s3">,</span>
                        <span class="s1">ForeignKey</span><span class="s3">(</span>
                            <span class="s4">&quot;%s.remote_table_2.id&quot; </span><span class="s3">% </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
                        <span class="s3">),</span>
                    <span class="s3">),</span>
                    <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                    <span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">default_schema_name</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">Table</span><span class="s3">(</span>
                    <span class="s4">&quot;remote_table&quot;</span><span class="s3">,</span>
                    <span class="s1">metadata</span><span class="s3">,</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                    <span class="s1">Column</span><span class="s3">(</span>
                        <span class="s4">&quot;local_id&quot;</span><span class="s3">,</span>
                        <span class="s1">ForeignKey</span><span class="s3">(</span>
                            <span class="s4">&quot;%s.local_table.id&quot;</span>
                            <span class="s3">% </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">default_schema_name</span>
                        <span class="s3">),</span>
                    <span class="s3">),</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
                    <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
                    <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>
                <span class="s1">Table</span><span class="s3">(</span>
                    <span class="s4">&quot;remote_table_2&quot;</span><span class="s3">,</span>
                    <span class="s1">metadata</span><span class="s3">,</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
                    <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
                    <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;users_t_idx&quot;</span><span class="s3">, </span><span class="s1">users</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">test1</span><span class="s3">, </span><span class="s1">users</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">test2</span><span class="s3">, </span><span class="s1">unique</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">Index</span><span class="s3">(</span>
                <span class="s4">&quot;users_all_idx&quot;</span><span class="s3">, </span><span class="s1">users</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">user_id</span><span class="s3">, </span><span class="s1">users</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">test2</span><span class="s3">, </span><span class="s1">users</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">test1</span>
            <span class="s3">)</span>

            <span class="s2">if not </span><span class="s1">schema</span><span class="s3">:</span>
                <span class="s0"># test_needs_fk is at the moment to force MySQL InnoDB</span>
                <span class="s1">noncol_idx_test_nopk </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
                    <span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">,</span>
                    <span class="s1">metadata</span><span class="s3">,</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;q&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)),</span>
                    <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>

                <span class="s1">noncol_idx_test_pk </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
                    <span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">,</span>
                    <span class="s1">metadata</span><span class="s3">,</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                    <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;q&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)),</span>
                    <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>

                <span class="s2">if </span><span class="s3">(</span>
                    <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">indexes_with_ascdesc</span><span class="s3">.</span><span class="s1">enabled</span>
                    <span class="s2">and </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_indexes_with_ascdesc</span><span class="s3">.</span><span class="s1">enabled</span>
                <span class="s3">):</span>
                    <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;noncol_idx_nopk&quot;</span><span class="s3">, </span><span class="s1">noncol_idx_test_nopk</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">q</span><span class="s3">.</span><span class="s1">desc</span><span class="s3">())</span>
                    <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;noncol_idx_pk&quot;</span><span class="s3">, </span><span class="s1">noncol_idx_test_pk</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">q</span><span class="s3">.</span><span class="s1">desc</span><span class="s3">())</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_column_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">define_views</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">schema </span><span class="s2">and </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">cls</span><span class="s3">.</span><span class="s1">define_temp_tables</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">temp_table_name</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">get_temp_table_name</span><span class="s3">(</span>
            <span class="s1">config</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">, </span><span class="s4">f&quot;user_tmp_</span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span><span class="s2">}</span><span class="s4">&quot;</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_temp_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">kw </span><span class="s3">= </span><span class="s1">temp_table_keyword_args</span><span class="s3">(</span><span class="s1">config</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s1">table_name </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">user_tmp </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">table_name</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">INT</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">VARCHAR</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;foo&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">INT</span><span class="s3">),</span>
            <span class="s0"># disambiguate temp table unique constraint names.  this is</span>
            <span class="s0"># pretty arbitrary for a generic dialect however we are doing</span>
            <span class="s0"># it to suit SQL Server which will produce name conflicts for</span>
            <span class="s0"># unique constraints created against temp tables in different</span>
            <span class="s0"># databases.</span>
            <span class="s0"># https://www.arbinada.com/en/node/1645</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">f&quot;user_tmp_uq_</span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;user_tmp_ix&quot;</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s3">),</span>
            <span class="s3">**</span><span class="s1">kw</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span><span class="s3">.</span><span class="s1">enabled</span>
            <span class="s2">and </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temporary_views</span><span class="s3">.</span><span class="s1">enabled</span>
        <span class="s3">):</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
                <span class="s1">user_tmp</span><span class="s3">,</span>
                <span class="s4">&quot;after_create&quot;</span><span class="s3">,</span>
                <span class="s1">DDL</span><span class="s3">(</span>
                    <span class="s4">&quot;create temporary view user_tmp_v as &quot;</span>
                    <span class="s4">&quot;select * from user_tmp_%s&quot; </span><span class="s3">% </span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">user_tmp</span><span class="s3">, </span><span class="s4">&quot;before_drop&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;drop view user_tmp_v&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_views</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">materialized_views</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">materialized </span><span class="s3">= {</span><span class="s4">&quot;dingalings&quot;</span><span class="s3">}</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">materialized </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">table_name </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">):</span>
            <span class="s1">fullname </span><span class="s3">= </span><span class="s1">table_name</span>
            <span class="s2">if </span><span class="s1">schema</span><span class="s3">:</span>
                <span class="s1">fullname </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">schema</span><span class="s2">}</span><span class="s4">.</span><span class="s2">{</span><span class="s1">table_name</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s1">view_name </span><span class="s3">= </span><span class="s1">fullname </span><span class="s3">+ </span><span class="s4">&quot;_v&quot;</span>
            <span class="s1">prefix </span><span class="s3">= </span><span class="s4">&quot;MATERIALIZED &quot; </span><span class="s2">if </span><span class="s1">table_name </span><span class="s2">in </span><span class="s1">materialized </span><span class="s2">else </span><span class="s4">&quot;&quot;</span>
            <span class="s1">query </span><span class="s3">= (</span>
                <span class="s4">f&quot;CREATE </span><span class="s2">{</span><span class="s1">prefix</span><span class="s2">}</span><span class="s4">VIEW </span><span class="s2">{</span><span class="s1">view_name</span><span class="s2">} </span><span class="s4">AS SELECT * FROM </span><span class="s2">{</span><span class="s1">fullname</span><span class="s2">}</span><span class="s4">&quot;</span>
            <span class="s3">)</span>

            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;after_create&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s1">query</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">table_name </span><span class="s2">in </span><span class="s1">materialized</span><span class="s3">:</span>
                <span class="s1">index_name </span><span class="s3">= </span><span class="s4">&quot;mat_index&quot;</span>
                <span class="s2">if </span><span class="s1">schema </span><span class="s2">and </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">against</span><span class="s3">(</span><span class="s4">&quot;oracle&quot;</span><span class="s3">):</span>
                    <span class="s1">index_name </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">schema</span><span class="s2">}</span><span class="s4">.</span><span class="s2">{</span><span class="s1">index_name</span><span class="s2">}</span><span class="s4">&quot;</span>
                <span class="s1">idx </span><span class="s3">= </span><span class="s4">f&quot;CREATE INDEX </span><span class="s2">{</span><span class="s1">index_name</span><span class="s2">} </span><span class="s4">ON </span><span class="s2">{</span><span class="s1">view_name</span><span class="s2">}</span><span class="s4">(data)&quot;</span>
                <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span><span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;after_create&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">))</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
                <span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;before_drop&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">f&quot;DROP </span><span class="s2">{</span><span class="s1">prefix</span><span class="s2">}</span><span class="s4">VIEW </span><span class="s2">{</span><span class="s1">view_name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">TABLE </span><span class="s2">in </span><span class="s1">kind</span><span class="s3">:</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">tables</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">VIEW </span><span class="s2">in </span><span class="s1">kind</span><span class="s3">:</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">views</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">MATERIALIZED_VIEW </span><span class="s2">in </span><span class="s1">kind</span><span class="s3">:</span>
            <span class="s1">res</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_column_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">materialized</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>
            <span class="s1">views</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>
        <span class="s2">elif not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">materialized_views</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">views</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">materialized</span><span class="s3">)</span>
            <span class="s1">materialized</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">values</span><span class="s3">):</span>
        <span class="s1">scope_filter </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">_</span><span class="s3">: </span><span class="s2">True  </span><span class="s0"># noqa: E731</span>
        <span class="s2">if </span><span class="s1">scope </span><span class="s2">is </span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">DEFAULT</span><span class="s3">:</span>
            <span class="s1">scope_filter </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">k</span><span class="s3">: </span><span class="s4">&quot;tmp&quot; </span><span class="s2">not in </span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]  </span><span class="s0"># noqa: E731</span>
        <span class="s2">if </span><span class="s1">scope </span><span class="s2">is </span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">TEMPORARY</span><span class="s3">:</span>
            <span class="s1">scope_filter </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">k</span><span class="s3">: </span><span class="s4">&quot;tmp&quot; </span><span class="s2">in </span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]  </span><span class="s0"># noqa: E731</span>

        <span class="s1">removed </span><span class="s3">= {</span>
            <span class="s2">None</span><span class="s3">: {</span><span class="s4">&quot;remote_table&quot;</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">},</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">: {</span>
                <span class="s4">&quot;local_table&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">(),</span>
            <span class="s3">},</span>
        <span class="s3">}</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">cross_schema_fk_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">removed</span><span class="s3">[</span><span class="s2">None</span><span class="s3">].</span><span class="s1">add</span><span class="s3">(</span><span class="s4">&quot;local_table&quot;</span><span class="s3">)</span>
            <span class="s1">removed</span><span class="s3">[</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">].</span><span class="s1">update</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s4">&quot;remote_table&quot;</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">]</span>
            <span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflection</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">removed</span><span class="s3">[</span><span class="s2">None</span><span class="s3">].</span><span class="s1">update</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">]</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s2">not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflection</span><span class="s3">.</span><span class="s1">enabled</span>
            <span class="s2">or not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_names</span><span class="s3">.</span><span class="s1">enabled</span>
        <span class="s3">):</span>
            <span class="s1">removed</span><span class="s3">[</span><span class="s2">None</span><span class="s3">].</span><span class="s1">update</span><span class="s3">([</span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()])</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temporary_views</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">removed</span><span class="s3">[</span><span class="s2">None</span><span class="s3">].</span><span class="s1">update</span><span class="s3">([</span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">])</span>

        <span class="s1">res </span><span class="s3">= {</span>
            <span class="s1">k</span><span class="s3">: </span><span class="s1">v</span>
            <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">scope_filter</span><span class="s3">(</span><span class="s1">k</span><span class="s3">)</span>
            <span class="s2">and </span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] </span><span class="s2">not in </span><span class="s1">removed</span><span class="s3">[</span><span class="s1">schema</span><span class="s3">]</span>
            <span class="s2">and </span><span class="s3">(</span><span class="s2">not </span><span class="s1">filter_names </span><span class="s2">or </span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] </span><span class="s2">in </span><span class="s1">filter_names</span><span class="s3">)</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">exp_options</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">exp_comments</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">empty </span><span class="s3">= {</span><span class="s4">&quot;text&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">}</span>
        <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): {</span>
                <span class="s4">&quot;text&quot;</span><span class="s3">: </span><span class="s4">r&quot;&quot;&quot;the test % ' &quot; \ table comment&quot;&quot;&quot;</span>
            <span class="s3">},</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): {</span>
                <span class="s4">&quot;text&quot;</span><span class="s3">: </span><span class="s4">&quot;no</span><span class="s2">\n</span><span class="s4">constraints</span><span class="s2">\r</span><span class="s4">has</span><span class="s2">\f</span><span class="s4">escaped</span><span class="s2">\v</span><span class="s4">comment&quot;</span>
            <span class="s3">},</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): </span><span class="s1">empty</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">exp_columns</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">def </span><span class="s1">col</span><span class="s3">(</span>
            <span class="s1">name</span><span class="s3">, </span><span class="s1">auto</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">default</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= {</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;autoincrement&quot;</span><span class="s3">: </span><span class="s1">auto</span><span class="s3">,</span>
                <span class="s4">&quot;type&quot;</span><span class="s3">: </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
                <span class="s4">&quot;default&quot;</span><span class="s3">: </span><span class="s1">default</span><span class="s3">,</span>
                <span class="s4">&quot;comment&quot;</span><span class="s3">: </span><span class="s1">comment</span><span class="s3">,</span>
                <span class="s4">&quot;nullable&quot;</span><span class="s3">: </span><span class="s1">nullable</span><span class="s3">,</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s1">auto </span><span class="s3">== </span><span class="s4">&quot;omit&quot;</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;autoincrement&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">res</span>

        <span class="s2">def </span><span class="s1">pk</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
            <span class="s1">kw </span><span class="s3">= {</span><span class="s4">&quot;auto&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;default&quot;</span><span class="s3">: </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s4">&quot;nullable&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">}</span>
            <span class="s2">return </span><span class="s1">col</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>

        <span class="s1">materialized </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): [</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;dingaling_id&quot;</span><span class="s3">, </span><span class="s1">auto</span><span class="s3">=</span><span class="s4">&quot;omit&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;address_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;id_user&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">),</span>
            <span class="s3">]</span>
        <span class="s3">}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): [</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;address_id&quot;</span><span class="s3">, </span><span class="s1">auto</span><span class="s3">=</span><span class="s4">&quot;omit&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;remote_user_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;email_address&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): [</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;user_id&quot;</span><span class="s3">, </span><span class="s1">auto</span><span class="s3">=</span><span class="s4">&quot;omit&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;test1&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;test2&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;parent_user_id&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): [</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">auto</span><span class="s3">=</span><span class="s4">&quot;omit&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;foo&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): [</span>
                <span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;user_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;test1&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;test2&quot;</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;parent_user_id&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): [</span>
                <span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;dingaling_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;address_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;id_user&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): [</span>
                <span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;address_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;remote_user_id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;email_address&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): [</span>
                <span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;id comment&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;data % comment&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span>
                    <span class="s4">&quot;d2&quot;</span><span class="s3">,</span>
                    <span class="s1">comment</span><span class="s3">=</span><span class="s4">r&quot;&quot;&quot;Comment types type speedily ' &quot; \ '' Fun!&quot;&quot;&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;d3&quot;</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;Comment</span><span class="s2">\n</span><span class="s4">with</span><span class="s2">\r</span><span class="s4">escapes&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): [</span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">)],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): [</span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">), </span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">), </span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;remote_id&quot;</span><span class="s3">)],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): [</span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">), </span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;local_id&quot;</span><span class="s3">), </span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">)],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): [</span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">), </span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">)],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): [</span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;q&quot;</span><span class="s3">)],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): [</span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">), </span><span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;q&quot;</span><span class="s3">)],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): [</span>
                <span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">),</span>
                <span class="s1">col</span><span class="s3">(</span><span class="s4">&quot;foo&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
        <span class="s3">}</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_required_column_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;type&quot;</span><span class="s3">, </span><span class="s4">&quot;nullable&quot;</span><span class="s3">, </span><span class="s4">&quot;default&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">exp_pks</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">def </span><span class="s1">pk</span><span class="s3">(*</span><span class="s1">cols</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">{</span>
                <span class="s4">&quot;constrained_columns&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">),</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;comment&quot;</span><span class="s3">: </span><span class="s1">comment</span><span class="s3">,</span>
            <span class="s3">}</span>

        <span class="s1">empty </span><span class="s3">= </span><span class="s1">pk</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">materialized_views_reflect_pk</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;dingaling_id&quot;</span><span class="s3">)}</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;user_id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;dingaling_id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span>
                <span class="s4">&quot;address_id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;email_ad_pk&quot;</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;ea pk comment&quot;</span>
            <span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): </span><span class="s1">empty</span><span class="s3">,</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): </span><span class="s1">pk</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">),</span>
        <span class="s3">}</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflects_pk_names</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">tables</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">val</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">val</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] = </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_required_pk_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">exp_fks</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">class </span><span class="s1">tt</span><span class="s3">:</span>
            <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s3">(</span>
                    <span class="s1">other </span><span class="s2">is None</span>
                    <span class="s2">or </span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">default_schema_name </span><span class="s3">== </span><span class="s1">other</span>
                <span class="s3">)</span>

        <span class="s2">def </span><span class="s1">fk</span><span class="s3">(</span>
            <span class="s1">cols</span><span class="s3">,</span>
            <span class="s1">ref_col</span><span class="s3">,</span>
            <span class="s1">ref_table</span><span class="s3">,</span>
            <span class="s1">ref_schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s2">return </span><span class="s3">{</span>
                <span class="s4">&quot;constrained_columns&quot;</span><span class="s3">: </span><span class="s1">cols</span><span class="s3">,</span>
                <span class="s4">&quot;referred_columns&quot;</span><span class="s3">: </span><span class="s1">ref_col</span><span class="s3">,</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;options&quot;</span><span class="s3">: </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
                <span class="s4">&quot;referred_schema&quot;</span><span class="s3">: (</span>
                    <span class="s1">ref_schema </span><span class="s2">if </span><span class="s1">ref_schema </span><span class="s2">is not None else </span><span class="s1">tt</span><span class="s3">()</span>
                <span class="s3">),</span>
                <span class="s4">&quot;referred_table&quot;</span><span class="s3">: </span><span class="s1">ref_table</span><span class="s3">,</span>
                <span class="s4">&quot;comment&quot;</span><span class="s3">: </span><span class="s1">comment</span><span class="s3">,</span>
            <span class="s3">}</span>

        <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): []}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): [],</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): [</span>
                <span class="s1">fk</span><span class="s3">([</span><span class="s4">&quot;parent_user_id&quot;</span><span class="s3">], [</span><span class="s4">&quot;user_id&quot;</span><span class="s3">], </span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;user_id_fk&quot;</span><span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): [</span>
                <span class="s1">fk</span><span class="s3">([</span><span class="s4">&quot;id_user&quot;</span><span class="s3">], [</span><span class="s4">&quot;user_id&quot;</span><span class="s3">], </span><span class="s4">&quot;users&quot;</span><span class="s3">),</span>
                <span class="s1">fk</span><span class="s3">(</span>
                    <span class="s3">[</span><span class="s4">&quot;address_id&quot;</span><span class="s3">],</span>
                    <span class="s3">[</span><span class="s4">&quot;address_id&quot;</span><span class="s3">],</span>
                    <span class="s4">&quot;email_addresses&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;zz_email_add_id_fg&quot;</span><span class="s3">,</span>
                    <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;di fk comment&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): [</span>
                <span class="s1">fk</span><span class="s3">([</span><span class="s4">&quot;remote_user_id&quot;</span><span class="s3">], [</span><span class="s4">&quot;user_id&quot;</span><span class="s3">], </span><span class="s4">&quot;users&quot;</span><span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): [</span>
                <span class="s1">fk</span><span class="s3">(</span>
                    <span class="s3">[</span><span class="s4">&quot;remote_id&quot;</span><span class="s3">],</span>
                    <span class="s3">[</span><span class="s4">&quot;id&quot;</span><span class="s3">],</span>
                    <span class="s4">&quot;remote_table_2&quot;</span><span class="s3">,</span>
                    <span class="s1">ref_schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): [</span>
                <span class="s1">fk</span><span class="s3">([</span><span class="s4">&quot;local_id&quot;</span><span class="s3">], [</span><span class="s4">&quot;id&quot;</span><span class="s3">], </span><span class="s4">&quot;local_table&quot;</span><span class="s3">, </span><span class="s1">ref_schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): [],</span>
        <span class="s3">}</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">self_referential_foreign_keys</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">tables</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">)].</span><span class="s1">clear</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">named_constraints</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">vals </span><span class="s2">in </span><span class="s1">tables</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
                <span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">vals</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">val</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] </span><span class="s2">is not </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">:</span>
                        <span class="s1">val</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] = </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_required_fk_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span>
            <span class="s4">&quot;name&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;constrained_columns&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;referred_schema&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;referred_table&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;referred_columns&quot;</span><span class="s3">,</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">exp_indexes</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">def </span><span class="s1">idx</span><span class="s3">(</span>
            <span class="s3">*</span><span class="s1">cols</span><span class="s3">,</span>
            <span class="s1">name</span><span class="s3">,</span>
            <span class="s1">unique</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">column_sorting</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">duplicates</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">fk</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s1">fk_req </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_keys_reflect_as_index</span>
            <span class="s1">dup_req </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_constraints_reflect_as_index</span>
            <span class="s1">sorting_expression </span><span class="s3">= (</span>
                <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_indexes_with_ascdesc_as_expression</span>
            <span class="s3">)</span>

            <span class="s2">if </span><span class="s3">(</span><span class="s1">fk </span><span class="s2">and not </span><span class="s1">fk_req</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">) </span><span class="s2">or </span><span class="s3">(</span>
                <span class="s1">duplicates </span><span class="s2">and not </span><span class="s1">dup_req</span><span class="s3">.</span><span class="s1">enabled</span>
            <span class="s3">):</span>
                <span class="s2">return </span><span class="s3">()</span>
            <span class="s1">res </span><span class="s3">= {</span>
                <span class="s4">&quot;unique&quot;</span><span class="s3">: </span><span class="s1">unique</span><span class="s3">,</span>
                <span class="s4">&quot;column_names&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">),</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;dialect_options&quot;</span><span class="s3">: </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
                <span class="s4">&quot;include_columns&quot;</span><span class="s3">: [],</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s1">column_sorting</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;column_sorting&quot;</span><span class="s3">] = </span><span class="s1">column_sorting</span>
                <span class="s2">if </span><span class="s1">sorting_expression</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
                    <span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;expressions&quot;</span><span class="s3">] = </span><span class="s1">orig </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;column_names&quot;</span><span class="s3">]</span>
                    <span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;column_names&quot;</span><span class="s3">] = [</span>
                        <span class="s2">None if </span><span class="s1">c </span><span class="s2">in </span><span class="s1">column_sorting </span><span class="s2">else </span><span class="s1">c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">orig</span>
                    <span class="s3">]</span>

            <span class="s2">if </span><span class="s1">duplicates</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;duplicates_constraint&quot;</span><span class="s3">] = </span><span class="s1">name</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">res</span><span class="s3">]</span>

        <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): []}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): [],</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">materialized</span><span class="s3">:</span>
            <span class="s1">materialized</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">)].</span><span class="s1">extend</span><span class="s3">(</span>
                <span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;mat_index&quot;</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;parent_user_id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;user_id_fk&quot;</span><span class="s3">, </span><span class="s1">fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;user_id&quot;</span><span class="s3">, </span><span class="s4">&quot;test2&quot;</span><span class="s3">, </span><span class="s4">&quot;test1&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;users_all_idx&quot;</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;test1&quot;</span><span class="s3">, </span><span class="s4">&quot;test2&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;users_t_idx&quot;</span><span class="s3">, </span><span class="s1">unique</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">unique</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">duplicates</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;id_user&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span>
                    <span class="s4">&quot;address_id&quot;</span><span class="s3">,</span>
                    <span class="s4">&quot;dingaling_id&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;zz_dingalings_multiple&quot;</span><span class="s3">,</span>
                    <span class="s1">unique</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                    <span class="s1">duplicates</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;email_address&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;remote_user_id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;remote_id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;local_id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span>
                    <span class="s4">&quot;q&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;noncol_idx_nopk&quot;</span><span class="s3">,</span>
                    <span class="s1">column_sorting</span><span class="s3">={</span><span class="s4">&quot;q&quot;</span><span class="s3">: (</span><span class="s4">&quot;desc&quot;</span><span class="s3">,)},</span>
                <span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span>
                    <span class="s4">&quot;q&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;noncol_idx_pk&quot;</span><span class="s3">, </span><span class="s1">column_sorting</span><span class="s3">={</span><span class="s4">&quot;q&quot;</span><span class="s3">: (</span><span class="s4">&quot;desc&quot;</span><span class="s3">,)}</span>
                <span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): [</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span><span class="s4">&quot;foo&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;user_tmp_ix&quot;</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">idx</span><span class="s3">(</span>
                    <span class="s4">&quot;name&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">f&quot;user_tmp_uq_</span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                    <span class="s1">duplicates</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                    <span class="s1">unique</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">],</span>
        <span class="s3">}</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s2">not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">indexes_with_ascdesc</span><span class="s3">.</span><span class="s1">enabled</span>
            <span class="s2">or not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_indexes_with_ascdesc</span><span class="s3">.</span><span class="s1">enabled</span>
        <span class="s3">):</span>
            <span class="s1">tables</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">)].</span><span class="s1">clear</span><span class="s3">()</span>
            <span class="s1">tables</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">)].</span><span class="s1">clear</span><span class="s3">()</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_required_index_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">, </span><span class="s4">&quot;unique&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">exp_ucs</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">all_</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">def </span><span class="s1">uc</span><span class="s3">(</span>
            <span class="s3">*</span><span class="s1">cols</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">duplicates_index</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">is_index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s2">None</span>
        <span class="s3">):</span>
            <span class="s1">req </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_index_reflect_as_unique_constraints</span>
            <span class="s2">if </span><span class="s1">is_index </span><span class="s2">and not </span><span class="s1">req</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s3">()</span>
            <span class="s1">res </span><span class="s3">= {</span>
                <span class="s4">&quot;column_names&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">),</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s3">,</span>
                <span class="s4">&quot;comment&quot;</span><span class="s3">: </span><span class="s1">comment</span><span class="s3">,</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s1">duplicates_index</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">[</span><span class="s4">&quot;duplicates_index&quot;</span><span class="s3">] = </span><span class="s1">duplicates_index</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">res</span><span class="s3">]</span>

        <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): []}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): [],</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">uc</span><span class="s3">(</span>
                    <span class="s4">&quot;test1&quot;</span><span class="s3">,</span>
                    <span class="s4">&quot;test2&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;users_t_idx&quot;</span><span class="s3">,</span>
                    <span class="s1">duplicates_index</span><span class="s3">=</span><span class="s4">&quot;users_t_idx&quot;</span><span class="s3">,</span>
                    <span class="s1">is_index</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): [</span>
                <span class="s3">*</span><span class="s1">uc</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s1">duplicates_index</span><span class="s3">=</span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s3">*</span><span class="s1">uc</span><span class="s3">(</span>
                    <span class="s4">&quot;address_id&quot;</span><span class="s3">,</span>
                    <span class="s4">&quot;dingaling_id&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;zz_dingalings_multiple&quot;</span><span class="s3">,</span>
                    <span class="s1">duplicates_index</span><span class="s3">=</span><span class="s4">&quot;zz_dingalings_multiple&quot;</span><span class="s3">,</span>
                    <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;di unique comment&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): [</span>
                <span class="s3">*</span><span class="s1">uc</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">f&quot;user_tmp_uq_</span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
            <span class="s3">],</span>
        <span class="s3">}</span>
        <span class="s2">if </span><span class="s1">all_</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s3">{**</span><span class="s1">materialized</span><span class="s3">, **</span><span class="s1">views</span><span class="s3">, **</span><span class="s1">tables</span><span class="s3">}</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">res</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_required_unique_cst_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">exp_ccs</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">scope</span><span class="s3">=</span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
        <span class="s1">filter_names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s2">class </span><span class="s1">tt</span><span class="s3">(</span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= (</span>
                    <span class="s1">other</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
                    <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;(&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
                    <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;)&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
                    <span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;`&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
                <span class="s3">)</span>
                <span class="s2">return </span><span class="s1">self </span><span class="s2">in </span><span class="s1">res</span>

        <span class="s2">def </span><span class="s1">cc</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s1">tt</span><span class="s3">(</span><span class="s1">text</span><span class="s3">), </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">name</span><span class="s3">, </span><span class="s4">&quot;comment&quot;</span><span class="s3">: </span><span class="s1">comment</span><span class="s3">}</span>

        <span class="s0"># print({1: &quot;test2 &gt; (0)::double precision&quot;} == {1: tt(&quot;test2 &gt; 0&quot;)})</span>
        <span class="s0"># assert 0</span>
        <span class="s1">materialized </span><span class="s3">= {(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">): []}</span>
        <span class="s1">views </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">): [],</span>
        <span class="s3">}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_views</span><span class="s3">(</span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">): [</span>
                <span class="s1">cc</span><span class="s3">(</span><span class="s4">&quot;test2 &lt;= 1000&quot;</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">),</span>
                <span class="s1">cc</span><span class="s3">(</span>
                    <span class="s4">&quot;test2 &gt; 0&quot;</span><span class="s3">,</span>
                    <span class="s4">&quot;zz_test2_gt_zero&quot;</span><span class="s3">,</span>
                    <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;users check constraint&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">): [</span>
                <span class="s1">cc</span><span class="s3">(</span>
                    <span class="s4">&quot;address_id &gt; 0 and address_id &lt; 1000&quot;</span><span class="s3">,</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;address_id_gt_zero&quot;</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;local_table&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;remote_table_2&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">): [],</span>
            <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()): [],</span>
        <span class="s3">}</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_kind</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">, </span><span class="s1">tables</span><span class="s3">, </span><span class="s1">views</span><span class="s3">, </span><span class="s1">materialized</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_resolve_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">filter_names</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_required_cc_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;sqltext&quot;</span><span class="s3">}</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_schema_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_schema_names</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s2">def </span><span class="s1">test_has_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">))</span>
        <span class="s1">is_false</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s4">&quot;sa_fake_schema_foo&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_schema_names_w_translate_map</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;test #7300&quot;&quot;&quot;</span>

        <span class="s1">connection </span><span class="s3">= </span><span class="s1">connection</span><span class="s3">.</span><span class="s1">execution_options</span><span class="s3">(</span>
            <span class="s1">schema_translate_map</span><span class="s3">={</span>
                <span class="s4">&quot;foo&quot;</span><span class="s3">: </span><span class="s4">&quot;bar&quot;</span><span class="s3">,</span>
                <span class="s1">BLANK_SCHEMA</span><span class="s3">: </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_schema_names</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s2">def </span><span class="s1">test_has_schema_w_translate_map</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">connection </span><span class="s3">= </span><span class="s1">connection</span><span class="s3">.</span><span class="s1">execution_options</span><span class="s3">(</span>
            <span class="s1">schema_translate_map</span><span class="s3">={</span>
                <span class="s4">&quot;foo&quot;</span><span class="s3">: </span><span class="s4">&quot;bar&quot;</span><span class="s3">,</span>
                <span class="s1">BLANK_SCHEMA</span><span class="s3">: </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">))</span>
        <span class="s1">is_false</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s4">&quot;sa_fake_schema_foo&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_create_delete</span>
    <span class="s2">def </span><span class="s1">test_schema_cache</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">is_false</span><span class="s3">(</span><span class="s4">&quot;foo_bar&quot; </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_schema_names</span><span class="s3">())</span>
        <span class="s1">is_false</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s4">&quot;foo_bar&quot;</span><span class="s3">))</span>
        <span class="s1">connection</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;CREATE SCHEMA foo_bar&quot;</span><span class="s3">))</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">is_false</span><span class="s3">(</span><span class="s4">&quot;foo_bar&quot; </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_schema_names</span><span class="s3">())</span>
            <span class="s1">is_false</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s4">&quot;foo_bar&quot;</span><span class="s3">))</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;foo_bar&quot; </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_schema_names</span><span class="s3">())</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">has_schema</span><span class="s3">(</span><span class="s4">&quot;foo_bar&quot;</span><span class="s3">))</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">connection</span><span class="s3">.</span><span class="s1">execute</span><span class="s3">(</span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;DROP SCHEMA foo_bar&quot;</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s2">def </span><span class="s1">test_dialect_initialize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">engine </span><span class="s3">= </span><span class="s1">engines</span><span class="s3">.</span><span class="s1">testing_engine</span><span class="s3">()</span>
        <span class="s1">inspect</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">, </span><span class="s4">&quot;default_schema_name&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schema_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_default_schema_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">default_schema_name</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">default_schema_name</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s2">None</span><span class="s3">,</span>
        <span class="s3">(</span><span class="s4">&quot;foreign_key&quot;</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_reflection</span><span class="s3">),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;order_by&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s2">False</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_table_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">order_by</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">_ignore_tables </span><span class="s3">= {</span>
            <span class="s4">&quot;comment_test&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;local_table&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;remote_table&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;remote_table_2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;no_constraints&quot;</span><span class="s3">,</span>
        <span class="s3">}</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">order_by</span><span class="s3">:</span>
            <span class="s1">tables </span><span class="s3">= [</span>
                <span class="s1">rec</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s2">for </span><span class="s1">rec </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_sorted_table_and_fkc_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">rec</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tables </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">table_names </span><span class="s3">= [</span><span class="s1">t </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">tables </span><span class="s2">if </span><span class="s1">t </span><span class="s2">not in </span><span class="s1">_ignore_tables</span><span class="s3">]</span>

        <span class="s2">if </span><span class="s1">order_by </span><span class="s3">== </span><span class="s4">&quot;foreign_key&quot;</span><span class="s3">:</span>
            <span class="s1">answer </span><span class="s3">= [</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">, </span><span class="s4">&quot;dingalings&quot;</span><span class="s3">]</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">table_names</span><span class="s3">, </span><span class="s1">answer</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">answer </span><span class="s3">= [</span><span class="s4">&quot;dingalings&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">]</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">table_names</span><span class="s3">), </span><span class="s1">answer</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s2">False</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_view_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">table_names </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_view_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">materialized_views</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">table_names</span><span class="s3">), [</span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">])</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_materialized_view_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">), [</span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">answer </span><span class="s3">= [</span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">, </span><span class="s4">&quot;users_v&quot;</span><span class="s3">]</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">table_names</span><span class="s3">), </span><span class="s1">answer</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_names</span>
    <span class="s2">def </span><span class="s1">test_get_temp_table_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">temp_table_names </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_temp_table_names</span><span class="s3">()</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">temp_table_names</span><span class="s3">), [</span><span class="s4">f&quot;user_tmp_</span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">ident</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temporary_views</span>
    <span class="s2">def </span><span class="s1">test_get_temp_view_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">temp_table_names </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_temp_view_names</span><span class="s3">()</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">temp_table_names</span><span class="s3">), [</span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_comments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_test_get_comments</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_get_comments_with_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_test_get_comments</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_test_get_comments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">exp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exp_comments</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s4">&quot;comment_test&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">)],</span>
        <span class="s3">)</span>

        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">)],</span>
        <span class="s3">)</span>

        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s4">&quot;comment_test&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;comment_test&quot;</span><span class="s3">)],</span>
        <span class="s3">)</span>

        <span class="s1">no_cst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">no_constraints</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s1">no_cst</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">no_cst</span><span class="s3">)],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span><span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">True</span><span class="s3">,</span>
            <span class="s2">True</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas </span><span class="s3">+ </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_views,use_schema&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_views</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">users</span><span class="s3">, </span><span class="s1">addresses </span><span class="s3">= (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">users</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">email_addresses</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">use_views</span><span class="s3">:</span>
            <span class="s1">table_names </span><span class="s3">= [</span><span class="s4">&quot;users_v&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">table_names </span><span class="s3">= [</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">]</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">table </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">table_names</span><span class="s3">, (</span><span class="s1">users</span><span class="s3">, </span><span class="s1">addresses</span><span class="s3">)):</span>
            <span class="s1">schema_name </span><span class="s3">= </span><span class="s1">schema</span>
            <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema_name</span><span class="s3">)</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">))</span>

            <span class="s0"># should be in order</span>

            <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">col </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">table</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">):</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">cols</span><span class="s3">[</span><span class="s1">i</span><span class="s3">][</span><span class="s4">&quot;name&quot;</span><span class="s3">])</span>
                <span class="s1">ctype </span><span class="s3">= </span><span class="s1">cols</span><span class="s3">[</span><span class="s1">i</span><span class="s3">][</span><span class="s4">&quot;type&quot;</span><span class="s3">].</span><span class="s1">__class__</span>
                <span class="s1">ctype_def </span><span class="s3">= </span><span class="s1">col</span><span class="s3">.</span><span class="s1">type</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ctype_def</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">types</span><span class="s3">.</span><span class="s1">TypeEngine</span><span class="s3">):</span>
                    <span class="s1">ctype_def </span><span class="s3">= </span><span class="s1">ctype_def</span><span class="s3">.</span><span class="s1">__class__</span>

                <span class="s0"># Oracle returns Date for DateTime.</span>

                <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">against</span><span class="s3">(</span><span class="s4">&quot;oracle&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">ctype_def </span><span class="s2">in </span><span class="s3">(</span>
                    <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Date</span><span class="s3">,</span>
                    <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">DateTime</span><span class="s3">,</span>
                <span class="s3">):</span>
                    <span class="s1">ctype_def </span><span class="s3">= </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Date</span>

                <span class="s0"># assert that the desired type and return type share</span>
                <span class="s0"># a base within one of the generic types.</span>

                <span class="s1">is_true</span><span class="s3">(</span>
                    <span class="s1">len</span><span class="s3">(</span>
                        <span class="s1">set</span><span class="s3">(</span><span class="s1">ctype</span><span class="s3">.</span><span class="s1">__mro__</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">ctype_def</span><span class="s3">.</span><span class="s1">__mro__</span><span class="s3">)</span>
                        <span class="s3">.</span><span class="s1">intersection</span><span class="s3">(</span>
                            <span class="s3">[</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">,</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Numeric</span><span class="s3">,</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">DateTime</span><span class="s3">,</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Date</span><span class="s3">,</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Time</span><span class="s3">,</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">String</span><span class="s3">,</span>
                                <span class="s1">sql_types</span><span class="s3">.</span><span class="s1">_Binary</span><span class="s3">,</span>
                            <span class="s3">]</span>
                        <span class="s3">)</span>
                    <span class="s3">)</span>
                    <span class="s3">&gt; </span><span class="s5">0</span><span class="s3">,</span>
                    <span class="s4">&quot;%s(%s), %s(%s)&quot;</span>
                    <span class="s3">% (</span><span class="s1">col</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">col</span><span class="s3">.</span><span class="s1">type</span><span class="s3">, </span><span class="s1">cols</span><span class="s3">[</span><span class="s1">i</span><span class="s3">][</span><span class="s4">&quot;name&quot;</span><span class="s3">], </span><span class="s1">ctype</span><span class="s3">),</span>
                <span class="s3">)</span>

                <span class="s2">if not </span><span class="s1">col</span><span class="s3">.</span><span class="s1">primary_key</span><span class="s3">:</span>
                    <span class="s2">assert </span><span class="s1">cols</span><span class="s3">[</span><span class="s1">i</span><span class="s3">][</span><span class="s4">&quot;default&quot;</span><span class="s3">] </span><span class="s2">is None</span>

        <span class="s0"># The case of a table with no column</span>
        <span class="s0"># is tested below in TableNoColumnsTest</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflection</span>
    <span class="s2">def </span><span class="s1">test_reflect_table_temp_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">table_name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">user_tmp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s1">table_name</span><span class="s3">]</span>

        <span class="s1">reflected_user_tmp </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">table_name</span><span class="s3">, </span><span class="s1">MetaData</span><span class="s3">(), </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">assert_tables_equal</span><span class="s3">(</span>
            <span class="s1">user_tmp</span><span class="s3">, </span><span class="s1">reflected_user_tmp</span><span class="s3">, </span><span class="s1">strict_constraints</span><span class="s3">=</span><span class="s2">False</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_temp_table_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">table_name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">user_tmp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s1">table_name</span><span class="s3">]</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">)</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">cols</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">col </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">user_tmp</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">):</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">col</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">cols</span><span class="s3">[</span><span class="s1">i</span><span class="s3">][</span><span class="s4">&quot;name&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_column_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temporary_views</span>
    <span class="s2">def </span><span class="s1">test_get_temp_view_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;user_tmp_v&quot;</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">([</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">], [</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;foo&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">,), (</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">primary_key_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_pk_constraint</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">users</span><span class="s3">, </span><span class="s1">addresses </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">users</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">email_addresses</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">exp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exp_pks</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>

        <span class="s1">users_cons </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_pk_constraint</span><span class="s3">(</span><span class="s1">users</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">users_cons</span><span class="s3">], [</span><span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">users</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)]], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_pk_keys</span>
        <span class="s3">)</span>

        <span class="s1">addr_cons </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_pk_constraint</span><span class="s3">(</span><span class="s1">addresses</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">exp_cols </span><span class="s3">= </span><span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">addresses</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)][</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">addr_cons</span><span class="s3">[</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">], </span><span class="s1">exp_cols</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflects_pk_names</span><span class="s3">.</span><span class="s1">fail_if</span><span class="s3">():</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">addr_cons</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">], </span><span class="s4">&quot;email_ad_pk&quot;</span><span class="s3">)</span>

        <span class="s1">no_cst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">no_constraints</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_pk_constraint</span><span class="s3">(</span><span class="s1">no_cst</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)],</span>
            <span class="s3">[</span><span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">no_cst</span><span class="s3">)]],</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_required_pk_keys</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">,), (</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_foreign_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">users</span><span class="s3">, </span><span class="s1">addresses </span><span class="s3">= (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">users</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">email_addresses</span><span class="s3">)</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">expected_schema </span><span class="s3">= </span><span class="s1">schema</span>
        <span class="s0"># users</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">self_referential_foreign_keys</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">users_fkeys </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s1">users</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s1">fkey1 </span><span class="s3">= </span><span class="s1">users_fkeys</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

            <span class="s2">with </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">named_constraints</span><span class="s3">.</span><span class="s1">fail_if</span><span class="s3">():</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">], </span><span class="s4">&quot;user_id_fk&quot;</span><span class="s3">)</span>

            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_schema&quot;</span><span class="s3">], </span><span class="s1">expected_schema</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_table&quot;</span><span class="s3">], </span><span class="s1">users</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;user_id&quot;</span><span class="s3">])</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;parent_user_id&quot;</span><span class="s3">])</span>

        <span class="s0"># addresses</span>
        <span class="s1">addr_fkeys </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s1">addresses</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">fkey1 </span><span class="s3">= </span><span class="s1">addr_fkeys</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s2">with </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">implicitly_named_constraints</span><span class="s3">.</span><span class="s1">fail_if</span><span class="s3">():</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] </span><span class="s2">is not None</span><span class="s3">)</span>

        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_schema&quot;</span><span class="s3">], </span><span class="s1">expected_schema</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_table&quot;</span><span class="s3">], </span><span class="s1">users</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;user_id&quot;</span><span class="s3">])</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;remote_user_id&quot;</span><span class="s3">])</span>

        <span class="s1">no_cst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">no_constraints</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s1">no_cst</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">), [])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">cross_schema_fk_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_get_inter_schema_foreign_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">local_table</span><span class="s3">, </span><span class="s1">remote_table</span><span class="s3">, </span><span class="s1">remote_table_2 </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">(</span>
            <span class="s4">&quot;%s.local_table&quot; </span><span class="s3">% </span><span class="s1">connection</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">default_schema_name</span><span class="s3">,</span>
            <span class="s4">&quot;%s.remote_table&quot; </span><span class="s3">% </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s4">&quot;%s.remote_table_2&quot; </span><span class="s3">% </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">local_fkeys </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s1">local_table</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">local_fkeys</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">fkey1 </span><span class="s3">= </span><span class="s1">local_fkeys</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_schema&quot;</span><span class="s3">], </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_table&quot;</span><span class="s3">], </span><span class="s1">remote_table_2</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;referred_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;id&quot;</span><span class="s3">])</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">[</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;remote_id&quot;</span><span class="s3">])</span>

        <span class="s1">remote_fkeys </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span>
            <span class="s1">remote_table</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">remote_fkeys</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">fkey2 </span><span class="s3">= </span><span class="s1">remote_fkeys</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">is_true</span><span class="s3">(</span>
            <span class="s1">fkey2</span><span class="s3">[</span><span class="s4">&quot;referred_schema&quot;</span><span class="s3">]</span>
            <span class="s2">in </span><span class="s3">(</span>
                <span class="s2">None</span><span class="s3">,</span>
                <span class="s1">connection</span><span class="s3">.</span><span class="s1">dialect</span><span class="s3">.</span><span class="s1">default_schema_name</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey2</span><span class="s3">[</span><span class="s4">&quot;referred_table&quot;</span><span class="s3">], </span><span class="s1">local_table</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey2</span><span class="s3">[</span><span class="s4">&quot;referred_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;id&quot;</span><span class="s3">])</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey2</span><span class="s3">[</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">], [</span><span class="s4">&quot;local_id&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">,), (</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_indexes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s0"># The database may decide to create indexes for foreign keys, etc.</span>
        <span class="s0"># so there may be more indexes than expected.</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">indexes </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">exp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exp_indexes</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span>
            <span class="s1">indexes</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">)], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_index_keys</span>
        <span class="s3">)</span>

        <span class="s1">no_cst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">no_constraints</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s1">no_cst</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s1">exp</span><span class="s3">[(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">no_cst</span><span class="s3">)],</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_required_index_keys</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s4">&quot;noncol_idx_test_nopk&quot;</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_nopk&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;noncol_idx_test_pk&quot;</span><span class="s3">, </span><span class="s4">&quot;noncol_idx_pk&quot;</span><span class="s3">),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;tname,ixname&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">indexes_with_ascdesc</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_indexes_with_ascdesc</span>
    <span class="s2">def </span><span class="s1">test_get_noncol_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">tname</span><span class="s3">, </span><span class="s1">ixname</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">indexes </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s1">tname</span><span class="s3">)</span>
        <span class="s0"># reflecting an index that has &quot;x DESC&quot; in it as the column.</span>
        <span class="s0"># the DB may or may not give us &quot;x&quot;, but make sure we get the index</span>
        <span class="s0"># back, it has a name, it's connected to the table.</span>
        <span class="s1">expected_indexes </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exp_indexes</span><span class="s3">()[(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">tname</span><span class="s3">)]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span><span class="s1">indexes</span><span class="s3">, </span><span class="s1">expected_indexes</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_index_keys</span><span class="s3">)</span>

        <span class="s1">t </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s1">tname</span><span class="s3">, </span><span class="s1">MetaData</span><span class="s3">(), </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">indexes</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">is_</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">indexes</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">table</span><span class="s3">, </span><span class="s1">t</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">indexes</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">name</span><span class="s3">, </span><span class="s1">ixname</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_temp_table_unique_constraints</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_unique_constraints</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">exp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exp_ucs</span><span class="s3">(</span><span class="s1">all_</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)[(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span><span class="s1">reflected</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_index_keys</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">temp_table_reflect_indexes</span>
    <span class="s2">def </span><span class="s1">test_get_temp_table_indexes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">table_name </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">temp_table_name</span><span class="s3">()</span>
        <span class="s1">indexes </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s1">table_name</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">ind </span><span class="s2">in </span><span class="s1">indexes</span><span class="s3">:</span>
            <span class="s1">ind</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;dialect_options&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= [</span>
            <span class="s3">{</span><span class="s4">&quot;unique&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;foo&quot;</span><span class="s3">], </span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;user_tmp_ix&quot;</span><span class="s3">}</span>
        <span class="s3">]</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflects_included_columns</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">expected</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">&quot;include_columns&quot;</span><span class="s3">] = []</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">idx </span><span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">indexes </span><span class="s2">if </span><span class="s1">idx</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] == </span><span class="s4">&quot;user_tmp_ix&quot;</span><span class="s3">],</span>
            <span class="s1">expected</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">,), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_unique_constraints</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s0"># SQLite dialect needs to parse the names of the constraints</span>
        <span class="s0"># separately from what it gets from PRAGMA index_list(), and</span>
        <span class="s0"># then matches them up.  so same set of column_names in two</span>
        <span class="s0"># constraints will confuse it.    Perhaps we should no longer</span>
        <span class="s0"># bother with index_list() here since we have the whole</span>
        <span class="s0"># CREATE TABLE?</span>

        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">uniques </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;unique_a&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">]},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;unique_a_b_c&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s4">&quot;c&quot;</span><span class="s3">]},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;unique_c_a_b&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;c&quot;</span><span class="s3">, </span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">]},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;unique_asc_key&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;asc&quot;</span><span class="s3">, </span><span class="s4">&quot;key&quot;</span><span class="s3">]},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;i.have.dots&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;b&quot;</span><span class="s3">]},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;i have spaces&quot;</span><span class="s3">, </span><span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;c&quot;</span><span class="s3">]},</span>
            <span class="s3">],</span>
            <span class="s1">key</span><span class="s3">=</span><span class="s1">operator</span><span class="s3">.</span><span class="s1">itemgetter</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">table </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;testtbl&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;c&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s0"># reserved identifiers</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;asc&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;key&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">uc </span><span class="s2">in </span><span class="s1">uniques</span><span class="s3">:</span>
            <span class="s1">table</span><span class="s3">.</span><span class="s1">append_constraint</span><span class="s3">(</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(*</span><span class="s1">uc</span><span class="s3">[</span><span class="s4">&quot;column_names&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s1">uc</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">])</span>
            <span class="s3">)</span>
        <span class="s1">table</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_unique_constraints</span><span class="s3">(</span><span class="s4">&quot;testtbl&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s1">key</span><span class="s3">=</span><span class="s1">operator</span><span class="s3">.</span><span class="s1">itemgetter</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>

        <span class="s1">names_that_duplicate_index </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>

        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">uniques</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">reflected</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">orig</span><span class="s3">, </span><span class="s1">refl </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">uniques</span><span class="s3">, </span><span class="s1">reflected</span><span class="s3">):</span>
            <span class="s0"># Different dialects handle duplicate index and constraints</span>
            <span class="s0"># differently, so ignore this flag</span>
            <span class="s1">dupe </span><span class="s3">= </span><span class="s1">refl</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;duplicates_index&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">dupe</span><span class="s3">:</span>
                <span class="s1">names_that_duplicate_index</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">dupe</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">refl</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;comment&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">orig</span><span class="s3">, </span><span class="s1">refl</span><span class="s3">)</span>

        <span class="s1">reflected_metadata </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;testtbl&quot;</span><span class="s3">,</span>
            <span class="s1">reflected_metadata</span><span class="s3">,</span>
            <span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">,</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s0"># test &quot;deduplicates for index&quot; logic.   MySQL and Oracle</span>
        <span class="s0"># &quot;unique constraints&quot; are actually unique indexes (with possible</span>
        <span class="s0"># exception of a unique that is a dupe of another one in the case</span>
        <span class="s0"># of Oracle).  make sure # they aren't duplicated.</span>
        <span class="s1">idx_names </span><span class="s3">= {</span><span class="s1">idx</span><span class="s3">.</span><span class="s1">name </span><span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">reflected</span><span class="s3">.</span><span class="s1">indexes</span><span class="s3">}</span>
        <span class="s1">uq_names </span><span class="s3">= {</span>
            <span class="s1">uq</span><span class="s3">.</span><span class="s1">name</span>
            <span class="s2">for </span><span class="s1">uq </span><span class="s2">in </span><span class="s1">reflected</span><span class="s3">.</span><span class="s1">constraints</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">uq</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">)</span>
        <span class="s3">}.</span><span class="s1">difference</span><span class="s3">([</span><span class="s4">&quot;unique_c_a_b&quot;</span><span class="s3">])</span>

        <span class="s2">assert not </span><span class="s1">idx_names</span><span class="s3">.</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">uq_names</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">names_that_duplicate_index</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">names_that_duplicate_index</span><span class="s3">, </span><span class="s1">idx_names</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">uq_names</span><span class="s3">, </span><span class="s1">set</span><span class="s3">())</span>

        <span class="s1">no_cst </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">no_constraints</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_unique_constraints</span><span class="s3">(</span><span class="s1">no_cst</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">), [])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">,), (</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_view_definition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">use_schema</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">view </span><span class="s2">in </span><span class="s3">[</span><span class="s4">&quot;users_v&quot;</span><span class="s3">, </span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">, </span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">]:</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_view_definition</span><span class="s3">(</span><span class="s1">view</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">bool</span><span class="s3">(</span><span class="s1">v</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">view_reflection</span>
    <span class="s2">def </span><span class="s1">test_get_view_definition_does_not_exist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">expect_raises</span><span class="s3">(</span><span class="s1">NoSuchTableError</span><span class="s3">):</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_view_definition</span><span class="s3">(</span><span class="s4">&quot;view_does_not_exist&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">expect_raises</span><span class="s3">(</span><span class="s1">NoSuchTableError</span><span class="s3">):</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">get_view_definition</span><span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">)  </span><span class="s0"># a table</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">table_reflection</span>
    <span class="s2">def </span><span class="s1">test_autoincrement_col</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;test that 'autoincrement' is reflected according to sqla's policy. 
 
        Don't mark this test as unsupported for any backend ! 
 
        (technically it fails with MySQL InnoDB since &quot;id&quot; comes before &quot;id2&quot;) 
 
        A backend is better off not returning &quot;autoincrement&quot; at all, 
        instead of potentially returning &quot;False&quot; for an auto-incrementing 
        primary key column. 
 
        &quot;&quot;&quot;</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">tname</span><span class="s3">, </span><span class="s1">cname </span><span class="s2">in </span><span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s4">&quot;user_id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">, </span><span class="s4">&quot;address_id&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;dingalings&quot;</span><span class="s3">, </span><span class="s4">&quot;dingaling_id&quot;</span><span class="s3">),</span>
        <span class="s3">]:</span>
            <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s1">tname</span><span class="s3">)</span>
            <span class="s1">id_ </span><span class="s3">= {</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">}[</span><span class="s1">cname</span><span class="s3">]</span>
            <span class="s2">assert </span><span class="s1">id_</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;autoincrement&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), (</span><span class="s2">False</span><span class="s3">,), </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_table_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema </span><span class="s2">if </span><span class="s1">use_schema </span><span class="s2">else None</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_table_options</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">))</span>
            <span class="s0"># NOTE: can't really create a table with no option</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">(</span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">expect_raises</span><span class="s3">(</span><span class="s1">NotImplementedError</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">(</span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">((</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_multi_get_table_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_table_options</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema </span><span class="s2">if </span><span class="s1">use_schema </span><span class="s2">else None</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_table_options</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>

            <span class="s1">exp </span><span class="s3">= {</span>
                <span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">table</span><span class="s3">): </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">table </span><span class="s2">in </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s3">}</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">expect_raises</span><span class="s3">(</span><span class="s1">NotImplementedError</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_table_options</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">fixture</span>
    <span class="s2">def </span><span class="s1">get_multi_exp</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">provide_fixture</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span><span class="s3">, </span><span class="s1">single_reflect_fn</span><span class="s3">, </span><span class="s1">exp_method</span>
        <span class="s3">):</span>
            <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
            <span class="s0"># call the reflection function at least once to avoid</span>
            <span class="s0"># &quot;Unexpected success&quot; errors if the result is actually empty</span>
            <span class="s0"># and NotImplementedError is not raised</span>
            <span class="s1">single_reflect_fn</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">, </span><span class="s4">&quot;email_addresses&quot;</span><span class="s3">)</span>
            <span class="s1">kw </span><span class="s3">= {</span><span class="s4">&quot;scope&quot;</span><span class="s3">: </span><span class="s1">scope</span><span class="s3">, </span><span class="s4">&quot;kind&quot;</span><span class="s3">: </span><span class="s1">kind</span><span class="s3">}</span>
            <span class="s2">if </span><span class="s1">schema</span><span class="s3">:</span>
                <span class="s1">schema </span><span class="s3">= </span><span class="s1">schema</span><span class="s3">()</span>

            <span class="s1">filter_names </span><span class="s3">= []</span>

            <span class="s2">if </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">TABLE </span><span class="s2">in </span><span class="s1">kind</span><span class="s3">:</span>
                <span class="s1">filter_names</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span>
                    <span class="s3">[</span><span class="s4">&quot;comment_test&quot;</span><span class="s3">, </span><span class="s4">&quot;users&quot;</span><span class="s3">, </span><span class="s4">&quot;does-not-exist&quot;</span><span class="s3">]</span>
                <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">VIEW </span><span class="s2">in </span><span class="s1">kind</span><span class="s3">:</span>
                <span class="s1">filter_names</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">([</span><span class="s4">&quot;email_addresses_v&quot;</span><span class="s3">, </span><span class="s4">&quot;does-not-exist&quot;</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">MATERIALIZED_VIEW </span><span class="s2">in </span><span class="s1">kind</span><span class="s3">:</span>
                <span class="s1">filter_names</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">([</span><span class="s4">&quot;dingalings_v&quot;</span><span class="s3">, </span><span class="s4">&quot;does-not-exist&quot;</span><span class="s3">])</span>

            <span class="s2">if </span><span class="s1">schema</span><span class="s3">:</span>
                <span class="s1">kw</span><span class="s3">[</span><span class="s4">&quot;schema&quot;</span><span class="s3">] = </span><span class="s1">schema</span>
            <span class="s2">if </span><span class="s1">use_filter</span><span class="s3">:</span>
                <span class="s1">kw</span><span class="s3">[</span><span class="s4">&quot;filter_names&quot;</span><span class="s3">] = </span><span class="s1">filter_names</span>

            <span class="s1">exp </span><span class="s3">= </span><span class="s1">exp_method</span><span class="s3">(</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
                <span class="s1">scope</span><span class="s3">=</span><span class="s1">scope</span><span class="s3">,</span>
                <span class="s1">kind</span><span class="s3">=</span><span class="s1">kind</span><span class="s3">,</span>
                <span class="s1">filter_names</span><span class="s3">=</span><span class="s1">kw</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;filter_names&quot;</span><span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">kws </span><span class="s3">= [</span><span class="s1">kw</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">scope </span><span class="s3">== </span><span class="s1">ObjectScope</span><span class="s3">.</span><span class="s1">DEFAULT</span><span class="s3">:</span>
                <span class="s1">nkw </span><span class="s3">= </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
                <span class="s1">nkw</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;scope&quot;</span><span class="s3">)</span>
                <span class="s1">kws</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nkw</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">kind </span><span class="s3">== </span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">TABLE</span><span class="s3">:</span>
                <span class="s1">nkw </span><span class="s3">= </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
                <span class="s1">nkw</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;kind&quot;</span><span class="s3">)</span>
                <span class="s1">kws</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">nkw</span><span class="s3">)</span>

            <span class="s2">return </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">), </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp</span>

        <span class="s2">return </span><span class="s1">provide_fixture</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_table_options</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_multi_get_table_options_tables</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_table_options</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_options</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_table_options</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_table_comment</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_comments</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_table_comment</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">), </span><span class="s1">exp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_check_expressions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">_clean</span><span class="s3">(</span><span class="s1">text</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">re</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span><span class="s4">r&quot;['\&quot; ]&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s1">text</span><span class="s3">).</span><span class="s1">lower</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exp</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
            <span class="s1">eq_</span><span class="s3">({</span><span class="s1">_clean</span><span class="s3">(</span><span class="s1">e</span><span class="s3">): </span><span class="s1">v </span><span class="s2">for </span><span class="s1">e</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">result</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()}, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">([</span><span class="s1">_clean</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">result</span><span class="s3">], </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_check_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">req_keys</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">req_keys </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">result</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">exp</span><span class="s3">), </span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">r</span><span class="s3">, </span><span class="s1">e </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">):</span>
                <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">set</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) | </span><span class="s1">set</span><span class="s3">(</span><span class="s1">e</span><span class="s3">):</span>
                    <span class="s2">if </span><span class="s1">k </span><span class="s2">in </span><span class="s1">req_keys </span><span class="s2">or </span><span class="s3">(</span><span class="s1">k </span><span class="s2">in </span><span class="s1">r </span><span class="s2">and </span><span class="s1">k </span><span class="s2">in </span><span class="s1">e</span><span class="s3">):</span>
                        <span class="s1">err_msg </span><span class="s3">= </span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">msg</span><span class="s2">} </span><span class="s4">- </span><span class="s2">{</span><span class="s1">k</span><span class="s2">} </span><span class="s4">- </span><span class="s2">{</span><span class="s1">r</span><span class="s2">}</span><span class="s4">&quot;</span>
                        <span class="s2">if </span><span class="s1">k </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;expressions&quot;</span><span class="s3">, </span><span class="s4">&quot;column_sorting&quot;</span><span class="s3">):</span>
                            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_expressions</span><span class="s3">(</span><span class="s1">r</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">e</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">err_msg</span><span class="s3">)</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">r</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">e</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">err_msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_check_table_dict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">req_keys</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">make_lists</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()), </span><span class="s1">set</span><span class="s3">(</span><span class="s1">exp</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()))</span>
        <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">result</span><span class="s3">:</span>
            <span class="s1">r</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= </span><span class="s1">result</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">exp</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">make_lists</span><span class="s3">:</span>
                <span class="s1">r</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= [</span><span class="s1">r</span><span class="s3">], [</span><span class="s1">e</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_list</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">e</span><span class="s3">, </span><span class="s1">req_keys</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_columns</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_columns</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_columns</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_table_dict</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_column_keys</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">primary_key_constraint_reflection</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_pk_constraint</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_pk_constraint</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_pks</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_pk_constraint</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_table_dict</span><span class="s3">(</span>
                <span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_pk_keys</span><span class="s3">, </span><span class="s1">make_lists</span><span class="s3">=</span><span class="s2">True</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_adjust_sort</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">key</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">implicitly_named_constraints</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s3">[</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">]:</span>
                <span class="s2">for </span><span class="s1">val </span><span class="s2">in </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">values</span><span class="s3">():</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">val</span><span class="s3">) &gt; </span><span class="s5">1 </span><span class="s2">and </span><span class="s1">any</span><span class="s3">(</span>
                        <span class="s1">v</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">val</span>
                    <span class="s3">):</span>
                        <span class="s1">val</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_reflection</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_foreign_keys</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_fks</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_foreign_keys</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_adjust_sort</span><span class="s3">(</span>
                <span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">d</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">])</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_table_dict</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_fk_keys</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflection</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_indexes</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_indexes</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_indexes</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_table_dict</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_index_keys</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_constraint_reflection</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_unique_constraints</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_unique_constraints</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_ucs</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_unique_constraints</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_adjust_sort</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">d</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s4">&quot;column_names&quot;</span><span class="s3">]))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_table_dict</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_unique_cst_keys</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">check_constraint_reflection</span>
    <span class="s3">@</span><span class="s1">_multi_combination</span>
    <span class="s2">def </span><span class="s1">test_get_multi_check_constraints</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">get_multi_exp</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">, </span><span class="s1">kind</span><span class="s3">, </span><span class="s1">use_filter</span>
    <span class="s3">):</span>
        <span class="s1">insp</span><span class="s3">, </span><span class="s1">kws</span><span class="s3">, </span><span class="s1">exp </span><span class="s3">= </span><span class="s1">get_multi_exp</span><span class="s3">(</span>
            <span class="s1">schema</span><span class="s3">,</span>
            <span class="s1">scope</span><span class="s3">,</span>
            <span class="s1">kind</span><span class="s3">,</span>
            <span class="s1">use_filter</span><span class="s3">,</span>
            <span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_check_constraints</span><span class="s3">,</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">exp_ccs</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">for </span><span class="s1">kw </span><span class="s2">in </span><span class="s1">kws</span><span class="s3">:</span>
            <span class="s1">insp</span><span class="s3">.</span><span class="s1">clear_cache</span><span class="s3">()</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_check_constraints</span><span class="s3">(**</span><span class="s1">kw</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_adjust_sort</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">d</span><span class="s3">: </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">]))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_table_dict</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_required_cc_keys</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s4">&quot;get_table_options&quot;</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_table_options</span><span class="s3">),</span>
        <span class="s4">&quot;get_columns&quot;</span><span class="s3">,</span>
        <span class="s3">(</span>
            <span class="s4">&quot;get_pk_constraint&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">primary_key_constraint_reflection</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;get_foreign_keys&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_reflection</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;get_indexes&quot;</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflection</span><span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;get_unique_constraints&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">unique_constraint_reflection</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s4">&quot;get_check_constraints&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">check_constraint_reflection</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;get_table_comment&quot;</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection</span><span class="s3">),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;method&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_not_existing_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">meth </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">expect_raises</span><span class="s3">(</span><span class="s1">NoSuchTableError</span><span class="s3">):</span>
            <span class="s1">meth</span><span class="s3">(</span><span class="s4">&quot;table_does_not_exists&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unreflectable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">mc </span><span class="s3">= </span><span class="s1">Inspector</span><span class="s3">.</span><span class="s1">get_multi_columns</span>

        <span class="s2">def </span><span class="s1">patched</span><span class="s3">(*</span><span class="s1">a</span><span class="s3">, **</span><span class="s1">k</span><span class="s3">):</span>
            <span class="s1">ur </span><span class="s3">= </span><span class="s1">k</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s4">&quot;unreflectable&quot;</span><span class="s3">, {})</span>
            <span class="s1">ur</span><span class="s3">[(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;some_table&quot;</span><span class="s3">)] = </span><span class="s1">UnreflectableTableError</span><span class="s3">(</span><span class="s4">&quot;err&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">mc</span><span class="s3">(*</span><span class="s1">a</span><span class="s3">, **</span><span class="s1">k</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">patch</span><span class="s3">.</span><span class="s1">object</span><span class="s3">(</span><span class="s1">Inspector</span><span class="s3">, </span><span class="s4">&quot;get_multi_columns&quot;</span><span class="s3">, </span><span class="s1">patched</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">expect_raises_message</span><span class="s3">(</span><span class="s1">UnreflectableTableError</span><span class="s3">, </span><span class="s4">&quot;err&quot;</span><span class="s3">):</span>
                <span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">).</span><span class="s1">reflect_table</span><span class="s3">(</span>
                    <span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;some_table&quot;</span><span class="s3">, </span><span class="s1">MetaData</span><span class="s3">()), </span><span class="s2">None</span>
                <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;use_schema&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">views</span><span class="s3">), </span><span class="s2">False</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;views&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_metadata</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema</span><span class="s3">, </span><span class="s1">views</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">schema </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema </span><span class="s2">if </span><span class="s1">use_schema </span><span class="s2">else None</span>
        <span class="s1">m</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">views</span><span class="s3">=</span><span class="s1">views</span><span class="s3">, </span><span class="s1">resolve_fks</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">tables </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">views</span><span class="s3">:</span>
            <span class="s1">tables </span><span class="s3">+= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_view_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">tables </span><span class="s3">+= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_materialized_view_names</span><span class="s3">(</span><span class="s1">schema</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">NotImplementedError</span><span class="s3">:</span>
                <span class="s2">pass</span>
        <span class="s2">if </span><span class="s1">schema</span><span class="s3">:</span>
            <span class="s1">tables </span><span class="s3">= [</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">schema</span><span class="s2">}</span><span class="s4">.</span><span class="s2">{</span><span class="s1">t</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">tables</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">), </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">tables</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection</span>
    <span class="s2">def </span><span class="s1">test_comments_unicode</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;unicode_comments&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;unicode&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;é試蛇ẟΩ&quot;</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;emoji&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;☁️✨&quot;</span><span class="s3">),</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;試蛇ẟΩ✨&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">tc </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s4">&quot;unicode_comments&quot;</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">tc</span><span class="s3">, {</span><span class="s4">&quot;text&quot;</span><span class="s3">: </span><span class="s4">&quot;試蛇ẟΩ✨&quot;</span><span class="s3">})</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;unicode_comments&quot;</span><span class="s3">)</span>
        <span class="s1">value </span><span class="s3">= {</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;comment&quot;</span><span class="s3">] </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">}</span>
        <span class="s1">exp </span><span class="s3">= {</span><span class="s4">&quot;unicode&quot;</span><span class="s3">: </span><span class="s4">&quot;é試蛇ẟΩ&quot;</span><span class="s3">, </span><span class="s4">&quot;emoji&quot;</span><span class="s3">: </span><span class="s4">&quot;☁️✨&quot;</span><span class="s3">}</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">comment_reflection_full_unicode</span>
    <span class="s2">def </span><span class="s1">test_comments_unicode_full</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;unicode_comments&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;emoji&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;🐍🧙🝝🧙‍♂️🧙‍♀️&quot;</span><span class="s3">),</span>
            <span class="s1">comment</span><span class="s3">=</span><span class="s4">&quot;🎩🁰🝑🤷‍♀️🤷‍♂️&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">tc </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_table_comment</span><span class="s3">(</span><span class="s4">&quot;unicode_comments&quot;</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">tc</span><span class="s3">, {</span><span class="s4">&quot;text&quot;</span><span class="s3">: </span><span class="s4">&quot;🎩🁰🝑🤷‍♀️🤷‍♂️&quot;</span><span class="s3">})</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;unicode_comments&quot;</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">({</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;comment&quot;</span><span class="s3">]}, {</span><span class="s4">&quot;emoji&quot;</span><span class="s3">: </span><span class="s4">&quot;🐍🧙🝝🧙‍♂️🧙‍♀️&quot;</span><span class="s3">})</span>


<span class="s2">class </span><span class="s1">TableNoColumnsTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TestBase</span><span class="s3">):</span>
    <span class="s1">__requires__ </span><span class="s3">= (</span><span class="s4">&quot;reflect_tables_no_columns&quot;</span><span class="s3">,)</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">fixture</span>
    <span class="s2">def </span><span class="s1">table_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;empty&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">)</span>
        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">fixture</span>
    <span class="s2">def </span><span class="s1">view_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;empty&quot;</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">)</span>
        <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s4">&quot;after_create&quot;</span><span class="s3">,</span>
            <span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;CREATE VIEW empty_v AS SELECT * FROM empty&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>

        <span class="s0"># for transactional DDL the transaction is rolled back before this</span>
        <span class="s0"># drop statement is invoked</span>
        <span class="s1">event</span><span class="s3">.</span><span class="s1">listen</span><span class="s3">(</span>
            <span class="s1">metadata</span><span class="s3">, </span><span class="s4">&quot;before_drop&quot;</span><span class="s3">, </span><span class="s1">DDL</span><span class="s3">(</span><span class="s4">&quot;DROP VIEW IF EXISTS empty_v&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reflect_table_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">table_no_columns</span><span class="s3">):</span>
        <span class="s1">t2 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;empty&quot;</span><span class="s3">, </span><span class="s1">MetaData</span><span class="s3">(), </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">t2</span><span class="s3">.</span><span class="s1">c</span><span class="s3">), [])</span>

    <span class="s2">def </span><span class="s1">test_get_columns_table_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">table_no_columns</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;empty&quot;</span><span class="s3">), [])</span>
        <span class="s1">multi </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_columns</span><span class="s3">()</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">multi</span><span class="s3">, {(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;empty&quot;</span><span class="s3">): []})</span>

    <span class="s2">def </span><span class="s1">test_reflect_incl_table_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">table_no_columns</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">m</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">).</span><span class="s1">intersection</span><span class="s3">([</span><span class="s4">&quot;empty&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">views</span>
    <span class="s2">def </span><span class="s1">test_reflect_view_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">view_no_columns</span><span class="s3">):</span>
        <span class="s1">t2 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;empty_v&quot;</span><span class="s3">, </span><span class="s1">MetaData</span><span class="s3">(), </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">t2</span><span class="s3">.</span><span class="s1">c</span><span class="s3">), [])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">views</span>
    <span class="s2">def </span><span class="s1">test_get_columns_view_no_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">view_no_columns</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;empty_v&quot;</span><span class="s3">), [])</span>
        <span class="s1">multi </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_multi_columns</span><span class="s3">(</span><span class="s1">kind</span><span class="s3">=</span><span class="s1">ObjectKind</span><span class="s3">.</span><span class="s1">VIEW</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">multi</span><span class="s3">, {(</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;empty_v&quot;</span><span class="s3">): []})</span>


<span class="s2">class </span><span class="s1">ComponentReflectionTestExtra</span><span class="s3">(</span><span class="s1">ComparesIndexes</span><span class="s3">, </span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TestBase</span><span class="s3">):</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">params</span><span class="s3">=[</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">use_schema_fixture</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return None</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">()</span>
    <span class="s2">def </span><span class="s1">inspect_for_table</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">use_schema_fixture</span><span class="s3">):</span>
        <span class="s3">@</span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">contextmanager</span>
        <span class="s2">def </span><span class="s1">go</span><span class="s3">(</span><span class="s1">tablename</span><span class="s3">):</span>
            <span class="s2">yield </span><span class="s1">use_schema_fixture</span><span class="s3">, </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

            <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">go</span>

    <span class="s2">def </span><span class="s1">ck_eq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">reflected</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s0"># trying to minimize effect of quoting, parenthesis, etc.</span>
        <span class="s0"># may need to add more to this as new dialects get CHECK</span>
        <span class="s0"># constraint reflection support</span>
        <span class="s2">def </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">sqltext</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s4">&quot; &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
                <span class="s1">re</span><span class="s3">.</span><span class="s1">findall</span><span class="s3">(</span><span class="s4">r&quot;and|\d|=|a|b|c|or|&lt;|&gt;&quot;</span><span class="s3">, </span><span class="s1">sqltext</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(), </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">item</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">], </span><span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">item</span><span class="s3">[</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">])}</span>
                <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">reflected</span>
            <span class="s3">],</span>
            <span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">item</span><span class="s3">: (</span><span class="s1">item</span><span class="s3">[</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">]),</span>
        <span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span>
            <span class="s1">expected</span><span class="s3">,</span>
            <span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">item</span><span class="s3">: (</span><span class="s1">item</span><span class="s3">[</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">]),</span>
        <span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">reflected</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">check_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_check_constraint_no_constraint</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">inspect_for_table</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">inspect_for_table</span><span class="s3">(</span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">inspector</span><span class="s3">):</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;no_constraints&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">ck_eq</span><span class="s3">(</span>
            <span class="s1">inspector</span><span class="s3">.</span><span class="s1">get_check_constraints</span><span class="s3">(</span><span class="s4">&quot;no_constraints&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">),</span>
            <span class="s3">[],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">inline_check_constraint_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s4">&quot;my_inline&quot;</span><span class="s3">, </span><span class="s4">&quot;MyInline&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;constraint_name&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_check_constraint_inline</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">inspect_for_table</span><span class="s3">, </span><span class="s1">constraint_name</span>
    <span class="s3">):</span>

        <span class="s2">with </span><span class="s1">inspect_for_table</span><span class="s3">(</span><span class="s4">&quot;sa_cc&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">inspector</span><span class="s3">):</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;sa_cc&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">(), </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span>
                    <span class="s4">&quot;a&quot;</span><span class="s3">,</span>
                    <span class="s1">Integer</span><span class="s3">(),</span>
                    <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span>
                        <span class="s4">&quot;a &gt; 1 AND a &lt; 5&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">constraint_name</span>
                    <span class="s3">),</span>
                <span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">inspector</span><span class="s3">.</span><span class="s1">get_check_constraints</span><span class="s3">(</span><span class="s4">&quot;sa_cc&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">ck_eq</span><span class="s3">(</span>
            <span class="s1">reflected</span><span class="s3">,</span>
            <span class="s3">[</span>
                <span class="s3">{</span>
                    <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">constraint_name </span><span class="s2">or </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
                    <span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s4">&quot;a &gt; 1 and a &lt; 5&quot;</span><span class="s3">,</span>
                <span class="s3">},</span>
            <span class="s3">],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">check_constraint_reflection</span>
    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s4">&quot;my_ck_const&quot;</span><span class="s3">, </span><span class="s4">&quot;MyCkConst&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;constraint_name&quot;</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_check_constraint_standalone</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">inspect_for_table</span><span class="s3">, </span><span class="s1">constraint_name</span>
    <span class="s3">):</span>
        <span class="s2">with </span><span class="s1">inspect_for_table</span><span class="s3">(</span><span class="s4">&quot;sa_cc&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">inspector</span><span class="s3">):</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;sa_cc&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">()),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span>
                    <span class="s4">&quot;a = 1 OR (a &gt; 2 AND a &lt; 5)&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s1">constraint_name</span>
                <span class="s3">),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">inspector</span><span class="s3">.</span><span class="s1">get_check_constraints</span><span class="s3">(</span><span class="s4">&quot;sa_cc&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">ck_eq</span><span class="s3">(</span>
            <span class="s1">reflected</span><span class="s3">,</span>
            <span class="s3">[</span>
                <span class="s3">{</span>
                    <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">constraint_name </span><span class="s2">or </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
                    <span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s4">&quot;a = 1 or a &gt; 2 and a &lt; 5&quot;</span><span class="s3">,</span>
                <span class="s3">},</span>
            <span class="s3">],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">inline_check_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_check_constraint_mixed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">inspect_for_table</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">inspect_for_table</span><span class="s3">(</span><span class="s4">&quot;sa_cc&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">schema</span><span class="s3">, </span><span class="s1">inspector</span><span class="s3">):</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;sa_cc&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">(), </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">(), </span><span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span><span class="s4">&quot;a &gt; 1 AND a &lt; 5&quot;</span><span class="s3">)),</span>
                <span class="s1">Column</span><span class="s3">(</span>
                    <span class="s4">&quot;b&quot;</span><span class="s3">,</span>
                    <span class="s1">Integer</span><span class="s3">(),</span>
                    <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span><span class="s4">&quot;b &gt; 1 AND b &lt; 5&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;my_inline&quot;</span><span class="s3">),</span>
                <span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;c&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">()),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">)),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(</span><span class="s4">&quot;data&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;some_uq&quot;</span><span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">CheckConstraint</span><span class="s3">(</span><span class="s4">&quot;c &gt; 1 AND c &lt; 5&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;cc1&quot;</span><span class="s3">),</span>
                <span class="s1">sa</span><span class="s3">.</span><span class="s1">UniqueConstraint</span><span class="s3">(</span><span class="s4">&quot;c&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;some_c_uq&quot;</span><span class="s3">),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">reflected </span><span class="s3">= </span><span class="s1">inspector</span><span class="s3">.</span><span class="s1">get_check_constraints</span><span class="s3">(</span><span class="s4">&quot;sa_cc&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">schema</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">ck_eq</span><span class="s3">(</span>
            <span class="s1">reflected</span><span class="s3">,</span>
            <span class="s3">[</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;cc1&quot;</span><span class="s3">, </span><span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s4">&quot;c &gt; 1 and c &lt; 5&quot;</span><span class="s3">},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;my_inline&quot;</span><span class="s3">, </span><span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s4">&quot;b &gt; 1 and b &lt; 5&quot;</span><span class="s3">},</span>
                <span class="s3">{</span><span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">, </span><span class="s4">&quot;sqltext&quot;</span><span class="s3">: </span><span class="s4">&quot;a &gt; 1 and a &lt; 5&quot;</span><span class="s3">},</span>
            <span class="s3">],</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">indexes_with_expressions</span>
    <span class="s2">def </span><span class="s1">test_reflect_expression_based_indexes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">t </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;t&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;x&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;y&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;z&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
        <span class="s3">)</span>

        <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;t_idx&quot;</span><span class="s3">, </span><span class="s1">func</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">x</span><span class="s3">), </span><span class="s1">t</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">z</span><span class="s3">, </span><span class="s1">func</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">y</span><span class="s3">))</span>
        <span class="s1">long_str </span><span class="s3">= </span><span class="s4">&quot;long string &quot; </span><span class="s3">* </span><span class="s5">100</span>
        <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;t_idx_long&quot;</span><span class="s3">, </span><span class="s1">func</span><span class="s3">.</span><span class="s1">coalesce</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">long_str</span><span class="s3">))</span>
        <span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;t_idx_2&quot;</span><span class="s3">, </span><span class="s1">t</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= [</span>
            <span class="s3">{</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;t_idx_2&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;x&quot;</span><span class="s3">],</span>
                <span class="s4">&quot;unique&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
                <span class="s4">&quot;dialect_options&quot;</span><span class="s3">: {},</span>
            <span class="s3">}</span>
        <span class="s3">]</span>

        <span class="s2">def </span><span class="s1">completeIndex</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflects_included_columns</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
                <span class="s1">entry</span><span class="s3">[</span><span class="s4">&quot;include_columns&quot;</span><span class="s3">] = []</span>
                <span class="s1">entry</span><span class="s3">[</span><span class="s4">&quot;dialect_options&quot;</span><span class="s3">] = {</span>
                    <span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">connection</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s4">_include&quot;</span><span class="s3">: []</span>
                <span class="s3">}</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">entry</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s4">&quot;dialect_options&quot;</span><span class="s3">, {})</span>

        <span class="s1">completeIndex</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

        <span class="s2">class </span><span class="s1">lower_index_str</span><span class="s3">(</span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
                <span class="s1">ol </span><span class="s3">= </span><span class="s1">other</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
                <span class="s0"># test that lower and x or y are in the string</span>
                <span class="s2">return </span><span class="s4">&quot;lower&quot; </span><span class="s2">in </span><span class="s1">ol </span><span class="s2">and </span><span class="s3">(</span><span class="s4">&quot;x&quot; </span><span class="s2">in </span><span class="s1">ol </span><span class="s2">or </span><span class="s4">&quot;y&quot; </span><span class="s2">in </span><span class="s1">ol</span><span class="s3">)</span>

        <span class="s2">class </span><span class="s1">coalesce_index_str</span><span class="s3">(</span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
                <span class="s0"># test that coalesce and the string is in other</span>
                <span class="s2">return </span><span class="s4">&quot;coalesce&quot; </span><span class="s2">in </span><span class="s1">other</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">and </span><span class="s1">long_str </span><span class="s2">in </span><span class="s1">other</span>

        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">reflect_indexes_with_expressions</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">expr_index </span><span class="s3">= {</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;t_idx&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;z&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">],</span>
                <span class="s4">&quot;expressions&quot;</span><span class="s3">: [</span>
                    <span class="s1">lower_index_str</span><span class="s3">(</span><span class="s4">&quot;lower(x)&quot;</span><span class="s3">),</span>
                    <span class="s4">&quot;z&quot;</span><span class="s3">,</span>
                    <span class="s1">lower_index_str</span><span class="s3">(</span><span class="s4">&quot;lower(y)&quot;</span><span class="s3">),</span>
                <span class="s3">],</span>
                <span class="s4">&quot;unique&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">}</span>
            <span class="s1">completeIndex</span><span class="s3">(</span><span class="s1">expr_index</span><span class="s3">)</span>
            <span class="s1">expected</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">expr_index</span><span class="s3">)</span>

            <span class="s1">expr_index_long </span><span class="s3">= {</span>
                <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;t_idx_long&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s2">None</span><span class="s3">],</span>
                <span class="s4">&quot;expressions&quot;</span><span class="s3">: [</span>
                    <span class="s1">coalesce_index_str</span><span class="s3">(</span><span class="s4">f&quot;coalesce(x, '</span><span class="s2">{</span><span class="s1">long_str</span><span class="s2">}</span><span class="s4">')&quot;</span><span class="s3">)</span>
                <span class="s3">],</span>
                <span class="s4">&quot;unique&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">}</span>
            <span class="s1">completeIndex</span><span class="s3">(</span><span class="s1">expr_index_long</span><span class="s3">)</span>
            <span class="s1">expected</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">expr_index_long</span><span class="s3">)</span>

            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">), </span><span class="s1">expected</span><span class="s3">)</span>
            <span class="s1">m2 </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
            <span class="s1">t2 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">, </span><span class="s1">m2</span><span class="s3">, </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">expect_warnings</span><span class="s3">(</span>
                <span class="s4">&quot;Skipped unsupported reflection of expression-based &quot;</span>
                <span class="s4">&quot;index t_idx&quot;</span>
            <span class="s3">):</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">), </span><span class="s1">expected</span><span class="s3">)</span>
                <span class="s1">m2 </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
                <span class="s1">t2 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">, </span><span class="s1">m2</span><span class="s3">, </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">compare_table_index_with_expected</span><span class="s3">(</span>
            <span class="s1">t2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">name</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">index_reflects_included_columns</span>
    <span class="s2">def </span><span class="s1">test_reflect_covering_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s1">t </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;t&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;x&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;y&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">30</span><span class="s3">)),</span>
        <span class="s3">)</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s1">Index</span><span class="s3">(</span><span class="s4">&quot;t_idx&quot;</span><span class="s3">, </span><span class="s1">t</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">idx</span><span class="s3">.</span><span class="s1">dialect_options</span><span class="s3">[</span><span class="s1">connection</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">name</span><span class="s3">][</span><span class="s4">&quot;include&quot;</span><span class="s3">] = [</span><span class="s4">&quot;y&quot;</span><span class="s3">]</span>

        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">get_indexes </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_indexes</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">get_indexes</span><span class="s3">,</span>
            <span class="s3">[</span>
                <span class="s3">{</span>
                    <span class="s4">&quot;name&quot;</span><span class="s3">: </span><span class="s4">&quot;t_idx&quot;</span><span class="s3">,</span>
                    <span class="s4">&quot;column_names&quot;</span><span class="s3">: [</span><span class="s4">&quot;x&quot;</span><span class="s3">],</span>
                    <span class="s4">&quot;include_columns&quot;</span><span class="s3">: [</span><span class="s4">&quot;y&quot;</span><span class="s3">],</span>
                    <span class="s4">&quot;unique&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
                    <span class="s4">&quot;dialect_options&quot;</span><span class="s3">: </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">ANY</span><span class="s3">,</span>
                <span class="s3">}</span>
            <span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">get_indexes</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">&quot;dialect_options&quot;</span><span class="s3">][</span>
                <span class="s4">&quot;%s_include&quot; </span><span class="s3">% </span><span class="s1">connection</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">name</span>
            <span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;y&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>

        <span class="s1">t2 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">, </span><span class="s1">MetaData</span><span class="s3">(), </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s1">list</span><span class="s3">(</span><span class="s1">t2</span><span class="s3">.</span><span class="s1">indexes</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">dialect_options</span><span class="s3">[</span><span class="s1">connection</span><span class="s3">.</span><span class="s1">engine</span><span class="s3">.</span><span class="s1">name</span><span class="s3">][</span>
                <span class="s4">&quot;include&quot;</span>
            <span class="s3">],</span>
            <span class="s3">[</span><span class="s4">&quot;y&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_type_round_trip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, *</span><span class="s1">types</span><span class="s3">):</span>
        <span class="s1">t </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;t&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s3">*[</span><span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;t%d&quot; </span><span class="s3">% </span><span class="s1">i</span><span class="s3">, </span><span class="s1">type_</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">type_ </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">types</span><span class="s3">)],</span>
        <span class="s3">)</span>
        <span class="s1">t</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s3">[</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;type&quot;</span><span class="s3">] </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">).</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">)]</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">table_reflection</span>
    <span class="s2">def </span><span class="s1">test_numeric_reflection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">typ </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_type_round_trip</span><span class="s3">(</span>
            <span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Numeric</span><span class="s3">(</span><span class="s5">18</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">Numeric</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">precision</span><span class="s3">, </span><span class="s5">18</span><span class="s3">)</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">table_reflection</span>
    <span class="s2">def </span><span class="s1">test_varchar_reflection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">typ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_type_round_trip</span><span class="s3">(</span>
            <span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">String</span><span class="s3">(</span><span class="s5">52</span><span class="s3">)</span>
        <span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">, </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">String</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">typ</span><span class="s3">.</span><span class="s1">length</span><span class="s3">, </span><span class="s5">52</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">table_reflection</span>
    <span class="s2">def </span><span class="s1">test_nullable_reflection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">t </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;t&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">t</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;nullable&quot;</span><span class="s3">]</span>
                <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">).</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;t&quot;</span><span class="s3">)</span>
            <span class="s3">},</span>
            <span class="s3">{</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">},</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">combinations</span><span class="s3">(</span>
        <span class="s3">(</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;CASCADE&quot;</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_option_reflection_ondelete</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;SET NULL&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_option_reflection_onupdate</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{},</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;NO ACTION&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_option_reflection_onupdate</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">{},</span>
            <span class="s4">&quot;NO ACTION&quot;</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">fk_constraint_option_reflection_ondelete_noaction</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;RESTRICT&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">fk_constraint_option_reflection_onupdate_restrict</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s4">&quot;RESTRICT&quot;</span><span class="s3">,</span>
            <span class="s2">None</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">fk_constraint_option_reflection_ondelete_restrict</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s1">argnames</span><span class="s3">=</span><span class="s4">&quot;expected,ondelete,onupdate&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_get_foreign_key_options</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">ondelete</span><span class="s3">, </span><span class="s1">onupdate</span>
    <span class="s3">):</span>
        <span class="s1">options </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">ondelete</span><span class="s3">:</span>
            <span class="s1">options</span><span class="s3">[</span><span class="s4">&quot;ondelete&quot;</span><span class="s3">] = </span><span class="s1">ondelete</span>
        <span class="s2">if </span><span class="s1">onupdate</span><span class="s3">:</span>
            <span class="s1">options</span><span class="s3">[</span><span class="s4">&quot;onupdate&quot;</span><span class="s3">] = </span><span class="s1">onupdate</span>

        <span class="s2">if </span><span class="s1">expected </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">options</span>

        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;x&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;table&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;x_id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">ForeignKey</span><span class="s3">(</span><span class="s4">&quot;x.id&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;xid&quot;</span><span class="s3">)),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;test&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)),</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;user&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">String</span><span class="s3">(</span><span class="s5">50</span><span class="s3">), </span><span class="s1">nullable</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;tid&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">ForeignKeyConstraint</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s4">&quot;tid&quot;</span><span class="s3">], [</span><span class="s4">&quot;table.id&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;myfk&quot;</span><span class="s3">, **</span><span class="s1">options</span>
            <span class="s3">),</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s1">metadata</span><span class="s3">.</span><span class="s1">create_all</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>

        <span class="s0"># test 'options' is always present for a backend</span>
        <span class="s0"># that can reflect these, since alembic looks for this</span>
        <span class="s1">opts </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s4">&quot;table&quot;</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">&quot;options&quot;</span><span class="s3">]</span>

        <span class="s1">eq_</span><span class="s3">({</span><span class="s1">k</span><span class="s3">: </span><span class="s1">opts</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] </span><span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">opts </span><span class="s2">if </span><span class="s1">opts</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]}, {})</span>

        <span class="s1">opts </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s4">&quot;user&quot;</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">&quot;options&quot;</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s0"># eq_(dict((k, opts[k]) for k in opts if opts[k]), expected)</span>


<span class="s2">class </span><span class="s1">NormalizedNameTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TablesTest</span><span class="s3">):</span>
    <span class="s1">__requires__ </span><span class="s3">= (</span><span class="s4">&quot;denormalized_names&quot;</span><span class="s3">,)</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">quoted_name</span><span class="s3">(</span><span class="s4">&quot;t1&quot;</span><span class="s3">, </span><span class="s1">quote</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">quoted_name</span><span class="s3">(</span><span class="s4">&quot;t2&quot;</span><span class="s3">, </span><span class="s1">quote</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;t1id&quot;</span><span class="s3">, </span><span class="s1">ForeignKey</span><span class="s3">(</span><span class="s4">&quot;t1.id&quot;</span><span class="s3">)),</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reflect_lowercase_forced_tables</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">t2_ref </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s1">quoted_name</span><span class="s3">(</span><span class="s4">&quot;t2&quot;</span><span class="s3">, </span><span class="s1">quote</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), </span><span class="s1">m2</span><span class="s3">, </span><span class="s1">autoload_with</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span>
        <span class="s3">)</span>
        <span class="s1">t1_ref </span><span class="s3">= </span><span class="s1">m2</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;t1&quot;</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">t2_ref</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">t1id</span><span class="s3">.</span><span class="s1">references</span><span class="s3">(</span><span class="s1">t1_ref</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">id</span><span class="s3">)</span>

        <span class="s1">m3 </span><span class="s3">= </span><span class="s1">MetaData</span><span class="s3">()</span>
        <span class="s1">m3</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">(</span>
            <span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">, </span><span class="s1">only</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">name</span><span class="s3">, </span><span class="s1">m</span><span class="s3">: </span><span class="s1">name</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;t1&quot;</span><span class="s3">, </span><span class="s4">&quot;t2&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">m3</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;t2&quot;</span><span class="s3">].</span><span class="s1">c</span><span class="s3">.</span><span class="s1">t1id</span><span class="s3">.</span><span class="s1">references</span><span class="s3">(</span><span class="s1">m3</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">[</span><span class="s4">&quot;t1&quot;</span><span class="s3">].</span><span class="s1">c</span><span class="s3">.</span><span class="s1">id</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_table_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">tablenames </span><span class="s3">= [</span>
            <span class="s1">t</span>
            <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">).</span><span class="s1">get_table_names</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">t</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;t1&quot;</span><span class="s3">, </span><span class="s4">&quot;t2&quot;</span><span class="s3">)</span>
        <span class="s3">]</span>

        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">tablenames</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">upper</span><span class="s3">(), </span><span class="s1">tablenames</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">lower</span><span class="s3">())</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">tablenames</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">upper</span><span class="s3">(), </span><span class="s1">tablenames</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">lower</span><span class="s3">())</span>


<span class="s2">class </span><span class="s1">ComputedReflectionTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">ComputedReflectionFixtureTest</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">test_computed_col_default_not_set</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;computed_default_table&quot;</span><span class="s3">)</span>
        <span class="s1">col_data </span><span class="s3">= {</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">}</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;42&quot; </span><span class="s2">in </span><span class="s1">col_data</span><span class="s3">[</span><span class="s4">&quot;with_default&quot;</span><span class="s3">][</span><span class="s4">&quot;default&quot;</span><span class="s3">])</span>
        <span class="s1">is_</span><span class="s3">(</span><span class="s1">col_data</span><span class="s3">[</span><span class="s4">&quot;normal&quot;</span><span class="s3">][</span><span class="s4">&quot;default&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">is_</span><span class="s3">(</span><span class="s1">col_data</span><span class="s3">[</span><span class="s4">&quot;computed_col&quot;</span><span class="s3">][</span><span class="s4">&quot;default&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_column_returns_computed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;computed_default_table&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= {</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">}</span>
        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;normal&quot;</span><span class="s3">, </span><span class="s4">&quot;with_default&quot;</span><span class="s3">):</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;computed&quot; </span><span class="s2">not in </span><span class="s1">data</span><span class="s3">[</span><span class="s1">key</span><span class="s3">])</span>
        <span class="s1">compData </span><span class="s3">= </span><span class="s1">data</span><span class="s3">[</span><span class="s4">&quot;computed_col&quot;</span><span class="s3">]</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;computed&quot; </span><span class="s2">in </span><span class="s1">compData</span><span class="s3">)</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;sqltext&quot; </span><span class="s2">in </span><span class="s1">compData</span><span class="s3">[</span><span class="s4">&quot;computed&quot;</span><span class="s3">])</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">compData</span><span class="s3">[</span><span class="s4">&quot;computed&quot;</span><span class="s3">][</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">]), </span><span class="s4">&quot;normal+42&quot;</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span>
            <span class="s4">&quot;persisted&quot; </span><span class="s2">in </span><span class="s1">compData</span><span class="s3">[</span><span class="s4">&quot;computed&quot;</span><span class="s3">],</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_reflect_persisted</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_reflect_persisted</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">(</span>
                <span class="s1">compData</span><span class="s3">[</span><span class="s4">&quot;computed&quot;</span><span class="s3">][</span><span class="s4">&quot;persisted&quot;</span><span class="s3">],</span>
                <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_default_persisted</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_column</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">column</span><span class="s3">, </span><span class="s1">sqltext</span><span class="s3">, </span><span class="s1">persisted</span><span class="s3">):</span>
        <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;computed&quot; </span><span class="s2">in </span><span class="s1">data</span><span class="s3">[</span><span class="s1">column</span><span class="s3">])</span>
        <span class="s1">compData </span><span class="s3">= </span><span class="s1">data</span><span class="s3">[</span><span class="s1">column</span><span class="s3">][</span><span class="s4">&quot;computed&quot;</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">compData</span><span class="s3">[</span><span class="s4">&quot;sqltext&quot;</span><span class="s3">]), </span><span class="s1">sqltext</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_reflect_persisted</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;persisted&quot; </span><span class="s2">in </span><span class="s1">compData</span><span class="s3">)</span>
            <span class="s1">is_</span><span class="s3">(</span><span class="s1">compData</span><span class="s3">[</span><span class="s4">&quot;persisted&quot;</span><span class="s3">], </span><span class="s1">persisted</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_column_returns_persisted</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;computed_column_table&quot;</span><span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= {</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">}</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_column</span><span class="s3">(</span>
            <span class="s1">data</span><span class="s3">,</span>
            <span class="s4">&quot;computed_no_flag&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;normal+42&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_default_persisted</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_virtual</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_column</span><span class="s3">(</span>
                <span class="s1">data</span><span class="s3">,</span>
                <span class="s4">&quot;computed_virtual&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;normal+2&quot;</span><span class="s3">,</span>
                <span class="s2">False</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_stored</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_column</span><span class="s3">(</span>
                <span class="s1">data</span><span class="s3">,</span>
                <span class="s4">&quot;computed_stored&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;normal-42&quot;</span><span class="s3">,</span>
                <span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_get_column_returns_persisted_with_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span>
            <span class="s4">&quot;computed_column_table&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span>
        <span class="s3">)</span>
        <span class="s1">data </span><span class="s3">= {</span><span class="s1">c</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">]: </span><span class="s1">c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">}</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_column</span><span class="s3">(</span>
            <span class="s1">data</span><span class="s3">,</span>
            <span class="s4">&quot;computed_no_flag&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;normal/42&quot;</span><span class="s3">,</span>
            <span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_default_persisted</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_virtual</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_column</span><span class="s3">(</span>
                <span class="s1">data</span><span class="s3">,</span>
                <span class="s4">&quot;computed_virtual&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;normal/2&quot;</span><span class="s3">,</span>
                <span class="s2">False</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">computed_columns_stored</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_column</span><span class="s3">(</span>
                <span class="s1">data</span><span class="s3">,</span>
                <span class="s4">&quot;computed_stored&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;normal*42&quot;</span><span class="s3">,</span>
                <span class="s2">True</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s2">class </span><span class="s1">IdentityReflectionTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TablesTest</span><span class="s3">):</span>
    <span class="s1">run_inserts </span><span class="s3">= </span><span class="s1">run_deletes </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s1">__requires__ </span><span class="s3">= (</span><span class="s4">&quot;identity_columns&quot;</span><span class="s3">, </span><span class="s4">&quot;table_reflection&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;t1&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;normal&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id1&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">Identity</span><span class="s3">()),</span>
        <span class="s3">)</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;t2&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span>
                <span class="s4">&quot;id2&quot;</span><span class="s3">,</span>
                <span class="s1">Integer</span><span class="s3">,</span>
                <span class="s1">Identity</span><span class="s3">(</span>
                    <span class="s1">always</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                    <span class="s1">start</span><span class="s3">=</span><span class="s5">2</span><span class="s3">,</span>
                    <span class="s1">increment</span><span class="s3">=</span><span class="s5">3</span><span class="s3">,</span>
                    <span class="s1">minvalue</span><span class="s3">=-</span><span class="s5">2</span><span class="s3">,</span>
                    <span class="s1">maxvalue</span><span class="s3">=</span><span class="s5">42</span><span class="s3">,</span>
                    <span class="s1">cycle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                    <span class="s1">cache</span><span class="s3">=</span><span class="s5">4</span><span class="s3">,</span>
                <span class="s3">),</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">Table</span><span class="s3">(</span>
                <span class="s4">&quot;t1&quot;</span><span class="s3">,</span>
                <span class="s1">metadata</span><span class="s3">,</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;normal&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
                <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id1&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">Identity</span><span class="s3">(</span><span class="s1">always</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">start</span><span class="s3">=</span><span class="s5">20</span><span class="s3">)),</span>
                <span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">, </span><span class="s1">approx</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">identity_columns_standard</span><span class="s3">.</span><span class="s1">enabled</span><span class="s3">:</span>
            <span class="s1">common_keys </span><span class="s3">= (</span>
                <span class="s4">&quot;always&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;start&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;increment&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;minvalue&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;maxvalue&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;cycle&quot;</span><span class="s3">,</span>
                <span class="s4">&quot;cache&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">list</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">k </span><span class="s2">not in </span><span class="s1">common_keys</span><span class="s3">:</span>
                    <span class="s1">value</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">k</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">approx</span><span class="s3">:</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">value</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">exp</span><span class="s3">))</span>
                <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">value</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">k </span><span class="s3">== </span><span class="s4">&quot;minvalue&quot;</span><span class="s3">:</span>
                        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">value</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] &lt;= </span><span class="s1">exp</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
                    <span class="s2">elif </span><span class="s1">k </span><span class="s2">in </span><span class="s3">{</span><span class="s4">&quot;maxvalue&quot;</span><span class="s3">, </span><span class="s4">&quot;cache&quot;</span><span class="s3">}:</span>
                        <span class="s1">is_true</span><span class="s3">(</span><span class="s1">value</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] &gt;= </span><span class="s1">exp</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">value</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">exp</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">k</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">exp</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">value</span><span class="s3">[</span><span class="s4">&quot;start&quot;</span><span class="s3">], </span><span class="s1">exp</span><span class="s3">[</span><span class="s4">&quot;start&quot;</span><span class="s3">])</span>
            <span class="s1">eq_</span><span class="s3">(</span><span class="s1">value</span><span class="s3">[</span><span class="s4">&quot;increment&quot;</span><span class="s3">], </span><span class="s1">exp</span><span class="s3">[</span><span class="s4">&quot;increment&quot;</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_reflect_identity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;t1&quot;</span><span class="s3">) + </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;t2&quot;</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] == </span><span class="s4">&quot;normal&quot;</span><span class="s3">:</span>
                <span class="s1">is_false</span><span class="s3">(</span><span class="s4">&quot;identity&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] == </span><span class="s4">&quot;id1&quot;</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s4">&quot;autoincrement&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">:</span>
                    <span class="s1">is_true</span><span class="s3">(</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;autoincrement&quot;</span><span class="s3">])</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;default&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;identity&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span>
                    <span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;identity&quot;</span><span class="s3">],</span>
                    <span class="s1">dict</span><span class="s3">(</span>
                        <span class="s1">always</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                        <span class="s1">start</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                        <span class="s1">increment</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                        <span class="s1">minvalue</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                        <span class="s1">maxvalue</span><span class="s3">=</span><span class="s5">2147483647</span><span class="s3">,</span>
                        <span class="s1">cycle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                        <span class="s1">cache</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                    <span class="s3">),</span>
                    <span class="s1">approx</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] == </span><span class="s4">&quot;id2&quot;</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s4">&quot;autoincrement&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">:</span>
                    <span class="s1">is_true</span><span class="s3">(</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;autoincrement&quot;</span><span class="s3">])</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;default&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;identity&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span>
                    <span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;identity&quot;</span><span class="s3">],</span>
                    <span class="s1">dict</span><span class="s3">(</span>
                        <span class="s1">always</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                        <span class="s1">start</span><span class="s3">=</span><span class="s5">2</span><span class="s3">,</span>
                        <span class="s1">increment</span><span class="s3">=</span><span class="s5">3</span><span class="s3">,</span>
                        <span class="s1">minvalue</span><span class="s3">=-</span><span class="s5">2</span><span class="s3">,</span>
                        <span class="s1">maxvalue</span><span class="s3">=</span><span class="s5">42</span><span class="s3">,</span>
                        <span class="s1">cycle</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                        <span class="s1">cache</span><span class="s3">=</span><span class="s5">4</span><span class="s3">,</span>
                    <span class="s3">),</span>
                    <span class="s1">approx</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">schemas</span>
    <span class="s2">def </span><span class="s1">test_reflect_identity_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">db</span><span class="s3">)</span>

        <span class="s1">cols </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_columns</span><span class="s3">(</span><span class="s4">&quot;t1&quot;</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">test_schema</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">cols</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] == </span><span class="s4">&quot;normal&quot;</span><span class="s3">:</span>
                <span class="s1">is_false</span><span class="s3">(</span><span class="s4">&quot;identity&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;name&quot;</span><span class="s3">] == </span><span class="s4">&quot;id1&quot;</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s4">&quot;autoincrement&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">:</span>
                    <span class="s1">is_true</span><span class="s3">(</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;autoincrement&quot;</span><span class="s3">])</span>
                <span class="s1">eq_</span><span class="s3">(</span><span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;default&quot;</span><span class="s3">], </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s1">is_true</span><span class="s3">(</span><span class="s4">&quot;identity&quot; </span><span class="s2">in </span><span class="s1">col</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span>
                    <span class="s1">col</span><span class="s3">[</span><span class="s4">&quot;identity&quot;</span><span class="s3">],</span>
                    <span class="s1">dict</span><span class="s3">(</span>
                        <span class="s1">always</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                        <span class="s1">start</span><span class="s3">=</span><span class="s5">20</span><span class="s3">,</span>
                        <span class="s1">increment</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                        <span class="s1">minvalue</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                        <span class="s1">maxvalue</span><span class="s3">=</span><span class="s5">2147483647</span><span class="s3">,</span>
                        <span class="s1">cycle</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                        <span class="s1">cache</span><span class="s3">=</span><span class="s5">1</span><span class="s3">,</span>
                    <span class="s3">),</span>
                    <span class="s1">approx</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>


<span class="s2">class </span><span class="s1">CompositeKeyReflectionTest</span><span class="s3">(</span><span class="s1">fixtures</span><span class="s3">.</span><span class="s1">TablesTest</span><span class="s3">):</span>
    <span class="s1">__backend__ </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">define_tables</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s1">tb1 </span><span class="s3">= </span><span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;tb1&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;attr&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">VARCHAR</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">PrimaryKeyConstraint</span><span class="s3">(</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;attr&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;pk_tb1&quot;</span><span class="s3">),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">Table</span><span class="s3">(</span>
            <span class="s4">&quot;tb2&quot;</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">, </span><span class="s1">primary_key</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;pid&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;pattr&quot;</span><span class="s3">, </span><span class="s1">Integer</span><span class="s3">),</span>
            <span class="s1">Column</span><span class="s3">(</span><span class="s4">&quot;pname&quot;</span><span class="s3">, </span><span class="s1">sql_types</span><span class="s3">.</span><span class="s1">VARCHAR</span><span class="s3">(</span><span class="s5">20</span><span class="s3">)),</span>
            <span class="s1">sa</span><span class="s3">.</span><span class="s1">ForeignKeyConstraint</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s4">&quot;pname&quot;</span><span class="s3">, </span><span class="s4">&quot;pid&quot;</span><span class="s3">, </span><span class="s4">&quot;pattr&quot;</span><span class="s3">],</span>
                <span class="s3">[</span><span class="s1">tb1</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">tb1</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">id</span><span class="s3">, </span><span class="s1">tb1</span><span class="s3">.</span><span class="s1">c</span><span class="s3">.</span><span class="s1">attr</span><span class="s3">],</span>
                <span class="s1">name</span><span class="s3">=</span><span class="s4">&quot;fk_tb1_name_id_attr&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s1">schema</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">test_needs_fk</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">primary_key_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_pk_column_order</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s0"># test for issue #5661</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">primary_key </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_pk_constraint</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">tb1</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">primary_key</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">), [</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;attr&quot;</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">requires</span><span class="s3">.</span><span class="s1">foreign_key_constraint_reflection</span>
    <span class="s2">def </span><span class="s1">test_fk_column_order</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">connection</span><span class="s3">):</span>
        <span class="s0"># test for issue #5661</span>
        <span class="s1">insp </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">(</span><span class="s1">connection</span><span class="s3">)</span>
        <span class="s1">foreign_keys </span><span class="s3">= </span><span class="s1">insp</span><span class="s3">.</span><span class="s1">get_foreign_keys</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tables</span><span class="s3">.</span><span class="s1">tb2</span><span class="s3">.</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">foreign_keys</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">fkey1 </span><span class="s3">= </span><span class="s1">foreign_keys</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;referred_columns&quot;</span><span class="s3">), [</span><span class="s4">&quot;name&quot;</span><span class="s3">, </span><span class="s4">&quot;id&quot;</span><span class="s3">, </span><span class="s4">&quot;attr&quot;</span><span class="s3">])</span>
        <span class="s1">eq_</span><span class="s3">(</span><span class="s1">fkey1</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;constrained_columns&quot;</span><span class="s3">), [</span><span class="s4">&quot;pname&quot;</span><span class="s3">, </span><span class="s4">&quot;pid&quot;</span><span class="s3">, </span><span class="s4">&quot;pattr&quot;</span><span class="s3">])</span>


<span class="s1">__all__ </span><span class="s3">= (</span>
    <span class="s4">&quot;ComponentReflectionTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;ComponentReflectionTestExtra&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;TableNoColumnsTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;QuotedNameArgumentTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;BizarroCharacterFKResolutionTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;HasTableTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;HasIndexTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;NormalizedNameTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;ComputedReflectionTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;IdentityReflectionTest&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;CompositeKeyReflectionTest&quot;</span><span class="s3">,</span>
<span class="s3">)</span>
</pre>
</body>
</html>