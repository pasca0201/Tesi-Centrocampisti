<html>
<head>
<title>test_naive_bayes.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_naive_bayes.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">special </span><span class="s0">import </span><span class="s1">logsumexp</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">load_digits</span><span class="s2">, </span><span class="s1">load_iris</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">model_selection </span><span class="s0">import </span><span class="s1">cross_val_score</span><span class="s2">, </span><span class="s1">train_test_split</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">naive_bayes </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">BernoulliNB</span><span class="s2">,</span>
    <span class="s1">CategoricalNB</span><span class="s2">,</span>
    <span class="s1">ComplementNB</span><span class="s2">,</span>
    <span class="s1">GaussianNB</span><span class="s2">,</span>
    <span class="s1">MultinomialNB</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSR_CONTAINERS</span>

<span class="s1">DISCRETE_NAIVE_BAYES_CLASSES </span><span class="s2">= [</span><span class="s1">BernoulliNB</span><span class="s2">, </span><span class="s1">CategoricalNB</span><span class="s2">, </span><span class="s1">ComplementNB</span><span class="s2">, </span><span class="s1">MultinomialNB</span><span class="s2">]</span>
<span class="s1">ALL_NAIVE_BAYES_CLASSES </span><span class="s2">= </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES </span><span class="s2">+ [</span><span class="s1">GaussianNB</span><span class="s2">]</span>

<span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;The default value for `force_alpha` will change&quot;</span>
<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">f&quot;ignore:</span><span class="s0">{</span><span class="s1">msg</span><span class="s0">}</span><span class="s3">:FutureWarning&quot;</span><span class="s2">)</span>

<span class="s4"># Data is just 6 separable points in the plane</span>
<span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
<span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">get_random_normal_x_binary_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4"># A bit more random tests</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X1 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">y1 </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">X1</span><span class="s2">, </span><span class="s1">y1</span>


<span class="s0">def </span><span class="s1">get_random_integer_x_three_classes_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4"># Data is 6 random integer points in a 100 dimensional space classified to</span>
    <span class="s4"># three classes.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">100</span><span class="s2">))</span>
    <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
    <span class="s0">return </span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span>


<span class="s0">def </span><span class="s1">test_gnb</span><span class="s2">():</span>
    <span class="s4"># Gaussian Naive Bayes classification.</span>
    <span class="s4"># This checks that GaussianNB implements fit and predict and returns</span>
    <span class="s4"># correct values for a simple toy dataset.</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">()</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">y_pred_proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">y_pred_log_proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_log_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">y_pred_proba</span><span class="s2">), </span><span class="s1">y_pred_log_proba</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>

    <span class="s4"># Test whether label mismatch between target y and classes raises</span>
    <span class="s4"># an Error</span>
    <span class="s4"># FIXME Remove this test once the more general partial_fit tests are merged</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;The target label.* in y do not exist in the initial classes&quot;</span>
    <span class="s2">):</span>
        <span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_gnb_prior</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4"># Test whether class priors are properly set.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]) / </span><span class="s5">6.0</span><span class="s2">, </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">X1</span><span class="s2">, </span><span class="s1">y1 </span><span class="s2">= </span><span class="s1">get_random_normal_x_binary_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
    <span class="s4"># Check that the class priors sum to 1</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(), </span><span class="s5">1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_sample_weight</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test whether sample weights are properly used in GNB.&quot;&quot;&quot;</span>
    <span class="s4"># Sample weights all being 1 should not change results</span>
    <span class="s1">sw </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">clf_sw </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sw</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">, </span><span class="s1">clf_sw</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">, </span><span class="s1">clf_sw</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">)</span>

    <span class="s4"># Fitting twice with half sample-weights should result</span>
    <span class="s4"># in same result as fitting once with full weights</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>

    <span class="s1">sw </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">clf1 </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw</span><span class="s2">)</span>
    <span class="s1">clf2 </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">clf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sw </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">, </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">, </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">)</span>

    <span class="s4"># Check that duplicate entries and correspondingly increased sample</span>
    <span class="s4"># weights yield the same result</span>
    <span class="s1">ind </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s5">20</span><span class="s2">)</span>
    <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bincount</span><span class="s2">(</span><span class="s1">ind</span><span class="s2">, </span><span class="s1">minlength</span><span class="s2">=</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>

    <span class="s1">clf_dupl </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">])</span>
    <span class="s1">clf_sw </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf_dupl</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">, </span><span class="s1">clf_sw</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf_dupl</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">, </span><span class="s1">clf_sw</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">)</span>

    <span class="s4"># non-regression test for gh-24140 where a division by zero was</span>
    <span class="s4"># occurring when a single class was present</span>
    <span class="s1">sample_weight </span><span class="s2">= (</span><span class="s1">y </span><span class="s2">== </span><span class="s5">1</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_neg_priors</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test whether an error is raised in case of negative priors&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">priors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">]))</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Priors must be non-negative&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_priors</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test whether the class prior override is properly used&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">priors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">])).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([[-</span><span class="s5">0.1</span><span class="s2">, -</span><span class="s5">0.1</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.825303662161683</span><span class="s2">, </span><span class="s5">0.174696337838317</span><span class="s2">]]),</span>
        <span class="s5">8</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">]))</span>


<span class="s0">def </span><span class="s1">test_gnb_priors_sum_isclose</span><span class="s2">():</span>
    <span class="s4"># test whether the class prior sum is properly tested&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[-</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s5">2</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s5">3</span><span class="s2">, -</span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s5">4</span><span class="s2">, -</span><span class="s5">5</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s5">5</span><span class="s2">, -</span><span class="s5">4</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">priors </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.08</span><span class="s2">, </span><span class="s5">0.14</span><span class="s2">, </span><span class="s5">0.03</span><span class="s2">, </span><span class="s5">0.16</span><span class="s2">, </span><span class="s5">0.11</span><span class="s2">, </span><span class="s5">0.16</span><span class="s2">, </span><span class="s5">0.07</span><span class="s2">, </span><span class="s5">0.14</span><span class="s2">, </span><span class="s5">0.11</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">])</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">priors</span><span class="s2">=</span><span class="s1">priors</span><span class="s2">)</span>
    <span class="s4"># smoke test for issue #9633</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_wrong_nb_priors</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test whether an error is raised if the number of prior is different 
    from the number of class&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">priors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">]))</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Number of priors must match number of classes&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_prior_greater_one</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test if an error is raised if the sum of prior greater than one&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">priors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]))</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;The sum of the priors should be 1&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_prior_large_bias</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test if good prediction when class prior favor largely one class&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">priors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.99</span><span class="s2">]))</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[-</span><span class="s5">0.1</span><span class="s2">, -</span><span class="s5">0.1</span><span class="s2">]]) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_gnb_check_update_with_no_data</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test when the partial fit is called without any data&quot;&quot;&quot;</span>
    <span class="s4"># Create an empty array</span>
    <span class="s1">prev_points </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">mean </span><span class="s2">= </span><span class="s5">0.0</span>
    <span class="s1">var </span><span class="s2">= </span><span class="s5">1.0</span>
    <span class="s1">x_empty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s5">0</span><span class="s2">, </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]))</span>
    <span class="s1">tmean</span><span class="s2">, </span><span class="s1">tvar </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">.</span><span class="s1">_update_mean_variance</span><span class="s2">(</span><span class="s1">prev_points</span><span class="s2">, </span><span class="s1">mean</span><span class="s2">, </span><span class="s1">var</span><span class="s2">, </span><span class="s1">x_empty</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tmean </span><span class="s2">== </span><span class="s1">mean</span>
    <span class="s0">assert </span><span class="s1">tvar </span><span class="s2">== </span><span class="s1">var</span>


<span class="s0">def </span><span class="s1">test_gnb_partial_fit</span><span class="s2">():</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">clf_pf </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y</span><span class="s2">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">, </span><span class="s1">clf_pf</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">, </span><span class="s1">clf_pf</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">, </span><span class="s1">clf_pf</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">)</span>

    <span class="s1">clf_pf2 </span><span class="s2">= </span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">::</span><span class="s5">2</span><span class="s2">, :], </span><span class="s1">y</span><span class="s2">[</span><span class="s5">0</span><span class="s2">::</span><span class="s5">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y</span><span class="s2">))</span>
    <span class="s1">clf_pf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s5">1</span><span class="s2">::</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">, </span><span class="s1">clf_pf2</span><span class="s2">.</span><span class="s1">theta_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">, </span><span class="s1">clf_pf2</span><span class="s2">.</span><span class="s1">var_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">, </span><span class="s1">clf_pf2</span><span class="s2">.</span><span class="s1">class_prior_</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gnb_naive_bayes_scale_invariance</span><span class="s2">():</span>
    <span class="s4"># Scaling the data should not change the prediction results</span>
    <span class="s1">iris </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">()</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span>
    <span class="s1">labels </span><span class="s2">= [</span><span class="s1">GaussianNB</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">f </span><span class="s2">* </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">f </span><span class="s2">* </span><span class="s1">X</span><span class="s2">) </span><span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s2">[</span><span class="s5">1e-10</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1e10</span><span class="s2">]]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">labels</span><span class="s2">[</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s1">labels</span><span class="s2">[</span><span class="s5">2</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discretenb_prior</span><span class="s2">(</span><span class="s1">DiscreteNaiveBayes</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4"># Test whether class priors are properly set.</span>
    <span class="s1">X2</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">get_random_integer_x_three_classes_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]) / </span><span class="s5">6.0</span><span class="s2">), </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_log_prior_</span><span class="s2">, </span><span class="s5">8</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discretenb_partial_fit</span><span class="s2">(</span><span class="s1">DiscreteNaiveBayes</span><span class="s2">):</span>
    <span class="s1">clf1 </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">()</span>
    <span class="s1">clf1</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s1">clf2 </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">()</span>
    <span class="s1">clf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">class_count_</span><span class="s2">, </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">class_count_</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">DiscreteNaiveBayes </span><span class="s0">is </span><span class="s1">CategoricalNB</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">)):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">feature_count_</span><span class="s2">, </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">feature_count_</span><span class="s2">)</span>

    <span class="s1">clf3 </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">()</span>
    <span class="s4"># all categories have to appear in the first partial fit</span>
    <span class="s1">clf3</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">clf3</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]], [</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">clf3</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">class_count_</span><span class="s2">, </span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">class_count_</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">DiscreteNaiveBayes </span><span class="s0">is </span><span class="s1">CategoricalNB</span><span class="s2">:</span>
        <span class="s4"># the categories for each feature of CategoricalNB are mapped to an</span>
        <span class="s4"># index chronologically with each call of partial fit and therefore</span>
        <span class="s4"># the category_count matrices cannot be compared for equality</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">)):</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span>
                <span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">shape</span>
            <span class="s2">)</span>
            <span class="s1">assert_array_equal</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">),</span>
            <span class="s2">)</span>

        <span class="s4"># assert category 0 occurs 1x in the first class and 0x in the 2nd</span>
        <span class="s4"># class</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]))</span>
        <span class="s4"># assert category 1 occurs 0x in the first class and 2x in the 2nd</span>
        <span class="s4"># class</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]))</span>

        <span class="s4"># assert category 0 occurs 0x in the first class and 1x in the 2nd</span>
        <span class="s4"># class</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s5">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]))</span>
        <span class="s4"># assert category 1 occurs 1x in the first class and 1x in the 2nd</span>
        <span class="s4"># class</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">[</span><span class="s5">1</span><span class="s2">][</span><span class="s5">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf1</span><span class="s2">.</span><span class="s1">feature_count_</span><span class="s2">, </span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">feature_count_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;NaiveBayes&quot;</span><span class="s2">, </span><span class="s1">ALL_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_NB_partial_fit_no_first_classes</span><span class="s2">(</span><span class="s1">NaiveBayes</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4"># classes is required for first call to partial fit</span>
    <span class="s1">X2</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">get_random_integer_x_three_classes_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;classes must be passed on the first call to partial_fit.&quot;</span>
    <span class="s2">):</span>
        <span class="s1">NaiveBayes</span><span class="s2">().</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s4"># check consistency of consecutive classes values</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">NaiveBayes</span><span class="s2">()</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;is not the same as on last call to partial_fit&quot;</span>
    <span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">42</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_discretenb_predict_proba</span><span class="s2">():</span>
    <span class="s4"># Test discrete NB classes' probability scores</span>

    <span class="s4"># The 100s below distinguish Bernoulli from multinomial.</span>
    <span class="s4"># FIXME: write a test to show this.</span>
    <span class="s1">X_bernoulli </span><span class="s2">= [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">100</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]</span>
    <span class="s1">X_multinomial </span><span class="s2">= [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">4</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]</span>

    <span class="s4"># test binary case (1-d output)</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]  </span><span class="s4"># 2 is regression test for binary case, 02e673</span>
    <span class="s0">for </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">, </span><span class="s1">X </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">BernoulliNB</span><span class="s2">, </span><span class="s1">MultinomialNB</span><span class="s2">], [</span><span class="s1">X_bernoulli</span><span class="s2">, </span><span class="s1">X_multinomial</span><span class="s2">]</span>
    <span class="s2">):</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">:]) == </span><span class="s5">2</span>
        <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([</span><span class="s1">X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]]).</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
            <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">]).</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]), </span><span class="s5">6</span>
        <span class="s2">)</span>

    <span class="s4"># test multiclass case (2-d output, must sum to one)</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">, </span><span class="s1">X </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">BernoulliNB</span><span class="s2">, </span><span class="s1">MultinomialNB</span><span class="s2">], [</span><span class="s1">X_bernoulli</span><span class="s2">, </span><span class="s1">X_multinomial</span><span class="s2">]</span>
    <span class="s2">):</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">1</span><span class="s2">]).</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">]).</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([</span><span class="s1">X</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]])), </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">([</span><span class="s1">X</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]])), </span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_log_prior_</span><span class="s2">)), </span><span class="s5">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discretenb_uniform_prior</span><span class="s2">(</span><span class="s1">DiscreteNaiveBayes</span><span class="s2">):</span>
    <span class="s4"># Test whether discrete NB classes fit a uniform prior</span>
    <span class="s4"># when fit_prior=False and class_prior=None</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">()</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">fit_prior</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">prior </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_log_prior_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">prior</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discretenb_provide_prior</span><span class="s2">(</span><span class="s1">DiscreteNaiveBayes</span><span class="s2">):</span>
    <span class="s4"># Test whether discrete NB classes use provided prior</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">(</span><span class="s1">class_prior</span><span class="s2">=[</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">])</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">prior </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_log_prior_</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">prior</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]))</span>

    <span class="s4"># Inconsistent number of classes with prior</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Number of priors must match number of classes&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;is not the same as on last call to partial_fit&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discretenb_provide_prior_with_partial_fit</span><span class="s2">(</span><span class="s1">DiscreteNaiveBayes</span><span class="s2">):</span>
    <span class="s4"># Test whether discrete NB classes use provided prior</span>
    <span class="s4"># when using partial_fit</span>

    <span class="s1">iris </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">()</span>
    <span class="s1">iris_data1</span><span class="s2">, </span><span class="s1">iris_data2</span><span class="s2">, </span><span class="s1">iris_target1</span><span class="s2">, </span><span class="s1">iris_target2 </span><span class="s2">= </span><span class="s1">train_test_split</span><span class="s2">(</span>
        <span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">, </span><span class="s1">test_size</span><span class="s2">=</span><span class="s5">0.4</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">415</span>
    <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">prior </span><span class="s0">in </span><span class="s2">[</span><span class="s0">None</span><span class="s2">, [</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">]]:</span>
        <span class="s1">clf_full </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">(</span><span class="s1">class_prior</span><span class="s2">=</span><span class="s1">prior</span><span class="s2">)</span>
        <span class="s1">clf_full</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">target</span><span class="s2">)</span>
        <span class="s1">clf_partial </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">(</span><span class="s1">class_prior</span><span class="s2">=</span><span class="s1">prior</span><span class="s2">)</span>
        <span class="s1">clf_partial</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">iris_data1</span><span class="s2">, </span><span class="s1">iris_target1</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">clf_partial</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">iris_data2</span><span class="s2">, </span><span class="s1">iris_target2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
            <span class="s1">clf_full</span><span class="s2">.</span><span class="s1">class_log_prior_</span><span class="s2">, </span><span class="s1">clf_partial</span><span class="s2">.</span><span class="s1">class_log_prior_</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_discretenb_sample_weight_multiclass</span><span class="s2">(</span><span class="s1">DiscreteNaiveBayes</span><span class="s2">):</span>
    <span class="s4"># check shape consistency for number of samples at fit time</span>
    <span class="s1">X </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">sample_weight </span><span class="s2">/= </span><span class="s1">sample_weight</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s4"># Check sample weight using the partial_fit method</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">()</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">3</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">3</span><span class="s2">], </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">3</span><span class="s2">])</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">3</span><span class="s2">:], </span><span class="s1">y</span><span class="s2">[</span><span class="s5">3</span><span class="s2">:], </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">[</span><span class="s5">3</span><span class="s2">:])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;DiscreteNaiveBayes&quot;</span><span class="s2">, </span><span class="s1">DISCRETE_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;use_partial_fit&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;train_on_single_class_y&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_discretenb_degenerate_one_class_case</span><span class="s2">(</span>
    <span class="s1">DiscreteNaiveBayes</span><span class="s2">,</span>
    <span class="s1">use_partial_fit</span><span class="s2">,</span>
    <span class="s1">train_on_single_class_y</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s4"># Most array attributes of a discrete naive Bayes classifier should have a</span>
    <span class="s4"># first-axis length equal to the number of classes. Exceptions include:</span>
    <span class="s4"># ComplementNB.feature_all_, CategoricalNB.n_categories_.</span>
    <span class="s4"># Confirm that this is the case for binary problems and the degenerate</span>
    <span class="s4"># case of a single class in the training set, when fitting with `fit` or</span>
    <span class="s4"># `partial_fit`.</span>
    <span class="s4"># Non-regression test for handling degenerate one-class case:</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18974</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">train_on_single_class_y</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">classes </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)))</span>
    <span class="s1">num_classes </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">classes</span><span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">DiscreteNaiveBayes</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">use_partial_fit</span><span class="s2">:</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">classes</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s5">1</span><span class="s2">]) == </span><span class="s1">y</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

    <span class="s4"># Check that attributes have expected first-axis lengths</span>
    <span class="s1">attribute_names </span><span class="s2">= [</span>
        <span class="s3">&quot;classes_&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;class_count_&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;class_log_prior_&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;feature_count_&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;feature_log_prob_&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>
    <span class="s0">for </span><span class="s1">attribute_name </span><span class="s0">in </span><span class="s1">attribute_names</span><span class="s2">:</span>
        <span class="s1">attribute </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">, </span><span class="s1">attribute_name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">attribute </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s4"># CategoricalNB has no feature_count_ attribute</span>
            <span class="s0">continue</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">attribute</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">attribute</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">num_classes</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s4"># CategoricalNB.feature_log_prob_ is a list of arrays</span>
            <span class="s0">for </span><span class="s1">element </span><span class="s0">in </span><span class="s1">attribute</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">element</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">num_classes</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;kind&quot;</span><span class="s2">, (</span><span class="s3">&quot;dense&quot;</span><span class="s2">, </span><span class="s3">&quot;sparse&quot;</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mnnb</span><span class="s2">(</span><span class="s1">kind</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">, </span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># Test Multinomial Naive Bayes classification.</span>
    <span class="s4"># This checks that MultinomialNB implements fit and predict and returns</span>
    <span class="s4"># correct values for a simple toy dataset.</span>
    <span class="s1">X2</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">get_random_integer_x_three_classes_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;dense&quot;</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">X2</span>
    <span class="s0">elif </span><span class="s1">kind </span><span class="s2">== </span><span class="s3">&quot;sparse&quot;</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>

    <span class="s4"># Check the ability to predict the learning set.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Negative values in data passed to&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(-</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>
    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s4"># Verify that np.log(clf.predict_proba(X)) gives the same results as</span>
    <span class="s4"># clf.predict_log_proba(X)</span>
    <span class="s1">y_pred_proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">y_pred_log_proba </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_log_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">y_pred_proba</span><span class="s2">), </span><span class="s1">y_pred_log_proba</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>

    <span class="s4"># Check that incremental fitting yields the same results</span>
    <span class="s1">clf2 </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">()</span>
    <span class="s1">clf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">], </span><span class="s1">y2</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">], </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">))</span>
    <span class="s1">clf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">5</span><span class="s2">], </span><span class="s1">y2</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:</span><span class="s5">5</span><span class="s2">])</span>
    <span class="s1">clf2</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[</span><span class="s5">5</span><span class="s2">:], </span><span class="s1">y2</span><span class="s2">[</span><span class="s5">5</span><span class="s2">:])</span>

    <span class="s1">y_pred2 </span><span class="s2">= </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s1">y_pred_proba2 </span><span class="s2">= </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">y_pred_log_proba2 </span><span class="s2">= </span><span class="s1">clf2</span><span class="s2">.</span><span class="s1">predict_log_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">y_pred_proba2</span><span class="s2">), </span><span class="s1">y_pred_log_proba2</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_pred_proba2</span><span class="s2">, </span><span class="s1">y_pred_proba</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_pred_log_proba2</span><span class="s2">, </span><span class="s1">y_pred_log_proba</span><span class="s2">)</span>

    <span class="s4"># Partial fit on the whole data at once should be the same as fit too</span>
    <span class="s1">clf3 </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">()</span>
    <span class="s1">clf3</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">))</span>

    <span class="s1">y_pred3 </span><span class="s2">= </span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred3</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>
    <span class="s1">y_pred_proba3 </span><span class="s2">= </span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">y_pred_log_proba3 </span><span class="s2">= </span><span class="s1">clf3</span><span class="s2">.</span><span class="s1">predict_log_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">y_pred_proba3</span><span class="s2">), </span><span class="s1">y_pred_log_proba3</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_pred_proba3</span><span class="s2">, </span><span class="s1">y_pred_proba</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y_pred_log_proba3</span><span class="s2">, </span><span class="s1">y_pred_log_proba</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_mnb_prior_unobserved_targets</span><span class="s2">():</span>
    <span class="s4"># test smoothing of prior for yet unobserved targets</span>

    <span class="s4"># Create toy training data</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>

        <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]) == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]) == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]) == </span><span class="s5">0</span>

    <span class="s4"># add a training example with previously unobserved class</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>

        <span class="s1">clf</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]], [</span><span class="s5">2</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]) == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]) == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]) == </span><span class="s5">2</span>


<span class="s0">def </span><span class="s1">test_bnb</span><span class="s2">():</span>
    <span class="s4"># Tests that BernoulliNB when alpha=1.0 gives the same values as</span>
    <span class="s4"># those given for the toy example in Manning, Raghavan, and</span>
    <span class="s4"># Schuetze's &quot;Introduction to Information Retrieval&quot; book:</span>
    <span class="s4"># https://nlp.stanford.edu/IR-book/html/htmledition/the-bernoulli-model-1.html</span>

    <span class="s4"># Training data points are:</span>
    <span class="s4"># Chinese Beijing Chinese (class: China)</span>
    <span class="s4"># Chinese Chinese Shanghai (class: China)</span>
    <span class="s4"># Chinese Macao (class: China)</span>
    <span class="s4"># Tokyo Japan Chinese (class: Japan)</span>

    <span class="s4"># Features are Beijing, Chinese, Japan, Macao, Shanghai, and Tokyo</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s4"># Classes are China (0), Japan (1)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s4"># Fit BernoulliBN w/ alpha = 1.0</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s4"># Check the class prior is correct</span>
    <span class="s1">class_prior </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_log_prior_</span><span class="s2">), </span><span class="s1">class_prior</span><span class="s2">)</span>

    <span class="s4"># Check the feature probabilities are correct</span>
    <span class="s1">feature_prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3.0</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_log_prob_</span><span class="s2">), </span><span class="s1">feature_prob</span><span class="s2">)</span>

    <span class="s4"># Testing data point is:</span>
    <span class="s4"># Chinese Chinese Chinese Tokyo Japan</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>

    <span class="s4"># Check the predictive probabilities are correct</span>
    <span class="s1">unnorm_predict_proba </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.005183999999999999</span><span class="s2">, </span><span class="s5">0.02194787379972565</span><span class="s2">]])</span>
    <span class="s1">predict_proba </span><span class="s2">= </span><span class="s1">unnorm_predict_proba </span><span class="s2">/ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">unnorm_predict_proba</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">predict_proba</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bnb_feature_log_prob</span><span class="s2">():</span>
    <span class="s4"># Test for issue #4268.</span>
    <span class="s4"># Tests that the feature log prob value computed by BernoulliNB when</span>
    <span class="s4"># alpha=1.0 is equal to the expression given in Manning, Raghavan,</span>
    <span class="s4"># and Schuetze's &quot;Introduction to Information Retrieval&quot; book:</span>
    <span class="s4"># http://nlp.stanford.edu/IR-book/html/htmledition/the-bernoulli-model-1.html</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s4"># Fit Bernoulli NB w/ alpha = 1.0</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s4"># Manually form the (log) numerator and denominator that</span>
    <span class="s4"># constitute P(feature presence | class)</span>
    <span class="s1">num </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_count_ </span><span class="s2">+ </span><span class="s5">1.0</span><span class="s2">)</span>
    <span class="s1">denom </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_count_ </span><span class="s2">+ </span><span class="s5">2.0</span><span class="s2">), (</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">], </span><span class="s5">1</span><span class="s2">)).</span><span class="s1">T</span>

    <span class="s4"># Check manual estimate matches</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_log_prob_</span><span class="s2">, (</span><span class="s1">num </span><span class="s2">- </span><span class="s1">denom</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_cnb</span><span class="s2">():</span>
    <span class="s4"># Tests ComplementNB when alpha=1.0 for the toy example in Manning,</span>
    <span class="s4"># Raghavan, and Schuetze's &quot;Introduction to Information Retrieval&quot; book:</span>
    <span class="s4"># https://nlp.stanford.edu/IR-book/html/htmledition/the-bernoulli-model-1.html</span>

    <span class="s4"># Training data points are:</span>
    <span class="s4"># Chinese Beijing Chinese (class: China)</span>
    <span class="s4"># Chinese Chinese Shanghai (class: China)</span>
    <span class="s4"># Chinese Macao (class: China)</span>
    <span class="s4"># Tokyo Japan Chinese (class: Japan)</span>

    <span class="s4"># Features are Beijing, Chinese, Japan, Macao, Shanghai, and Tokyo.</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]</span>
    <span class="s2">)</span>

    <span class="s4"># Classes are China (0), Japan (1).</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s4"># Check that weights are correct. See steps 4-6 in Table 4 of</span>
    <span class="s4"># Rennie et al. (2003).</span>
    <span class="s1">theta </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span>
                <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s2">[</span>
                <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">6 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">3 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">6 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">6 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">6 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">1 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">6 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s5">0 </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">) / (</span><span class="s5">6 </span><span class="s2">+ </span><span class="s5">6</span><span class="s2">),</span>
            <span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">normed_weights </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">):</span>
        <span class="s1">weights</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">normed_weights</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">weights</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] / </span><span class="s1">weights</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s4"># Verify inputs are nonnegative.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">ComplementNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s3">&quot;Negative values in data passed to ComplementNB (input X)&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(-</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s4"># Check that counts/weights are correct.</span>
    <span class="s1">feature_count </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_count_</span><span class="s2">, </span><span class="s1">feature_count</span><span class="s2">)</span>
    <span class="s1">class_count </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">class_count_</span><span class="s2">, </span><span class="s1">class_count</span><span class="s2">)</span>
    <span class="s1">feature_all </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_all_</span><span class="s2">, </span><span class="s1">feature_all</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_log_prob_</span><span class="s2">, </span><span class="s1">weights</span><span class="s2">)</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">ComplementNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">feature_log_prob_</span><span class="s2">, </span><span class="s1">normed_weights</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_categoricalnb</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s4"># Check the ability to predict the training set.</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">()</span>
    <span class="s1">X2</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">get_random_integer_x_three_classes_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>

    <span class="s1">y_pred </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">).</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y_pred</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s1">X3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]])</span>
    <span class="s1">y3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">fit_prior</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X3</span><span class="s2">, </span><span class="s1">y3</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">n_categories_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]))</span>

    <span class="s4"># Check error is raised for X with negative entries</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">error_msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s3">&quot;Negative values in data passed to CategoricalNB (input X)&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s4"># Test alpha</span>
    <span class="s1">X3_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]])</span>
    <span class="s4"># alpha=1 increases the count of all categories by one so the final</span>
    <span class="s4"># probability for each category is not 50/50 but 1/3 to 2/3</span>
    <span class="s1">bayes_numerator </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3 </span><span class="s2">* </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3 </span><span class="s2">* </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">]])</span>
    <span class="s1">bayes_denominator </span><span class="s2">= </span><span class="s1">bayes_numerator</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X3_test</span><span class="s2">), </span><span class="s1">bayes_numerator </span><span class="s2">/ </span><span class="s1">bayes_denominator</span>
    <span class="s2">)</span>

    <span class="s4"># Assert category_count has counted all features</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">category_count_</span><span class="s2">) == </span><span class="s1">X3</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>

    <span class="s4"># Check sample_weight</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">clf </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">fit_prior</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">]))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">n_categories_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]))</span>

    <span class="s0">for </span><span class="s1">factor </span><span class="s0">in </span><span class="s2">[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">0.0001</span><span class="s2">]:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
        <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">]) * </span><span class="s1">factor</span>
        <span class="s1">clf </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">fit_prior</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">sample_weight</span><span class="s2">=</span><span class="s1">sample_weight</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]])), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">]))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">n_categories_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;min_categories, exp_X1_count, exp_X2_count, new_X, exp_n_categories_&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s4"># check min_categories with int &gt; observed categories</span>
        <span class="s2">(</span>
            <span class="s5">3</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]),</span>
        <span class="s2">),</span>
        <span class="s4"># check with list input</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]]),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]),</span>
        <span class="s2">),</span>
        <span class="s4"># check min_categories with min less than actual</span>
        <span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s5">1</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]]),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]),</span>
            <span class="s2">]</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_categoricalnb_with_min_categories</span><span class="s2">(</span>
    <span class="s1">min_categories</span><span class="s2">, </span><span class="s1">exp_X1_count</span><span class="s2">, </span><span class="s1">exp_X2_count</span><span class="s2">, </span><span class="s1">new_X</span><span class="s2">, </span><span class="s1">exp_n_categories_</span>
<span class="s2">):</span>
    <span class="s1">X_n_categories </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y_n_categories </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">expected_prediction </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">])</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">fit_prior</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">min_categories</span><span class="s2">=</span><span class="s1">min_categories</span><span class="s2">)</span>
    <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_n_categories</span><span class="s2">, </span><span class="s1">y_n_categories</span><span class="s2">)</span>
    <span class="s1">X1_count</span><span class="s2">, </span><span class="s1">X2_count </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">category_count_</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X1_count</span><span class="s2">, </span><span class="s1">exp_X1_count</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X2_count</span><span class="s2">, </span><span class="s1">exp_X2_count</span><span class="s2">)</span>
    <span class="s1">predictions </span><span class="s2">= </span><span class="s1">clf</span><span class="s2">.</span><span class="s1">predict</span><span class="s2">(</span><span class="s1">new_X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">predictions</span><span class="s2">, </span><span class="s1">expected_prediction</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">clf</span><span class="s2">.</span><span class="s1">n_categories_</span><span class="s2">, </span><span class="s1">exp_n_categories_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;min_categories, error_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]], </span><span class="s3">&quot;'min_categories' should have shape&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_categoricalnb_min_categories_errors</span><span class="s2">(</span><span class="s1">min_categories</span><span class="s2">, </span><span class="s1">error_msg</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s1">clf </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">fit_prior</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">min_categories</span><span class="s2">=</span><span class="s1">min_categories</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_msg</span><span class="s2">):</span>
        <span class="s1">clf</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_alpha</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s4"># Setting alpha=0 should not output nan results when p(x_i|y_j)=0 is a case</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">nb </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;alpha too small will result in numeric errors, setting alpha = 1.0e-10&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">prob</span><span class="s2">)</span>

    <span class="s1">nb </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2.0 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1.0 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">prob</span><span class="s2">)</span>

    <span class="s1">nb </span><span class="s2">= </span><span class="s1">CategoricalNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">prob</span><span class="s2">)</span>

    <span class="s4"># Test sparse X</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">nb </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">prob</span><span class="s2">)</span>

    <span class="s1">nb </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">2.0 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">, </span><span class="s5">1.0 </span><span class="s2">/ </span><span class="s5">3</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">prob</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_alpha_vector</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s4"># Setting alpha=np.array with same length</span>
    <span class="s4"># as number of features should be fine</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">nb </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">nb</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>

    <span class="s4"># Test feature probabilities uses pseudo-counts (alpha)</span>
    <span class="s1">feature_prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1 </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">5</span><span class="s2">, </span><span class="s5">3 </span><span class="s2">/ </span><span class="s5">5</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">feature_log_prob_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">feature_prob</span><span class="s2">))</span>

    <span class="s4"># Test predictions</span>
    <span class="s1">prob </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">5 </span><span class="s2">/ </span><span class="s5">9</span><span class="s2">, </span><span class="s5">4 </span><span class="s2">/ </span><span class="s5">9</span><span class="s2">], [</span><span class="s5">25 </span><span class="s2">/ </span><span class="s5">49</span><span class="s2">, </span><span class="s5">24 </span><span class="s2">/ </span><span class="s5">49</span><span class="s2">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">.</span><span class="s1">predict_proba</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">prob</span><span class="s2">)</span>

    <span class="s4"># Test alpha non-negative</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, -</span><span class="s5">0.1</span><span class="s2">])</span>
    <span class="s1">m_nb </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">expected_msg </span><span class="s2">= </span><span class="s3">&quot;All values in alpha must be greater than 0.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_msg</span><span class="s2">):</span>
        <span class="s1">m_nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s4"># Test that too small pseudo-counts are replaced</span>
    <span class="s1">ALPHA_MIN </span><span class="s2">= </span><span class="s5">1e-10</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">ALPHA_MIN </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">])</span>
    <span class="s1">m_nb </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">m_nb</span><span class="s2">.</span><span class="s1">partial_fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">classes</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">m_nb</span><span class="s2">.</span><span class="s1">_check_alpha</span><span class="s2">(), [</span><span class="s1">ALPHA_MIN</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">], </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">12</span><span class="s2">)</span>

    <span class="s4"># Test correct dimensions</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">])</span>
    <span class="s1">m_nb </span><span class="s2">= </span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">expected_msg </span><span class="s2">= </span><span class="s3">&quot;When alpha is an array, it should contains `n_features`&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_msg</span><span class="s2">):</span>
        <span class="s1">m_nb</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_check_accuracy_on_digits</span><span class="s2">():</span>
    <span class="s4"># Non regression test to make sure that any further refactoring / optim</span>
    <span class="s4"># of the NB models do not harm the performance on a slightly non-linearly</span>
    <span class="s4"># separable dataset</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">load_digits</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">binary_3v8 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">logical_or</span><span class="s2">(</span><span class="s1">y </span><span class="s2">== </span><span class="s5">3</span><span class="s2">, </span><span class="s1">y </span><span class="s2">== </span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">X_3v8</span><span class="s2">, </span><span class="s1">y_3v8 </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[</span><span class="s1">binary_3v8</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">binary_3v8</span><span class="s2">]</span>

    <span class="s4"># Multinomial NB</span>
    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">10</span><span class="s2">), </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.86</span>

    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">MultinomialNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">10</span><span class="s2">), </span><span class="s1">X_3v8</span><span class="s2">, </span><span class="s1">y_3v8</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.94</span>

    <span class="s4"># Bernoulli NB</span>
    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">10</span><span class="s2">), </span><span class="s1">X </span><span class="s2">&gt; </span><span class="s5">4</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.83</span>

    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">10</span><span class="s2">), </span><span class="s1">X_3v8 </span><span class="s2">&gt; </span><span class="s5">4</span><span class="s2">, </span><span class="s1">y_3v8</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.92</span>

    <span class="s4"># Gaussian NB</span>
    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">GaussianNB</span><span class="s2">(), </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.77</span>

    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">GaussianNB</span><span class="s2">(</span><span class="s1">var_smoothing</span><span class="s2">=</span><span class="s5">0.1</span><span class="s2">), </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.89</span>

    <span class="s1">scores </span><span class="s2">= </span><span class="s1">cross_val_score</span><span class="s2">(</span><span class="s1">GaussianNB</span><span class="s2">(), </span><span class="s1">X_3v8</span><span class="s2">, </span><span class="s1">y_3v8</span><span class="s2">, </span><span class="s1">cv</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">scores</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() &gt; </span><span class="s5">0.86</span>


<span class="s0">def </span><span class="s1">test_check_alpha</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;The provided value for alpha must only be 
    used if alpha &lt; _ALPHA_MIN and force_alpha is True. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/10772 
    &quot;&quot;&quot;</span>
    <span class="s1">_ALPHA_MIN </span><span class="s2">= </span><span class="s5">1e-10</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">b</span><span class="s2">.</span><span class="s1">_check_alpha</span><span class="s2">() == </span><span class="s5">0</span>

    <span class="s1">alphas </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alphas</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s4"># We manually set `n_features_in_` not to have `_check_alpha` err</span>
    <span class="s1">b</span><span class="s2">.</span><span class="s1">n_features_in_ </span><span class="s2">= </span><span class="s1">alphas</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">_check_alpha</span><span class="s2">(), </span><span class="s1">alphas</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s3">&quot;alpha too small will result in numeric errors, setting alpha = %.1e&quot;</span>
        <span class="s2">% </span><span class="s1">_ALPHA_MIN</span>
    <span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">b</span><span class="s2">.</span><span class="s1">_check_alpha</span><span class="s2">() == </span><span class="s1">_ALPHA_MIN</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">b</span><span class="s2">.</span><span class="s1">_check_alpha</span><span class="s2">() == </span><span class="s1">_ALPHA_MIN</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">BernoulliNB</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alphas</span><span class="s2">, </span><span class="s1">force_alpha</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s4"># We manually set `n_features_in_` not to have `_check_alpha` err</span>
    <span class="s1">b</span><span class="s2">.</span><span class="s1">n_features_in_ </span><span class="s2">= </span><span class="s1">alphas</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">_check_alpha</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">_ALPHA_MIN</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;Estimator&quot;</span><span class="s2">, </span><span class="s1">ALL_NAIVE_BAYES_CLASSES</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_predict_joint_proba</span><span class="s2">(</span><span class="s1">Estimator</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s1">X2</span><span class="s2">, </span><span class="s1">y2 </span><span class="s2">= </span><span class="s1">get_random_integer_x_three_classes_y</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">est </span><span class="s2">= </span><span class="s1">Estimator</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>
    <span class="s1">jll </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">predict_joint_log_proba</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>
    <span class="s1">log_prob_x </span><span class="s2">= </span><span class="s1">logsumexp</span><span class="s2">(</span><span class="s1">jll</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">log_prob_x_y </span><span class="s2">= </span><span class="s1">jll </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_2d</span><span class="s2">(</span><span class="s1">log_prob_x</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">est</span><span class="s2">.</span><span class="s1">predict_log_proba</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">), </span><span class="s1">log_prob_x_y</span><span class="s2">)</span>
</pre>
</body>
</html>