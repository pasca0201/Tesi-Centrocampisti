<html>
<head>
<title>test_resampling.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_resampling.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">suppress_warnings</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">conftest </span><span class="s0">import </span><span class="s1">array_api_compatible</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_util </span><span class="s0">import </span><span class="s1">rng_integers</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_array_api </span><span class="s0">import </span><span class="s2">(</span><span class="s1">is_numpy</span><span class="s2">, </span><span class="s1">xp_assert_close</span><span class="s2">,</span>
                                   <span class="s1">xp_assert_equal</span><span class="s2">, </span><span class="s1">array_namespace</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">stats</span><span class="s2">, </span><span class="s1">special</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize </span><span class="s0">import </span><span class="s1">root</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats </span><span class="s0">import </span><span class="s1">bootstrap</span><span class="s2">, </span><span class="s1">monte_carlo_test</span><span class="s2">, </span><span class="s1">permutation_test</span><span class="s2">, </span><span class="s1">power</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">_resampling </span><span class="s0">as </span><span class="s1">_resampling</span>


<span class="s0">def </span><span class="s1">test_bootstrap_iv</span><span class="s2">():</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`data` must be a sequence of samples.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`data` must contain at least one sample.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;each sample in `data` must contain two or more observations...&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= (</span><span class="s3">&quot;When `paired is True`, all samples must have the same length &quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`vectorized` must be `True`, `False`, or `None`.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s3">'ekki'</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`axis` must be an integer.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;could not convert string to float&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s3">'ni'</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a non-negative integer.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=-</span><span class="s4">1000</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a non-negative integer.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000.5</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer or None.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=-</span><span class="s4">1000</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer or None.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1000.5</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`method` must be in&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'ekki'</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`bootstrap_result` must have attribute `bootstrap_distribution'&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">bootstrap_result</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Either `bootstrap_result.bootstrap_distribution.size`&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;'herring' cannot be used to seed a&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">bootstrap</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s3">'herring'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">'basic'</span><span class="s2">, </span><span class="s3">'percentile'</span><span class="s2">, </span><span class="s3">'BCa'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_batch</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s5"># for one-sample statistics, batch size shouldn't affect the result</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)</span>
    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">'basic'</span><span class="s2">, </span><span class="s3">'percentile'</span><span class="s2">, </span><span class="s3">'BCa'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_paired</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s5"># test that `paired` works as expected</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">my_statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">((</span><span class="s1">x</span><span class="s2">-</span><span class="s1">y</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">).</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">my_paired_statistic</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">my_statistic</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">res</span>

    <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>

    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">i</span><span class="s2">,), </span><span class="s1">my_paired_statistic</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">my_statistic</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">'basic'</span><span class="s2">, </span><span class="s3">'percentile'</span><span class="s2">, </span><span class="s3">'BCa'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;paired&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_vectorized</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">):</span>
    <span class="s5"># test that paired is vectorized as expected: when samples are tiled,</span>
    <span class="s5"># CI and standard_error of each axis-slice is the same as those of the</span>
    <span class="s5"># original 1d sample</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">my_statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">) + </span><span class="s1">y</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">) + </span><span class="s1">z</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s1">shape</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">]</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">)</span>
    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">my_statistic</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">=</span><span class="s1">paired</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">bootstrap_distribution</span><span class="s2">.</span><span class="s1">shape</span>
            <span class="s2">== </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">+ (</span><span class="s4">100</span><span class="s2">,))</span>

    <span class="s1">reshape </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">reshape</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">] = </span><span class="s1">n_samples</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">reshape</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">reshape</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">reshape</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">my_statistic</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">=</span><span class="s1">paired</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">,</span>
                    <span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">,</span>
                    <span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">)</span>

    <span class="s1">result_shape </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">result_shape</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">result_shape</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">result_shape</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">result_shape</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail_on_32bit</span><span class="s2">(</span><span class="s3">&quot;MemoryError with BCa observed in CI&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">'basic'</span><span class="s2">, </span><span class="s3">'percentile'</span><span class="s2">, </span><span class="s3">'BCa'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_against_theory</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s5"># based on https://www.statology.org/confidence-intervals-python/</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2442101192988600726</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">5000</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s4">0.95</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">t</span><span class="s2">(</span><span class="s1">df</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">sem</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>
    <span class="s1">expected_interval </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">interval</span><span class="s2">(</span><span class="s1">confidence</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">expected_se </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">std</span><span class="s2">()</span>

    <span class="s1">config </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=(</span><span class="s1">data</span><span class="s2">,), </span><span class="s1">statistic</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">5000</span><span class="s2">,</span>
                  <span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">expected_interval</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">5e-4</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">expected_se</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">3e-4</span><span class="s2">)</span>

    <span class="s1">config</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">bootstrap_result</span><span class="s2">=</span><span class="s1">res</span><span class="s2">))</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">5e-4</span><span class="s2">)</span>

    <span class="s1">config</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">bootstrap_result</span><span class="s2">=</span><span class="s1">res</span><span class="s2">))</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">, </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">ppf</span><span class="s2">(</span><span class="s4">1</span><span class="s2">-</span><span class="s1">alpha</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">5e-4</span><span class="s2">)</span>


<span class="s1">tests_R </span><span class="s2">= {</span><span class="s3">&quot;basic&quot;</span><span class="s2">: (</span><span class="s4">23.77</span><span class="s2">, </span><span class="s4">79.12</span><span class="s2">),</span>
           <span class="s3">&quot;percentile&quot;</span><span class="s2">: (</span><span class="s4">28.86</span><span class="s2">, </span><span class="s4">84.21</span><span class="s2">),</span>
           <span class="s3">&quot;BCa&quot;</span><span class="s2">: (</span><span class="s4">32.31</span><span class="s2">, </span><span class="s4">91.43</span><span class="s2">)}</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method, expected&quot;</span><span class="s2">, </span><span class="s1">tests_R</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_bootstrap_against_R</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s5"># Compare against R's &quot;boot&quot; library</span>
    <span class="s5"># library(boot)</span>

    <span class="s5"># stat &lt;- function (x, a) {</span>
    <span class="s5">#     mean(x[a])</span>
    <span class="s5"># }</span>

    <span class="s5"># x &lt;- c(10, 12, 12.5, 12.5, 13.9, 15, 21, 22,</span>
    <span class="s5">#        23, 34, 50, 81, 89, 121, 134, 213)</span>

    <span class="s5"># # Use a large value so we get a few significant digits for the CI.</span>
    <span class="s5"># n = 1000000</span>
    <span class="s5"># bootresult = boot(x, stat, n)</span>
    <span class="s5"># result &lt;- boot.ci(bootresult)</span>
    <span class="s5"># print(result)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12.5</span><span class="s2">, </span><span class="s4">12.5</span><span class="s2">, </span><span class="s4">13.9</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">22</span><span class="s2">,</span>
                  <span class="s4">23</span><span class="s2">, </span><span class="s4">34</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">81</span><span class="s2">, </span><span class="s4">89</span><span class="s2">, </span><span class="s4">121</span><span class="s2">, </span><span class="s4">134</span><span class="s2">, </span><span class="s4">213</span><span class="s2">])</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000000</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                    <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.005</span><span class="s2">)</span>


<span class="s1">tests_against_itself_1samp </span><span class="s2">= {</span><span class="s3">&quot;basic&quot;</span><span class="s2">: </span><span class="s4">1780</span><span class="s2">,</span>
                              <span class="s3">&quot;percentile&quot;</span><span class="s2">: </span><span class="s4">1784</span><span class="s2">,</span>
                              <span class="s3">&quot;BCa&quot;</span><span class="s2">: </span><span class="s4">1784</span><span class="s2">}</span>


<span class="s0">def </span><span class="s1">test_multisample_BCa_against_R</span><span class="s2">():</span>
    <span class="s5"># Because bootstrap is stochastic, it's tricky to test against reference</span>
    <span class="s5"># behavior. Here, we show that SciPy's BCa CI matches R wboot's BCa CI</span>
    <span class="s5"># much more closely than the other SciPy CIs do.</span>

    <span class="s5"># arbitrary skewed data</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s4">0.75859206</span><span class="s2">, </span><span class="s4">0.5910282</span><span class="s2">, -</span><span class="s4">0.4419409</span><span class="s2">, -</span><span class="s4">0.36654601</span><span class="s2">,</span>
         <span class="s4">0.34955357</span><span class="s2">, -</span><span class="s4">1.38835871</span><span class="s2">, </span><span class="s4">0.76735821</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s4">1.41186073</span><span class="s2">, </span><span class="s4">0.49775975</span><span class="s2">, </span><span class="s4">0.08275588</span><span class="s2">, </span><span class="s4">0.24086388</span><span class="s2">,</span>
         <span class="s4">0.03567057</span><span class="s2">, </span><span class="s4">0.52024419</span><span class="s2">, </span><span class="s4">0.31966611</span><span class="s2">, </span><span class="s4">1.32067634</span><span class="s2">]</span>

    <span class="s5"># a multi-sample statistic for which the BCa CI tends to be different</span>
    <span class="s5"># from the other CIs</span>
    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skew</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skew</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">s1 </span><span class="s2">- </span><span class="s1">s2</span>

    <span class="s5"># compute confidence intervals using each method</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">468865032284792692</span><span class="s2">)</span>

    <span class="s1">res_basic </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'basic'</span><span class="s2">,</span>
                                <span class="s1">batch</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">res_percent </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'percentile'</span><span class="s2">,</span>
                                  <span class="s1">batch</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">res_bca </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'bca'</span><span class="s2">,</span>
                              <span class="s1">batch</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

    <span class="s5"># compute midpoints so we can compare just one number for each</span>
    <span class="s1">mid_basic </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">res_basic</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>
    <span class="s1">mid_percent </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">res_percent</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>
    <span class="s1">mid_bca </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">res_bca</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>

    <span class="s5"># reference for BCA CI computed using R wboot package:</span>
    <span class="s5"># library(wBoot)</span>
    <span class="s5"># library(moments)</span>

    <span class="s5"># x = c(0.75859206, 0.5910282, -0.4419409, -0.36654601,</span>
    <span class="s5">#       0.34955357, -1.38835871,  0.76735821)</span>
    <span class="s5"># y = c(1.41186073, 0.49775975, 0.08275588, 0.24086388,</span>
    <span class="s5">#       0.03567057, 0.52024419, 0.31966611, 1.32067634)</span>

    <span class="s5"># twoskew &lt;- function(x1, y1) {skewness(x1) - skewness(y1)}</span>
    <span class="s5"># boot.two.bca(x, y, skewness, conf.level = 0.95,</span>
    <span class="s5">#              R = 9999, stacked = FALSE)</span>
    <span class="s1">mid_wboot </span><span class="s2">= -</span><span class="s4">1.5519</span>

    <span class="s5"># compute percent difference relative to wboot BCA method</span>
    <span class="s1">diff_basic </span><span class="s2">= (</span><span class="s1">mid_basic </span><span class="s2">- </span><span class="s1">mid_wboot</span><span class="s2">)/</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">mid_wboot</span><span class="s2">)</span>
    <span class="s1">diff_percent </span><span class="s2">= (</span><span class="s1">mid_percent </span><span class="s2">- </span><span class="s1">mid_wboot</span><span class="s2">)/</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">mid_wboot</span><span class="s2">)</span>
    <span class="s1">diff_bca </span><span class="s2">= (</span><span class="s1">mid_bca </span><span class="s2">- </span><span class="s1">mid_wboot</span><span class="s2">)/</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">mid_wboot</span><span class="s2">)</span>

    <span class="s5"># SciPy's BCa CI midpoint is much closer than that of the other methods</span>
    <span class="s0">assert </span><span class="s1">diff_basic </span><span class="s2">&lt; -</span><span class="s4">0.15</span>
    <span class="s0">assert </span><span class="s1">diff_percent </span><span class="s2">&gt; </span><span class="s4">0.15</span>
    <span class="s0">assert </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diff_bca</span><span class="s2">) &lt; </span><span class="s4">0.03</span>


<span class="s0">def </span><span class="s1">test_BCa_acceleration_against_reference</span><span class="s2">():</span>
    <span class="s5"># Compare the (deterministic) acceleration parameter for a multi-sample</span>
    <span class="s5"># problem against a reference value. The example is from [1], but Efron's</span>
    <span class="s5"># value seems inaccurate. Straightorward code for computing the</span>
    <span class="s5"># reference acceleration (0.011008228344026734) is available at:</span>
    <span class="s5"># https://github.com/scipy/scipy/pull/16455#issuecomment-1193400981</span>

    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">40</span><span class="s2">, </span><span class="s4">46</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">52</span><span class="s2">, </span><span class="s4">104</span><span class="s2">, </span><span class="s4">146</span><span class="s2">])</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">16</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">38</span><span class="s2">, </span><span class="s4">94</span><span class="s2">, </span><span class="s4">99</span><span class="s2">, </span><span class="s4">141</span><span class="s2">, </span><span class="s4">197</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s1">data </span><span class="s2">= [</span><span class="s1">z</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">)</span>

    <span class="s1">axis </span><span class="s2">= -</span><span class="s4">1</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s4">0.95</span>
    <span class="s1">theta_hat_b </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">bootstrap_distribution</span>
    <span class="s1">batch </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">a_hat </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_bca_interval</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">,</span>
                                            <span class="s1">theta_hat_b</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a_hat</span><span class="s2">, </span><span class="s4">0.011008228344026734</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method, expected&quot;</span><span class="s2">,</span>
                         <span class="s1">tests_against_itself_1samp</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_bootstrap_against_itself_1samp</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s5"># The expected values in this test were generated using bootstrap</span>
    <span class="s5"># to check for unintended changes in behavior. The test also makes sure</span>
    <span class="s5"># that bootstrap works with multi-sample statistics and that the</span>
    <span class="s5"># `axis` argument works as expected / function is vectorized.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">n </span><span class="s2">= </span><span class="s4">100  </span><span class="s5"># size of sample</span>
    <span class="s1">n_resamples </span><span class="s2">= </span><span class="s4">999  </span><span class="s5"># number of bootstrap resamples used to form each CI</span>
    <span class="s1">confidence_level </span><span class="s2">= </span><span class="s4">0.9</span>

    <span class="s5"># The true mean is 5</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">stat_true </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s5"># Do the same thing 2000 times. (The code is fully vectorized.)</span>
    <span class="s1">n_replications </span><span class="s2">= </span><span class="s4">2000</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_replications</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">data</span><span class="s2">,),</span>
                    <span class="s1">statistic</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">,</span>
                    <span class="s1">confidence_level</span><span class="s2">=</span><span class="s1">confidence_level</span><span class="s2">,</span>
                    <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">n_resamples</span><span class="s2">,</span>
                    <span class="s1">batch</span><span class="s2">=</span><span class="s4">50</span><span class="s2">,</span>
                    <span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                    <span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">ci </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span>

    <span class="s5"># ci contains vectors of lower and upper confidence interval bounds</span>
    <span class="s1">ci_contains_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">ci</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s1">stat_true</span><span class="s2">) &amp; (</span><span class="s1">stat_true </span><span class="s2">&lt; </span><span class="s1">ci</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s1">ci_contains_true </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s5"># ci_contains_true is not inconsistent with confidence_level</span>
    <span class="s1">pvalue </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">binomtest</span><span class="s2">(</span><span class="s1">ci_contains_true</span><span class="s2">, </span><span class="s1">n_replications</span><span class="s2">,</span>
                             <span class="s1">confidence_level</span><span class="s2">).</span><span class="s1">pvalue</span>
    <span class="s0">assert </span><span class="s1">pvalue </span><span class="s2">&gt; </span><span class="s4">0.1</span>


<span class="s1">tests_against_itself_2samp </span><span class="s2">= {</span><span class="s3">&quot;basic&quot;</span><span class="s2">: </span><span class="s4">892</span><span class="s2">,</span>
                              <span class="s3">&quot;percentile&quot;</span><span class="s2">: </span><span class="s4">890</span><span class="s2">}</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method, expected&quot;</span><span class="s2">,</span>
                         <span class="s1">tests_against_itself_2samp</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
<span class="s0">def </span><span class="s1">test_bootstrap_against_itself_2samp</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s5"># The expected values in this test were generated using bootstrap</span>
    <span class="s5"># to check for unintended changes in behavior. The test also makes sure</span>
    <span class="s5"># that bootstrap works with multi-sample statistics and that the</span>
    <span class="s5"># `axis` argument works as expected / function is vectorized.</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">n1 </span><span class="s2">= </span><span class="s4">100  </span><span class="s5"># size of sample 1</span>
    <span class="s1">n2 </span><span class="s2">= </span><span class="s4">120  </span><span class="s5"># size of sample 2</span>
    <span class="s1">n_resamples </span><span class="s2">= </span><span class="s4">999  </span><span class="s5"># number of bootstrap resamples used to form each CI</span>
    <span class="s1">confidence_level </span><span class="s2">= </span><span class="s4">0.9</span>

    <span class="s5"># The statistic we're interested in is the difference in means</span>
    <span class="s0">def </span><span class="s1">my_stat</span><span class="s2">(</span><span class="s1">data1</span><span class="s2">, </span><span class="s1">data2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">):</span>
        <span class="s1">mean1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">data1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">mean2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">data2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">mean1 </span><span class="s2">- </span><span class="s1">mean2</span>

    <span class="s5"># The true difference in the means is -0.1</span>
    <span class="s1">dist1 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">dist2 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">0.1</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">stat_true </span><span class="s2">= </span><span class="s1">dist1</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() - </span><span class="s1">dist2</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>

    <span class="s5"># Do the same thing 1000 times. (The code is fully vectorized.)</span>
    <span class="s1">n_replications </span><span class="s2">= </span><span class="s4">1000</span>
    <span class="s1">data1 </span><span class="s2">= </span><span class="s1">dist1</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_replications</span><span class="s2">, </span><span class="s1">n1</span><span class="s2">))</span>
    <span class="s1">data2 </span><span class="s2">= </span><span class="s1">dist2</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_replications</span><span class="s2">, </span><span class="s1">n2</span><span class="s2">))</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">data1</span><span class="s2">, </span><span class="s1">data2</span><span class="s2">),</span>
                    <span class="s1">statistic</span><span class="s2">=</span><span class="s1">my_stat</span><span class="s2">,</span>
                    <span class="s1">confidence_level</span><span class="s2">=</span><span class="s1">confidence_level</span><span class="s2">,</span>
                    <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">n_resamples</span><span class="s2">,</span>
                    <span class="s1">batch</span><span class="s2">=</span><span class="s4">50</span><span class="s2">,</span>
                    <span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                    <span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">ci </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span>

    <span class="s5"># ci contains vectors of lower and upper confidence interval bounds</span>
    <span class="s1">ci_contains_true </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">ci</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &lt; </span><span class="s1">stat_true</span><span class="s2">) &amp; (</span><span class="s1">stat_true </span><span class="s2">&lt; </span><span class="s1">ci</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s1">ci_contains_true </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s5"># ci_contains_true is not inconsistent with confidence_level</span>
    <span class="s1">pvalue </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">binomtest</span><span class="s2">(</span><span class="s1">ci_contains_true</span><span class="s2">, </span><span class="s1">n_replications</span><span class="s2">,</span>
                             <span class="s1">confidence_level</span><span class="s2">).</span><span class="s1">pvalue</span>
    <span class="s0">assert </span><span class="s1">pvalue </span><span class="s2">&gt; </span><span class="s4">0.1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;basic&quot;</span><span class="s2">, </span><span class="s3">&quot;percentile&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_vectorized_3samp</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s5"># an arbitrary, vectorized statistic</span>
        <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">) </span><span class="s0">for </span><span class="s1">sample </span><span class="s0">in </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic_1d</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">):</span>
        <span class="s5"># the same statistic, not vectorized</span>
        <span class="s0">for </span><span class="s1">sample </span><span class="s0">in </span><span class="s1">data</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>
        <span class="s0">return </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                     <span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">statistic_1d</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                     <span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail_on_32bit</span><span class="s2">(</span><span class="s3">&quot;Failure is not concerning; see gh-14107&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;basic&quot;</span><span class="s2">, </span><span class="s3">&quot;percentile&quot;</span><span class="s2">, </span><span class="s3">&quot;BCa&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_vectorized_1samp</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s5"># an arbitrary, vectorized statistic</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s5"># the same statistic, not vectorized</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>
        <span class="s0">return </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">,</span>
                     <span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">statistic_1d</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">,</span>
                     <span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;basic&quot;</span><span class="s2">, </span><span class="s3">&quot;percentile&quot;</span><span class="s2">, </span><span class="s3">&quot;BCa&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_degenerate</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s4">35 </span><span class="s2">* [</span><span class="s4">10000.</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;BCa&quot;</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s3">'ignore'</span><span class="s2">):</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;The BCa confidence interval cannot be calculated&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">DegenerateDataWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">([</span><span class="s1">data</span><span class="s2">, ], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">([</span><span class="s1">data</span><span class="s2">, ], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, (</span><span class="s4">10000.</span><span class="s2">, </span><span class="s4">10000.</span><span class="s2">))</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;basic&quot;</span><span class="s2">, </span><span class="s3">&quot;percentile&quot;</span><span class="s2">, </span><span class="s3">&quot;BCa&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_gh15678</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s5"># Check that gh-15678 is fixed: when statistic function returned a Python</span>
    <span class="s5"># float, method=&quot;BCa&quot; failed when trying to add a dimension to the float</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">354645618886684</span><span class="s2">)</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= (</span><span class="s1">data</span><span class="s2">,)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skew</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
                    <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">9563</span><span class="s2">))</span>
    <span class="s5"># this always worked because np.apply_along_axis returns NumPy data type</span>
    <span class="s1">ref </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skew</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
                    <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">9563</span><span class="s2">), </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bootstrap_min</span><span class="s2">():</span>
    <span class="s5"># Check that gh-15883 is fixed: percentileofscore should</span>
    <span class="s5"># behave according to the 'mean' behavior and not trigger nan for BCa</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">1891289180021102</span><span class="s2">)</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">true_min </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= (</span><span class="s1">data</span><span class="s2">,)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;BCa&quot;</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
                    <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">3942</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">true_min </span><span class="s2">== </span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;BCa&quot;</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
                     <span class="s1">random_state</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">3942</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(-</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">,</span>
                    <span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(-</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">,</span>
                    <span class="s1">res2</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;additional_resamples&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_re_bootstrap</span><span class="s2">(</span><span class="s1">additional_resamples</span><span class="s2">):</span>
    <span class="s5"># Test behavior of parameter `bootstrap_result`</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">8958153316228384</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>

    <span class="s1">n1 </span><span class="s2">= </span><span class="s4">1000</span>
    <span class="s1">n2 </span><span class="s2">= </span><span class="s1">additional_resamples</span>
    <span class="s1">n3 </span><span class="s2">= </span><span class="s1">n1 </span><span class="s2">+ </span><span class="s1">additional_resamples</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">296689032789913033</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">n1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">,</span>
                          <span class="s1">confidence_level</span><span class="s2">=</span><span class="s4">0.95</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'percentile'</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">n2</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">,</span>
                          <span class="s1">confidence_level</span><span class="s2">=</span><span class="s4">0.90</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'BCa'</span><span class="s2">,</span>
                          <span class="s1">bootstrap_result</span><span class="s2">=</span><span class="s1">res</span><span class="s2">)</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">296689032789913033</span><span class="s2">)</span>
    <span class="s1">ref </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">n3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">,</span>
                          <span class="s1">confidence_level</span><span class="s2">=</span><span class="s4">0.90</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'BCa'</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">,</span>
                    <span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail_on_32bit</span><span class="s2">(</span><span class="s3">&quot;Sensible to machine precision&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">'basic'</span><span class="s2">, </span><span class="s3">'percentile'</span><span class="s2">, </span><span class="s3">'BCa'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_alternative</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">5894822712842015040</span><span class="s2">)</span>
    <span class="s1">dist </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= (</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">100</span><span class="s2">), </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">),)</span>

    <span class="s1">config </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s4">0.9</span><span class="s2">)</span>

    <span class="s1">config</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">bootstrap_result</span><span class="s2">=</span><span class="s1">t</span><span class="s2">))</span>
    <span class="s1">l </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s4">0.95</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">)</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">confidence_level</span><span class="s2">=</span><span class="s4">0.95</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">l</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">,</span>
                    <span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">g</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">,</span>
                    <span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isneginf</span><span class="s2">(</span><span class="s1">l</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isposinf</span><span class="s2">(</span><span class="s1">g</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">'`alternative` must be one of'</span><span class="s2">):</span>
        <span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">(**</span><span class="s1">config</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'ekki-ekki'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_jackknife_resample</span><span class="s2">():</span>
    <span class="s1">shape </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_jackknife_resample</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]):</span>
        <span class="s5"># each resample is indexed along second to last axis</span>
        <span class="s5"># (last axis is the one the statistic will be taken over / consumed)</span>
        <span class="s1">slc </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[..., </span><span class="s1">i</span><span class="s2">, :]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">slc</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_jackknife_resample</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)),</span>
                        <span class="s1">axis</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">y2</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;rng_name&quot;</span><span class="s2">, [</span><span class="s3">&quot;RandomState&quot;</span><span class="s2">, </span><span class="s3">&quot;default_rng&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bootstrap_resample</span><span class="s2">(</span><span class="s1">rng_name</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">, </span><span class="s1">rng_name</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">rng </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">rng_name</span><span class="s0">} </span><span class="s3">not available.&quot;</span><span class="s2">)</span>
    <span class="s1">rng1 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">rng2 </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">n_resamples </span><span class="s2">= </span><span class="s4">10</span>
    <span class="s1">shape </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_bootstrap_resample</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng1</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_resamples</span><span class="s2">):</span>
        <span class="s5"># each resample is indexed along second to last axis</span>
        <span class="s5"># (last axis is the one the statistic will be taken over / consumed)</span>
        <span class="s1">slc </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[..., </span><span class="s1">i</span><span class="s2">, :]</span>

        <span class="s1">js </span><span class="s2">= </span><span class="s1">rng_integers</span><span class="s2">(</span><span class="s1">rng2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">shape</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[..., </span><span class="s1">js</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">slc</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;score&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_percentile_of_score</span><span class="s2">(</span><span class="s1">score</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">p </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_percentile_of_score</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">score</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">vectorized_pos</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">score</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">apply_along_axis</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">percentileofscore</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">score</span><span class="s2">)</span>

    <span class="s1">p2 </span><span class="s2">= </span><span class="s1">vectorized_pos</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">score</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)/</span><span class="s4">100</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">p2</span><span class="s2">, </span><span class="s4">1e-15</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_percentile_along_axis</span><span class="s2">():</span>
    <span class="s5"># the difference between _percentile_along_axis and np.percentile is that</span>
    <span class="s5"># np.percentile gets _all_ the qs for each axis slice, whereas</span>
    <span class="s5"># _percentile_along_axis gets the q corresponding with each axis slice</span>

    <span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s1">q </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">shape</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]) * </span><span class="s4">100</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_percentile_along_axis</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">percentile</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">q</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s4">1e-15</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_vectorize_statistic</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s5"># test that _vectorize_statistic vectorizes a statistic along `axis`</span>

    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s5"># an arbitrary, vectorized statistic</span>
        <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">) </span><span class="s0">for </span><span class="s1">sample </span><span class="s0">in </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic_1d</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">):</span>
        <span class="s5"># the same statistic, not vectorized</span>
        <span class="s0">for </span><span class="s1">sample </span><span class="s0">in </span><span class="s1">data</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">sample</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>
        <span class="s0">return </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s5"># vectorize the non-vectorized statistic</span>
    <span class="s1">statistic2 </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">statistic_1d</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)</span>

    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">statistic2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;basic&quot;</span><span class="s2">, </span><span class="s3">&quot;percentile&quot;</span><span class="s2">, </span><span class="s3">&quot;BCa&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_vector_valued_statistic</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s5"># Generate 95% confidence interval around MLE of normal distribution</span>
    <span class="s5"># parameters. Repeat 100 times, each time on sample of size 100.</span>
    <span class="s5"># Check that confidence interval contains true parameters ~95 times.</span>
    <span class="s5"># Confidence intervals are estimated and stochastic; a test failure</span>
    <span class="s5"># does not necessarily indicate that something is wrong. More important</span>
    <span class="s5"># than values of `counts` below is that the shapes of the outputs are</span>
    <span class="s5"># correct.</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2196847219</span><span class="s2">)</span>
    <span class="s1">params </span><span class="s2">= </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.5</span>
    <span class="s1">sample </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(*</span><span class="s1">params</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">), </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">),</span>
                           <span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">ddof</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)])</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">sample</span><span class="s2">,), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">,</span>
                    <span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">9999</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">200</span><span class="s2">)</span>

    <span class="s1">counts </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">.</span><span class="s1">T </span><span class="s2">&lt; </span><span class="s1">params</span><span class="s2">)</span>
                    <span class="s2">&amp; (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">.</span><span class="s1">T </span><span class="s2">&gt; </span><span class="s1">params</span><span class="s2">),</span>
                    <span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">counts </span><span class="s2">&gt;= </span><span class="s4">90</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">counts </span><span class="s2">&lt;= </span><span class="s4">100</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">standard_error</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">bootstrap_distribution</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">9999</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">'ignore::RuntimeWarning'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_vector_valued_statistic_gh17715</span><span class="s2">():</span>
    <span class="s5"># gh-17715 reported a mistake introduced in the extension of BCa to</span>
    <span class="s5"># multi-sample statistics; a `len` should have been `.shape[-1]`. Check</span>
    <span class="s5"># that this is resolved.</span>

    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">141921000979291141</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">concordance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s1">xm </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">ym </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">cov </span><span class="s2">= ((</span><span class="s1">x </span><span class="s2">- </span><span class="s1">xm</span><span class="s2">[..., </span><span class="s0">None</span><span class="s2">]) * (</span><span class="s1">y </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">[..., </span><span class="s0">None</span><span class="s2">])).</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">cov</span><span class="s2">) / (</span><span class="s1">x</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">) + </span><span class="s1">y</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">) + (</span><span class="s1">xm </span><span class="s2">- </span><span class="s1">ym</span><span class="s2">) ** </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">tn</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">tp </span><span class="s2">+ </span><span class="s1">fp</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">tp </span><span class="s2">+ </span><span class="s1">fn</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan_to_num</span><span class="s2">(</span><span class="s1">concordance</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">statistic_extradim</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">, ...]</span>

    <span class="s1">data </span><span class="s2">= [[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],  </span><span class="s5"># (tp, tn, fp, fn)</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">T</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic_extradim</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ref </span><span class="s2">= </span><span class="s1">bootstrap</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">, </span><span class="s1">paired</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],</span>
                    <span class="s1">ref</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">low</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],</span>
                    <span class="s1">ref</span><span class="s2">.</span><span class="s1">confidence_interval</span><span class="s2">.</span><span class="s1">high</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gh_20850</span><span class="s2">():</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2085020850</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">11</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

    <span class="s5"># The shapes do *not* need to be the same along axis</span>
    <span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">)</span>
    <span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">T</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s5"># But even when the shapes *are* the same along axis, the lengths</span>
    <span class="s5"># along other dimensions have to be the same (or `bootstrap` warns).</span>
    <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Ignoring the dimension specified by `axis`...&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:</span><span class="s4">10</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]), </span><span class="s1">statistic</span><span class="s2">)  </span><span class="s5"># this won't work after 1.16</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:</span><span class="s4">10</span><span class="s2">, </span><span class="s4">0</span><span class="s2">:</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">statistic</span><span class="s2">)  </span><span class="s5"># this will</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
        <span class="s1">stats</span><span class="s2">.</span><span class="s1">bootstrap</span><span class="s2">((</span><span class="s1">x</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">T</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">1</span><span class="s2">, :</span><span class="s4">10</span><span class="s2">]), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)  </span><span class="s5"># this will</span>


<span class="s5"># --- Test Monte Carlo Hypothesis Test --- #</span>

<span class="s0">class </span><span class="s1">TestMonteCarloHypothesisTest</span><span class="s2">:</span>
    <span class="s1">atol </span><span class="s2">= </span><span class="s4">2.5e-2  </span><span class="s5"># for comparing p-value</span>

    <span class="s0">def </span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rvs_in</span><span class="s2">, </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">np</span><span class="s2">):</span>
        <span class="s0">return lambda </span><span class="s2">*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">: </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">rvs_in</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rs</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">),</span>
                                                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_statistic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s1">m </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
            <span class="s1">v </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">correction</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">n </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">]</span>
            <span class="s0">return </span><span class="s1">m </span><span class="s2">/ (</span><span class="s1">v</span><span class="s2">/</span><span class="s1">n</span><span class="s2">)**</span><span class="s4">0.5</span>
            <span class="s5"># return stats.ttest_1samp(x, popmean=0., axis=axis).statistic)</span>
        <span class="s0">return </span><span class="s1">statistic</span>

    <span class="s2">@</span><span class="s1">array_api_compatible</span>
    <span class="s0">def </span><span class="s1">test_input_validation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># test that the appropriate error messages are raised for invalid input</span>

        <span class="s1">data </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">])</span>
        <span class="s0">def </span><span class="s1">stat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Array shapes are incompatible for broadcasting.&quot;</span>
        <span class="s1">temp </span><span class="s2">= (</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)))</span>
        <span class="s1">rvs </span><span class="s2">= (</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">temp</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`axis` must be an integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`vectorized` must be `True`, `False`, or `None`.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`rvs` must be callable or sequence of callables.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">temp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">], [</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]])</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">temp</span><span class="s2">, [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">stat</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;If `rvs` is a sequence...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">temp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">]])</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">temp</span><span class="s2">, [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">], </span><span class="s1">stat</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`statistic` must be callable.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a positive integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=-</span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a positive integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer or None.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=-</span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer or None.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1000.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`alternative` must be in...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'ekki'</span><span class="s2">)</span>

        <span class="s5"># *If* this raises a value error, make sure it has the intended message</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;Signature inspection of statistic&quot;</span>
        <span class="s0">def </span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">))</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">).</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">array_api_compatible</span>
    <span class="s0">def </span><span class="s1">test_input_validation_xp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">non_vectorized_statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`statistic` must be vectorized...&quot;</span>
        <span class="s1">sample </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">non_vectorized_statistic</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">non_vectorized_statistic</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">sample</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xslow</span>
    <span class="s2">@</span><span class="s1">array_api_compatible</span>
    <span class="s0">def </span><span class="s1">test_batch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># make sure that the `batch` parameter is respected by checking the</span>
        <span class="s5"># maximum batch size provided in calls to `statistic`</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">23492340193</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">))</span>

        <span class="s1">xp_test </span><span class="s2">= </span><span class="s1">array_namespace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)  </span><span class="s5"># numpy.std doesn't have `correction`</span>
        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s1">batch_size </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">else </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
            <span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">)</span>
            <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">+= </span><span class="s4">1</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_statistic</span><span class="s2">(</span><span class="s1">xp_test</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size </span><span class="s2">= </span><span class="s4">0</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'sample'</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s3">'statistic'</span><span class="s2">: </span><span class="s1">statistic</span><span class="s2">,</span>
                <span class="s3">'n_resamples'</span><span class="s2">: </span><span class="s4">1000</span><span class="s2">, </span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>

        <span class="s1">kwds</span><span class="s2">[</span><span class="s3">'rvs'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">328423</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">1001</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">kwds</span><span class="s2">[</span><span class="s3">'rvs'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">328423</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>
        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">batch</span><span class="s2">=</span><span class="s4">50</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">21</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">kwds</span><span class="s2">[</span><span class="s3">'rvs'</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">328423</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>
        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(**</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">array_api_compatible</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'axis'</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(-</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_axis_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># test that Nd-array samples are handled correctly for valid values</span>
        <span class="s5"># of the `axis` parameter; also make sure non-default dtype is maintained</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2389234</span><span class="s2">)</span>
        <span class="s1">size </span><span class="s2">= [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">size</span><span class="s2">[</span><span class="s1">axis</span><span class="s2">] = </span><span class="s4">100</span>

        <span class="s5"># Determine non-default dtype</span>
        <span class="s1">dtype_default </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s4">1.</span><span class="s2">).</span><span class="s1">dtype</span>
        <span class="s1">dtype_str </span><span class="s2">= </span><span class="s3">'float32'</span><span class="s0">if </span><span class="s2">(</span><span class="s3">&quot;64&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">dtype_default</span><span class="s2">)) </span><span class="s0">else </span><span class="s3">'float64'</span>
        <span class="s1">dtype_np </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">, </span><span class="s1">dtype_str</span><span class="s2">)</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">, </span><span class="s1">dtype_str</span><span class="s2">)</span>

        <span class="s5"># ttest_1samp is CPU array-API compatible, but it would be good to</span>
        <span class="s5"># include CuPy in this test. We'll perform ttest_1samp with a</span>
        <span class="s5"># NumPy array, but all the rest with be done with fully array-API</span>
        <span class="s5"># compatible code.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype_np</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">popmean</span><span class="s2">=</span><span class="s4">0.</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">xp_test </span><span class="s2">= </span><span class="s1">array_namespace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)  </span><span class="s5"># numpy.std doesn't have `correction`</span>
        <span class="s1">statistic </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_statistic</span><span class="s2">(</span><span class="s1">xp_test</span><span class="s2">)</span>
        <span class="s1">rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">20000</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">ref_statistic </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">ref_pvalue </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">ref_statistic</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">ref_pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">array_api_compatible</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;two-sided&quot;</span><span class="s2">, </span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_alternative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># test that `alternative` is working as expected</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">65723433</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">30</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">xp_test </span><span class="s2">= </span><span class="s1">array_namespace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)  </span><span class="s5"># numpy.std doesn't have `correction`</span>
        <span class="s1">statistic </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_statistic</span><span class="s2">(</span><span class="s1">xp_test</span><span class="s2">)</span>
        <span class="s1">rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">))</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>


    <span class="s5"># Tests below involve statistics that are not yet array-API compatible.</span>
    <span class="s5"># They can be converted when the statistics are converted.</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))  </span><span class="s5"># skewness</span>
    <span class="s0">def </span><span class="s1">test_against_ks_1samp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s5"># test that monte_carlo_test can reproduce pvalue of ks_1samp</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">65723433</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skewnorm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">30</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ks_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ks_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'asymp'</span><span class="s2">,</span>
                                  <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">norm_rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">norm_rvs</span><span class="s2">, </span><span class="s1">statistic1d</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">alternative </span><span class="s2">== </span><span class="s3">'greater'</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">alternative </span><span class="s2">== </span><span class="s3">'less'</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s4">1</span><span class="s2">-</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'hypotest'</span><span class="s2">, (</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skewtest</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">kurtosistest</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">, </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))  </span><span class="s5"># skewness</span>
    <span class="s0">def </span><span class="s1">test_against_normality_tests</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">hypotest</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s5"># test that monte_carlo_test can reproduce pvalue of normality tests</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">85723405</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skewnorm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">150</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">hypotest</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">hypotest</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">norm_rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">norm_rvs</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))  </span><span class="s5"># skewness parameter</span>
    <span class="s0">def </span><span class="s1">test_against_normaltest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s5"># test that monte_carlo_test can reproduce pvalue of normaltest</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12340513</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skewnorm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">150</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">normaltest</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">normaltest</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">norm_rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">norm_rvs</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xslow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))  </span><span class="s5"># skewness</span>
    <span class="s0">def </span><span class="s1">test_against_cramervonmises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s5"># test that monte_carlo_test can reproduce pvalue of cramervonmises</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">234874135</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">skewnorm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">30</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">cramervonmises</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">cramervonmises</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">cdf</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">norm_rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">norm_rvs</span><span class="s2">, </span><span class="s1">statistic1d</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'dist_name'</span><span class="s2">, (</span><span class="s3">'norm'</span><span class="s2">, </span><span class="s3">'logistic'</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'i'</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_anderson</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">, </span><span class="s1">i</span><span class="s2">):</span>
        <span class="s5"># test that monte_carlo_test can reproduce results of `anderson`. Note:</span>
        <span class="s5"># `anderson` does not provide a p-value; it provides a list of</span>
        <span class="s5"># significance levels and the associated critical value of the test</span>
        <span class="s5"># statistic. `i` used to index this list.</span>

        <span class="s5"># find the skewness for which the sample statistic matches one of the</span>
        <span class="s5"># critical values provided by `stats.anderson`</span>

        <span class="s0">def </span><span class="s1">fun</span><span class="s2">(</span><span class="s1">a</span><span class="s2">):</span>
            <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">394295467</span><span class="s2">)</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">tukeylambda</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">anderson</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic </span><span class="s2">- </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">critical_values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
            <span class="s1">sol </span><span class="s2">= </span><span class="s1">root</span><span class="s2">(</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sol</span><span class="s2">.</span><span class="s1">success</span>

        <span class="s5"># get the significance level (p-value) associated with that critical</span>
        <span class="s5"># value</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">sol</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">394295467</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">tukeylambda</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">anderson</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">)</span>
        <span class="s1">expected_stat </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span>
        <span class="s1">expected_p </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">significance_level</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]/</span><span class="s4">100</span>

        <span class="s5"># perform equivalent Monte Carlo test and compare results</span>
        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">anderson</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">dist_rvs </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_rvs</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">, </span><span class="s1">dist_name</span><span class="s2">).</span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dist_rvs</span><span class="s2">,</span>
                                   <span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
                                   <span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected_stat</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_p</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_p_never_zero</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Use biased estimate of p-value to ensure that p-value is never zero</span>
        <span class="s5"># per monte_carlo_test reference [1]</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2190176673029737545</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">,</span>
                               <span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue </span><span class="s2">== </span><span class="s4">0.0001</span>

    <span class="s0">def </span><span class="s1">test_against_ttest_ind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># test that `monte_carlo_test` can reproduce results of `ttest_ind`.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">219017667302737545</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)  </span><span class="s5"># broadcastable</span>
        <span class="s1">rvs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span>
        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], [</span><span class="s1">data</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">2e-2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_against_f_oneway</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># test that `monte_carlo_test` can reproduce results of `f_oneway`.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">219017667302737545</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">101</span><span class="s2">)),</span>
                <span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">102</span><span class="s2">)), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">103</span><span class="s2">)))</span>
        <span class="s1">rvs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">f_oneway</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">,</span>
                                     <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">f_oneway</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail_on_32bit</span><span class="s2">(</span><span class="s3">&quot;Statistic may not depend on sample order on 32-bit&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_finite_precision_statistic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Some statistics return numerically distinct values when the values</span>
        <span class="s5"># should be equal in theory. Test that `monte_carlo_test` accounts</span>
        <span class="s5"># for this in some way.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2549824598234528</span><span class="s2">)</span>
        <span class="s1">n_resamples </span><span class="s2">= </span><span class="s4">9999</span>
        <span class="s0">def </span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s4">1. </span><span class="s2">* </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">bernoulli</span><span class="s2">(</span><span class="s1">p</span><span class="s2">=</span><span class="s4">0.333</span><span class="s2">).</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">rvs</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">monte_carlo_test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">var</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">,</span>
                                     <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">n_resamples</span><span class="s2">)</span>
        <span class="s5"># show that having a tolerance matters</span>
        <span class="s1">c0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution </span><span class="s2">&lt;= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">)</span>
        <span class="s1">c1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution </span><span class="s2">&lt;= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">*(</span><span class="s4">1</span><span class="s2">+</span><span class="s4">1e-15</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">c0 </span><span class="s2">!= </span><span class="s1">c1</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue </span><span class="s2">== (</span><span class="s1">c1 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)/(</span><span class="s1">n_resamples </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPower</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_input_validation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># test that the appropriate error messages are raised for invalid input</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">8519895914314711673</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span>
        <span class="s1">rvs </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">)</span>
        <span class="s1">n_observations </span><span class="s2">= (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`vectorized` must be `True`, `False`, or `None`.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`rvs` must be callable or sequence of callables.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s3">'ekki'</span><span class="s2">), </span><span class="s1">n_observations</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;If `rvs` is a sequence...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">,), </span><span class="s1">n_observations</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, (</span><span class="s4">10</span><span class="s2">,))</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`significance` must contain floats between 0 and 1.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">significance</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">significance</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`kwargs` must be a dictionary&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;shape mismatch: objects cannot be broadcast&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, ([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">], [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">14</span><span class="s2">]))</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, ([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">], [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">13</span><span class="s2">]), </span><span class="s1">kwargs</span><span class="s2">={</span><span class="s3">'x'</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`test` must be callable&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a positive integer&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=-</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">10.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=-</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">10.5</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_batch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># make sure that the `batch` parameter is respected by checking the</span>
        <span class="s5"># maximum batch size provided in calls to `test`</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">23492340193</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s1">batch_size </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">else </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">test</span><span class="s2">.</span><span class="s1">batch_size </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s1">test</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">)</span>
            <span class="s1">test</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">+= </span><span class="s4">1</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">pvalue</span>
        <span class="s1">test</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">test</span><span class="s2">.</span><span class="s1">batch_size </span><span class="s2">= </span><span class="s4">0</span>

        <span class="s1">kwds </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">test</span><span class="s2">=</span><span class="s1">test</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">23492340193</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">power</span><span class="s2">(**</span><span class="s1">kwds</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">23492340193</span><span class="s2">)</span>
        <span class="s1">test</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">power</span><span class="s2">(**</span><span class="s1">kwds</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">23492340193</span><span class="s2">)</span>
        <span class="s1">test</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">power</span><span class="s2">(**</span><span class="s1">kwds</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">test</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">.</span><span class="s1">power</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">.</span><span class="s1">power</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_vectorization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test that `power` is vectorized as expected</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">25495254834552</span><span class="s2">)</span>

        <span class="s5"># Single vectorized call</span>
        <span class="s1">popmeans </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">])</span>
        <span class="s0">def </span><span class="s1">test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">):</span>
            <span class="s5"># ensure that popmeans axis is zeroth and orthogonal to the rest</span>
            <span class="s1">popmeans_expanded </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">expand_dims</span><span class="s2">(</span><span class="s1">popmeans</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)))</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">popmeans_expanded</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">,</span>
                                     <span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s5"># nx and kwargs broadcast against one another</span>
        <span class="s1">nx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">10</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">50</span><span class="s2">, </span><span class="s4">100</span><span class="s2">])[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
        <span class="s1">kwargs </span><span class="s2">= {</span><span class="s3">'alternative'</span><span class="s2">: [</span><span class="s3">'less'</span><span class="s2">, </span><span class="s3">'greater'</span><span class="s2">, </span><span class="s3">'two-sided'</span><span class="s2">]}</span>

        <span class="s5"># This dimension is added to the beginning</span>
        <span class="s1">significance </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0.01</span><span class="s2">, </span><span class="s4">0.025</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">nx</span><span class="s2">, </span><span class="s1">significance</span><span class="s2">=</span><span class="s1">significance</span><span class="s2">,</span>
                          <span class="s1">kwargs</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s5"># Looping over all combinations</span>
        <span class="s1">ref </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">significance_i </span><span class="s0">in </span><span class="s1">significance</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">nx_i </span><span class="s0">in </span><span class="s1">nx</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">alternative_i </span><span class="s0">in </span><span class="s1">kwargs</span><span class="s2">[</span><span class="s3">'alternative'</span><span class="s2">]:</span>
                    <span class="s0">for </span><span class="s1">popmean_i </span><span class="s0">in </span><span class="s1">popmeans</span><span class="s2">:</span>
                        <span class="s0">def </span><span class="s1">test2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">):</span>
                            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_1samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">popmean_i</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">,</span>
                                                     <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative_i</span><span class="s2">)</span>

                        <span class="s1">tmp </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">test2</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">nx_i</span><span class="s2">,</span>
                                          <span class="s1">significance</span><span class="s2">=</span><span class="s1">significance_i</span><span class="s2">)</span>
                        <span class="s1">ref</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">tmp</span><span class="s2">.</span><span class="s1">power</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">power</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s5"># Show that results are similar</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">2e-2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ttest_ind_null</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that the p-values of `ttest_ind` are uniformly distributed under</span>
        <span class="s5"># the null hypothesis</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">254952548345528</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span>
        <span class="s1">n_observations </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">10</span><span class="s2">))</span>
        <span class="s1">rvs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span>
        <span class="s1">significance </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0.01</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">rvs</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">, </span><span class="s1">significance</span><span class="s2">=</span><span class="s1">significance</span><span class="s2">)</span>
        <span class="s1">significance </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">significance</span><span class="s2">[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">], </span><span class="s1">res</span><span class="s2">.</span><span class="s1">power</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">significance</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ttest_1samp_power</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check simulated ttest_1samp power against reference</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">254952548345528</span><span class="s2">)</span>

        <span class="s5"># Reference values computed with statmodels</span>
        <span class="s5"># import numpy as np</span>
        <span class="s5"># from statsmodels.stats.power import tt_solve_power</span>
        <span class="s5"># tt_solve_power = np.vectorize(tt_solve_power)</span>
        <span class="s5"># tt_solve_power([0.1, 0.5, 0.9], [[10], [20]], [[[0.01]], [[0.05]]])</span>
        <span class="s1">ref </span><span class="s2">= [[[</span><span class="s4">0.0126515 </span><span class="s2">, </span><span class="s4">0.10269751</span><span class="s2">, </span><span class="s4">0.40415802</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">0.01657775</span><span class="s2">, </span><span class="s4">0.29734608</span><span class="s2">, </span><span class="s4">0.86228288</span><span class="s2">]],</span>
               <span class="s2">[[</span><span class="s4">0.0592903 </span><span class="s2">, </span><span class="s4">0.29317561</span><span class="s2">, </span><span class="s4">0.71718121</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">0.07094116</span><span class="s2">, </span><span class="s4">0.56450441</span><span class="s2">, </span><span class="s4">0.96815163</span><span class="s2">]]]</span>

        <span class="s1">kwargs </span><span class="s2">= {</span><span class="s3">'popmean'</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.9</span><span class="s2">]}</span>
        <span class="s1">n_observations </span><span class="s2">= [[</span><span class="s4">10</span><span class="s2">], [</span><span class="s4">20</span><span class="s2">]]</span>
        <span class="s1">significance </span><span class="s2">= [</span><span class="s4">0.01</span><span class="s2">, </span><span class="s4">0.05</span><span class="s2">]</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">power</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_1samp</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">, </span><span class="s1">n_observations</span><span class="s2">,</span>
                          <span class="s1">significance</span><span class="s2">=</span><span class="s1">significance</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">=</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">power</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestPermutationTest</span><span class="s2">:</span>

    <span class="s1">rtol </span><span class="s2">= </span><span class="s4">1e-14</span>

    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">7170559330470561044</span><span class="s2">)</span>

    <span class="s5"># -- Input validation -- #</span>

    <span class="s0">def </span><span class="s1">test_permutation_test_iv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s0">def </span><span class="s1">stat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;each sample in `data` must contain two or more ...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`data` must be a tuple containing at least two samples&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">((</span><span class="s4">1</span><span class="s2">,), </span><span class="s1">stat</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`axis` must be an integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`permutation_type` must be in...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">,</span>
                             <span class="s1">permutation_type</span><span class="s2">=</span><span class="s3">&quot;ekki&quot;</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`vectorized` must be `True`, `False`, or `None`.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a positive integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=-</span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`n_resamples` must be a positive integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer or None.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=-</span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`batch` must be a positive integer or None.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1000.5</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;`alternative` must be in...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'ekki'</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;'herring' cannot be used to seed a&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">permutation_test</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">stat</span><span class="s2">,</span>
                             <span class="s1">random_state</span><span class="s2">=</span><span class="s3">'herring'</span><span class="s2">)</span>

    <span class="s5"># -- Test Parameters -- #</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'random_state'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">,</span>
                                              <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'permutation_type'</span><span class="s2">,</span>
                             <span class="s2">[</span><span class="s3">'pairings'</span><span class="s2">, </span><span class="s3">'samples'</span><span class="s2">, </span><span class="s3">'independent'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_batch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">permutation_type</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">):</span>
        <span class="s5"># make sure that the `batch` parameter is respected by checking the</span>
        <span class="s5"># maximum batch size provided in calls to `statistic`</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s1">batch_size </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">else </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">)</span>
            <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">+= </span><span class="s4">1</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size </span><span class="s2">= </span><span class="s4">0</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'n_resamples'</span><span class="s2">: </span><span class="s4">1000</span><span class="s2">, </span><span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s1">permutation_type</span><span class="s2">,</span>
                <span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
                                      <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">1001</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">50</span><span class="s2">,</span>
                                      <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">21</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">,</span>
                                      <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">counter</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">.</span><span class="s1">batch_size</span><span class="s2">, </span><span class="s4">1000</span><span class="s2">)</span>

        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'random_state'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">,</span>
                                              <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'permutation_type, exact_size'</span><span class="s2">,</span>
                             <span class="s2">[(</span><span class="s3">'pairings'</span><span class="s2">, </span><span class="s1">special</span><span class="s2">.</span><span class="s1">factorial</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">),</span>
                              <span class="s2">(</span><span class="s3">'samples'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">3</span><span class="s2">),</span>
                              <span class="s2">(</span><span class="s3">'independent'</span><span class="s2">, </span><span class="s1">special</span><span class="s2">.</span><span class="s1">binom</span><span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))])</span>
    <span class="s0">def </span><span class="s1">test_permutations</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">permutation_type</span><span class="s2">, </span><span class="s1">exact_size</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">):</span>
        <span class="s5"># make sure that the `permutations` parameter is respected by checking</span>
        <span class="s5"># the size of the null distribution</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s1">permutation_type</span><span class="s2">,</span>
                <span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">}</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
                                     <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">.</span><span class="s1">size</span><span class="s2">, </span><span class="s1">exact_size</span><span class="s2">)</span>

    <span class="s5"># -- Randomized Permutation Tests -- #</span>

    <span class="s5"># To get reasonable accuracy, these next three tests are somewhat slow.</span>
    <span class="s5"># Originally, I had them passing for all combinations of permutation type,</span>
    <span class="s5"># alternative, and RNG, but that takes too long for CI. Instead, split</span>
    <span class="s5"># into three tests, each testing a particular combination of the three</span>
    <span class="s5"># parameters.</span>

    <span class="s0">def </span><span class="s1">test_randomized_test_against_exact_both</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># check that the randomized and exact tests agree to reasonable</span>
        <span class="s5"># precision for permutation_type='both</span>

        <span class="s1">alternative</span><span class="s2">, </span><span class="s1">rng </span><span class="s2">= </span><span class="s3">'less'</span><span class="s2">, </span><span class="s4">0</span>

        <span class="s1">nx</span><span class="s2">, </span><span class="s1">ny</span><span class="s2">, </span><span class="s1">permutations </span><span class="s2">= </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">24000</span>
        <span class="s0">assert </span><span class="s1">special</span><span class="s2">.</span><span class="s1">binom</span><span class="s2">(</span><span class="s1">nx </span><span class="s2">+ </span><span class="s1">ny</span><span class="s2">, </span><span class="s1">nx</span><span class="s2">) &gt; </span><span class="s1">permutations</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">nx</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">ny</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'independent'</span><span class="s2">,</span>
                <span class="s3">'batch'</span><span class="s2">: </span><span class="s4">100</span><span class="s2">, </span><span class="s3">'alternative'</span><span class="s2">: </span><span class="s1">alternative</span><span class="s2">, </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">rng</span><span class="s2">}</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">permutations</span><span class="s2">,</span>
                               <span class="s2">**</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic </span><span class="s2">== </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span><span class="s2">()</span>
    <span class="s0">def </span><span class="s1">test_randomized_test_against_exact_samples</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># check that the randomized and exact tests agree to reasonable</span>
        <span class="s5"># precision for permutation_type='samples'</span>

        <span class="s1">alternative</span><span class="s2">, </span><span class="s1">rng </span><span class="s2">= </span><span class="s3">'greater'</span><span class="s2">, </span><span class="s0">None</span>

        <span class="s1">nx</span><span class="s2">, </span><span class="s1">ny</span><span class="s2">, </span><span class="s1">permutations </span><span class="s2">= </span><span class="s4">15</span><span class="s2">, </span><span class="s4">15</span><span class="s2">, </span><span class="s4">32000</span>
        <span class="s0">assert </span><span class="s4">2</span><span class="s2">**</span><span class="s1">nx </span><span class="s2">&gt; </span><span class="s1">permutations</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">nx</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">ny</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'samples'</span><span class="s2">,</span>
                <span class="s3">'batch'</span><span class="s2">: </span><span class="s4">100</span><span class="s2">, </span><span class="s3">'alternative'</span><span class="s2">: </span><span class="s1">alternative</span><span class="s2">, </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">rng</span><span class="s2">}</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">permutations</span><span class="s2">,</span>
                               <span class="s2">**</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic </span><span class="s2">== </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_randomized_test_against_exact_pairings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># check that the randomized and exact tests agree to reasonable</span>
        <span class="s5"># precision for permutation_type='pairings'</span>

        <span class="s1">alternative</span><span class="s2">, </span><span class="s1">rng </span><span class="s2">= </span><span class="s3">'two-sided'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span>

        <span class="s1">nx</span><span class="s2">, </span><span class="s1">ny</span><span class="s2">, </span><span class="s1">permutations </span><span class="s2">= </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">40000</span>
        <span class="s0">assert </span><span class="s1">special</span><span class="s2">.</span><span class="s1">factorial</span><span class="s2">(</span><span class="s1">nx</span><span class="s2">) &gt; </span><span class="s1">permutations</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">nx</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">ny</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">]</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">pearsonr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]</span>

        <span class="s1">statistic </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">statistic1d</span><span class="s2">)</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">True</span><span class="s2">, </span><span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'samples'</span><span class="s2">,</span>
                <span class="s3">'batch'</span><span class="s2">: </span><span class="s4">100</span><span class="s2">, </span><span class="s3">'alternative'</span><span class="s2">: </span><span class="s1">alternative</span><span class="s2">, </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">rng</span><span class="s2">}</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">permutations</span><span class="s2">,</span>
                               <span class="s2">**</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic </span><span class="s2">== </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">'less'</span><span class="s2">, </span><span class="s3">'greater'</span><span class="s2">))</span>
    <span class="s5"># Different conventions for two-sided p-value here VS ttest_ind.</span>
    <span class="s5"># Eventually, we can add multiple options for the two-sided alternative</span>
    <span class="s5"># here in permutation_test.</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'permutations'</span><span class="s2">, (</span><span class="s4">30</span><span class="s2">, </span><span class="s4">1e9</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'axis'</span><span class="s2">, (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_permutation_ttest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">permutations</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s5"># check that this function and ttest_ind with permutations give</span>
        <span class="s5"># essentially identical results.</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">*</span><span class="s4">4</span><span class="s2">*</span><span class="s4">5</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">moveaxis</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">rng1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">4337234444626115331</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">permutations</span><span class="s2">=</span><span class="s1">permutations</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">,</span>
                               <span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng1</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ttest_ind</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">rng2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">4337234444626115331</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                                <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">permutations</span><span class="s2">,</span>
                                <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">,</span>
                                <span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng2</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s5"># -- Independent (Unpaired) Sample Tests -- #</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">, </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_ks_2samp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ks_2samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'exact'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ks_2samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s3">'asymp'</span><span class="s2">,</span>
                                  <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s5"># ks_2samp is always a one-tailed 'greater' test</span>
        <span class="s5"># it's the statistic that changes (D+ vs D- vs max(D+, D-))</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">, </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_ansari</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s5"># ansari has a different convention for 'alternative'</span>
        <span class="s1">alternative_correspondence </span><span class="s2">= {</span><span class="s3">&quot;less&quot;</span><span class="s2">: </span><span class="s3">&quot;greater&quot;</span><span class="s2">,</span>
                                      <span class="s3">&quot;greater&quot;</span><span class="s2">: </span><span class="s3">&quot;less&quot;</span><span class="s2">,</span>
                                      <span class="s3">&quot;two-sided&quot;</span><span class="s2">: </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">}</span>
        <span class="s1">alternative_scipy </span><span class="s2">= </span><span class="s1">alternative_correspondence</span><span class="s2">[</span><span class="s1">alternative</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ansari</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative_scipy</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ansari</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">, </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_mannwhitneyu</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">0.05</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">mannwhitneyu</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">mannwhitneyu</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">,</span>
                               <span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_against_cvm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">cramervonmises_2samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'exact'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">cramervonmises_2samp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
                                              <span class="s1">method</span><span class="s2">=</span><span class="s3">'asymptotic'</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s5"># cramervonmises_2samp has only one alternative, greater</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                               <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'greater'</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xslow</span><span class="s2">()</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'axis'</span><span class="s2">, (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_vectorized_nsamp_ptype_both</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s5"># Test that permutation_test with permutation_type='independent' works</span>
        <span class="s5"># properly for a 3-sample statistic with nd array samples of different</span>
        <span class="s5"># (but compatible) shapes and ndims. Show that exact permutation test</span>
        <span class="s5"># and random permutation tests approximate SciPy's asymptotic pvalues</span>
        <span class="s5"># and that exact and random permutation test results are even closer</span>
        <span class="s5"># to one another (than they are to the asymptotic results).</span>

        <span class="s5"># Three samples, different (but compatible) shapes with different ndims</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">6709265303529651545</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

        <span class="s5"># Define the statistic (and pvalue for comparison)</span>
        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">kruskal</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s0">def </span><span class="s1">pvalue1d</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">kruskal</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">).</span><span class="s1">pvalue</span>

        <span class="s1">statistic </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">statistic1d</span><span class="s2">)</span>
        <span class="s1">pvalue </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">pvalue1d</span><span class="s2">)</span>

        <span class="s5"># Calculate the expected results</span>
        <span class="s1">x2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))  </span><span class="s5"># broadcast manually because</span>
        <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))  </span><span class="s5"># _vectorize_statistic doesn't</span>
        <span class="s1">z2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_to</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
        <span class="s1">expected_statistic </span><span class="s2">= </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">z2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">expected_pvalue </span><span class="s2">= </span><span class="s1">pvalue</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">, </span><span class="s1">z2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s5"># Calculate exact and randomized permutation results</span>
        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">, </span><span class="s3">'axis'</span><span class="s2">: </span><span class="s1">axis</span><span class="s2">, </span><span class="s3">'alternative'</span><span class="s2">: </span><span class="s3">'greater'</span><span class="s2">,</span>
                <span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'independent'</span><span class="s2">, </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">}</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>

        <span class="s5"># Check results</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected_statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">6e-2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">3e-2</span><span class="s2">)</span>

    <span class="s5"># -- Paired-Sample Tests -- #</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">, </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_wilcoxon</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">0.05</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s5"># We'll check both 1- and 2-sample versions of the same test;</span>
        <span class="s5"># we expect identical results to wilcoxon in all cases.</span>
        <span class="s0">def </span><span class="s1">statistic_1samp_1d</span><span class="s2">(</span><span class="s1">z</span><span class="s2">):</span>
            <span class="s5"># 'less' ensures we get the same of two statistics every time</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">wilcoxon</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s0">def </span><span class="s1">statistic_2samp_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">wilcoxon</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s0">def </span><span class="s1">test_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">wilcoxon</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">test </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">test_1d</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">test</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected_stat </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">expected_p </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">, </span><span class="s3">'axis'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'alternative'</span><span class="s2">: </span><span class="s1">alternative</span><span class="s2">,</span>
                <span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'samples'</span><span class="s2">, </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">,</span>
                <span class="s3">'n_resamples'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">}</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">-</span><span class="s1">y</span><span class="s2">,), </span><span class="s1">statistic_1samp_1d</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic_2samp_1d</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>

        <span class="s5"># `wilcoxon` returns a different statistic with 'two-sided'</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">alternative </span><span class="s2">!= </span><span class="s3">'two-sided'</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected_stat</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_p</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">&quot;less&quot;</span><span class="s2">, </span><span class="s3">&quot;greater&quot;</span><span class="s2">, </span><span class="s3">&quot;two-sided&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_binomtest</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s1">x </span><span class="s2">== </span><span class="s4">0</span><span class="s2">] = -</span><span class="s4">1</span>
        <span class="s5"># More naturally, the test would flip elements between 0 and one.</span>
        <span class="s5"># However, permutation_test will flip the _signs_ of the elements.</span>
        <span class="s5"># So we have to work with +1/-1 instead of 1/0.</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s4">10</span><span class="s2">, </span><span class="s4">0.5</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">binomtest</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                                     <span class="s1">permutation_type</span><span class="s2">=</span><span class="s3">'samples'</span><span class="s2">,</span>
                                     <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">,</span>
                                     <span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s5"># -- Exact Association Tests -- #</span>

    <span class="s0">def </span><span class="s1">test_against_kendalltau</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">kendalltau</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'exact'</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">kendalltau</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s3">'asymptotic'</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s5"># kendalltau currently has only one alternative, two-sided</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">permutation_type</span><span class="s2">=</span><span class="s3">'pairings'</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative'</span><span class="s2">, (</span><span class="s3">'less'</span><span class="s2">, </span><span class="s3">'greater'</span><span class="s2">, </span><span class="s3">'two-sided'</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_against_fisher_exact</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">):</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">((</span><span class="s1">x </span><span class="s2">== </span><span class="s4">1</span><span class="s2">) &amp; (</span><span class="s1">y </span><span class="s2">== </span><span class="s4">1</span><span class="s2">))</span>

        <span class="s5"># x and y are binary random variables with some dependence</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">6235696159000529929</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">7</span><span class="s2">) &gt; </span><span class="s4">0.6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">7</span><span class="s2">) + </span><span class="s4">0.25</span><span class="s2">*</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s4">0.6</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">tab </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">contingency</span><span class="s2">.</span><span class="s1">crosstab</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">permutation_type</span><span class="s2">=</span><span class="s3">'pairings'</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">,</span>
                               <span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">fisher_exact</span><span class="s2">(</span><span class="s1">tab</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xslow</span><span class="s2">()</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'axis'</span><span class="s2">, (-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_vectorized_nsamp_ptype_samples</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s5"># Test that permutation_test with permutation_type='samples' works</span>
        <span class="s5"># properly for a 3-sample statistic with nd array samples of different</span>
        <span class="s5"># (but compatible) shapes and ndims. Show that exact permutation test</span>
        <span class="s5"># reproduces SciPy's exact pvalue and that random permutation test</span>
        <span class="s5"># approximates it.</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">rankdata</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">rankdata</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">rankdata</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]  </span><span class="s5"># to check broadcast with different ndim</span>
        <span class="s1">data </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">page_trend_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">ranked</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                                         <span class="s1">method</span><span class="s2">=</span><span class="s3">'asymptotic'</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s0">def </span><span class="s1">pvalue1d</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">page_trend_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">ranked</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                                         <span class="s1">method</span><span class="s2">=</span><span class="s3">'exact'</span><span class="s2">).</span><span class="s1">pvalue</span>

        <span class="s1">statistic </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">statistic1d</span><span class="s2">)</span>
        <span class="s1">pvalue </span><span class="s2">= </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_vectorize_statistic</span><span class="s2">(</span><span class="s1">pvalue1d</span><span class="s2">)</span>

        <span class="s1">expected_statistic </span><span class="s2">= </span><span class="s1">statistic</span><span class="s2">(*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_arrays</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">expected_pvalue </span><span class="s2">= </span><span class="s1">pvalue</span><span class="s2">(*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_arrays</span><span class="s2">(*</span><span class="s1">data</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>

        <span class="s5"># Let's forgive this use of an integer seed, please.</span>
        <span class="s1">kwds </span><span class="s2">= {</span><span class="s3">'vectorized'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">, </span><span class="s3">'axis'</span><span class="s2">: </span><span class="s1">axis</span><span class="s2">, </span><span class="s3">'alternative'</span><span class="s2">: </span><span class="s3">'greater'</span><span class="s2">,</span>
                <span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'pairings'</span><span class="s2">, </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s4">0</span><span class="s2">}</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s4">5000</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected_statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_pvalue</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">3e-2</span><span class="s2">)</span>

    <span class="s5"># -- Test Against External References -- #</span>

    <span class="s1">tie_case_1 </span><span class="s2">= {</span><span class="s3">'x'</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s3">'y'</span><span class="s2">: [</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">],</span>
                  <span class="s3">'expected_less'</span><span class="s2">: </span><span class="s4">0.2000000000</span><span class="s2">,</span>
                  <span class="s3">'expected_2sided'</span><span class="s2">: </span><span class="s4">0.4</span><span class="s2">,  </span><span class="s5"># 2*expected_less</span>
                  <span class="s3">'expected_Pr_gte_S_mean'</span><span class="s2">: </span><span class="s4">0.3428571429</span><span class="s2">,  </span><span class="s5"># see note below</span>
                  <span class="s3">'expected_statistic'</span><span class="s2">: </span><span class="s4">7.5</span><span class="s2">,</span>
                  <span class="s3">'expected_avg'</span><span class="s2">: </span><span class="s4">9.142857</span><span class="s2">, </span><span class="s3">'expected_std'</span><span class="s2">: </span><span class="s4">1.40698</span><span class="s2">}</span>
    <span class="s1">tie_case_2 </span><span class="s2">= {</span><span class="s3">'x'</span><span class="s2">: [</span><span class="s4">111</span><span class="s2">, </span><span class="s4">107</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">99</span><span class="s2">, </span><span class="s4">102</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, </span><span class="s4">109</span><span class="s2">, </span><span class="s4">108</span><span class="s2">],</span>
                  <span class="s3">'y'</span><span class="s2">: [</span><span class="s4">107</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, </span><span class="s4">106</span><span class="s2">, </span><span class="s4">98</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, </span><span class="s4">103</span><span class="s2">, </span><span class="s4">110</span><span class="s2">, </span><span class="s4">105</span><span class="s2">, </span><span class="s4">104</span><span class="s2">],</span>
                  <span class="s3">'expected_less'</span><span class="s2">: </span><span class="s4">0.1555738379</span><span class="s2">,</span>
                  <span class="s3">'expected_2sided'</span><span class="s2">: </span><span class="s4">0.3111476758</span><span class="s2">,</span>
                  <span class="s3">'expected_Pr_gte_S_mean'</span><span class="s2">: </span><span class="s4">0.2969971205</span><span class="s2">,  </span><span class="s5"># see note below</span>
                  <span class="s3">'expected_statistic'</span><span class="s2">: </span><span class="s4">32.5</span><span class="s2">,</span>
                  <span class="s3">'expected_avg'</span><span class="s2">: </span><span class="s4">38.117647</span><span class="s2">, </span><span class="s3">'expected_std'</span><span class="s2">: </span><span class="s4">5.172124</span><span class="s2">}</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xslow</span><span class="s2">()  </span><span class="s5"># only the second case is slow, really</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'case'</span><span class="s2">, (</span><span class="s1">tie_case_1</span><span class="s2">, </span><span class="s1">tie_case_2</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_with_ties</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">case</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Results above from SAS PROC NPAR1WAY, e.g. 
 
        DATA myData; 
        INPUT X Y; 
        CARDS; 
        1 1 
        1 2 
        1 3 
        1 4 
        2 1.5 
        2 2 
        2 2.5 
        ods graphics on; 
        proc npar1way AB data=myData; 
            class X; 
            EXACT; 
        run; 
        ods graphics off; 
 
        Note: SAS provides Pr &gt;= |S-Mean|, which is different from our 
        definition of a two-sided p-value. 
 
        &quot;&quot;&quot;</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'x'</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'y'</span><span class="s2">]</span>

        <span class="s1">expected_statistic </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'expected_statistic'</span><span class="s2">]</span>
        <span class="s1">expected_less </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'expected_less'</span><span class="s2">]</span>
        <span class="s1">expected_2sided </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'expected_2sided'</span><span class="s2">]</span>
        <span class="s1">expected_Pr_gte_S_mean </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'expected_Pr_gte_S_mean'</span><span class="s2">]</span>
        <span class="s1">expected_avg </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'expected_avg'</span><span class="s2">]</span>
        <span class="s1">expected_std </span><span class="s2">= </span><span class="s1">case</span><span class="s2">[</span><span class="s3">'expected_std'</span><span class="s2">]</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">ansari</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s3">&quot;Ties preclude use of exact statistic&quot;</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                                   <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'less'</span><span class="s2">)</span>
            <span class="s1">res2 </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">,</span>
                                    <span class="s1">alternative</span><span class="s2">=</span><span class="s3">'two-sided'</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected_statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_less</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_2sided</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">expected_avg</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(), </span><span class="s1">expected_std</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">)</span>

        <span class="s5"># SAS provides Pr &gt;= |S-Mean|; might as well check against that, too</span>
        <span class="s1">S </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span>
        <span class="s1">mean </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">)</span>
        <span class="s1">Pr_gte_S_mean </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution</span><span class="s2">-</span><span class="s1">mean</span><span class="s2">)</span>
                               <span class="s2">&gt;= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">S</span><span class="s2">-</span><span class="s1">mean</span><span class="s2">))/</span><span class="s1">n</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected_Pr_gte_S_mean</span><span class="s2">, </span><span class="s1">Pr_gte_S_mean</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'alternative, expected_pvalue'</span><span class="s2">,</span>
                             <span class="s2">((</span><span class="s3">'less'</span><span class="s2">, </span><span class="s4">0.9708333333333</span><span class="s2">),</span>
                              <span class="s2">(</span><span class="s3">'greater'</span><span class="s2">, </span><span class="s4">0.05138888888889</span><span class="s2">),</span>
                              <span class="s2">(</span><span class="s3">'two-sided'</span><span class="s2">, </span><span class="s4">0.1027777777778</span><span class="s2">)))</span>
    <span class="s0">def </span><span class="s1">test_against_spearmanr_in_R</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">, </span><span class="s1">expected_pvalue</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Results above from R cor.test, e.g. 
 
        options(digits=16) 
        x &lt;- c(1.76405235, 0.40015721, 0.97873798, 
               2.2408932, 1.86755799, -0.97727788) 
        y &lt;- c(2.71414076, 0.2488, 0.87551913, 
               2.6514917, 2.01160156, 0.47699563) 
        cor.test(x, y, method = &quot;spearm&quot;, alternative = &quot;t&quot;) 
        &quot;&quot;&quot;</span>
        <span class="s5"># data comes from</span>
        <span class="s5"># np.random.seed(0)</span>
        <span class="s5"># x = stats.norm.rvs(size=6)</span>
        <span class="s5"># y = x + stats.norm.rvs(size=6)</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1.76405235</span><span class="s2">, </span><span class="s4">0.40015721</span><span class="s2">, </span><span class="s4">0.97873798</span><span class="s2">,</span>
             <span class="s4">2.2408932</span><span class="s2">, </span><span class="s4">1.86755799</span><span class="s2">, -</span><span class="s4">0.97727788</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s4">2.71414076</span><span class="s2">, </span><span class="s4">0.2488</span><span class="s2">, </span><span class="s4">0.87551913</span><span class="s2">,</span>
             <span class="s4">2.6514917</span><span class="s2">, </span><span class="s4">2.01160156</span><span class="s2">, </span><span class="s4">0.47699563</span><span class="s2">]</span>
        <span class="s1">expected_statistic </span><span class="s2">= </span><span class="s4">0.7714285714285715</span>

        <span class="s0">def </span><span class="s1">statistic1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">spearmanr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">).</span><span class="s1">statistic</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">,), </span><span class="s1">statistic1d</span><span class="s2">, </span><span class="s1">permutation_type</span><span class="s2">=</span><span class="s3">'pairings'</span><span class="s2">,</span>
                               <span class="s1">n_resamples</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">alternative</span><span class="s2">=</span><span class="s1">alternative</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">expected_statistic</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">rtol</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">expected_pvalue</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-13</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;batch&quot;</span><span class="s2">, (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_batch_generator_iv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;`batch` must be positive.&quot;</span><span class="s2">):</span>
            <span class="s1">list</span><span class="s2">(</span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_batch_generator</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">batch</span><span class="s2">))</span>

    <span class="s1">batch_generator_cases </span><span class="s2">= [(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, []),</span>
                             <span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">6</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]),</span>
                             <span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">8</span><span class="s2">), </span><span class="s4">3</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;iterable, batch, expected&quot;</span><span class="s2">,</span>
                             <span class="s1">batch_generator_cases</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_batch_generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">iterable</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_batch_generator</span><span class="s2">(</span><span class="s1">iterable</span><span class="s2">, </span><span class="s1">batch</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">got </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s0">def </span><span class="s1">test_finite_precision_statistic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Some statistics return numerically distinct values when the values</span>
        <span class="s5"># should be equal in theory. Test that `permutation_test` accounts</span>
        <span class="s5"># for this in some way.</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]</span>

        <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">pearsonr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">permutation_test</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                                     <span class="s1">permutation_type</span><span class="s2">=</span><span class="s3">'pairings'</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">null </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">pvalue</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">null_distribution</span>

        <span class="s1">correct_p </span><span class="s2">= </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">null </span><span class="s2">&gt;= </span><span class="s1">r </span><span class="s2">- </span><span class="s4">1e-14</span><span class="s2">) / </span><span class="s1">len</span><span class="s2">(</span><span class="s1">null</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">pvalue </span><span class="s2">== </span><span class="s1">correct_p </span><span class="s2">== </span><span class="s4">1</span><span class="s2">/</span><span class="s4">3</span>
        <span class="s5"># Compare against other exact correlation tests using R corr.test</span>
        <span class="s5"># options(digits=16)</span>
        <span class="s5"># x = c(1, 2, 4, 3)</span>
        <span class="s5"># y = c(2, 4, 6, 8)</span>
        <span class="s5"># cor.test(x, y, alternative = &quot;t&quot;, method = &quot;spearman&quot;)  # 0.333333333</span>
        <span class="s5"># cor.test(x, y, alternative = &quot;t&quot;, method = &quot;kendall&quot;)  # 0.333333333</span>


<span class="s0">def </span><span class="s1">test_all_partitions_concatenated</span><span class="s2">():</span>
    <span class="s5"># make sure that _all_paritions_concatenated produces the correct number</span>
    <span class="s5"># of partitions of the data into samples of the given sizes and that</span>
    <span class="s5"># all are unique</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">nc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

    <span class="s1">all_partitions </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>
    <span class="s1">counter </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">partition_concatenated </span><span class="s0">in </span><span class="s1">_resampling</span><span class="s2">.</span><span class="s1">_all_partitions_concatenated</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">counter </span><span class="s2">+= </span><span class="s4">1</span>
        <span class="s1">partitioning </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">partition_concatenated</span><span class="s2">, </span><span class="s1">nc</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">all_partitions</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">([</span><span class="s1">frozenset</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">partitioning</span><span class="s2">]))</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">([</span><span class="s1">special</span><span class="s2">.</span><span class="s1">binom</span><span class="s2">(</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:]), </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">n</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:]))</span>
                        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">)])</span>

    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">counter</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">all_partitions</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'fun_name'</span><span class="s2">,</span>
                         <span class="s2">[</span><span class="s3">'bootstrap'</span><span class="s2">, </span><span class="s3">'permutation_test'</span><span class="s2">, </span><span class="s3">'monte_carlo_test'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_parameter_vectorized</span><span class="s2">(</span><span class="s1">fun_name</span><span class="s2">):</span>
    <span class="s5"># Check that parameter `vectorized` is working as desired for all</span>
    <span class="s5"># resampling functions. Results don't matter; just don't fail asserts.</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">75245098234592</span><span class="s2">)</span>
    <span class="s1">sample </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">):  </span><span class="s5"># needed by `monte_carlo_test`</span>
        <span class="s0">return </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">size</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

    <span class="s1">fun_options </span><span class="s2">= {</span><span class="s3">'bootstrap'</span><span class="s2">: {</span><span class="s3">'data'</span><span class="s2">: (</span><span class="s1">sample</span><span class="s2">,), </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">rng</span><span class="s2">,</span>
                                 <span class="s3">'method'</span><span class="s2">: </span><span class="s3">'percentile'</span><span class="s2">},</span>
                   <span class="s3">'permutation_test'</span><span class="s2">: {</span><span class="s3">'data'</span><span class="s2">: (</span><span class="s1">sample</span><span class="s2">,), </span><span class="s3">'random_state'</span><span class="s2">: </span><span class="s1">rng</span><span class="s2">,</span>
                                        <span class="s3">'permutation_type'</span><span class="s2">: </span><span class="s3">'samples'</span><span class="s2">},</span>
                   <span class="s3">'monte_carlo_test'</span><span class="s2">: {</span><span class="s3">'sample'</span><span class="s2">: </span><span class="s1">sample</span><span class="s2">, </span><span class="s3">'rvs'</span><span class="s2">: </span><span class="s1">rvs</span><span class="s2">}}</span>
    <span class="s1">common_options </span><span class="s2">= {</span><span class="s3">'n_resamples'</span><span class="s2">: </span><span class="s4">100</span><span class="s2">}</span>

    <span class="s1">fun </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">, </span><span class="s1">fun_name</span><span class="s2">)</span>
    <span class="s1">options </span><span class="s2">= </span><span class="s1">fun_options</span><span class="s2">[</span><span class="s1">fun_name</span><span class="s2">]</span>
    <span class="s1">options</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">common_options</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">&gt; </span><span class="s4">1 </span><span class="s0">or </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">fun</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">=</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
    <span class="s1">fun</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">=</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">statistic</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">fun</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">=</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
    <span class="s1">fun</span><span class="s2">(</span><span class="s1">statistic</span><span class="s2">=</span><span class="s1">statistic</span><span class="s2">, </span><span class="s1">vectorized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">options</span><span class="s2">)</span>
</pre>
</body>
</html>