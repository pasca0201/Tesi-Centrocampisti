<html>
<head>
<title>auxfuncs.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
auxfuncs.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Auxiliary functions for f2py2e. 
 
Copyright 1999 -- 2011 Pearu Peterson all rights reserved. 
Copyright 2011 -- present NumPy Developers. 
Permission to use, modify, and distribute this software is given under the 
terms of the NumPy (BSD style) LICENSE. 
 
NO WARRANTY IS EXPRESSED OR IMPLIED.  USE AT YOUR OWN RISK. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">pprint</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">types</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">reduce</span>
<span class="s2">from </span><span class="s1">copy </span><span class="s2">import </span><span class="s1">deepcopy</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">__version__</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">cfuncs</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">cfuncs </span><span class="s2">import </span><span class="s1">errmess</span>

<span class="s1">__all__ </span><span class="s3">= [</span>
    <span class="s4">'applyrules'</span><span class="s3">, </span><span class="s4">'debugcapi'</span><span class="s3">, </span><span class="s4">'dictappend'</span><span class="s3">, </span><span class="s4">'errmess'</span><span class="s3">, </span><span class="s4">'gentitle'</span><span class="s3">,</span>
    <span class="s4">'getargs2'</span><span class="s3">, </span><span class="s4">'getcallprotoargument'</span><span class="s3">, </span><span class="s4">'getcallstatement'</span><span class="s3">,</span>
    <span class="s4">'getfortranname'</span><span class="s3">, </span><span class="s4">'getpymethoddef'</span><span class="s3">, </span><span class="s4">'getrestdoc'</span><span class="s3">, </span><span class="s4">'getusercode'</span><span class="s3">,</span>
    <span class="s4">'getusercode1'</span><span class="s3">, </span><span class="s4">'getdimension'</span><span class="s3">, </span><span class="s4">'hasbody'</span><span class="s3">, </span><span class="s4">'hascallstatement'</span><span class="s3">, </span><span class="s4">'hascommon'</span><span class="s3">,</span>
    <span class="s4">'hasexternals'</span><span class="s3">, </span><span class="s4">'hasinitvalue'</span><span class="s3">, </span><span class="s4">'hasnote'</span><span class="s3">, </span><span class="s4">'hasresultnote'</span><span class="s3">,</span>
    <span class="s4">'isallocatable'</span><span class="s3">, </span><span class="s4">'isarray'</span><span class="s3">, </span><span class="s4">'isarrayofstrings'</span><span class="s3">,</span>
    <span class="s4">'ischaracter'</span><span class="s3">, </span><span class="s4">'ischaracterarray'</span><span class="s3">, </span><span class="s4">'ischaracter_or_characterarray'</span><span class="s3">,</span>
    <span class="s4">'iscomplex'</span><span class="s3">,</span>
    <span class="s4">'iscomplexarray'</span><span class="s3">, </span><span class="s4">'iscomplexfunction'</span><span class="s3">, </span><span class="s4">'iscomplexfunction_warn'</span><span class="s3">,</span>
    <span class="s4">'isdouble'</span><span class="s3">, </span><span class="s4">'isdummyroutine'</span><span class="s3">, </span><span class="s4">'isexternal'</span><span class="s3">, </span><span class="s4">'isfunction'</span><span class="s3">,</span>
    <span class="s4">'isfunction_wrap'</span><span class="s3">, </span><span class="s4">'isint1'</span><span class="s3">, </span><span class="s4">'isint1array'</span><span class="s3">, </span><span class="s4">'isinteger'</span><span class="s3">, </span><span class="s4">'isintent_aux'</span><span class="s3">,</span>
    <span class="s4">'isintent_c'</span><span class="s3">, </span><span class="s4">'isintent_callback'</span><span class="s3">, </span><span class="s4">'isintent_copy'</span><span class="s3">, </span><span class="s4">'isintent_dict'</span><span class="s3">,</span>
    <span class="s4">'isintent_hide'</span><span class="s3">, </span><span class="s4">'isintent_in'</span><span class="s3">, </span><span class="s4">'isintent_inout'</span><span class="s3">, </span><span class="s4">'isintent_inplace'</span><span class="s3">,</span>
    <span class="s4">'isintent_nothide'</span><span class="s3">, </span><span class="s4">'isintent_out'</span><span class="s3">, </span><span class="s4">'isintent_overwrite'</span><span class="s3">, </span><span class="s4">'islogical'</span><span class="s3">,</span>
    <span class="s4">'islogicalfunction'</span><span class="s3">, </span><span class="s4">'islong_complex'</span><span class="s3">, </span><span class="s4">'islong_double'</span><span class="s3">,</span>
    <span class="s4">'islong_doublefunction'</span><span class="s3">, </span><span class="s4">'islong_long'</span><span class="s3">, </span><span class="s4">'islong_longfunction'</span><span class="s3">,</span>
    <span class="s4">'ismodule'</span><span class="s3">, </span><span class="s4">'ismoduleroutine'</span><span class="s3">, </span><span class="s4">'isoptional'</span><span class="s3">, </span><span class="s4">'isprivate'</span><span class="s3">, </span><span class="s4">'isvariable'</span><span class="s3">,</span>
    <span class="s4">'isrequired'</span><span class="s3">, </span><span class="s4">'isroutine'</span><span class="s3">, </span><span class="s4">'isscalar'</span><span class="s3">, </span><span class="s4">'issigned_long_longarray'</span><span class="s3">,</span>
    <span class="s4">'isstring'</span><span class="s3">, </span><span class="s4">'isstringarray'</span><span class="s3">, </span><span class="s4">'isstring_or_stringarray'</span><span class="s3">, </span><span class="s4">'isstringfunction'</span><span class="s3">,</span>
    <span class="s4">'issubroutine'</span><span class="s3">, </span><span class="s4">'get_f2py_modulename'</span><span class="s3">, </span><span class="s4">'issubroutine_wrap'</span><span class="s3">, </span><span class="s4">'isthreadsafe'</span><span class="s3">,</span>
    <span class="s4">'isunsigned'</span><span class="s3">, </span><span class="s4">'isunsigned_char'</span><span class="s3">, </span><span class="s4">'isunsigned_chararray'</span><span class="s3">,</span>
    <span class="s4">'isunsigned_long_long'</span><span class="s3">, </span><span class="s4">'isunsigned_long_longarray'</span><span class="s3">, </span><span class="s4">'isunsigned_short'</span><span class="s3">,</span>
    <span class="s4">'isunsigned_shortarray'</span><span class="s3">, </span><span class="s4">'l_and'</span><span class="s3">, </span><span class="s4">'l_not'</span><span class="s3">, </span><span class="s4">'l_or'</span><span class="s3">, </span><span class="s4">'outmess'</span><span class="s3">, </span><span class="s4">'replace'</span><span class="s3">,</span>
    <span class="s4">'show'</span><span class="s3">, </span><span class="s4">'stripcomma'</span><span class="s3">, </span><span class="s4">'throw_error'</span><span class="s3">, </span><span class="s4">'isattr_value'</span><span class="s3">, </span><span class="s4">'getuseblocks'</span><span class="s3">,</span>
    <span class="s4">'process_f2cmap_dict'</span>
<span class="s3">]</span>


<span class="s1">f2py_version </span><span class="s3">= </span><span class="s1">__version__</span><span class="s3">.</span><span class="s1">version</span>


<span class="s1">show </span><span class="s3">= </span><span class="s1">pprint</span><span class="s3">.</span><span class="s1">pprint</span>

<span class="s1">options </span><span class="s3">= {}</span>
<span class="s1">debugoptions </span><span class="s3">= []</span>
<span class="s1">wrapfuncs </span><span class="s3">= </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">outmess</span><span class="s3">(</span><span class="s1">t</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'verbose'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">):</span>
        <span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">debugcapi</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'capi' </span><span class="s2">in </span><span class="s1">debugoptions</span>


<span class="s2">def </span><span class="s1">_ischaracter</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'typespec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'typespec'</span><span class="s3">] == </span><span class="s4">'character' </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s2">not </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'typespec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'typespec'</span><span class="s3">] == </span><span class="s4">'character' </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s2">not </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">ischaracter_or_characterarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">_ischaracter</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s4">'charselector' </span><span class="s2">not in </span><span class="s1">var</span>


<span class="s2">def </span><span class="s1">ischaracter</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">ischaracter_or_characterarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">ischaracterarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">ischaracter_or_characterarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isstring_or_stringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">_ischaracter</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s4">'charselector' </span><span class="s2">in </span><span class="s1">var</span>


<span class="s2">def </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isstring_or_stringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isstringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isstring_or_stringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isarrayofstrings</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):  </span><span class="s6"># obsolete?</span>
    <span class="s6"># leaving out '*' for now so that `character*(*) a(m)` and `character</span>
    <span class="s6"># a(m,*)` are treated differently. Luckily `character**` is illegal.</span>
    <span class="s2">return </span><span class="s1">isstringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'dimension'</span><span class="s3">][-</span><span class="s5">1</span><span class="s3">] == </span><span class="s4">'(*)'</span>


<span class="s2">def </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'dimension' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and not </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return not </span><span class="s3">(</span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">or </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">or </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">iscomplex</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'complex'</span><span class="s3">, </span><span class="s4">'double complex'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">islogical</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'logical'</span>


<span class="s2">def </span><span class="s1">isinteger</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'integer'</span>


<span class="s2">def </span><span class="s1">isreal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'real'</span>


<span class="s2">def </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'kindselector'</span><span class="s3">][</span><span class="s4">'*'</span><span class="s3">]</span>
    <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'kindselector'</span><span class="s3">][</span><span class="s4">'kind'</span><span class="s3">]</span>
        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">isint1</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'integer' </span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'1' </span><span class="s2">and not </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">islong_long</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">not in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'8'</span>


<span class="s2">def </span><span class="s1">isunsigned_char</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) != </span><span class="s4">'integer'</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-1'</span>


<span class="s2">def </span><span class="s1">isunsigned_short</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) != </span><span class="s4">'integer'</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-2'</span>


<span class="s2">def </span><span class="s1">isunsigned</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) != </span><span class="s4">'integer'</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-4'</span>


<span class="s2">def </span><span class="s1">isunsigned_long_long</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) != </span><span class="s4">'integer'</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-8'</span>


<span class="s2">def </span><span class="s1">isdouble</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if not </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'real'</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'8'</span>


<span class="s2">def </span><span class="s1">islong_double</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if not </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'real'</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'16'</span>


<span class="s2">def </span><span class="s1">islong_complex</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">iscomplex</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'32'</span>


<span class="s2">def </span><span class="s1">iscomplexarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'complex'</span><span class="s3">, </span><span class="s4">'double complex'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isint1array</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) == </span><span class="s4">'integer' </span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'1'</span>


<span class="s2">def </span><span class="s1">isunsigned_chararray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-1'</span>


<span class="s2">def </span><span class="s1">isunsigned_shortarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-2'</span>


<span class="s2">def </span><span class="s1">isunsignedarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-4'</span>


<span class="s2">def </span><span class="s1">isunsigned_long_longarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'-8'</span>


<span class="s2">def </span><span class="s1">issigned_chararray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'1'</span>


<span class="s2">def </span><span class="s1">issigned_shortarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'2'</span>


<span class="s2">def </span><span class="s1">issigned_array</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'4'</span>


<span class="s2">def </span><span class="s1">issigned_long_longarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'typespec'</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'integer'</span><span class="s3">, </span><span class="s4">'logical'</span><span class="s3">]</span><span class="s1">\</span>
        <span class="s2">and </span><span class="s1">get_kind</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s4">'8'</span>


<span class="s2">def </span><span class="s1">isallocatable</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'attrspec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s4">'allocatable' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">ismutable</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return not </span><span class="s3">(</span><span class="s4">'dimension' </span><span class="s2">not in </span><span class="s1">var </span><span class="s2">or </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">ismoduleroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'modulename' </span><span class="s2">in </span><span class="s1">rout</span>


<span class="s2">def </span><span class="s1">ismodule</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'block' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s4">'module' </span><span class="s3">== </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'block'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'block' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s4">'function' </span><span class="s3">== </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'block'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isfunction_wrap</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isintent_c</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">wrapfuncs </span><span class="s2">and </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s2">not </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">issubroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'block' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s4">'subroutine' </span><span class="s3">== </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'block'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">issubroutine_wrap</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isintent_c</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">issubroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">and </span><span class="s1">hasassumedshape</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">isattr_value</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'value' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'attrspec'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">hasassumedshape</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">rout</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'hasassumedshape'</span><span class="s3">):</span>
        <span class="s2">return True</span>
    <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'args'</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, {}).</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'dimension'</span><span class="s3">, []):</span>
            <span class="s2">if </span><span class="s1">d </span><span class="s3">== </span><span class="s4">':'</span><span class="s3">:</span>
                <span class="s1">rout</span><span class="s3">[</span><span class="s4">'hasassumedshape'</span><span class="s3">] = </span><span class="s2">True</span>
                <span class="s2">return True</span>
    <span class="s2">return False</span>


<span class="s2">def </span><span class="s1">requiresf90wrapper</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">ismoduleroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">or </span><span class="s1">hasassumedshape</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">or </span><span class="s1">issubroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">islogicalfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'result'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">islogical</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">islong_longfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'result'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">islong_long</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">islong_doublefunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'result'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">islong_double</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">iscomplexfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'result'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">iscomplex</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">iscomplexfunction_warn</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">iscomplexfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s1">outmess</span><span class="s3">(</span><span class="s4">&quot;&quot;&quot;</span><span class="s2">\ 
    </span><span class="s4">************************************************************** 
        Warning: code with a function returning complex value 
        may not work correctly with your Fortran compiler. 
        When using GNU gcc/g77 compilers, codes should work 
        correctly for callbacks with: 
        f2py -c -DF2PY_CB_RETURNCOMPLEX 
    **************************************************************</span><span class="s2">\n</span><span class="s4">&quot;&quot;&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">isstringfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'result'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">hasexternals</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'externals' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'externals'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isthreadsafe</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'f2pyenhancements' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s1">\</span>
           <span class="s4">'threadsafe' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'f2pyenhancements'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">hasvariables</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'vars' </span><span class="s2">in </span><span class="s1">rout </span><span class="s2">and </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isoptional</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s4">'attrspec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s4">'optional' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">] </span><span class="s2">and</span>
            <span class="s4">'required' </span><span class="s2">not in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">]) </span><span class="s2">and </span><span class="s1">isintent_nothide</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isexternal</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'attrspec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s4">'external' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">getdimension</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s1">dimpattern </span><span class="s3">= </span><span class="s4">r&quot;\((.*?)\)&quot;</span>
    <span class="s2">if </span><span class="s4">'attrspec' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">any</span><span class="s3">(</span><span class="s4">'dimension' </span><span class="s2">in </span><span class="s1">s </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">]):</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">re</span><span class="s3">.</span><span class="s1">findall</span><span class="s3">(</span><span class="s1">dimpattern</span><span class="s3">, </span><span class="s1">v</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">]][</span><span class="s5">0</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isrequired</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return not </span><span class="s1">isoptional</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isintent_nothide</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isintent_in</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s4">'intent' </span><span class="s2">not in </span><span class="s1">var</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">if </span><span class="s4">'hide' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'inplace' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'in' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">if </span><span class="s4">'out' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'inout' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'outin' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">isintent_inout</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s4">'intent' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s3">(</span><span class="s4">'inout' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">] </span><span class="s2">or</span>
            <span class="s4">'outin' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">]) </span><span class="s2">and </span><span class="s4">'in' </span><span class="s2">not in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">] </span><span class="s2">and</span>
            <span class="s4">'hide' </span><span class="s2">not in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">] </span><span class="s2">and </span><span class="s4">'inplace' </span><span class="s2">not in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">isintent_out</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'out' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_hide</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s4">'intent' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s3">(</span><span class="s4">'hide' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">] </span><span class="s2">or</span>
            <span class="s3">(</span><span class="s4">'out' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">] </span><span class="s2">and </span><span class="s4">'in' </span><span class="s2">not in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'intent'</span><span class="s3">] </span><span class="s2">and</span>
                <span class="s3">(</span><span class="s2">not </span><span class="s1">l_or</span><span class="s3">(</span><span class="s1">isintent_inout</span><span class="s3">, </span><span class="s1">isintent_inplace</span><span class="s3">)(</span><span class="s1">var</span><span class="s3">)))))</span>


<span class="s2">def </span><span class="s1">isintent_nothide</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return not </span><span class="s1">isintent_hide</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isintent_c</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'c' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_cache</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'cache' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_copy</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'copy' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_overwrite</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'overwrite' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_callback</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'callback' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_inplace</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'inplace' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_aux</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'aux' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_aligned4</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'aligned4' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_aligned8</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'aligned8' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s2">def </span><span class="s1">isintent_aligned16</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'aligned16' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'intent'</span><span class="s3">, [])</span>


<span class="s1">isintent_dict </span><span class="s3">= {</span><span class="s1">isintent_in</span><span class="s3">: </span><span class="s4">'INTENT_IN'</span><span class="s3">, </span><span class="s1">isintent_inout</span><span class="s3">: </span><span class="s4">'INTENT_INOUT'</span><span class="s3">,</span>
                 <span class="s1">isintent_out</span><span class="s3">: </span><span class="s4">'INTENT_OUT'</span><span class="s3">, </span><span class="s1">isintent_hide</span><span class="s3">: </span><span class="s4">'INTENT_HIDE'</span><span class="s3">,</span>
                 <span class="s1">isintent_cache</span><span class="s3">: </span><span class="s4">'INTENT_CACHE'</span><span class="s3">,</span>
                 <span class="s1">isintent_c</span><span class="s3">: </span><span class="s4">'INTENT_C'</span><span class="s3">, </span><span class="s1">isoptional</span><span class="s3">: </span><span class="s4">'OPTIONAL'</span><span class="s3">,</span>
                 <span class="s1">isintent_inplace</span><span class="s3">: </span><span class="s4">'INTENT_INPLACE'</span><span class="s3">,</span>
                 <span class="s1">isintent_aligned4</span><span class="s3">: </span><span class="s4">'INTENT_ALIGNED4'</span><span class="s3">,</span>
                 <span class="s1">isintent_aligned8</span><span class="s3">: </span><span class="s4">'INTENT_ALIGNED8'</span><span class="s3">,</span>
                 <span class="s1">isintent_aligned16</span><span class="s3">: </span><span class="s4">'INTENT_ALIGNED16'</span><span class="s3">,</span>
                 <span class="s3">}</span>


<span class="s2">def </span><span class="s1">isprivate</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'attrspec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s4">'private' </span><span class="s2">in </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">isvariable</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s6"># heuristic to find public/private declarations of filtered subroutines</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">var</span><span class="s3">) == </span><span class="s5">1 </span><span class="s2">and </span><span class="s4">'attrspec' </span><span class="s2">in </span><span class="s1">var </span><span class="s2">and </span><span class="s1">\</span>
            <span class="s1">var</span><span class="s3">[</span><span class="s4">'attrspec'</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'public'</span><span class="s3">, </span><span class="s4">'private'</span><span class="s3">):</span>
        <span class="s1">is_var </span><span class="s3">= </span><span class="s2">False</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">is_var </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s2">return </span><span class="s1">is_var</span>

<span class="s2">def </span><span class="s1">hasinitvalue</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'=' </span><span class="s2">in </span><span class="s1">var</span>


<span class="s2">def </span><span class="s1">hasinitvalueasstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">hasinitvalue</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">return </span><span class="s1">var</span><span class="s3">[</span><span class="s4">'='</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'&quot;'</span><span class="s3">, </span><span class="s4">&quot;'&quot;</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'note' </span><span class="s2">in </span><span class="s1">var</span>


<span class="s2">def </span><span class="s1">hasresultnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">isfunction</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">if </span><span class="s4">'result' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'result'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">hasnote</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">hascommon</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'common' </span><span class="s2">in </span><span class="s1">rout</span>


<span class="s2">def </span><span class="s1">containscommon</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">hascommon</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">if </span><span class="s1">hasbody</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'body'</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">containscommon</span><span class="s3">(</span><span class="s1">b</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">containsmodule</span><span class="s3">(</span><span class="s1">block</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">ismodule</span><span class="s3">(</span><span class="s1">block</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">if not </span><span class="s1">hasbody</span><span class="s3">(</span><span class="s1">block</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">0</span>
    <span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">block</span><span class="s3">[</span><span class="s4">'body'</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">containsmodule</span><span class="s3">(</span><span class="s1">b</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s5">1</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">hasbody</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s4">'body' </span><span class="s2">in </span><span class="s1">rout</span>


<span class="s2">def </span><span class="s1">hascallstatement</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">getcallstatement</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">) </span><span class="s2">is not None</span>


<span class="s2">def </span><span class="s1">istrue</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">isfalse</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s5">0</span>


<span class="s2">class </span><span class="s1">F2PYError</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">throw_error</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mess</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mess </span><span class="s3">= </span><span class="s1">mess</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">var</span><span class="s3">):</span>
        <span class="s1">mess </span><span class="s3">= </span><span class="s4">'</span><span class="s2">\n\n  </span><span class="s4">var = %s</span><span class="s2">\n  </span><span class="s4">Message: %s</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% (</span><span class="s1">var</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mess</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">F2PYError</span><span class="s3">(</span><span class="s1">mess</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">l_and</span><span class="s3">(*</span><span class="s1">f</span><span class="s3">):</span>
    <span class="s1">l1</span><span class="s3">, </span><span class="s1">l2 </span><span class="s3">= </span><span class="s4">'lambda v'</span><span class="s3">, []</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)):</span>
        <span class="s1">l1 </span><span class="s3">= </span><span class="s4">'%s,f%d=f[%d]' </span><span class="s3">% (</span><span class="s1">l1</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>
        <span class="s1">l2</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'f%d(v)' </span><span class="s3">% (</span><span class="s1">i</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">eval</span><span class="s3">(</span><span class="s4">'%s:%s' </span><span class="s3">% (</span><span class="s1">l1</span><span class="s3">, </span><span class="s4">' and '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">l2</span><span class="s3">)))</span>


<span class="s2">def </span><span class="s1">l_or</span><span class="s3">(*</span><span class="s1">f</span><span class="s3">):</span>
    <span class="s1">l1</span><span class="s3">, </span><span class="s1">l2 </span><span class="s3">= </span><span class="s4">'lambda v'</span><span class="s3">, []</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)):</span>
        <span class="s1">l1 </span><span class="s3">= </span><span class="s4">'%s,f%d=f[%d]' </span><span class="s3">% (</span><span class="s1">l1</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">i</span><span class="s3">)</span>
        <span class="s1">l2</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'f%d(v)' </span><span class="s3">% (</span><span class="s1">i</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">eval</span><span class="s3">(</span><span class="s4">'%s:%s' </span><span class="s3">% (</span><span class="s1">l1</span><span class="s3">, </span><span class="s4">' or '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">l2</span><span class="s3">)))</span>


<span class="s2">def </span><span class="s1">l_not</span><span class="s3">(</span><span class="s1">f</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">eval</span><span class="s3">(</span><span class="s4">'lambda v,f=f:not f(v)'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">isdummyroutine</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'f2pyenhancements'</span><span class="s3">][</span><span class="s4">'fortranname'</span><span class="s3">] == </span><span class="s4">''</span>
    <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">0</span>


<span class="s2">def </span><span class="s1">getfortranname</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'f2pyenhancements'</span><span class="s3">][</span><span class="s4">'fortranname'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s3">== </span><span class="s4">''</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">KeyError</span>
        <span class="s2">if not </span><span class="s1">name</span><span class="s3">:</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s4">'Failed to use fortranname from %s</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">%</span>
                    <span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'f2pyenhancements'</span><span class="s3">]))</span>
            <span class="s2">raise </span><span class="s1">KeyError</span>
    <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">name</span>


<span class="s2">def </span><span class="s1">getmultilineblock</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s1">blockname</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">counter</span><span class="s3">=</span><span class="s5">0</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'f2pyenhancements'</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s1">blockname</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
        <span class="s2">return</span>
    <span class="s2">if not </span><span class="s1">r</span><span class="s3">:</span>
        <span class="s2">return</span>
    <span class="s2">if </span><span class="s1">counter </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s2">return</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">counter </span><span class="s3">&gt;= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">r</span><span class="s3">):</span>
            <span class="s2">return</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">r</span><span class="s3">[</span><span class="s1">counter</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">r</span><span class="s3">[:</span><span class="s5">3</span><span class="s3">] == </span><span class="s4">&quot;'''&quot;</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">comment</span><span class="s3">:</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s4">'</span><span class="s2">\t</span><span class="s4">/* start ' </span><span class="s3">+ </span><span class="s1">blockname </span><span class="s3">+ </span><span class="s1">\</span>
                <span class="s4">' multiline (' </span><span class="s3">+ </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">counter</span><span class="s3">) + </span><span class="s4">') */</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">+ </span><span class="s1">r</span><span class="s3">[</span><span class="s5">3</span><span class="s3">:]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">r</span><span class="s3">[</span><span class="s5">3</span><span class="s3">:]</span>
        <span class="s2">if </span><span class="s1">r</span><span class="s3">[-</span><span class="s5">3</span><span class="s3">:] == </span><span class="s4">&quot;'''&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">comment</span><span class="s3">:</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s1">r</span><span class="s3">[:-</span><span class="s5">3</span><span class="s3">] + </span><span class="s4">'</span><span class="s2">\n\t</span><span class="s4">/* end multiline (' </span><span class="s3">+ </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">counter</span><span class="s3">) + </span><span class="s4">')*/'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s1">r</span><span class="s3">[:-</span><span class="s5">3</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s4">&quot;%s multiline block should end with `'''`: %s</span><span class="s2">\n</span><span class="s4">&quot;</span>
                    <span class="s3">% (</span><span class="s1">blockname</span><span class="s3">, </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)))</span>
    <span class="s2">return </span><span class="s1">r</span>


<span class="s2">def </span><span class="s1">getcallstatement</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">getmultilineblock</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s4">'callstatement'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getcallprotoargument</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s1">cb_map</span><span class="s3">={}):</span>
    <span class="s1">r </span><span class="s3">= </span><span class="s1">getmultilineblock</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s4">'callprotoargument'</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">r</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">r</span>
    <span class="s2">if </span><span class="s1">hascallstatement</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s1">outmess</span><span class="s3">(</span>
            <span class="s4">'warning: callstatement is defined without callprotoargument</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">)</span>
        <span class="s2">return</span>
    <span class="s2">from </span><span class="s3">.</span><span class="s1">capi_maps </span><span class="s2">import </span><span class="s1">getctype</span>
    <span class="s1">arg_types</span><span class="s3">, </span><span class="s1">arg_types2 </span><span class="s3">= [], []</span>
    <span class="s2">if </span><span class="s1">l_and</span><span class="s3">(</span><span class="s1">isstringfunction</span><span class="s3">, </span><span class="s1">l_not</span><span class="s3">(</span><span class="s1">isfunction_wrap</span><span class="s3">))(</span><span class="s1">rout</span><span class="s3">):</span>
        <span class="s1">arg_types</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">([</span><span class="s4">'char*'</span><span class="s3">, </span><span class="s4">'size_t'</span><span class="s3">])</span>
    <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'args'</span><span class="s3">]:</span>
        <span class="s1">var </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">n</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">isintent_callback</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s1">n </span><span class="s2">in </span><span class="s1">cb_map</span><span class="s3">:</span>
            <span class="s1">ctype </span><span class="s3">= </span><span class="s1">cb_map</span><span class="s3">[</span><span class="s1">n</span><span class="s3">] + </span><span class="s4">'_typedef'</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">ctype </span><span class="s3">= </span><span class="s1">getctype</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">l_and</span><span class="s3">(</span><span class="s1">isintent_c</span><span class="s3">, </span><span class="s1">l_or</span><span class="s3">(</span><span class="s1">isscalar</span><span class="s3">, </span><span class="s1">iscomplex</span><span class="s3">))(</span><span class="s1">var</span><span class="s3">):</span>
                <span class="s2">pass</span>
            <span class="s2">elif </span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
                <span class="s2">pass</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">isattr_value</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
                    <span class="s1">ctype </span><span class="s3">= </span><span class="s1">ctype </span><span class="s3">+ </span><span class="s4">'*'</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">isstring</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)</span>
                 <span class="s2">or </span><span class="s1">isarrayofstrings</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)  </span><span class="s6"># obsolete?</span>
                 <span class="s2">or </span><span class="s1">isstringarray</span><span class="s3">(</span><span class="s1">var</span><span class="s3">)):</span>
                <span class="s1">arg_types2</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'size_t'</span><span class="s3">)</span>
        <span class="s1">arg_types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ctype</span><span class="s3">)</span>

    <span class="s1">proto_args </span><span class="s3">= </span><span class="s4">','</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">arg_types </span><span class="s3">+ </span><span class="s1">arg_types2</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">proto_args</span><span class="s3">:</span>
        <span class="s1">proto_args </span><span class="s3">= </span><span class="s4">'void'</span>
    <span class="s2">return </span><span class="s1">proto_args</span>


<span class="s2">def </span><span class="s1">getusercode</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">getmultilineblock</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s4">'usercode'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getusercode1</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">getmultilineblock</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s4">'usercode'</span><span class="s3">, </span><span class="s1">counter</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getpymethoddef</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">getmultilineblock</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">, </span><span class="s4">'pymethoddef'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getargs</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s1">sortargs</span><span class="s3">, </span><span class="s1">args </span><span class="s3">= [], []</span>
    <span class="s2">if </span><span class="s4">'args' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'args'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s4">'sortvars' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'sortvars'</span><span class="s3">]:</span>
                <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">args</span><span class="s3">:</span>
                    <span class="s1">sortargs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">args</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">a </span><span class="s2">not in </span><span class="s1">sortargs</span><span class="s3">:</span>
                    <span class="s1">sortargs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">sortargs </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'args'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">args</span><span class="s3">, </span><span class="s1">sortargs</span>


<span class="s2">def </span><span class="s1">getargs2</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s1">sortargs</span><span class="s3">, </span><span class="s1">args </span><span class="s3">= [], </span><span class="s1">rout</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'args'</span><span class="s3">, [])</span>
    <span class="s1">auxvars </span><span class="s3">= [</span><span class="s1">a </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">].</span><span class="s1">keys</span><span class="s3">() </span><span class="s2">if </span><span class="s1">isintent_aux</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'vars'</span><span class="s3">][</span><span class="s1">a</span><span class="s3">])</span>
               <span class="s2">and </span><span class="s1">a </span><span class="s2">not in </span><span class="s1">args</span><span class="s3">]</span>
    <span class="s1">args </span><span class="s3">= </span><span class="s1">auxvars </span><span class="s3">+ </span><span class="s1">args</span>
    <span class="s2">if </span><span class="s4">'sortvars' </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'sortvars'</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">a </span><span class="s2">in </span><span class="s1">args</span><span class="s3">:</span>
                <span class="s1">sortargs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">args</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">a </span><span class="s2">not in </span><span class="s1">sortargs</span><span class="s3">:</span>
                <span class="s1">sortargs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">sortargs </span><span class="s3">= </span><span class="s1">auxvars </span><span class="s3">+ </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'args'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">args</span><span class="s3">, </span><span class="s1">sortargs</span>


<span class="s2">def </span><span class="s1">getrestdoc</span><span class="s3">(</span><span class="s1">rout</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s4">'f2pymultilines' </span><span class="s2">not in </span><span class="s1">rout</span><span class="s3">:</span>
        <span class="s2">return None</span>
    <span class="s1">k </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'block'</span><span class="s3">] == </span><span class="s4">'python module'</span><span class="s3">:</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'block'</span><span class="s3">], </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'name'</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">rout</span><span class="s3">[</span><span class="s4">'f2pymultilines'</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">gentitle</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
    <span class="s1">ln </span><span class="s3">= (</span><span class="s5">80 </span><span class="s3">- </span><span class="s1">len</span><span class="s3">(</span><span class="s1">name</span><span class="s3">) - </span><span class="s5">6</span><span class="s3">) // </span><span class="s5">2</span>
    <span class="s2">return </span><span class="s4">'/*%s %s %s*/' </span><span class="s3">% (</span><span class="s1">ln </span><span class="s3">* </span><span class="s4">'*'</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">ln </span><span class="s3">* </span><span class="s4">'*'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">flatlist</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">reduce</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">f</span><span class="s3">=</span><span class="s1">flatlist</span><span class="s3">: </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">f</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s1">lst</span><span class="s3">, [])</span>
    <span class="s2">return </span><span class="s3">[</span><span class="s1">lst</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">stripcomma</span><span class="s3">(</span><span class="s1">s</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">s </span><span class="s2">and </span><span class="s1">s</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] == </span><span class="s4">','</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">s</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">s</span>


<span class="s2">def </span><span class="s1">replace</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">defaultsep</span><span class="s3">=</span><span class="s4">''</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">_m</span><span class="s3">, </span><span class="s1">defaultsep</span><span class="s3">) </span><span class="s2">for </span><span class="s1">_m </span><span class="s2">in </span><span class="s1">d</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">_m</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">defaultsep</span><span class="s3">) </span><span class="s2">for </span><span class="s1">_m </span><span class="s2">in </span><span class="s1">str</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s5">2 </span><span class="s3">* </span><span class="s1">list</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()):</span>
        <span class="s2">if </span><span class="s1">k </span><span class="s3">== </span><span class="s4">'separatorsfor'</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s4">'separatorsfor' </span><span class="s2">in </span><span class="s1">d </span><span class="s2">and </span><span class="s1">k </span><span class="s2">in </span><span class="s1">d</span><span class="s3">[</span><span class="s4">'separatorsfor'</span><span class="s3">]:</span>
            <span class="s1">sep </span><span class="s3">= </span><span class="s1">d</span><span class="s3">[</span><span class="s4">'separatorsfor'</span><span class="s3">][</span><span class="s1">k</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">sep </span><span class="s3">= </span><span class="s1">defaultsep</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">str </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'#%s#' </span><span class="s3">% (</span><span class="s1">k</span><span class="s3">), </span><span class="s1">sep</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">flatlist</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">str </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'#%s#' </span><span class="s3">% (</span><span class="s1">k</span><span class="s3">), </span><span class="s1">d</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">str</span>


<span class="s2">def </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">rd</span><span class="s3">, </span><span class="s1">ar</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ar</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">ar</span><span class="s3">:</span>
            <span class="s1">rd </span><span class="s3">= </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">rd</span><span class="s3">, </span><span class="s1">a</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">rd</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">ar</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">k</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'_'</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s1">k </span><span class="s2">in </span><span class="s1">rd</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = [</span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]]</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">list</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">list</span><span class="s3">):</span>
                    <span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] + </span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">dict</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">dict</span><span class="s3">):</span>
                    <span class="s2">if </span><span class="s1">k </span><span class="s3">== </span><span class="s4">'separatorsfor'</span><span class="s3">:</span>
                        <span class="s2">for </span><span class="s1">k1 </span><span class="s2">in </span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">keys</span><span class="s3">():</span>
                            <span class="s2">if </span><span class="s1">k1 </span><span class="s2">not in </span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]:</span>
                                <span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">] = </span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">]</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">rd</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">rd</span>


<span class="s2">def </span><span class="s1">applyrules</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">var</span><span class="s3">={}):</span>
    <span class="s1">ret </span><span class="s3">= {}</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">r </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">:</span>
            <span class="s1">rr </span><span class="s3">= </span><span class="s1">applyrules</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
            <span class="s1">ret </span><span class="s3">= </span><span class="s1">dictappend</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">, </span><span class="s1">rr</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s4">'_break' </span><span class="s2">in </span><span class="s1">rr</span><span class="s3">:</span>
                <span class="s2">break</span>
        <span class="s2">return </span><span class="s1">ret</span>
    <span class="s2">if </span><span class="s4">'_check' </span><span class="s2">in </span><span class="s1">rules </span><span class="s2">and </span><span class="s3">(</span><span class="s2">not </span><span class="s1">rules</span><span class="s3">[</span><span class="s4">'_check'</span><span class="s3">](</span><span class="s1">var</span><span class="s3">)):</span>
        <span class="s2">return </span><span class="s1">ret</span>
    <span class="s2">if </span><span class="s4">'need' </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">:</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">applyrules</span><span class="s3">({</span><span class="s4">'needs'</span><span class="s3">: </span><span class="s1">rules</span><span class="s3">[</span><span class="s4">'need'</span><span class="s3">]}, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s4">'needs' </span><span class="s2">in </span><span class="s1">res</span><span class="s3">:</span>
            <span class="s1">cfuncs</span><span class="s3">.</span><span class="s1">append_needs</span><span class="s3">(</span><span class="s1">res</span><span class="s3">[</span><span class="s4">'needs'</span><span class="s3">])</span>

    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">k </span><span class="s3">== </span><span class="s4">'separatorsfor'</span><span class="s3">:</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">replace</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">d</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = []</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]:</span>
                <span class="s1">ar </span><span class="s3">= </span><span class="s1">applyrules</span><span class="s3">({</span><span class="s1">k</span><span class="s3">: </span><span class="s1">i</span><span class="s3">}, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">k </span><span class="s2">in </span><span class="s1">ar</span><span class="s3">:</span>
                    <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ar</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
        <span class="s2">elif </span><span class="s1">k</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">'_'</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">dict</span><span class="s3">):</span>
            <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = []</span>
            <span class="s2">for </span><span class="s1">k1 </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">keys</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">k1</span><span class="s3">, </span><span class="s1">types</span><span class="s3">.</span><span class="s1">FunctionType</span><span class="s3">) </span><span class="s2">and </span><span class="s1">k1</span><span class="s3">(</span><span class="s1">var</span><span class="s3">):</span>
                    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">], </span><span class="s1">list</span><span class="s3">):</span>
                        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">]:</span>
                            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
                                <span class="s1">res </span><span class="s3">= </span><span class="s1">applyrules</span><span class="s3">({</span><span class="s4">'supertext'</span><span class="s3">: </span><span class="s1">i</span><span class="s3">}, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">var</span><span class="s3">)</span>
                                <span class="s2">if </span><span class="s4">'supertext' </span><span class="s2">in </span><span class="s1">res</span><span class="s3">:</span>
                                    <span class="s1">i </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s4">'supertext'</span><span class="s3">]</span>
                                <span class="s2">else</span><span class="s3">:</span>
                                    <span class="s1">i </span><span class="s3">= </span><span class="s4">''</span>
                            <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">d</span><span class="s3">))</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">i </span><span class="s3">= </span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">]</span>
                        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">):</span>
                            <span class="s1">res </span><span class="s3">= </span><span class="s1">applyrules</span><span class="s3">({</span><span class="s4">'supertext'</span><span class="s3">: </span><span class="s1">i</span><span class="s3">}, </span><span class="s1">d</span><span class="s3">)</span>
                            <span class="s2">if </span><span class="s4">'supertext' </span><span class="s2">in </span><span class="s1">res</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s4">'supertext'</span><span class="s3">]</span>
                            <span class="s2">else</span><span class="s3">:</span>
                                <span class="s1">i </span><span class="s3">= </span><span class="s4">''</span>
                        <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">d</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">errmess</span><span class="s3">(</span><span class="s4">'applyrules: ignoring rule %s.</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% </span><span class="s1">repr</span><span class="s3">(</span><span class="s1">rules</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]))</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]) == </span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s5">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] == []:</span>
                <span class="s2">del </span><span class="s1">ret</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">ret</span>

<span class="s1">_f2py_module_name_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'\s*python\s*module\s*(?P&lt;name&gt;[\w_]+)'</span><span class="s3">,</span>
                                     <span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>
<span class="s1">_f2py_user_module_name_match </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'\s*python\s*module\s*(?P&lt;name&gt;[\w_]*?'</span>
                                          <span class="s4">r'__user__[\w_]*)'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>

<span class="s2">def </span><span class="s1">get_f2py_modulename</span><span class="s3">(</span><span class="s1">source</span><span class="s3">):</span>
    <span class="s1">name </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">source</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">m </span><span class="s3">= </span><span class="s1">_f2py_module_name_match</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">m</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">_f2py_user_module_name_match</span><span class="s3">(</span><span class="s1">line</span><span class="s3">): </span><span class="s6"># skip *__user__* names</span>
                    <span class="s2">continue</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s4">'name'</span><span class="s3">)</span>
                <span class="s2">break</span>
    <span class="s2">return </span><span class="s1">name</span>

<span class="s2">def </span><span class="s1">getuseblocks</span><span class="s3">(</span><span class="s1">pymod</span><span class="s3">):</span>
    <span class="s1">all_uses </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">inner </span><span class="s2">in </span><span class="s1">pymod</span><span class="s3">[</span><span class="s4">'body'</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">modblock </span><span class="s2">in </span><span class="s1">inner</span><span class="s3">[</span><span class="s4">'body'</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">modblock</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'use'</span><span class="s3">):</span>
                <span class="s1">all_uses</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">([</span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">modblock</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;use&quot;</span><span class="s3">).</span><span class="s1">keys</span><span class="s3">() </span><span class="s2">if </span><span class="s4">&quot;__&quot; </span><span class="s2">not in </span><span class="s1">x</span><span class="s3">])</span>
    <span class="s2">return </span><span class="s1">all_uses</span>

<span class="s2">def </span><span class="s1">process_f2cmap_dict</span><span class="s3">(</span><span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">new_map</span><span class="s3">, </span><span class="s1">c2py_map</span><span class="s3">, </span><span class="s1">verbose </span><span class="s3">= </span><span class="s2">False</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Update the Fortran-to-C type mapping dictionary with new mappings and 
    return a list of successfully mapped C types. 
 
    This function integrates a new mapping dictionary into an existing 
    Fortran-to-C type mapping dictionary. It ensures that all keys are in 
    lowercase and validates new entries against a given C-to-Python mapping 
    dictionary. Redefinitions and invalid entries are reported with a warning. 
 
    Parameters 
    ---------- 
    f2cmap_all : dict 
        The existing Fortran-to-C type mapping dictionary that will be updated. 
        It should be a dictionary of dictionaries where the main keys represent 
        Fortran types and the nested dictionaries map Fortran type specifiers 
        to corresponding C types. 
 
    new_map : dict 
        A dictionary containing new type mappings to be added to `f2cmap_all`. 
        The structure should be similar to `f2cmap_all`, with keys representing 
        Fortran types and values being dictionaries of type specifiers and their 
        C type equivalents. 
 
    c2py_map : dict 
        A dictionary used for validating the C types in `new_map`. It maps C 
        types to corresponding Python types and is used to ensure that the C 
        types specified in `new_map` are valid. 
 
    verbose : boolean 
        A flag used to provide information about the types mapped 
 
    Returns 
    ------- 
    tuple of (dict, list) 
        The updated Fortran-to-C type mapping dictionary and a list of 
        successfully mapped C types. 
    &quot;&quot;&quot;</span>
    <span class="s1">f2cmap_mapped </span><span class="s3">= []</span>

    <span class="s1">new_map_lower </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">d1 </span><span class="s2">in </span><span class="s1">new_map</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">d1_lower </span><span class="s3">= {</span><span class="s1">k1</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(): </span><span class="s1">v1 </span><span class="s2">for </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">v1 </span><span class="s2">in </span><span class="s1">d1</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()}</span>
        <span class="s1">new_map_lower</span><span class="s3">[</span><span class="s1">k</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()] = </span><span class="s1">d1_lower</span>

    <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">d1 </span><span class="s2">in </span><span class="s1">new_map_lower</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">if </span><span class="s1">k </span><span class="s2">not in </span><span class="s1">f2cmap_all</span><span class="s3">:</span>
            <span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = {}</span>

        <span class="s2">for </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">v1 </span><span class="s2">in </span><span class="s1">d1</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">v1 </span><span class="s2">in </span><span class="s1">c2py_map</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">k1 </span><span class="s2">in </span><span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">k</span><span class="s3">]:</span>
                    <span class="s1">outmess</span><span class="s3">(</span>
                        <span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">Warning: redefinition of {'%s':{'%s':'%s'-&gt;'%s'}}</span><span class="s2">\n</span><span class="s4">&quot;</span>
                        <span class="s3">% (</span><span class="s1">k</span><span class="s3">, </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">], </span><span class="s1">v1</span><span class="s3">)</span>
                    <span class="s3">)</span>
                <span class="s1">f2cmap_all</span><span class="s3">[</span><span class="s1">k</span><span class="s3">][</span><span class="s1">k1</span><span class="s3">] = </span><span class="s1">v1</span>
                <span class="s2">if </span><span class="s1">verbose</span><span class="s3">:</span>
                    <span class="s1">outmess</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\t</span><span class="s4">Mapping &quot;%s(kind=%s)&quot; to &quot;%s&quot;</span><span class="s2">\n</span><span class="s4">' </span><span class="s3">% (</span><span class="s1">k</span><span class="s3">, </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">v1</span><span class="s3">))</span>
                <span class="s1">f2cmap_mapped</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">v1</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">verbose</span><span class="s3">:</span>
                    <span class="s1">errmess</span><span class="s3">(</span>
                        <span class="s4">&quot;</span><span class="s2">\t</span><span class="s4">Ignoring map {'%s':{'%s':'%s'}}: '%s' must be in %s</span><span class="s2">\n</span><span class="s4">&quot;</span>
                        <span class="s3">% (</span><span class="s1">k</span><span class="s3">, </span><span class="s1">k1</span><span class="s3">, </span><span class="s1">v1</span><span class="s3">, </span><span class="s1">v1</span><span class="s3">, </span><span class="s1">list</span><span class="s3">(</span><span class="s1">c2py_map</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()))</span>
                    <span class="s3">)</span>

    <span class="s2">return </span><span class="s1">f2cmap_all</span><span class="s3">, </span><span class="s1">f2cmap_mapped</span>
</pre>
</body>
</html>