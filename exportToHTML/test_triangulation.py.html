<html>
<head>
<title>test_triangulation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_triangulation.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_less</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">testutils </span><span class="s0">as </span><span class="s1">matest</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">tri </span><span class="s0">as </span><span class="s1">mtri</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">path </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">image_comparison</span><span class="s2">, </span><span class="s1">check_figures_equal</span>


<span class="s0">class </span><span class="s1">TestTriangulationParams</span><span class="s2">:</span>
    <span class="s1">x </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]]</span>
    <span class="s1">mask </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'args, kwargs, expected'</span><span class="s2">, [</span>
        <span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], {}, [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">], {}, [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">triangles</span><span class="s2">=</span><span class="s1">triangles</span><span class="s2">), [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">=</span><span class="s1">mask</span><span class="s2">), [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">], </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">=</span><span class="s1">mask</span><span class="s2">), [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">], </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">triangles</span><span class="s2">=</span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s1">mask</span><span class="s2">), [</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">])</span>
    <span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_extract_triangulation_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s1">other_args </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">other_kwargs </span><span class="s2">= {</span><span class="s4">'a'</span><span class="s2">: </span><span class="s3">3</span><span class="s2">, </span><span class="s4">'b'</span><span class="s2">: </span><span class="s4">'4'</span><span class="s2">}</span>
        <span class="s1">x_</span><span class="s2">, </span><span class="s1">y_</span><span class="s2">, </span><span class="s1">triangles_</span><span class="s2">, </span><span class="s1">mask_</span><span class="s2">, </span><span class="s1">args_</span><span class="s2">, </span><span class="s1">kwargs_ </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">.</span><span class="s1">_extract_triangulation_params</span><span class="s2">(</span>
                <span class="s1">args </span><span class="s2">+ </span><span class="s1">other_args</span><span class="s2">, {**</span><span class="s1">kwargs</span><span class="s2">, **</span><span class="s1">other_kwargs</span><span class="s2">})</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask </span><span class="s2">= </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">x_ </span><span class="s0">is </span><span class="s1">x</span>
        <span class="s0">assert </span><span class="s1">y_ </span><span class="s0">is </span><span class="s1">y</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">triangles_</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">mask_ </span><span class="s0">is </span><span class="s1">mask</span>
        <span class="s0">assert </span><span class="s1">args_ </span><span class="s2">== </span><span class="s1">other_args</span>
        <span class="s0">assert </span><span class="s1">kwargs_ </span><span class="s2">== </span><span class="s1">other_kwargs</span>


<span class="s0">def </span><span class="s1">test_extract_triangulation_positional_mask</span><span class="s2">():</span>
    <span class="s5"># mask cannot be passed positionally</span>
    <span class="s1">mask </span><span class="s2">= [</span><span class="s0">True</span><span class="s2">]</span>
    <span class="s1">args </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]], </span><span class="s1">mask</span><span class="s2">]</span>
    <span class="s1">x_</span><span class="s2">, </span><span class="s1">y_</span><span class="s2">, </span><span class="s1">triangles_</span><span class="s2">, </span><span class="s1">mask_</span><span class="s2">, </span><span class="s1">args_</span><span class="s2">, </span><span class="s1">kwargs_ </span><span class="s2">= </span><span class="s1">\</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">.</span><span class="s1">_extract_triangulation_params</span><span class="s2">(</span><span class="s1">args</span><span class="s2">, {})</span>
    <span class="s0">assert </span><span class="s1">mask_ </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">args_ </span><span class="s2">== [</span><span class="s1">mask</span><span class="s2">]</span>
    <span class="s5"># the positional mask must be caught downstream because this must pass</span>
    <span class="s5"># unknown args through</span>


<span class="s0">def </span><span class="s1">test_triangulation_init</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;x and y must be equal-length&quot;</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;triangles must be a \(N, 3\) int array, but found shape &quot;</span>
                  <span class="s4">r&quot;\(3,\)&quot;</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;triangles must be a \(N, 3\) int array, not 'other'&quot;</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">'other'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;found value 99&quot;</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">99</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;found value -1&quot;</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_triangulation_set_mask</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>

    <span class="s5"># Check neighbors, which forces creation of C++ triangulation</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">neighbors</span><span class="s2">, [[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>

    <span class="s5"># Set mask</span>
    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>

    <span class="s5"># Reset mask</span>
    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">mask </span><span class="s0">is None</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s4">r&quot;mask array must have same length as triangles array&quot;</span>
    <span class="s0">for </span><span class="s1">mask </span><span class="s0">in </span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], [</span><span class="s0">False</span><span class="s2">], [</span><span class="s0">True</span><span class="s2">], </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_delaunay</span><span class="s2">():</span>
    <span class="s5"># No duplicate points, regular grid.</span>
    <span class="s1">nx </span><span class="s2">= </span><span class="s3">5</span>
    <span class="s1">ny </span><span class="s2">= </span><span class="s3">4</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">nx</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">ny</span><span class="s2">))</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">npoints </span><span class="s2">= </span><span class="s1">nx</span><span class="s2">*</span><span class="s1">ny</span>
    <span class="s1">ntriangles </span><span class="s2">= </span><span class="s3">2 </span><span class="s2">* (</span><span class="s1">nx</span><span class="s2">-</span><span class="s3">1</span><span class="s2">) * (</span><span class="s1">ny</span><span class="s2">-</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">nedges </span><span class="s2">= </span><span class="s3">3</span><span class="s2">*</span><span class="s1">nx</span><span class="s2">*</span><span class="s1">ny </span><span class="s2">- </span><span class="s3">2</span><span class="s2">*</span><span class="s1">nx </span><span class="s2">- </span><span class="s3">2</span><span class="s2">*</span><span class="s1">ny </span><span class="s2">+ </span><span class="s3">1</span>

    <span class="s5"># Create delaunay triangulation.</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># The tests in the remainder of this function should be passed by any</span>
    <span class="s5"># triangulation that does not contain duplicate points.</span>

    <span class="s5"># Points - floating point.</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># Triangles - integers.</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">) == </span><span class="s1">ntriangles</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">) == </span><span class="s3">0</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">) == </span><span class="s1">npoints</span><span class="s2">-</span><span class="s3">1</span>

    <span class="s5"># Edges - integers.</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">edges</span><span class="s2">) == </span><span class="s1">nedges</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">edges</span><span class="s2">) == </span><span class="s3">0</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">edges</span><span class="s2">) == </span><span class="s1">npoints</span><span class="s2">-</span><span class="s3">1</span>

    <span class="s5"># Neighbors - integers.</span>
    <span class="s5"># Check that neighbors calculated by C++ triangulation class are the same</span>
    <span class="s5"># as those returned from delaunay routine.</span>
    <span class="s1">neighbors </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">neighbors</span>
    <span class="s1">triang</span><span class="s2">.</span><span class="s1">_neighbors </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">neighbors</span><span class="s2">, </span><span class="s1">neighbors</span><span class="s2">)</span>

    <span class="s5"># Is each point used in at least one triangle?</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">npoints</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_delaunay_duplicate_points</span><span class="s2">():</span>
    <span class="s1">npoints </span><span class="s2">= </span><span class="s3">10</span>
    <span class="s1">duplicate </span><span class="s2">= </span><span class="s3">7</span>
    <span class="s1">duplicate_of </span><span class="s2">= </span><span class="s3">3</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">23</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">npoints</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">npoints</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">[</span><span class="s1">duplicate</span><span class="s2">] = </span><span class="s1">x</span><span class="s2">[</span><span class="s1">duplicate_of</span><span class="s2">]</span>
    <span class="s1">y</span><span class="s2">[</span><span class="s1">duplicate</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[</span><span class="s1">duplicate_of</span><span class="s2">]</span>

    <span class="s5"># Create delaunay triangulation.</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># Duplicate points should be ignored, so the index of the duplicate points</span>
    <span class="s5"># should not appear in any triangle.</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">),</span>
                       <span class="s1">np</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">npoints</span><span class="s2">), </span><span class="s1">duplicate</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_delaunay_points_in_line</span><span class="s2">():</span>
    <span class="s5"># Cannot triangulate points that are all in a straight line, but check</span>
    <span class="s5"># that delaunay code fails gracefully.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">11</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s5"># Add an extra point not on the line and the triangulation is OK.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s3">8.0</span><span class="s2">)</span>
    <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'x, y'</span><span class="s2">, [</span>
    <span class="s5"># Triangulation should raise a ValueError if passed less than 3 points.</span>
    <span class="s2">([], []),</span>
    <span class="s2">([</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]),</span>
    <span class="s5"># Triangulation should also raise a ValueError if passed duplicate points</span>
    <span class="s5"># such that there are less than 3 unique points.</span>
    <span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_delaunay_insufficient_points</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_delaunay_robust</span><span class="s2">():</span>
    <span class="s5"># Fails when mtri.Triangulation uses matplotlib.delaunay, works when using</span>
    <span class="s5"># qhull.</span>
    <span class="s1">tri_points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
        <span class="s2">[</span><span class="s3">0.8660254037844384</span><span class="s2">, -</span><span class="s3">0.5000000000000004</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.7577722283113836</span><span class="s2">, -</span><span class="s3">0.5000000000000004</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.6495190528383288</span><span class="s2">, -</span><span class="s3">0.5000000000000003</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.5412658773652739</span><span class="s2">, -</span><span class="s3">0.5000000000000003</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.811898816047911</span><span class="s2">, -</span><span class="s3">0.40625000000000044</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.7036456405748561</span><span class="s2">, -</span><span class="s3">0.4062500000000004</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.5953924651018013</span><span class="s2">, -</span><span class="s3">0.40625000000000033</span><span class="s2">]])</span>
    <span class="s1">test_points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span>
        <span class="s2">[</span><span class="s3">0.58</span><span class="s2">, -</span><span class="s3">0.46</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.65</span><span class="s2">, -</span><span class="s3">0.46</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.65</span><span class="s2">, -</span><span class="s3">0.42</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.7</span><span class="s2">, -</span><span class="s3">0.48</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.7</span><span class="s2">, -</span><span class="s3">0.44</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.75</span><span class="s2">, -</span><span class="s3">0.44</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.8</span><span class="s2">, -</span><span class="s3">0.48</span><span class="s2">]])</span>

    <span class="s5"># Utility function that indicates if a triangle defined by 3 points</span>
    <span class="s5"># (xtri, ytri) contains the test point xy.  Avoid calling with a point that</span>
    <span class="s5"># lies on or very near to an edge of the triangle.</span>
    <span class="s0">def </span><span class="s1">tri_contains_point</span><span class="s2">(</span><span class="s1">xtri</span><span class="s2">, </span><span class="s1">ytri</span><span class="s2">, </span><span class="s1">xy</span><span class="s2">):</span>
        <span class="s1">tri_points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">((</span><span class="s1">xtri</span><span class="s2">, </span><span class="s1">ytri</span><span class="s2">)).</span><span class="s1">T</span>
        <span class="s0">return </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">tri_points</span><span class="s2">).</span><span class="s1">contains_point</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">)</span>

    <span class="s5"># Utility function that returns how many triangles of the specified</span>
    <span class="s5"># triangulation contain the test point xy.  Avoid calling with a point that</span>
    <span class="s5"># lies on or very near to an edge of any triangle in the triangulation.</span>
    <span class="s0">def </span><span class="s1">tris_contain_point</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">xy</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">tri_contains_point</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s1">tri</span><span class="s2">], </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">[</span><span class="s1">tri</span><span class="s2">], </span><span class="s1">xy</span><span class="s2">)</span>
                   <span class="s0">for </span><span class="s1">tri </span><span class="s0">in </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">)</span>

    <span class="s5"># Using matplotlib.delaunay, an invalid triangulation is created with</span>
    <span class="s5"># overlapping triangles; qhull is OK.</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">tri_points</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">tri_points</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">test_point </span><span class="s0">in </span><span class="s1">test_points</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">tris_contain_point</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">test_point</span><span class="s2">) == </span><span class="s3">1</span>

    <span class="s5"># If ignore the first point of tri_points, matplotlib.delaunay throws a</span>
    <span class="s5"># KeyError when calculating the convex hull; qhull is OK.</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">tri_points</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">tri_points</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:, </span><span class="s3">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'tripcolor1.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_tripcolor</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,   </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,   </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,   </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,   </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">])</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span>
        <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">]])</span>

    <span class="s5"># Triangulation with same number of points and triangles.</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>

    <span class="s1">Cpoints </span><span class="s2">= </span><span class="s1">x </span><span class="s2">+ </span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">y</span>

    <span class="s1">xmid </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ymid </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">Cfaces </span><span class="s2">= </span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">xmid </span><span class="s2">+ </span><span class="s1">ymid</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot</span><span class="s2">(</span><span class="s3">121</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">Cpoints</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">=</span><span class="s4">'k'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">title</span><span class="s2">(</span><span class="s4">'point colors'</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplot</span><span class="s2">(</span><span class="s3">122</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=</span><span class="s1">Cfaces</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">=</span><span class="s4">'k'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">title</span><span class="s2">(</span><span class="s4">'facecolors'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_tripcolor_color</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;tripcolor\(\) missing 1 required &quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;The length of c must match either&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;length of facecolors must match .* triangles&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;'gouraud' .* at the points.* not at the faces&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">shading</span><span class="s2">=</span><span class="s4">'gouraud'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;'gouraud' .* at the points.* not at the faces&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">shading</span><span class="s2">=</span><span class="s4">'gouraud'</span><span class="s2">)  </span><span class="s5"># faces</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">,</span>
                       <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;positional.*'c'.*keyword-only.*'facecolors'&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">C</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Unexpected positional parameter&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s4">'unused_positional'</span><span class="s2">)</span>

    <span class="s5"># smoke test for valid color specifications (via C or facecolors)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">])  </span><span class="s5"># edges</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], </span><span class="s1">shading</span><span class="s2">=</span><span class="s4">'gouraud'</span><span class="s2">)  </span><span class="s5"># edges</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])  </span><span class="s5"># faces</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])  </span><span class="s5"># faces</span>


<span class="s0">def </span><span class="s1">test_tripcolor_clim</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">19680801</span><span class="s2">)</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">10</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">().</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">clim </span><span class="s2">= (</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">)</span>
    <span class="s1">norm </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">clim</span><span class="s2">=</span><span class="s1">clim</span><span class="s2">).</span><span class="s1">norm</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">vmin</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">.</span><span class="s1">vmax</span><span class="s2">) == </span><span class="s1">clim</span>


<span class="s0">def </span><span class="s1">test_tripcolor_warnings</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">c </span><span class="s2">= [</span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s5"># facecolors takes precedence over c</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Positional parameter c .*no effect&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=</span><span class="s1">c</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;Positional parameter c .*no effect&quot;</span><span class="s2">):</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tripcolor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">'interpreted as c'</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=</span><span class="s1">c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_no_modify</span><span class="s2">():</span>
    <span class="s5"># Test that Triangulation does not modify triangles array passed to it.</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">), (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)])</span>

    <span class="s1">old_triangles </span><span class="s2">= </span><span class="s1">triangles</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">points</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">points</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">triangles</span><span class="s2">).</span><span class="s1">edges</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">old_triangles</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_trifinder</span><span class="s2">():</span>
    <span class="s5"># Test points within triangles of masked triangulation.</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">4</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">9</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">12</span><span class="s2">], [</span><span class="s3">9</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">12</span><span class="s2">], [</span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">13</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">13</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">14</span><span class="s2">], [</span><span class="s3">11</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">14</span><span class="s2">]]</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">triangles</span><span class="s2">))</span>
    <span class="s1">mask</span><span class="s2">[</span><span class="s3">8</span><span class="s2">:</span><span class="s3">10</span><span class="s2">] = </span><span class="s3">1</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">trifinder </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()</span>

    <span class="s1">xs </span><span class="s2">= [</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.25</span><span class="s2">, </span><span class="s3">3.25</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= [</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">2.25</span><span class="s2">, </span><span class="s3">3.25</span><span class="s2">]</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">xs </span><span class="s2">= </span><span class="s1">xs</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">ys </span><span class="s2">= </span><span class="s1">ys</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">,</span>
                              <span class="s3">12</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">-</span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">,</span>
                              <span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">17</span><span class="s2">])</span>

    <span class="s5"># Test points exactly on boundary edges of masked triangulation.</span>
    <span class="s1">xs </span><span class="s2">= [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">]</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">17</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">])</span>

    <span class="s5"># Test points exactly on boundary corners of masked triangulation.</span>
    <span class="s1">xs </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">]</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">17</span><span class="s2">])</span>

    <span class="s5">#</span>
    <span class="s5"># Test triangles with horizontal colinear points.  These are not valid</span>
    <span class="s5"># triangulations, but we try to deal with the simplest violations.</span>
    <span class="s5">#</span>

    <span class="s5"># If +ve, triangulation is OK, if -ve triangulation invalid,</span>
    <span class="s5"># if zero have colinear points but should pass tests anyway.</span>
    <span class="s1">delta </span><span class="s2">= </span><span class="s3">0.0</span>

    <span class="s1">x </span><span class="s2">= [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">,   </span><span class="s3">1.5</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">delta</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
    <span class="s1">trifinder </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()</span>

    <span class="s1">xs </span><span class="s2">= [-</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">1.4</span><span class="s2">, </span><span class="s3">1.9</span><span class="s2">, </span><span class="s3">2.4</span><span class="s2">, </span><span class="s3">2.9</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= [-</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">]</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">],</span>
                              <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s5">#</span>
    <span class="s5"># Test triangles with vertical colinear points.  These are not valid</span>
    <span class="s5"># triangulations, but we try to deal with the simplest violations.</span>
    <span class="s5">#</span>

    <span class="s5"># If +ve, triangulation is OK, if -ve triangulation invalid,</span>
    <span class="s5"># if zero have colinear points but should pass tests anyway.</span>
    <span class="s1">delta </span><span class="s2">= </span><span class="s3">0.0</span>

    <span class="s1">x </span><span class="s2">= [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s1">delta</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">,   </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">]</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
    <span class="s1">trifinder </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()</span>

    <span class="s1">xs </span><span class="s2">= [-</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= [-</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">1.4</span><span class="s2">, </span><span class="s3">1.9</span><span class="s2">, </span><span class="s3">2.4</span><span class="s2">, </span><span class="s3">2.9</span><span class="s2">]</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">7</span><span class="s2">],</span>
                              <span class="s2">[-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s5"># Test that changing triangulation by setting a mask causes the trifinder</span>
    <span class="s5"># to be reinitialised.</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
    <span class="s1">trifinder </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()</span>

    <span class="s1">xs </span><span class="s2">= [-</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">]</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">trifinder </span><span class="s2">== </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()</span>
    <span class="s1">tris </span><span class="s2">= </span><span class="s1">trifinder</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">tris</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_triinterp</span><span class="s2">():</span>
    <span class="s5"># Test points within triangles of masked triangulation.</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">4</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">4</span><span class="s2">))</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s3">1.23</span><span class="s2">*</span><span class="s1">x </span><span class="s2">- </span><span class="s3">4.79</span><span class="s2">*</span><span class="s1">y</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">9</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">9</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">7</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">10</span><span class="s2">], [</span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s2">, </span><span class="s3">12</span><span class="s2">], [</span><span class="s3">9</span><span class="s2">, </span><span class="s3">13</span><span class="s2">, </span><span class="s3">12</span><span class="s2">], [</span><span class="s3">9</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">13</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">13</span><span class="s2">], [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">14</span><span class="s2">], [</span><span class="s3">11</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">14</span><span class="s2">]]</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">triangles</span><span class="s2">))</span>
    <span class="s1">mask</span><span class="s2">[</span><span class="s3">8</span><span class="s2">:</span><span class="s3">10</span><span class="s2">] = </span><span class="s3">1</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">linear_interp </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">LinearTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">cubic_min_E </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">cubic_geom </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'geom'</span><span class="s2">)</span>

    <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">2.75</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
    <span class="s1">ys </span><span class="s2">= [</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">2.25</span><span class="s2">, </span><span class="s3">2.75</span><span class="s2">]</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)  </span><span class="s5"># Testing arrays with array.ndim = 2</span>
    <span class="s0">for </span><span class="s1">interp </span><span class="s0">in </span><span class="s2">(</span><span class="s1">linear_interp</span><span class="s2">, </span><span class="s1">cubic_min_E</span><span class="s2">, </span><span class="s1">cubic_geom</span><span class="s2">):</span>
        <span class="s1">zs </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zs</span><span class="s2">, (</span><span class="s3">1.23</span><span class="s2">*</span><span class="s1">xs </span><span class="s2">- </span><span class="s3">4.79</span><span class="s2">*</span><span class="s1">ys</span><span class="s2">))</span>

    <span class="s5"># Test points outside triangulation.</span>
    <span class="s1">xs </span><span class="s2">= [-</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">1.75</span><span class="s2">, </span><span class="s3">3.25</span><span class="s2">]</span>
    <span class="s1">ys </span><span class="s2">= </span><span class="s1">xs</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">interp </span><span class="s0">in </span><span class="s2">(</span><span class="s1">linear_interp</span><span class="s2">, </span><span class="s1">cubic_min_E</span><span class="s2">, </span><span class="s1">cubic_geom</span><span class="s2">):</span>
        <span class="s1">zs </span><span class="s2">= </span><span class="s1">linear_interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">zs</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, [[</span><span class="s0">True</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">)</span>

    <span class="s5"># Test mixed configuration (outside / inside).</span>
    <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">1.75</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)</span>
    <span class="s1">ys </span><span class="s2">= [</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.75</span><span class="s2">, </span><span class="s3">1.25</span><span class="s2">, </span><span class="s3">1.75</span><span class="s2">]</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">interp </span><span class="s0">in </span><span class="s2">(</span><span class="s1">linear_interp</span><span class="s2">, </span><span class="s1">cubic_min_E</span><span class="s2">, </span><span class="s1">cubic_geom</span><span class="s2">):</span>
        <span class="s1">zs </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
        <span class="s1">matest</span><span class="s2">.</span><span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zs</span><span class="s2">, (</span><span class="s3">1.23</span><span class="s2">*</span><span class="s1">xs </span><span class="s2">- </span><span class="s3">4.79</span><span class="s2">*</span><span class="s1">ys</span><span class="s2">))</span>
        <span class="s1">mask </span><span class="s2">= (</span><span class="s1">xs </span><span class="s2">&gt;= </span><span class="s3">1</span><span class="s2">) * (</span><span class="s1">xs </span><span class="s2">&lt;= </span><span class="s3">2</span><span class="s2">) * (</span><span class="s1">ys </span><span class="s2">&gt;= </span><span class="s3">1</span><span class="s2">) * (</span><span class="s1">ys </span><span class="s2">&lt;= </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">zs</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s5"># 2nd order patch test: on a grid with an 'arbitrary shaped' triangle,</span>
    <span class="s5"># patch test shall be exact for quadratic functions and cubic</span>
    <span class="s5"># interpolator if *kind* = user</span>
    <span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">) = (</span><span class="s3">1.23</span><span class="s2">, -</span><span class="s3">4.79</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">quad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">a</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">-</span><span class="s3">0.5</span><span class="s2">)**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s1">b</span><span class="s2">*(</span><span class="s1">y</span><span class="s2">-</span><span class="s3">0.5</span><span class="s2">)**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s1">c</span><span class="s2">*</span><span class="s1">x</span><span class="s2">*</span><span class="s1">y</span>

    <span class="s0">def </span><span class="s1">gradient_quad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">a</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">-</span><span class="s3">0.5</span><span class="s2">) + </span><span class="s1">c</span><span class="s2">*</span><span class="s1">y</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">b</span><span class="s2">*(</span><span class="s1">y</span><span class="s2">-</span><span class="s3">0.5</span><span class="s2">) + </span><span class="s1">c</span><span class="s2">*</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.33367</span><span class="s2">, </span><span class="s3">0.669</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.80755</span><span class="s2">, </span><span class="s3">0.4335</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">quad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">dz </span><span class="s2">= </span><span class="s1">gradient_quad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s5"># test points for 2nd order patch test</span>
    <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">cubic_user </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'user'</span><span class="s2">, </span><span class="s1">dz</span><span class="s2">=</span><span class="s1">dz</span><span class="s2">)</span>
    <span class="s1">interp_zs </span><span class="s2">= </span><span class="s1">cubic_user</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">interp_zs</span><span class="s2">, </span><span class="s1">quad</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">))</span>
    <span class="s2">(</span><span class="s1">interp_dzsdx</span><span class="s2">, </span><span class="s1">interp_dzsdy</span><span class="s2">) = </span><span class="s1">cubic_user</span><span class="s2">.</span><span class="s1">gradient</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">dzsdx</span><span class="s2">, </span><span class="s1">dzsdy</span><span class="s2">) = </span><span class="s1">gradient_quad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">interp_dzsdx</span><span class="s2">, </span><span class="s1">dzsdx</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">interp_dzsdy</span><span class="s2">, </span><span class="s1">dzsdy</span><span class="s2">)</span>

    <span class="s5"># Cubic improvement: cubic interpolation shall perform better than linear</span>
    <span class="s5"># on a sufficiently dense mesh for a quadratic function.</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s3">11</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">quad</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">=</span><span class="s1">meshgrid_triangles</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">5</span><span class="s2">))</span>
    <span class="s1">xs </span><span class="s2">= </span><span class="s1">xs</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">ys </span><span class="s2">= </span><span class="s1">ys</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">linear_interp </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">LinearTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">cubic_min_E </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">cubic_geom </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'geom'</span><span class="s2">)</span>
    <span class="s1">zs </span><span class="s2">= </span><span class="s1">quad</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
    <span class="s1">diff_lin </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">linear_interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">) - </span><span class="s1">zs</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">interp </span><span class="s0">in </span><span class="s2">(</span><span class="s1">cubic_min_E</span><span class="s2">, </span><span class="s1">cubic_geom</span><span class="s2">):</span>
        <span class="s1">diff_cubic </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">) - </span><span class="s1">zs</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">diff_lin</span><span class="s2">) &gt;= </span><span class="s3">10 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">diff_cubic</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">diff_lin</span><span class="s2">, </span><span class="s1">diff_lin</span><span class="s2">) &gt;=</span>
                <span class="s3">100 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">diff_cubic</span><span class="s2">, </span><span class="s1">diff_cubic</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_triinterpcubic_C1_continuity</span><span class="s2">():</span>
    <span class="s5"># Below the 4 tests which demonstrate C1 continuity of the</span>
    <span class="s5"># TriCubicInterpolator (testing the cubic shape functions on arbitrary</span>
    <span class="s5"># triangle):</span>
    <span class="s5">#</span>
    <span class="s5"># 1) Testing continuity of function &amp; derivatives at corner for all 9</span>
    <span class="s5">#    shape functions. Testing also function values at same location.</span>
    <span class="s5"># 2) Testing C1 continuity along each edge (as gradient is polynomial of</span>
    <span class="s5">#    2nd order, it is sufficient to test at the middle).</span>
    <span class="s5"># 3) Testing C1 continuity at triangle barycenter (where the 3 subtriangles</span>
    <span class="s5">#    meet)</span>
    <span class="s5"># 4) Testing C1 continuity at median 1/3 points (midside between 2</span>
    <span class="s5">#    subtriangles)</span>

    <span class="s5"># Utility test function check_continuity</span>
    <span class="s0">def </span><span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interpolator</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">values</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Checks the continuity of interpolator (and its derivatives) near 
        location loc. Can check the value at loc itself if *values* is 
        provided. 
 
        *interpolator* TriInterpolator 
        *loc* location to test (x0, y0) 
        *values* (optional) array [z0, dzx0, dzy0] to check the value at *loc* 
        &quot;&quot;&quot;</span>
        <span class="s1">n_star </span><span class="s2">= </span><span class="s3">24       </span><span class="s5"># Number of continuity points in a boundary of loc</span>
        <span class="s1">epsilon </span><span class="s2">= </span><span class="s3">1.e-10  </span><span class="s5"># Distance for loc boundary</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s3">100.          </span><span class="s5"># Continuity coefficient</span>
        <span class="s2">(</span><span class="s1">loc_x</span><span class="s2">, </span><span class="s1">loc_y</span><span class="s2">) = </span><span class="s1">loc</span>
        <span class="s1">star_x </span><span class="s2">= </span><span class="s1">loc_x </span><span class="s2">+ </span><span class="s1">epsilon</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s1">n_star</span><span class="s2">))</span>
        <span class="s1">star_y </span><span class="s2">= </span><span class="s1">loc_y </span><span class="s2">+ </span><span class="s1">epsilon</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s1">n_star</span><span class="s2">))</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">interpolator</span><span class="s2">([</span><span class="s1">loc_x</span><span class="s2">], [</span><span class="s1">loc_y</span><span class="s2">])[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s2">(</span><span class="s1">dzx</span><span class="s2">, </span><span class="s1">dzy</span><span class="s2">) = </span><span class="s1">interpolator</span><span class="s2">.</span><span class="s1">gradient</span><span class="s2">([</span><span class="s1">loc_x</span><span class="s2">], [</span><span class="s1">loc_y</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">values </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">values</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">dzx</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">values</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">dzy</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">values</span><span class="s2">[</span><span class="s3">2</span><span class="s2">])</span>
        <span class="s1">diff_z </span><span class="s2">= </span><span class="s1">interpolator</span><span class="s2">(</span><span class="s1">star_x</span><span class="s2">, </span><span class="s1">star_y</span><span class="s2">) - </span><span class="s1">z</span>
        <span class="s2">(</span><span class="s1">tab_dzx</span><span class="s2">, </span><span class="s1">tab_dzy</span><span class="s2">) = </span><span class="s1">interpolator</span><span class="s2">.</span><span class="s1">gradient</span><span class="s2">(</span><span class="s1">star_x</span><span class="s2">, </span><span class="s1">star_y</span><span class="s2">)</span>
        <span class="s1">diff_dzx </span><span class="s2">= </span><span class="s1">tab_dzx </span><span class="s2">- </span><span class="s1">dzx</span>
        <span class="s1">diff_dzy </span><span class="s2">= </span><span class="s1">tab_dzy </span><span class="s2">- </span><span class="s1">dzy</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">diff_z</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">*</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">diff_dzx</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">*</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">diff_dzy</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">*</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s5"># Drawing arbitrary triangle (a, b, c) inside a unit square.</span>
    <span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">) = (</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">bx</span><span class="s2">, </span><span class="s1">by</span><span class="s2">) = (</span><span class="s3">0.33367</span><span class="s2">, </span><span class="s3">0.80755</span><span class="s2">)</span>
    <span class="s2">(</span><span class="s1">cx</span><span class="s2">, </span><span class="s1">cy</span><span class="s2">) = (</span><span class="s3">0.669</span><span class="s2">, </span><span class="s3">0.4335</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">bx</span><span class="s2">, </span><span class="s1">cx</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">ay</span><span class="s2">, </span><span class="s1">by</span><span class="s2">, </span><span class="s1">cy</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">],</span>
                          <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">idof </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">9</span><span class="s2">):</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">7</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">dzx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">7</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">dzy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">7</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">case </span><span class="s2">= </span><span class="s1">idof</span><span class="s2">//</span><span class="s3">3</span>
        <span class="s1">values</span><span class="s2">[</span><span class="s1">case</span><span class="s2">, </span><span class="s1">idof </span><span class="s2">% </span><span class="s3">3</span><span class="s2">] = </span><span class="s3">1.0</span>
        <span class="s0">if </span><span class="s1">case </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">z</span><span class="s2">[</span><span class="s1">idof</span><span class="s2">] = </span><span class="s3">1.0</span>
        <span class="s0">elif </span><span class="s1">case </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
            <span class="s1">dzx</span><span class="s2">[</span><span class="s1">idof </span><span class="s2">% </span><span class="s3">3</span><span class="s2">] = </span><span class="s3">1.0</span>
        <span class="s0">elif </span><span class="s1">case </span><span class="s2">== </span><span class="s3">2</span><span class="s2">:</span>
            <span class="s1">dzy</span><span class="s2">[</span><span class="s1">idof </span><span class="s2">% </span><span class="s3">3</span><span class="s2">] = </span><span class="s3">1.0</span>
        <span class="s1">interp </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'user'</span><span class="s2">,</span>
                                           <span class="s1">dz</span><span class="s2">=(</span><span class="s1">dzx</span><span class="s2">, </span><span class="s1">dzy</span><span class="s2">))</span>
        <span class="s5"># Test 1) Checking values and continuity at nodes</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, (</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">), </span><span class="s1">values</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, (</span><span class="s1">bx</span><span class="s2">, </span><span class="s1">by</span><span class="s2">), </span><span class="s1">values</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, (</span><span class="s1">cx</span><span class="s2">, </span><span class="s1">cy</span><span class="s2">), </span><span class="s1">values</span><span class="s2">[:, </span><span class="s3">2</span><span class="s2">])</span>
        <span class="s5"># Test 2) Checking continuity at midside nodes</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s1">ax</span><span class="s2">+</span><span class="s1">bx</span><span class="s2">)*</span><span class="s3">0.5</span><span class="s2">, (</span><span class="s1">ay</span><span class="s2">+</span><span class="s1">by</span><span class="s2">)*</span><span class="s3">0.5</span><span class="s2">))</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s1">ax</span><span class="s2">+</span><span class="s1">cx</span><span class="s2">)*</span><span class="s3">0.5</span><span class="s2">, (</span><span class="s1">ay</span><span class="s2">+</span><span class="s1">cy</span><span class="s2">)*</span><span class="s3">0.5</span><span class="s2">))</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s1">cx</span><span class="s2">+</span><span class="s1">bx</span><span class="s2">)*</span><span class="s3">0.5</span><span class="s2">, (</span><span class="s1">cy</span><span class="s2">+</span><span class="s1">by</span><span class="s2">)*</span><span class="s3">0.5</span><span class="s2">))</span>
        <span class="s5"># Test 3) Checking continuity at barycenter</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s1">ax</span><span class="s2">+</span><span class="s1">bx</span><span class="s2">+</span><span class="s1">cx</span><span class="s2">)/</span><span class="s3">3.</span><span class="s2">, (</span><span class="s1">ay</span><span class="s2">+</span><span class="s1">by</span><span class="s2">+</span><span class="s1">cy</span><span class="s2">)/</span><span class="s3">3.</span><span class="s2">))</span>
        <span class="s5"># Test 4) Checking continuity at median 1/3-point</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s3">4.</span><span class="s2">*</span><span class="s1">ax</span><span class="s2">+</span><span class="s1">bx</span><span class="s2">+</span><span class="s1">cx</span><span class="s2">)/</span><span class="s3">6.</span><span class="s2">, (</span><span class="s3">4.</span><span class="s2">*</span><span class="s1">ay</span><span class="s2">+</span><span class="s1">by</span><span class="s2">+</span><span class="s1">cy</span><span class="s2">)/</span><span class="s3">6.</span><span class="s2">))</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s1">ax</span><span class="s2">+</span><span class="s3">4.</span><span class="s2">*</span><span class="s1">bx</span><span class="s2">+</span><span class="s1">cx</span><span class="s2">)/</span><span class="s3">6.</span><span class="s2">, (</span><span class="s1">ay</span><span class="s2">+</span><span class="s3">4.</span><span class="s2">*</span><span class="s1">by</span><span class="s2">+</span><span class="s1">cy</span><span class="s2">)/</span><span class="s3">6.</span><span class="s2">))</span>
        <span class="s1">check_continuity</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, ((</span><span class="s1">ax</span><span class="s2">+</span><span class="s1">bx</span><span class="s2">+</span><span class="s3">4.</span><span class="s2">*</span><span class="s1">cx</span><span class="s2">)/</span><span class="s3">6.</span><span class="s2">, (</span><span class="s1">ay</span><span class="s2">+</span><span class="s1">by</span><span class="s2">+</span><span class="s3">4.</span><span class="s2">*</span><span class="s1">cy</span><span class="s2">)/</span><span class="s3">6.</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_triinterpcubic_cg_solver</span><span class="s2">():</span>
    <span class="s5"># Now 3 basic tests of the Sparse CG solver, used for</span>
    <span class="s5"># TriCubicInterpolator with *kind* = 'min_E'</span>
    <span class="s5"># 1) A commonly used test involves a 2d Poisson matrix.</span>
    <span class="s0">def </span><span class="s1">poisson_sparse_matrix</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Return the sparse, (n*m, n*m) matrix in coo format resulting from the 
        discretisation of the 2-dimensional Poisson equation according to a 
        finite difference numerical scheme on a uniform (n, m) grid. 
        &quot;&quot;&quot;</span>
        <span class="s1">l </span><span class="s2">= </span><span class="s1">m</span><span class="s2">*</span><span class="s1">n</span>
        <span class="s1">rows </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)])</span>
        <span class="s1">cols </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)])</span>
        <span class="s1">vals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span>
            <span class="s3">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">l</span><span class="s2">-</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)])</span>
        <span class="s5"># In fact +1 and -1 diags have some zeros</span>
        <span class="s1">vals</span><span class="s2">[</span><span class="s1">l</span><span class="s2">:</span><span class="s3">2</span><span class="s2">*</span><span class="s1">l</span><span class="s2">-</span><span class="s3">1</span><span class="s2">][</span><span class="s1">m</span><span class="s2">-</span><span class="s3">1</span><span class="s2">::</span><span class="s1">m</span><span class="s2">] = </span><span class="s3">0.</span>
        <span class="s1">vals</span><span class="s2">[</span><span class="s3">2</span><span class="s2">*</span><span class="s1">l</span><span class="s2">-</span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">*</span><span class="s1">l</span><span class="s2">-</span><span class="s3">2</span><span class="s2">][</span><span class="s1">m</span><span class="s2">-</span><span class="s3">1</span><span class="s2">::</span><span class="s1">m</span><span class="s2">] = </span><span class="s3">0.</span>
        <span class="s0">return </span><span class="s1">vals</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">*</span><span class="s1">m</span><span class="s2">)</span>

    <span class="s5"># Instantiating a sparse Poisson matrix of size 48 x 48:</span>
    <span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m</span><span class="s2">) = (</span><span class="s3">12</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
    <span class="s1">mat </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">_triinterpolate</span><span class="s2">.</span><span class="s1">_Sparse_Matrix_coo</span><span class="s2">(*</span><span class="s1">poisson_sparse_matrix</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m</span><span class="s2">))</span>
    <span class="s1">mat</span><span class="s2">.</span><span class="s1">compress_csc</span><span class="s2">()</span>
    <span class="s1">mat_dense </span><span class="s2">= </span><span class="s1">mat</span><span class="s2">.</span><span class="s1">to_dense</span><span class="s2">()</span>
    <span class="s5"># Testing a sparse solve for all 48 basis vector</span>
    <span class="s0">for </span><span class="s1">itest </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s1">itest</span><span class="s2">] = </span><span class="s3">1.</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">_triinterpolate</span><span class="s2">.</span><span class="s1">_cg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">=</span><span class="s1">mat</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s1">b</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m</span><span class="s2">),</span>
                                        <span class="s1">tol</span><span class="s2">=</span><span class="s3">1.e-10</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">mat_dense</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s5"># 2) Same matrix with inserting 2 rows - cols with null diag terms</span>
    <span class="s5"># (but still linked with the rest of the matrix by extra-diag terms)</span>
    <span class="s2">(</span><span class="s1">i_zero</span><span class="s2">, </span><span class="s1">j_zero</span><span class="s2">) = (</span><span class="s3">12</span><span class="s2">, </span><span class="s3">49</span><span class="s2">)</span>
    <span class="s1">vals</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">poisson_sparse_matrix</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>
    <span class="s1">rows </span><span class="s2">= </span><span class="s1">rows </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">*(</span><span class="s1">rows </span><span class="s2">&gt;= </span><span class="s1">i_zero</span><span class="s2">) + </span><span class="s3">1</span><span class="s2">*(</span><span class="s1">rows </span><span class="s2">&gt;= </span><span class="s1">j_zero</span><span class="s2">)</span>
    <span class="s1">cols </span><span class="s2">= </span><span class="s1">cols </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">*(</span><span class="s1">cols </span><span class="s2">&gt;= </span><span class="s1">i_zero</span><span class="s2">) + </span><span class="s3">1</span><span class="s2">*(</span><span class="s1">cols </span><span class="s2">&gt;= </span><span class="s1">j_zero</span><span class="s2">)</span>
    <span class="s5"># adding extra-diag terms</span>
    <span class="s1">rows </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">rows</span><span class="s2">, [</span><span class="s1">i_zero</span><span class="s2">, </span><span class="s1">i_zero</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">j_zero</span><span class="s2">, </span><span class="s1">j_zero</span><span class="s2">-</span><span class="s3">1</span><span class="s2">]])</span>
    <span class="s1">cols </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">cols</span><span class="s2">, [</span><span class="s1">i_zero</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">i_zero</span><span class="s2">, </span><span class="s1">j_zero</span><span class="s2">-</span><span class="s3">1</span><span class="s2">, </span><span class="s1">j_zero</span><span class="s2">]])</span>
    <span class="s1">vals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">concatenate</span><span class="s2">([</span><span class="s1">vals</span><span class="s2">, [</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">]])</span>
    <span class="s1">mat </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">_triinterpolate</span><span class="s2">.</span><span class="s1">_Sparse_Matrix_coo</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">,</span>
                                                  <span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">*</span><span class="s1">m </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">))</span>
    <span class="s1">mat</span><span class="s2">.</span><span class="s1">compress_csc</span><span class="s2">()</span>
    <span class="s1">mat_dense </span><span class="s2">= </span><span class="s1">mat</span><span class="s2">.</span><span class="s1">to_dense</span><span class="s2">()</span>
    <span class="s5"># Testing a sparse solve for all 50 basis vec</span>
    <span class="s0">for </span><span class="s1">itest </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n</span><span class="s2">*</span><span class="s1">m </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">b</span><span class="s2">[</span><span class="s1">itest</span><span class="s2">] = </span><span class="s3">1.</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">_triinterpolate</span><span class="s2">.</span><span class="s1">_cg</span><span class="s2">(</span><span class="s1">A</span><span class="s2">=</span><span class="s1">mat</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s1">b</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">n </span><span class="s2">* </span><span class="s1">m </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">),</span>
                                        <span class="s1">tol</span><span class="s2">=</span><span class="s3">1.e-10</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">mat_dense</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s5"># 3) Now a simple test that summation of duplicate (i.e. with same rows,</span>
    <span class="s5"># same cols) entries occurs when compressed.</span>
    <span class="s1">vals </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">17</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">rows </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                    <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">cols </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                    <span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">dim </span><span class="s2">= (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">mat </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">_triinterpolate</span><span class="s2">.</span><span class="s1">_Sparse_Matrix_coo</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">, </span><span class="s1">dim</span><span class="s2">)</span>
    <span class="s1">mat</span><span class="s2">.</span><span class="s1">compress_csc</span><span class="s2">()</span>
    <span class="s1">mat_dense </span><span class="s2">= </span><span class="s1">mat</span><span class="s2">.</span><span class="s1">to_dense</span><span class="s2">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">mat_dense</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
        <span class="s2">[</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], [</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">], [</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_triinterpcubic_geom_weights</span><span class="s2">():</span>
    <span class="s5"># Tests to check computation of weights for _DOF_estimator_geom:</span>
    <span class="s5"># The weight sum per triangle can be 1. (in case all angles &lt; 90 degrees)</span>
    <span class="s5"># or (2*w_i) where w_i = 1-alpha_i/np.pi is the weight of apex i; alpha_i</span>
    <span class="s5"># is the apex angle &gt; 90 degrees.</span>
    <span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">ay</span><span class="s2">) = (</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.687</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">ax</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">ax</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">ay</span><span class="s2">, -</span><span class="s1">ay</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">])</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">sum_w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])  </span><span class="s5"># 4 possibilities; 2 triangles</span>
    <span class="s0">for </span><span class="s1">theta </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s3">14</span><span class="s2">):  </span><span class="s5"># rotating the figure...</span>
        <span class="s1">x_rot </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">y</span>
        <span class="s1">y_rot </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">y</span>
        <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x_rot</span><span class="s2">, </span><span class="s1">y_rot</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
        <span class="s1">cubic_geom </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'geom'</span><span class="s2">)</span>
        <span class="s1">dof_estimator </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">_triinterpolate</span><span class="s2">.</span><span class="s1">_DOF_estimator_geom</span><span class="s2">(</span><span class="s1">cubic_geom</span><span class="s2">)</span>
        <span class="s1">weights </span><span class="s2">= </span><span class="s1">dof_estimator</span><span class="s2">.</span><span class="s1">compute_geom_weights</span><span class="s2">()</span>
        <span class="s5"># Testing for the 4 possibilities...</span>
        <span class="s1">sum_w</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, :] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">, </span><span class="s3">1</span><span class="s2">) - </span><span class="s3">1</span>
        <span class="s0">for </span><span class="s1">itri </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
            <span class="s1">sum_w</span><span class="s2">[</span><span class="s1">itri</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, :] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">weights</span><span class="s2">, </span><span class="s3">1</span><span class="s2">) - </span><span class="s3">2</span><span class="s2">*</span><span class="s1">weights</span><span class="s2">[:, </span><span class="s1">itri</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">sum_w</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">0</span><span class="s2">),</span>
                                  <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_triinterp_colinear</span><span class="s2">():</span>
    <span class="s5"># Tests interpolating inside a triangulation with horizontal colinear</span>
    <span class="s5"># points (refer also to the tests :func:`test_trifinder` ).</span>
    <span class="s5">#</span>
    <span class="s5"># These are not valid triangulations, but we try to deal with the</span>
    <span class="s5"># simplest violations (i. e. those handled by default TriFinder).</span>
    <span class="s5">#</span>
    <span class="s5"># Note that the LinearTriInterpolator and the CubicTriInterpolator with</span>
    <span class="s5"># kind='min_E' or 'geom' still pass a linear patch test.</span>
    <span class="s5"># We also test interpolation inside a flat triangle, by forcing</span>
    <span class="s5"># *tri_index* in a call to :meth:`_interpolate_multikeys`.</span>

    <span class="s5"># If +ve, triangulation is OK, if -ve triangulation invalid,</span>
    <span class="s5"># if zero have colinear points but should pass tests anyway.</span>
    <span class="s1">delta </span><span class="s2">= </span><span class="s3">0.</span>

    <span class="s1">x0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">1</span><span class="s2">,  </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">,   </span><span class="s3">1.5</span><span class="s2">])</span>
    <span class="s1">y0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">,  </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">delta</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s5"># We test different affine transformations of the initial figure; to</span>
    <span class="s5"># avoid issues related to round-off errors we only use integer</span>
    <span class="s5"># coefficients (otherwise the Triangulation might become invalid even with</span>
    <span class="s5"># delta == 0).</span>
    <span class="s1">transformations </span><span class="s2">= [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">], [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s0">for </span><span class="s1">transformation </span><span class="s0">in </span><span class="s1">transformations</span><span class="s2">:</span>
        <span class="s1">x_rot </span><span class="s2">= </span><span class="s1">transformation</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]*</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">transformation</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]*</span><span class="s1">y0</span>
        <span class="s1">y_rot </span><span class="s2">= -</span><span class="s1">transformation</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]*</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">transformation</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]*</span><span class="s1">y0</span>
        <span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) = (</span><span class="s1">x_rot</span><span class="s2">, </span><span class="s1">y_rot</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s3">1.23</span><span class="s2">*</span><span class="s1">x </span><span class="s2">- </span><span class="s3">4.79</span><span class="s2">*</span><span class="s1">y</span>
        <span class="s1">triangles </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">],</span>
                     <span class="s2">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]]</span>
        <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
        <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">), </span><span class="s3">20</span><span class="s2">)</span>
        <span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">), </span><span class="s3">20</span><span class="s2">)</span>
        <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
        <span class="s1">xs </span><span class="s2">= </span><span class="s1">xs</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
        <span class="s1">ys </span><span class="s2">= </span><span class="s1">ys</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
        <span class="s1">mask_out </span><span class="s2">= (</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">) == -</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">zs_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s3">1.23</span><span class="s2">*</span><span class="s1">xs </span><span class="s2">- </span><span class="s3">4.79</span><span class="s2">*</span><span class="s1">ys</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s1">mask_out</span><span class="s2">)</span>

        <span class="s1">linear_interp </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">LinearTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">cubic_min_E </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">cubic_geom </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'geom'</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">interp </span><span class="s0">in </span><span class="s2">(</span><span class="s1">linear_interp</span><span class="s2">, </span><span class="s1">cubic_min_E</span><span class="s2">, </span><span class="s1">cubic_geom</span><span class="s2">):</span>
            <span class="s1">zs </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zs_target</span><span class="s2">, </span><span class="s1">zs</span><span class="s2">)</span>

        <span class="s5"># Testing interpolation inside the flat triangle number 4: [2, 3, 5]</span>
        <span class="s5"># by imposing *tri_index* in a call to :meth:`_interpolate_multikeys`</span>
        <span class="s1">itri </span><span class="s2">= </span><span class="s3">4</span>
        <span class="s1">pt1 </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">[</span><span class="s1">itri</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">pt2 </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">[</span><span class="s1">itri</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s1">pt1</span><span class="s2">], </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s1">pt2</span><span class="s2">], </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">[</span><span class="s1">pt1</span><span class="s2">], </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">[</span><span class="s1">pt2</span><span class="s2">], </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">zs_target </span><span class="s2">= </span><span class="s3">1.23</span><span class="s2">*</span><span class="s1">xs </span><span class="s2">- </span><span class="s3">4.79</span><span class="s2">*</span><span class="s1">ys</span>
        <span class="s0">for </span><span class="s1">interp </span><span class="s0">in </span><span class="s2">(</span><span class="s1">linear_interp</span><span class="s2">, </span><span class="s1">cubic_min_E</span><span class="s2">, </span><span class="s1">cubic_geom</span><span class="s2">):</span>
            <span class="s1">zs</span><span class="s2">, = </span><span class="s1">interp</span><span class="s2">.</span><span class="s1">_interpolate_multikeys</span><span class="s2">(</span>
                <span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">, </span><span class="s1">tri_index</span><span class="s2">=</span><span class="s1">itri</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">zs_target</span><span class="s2">, </span><span class="s1">zs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_triinterp_transformations</span><span class="s2">():</span>
    <span class="s5"># 1) Testing that the interpolation scheme is invariant by rotation of the</span>
    <span class="s5"># whole figure.</span>
    <span class="s5"># Note: This test is non-trivial for a CubicTriInterpolator with</span>
    <span class="s5"># kind='min_E'. It does fail for a non-isotropic stiffness matrix E of</span>
    <span class="s5"># :class:`_ReducedHCT_Element` (tested with E=np.diag([1., 1., 1.])), and</span>
    <span class="s5"># provides a good test for :meth:`get_Kff_and_Ff`of the same class.</span>
    <span class="s5">#</span>
    <span class="s5"># 2) Also testing that the interpolation scheme is invariant by expansion</span>
    <span class="s5"># of the whole figure along one axis.</span>
    <span class="s1">n_angles </span><span class="s2">= </span><span class="s3">20</span>
    <span class="s1">n_radii </span><span class="s2">= </span><span class="s3">10</span>
    <span class="s1">min_radius </span><span class="s2">= </span><span class="s3">0.15</span>

    <span class="s0">def </span><span class="s1">z</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">theta1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(-</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">, -</span><span class="s1">y </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">)</span>
        <span class="s1">theta2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">, -</span><span class="s1">y </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= -(</span><span class="s3">2</span><span class="s2">*(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">((</span><span class="s1">r1</span><span class="s2">/</span><span class="s3">10</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">)*</span><span class="s3">30. </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s3">7.</span><span class="s2">*</span><span class="s1">theta1</span><span class="s2">) +</span>
              <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">((</span><span class="s1">r2</span><span class="s2">/</span><span class="s3">10</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">)*</span><span class="s3">30. </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s3">11.</span><span class="s2">*</span><span class="s1">theta2</span><span class="s2">) +</span>
              <span class="s3">0.7</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">**</span><span class="s3">2</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)-</span><span class="s1">z</span><span class="s2">)/(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>

    <span class="s5"># First create the x and y coordinates of the points.</span>
    <span class="s1">radii </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">min_radius</span><span class="s2">, </span><span class="s3">0.95</span><span class="s2">, </span><span class="s1">n_radii</span><span class="s2">)</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0 </span><span class="s2">+ </span><span class="s1">n_angles</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">+ </span><span class="s1">n_angles</span><span class="s2">,</span>
                         <span class="s1">n_angles</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">[..., </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">], </span><span class="s1">n_radii</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">angles</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s1">n_angles</span>
    <span class="s1">x0 </span><span class="s2">= (</span><span class="s1">radii</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">y0 </span><span class="s2">= (</span><span class="s1">radii</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">triang0 </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">)  </span><span class="s5"># Delaunay triangulation</span>
    <span class="s1">z0 </span><span class="s2">= </span><span class="s1">z</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">)</span>

    <span class="s5"># Then create the test points</span>
    <span class="s1">xs0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">23</span><span class="s2">)</span>
    <span class="s1">ys0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">23</span><span class="s2">)</span>
    <span class="s1">xs0</span><span class="s2">, </span><span class="s1">ys0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xs0</span><span class="s2">, </span><span class="s1">ys0</span><span class="s2">)</span>
    <span class="s1">xs0 </span><span class="s2">= </span><span class="s1">xs0</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">ys0 </span><span class="s2">= </span><span class="s1">ys0</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>

    <span class="s1">interp_z0 </span><span class="s2">= {}</span>
    <span class="s0">for </span><span class="s1">i_angle </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">):</span>
        <span class="s5"># Rotating everything</span>
        <span class="s1">theta </span><span class="s2">= </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s1">n_angles </span><span class="s2">* </span><span class="s1">i_angle</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">y0</span>
        <span class="s1">y </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">y0</span>
        <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">xs0 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">ys0</span>
        <span class="s1">ys </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">xs0 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)*</span><span class="s1">ys0</span>
        <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triang0</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">)</span>
        <span class="s1">linear_interp </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">LinearTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">)</span>
        <span class="s1">cubic_min_E </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">)</span>
        <span class="s1">cubic_geom </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'geom'</span><span class="s2">)</span>
        <span class="s1">dic_interp </span><span class="s2">= {</span><span class="s4">'lin'</span><span class="s2">: </span><span class="s1">linear_interp</span><span class="s2">,</span>
                      <span class="s4">'min_E'</span><span class="s2">: </span><span class="s1">cubic_min_E</span><span class="s2">,</span>
                      <span class="s4">'geom'</span><span class="s2">: </span><span class="s1">cubic_geom</span><span class="s2">}</span>
        <span class="s5"># Testing that the interpolation is invariant by rotation...</span>
        <span class="s0">for </span><span class="s1">interp_key </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'lin'</span><span class="s2">, </span><span class="s4">'min_E'</span><span class="s2">, </span><span class="s4">'geom'</span><span class="s2">]:</span>
            <span class="s1">interp </span><span class="s2">= </span><span class="s1">dic_interp</span><span class="s2">[</span><span class="s1">interp_key</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">i_angle </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">interp_z0</span><span class="s2">[</span><span class="s1">interp_key</span><span class="s2">] = </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xs0</span><span class="s2">, </span><span class="s1">ys0</span><span class="s2">)  </span><span class="s5"># storage</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">interpz </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
                <span class="s1">matest</span><span class="s2">.</span><span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">interpz</span><span class="s2">,</span>
                                                 <span class="s1">interp_z0</span><span class="s2">[</span><span class="s1">interp_key</span><span class="s2">])</span>

    <span class="s1">scale_factor </span><span class="s2">= </span><span class="s3">987654.3210</span>
    <span class="s0">for </span><span class="s1">scaled_axis </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'x'</span><span class="s2">, </span><span class="s4">'y'</span><span class="s2">):</span>
        <span class="s5"># Scaling everything (expansion along scaled_axis)</span>
        <span class="s0">if </span><span class="s1">scaled_axis </span><span class="s2">== </span><span class="s4">'x'</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">scale_factor </span><span class="s2">* </span><span class="s1">x0</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">y0</span>
            <span class="s1">xs </span><span class="s2">= </span><span class="s1">scale_factor </span><span class="s2">* </span><span class="s1">xs0</span>
            <span class="s1">ys </span><span class="s2">= </span><span class="s1">ys0</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x0</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">scale_factor </span><span class="s2">* </span><span class="s1">y0</span>
            <span class="s1">xs </span><span class="s2">= </span><span class="s1">xs0</span>
            <span class="s1">ys </span><span class="s2">= </span><span class="s1">scale_factor </span><span class="s2">* </span><span class="s1">ys0</span>
        <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triang0</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">)</span>
        <span class="s1">linear_interp </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">LinearTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">)</span>
        <span class="s1">cubic_min_E </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">)</span>
        <span class="s1">cubic_geom </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z0</span><span class="s2">, </span><span class="s1">kind</span><span class="s2">=</span><span class="s4">'geom'</span><span class="s2">)</span>
        <span class="s1">dic_interp </span><span class="s2">= {</span><span class="s4">'lin'</span><span class="s2">: </span><span class="s1">linear_interp</span><span class="s2">,</span>
                      <span class="s4">'min_E'</span><span class="s2">: </span><span class="s1">cubic_min_E</span><span class="s2">,</span>
                      <span class="s4">'geom'</span><span class="s2">: </span><span class="s1">cubic_geom</span><span class="s2">}</span>
        <span class="s5"># Test that the interpolation is invariant by expansion along 1 axis...</span>
        <span class="s0">for </span><span class="s1">interp_key </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'lin'</span><span class="s2">, </span><span class="s4">'min_E'</span><span class="s2">, </span><span class="s4">'geom'</span><span class="s2">]:</span>
            <span class="s1">interpz </span><span class="s2">= </span><span class="s1">dic_interp</span><span class="s2">[</span><span class="s1">interp_key</span><span class="s2">](</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">ys</span><span class="s2">)</span>
            <span class="s1">matest</span><span class="s2">.</span><span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">interpz</span><span class="s2">, </span><span class="s1">interp_z0</span><span class="s2">[</span><span class="s1">interp_key</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'tri_smooth_contouring.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">0.072</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_tri_smooth_contouring</span><span class="s2">():</span>
    <span class="s5"># Image comparison based on example tricontour_smooth_user.</span>
    <span class="s1">n_angles </span><span class="s2">= </span><span class="s3">20</span>
    <span class="s1">n_radii </span><span class="s2">= </span><span class="s3">10</span>
    <span class="s1">min_radius </span><span class="s2">= </span><span class="s3">0.15</span>

    <span class="s0">def </span><span class="s1">z</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s1">r1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">theta1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.5 </span><span class="s2">- </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(-</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">, -</span><span class="s1">y </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">)</span>
        <span class="s1">theta2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(-</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">, -</span><span class="s1">y </span><span class="s2">- </span><span class="s3">0.2</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= -(</span><span class="s3">2</span><span class="s2">*(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">((</span><span class="s1">r1</span><span class="s2">/</span><span class="s3">10</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">)*</span><span class="s3">30. </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s3">7.</span><span class="s2">*</span><span class="s1">theta1</span><span class="s2">) +</span>
              <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">((</span><span class="s1">r2</span><span class="s2">/</span><span class="s3">10</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)-</span><span class="s3">1</span><span class="s2">)*</span><span class="s3">30. </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s3">11.</span><span class="s2">*</span><span class="s1">theta2</span><span class="s2">) +</span>
              <span class="s3">0.7</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">**</span><span class="s3">2</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)-</span><span class="s1">z</span><span class="s2">)/(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>

    <span class="s5"># First create the x and y coordinates of the points.</span>
    <span class="s1">radii </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">min_radius</span><span class="s2">, </span><span class="s3">0.95</span><span class="s2">, </span><span class="s1">n_radii</span><span class="s2">)</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0 </span><span class="s2">+ </span><span class="s1">n_angles</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">+ </span><span class="s1">n_angles</span><span class="s2">,</span>
                         <span class="s1">n_angles</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">[..., </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">], </span><span class="s1">n_radii</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">angles</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s1">n_angles</span>
    <span class="s1">x0 </span><span class="s2">= (</span><span class="s1">radii</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">y0 </span><span class="s2">= (</span><span class="s1">radii</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">triang0 </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">)  </span><span class="s5"># Delaunay triangulation</span>
    <span class="s1">z0 </span><span class="s2">= </span><span class="s1">z</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">)</span>
    <span class="s1">triang0</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">[</span><span class="s1">triang0</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">),</span>
                              <span class="s1">y0</span><span class="s2">[</span><span class="s1">triang0</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>
                     <span class="s2">&lt; </span><span class="s1">min_radius</span><span class="s2">)</span>

    <span class="s5"># Then the plot</span>
    <span class="s1">refiner </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">triang0</span><span class="s2">)</span>
    <span class="s1">tri_refi</span><span class="s2">, </span><span class="s1">z_test_refi </span><span class="s2">= </span><span class="s1">refiner</span><span class="s2">.</span><span class="s1">refine_field</span><span class="s2">(</span><span class="s1">z0</span><span class="s2">, </span><span class="s1">subdiv</span><span class="s2">=</span><span class="s3">4</span><span class="s2">)</span>
    <span class="s1">levels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.025</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">triplot</span><span class="s2">(</span><span class="s1">triang0</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'0.5'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontour</span><span class="s2">(</span><span class="s1">tri_refi</span><span class="s2">, </span><span class="s1">z_test_refi</span><span class="s2">, </span><span class="s1">levels</span><span class="s2">=</span><span class="s1">levels</span><span class="s2">, </span><span class="s1">colors</span><span class="s2">=</span><span class="s4">&quot;black&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'tri_smooth_gradient.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">0.092</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_tri_smooth_gradient</span><span class="s2">():</span>
    <span class="s5"># Image comparison based on example trigradient_demo.</span>

    <span class="s0">def </span><span class="s1">dipole_potential</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;An electric dipole potential V.&quot;&quot;&quot;</span>
        <span class="s1">r_sq </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">**</span><span class="s3">2</span>
        <span class="s1">theta </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arctan2</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)/</span><span class="s1">r_sq</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)-</span><span class="s1">z</span><span class="s2">) / (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">z</span><span class="s2">))</span>

    <span class="s5"># Creating a Triangulation</span>
    <span class="s1">n_angles </span><span class="s2">= </span><span class="s3">30</span>
    <span class="s1">n_radii </span><span class="s2">= </span><span class="s3">10</span>
    <span class="s1">min_radius </span><span class="s2">= </span><span class="s3">0.2</span>
    <span class="s1">radii </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">min_radius</span><span class="s2">, </span><span class="s3">0.95</span><span class="s2">, </span><span class="s1">n_radii</span><span class="s2">)</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s1">n_angles</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">angles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">[..., </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">], </span><span class="s1">n_radii</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">angles</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">::</span><span class="s3">2</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s1">n_angles</span>
    <span class="s1">x </span><span class="s2">= (</span><span class="s1">radii</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= (</span><span class="s1">radii</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">)).</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">V </span><span class="s2">= </span><span class="s1">dipole_potential</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">),</span>
                             <span class="s1">y</span><span class="s2">[</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>
                    <span class="s2">&lt; </span><span class="s1">min_radius</span><span class="s2">)</span>

    <span class="s5"># Refine data - interpolates the electrical potential V</span>
    <span class="s1">refiner </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>
    <span class="s1">tri_refi</span><span class="s2">, </span><span class="s1">z_test_refi </span><span class="s2">= </span><span class="s1">refiner</span><span class="s2">.</span><span class="s1">refine_field</span><span class="s2">(</span><span class="s1">V</span><span class="s2">, </span><span class="s1">subdiv</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s5"># Computes the electrical field (Ex, Ey) as gradient of -V</span>
    <span class="s1">tci </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, -</span><span class="s1">V</span><span class="s2">)</span>
    <span class="s1">Ex</span><span class="s2">, </span><span class="s1">Ey </span><span class="s2">= </span><span class="s1">tci</span><span class="s2">.</span><span class="s1">gradient</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">E_norm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">Ex</span><span class="s2">, </span><span class="s1">Ey</span><span class="s2">)</span>

    <span class="s5"># Plot the triangulation, the potential iso-contours and the vector field</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">().</span><span class="s1">set_aspect</span><span class="s2">(</span><span class="s4">'equal'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">triplot</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'0.8'</span><span class="s2">)</span>

    <span class="s1">levels </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">)</span>
    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s4">'hot'</span><span class="s2">]</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontour</span><span class="s2">(</span><span class="s1">tri_refi</span><span class="s2">, </span><span class="s1">z_test_refi</span><span class="s2">, </span><span class="s1">levels</span><span class="s2">=</span><span class="s1">levels</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">,</span>
                   <span class="s1">linewidths</span><span class="s2">=[</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s5"># Plots direction of the electrical vector field</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">quiver</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">Ex</span><span class="s2">/</span><span class="s1">E_norm</span><span class="s2">, </span><span class="s1">Ey</span><span class="s2">/</span><span class="s1">E_norm</span><span class="s2">,</span>
               <span class="s1">units</span><span class="s2">=</span><span class="s4">'xy'</span><span class="s2">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s3">10.</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'blue'</span><span class="s2">,</span>
               <span class="s1">width</span><span class="s2">=</span><span class="s3">0.007</span><span class="s2">, </span><span class="s1">headwidth</span><span class="s2">=</span><span class="s3">3.</span><span class="s2">, </span><span class="s1">headlength</span><span class="s2">=</span><span class="s3">4.</span><span class="s2">)</span>
    <span class="s5"># We are leaving ax.use_sticky_margins as True, so the</span>
    <span class="s5"># view limits are the contour data limits.</span>


<span class="s0">def </span><span class="s1">test_tritools</span><span class="s2">():</span>
    <span class="s5"># Tests TriAnalyzer.scale_factors on masked triangulation</span>
    <span class="s5"># Tests circle_ratios on equilateral and right-angled triangle.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">), -</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">analyser </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">TriAnalyzer</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">analyser</span><span class="s2">.</span><span class="s1">scale_factors</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">/(</span><span class="s3">1</span><span class="s2">+</span><span class="s3">3</span><span class="s2">**</span><span class="s3">.5</span><span class="s2">/</span><span class="s3">2</span><span class="s2">)])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">analyser</span><span class="s2">.</span><span class="s1">circle_ratios</span><span class="s2">(</span><span class="s1">rescale</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">/(</span><span class="s3">1.</span><span class="s2">+</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">))</span>

    <span class="s5"># Tests circle ratio of a flat triangle</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">+</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">+</span><span class="s3">6.</span><span class="s2">])</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">)</span>
    <span class="s1">analyser </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">TriAnalyzer</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">analyser</span><span class="s2">.</span><span class="s1">circle_ratios</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">]))</span>

    <span class="s5"># Tests TriAnalyzer.get_flat_tri_mask</span>
    <span class="s5"># Creates a triangulation of [-1, 1] x [-1, 1] with contiguous groups of</span>
    <span class="s5"># 'flat' triangles at the 4 corners and at the center. Checks that only</span>
    <span class="s5"># those at the borders are eliminated by TriAnalyzer.get_flat_tri_mask</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s3">9</span>

    <span class="s0">def </span><span class="s1">power</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)**</span><span class="s1">a</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">power</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">), </span><span class="s1">power</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">))</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>

    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">=</span><span class="s1">meshgrid_triangles</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">analyser </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">TriAnalyzer</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>
    <span class="s1">mask_flat </span><span class="s2">= </span><span class="s1">analyser</span><span class="s2">.</span><span class="s1">get_flat_tri_mask</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">)</span>
    <span class="s1">verif_mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">162</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">corners_index </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">14</span><span class="s2">, </span><span class="s3">15</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">17</span><span class="s2">, </span><span class="s3">18</span><span class="s2">, </span><span class="s3">19</span><span class="s2">, </span><span class="s3">34</span><span class="s2">, </span><span class="s3">35</span><span class="s2">, </span><span class="s3">126</span><span class="s2">, </span><span class="s3">127</span><span class="s2">,</span>
                     <span class="s3">142</span><span class="s2">, </span><span class="s3">143</span><span class="s2">, </span><span class="s3">144</span><span class="s2">, </span><span class="s3">145</span><span class="s2">, </span><span class="s3">146</span><span class="s2">, </span><span class="s3">147</span><span class="s2">, </span><span class="s3">158</span><span class="s2">, </span><span class="s3">159</span><span class="s2">, </span><span class="s3">160</span><span class="s2">, </span><span class="s3">161</span><span class="s2">]</span>
    <span class="s1">verif_mask</span><span class="s2">[</span><span class="s1">corners_index</span><span class="s2">] = </span><span class="s0">True</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">mask_flat</span><span class="s2">, </span><span class="s1">verif_mask</span><span class="s2">)</span>

    <span class="s5"># Now including a hole (masked triangle) at the center. The center also</span>
    <span class="s5"># shall be eliminated by get_flat_tri_mask.</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">162</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">mask</span><span class="s2">[</span><span class="s3">80</span><span class="s2">] = </span><span class="s0">True</span>
    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">mask_flat </span><span class="s2">= </span><span class="s1">analyser</span><span class="s2">.</span><span class="s1">get_flat_tri_mask</span><span class="s2">(</span><span class="s3">0.2</span><span class="s2">)</span>
    <span class="s1">center_index </span><span class="s2">= [</span><span class="s3">44</span><span class="s2">, </span><span class="s3">45</span><span class="s2">, </span><span class="s3">62</span><span class="s2">, </span><span class="s3">63</span><span class="s2">, </span><span class="s3">78</span><span class="s2">, </span><span class="s3">79</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">81</span><span class="s2">, </span><span class="s3">82</span><span class="s2">, </span><span class="s3">83</span><span class="s2">, </span><span class="s3">98</span><span class="s2">, </span><span class="s3">99</span><span class="s2">, </span><span class="s3">116</span><span class="s2">, </span><span class="s3">117</span><span class="s2">]</span>
    <span class="s1">verif_mask</span><span class="s2">[</span><span class="s1">center_index</span><span class="s2">] = </span><span class="s0">True</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">mask_flat</span><span class="s2">, </span><span class="s1">verif_mask</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_trirefine</span><span class="s2">():</span>
    <span class="s5"># Testing subdiv=2 refinement</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s3">3</span>
    <span class="s1">subdiv </span><span class="s2">= </span><span class="s3">2</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">2</span><span class="s2">*</span><span class="s1">n</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">mask</span><span class="s2">[</span><span class="s1">n</span><span class="s2">**</span><span class="s3">2</span><span class="s2">:] = </span><span class="s0">True</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">=</span><span class="s1">meshgrid_triangles</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s3">1</span><span class="s2">),</span>
                                <span class="s1">mask</span><span class="s2">=</span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">refiner </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>
    <span class="s1">refi_triang </span><span class="s2">= </span><span class="s1">refiner</span><span class="s2">.</span><span class="s1">refine_triangulation</span><span class="s2">(</span><span class="s1">subdiv</span><span class="s2">=</span><span class="s1">subdiv</span><span class="s2">)</span>
    <span class="s1">x_refi </span><span class="s2">= </span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">x</span>
    <span class="s1">y_refi </span><span class="s2">= </span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">y</span>

    <span class="s1">n_refi </span><span class="s2">= </span><span class="s1">n </span><span class="s2">* </span><span class="s1">subdiv</span><span class="s2">**</span><span class="s3">2</span>
    <span class="s1">x_verif </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s1">n_refi</span><span class="s2">+</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">x_verif</span><span class="s2">, </span><span class="s1">y_verif </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x_verif</span><span class="s2">, </span><span class="s1">x_verif</span><span class="s2">)</span>
    <span class="s1">x_verif </span><span class="s2">= </span><span class="s1">x_verif</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">y_verif </span><span class="s2">= </span><span class="s1">y_verif</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s1">ind1d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">around</span><span class="s2">(</span><span class="s1">x_verif</span><span class="s2">*(</span><span class="s3">2.5</span><span class="s2">+</span><span class="s1">y_verif</span><span class="s2">), </span><span class="s3">8</span><span class="s2">),</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">around</span><span class="s2">(</span><span class="s1">x_refi</span><span class="s2">*(</span><span class="s3">2.5</span><span class="s2">+</span><span class="s1">y_refi</span><span class="s2">), </span><span class="s3">8</span><span class="s2">))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ind1d</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>

    <span class="s5"># Testing the mask of the refined triangulation</span>
    <span class="s1">refi_mask </span><span class="s2">= </span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">mask</span>
    <span class="s1">refi_tri_barycenter_x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">],</span>
                                   <span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) / </span><span class="s3">3.</span>
    <span class="s1">refi_tri_barycenter_y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">[</span><span class="s1">refi_triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">],</span>
                                   <span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">) / </span><span class="s3">3.</span>
    <span class="s1">tri_finder </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_trifinder</span><span class="s2">()</span>
    <span class="s1">refi_tri_indices </span><span class="s2">= </span><span class="s1">tri_finder</span><span class="s2">(</span><span class="s1">refi_tri_barycenter_x</span><span class="s2">,</span>
                                  <span class="s1">refi_tri_barycenter_y</span><span class="s2">)</span>
    <span class="s1">refi_tri_mask </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">[</span><span class="s1">refi_tri_indices</span><span class="s2">]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">refi_mask</span><span class="s2">, </span><span class="s1">refi_tri_mask</span><span class="s2">)</span>

    <span class="s5"># Testing that the numbering of triangles does not change the</span>
    <span class="s5"># interpolation result.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
    <span class="s1">triang </span><span class="s2">= [</span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]),</span>
              <span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]])]</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.3</span><span class="s2">, </span><span class="s1">y </span><span class="s2">- </span><span class="s3">0.4</span><span class="s2">)</span>
    <span class="s5"># Refining the 2 triangulations and reordering the points</span>
    <span class="s1">xyz_data </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">):</span>
        <span class="s1">refiner </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">refined_triang</span><span class="s2">, </span><span class="s1">refined_z </span><span class="s2">= </span><span class="s1">refiner</span><span class="s2">.</span><span class="s1">refine_field</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">subdiv</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">xyz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">refined_triang</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">refined_triang</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">refined_z</span><span class="s2">))[</span><span class="s3">0</span><span class="s2">]</span>
        <span class="s1">xyz </span><span class="s2">= </span><span class="s1">xyz</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">lexsort</span><span class="s2">((</span><span class="s1">xyz</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">xyz</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">]))]</span>
        <span class="s1">xyz_data </span><span class="s2">+= [</span><span class="s1">xyz</span><span class="s2">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">xyz_data</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">xyz_data</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'interpolator'</span><span class="s2">,</span>
                         <span class="s2">[</span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">LinearTriInterpolator</span><span class="s2">,</span>
                          <span class="s1">mtri</span><span class="s2">.</span><span class="s1">CubicTriInterpolator</span><span class="s2">],</span>
                         <span class="s1">ids</span><span class="s2">=[</span><span class="s4">'linear'</span><span class="s2">, </span><span class="s4">'cubic'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_trirefine_masked</span><span class="s2">(</span><span class="s1">interpolator</span><span class="s2">):</span>
    <span class="s5"># Repeated points means we will have fewer triangles than points, and thus</span>
    <span class="s5"># get masking.</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mgrid</span><span class="s2">[:</span><span class="s3">2</span><span class="s2">, :</span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">(), </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">y</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">(), </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">tri </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">refiner </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">tri</span><span class="s2">)</span>
    <span class="s1">interp </span><span class="s2">= </span><span class="s1">interpolator</span><span class="s2">(</span><span class="s1">tri</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">refiner</span><span class="s2">.</span><span class="s1">refine_field</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">triinterpolator</span><span class="s2">=</span><span class="s1">interp</span><span class="s2">, </span><span class="s1">subdiv</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">meshgrid_triangles</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Return (2*(N-1)**2, 3) array of triangles to mesh (N, N)-point np.meshgrid. 
    &quot;&quot;&quot;</span>
    <span class="s1">tri </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">-</span><span class="s3">1</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">-</span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">i </span><span class="s2">+ </span><span class="s1">j</span><span class="s2">*</span><span class="s1">n</span>
            <span class="s1">b </span><span class="s2">= (</span><span class="s1">i</span><span class="s2">+</span><span class="s3">1</span><span class="s2">) + </span><span class="s1">j</span><span class="s2">*</span><span class="s1">n</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">i </span><span class="s2">+ (</span><span class="s1">j</span><span class="s2">+</span><span class="s3">1</span><span class="s2">)*</span><span class="s1">n</span>
            <span class="s1">d </span><span class="s2">= (</span><span class="s1">i</span><span class="s2">+</span><span class="s3">1</span><span class="s2">) + (</span><span class="s1">j</span><span class="s2">+</span><span class="s3">1</span><span class="s2">)*</span><span class="s1">n</span>
            <span class="s1">tri </span><span class="s2">+= [[</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">d</span><span class="s2">], [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">c</span><span class="s2">]]</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">tri</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_triplot_return</span><span class="s2">():</span>
    <span class="s5"># Check that triplot returns the artists it adds</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">().</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">], [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">],</span>
        <span class="s1">triangles</span><span class="s2">=[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">triplot</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s4">&quot;b-&quot;</span><span class="s2">) </span><span class="s0">is not None</span><span class="s2">, </span><span class="s1">\</span>
        <span class="s4">'triplot should return the artist it adds'</span>


<span class="s0">def </span><span class="s1">test_trirefiner_fortran_contiguous_triangles</span><span class="s2">():</span>
    <span class="s5"># github issue 4180.  Test requires two arrays of triangles that are</span>
    <span class="s5"># identical except that one is C-contiguous and one is fortran-contiguous.</span>
    <span class="s1">triangles1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]])</span>
    <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfortran</span><span class="s2">(</span><span class="s1">triangles1</span><span class="s2">)</span>

    <span class="s1">triangles2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">triangles1</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">order</span><span class="s2">=</span><span class="s4">'F'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfortran</span><span class="s2">(</span><span class="s1">triangles2</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.39</span><span class="s2">, </span><span class="s3">0.59</span><span class="s2">, </span><span class="s3">0.43</span><span class="s2">, </span><span class="s3">0.32</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">33.99</span><span class="s2">, </span><span class="s3">34.01</span><span class="s2">, </span><span class="s3">34.19</span><span class="s2">, </span><span class="s3">34.18</span><span class="s2">])</span>
    <span class="s1">triang1 </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles1</span><span class="s2">)</span>
    <span class="s1">triang2 </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles2</span><span class="s2">)</span>

    <span class="s1">refiner1 </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">triang1</span><span class="s2">)</span>
    <span class="s1">refiner2 </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">UniformTriRefiner</span><span class="s2">(</span><span class="s1">triang2</span><span class="s2">)</span>

    <span class="s1">fine_triang1 </span><span class="s2">= </span><span class="s1">refiner1</span><span class="s2">.</span><span class="s1">refine_triangulation</span><span class="s2">(</span><span class="s1">subdiv</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">fine_triang2 </span><span class="s2">= </span><span class="s1">refiner2</span><span class="s2">.</span><span class="s1">refine_triangulation</span><span class="s2">(</span><span class="s1">subdiv</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">fine_triang1</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">fine_triang2</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_qhull_triangle_orientation</span><span class="s2">():</span>
    <span class="s5"># github issue 4437.</span>
    <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">100</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">xi</span><span class="s2">))</span>
    <span class="s1">w </span><span class="s2">= (</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s1">y </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) &amp; (</span><span class="s1">x </span><span class="s2">&lt; -</span><span class="s3">1.95</span><span class="s2">) &amp; (</span><span class="s1">y </span><span class="s2">&gt; -</span><span class="s3">1.2</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">w</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">w</span><span class="s2">]</span>
    <span class="s1">theta </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">radians</span><span class="s2">(</span><span class="s3">25</span><span class="s2">)</span>
    <span class="s1">x1 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">) - </span><span class="s1">y</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)</span>
    <span class="s1">y1 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">) + </span><span class="s1">y</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">theta</span><span class="s2">)</span>

    <span class="s5"># Calculate Delaunay triangulation using Qhull.</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>

    <span class="s5"># Neighbors returned by Qhull.</span>
    <span class="s1">qhull_neighbors </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">neighbors</span>

    <span class="s5"># Obtain neighbors using own C++ calculation.</span>
    <span class="s1">triang</span><span class="s2">.</span><span class="s1">_neighbors </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">own_neighbors </span><span class="s2">= </span><span class="s1">triang</span><span class="s2">.</span><span class="s1">neighbors</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">qhull_neighbors</span><span class="s2">, </span><span class="s1">own_neighbors</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_trianalyzer_mismatched_indices</span><span class="s2">():</span>
    <span class="s5"># github issue 4999.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s3">3.</span><span class="s2">), -</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">])</span>
    <span class="s1">triangles </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">triangles</span><span class="s2">, </span><span class="s1">mask</span><span class="s2">=</span><span class="s1">mask</span><span class="s2">)</span>
    <span class="s1">analyser </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">TriAnalyzer</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>
    <span class="s5"># numpy &gt;= 1.10 raises a VisibleDeprecationWarning in the following line</span>
    <span class="s5"># prior to the fix.</span>
    <span class="s1">analyser</span><span class="s2">.</span><span class="s1">_get_compressed_triangulation</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_tricontourf_decreasing_levels</span><span class="s2">():</span>
    <span class="s5"># github issue 5477.</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">z </span><span class="s2">= [</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">]</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_internal_cpp_api</span><span class="s2">():</span>
    <span class="s5"># Following github issue 8197.</span>
    <span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_tri  </span><span class="s5"># noqa: ensure lazy-loaded module *is* loaded.</span>

    <span class="s5"># C++ Triangulation.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">TypeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'__init__\(\): incompatible constructor arguments.'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r'x and y must be 1D arrays of the same length'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">([], [</span><span class="s3">1</span><span class="s2">], [[]], (), (), (), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'triangles must be a 2D array of shape \(\?,3\)'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]], (), (), (), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">tris </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'mask must be a 1D array with the same length as the '</span>
                  <span class="s4">r'triangles array'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">tris</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], (), (), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r'edges must be a 2D array with shape \(\?,2\)'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">tris</span><span class="s2">, (), [[</span><span class="s3">1</span><span class="s2">]], (), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'neighbors must be a 2D array with the same shape as the '</span>
                  <span class="s4">r'triangles array'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">tris</span><span class="s2">, (), (), [[-</span><span class="s3">1</span><span class="s2">]], </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">tris</span><span class="s2">, (), (), (), </span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'z must be a 1D array with the same length as the '</span>
                  <span class="s4">r'triangulation x and y arrays'</span><span class="s2">):</span>
        <span class="s1">triang</span><span class="s2">.</span><span class="s1">calculate_plane_coefficients</span><span class="s2">([])</span>

    <span class="s0">for </span><span class="s1">mask </span><span class="s0">in </span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">ValueError</span><span class="s2">,</span>
                <span class="s1">match</span><span class="s2">=</span><span class="s4">r'mask must be a 1D array with the same length as the '</span>
                      <span class="s4">r'triangles array'</span><span class="s2">):</span>
            <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>

    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">([</span><span class="s0">True</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_edges</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)))</span>

    <span class="s1">triang</span><span class="s2">.</span><span class="s1">set_mask</span><span class="s2">(())  </span><span class="s5"># Equivalent to Python Triangulation mask=None</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">get_edges</span><span class="s2">(), [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]])</span>

    <span class="s5"># C++ TriContourGenerator.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">TypeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'__init__\(\): incompatible constructor arguments.'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">TriContourGenerator</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'z must be a 1D array with the same length as the x and y '</span>
                  <span class="s4">r'arrays'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">TriContourGenerator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s1">z </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">tcg </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">TriContourGenerator</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r'filled contour levels must be increasing'</span><span class="s2">):</span>
        <span class="s1">tcg</span><span class="s2">.</span><span class="s1">create_filled_contour</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s5"># C++ TrapezoidMapTriFinder.</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">TypeError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s4">r'__init__\(\): incompatible constructor arguments.'</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">TrapezoidMapTriFinder</span><span class="s2">()</span>

    <span class="s1">trifinder </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">_tri</span><span class="s2">.</span><span class="s1">TrapezoidMapTriFinder</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r'x and y must be array-like with same shape'</span><span class="s2">):</span>
        <span class="s1">trifinder</span><span class="s2">.</span><span class="s1">find_many</span><span class="s2">([</span><span class="s3">0</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_qhull_large_offset</span><span class="s2">():</span>
    <span class="s5"># github issue 8682.</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>

    <span class="s1">offset </span><span class="s2">= </span><span class="s3">1e10</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">triang_offset </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">y </span><span class="s2">+ </span><span class="s1">offset</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">triang_offset</span><span class="s2">.</span><span class="s1">triangles</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_tricontour_non_finite_z</span><span class="s2">():</span>
    <span class="s5"># github issue 10167.</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'z array must not contain non-finite '</span>
                                         <span class="s4">'values within the triangulation'</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'z array must not contain non-finite '</span>
                                         <span class="s4">'values within the triangulation'</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'z array must not contain non-finite '</span>
                                         <span class="s4">'values within the triangulation'</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">'z must not contain masked points '</span>
                                         <span class="s4">'within the triangulation'</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]))</span>


<span class="s0">def </span><span class="s1">test_tricontourset_reuse</span><span class="s2">():</span>
    <span class="s5"># If TriContourSet returned from one tricontour(f) call is passed as first</span>
    <span class="s5"># argument to another the underlying C++ contour generator will be reused.</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]</span>
    <span class="s1">z </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">tcs1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">tcs2 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontour</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tcs2</span><span class="s2">.</span><span class="s1">_contour_generator </span><span class="s2">!= </span><span class="s1">tcs1</span><span class="s2">.</span><span class="s1">_contour_generator</span>
    <span class="s1">tcs3 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontour</span><span class="s2">(</span><span class="s1">tcs1</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tcs3</span><span class="s2">.</span><span class="s1">_contour_generator </span><span class="s2">== </span><span class="s1">tcs1</span><span class="s2">.</span><span class="s1">_contour_generator</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_triplot_with_ls</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">data </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">().</span><span class="s1">triplot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">ls</span><span class="s2">=</span><span class="s4">'--'</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">().</span><span class="s1">triplot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s4">'--'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_triplot_label</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
    <span class="s1">data </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">lines</span><span class="s2">, </span><span class="s1">markers </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">triplot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">label</span><span class="s2">=</span><span class="s4">'label'</span><span class="s2">)</span>
    <span class="s1">handles</span><span class="s2">, </span><span class="s1">labels </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_legend_handles_labels</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">labels </span><span class="s2">== [</span><span class="s4">'label'</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">handles</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">handles</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] </span><span class="s0">is </span><span class="s1">lines</span>


<span class="s0">def </span><span class="s1">test_tricontour_path</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s5"># Line strip from boundary to boundary</span>
    <span class="s1">cs </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontour</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">levels</span><span class="s2">=[</span><span class="s3">0.5</span><span class="s2">])</span>
    <span class="s1">paths </span><span class="s2">= </span><span class="s1">cs</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s1">expected_vertices </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">expected_vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">codes</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
        <span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">to_polygons</span><span class="s2">(</span><span class="s1">closed_only</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), [</span><span class="s1">expected_vertices</span><span class="s2">])</span>

    <span class="s5"># Closed line loop inside domain</span>
    <span class="s1">cs </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontour</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">levels</span><span class="s2">=[</span><span class="s3">0.5</span><span class="s2">])</span>
    <span class="s1">paths </span><span class="s2">= </span><span class="s1">cs</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s1">expected_vertices </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">expected_vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">codes</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">79</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">to_polygons</span><span class="s2">(), [</span><span class="s1">expected_vertices</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_tricontourf_path</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
    <span class="s1">triang </span><span class="s2">= </span><span class="s1">mtri</span><span class="s2">.</span><span class="s1">Triangulation</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s5"># Polygon inside domain</span>
    <span class="s1">cs </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">levels</span><span class="s2">=[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">])</span>
    <span class="s1">paths </span><span class="s2">= </span><span class="s1">cs</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s1">expected_vertices </span><span class="s2">= [[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">expected_vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">codes</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">79</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">to_polygons</span><span class="s2">(), [</span><span class="s1">expected_vertices</span><span class="s2">])</span>

    <span class="s5"># Polygon following boundary and inside domain</span>
    <span class="s1">cs </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">levels</span><span class="s2">=[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">])</span>
    <span class="s1">paths </span><span class="s2">= </span><span class="s1">cs</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s1">expected_vertices </span><span class="s2">= [[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">expected_vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">codes</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">79</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">to_polygons</span><span class="s2">(), [</span><span class="s1">expected_vertices</span><span class="s2">])</span>

    <span class="s5"># Polygon is outer boundary with hole</span>
    <span class="s1">cs </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tricontourf</span><span class="s2">(</span><span class="s1">triang</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">levels</span><span class="s2">=[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
    <span class="s1">paths </span><span class="s2">= </span><span class="s1">cs</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s1">expected_vertices </span><span class="s2">= [[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
                         <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">vertices</span><span class="s2">, </span><span class="s1">expected_vertices</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">codes</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">79</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">79</span><span class="s2">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">paths</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">to_polygons</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">expected_vertices</span><span class="s2">, [</span><span class="s3">5</span><span class="s2">]))</span>
</pre>
</body>
</html>