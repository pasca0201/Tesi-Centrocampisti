<html>
<head>
<title>test_quadrature.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_quadrature.py</font>
</center></td></tr></table>
<pre><span class="s0"># mypy: disable-error-code=&quot;attr-defined&quot;</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy </span><span class="s2">import </span><span class="s1">cos</span><span class="s3">, </span><span class="s1">sin</span><span class="s3">, </span><span class="s1">pi</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_almost_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span><span class="s3">,</span>
                           <span class="s1">assert_</span><span class="s3">, </span><span class="s1">suppress_warnings</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">hypothesis </span><span class="s2">import </span><span class="s1">given</span>
<span class="s2">import </span><span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">strategies </span><span class="s2">as </span><span class="s1">st</span>
<span class="s2">import </span><span class="s1">hypothesis</span><span class="s3">.</span><span class="s1">extra</span><span class="s3">.</span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">hyp_num</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">integrate </span><span class="s2">import </span><span class="s3">(</span><span class="s1">quadrature</span><span class="s3">, </span><span class="s1">romberg</span><span class="s3">, </span><span class="s1">romb</span><span class="s3">, </span><span class="s1">newton_cotes</span><span class="s3">,</span>
                             <span class="s1">cumulative_trapezoid</span><span class="s3">, </span><span class="s1">trapezoid</span><span class="s3">,</span>
                             <span class="s1">quad</span><span class="s3">, </span><span class="s1">simpson</span><span class="s3">, </span><span class="s1">fixed_quad</span><span class="s3">, </span><span class="s1">AccuracyWarning</span><span class="s3">,</span>
                             <span class="s1">qmc_quad</span><span class="s3">, </span><span class="s1">cumulative_simpson</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">integrate</span><span class="s3">.</span><span class="s1">_quadrature </span><span class="s2">import </span><span class="s1">_cumulative_simpson_unequal_intervals</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">stats</span><span class="s3">, </span><span class="s1">special</span>


<span class="s2">class </span><span class="s1">TestFixedQuad</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_scalar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s4">4</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s4">1</span><span class="s3">/(</span><span class="s4">2</span><span class="s3">*</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">got</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">fixed_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">**(</span><span class="s4">2</span><span class="s3">*</span><span class="s1">n </span><span class="s3">- </span><span class="s4">1</span><span class="s3">), </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s0"># quadrature exact for this input</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">got</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-12</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_vector</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s4">4</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">*</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s4">1</span><span class="s3">/(</span><span class="s1">p </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">got</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">fixed_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">**</span><span class="s1">p</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">], </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">got</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-12</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s5">'ignore::DeprecationWarning'</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestQuadrature</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">quad</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s2">def </span><span class="s1">test_quadrature</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Typical function with two extra arguments:</span>
        <span class="s2">def </span><span class="s1">myfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):       </span><span class="s0"># Bessel function integrand</span>
            <span class="s2">return </span><span class="s1">cos</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*</span><span class="s1">x</span><span class="s3">-</span><span class="s1">z</span><span class="s3">*</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))/</span><span class="s1">pi</span>
        <span class="s1">val</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">quadrature</span><span class="s3">(</span><span class="s1">myfunc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">pi</span><span class="s3">, (</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1.8</span><span class="s3">))</span>
        <span class="s1">table_val </span><span class="s3">= </span><span class="s4">0.30614353532540296487</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">table_val</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_quadrature_rtol</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">myfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):       </span><span class="s0"># Bessel function integrand</span>
            <span class="s2">return </span><span class="s4">1e90 </span><span class="s3">* </span><span class="s1">cos</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*</span><span class="s1">x</span><span class="s3">-</span><span class="s1">z</span><span class="s3">*</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))/</span><span class="s1">pi</span>
        <span class="s1">val</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">quadrature</span><span class="s3">(</span><span class="s1">myfunc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">pi</span><span class="s3">, (</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1.8</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-10</span><span class="s3">)</span>
        <span class="s1">table_val </span><span class="s3">= </span><span class="s4">1e90 </span><span class="s3">* </span><span class="s4">0.30614353532540296487</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">table_val</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_quadrature_miniter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Typical function with two extra arguments:</span>
        <span class="s2">def </span><span class="s1">myfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):       </span><span class="s0"># Bessel function integrand</span>
            <span class="s2">return </span><span class="s1">cos</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*</span><span class="s1">x</span><span class="s3">-</span><span class="s1">z</span><span class="s3">*</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))/</span><span class="s1">pi</span>
        <span class="s1">table_val </span><span class="s3">= </span><span class="s4">0.30614353532540296487</span>
        <span class="s2">for </span><span class="s1">miniter </span><span class="s2">in </span><span class="s3">[</span><span class="s4">5</span><span class="s3">, </span><span class="s4">52</span><span class="s3">]:</span>
            <span class="s1">val</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">quadrature</span><span class="s3">(</span><span class="s1">myfunc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">pi</span><span class="s3">, (</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1.8</span><span class="s3">), </span><span class="s1">miniter</span><span class="s3">=</span><span class="s1">miniter</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">table_val</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">7</span><span class="s3">)</span>
            <span class="s1">assert_</span><span class="s3">(</span><span class="s1">err </span><span class="s3">&lt; </span><span class="s4">1.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_quadrature_single_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">myfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s4">1e90 </span><span class="s3">* </span><span class="s1">cos</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*</span><span class="s1">x</span><span class="s3">-</span><span class="s4">1.8</span><span class="s3">*</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))/</span><span class="s1">pi</span>
        <span class="s1">val</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">quadrature</span><span class="s3">(</span><span class="s1">myfunc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">pi</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-10</span><span class="s3">)</span>
        <span class="s1">table_val </span><span class="s3">= </span><span class="s4">1e90 </span><span class="s3">* </span><span class="s4">0.30614353532540296487</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">table_val</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_romberg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Typical function with two extra arguments:</span>
        <span class="s2">def </span><span class="s1">myfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):       </span><span class="s0"># Bessel function integrand</span>
            <span class="s2">return </span><span class="s1">cos</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*</span><span class="s1">x</span><span class="s3">-</span><span class="s1">z</span><span class="s3">*</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))/</span><span class="s1">pi</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">romberg</span><span class="s3">(</span><span class="s1">myfunc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">pi</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1.8</span><span class="s3">))</span>
        <span class="s1">table_val </span><span class="s3">= </span><span class="s4">0.30614353532540296487</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">table_val</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_romberg_rtol</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Typical function with two extra arguments:</span>
        <span class="s2">def </span><span class="s1">myfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">z</span><span class="s3">):       </span><span class="s0"># Bessel function integrand</span>
            <span class="s2">return </span><span class="s4">1e19</span><span class="s3">*</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">n</span><span class="s3">*</span><span class="s1">x</span><span class="s3">-</span><span class="s1">z</span><span class="s3">*</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))/</span><span class="s1">pi</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">romberg</span><span class="s3">(</span><span class="s1">myfunc</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">pi</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1.8</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-10</span><span class="s3">)</span>
        <span class="s1">table_val </span><span class="s3">= </span><span class="s4">1e19</span><span class="s3">*</span><span class="s4">0.30614353532540296487</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">table_val</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_romb</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">romb</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">17</span><span class="s3">)), </span><span class="s4">128</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_romb_gh_3731</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Check that romb makes maximal use of data points</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">2</span><span class="s3">**</span><span class="s4">4</span><span class="s3">+</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s4">0.2</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">romb</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">val2</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s4">0.2</span><span class="s3">*</span><span class="s1">x</span><span class="s3">), </span><span class="s1">x</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(), </span><span class="s1">x</span><span class="s3">.</span><span class="s1">max</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">val2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-8</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

        <span class="s0"># should be equal to romb with 2**k+1 samples</span>
        <span class="s2">with </span><span class="s1">suppress_warnings</span><span class="s3">() </span><span class="s2">as </span><span class="s1">sup</span><span class="s3">:</span>
            <span class="s1">sup</span><span class="s3">.</span><span class="s1">filter</span><span class="s3">(</span><span class="s1">AccuracyWarning</span><span class="s3">, </span><span class="s5">&quot;divmax .4. exceeded&quot;</span><span class="s3">)</span>
            <span class="s1">val3 </span><span class="s3">= </span><span class="s1">romberg</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s4">0.2</span><span class="s3">*</span><span class="s1">x</span><span class="s3">), </span><span class="s1">x</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(), </span><span class="s1">x</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(), </span><span class="s1">divmax</span><span class="s3">=</span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">val3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-12</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_non_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Check that we work fine with functions returning float</span>
        <span class="s2">import </span><span class="s1">math</span>
        <span class="s1">valmath </span><span class="s3">= </span><span class="s1">romberg</span><span class="s3">(</span><span class="s1">math</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">expected_val </span><span class="s3">= </span><span class="s4">0.45969769413185085</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">valmath</span><span class="s3">, </span><span class="s1">expected_val</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_newton_cotes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Test the first few degrees, for evenly spaced points.&quot;&quot;&quot;</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s4">1</span>
        <span class="s1">wts</span><span class="s3">, </span><span class="s1">errcoff </span><span class="s3">= </span><span class="s1">newton_cotes</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">wts</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">]))</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">errcoff</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">**</span><span class="s4">3</span><span class="s3">/</span><span class="s4">12.0</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s4">2</span>
        <span class="s1">wts</span><span class="s3">, </span><span class="s1">errcoff </span><span class="s3">= </span><span class="s1">newton_cotes</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">wts</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">4.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])/</span><span class="s4">6.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">errcoff</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">**</span><span class="s4">5</span><span class="s3">/</span><span class="s4">2880.0</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s4">3</span>
        <span class="s1">wts</span><span class="s3">, </span><span class="s1">errcoff </span><span class="s3">= </span><span class="s1">newton_cotes</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">wts</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])/</span><span class="s4">8.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">errcoff</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">**</span><span class="s4">5</span><span class="s3">/</span><span class="s4">6480.0</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s4">4</span>
        <span class="s1">wts</span><span class="s3">, </span><span class="s1">errcoff </span><span class="s3">= </span><span class="s1">newton_cotes</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">wts</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">7.0</span><span class="s3">, </span><span class="s4">32.0</span><span class="s3">, </span><span class="s4">12.0</span><span class="s3">, </span><span class="s4">32.0</span><span class="s3">, </span><span class="s4">7.0</span><span class="s3">])/</span><span class="s4">90.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">errcoff</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">**</span><span class="s4">7</span><span class="s3">/</span><span class="s4">1935360.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_newton_cotes2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Test newton_cotes with points that are not evenly spaced.&quot;&quot;&quot;</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.5</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">x</span><span class="s3">**</span><span class="s4">2</span>
        <span class="s1">wts</span><span class="s3">, </span><span class="s1">errcoff </span><span class="s3">= </span><span class="s1">newton_cotes</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">exact_integral </span><span class="s3">= </span><span class="s4">8.0</span><span class="s3">/</span><span class="s4">3</span>
        <span class="s1">numeric_integral </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">wts</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">numeric_integral</span><span class="s3">, </span><span class="s1">exact_integral</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.4</span><span class="s3">, </span><span class="s4">2.1</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">x</span><span class="s3">**</span><span class="s4">2</span>
        <span class="s1">wts</span><span class="s3">, </span><span class="s1">errcoff </span><span class="s3">= </span><span class="s1">newton_cotes</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">exact_integral </span><span class="s3">= </span><span class="s4">9.0</span>
        <span class="s1">numeric_integral </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">wts</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">numeric_integral</span><span class="s3">, </span><span class="s1">exact_integral</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_simpson</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">17</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s4">128</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">0.5</span><span class="s3">), </span><span class="s4">64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">17</span><span class="s3">)), </span><span class="s4">32</span><span class="s3">)</span>

        <span class="s0"># integral should be exactly 21</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">**</span><span class="s4">2</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">), </span><span class="s4">21.0</span><span class="s3">)</span>

        <span class="s0"># integral should be exactly 114</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">2.0</span><span class="s3">), </span><span class="s4">114</span><span class="s3">)</span>

        <span class="s0"># test multi-axis behaviour</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">16</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">64.</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">3</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">i</span><span class="s3">)</span>
            <span class="s1">it </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nditer</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">=[</span><span class="s5">'multi_index'</span><span class="s3">])</span>
            <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">it</span><span class="s3">:</span>
                <span class="s1">idx </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">it</span><span class="s3">.</span><span class="s1">multi_index</span><span class="s3">)</span>
                <span class="s1">idx</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s2">None</span><span class="s3">))</span>
                <span class="s1">integral </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)][-</span><span class="s4">1</span><span class="s3">]**</span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">3 </span><span class="s3">- </span><span class="s1">x</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)][</span><span class="s4">0</span><span class="s3">]**</span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">3</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">[</span><span class="s1">it</span><span class="s3">.</span><span class="s1">multi_index</span><span class="s3">], </span><span class="s1">integral</span><span class="s3">)</span>

        <span class="s0"># test when integration axis only has two points</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">16</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">8</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>

        <span class="s1">integral </span><span class="s3">= </span><span class="s4">0.5 </span><span class="s3">* (</span><span class="s1">y</span><span class="s3">[:, </span><span class="s4">1</span><span class="s3">] + </span><span class="s1">y</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">]) * (</span><span class="s1">x</span><span class="s3">[:, </span><span class="s4">1</span><span class="s3">] - </span><span class="s1">x</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">integral</span><span class="s3">)</span>

        <span class="s0"># odd points, test multi-axis behaviour</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">25</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">125</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">3</span><span class="s3">):</span>
            <span class="s1">r </span><span class="s3">= </span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">i</span><span class="s3">)</span>
            <span class="s1">it </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nditer</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">=[</span><span class="s5">'multi_index'</span><span class="s3">])</span>
            <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">it</span><span class="s3">:</span>
                <span class="s1">idx </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">it</span><span class="s3">.</span><span class="s1">multi_index</span><span class="s3">)</span>
                <span class="s1">idx</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s2">None</span><span class="s3">))</span>
                <span class="s1">integral </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)][-</span><span class="s4">1</span><span class="s3">]**</span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">3 </span><span class="s3">- </span><span class="s1">x</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">idx</span><span class="s3">)][</span><span class="s4">0</span><span class="s3">]**</span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">3</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">[</span><span class="s1">it</span><span class="s3">.</span><span class="s1">multi_index</span><span class="s3">], </span><span class="s1">integral</span><span class="s3">)</span>

        <span class="s0"># Tests for checking base case</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">3</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">]])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">zero_axis </span><span class="s3">= [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">]</span>
        <span class="s1">default_axis </span><span class="s3">= [</span><span class="s4">170 </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">/</span><span class="s4">3</span><span class="s3">] * </span><span class="s4">3   </span><span class="s0"># 8**3 / 3 - 1/3</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">zero_axis</span><span class="s3">)</span>
        <span class="s0"># the following should be exact</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">), </span><span class="s1">default_axis</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">16</span><span class="s3">, </span><span class="s4">32</span><span class="s3">]])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">power</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">zero_axis </span><span class="s3">= [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">136.0</span><span class="s3">, </span><span class="s4">1088.0</span><span class="s3">, </span><span class="s4">8704.0</span><span class="s3">]</span>
        <span class="s1">default_axis </span><span class="s3">= [</span><span class="s4">170 </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">/</span><span class="s4">3</span><span class="s3">, </span><span class="s4">170 </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">/</span><span class="s4">3</span><span class="s3">, </span><span class="s4">32</span><span class="s3">**</span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">3 </span><span class="s3">- </span><span class="s4">1</span><span class="s3">/</span><span class="s4">3</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">zero_axis</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">), </span><span class="s1">default_axis</span><span class="s3">)</span>


    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'droplast'</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_simpson_2d_integer_no_x</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">droplast</span><span class="s3">):</span>
        <span class="s0"># The inputs are 2d integer arrays.  The results should be</span>
        <span class="s0"># identical to the results when the inputs are floating point.</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, -</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, -</span><span class="s4">4</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">22</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">, </span><span class="s4">10</span><span class="s3">]])</span>
        <span class="s2">if </span><span class="s1">droplast</span><span class="s3">:</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">[:, :-</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'func'</span><span class="s3">, [</span><span class="s1">romberg</span><span class="s3">, </span><span class="s1">quadrature</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_deprecate_integrator</span><span class="s3">(</span><span class="s1">func</span><span class="s3">):</span>
    <span class="s1">message </span><span class="s3">= </span><span class="s5">f&quot;`scipy.integrate.</span><span class="s2">{</span><span class="s1">func</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s5">` is deprecated...&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">deprecated_call</span><span class="s3">(</span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
        <span class="s1">func</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestCumulative_trapezoid</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_1d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">x</span>
        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">y_expected </span><span class="s3">= [</span><span class="s4">0.</span><span class="s3">, -</span><span class="s4">1.5</span><span class="s3">, -</span><span class="s4">2.</span><span class="s3">, -</span><span class="s4">1.5</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:])</span>

    <span class="s2">def </span><span class="s1">test_y_nd_x_nd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">3 </span><span class="s3">* </span><span class="s4">2 </span><span class="s3">* </span><span class="s4">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">x</span>
        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">y_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">2.</span><span class="s3">, </span><span class="s4">4.5</span><span class="s3">],</span>
                                <span class="s3">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">4.5</span><span class="s3">, </span><span class="s4">10.</span><span class="s3">, </span><span class="s4">16.5</span><span class="s3">]],</span>
                               <span class="s3">[[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">8.5</span><span class="s3">, </span><span class="s4">18.</span><span class="s3">, </span><span class="s4">28.5</span><span class="s3">],</span>
                                <span class="s3">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">12.5</span><span class="s3">, </span><span class="s4">26.</span><span class="s3">, </span><span class="s4">40.5</span><span class="s3">]],</span>
                               <span class="s3">[[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">16.5</span><span class="s3">, </span><span class="s4">34.</span><span class="s3">, </span><span class="s4">52.5</span><span class="s3">],</span>
                                <span class="s3">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">20.5</span><span class="s3">, </span><span class="s4">42.</span><span class="s3">, </span><span class="s4">64.5</span><span class="s3">]]])</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

        <span class="s0"># Try with all axes</span>
        <span class="s1">shapes </span><span class="s3">= [(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)]</span>
        <span class="s2">for </span><span class="s1">axis</span><span class="s3">, </span><span class="s1">shape </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">], </span><span class="s1">shapes</span><span class="s3">):</span>
            <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">))</span>
            <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_y_nd_x_1d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">3 </span><span class="s3">* </span><span class="s4">2 </span><span class="s3">* </span><span class="s4">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">4</span><span class="s3">)**</span><span class="s4">2</span>
        <span class="s0"># Try with all axes</span>
        <span class="s1">ys_expected </span><span class="s3">= (</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s4">4.</span><span class="s3">, </span><span class="s4">5.</span><span class="s3">, </span><span class="s4">6.</span><span class="s3">, </span><span class="s4">7.</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s4">8.</span><span class="s3">, </span><span class="s4">9.</span><span class="s3">, </span><span class="s4">10.</span><span class="s3">, </span><span class="s4">11.</span><span class="s3">]],</span>
                      <span class="s3">[[</span><span class="s4">40.</span><span class="s3">, </span><span class="s4">44.</span><span class="s3">, </span><span class="s4">48.</span><span class="s3">, </span><span class="s4">52.</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s4">56.</span><span class="s3">, </span><span class="s4">60.</span><span class="s3">, </span><span class="s4">64.</span><span class="s3">, </span><span class="s4">68.</span><span class="s3">]]]),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s4">2.</span><span class="s3">, </span><span class="s4">3.</span><span class="s3">, </span><span class="s4">4.</span><span class="s3">, </span><span class="s4">5.</span><span class="s3">]],</span>
                      <span class="s3">[[</span><span class="s4">10.</span><span class="s3">, </span><span class="s4">11.</span><span class="s3">, </span><span class="s4">12.</span><span class="s3">, </span><span class="s4">13.</span><span class="s3">]],</span>
                      <span class="s3">[[</span><span class="s4">18.</span><span class="s3">, </span><span class="s4">19.</span><span class="s3">, </span><span class="s4">20.</span><span class="s3">, </span><span class="s4">21.</span><span class="s3">]]]),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[[</span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">5.</span><span class="s3">, </span><span class="s4">17.5</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s4">4.5</span><span class="s3">, </span><span class="s4">21.</span><span class="s3">, </span><span class="s4">53.5</span><span class="s3">]],</span>
                      <span class="s3">[[</span><span class="s4">8.5</span><span class="s3">, </span><span class="s4">37.</span><span class="s3">, </span><span class="s4">89.5</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s4">12.5</span><span class="s3">, </span><span class="s4">53.</span><span class="s3">, </span><span class="s4">125.5</span><span class="s3">]],</span>
                      <span class="s3">[[</span><span class="s4">16.5</span><span class="s3">, </span><span class="s4">69.</span><span class="s3">, </span><span class="s4">161.5</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s4">20.5</span><span class="s3">, </span><span class="s4">85.</span><span class="s3">, </span><span class="s4">197.5</span><span class="s3">]]]))</span>

        <span class="s2">for </span><span class="s1">axis</span><span class="s3">, </span><span class="s1">y_expected </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">], </span><span class="s1">ys_expected</span><span class="s3">):</span>
            <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">[:</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">,</span>
                                         <span class="s1">initial</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_x_none</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>

        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">y_expected </span><span class="s3">= [-</span><span class="s4">1.5</span><span class="s3">, -</span><span class="s4">2.</span><span class="s3">, -</span><span class="s4">1.5</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">y_expected </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">, -</span><span class="s4">1.5</span><span class="s3">, -</span><span class="s4">2.</span><span class="s3">, -</span><span class="s4">1.5</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>
        <span class="s1">y_expected </span><span class="s3">= [-</span><span class="s4">4.5</span><span class="s3">, -</span><span class="s4">6.</span><span class="s3">, -</span><span class="s4">4.5</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

        <span class="s1">y_int </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">y_expected </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">, -</span><span class="s4">4.5</span><span class="s3">, -</span><span class="s4">6.</span><span class="s3">, -</span><span class="s4">4.5</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_int</span><span class="s3">, </span><span class="s1">y_expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s5">&quot;initial&quot;</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_initial_warning</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;If initial is not None or 0, a ValueError is raised.&quot;&quot;&quot;</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">deprecated_call</span><span class="s3">(</span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;`initial`&quot;</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s1">initial</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, [</span><span class="s1">initial</span><span class="s3">, *</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cumsum</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:] + </span><span class="s1">y</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">])/</span><span class="s4">2</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_zero_len_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;At least one point is required&quot;</span><span class="s3">):</span>
            <span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">=[])</span>


<span class="s2">class </span><span class="s1">TestTrapezoid</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_simple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">.1</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s4">.5 </span><span class="s3">* </span><span class="s1">x </span><span class="s3">** </span><span class="s4">2</span><span class="s3">) / </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">), </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">0.1</span><span class="s3">)</span>
        <span class="s0"># check integral of normal equals 1</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_ndim</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">8</span><span class="s3">)</span>
        <span class="s1">z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">13</span><span class="s3">)</span>

        <span class="s1">wx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) * (</span><span class="s1">x</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">x</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">wx</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] /= </span><span class="s4">2</span>
        <span class="s1">wx</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">] /= </span><span class="s4">2</span>
        <span class="s1">wy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">) * (</span><span class="s1">y</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">y</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">wy</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] /= </span><span class="s4">2</span>
        <span class="s1">wy</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">] /= </span><span class="s4">2</span>
        <span class="s1">wz </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">z</span><span class="s3">) * (</span><span class="s1">z</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">z</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">wz</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] /= </span><span class="s4">2</span>
        <span class="s1">wz</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">] /= </span><span class="s4">2</span>

        <span class="s1">q </span><span class="s3">= </span><span class="s1">x</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">] + </span><span class="s1">y</span><span class="s3">[</span><span class="s2">None</span><span class="s3">,:, </span><span class="s2">None</span><span class="s3">] + </span><span class="s1">z</span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">,:]</span>

        <span class="s1">qx </span><span class="s3">= (</span><span class="s1">q </span><span class="s3">* </span><span class="s1">wx</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">qy </span><span class="s3">= (</span><span class="s1">q </span><span class="s3">* </span><span class="s1">wy</span><span class="s3">[</span><span class="s2">None</span><span class="s3">, :, </span><span class="s2">None</span><span class="s3">]).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">qz </span><span class="s3">= (</span><span class="s1">q </span><span class="s3">* </span><span class="s1">wz</span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, :]).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

        <span class="s0"># n-d `x`</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">qx</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">y</span><span class="s3">[</span><span class="s2">None</span><span class="s3">,:, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">qy</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">z</span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">,:], </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">qz</span><span class="s3">)</span>

        <span class="s0"># 1-d `x`</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">qx</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">y</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">qy</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">q</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">z</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">qz</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_masked</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Testing that masked arrays behave as if the function is 0 where</span>
        <span class="s0"># masked</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">5</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">x </span><span class="s3">* </span><span class="s1">x</span>
        <span class="s1">mask </span><span class="s3">= </span><span class="s1">x </span><span class="s3">== </span><span class="s4">2</span>
        <span class="s1">ym </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">=</span><span class="s1">mask</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s4">13.0  </span><span class="s0"># sum(0.5 * (0 + 1) * 1.0 + 0.5 * (9 + 16))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">ym</span><span class="s3">, </span><span class="s1">x</span><span class="s3">), </span><span class="s1">r</span><span class="s3">)</span>

        <span class="s1">xm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">=</span><span class="s1">mask</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">ym</span><span class="s3">, </span><span class="s1">xm</span><span class="s3">), </span><span class="s1">r</span><span class="s3">)</span>

        <span class="s1">xm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">=</span><span class="s1">mask</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">xm</span><span class="s3">), </span><span class="s1">r</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestQMCQuad</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;`func` must be callable.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s5">&quot;a duck&quot;</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;`func` must evaluate the integrand at points...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">x</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s4">1</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;Exception encountered when attempting vectorized call...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;`n_points` must be an integer.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">n_points</span><span class="s3">=</span><span class="s4">1024.5</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;`n_estimates` must be an integer.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">n_estimates</span><span class="s3">=</span><span class="s4">8.5</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;`qrng` must be an instance of scipy.stats.qmc.QMCEngine.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">qrng</span><span class="s3">=</span><span class="s5">&quot;a duck&quot;</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;`qrng` must be initialized with dimensionality equal to &quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">qrng</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">qmc</span><span class="s3">.</span><span class="s1">Sobol</span><span class="s3">(</span><span class="s4">1</span><span class="s3">))</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">r&quot;`log` must be boolean \(`True` or `False`\).&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">log</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">basic_test</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n_points</span><span class="s3">=</span><span class="s4">2</span><span class="s3">**</span><span class="s4">8</span><span class="s3">, </span><span class="s1">n_estimates</span><span class="s3">=</span><span class="s4">8</span><span class="s3">, </span><span class="s1">signs</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)):</span>

        <span class="s1">ndim </span><span class="s3">= </span><span class="s4">2</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">ndim</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">ndim</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">2879434385674690281</span><span class="s3">)</span>
        <span class="s1">qrng </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">qmc</span><span class="s3">.</span><span class="s1">Sobol</span><span class="s3">(</span><span class="s1">ndim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">ndim</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">ndim</span><span class="s3">) * </span><span class="s1">signs</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">qmc_quad</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">n_points</span><span class="s3">=</span><span class="s1">n_points</span><span class="s3">,</span>
                       <span class="s1">n_estimates</span><span class="s3">=</span><span class="s1">n_estimates</span><span class="s3">, </span><span class="s1">qrng</span><span class="s3">=</span><span class="s1">qrng</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">atol </span><span class="s3">= </span><span class="s1">special</span><span class="s3">.</span><span class="s1">stdtrit</span><span class="s3">(</span><span class="s1">n_estimates</span><span class="s3">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0.995</span><span class="s3">) * </span><span class="s1">res</span><span class="s3">.</span><span class="s1">standard_error  </span><span class="s0"># 99% CI</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">prod</span><span class="s3">(</span><span class="s1">signs</span><span class="s3">)*</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">&gt; </span><span class="s4">0</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">2879434385674690281</span><span class="s3">)</span>
        <span class="s1">qrng </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">qmc</span><span class="s3">.</span><span class="s1">Sobol</span><span class="s3">(</span><span class="s1">ndim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">logres </span><span class="s3">= </span><span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s3">*</span><span class="s1">args</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)), </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">,</span>
                          <span class="s1">n_points</span><span class="s3">=</span><span class="s1">n_points</span><span class="s3">, </span><span class="s1">n_estimates</span><span class="s3">=</span><span class="s1">n_estimates</span><span class="s3">,</span>
                          <span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">qrng</span><span class="s3">=</span><span class="s1">qrng</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-14</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">) == (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">prod</span><span class="s3">(</span><span class="s1">signs</span><span class="s3">) &lt; </span><span class="s4">0 </span><span class="s2">else </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">standard_error</span><span class="s3">),</span>
                        <span class="s1">res</span><span class="s3">.</span><span class="s1">standard_error</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-14</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-16</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;n_points&quot;</span><span class="s3">, [</span><span class="s4">2</span><span class="s3">**</span><span class="s4">8</span><span class="s3">, </span><span class="s4">2</span><span class="s3">**</span><span class="s4">12</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;n_estimates&quot;</span><span class="s3">, [</span><span class="s4">8</span><span class="s3">, </span><span class="s4">16</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n_points</span><span class="s3">, </span><span class="s1">n_estimates</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basic_test</span><span class="s3">(</span><span class="s1">n_points</span><span class="s3">, </span><span class="s1">n_estimates</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;signs&quot;</span><span class="s3">, [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">], [-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]])</span>
    <span class="s2">def </span><span class="s1">test_sign</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">signs</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basic_test</span><span class="s3">(</span><span class="s1">signs</span><span class="s3">=</span><span class="s1">signs</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;log&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_zero</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">log</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s5">&quot;A lower limit was equal to an upper limit, so&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">qmc_quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], </span><span class="s1">log</span><span class="s3">=</span><span class="s1">log</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">== (-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf </span><span class="s2">if </span><span class="s1">log </span><span class="s2">else </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">standard_error </span><span class="s3">== </span><span class="s4">0</span>

    <span class="s2">def </span><span class="s1">test_flexible_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># check that qrng is not required</span>
        <span class="s0"># also checks that for 1d problems, a and b can be scalars</span>
        <span class="s2">def </span><span class="s1">func</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">qmc_quad</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s4">2</span><span class="s3">) - </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s4">1e-2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">cumulative_simpson_nd_reference</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, *, </span><span class="s1">x</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">):</span>
    <span class="s0"># Use cumulative_trapezoid if length of y &lt; 3</span>
    <span class="s2">if </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">] &lt; </span><span class="s4">3</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">initial </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">initial </span><span class="s3">+ </span><span class="s1">cumulative_trapezoid</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s0"># Ensure that working axis is last axis</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">moveaxis</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">moveaxis</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">) </span><span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) &gt; </span><span class="s4">1 </span><span class="s2">else </span><span class="s1">x</span>
    <span class="s1">dx </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">moveaxis</span><span class="s3">(</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">) </span><span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">(</span><span class="s1">dx</span><span class="s3">) &gt; </span><span class="s4">1 </span><span class="s2">else </span><span class="s1">dx</span>
    <span class="s1">initial </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">moveaxis</span><span class="s3">(</span><span class="s1">initial</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">) </span><span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">(</span><span class="s1">initial</span><span class="s3">) &gt; </span><span class="s4">1 </span><span class="s2">else </span><span class="s1">initial</span>

    <span class="s0"># If `x` is not present, create it from `dx`</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">dx </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) </span><span class="s2">if </span><span class="s1">dx </span><span class="s2">is not None else </span><span class="s1">x</span>
    <span class="s0"># Similarly, if `initial` is not present, set it to 0</span>
    <span class="s1">initial_was_none </span><span class="s3">= </span><span class="s1">initial </span><span class="s2">is None</span>
    <span class="s1">initial </span><span class="s3">= </span><span class="s4">0 </span><span class="s2">if </span><span class="s1">initial_was_none </span><span class="s2">else </span><span class="s1">initial</span>

    <span class="s0"># `np.apply_along_axis` accepts only one array, so concatenate arguments</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_to</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
    <span class="s1">initial </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_to</span><span class="s3">(</span><span class="s1">initial</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">] + (</span><span class="s4">1</span><span class="s3">,))</span>
    <span class="s1">z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">((</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>

    <span class="s0"># Use `np.apply_along_axis` to compute result</span>
    <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">z</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">cumulative_simpson</span><span class="s3">(</span><span class="s1">z</span><span class="s3">[:</span><span class="s1">n</span><span class="s3">], </span><span class="s1">x</span><span class="s3">=</span><span class="s1">z</span><span class="s3">[</span><span class="s1">n</span><span class="s3">:</span><span class="s4">2</span><span class="s3">*</span><span class="s1">n</span><span class="s3">], </span><span class="s1">initial</span><span class="s3">=</span><span class="s1">z</span><span class="s3">[</span><span class="s4">2</span><span class="s3">*</span><span class="s1">n</span><span class="s3">:])</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">apply_along_axis</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s1">z</span><span class="s3">)</span>

    <span class="s0"># Remove `initial` and undo axis move as needed</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:] </span><span class="s2">if </span><span class="s1">initial_was_none </span><span class="s2">else </span><span class="s1">res</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">moveaxis</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">res</span>


<span class="s2">class </span><span class="s1">TestCumulativeSimpson</span><span class="s3">:</span>
    <span class="s1">x0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">4</span><span class="s3">)</span>
    <span class="s1">y0 </span><span class="s3">= </span><span class="s1">x0</span><span class="s3">**</span><span class="s4">2</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'use_dx'</span><span class="s3">, (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'use_initial'</span><span class="s3">, (</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_1d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">use_dx</span><span class="s3">, </span><span class="s1">use_initial</span><span class="s3">):</span>
        <span class="s0"># Test for exact agreement with polynomial of highest</span>
        <span class="s0"># possible order (3 if `dx` is constant, 2 otherwise).</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">82456839535679456794</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s4">10</span>

        <span class="s0"># Generate random polynomials and ground truth</span>
        <span class="s0"># integral of appropriate order</span>
        <span class="s1">order </span><span class="s3">= </span><span class="s4">3 </span><span class="s2">if </span><span class="s1">use_dx </span><span class="s2">else </span><span class="s4">2</span>
        <span class="s1">dx </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">()</span>
        <span class="s1">x </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)) </span><span class="s2">if </span><span class="s1">order </span><span class="s3">== </span><span class="s4">2</span>
             <span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)*</span><span class="s1">dx </span><span class="s3">+ </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">())</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">order </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">order </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">c</span><span class="s3">*</span><span class="s1">x</span><span class="s3">**</span><span class="s1">i</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">c</span><span class="s3">*</span><span class="s1">x</span><span class="s3">**(</span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)/(</span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">Y </span><span class="s2">if </span><span class="s1">use_initial </span><span class="s2">else </span><span class="s3">(</span><span class="s1">Y</span><span class="s3">-</span><span class="s1">Y</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])[</span><span class="s4">1</span><span class="s3">:]</span>

        <span class="s0"># Integrate with `cumulative_simpson`</span>
        <span class="s1">initial </span><span class="s3">= </span><span class="s1">Y</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] </span><span class="s2">if </span><span class="s1">use_initial </span><span class="s2">else None</span>
        <span class="s1">kwarg </span><span class="s3">= {</span><span class="s5">'dx'</span><span class="s3">: </span><span class="s1">dx</span><span class="s3">} </span><span class="s2">if </span><span class="s1">use_dx </span><span class="s2">else </span><span class="s3">{</span><span class="s5">'x'</span><span class="s3">: </span><span class="s1">x</span><span class="s3">}</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">cumulative_simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, **</span><span class="s1">kwarg</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s1">initial</span><span class="s3">)</span>

        <span class="s0"># Compare result against reference</span>
        <span class="s2">if not </span><span class="s1">use_dx</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">2e-15</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">i0 </span><span class="s3">= </span><span class="s4">0 </span><span class="s2">if </span><span class="s1">use_initial </span><span class="s2">else </span><span class="s4">1</span>
            <span class="s0"># all terms are &quot;close&quot;</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">0.0025</span><span class="s3">)</span>
            <span class="s0"># only even-interval terms are &quot;exact&quot;</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">[</span><span class="s1">i0</span><span class="s3">::</span><span class="s4">2</span><span class="s3">], </span><span class="s1">ref</span><span class="s3">[</span><span class="s1">i0</span><span class="s3">::</span><span class="s4">2</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">2e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'axis'</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(-</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'x_ndim'</span><span class="s3">, (</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'x_len'</span><span class="s3">, (</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">7</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'i_ndim'</span><span class="s3">, (</span><span class="s2">None</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">,))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'dx'</span><span class="s3">, (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_nd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, </span><span class="s1">x_ndim</span><span class="s3">, </span><span class="s1">x_len</span><span class="s3">, </span><span class="s1">i_ndim</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">):</span>
        <span class="s0"># Test behavior of `cumulative_simpson` with N-D `y`</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">82456839535679456794</span><span class="s3">)</span>

        <span class="s0"># determine shapes</span>
        <span class="s1">shape </span><span class="s3">= [</span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s1">x_len</span><span class="s3">]</span>
        <span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">] = </span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">]</span>
        <span class="s1">shape_len_1 </span><span class="s3">= </span><span class="s1">shape</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">shape_len_1</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">] = </span><span class="s4">1</span>
        <span class="s1">i_shape </span><span class="s3">= </span><span class="s1">shape_len_1 </span><span class="s2">if </span><span class="s1">i_ndim </span><span class="s3">== </span><span class="s4">3 </span><span class="s2">else </span><span class="s3">()</span>

        <span class="s0"># initialize arguments</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">dx </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">dx</span><span class="s3">:</span>
            <span class="s1">dx </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">shape_len_1</span><span class="s3">) </span><span class="s2">if </span><span class="s1">x_ndim </span><span class="s3">&gt; </span><span class="s4">1 </span><span class="s2">else </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">) </span><span class="s2">if </span><span class="s1">x_ndim </span><span class="s3">&gt; </span><span class="s4">1</span>
                 <span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">])))</span>
        <span class="s1">initial </span><span class="s3">= </span><span class="s2">None if </span><span class="s1">i_ndim </span><span class="s2">is None else </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">i_shape</span><span class="s3">)</span>

        <span class="s0"># compare results</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">cumulative_simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s1">initial</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">cumulative_simpson_nd_reference</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s1">initial</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">((</span><span class="s5">'message'</span><span class="s3">, </span><span class="s5">'kwarg_update'</span><span class="s3">), [</span>
        <span class="s3">(</span><span class="s5">&quot;x must be strictly increasing&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">])),</span>
        <span class="s3">(</span><span class="s5">&quot;x must be strictly increasing&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=[</span><span class="s1">x0</span><span class="s3">, [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">]], </span><span class="s1">y</span><span class="s3">=[</span><span class="s1">y0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">])),</span>
        <span class="s3">(</span><span class="s5">&quot;x must be strictly increasing&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=[</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">], </span><span class="s1">y</span><span class="s3">=[</span><span class="s1">y0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">, </span><span class="s1">y0</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)),</span>
        <span class="s3">(</span><span class="s5">&quot;At least one point is required&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=[], </span><span class="s1">y</span><span class="s3">=[])),</span>
        <span class="s3">(</span><span class="s5">&quot;`axis=4` is not valid for `y` with `y.ndim=1`&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">4</span><span class="s3">)),</span>
        <span class="s3">(</span><span class="s5">&quot;shape of `x` must be the same as `y` or 1-D&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">5</span><span class="s3">))),</span>
        <span class="s3">(</span><span class="s5">&quot;`initial` must either be a scalar or...&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">initial</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">5</span><span class="s3">))),</span>
        <span class="s3">(</span><span class="s5">&quot;`dx` must either be a scalar or...&quot;</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">5</span><span class="s3">))),</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_simpson_exceptions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">, </span><span class="s1">kwarg_update</span><span class="s3">):</span>
        <span class="s1">kwargs0 </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">y</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">y0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">cumulative_simpson</span><span class="s3">(**</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">kwargs0</span><span class="s3">, **</span><span class="s1">kwarg_update</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_special_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test special cases not checked elsewhere</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">82456839535679456794</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">cumulative_simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>

        <span class="s0"># Should add tests of:</span>
        <span class="s0"># - all elements of `x` identical</span>
        <span class="s0"># These should work as they do for `simpson`</span>

    <span class="s2">def </span><span class="s1">_get_theoretical_diff_between_simps_and_cum_simps</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;`cumulative_simpson` and `simpson` can be tested against other to verify 
        they give consistent results. `simpson` will iteratively be called with 
        successively higher upper limits of integration. This function calculates 
        the theoretical correction required to `simpson` at even intervals to match 
        with `cumulative_simpson`. 
        &quot;&quot;&quot;</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diff</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">sub_integrals_h1 </span><span class="s3">= </span><span class="s1">_cumulative_simpson_unequal_intervals</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">d</span><span class="s3">)</span>
        <span class="s1">sub_integrals_h2 </span><span class="s3">= </span><span class="s1">_cumulative_simpson_unequal_intervals</span><span class="s3">(</span>
            <span class="s1">y</span><span class="s3">[..., ::-</span><span class="s4">1</span><span class="s3">], </span><span class="s1">d</span><span class="s3">[..., ::-</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s3">)[..., ::-</span><span class="s4">1</span><span class="s3">]</span>

        <span class="s0"># Concatenate to build difference array</span>
        <span class="s1">zeros_shape </span><span class="s3">= (*</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">], </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">theoretical_difference </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">zeros_shape</span><span class="s3">),</span>
                <span class="s3">(</span><span class="s1">sub_integrals_h1</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:] - </span><span class="s1">sub_integrals_h2</span><span class="s3">[..., :-</span><span class="s4">1</span><span class="s3">]),</span>
                <span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">zeros_shape</span><span class="s3">),</span>
            <span class="s3">],</span>
            <span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s0"># Differences only expected at even intervals. Odd intervals will</span>
        <span class="s0"># match exactly so there is no correction</span>
        <span class="s1">theoretical_difference</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">::</span><span class="s4">2</span><span class="s3">] = </span><span class="s4">0.0</span>
        <span class="s0"># Note: the first interval will not match from this correction as</span>
        <span class="s0"># `simpson` uses the trapezoidal rule</span>
        <span class="s2">return </span><span class="s1">theoretical_difference</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s3">@</span><span class="s1">given</span><span class="s3">(</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s1">hyp_num</span><span class="s3">.</span><span class="s1">arrays</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">,</span>
            <span class="s1">hyp_num</span><span class="s3">.</span><span class="s1">array_shapes</span><span class="s3">(</span><span class="s1">max_dims</span><span class="s3">=</span><span class="s4">4</span><span class="s3">, </span><span class="s1">min_side</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">max_side</span><span class="s3">=</span><span class="s4">10</span><span class="s3">),</span>
            <span class="s1">elements</span><span class="s3">=</span><span class="s1">st</span><span class="s3">.</span><span class="s1">floats</span><span class="s3">(-</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">allow_nan</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">filter</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) &gt; </span><span class="s4">1e-7</span><span class="s3">)</span>
        <span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_cumulative_simpson_against_simpson_with_default_dx</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">y</span>
    <span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Theoretically, the output of `cumulative_simpson` will be identical 
        to `simpson` at all even indices and in the last index. The first index 
        will not match as `simpson` uses the trapezoidal rule when there are only two 
        data points. Odd indices after the first index are shown to match with 
        a mathematically-derived correction.&quot;&quot;&quot;</span>
        <span class="s2">def </span><span class="s1">simpson_reference</span><span class="s3">(</span><span class="s1">y</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[..., :</span><span class="s1">i</span><span class="s3">], </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">1.0</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]+</span><span class="s4">1</span><span class="s3">)], </span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">cumulative_simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">=</span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">simpson_reference</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">theoretical_difference </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_theoretical_diff_between_simps_and_cum_simps</span><span class="s3">(</span>
            <span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">])</span>
        <span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_allclose</span><span class="s3">(</span>
            <span class="s1">res</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:], </span><span class="s1">ref</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:] + </span><span class="s1">theoretical_difference</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:]</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s3">@</span><span class="s1">given</span><span class="s3">(</span>
        <span class="s1">y</span><span class="s3">=</span><span class="s1">hyp_num</span><span class="s3">.</span><span class="s1">arrays</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">,</span>
            <span class="s1">hyp_num</span><span class="s3">.</span><span class="s1">array_shapes</span><span class="s3">(</span><span class="s1">max_dims</span><span class="s3">=</span><span class="s4">4</span><span class="s3">, </span><span class="s1">min_side</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">max_side</span><span class="s3">=</span><span class="s4">10</span><span class="s3">),</span>
            <span class="s1">elements</span><span class="s3">=</span><span class="s1">st</span><span class="s3">.</span><span class="s1">floats</span><span class="s3">(-</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">allow_nan</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">filter</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) &gt; </span><span class="s4">1e-7</span><span class="s3">)</span>
        <span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_cumulative_simpson_against_simpson</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">y</span>
    <span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Theoretically, the output of `cumulative_simpson` will be identical 
        to `simpson` at all even indices and in the last index. The first index 
        will not match as `simpson` uses the trapezoidal rule when there are only two 
        data points. Odd indices after the first index are shown to match with 
        a mathematically-derived correction.&quot;&quot;&quot;</span>
        <span class="s1">interval </span><span class="s3">= </span><span class="s4">10</span><span class="s3">/(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">] - </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">])</span>
        <span class="s1">x</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:] = </span><span class="s1">x</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:] + </span><span class="s4">0.2</span><span class="s3">*</span><span class="s1">interval</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) - </span><span class="s4">1</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">simpson_reference</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[..., :</span><span class="s1">i</span><span class="s3">], </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">[..., :</span><span class="s1">i</span><span class="s3">]) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]+</span><span class="s4">1</span><span class="s3">)],</span>
                <span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">cumulative_simpson</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">=</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">simpson_reference</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">theoretical_difference </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_theoretical_diff_between_simps_and_cum_simps</span><span class="s3">(</span>
            <span class="s1">y</span><span class="s3">, </span><span class="s1">x</span>
        <span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_allclose</span><span class="s3">(</span>
            <span class="s1">res</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:], </span><span class="s1">ref</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:] + </span><span class="s1">theoretical_difference</span><span class="s3">[..., </span><span class="s4">1</span><span class="s3">:]</span>
        <span class="s3">)</span>
</pre>
</body>
</html>