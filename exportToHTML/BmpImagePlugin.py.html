<html>
<head>
<title>BmpImagePlugin.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
BmpImagePlugin.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># The Python Imaging Library.</span>
<span class="s0"># $Id$</span>
<span class="s0">#</span>
<span class="s0"># BMP file handler</span>
<span class="s0">#</span>
<span class="s0"># Windows (and OS/2) native bitmap storage format.</span>
<span class="s0">#</span>
<span class="s0"># history:</span>
<span class="s0"># 1995-09-01 fl   Created</span>
<span class="s0"># 1996-04-30 fl   Added save</span>
<span class="s0"># 1997-08-27 fl   Fixed save of 1-bit images</span>
<span class="s0"># 1998-03-06 fl   Load P images as L where possible</span>
<span class="s0"># 1998-07-03 fl   Load P images as 1 where possible</span>
<span class="s0"># 1998-12-29 fl   Handle small palettes</span>
<span class="s0"># 2002-12-30 fl   Fixed load of 1-bit palette images</span>
<span class="s0"># 2003-04-21 fl   Fixed load of 1-bit monochrome images</span>
<span class="s0"># 2003-04-23 fl   Added limited support for BI_BITFIELDS compression</span>
<span class="s0">#</span>
<span class="s0"># Copyright (c) 1997-2003 by Secret Labs AB</span>
<span class="s0"># Copyright (c) 1995-2003 by Fredrik Lundh</span>
<span class="s0">#</span>
<span class="s0"># See the README file for information on usage and redistribution.</span>
<span class="s0">#</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">IO</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">Image</span><span class="s3">, </span><span class="s1">ImageFile</span><span class="s3">, </span><span class="s1">ImagePalette</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">i16le </span><span class="s2">as </span><span class="s1">i16</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">i32le </span><span class="s2">as </span><span class="s1">i32</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">o8</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">o16le </span><span class="s2">as </span><span class="s1">o16</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">o32le </span><span class="s2">as </span><span class="s1">o32</span>

<span class="s0">#</span>
<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Read BMP file</span>

<span class="s1">BIT2MODE </span><span class="s3">= {</span>
    <span class="s0"># bits =&gt; mode, rawmode</span>
    <span class="s4">1</span><span class="s3">: (</span><span class="s5">&quot;P&quot;</span><span class="s3">, </span><span class="s5">&quot;P;1&quot;</span><span class="s3">),</span>
    <span class="s4">4</span><span class="s3">: (</span><span class="s5">&quot;P&quot;</span><span class="s3">, </span><span class="s5">&quot;P;4&quot;</span><span class="s3">),</span>
    <span class="s4">8</span><span class="s3">: (</span><span class="s5">&quot;P&quot;</span><span class="s3">, </span><span class="s5">&quot;P&quot;</span><span class="s3">),</span>
    <span class="s4">16</span><span class="s3">: (</span><span class="s5">&quot;RGB&quot;</span><span class="s3">, </span><span class="s5">&quot;BGR;15&quot;</span><span class="s3">),</span>
    <span class="s4">24</span><span class="s3">: (</span><span class="s5">&quot;RGB&quot;</span><span class="s3">, </span><span class="s5">&quot;BGR&quot;</span><span class="s3">),</span>
    <span class="s4">32</span><span class="s3">: (</span><span class="s5">&quot;RGB&quot;</span><span class="s3">, </span><span class="s5">&quot;BGRX&quot;</span><span class="s3">),</span>
<span class="s3">}</span>


<span class="s2">def </span><span class="s1">_accept</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">prefix</span><span class="s3">[:</span><span class="s4">2</span><span class="s3">] == </span><span class="s6">b&quot;BM&quot;</span>


<span class="s2">def </span><span class="s1">_dib_accept</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">) </span><span class="s2">in </span><span class="s3">[</span><span class="s4">12</span><span class="s3">, </span><span class="s4">40</span><span class="s3">, </span><span class="s4">52</span><span class="s3">, </span><span class="s4">56</span><span class="s3">, </span><span class="s4">64</span><span class="s3">, </span><span class="s4">108</span><span class="s3">, </span><span class="s4">124</span><span class="s3">]</span>


<span class="s0"># =============================================================================</span>
<span class="s0"># Image plugin for the Windows BMP format.</span>
<span class="s0"># =============================================================================</span>
<span class="s2">class </span><span class="s1">BmpImageFile</span><span class="s3">(</span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">ImageFile</span><span class="s3">):</span>
    <span class="s7">&quot;&quot;&quot;Image plugin for the Windows Bitmap format (BMP)&quot;&quot;&quot;</span>

    <span class="s0"># ------------------------------------------------------------- Description</span>
    <span class="s1">format_description </span><span class="s3">= </span><span class="s5">&quot;Windows Bitmap&quot;</span>
    <span class="s1">format </span><span class="s3">= </span><span class="s5">&quot;BMP&quot;</span>

    <span class="s0"># -------------------------------------------------- BMP Compression values</span>
    <span class="s1">COMPRESSIONS </span><span class="s3">= {</span><span class="s5">&quot;RAW&quot;</span><span class="s3">: </span><span class="s4">0</span><span class="s3">, </span><span class="s5">&quot;RLE8&quot;</span><span class="s3">: </span><span class="s4">1</span><span class="s3">, </span><span class="s5">&quot;RLE4&quot;</span><span class="s3">: </span><span class="s4">2</span><span class="s3">, </span><span class="s5">&quot;BITFIELDS&quot;</span><span class="s3">: </span><span class="s4">3</span><span class="s3">, </span><span class="s5">&quot;JPEG&quot;</span><span class="s3">: </span><span class="s4">4</span><span class="s3">, </span><span class="s5">&quot;PNG&quot;</span><span class="s3">: </span><span class="s4">5</span><span class="s3">}</span>
    <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">COMPRESSIONS</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">vars</span><span class="s3">()[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v</span>

    <span class="s2">def </span><span class="s1">_bitmap</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">header</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">=</span><span class="s4">0</span><span class="s3">):</span>
        <span class="s7">&quot;&quot;&quot;Read relevant info about the BMP&quot;&quot;&quot;</span>
        <span class="s1">read</span><span class="s3">, </span><span class="s1">seek </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">seek</span>
        <span class="s2">if </span><span class="s1">header</span><span class="s3">:</span>
            <span class="s1">seek</span><span class="s3">(</span><span class="s1">header</span><span class="s3">)</span>
        <span class="s0"># read bmp header size @offset 14 (this is part of the header size)</span>
        <span class="s1">file_info </span><span class="s3">= {</span><span class="s5">&quot;header_size&quot;</span><span class="s3">: </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">read</span><span class="s3">(</span><span class="s4">4</span><span class="s3">)), </span><span class="s5">&quot;direction&quot;</span><span class="s3">: -</span><span class="s4">1</span><span class="s3">}</span>

        <span class="s0"># -------------------- If requested, read header at a specific position</span>
        <span class="s0"># read the rest of the bmp header, without its size</span>
        <span class="s1">header_data </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;header_size&quot;</span><span class="s3">] - </span><span class="s4">4</span><span class="s3">)</span>

        <span class="s0"># ------------------------------- Windows Bitmap v2, IBM OS/2 Bitmap v1</span>
        <span class="s0"># ----- This format has different offsets because of width/height types</span>
        <span class="s0"># 12: BITMAPCOREHEADER/OS21XBITMAPHEADER</span>
        <span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;header_size&quot;</span><span class="s3">] == </span><span class="s4">12</span><span class="s3">:</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;width&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;height&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;planes&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">6</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">RAW</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;palette_padding&quot;</span><span class="s3">] = </span><span class="s4">3</span>

        <span class="s0"># --------------------------------------------- Windows Bitmap v3 to v5</span>
        <span class="s0">#  40: BITMAPINFOHEADER</span>
        <span class="s0">#  52: BITMAPV2HEADER</span>
        <span class="s0">#  56: BITMAPV3HEADER</span>
        <span class="s0">#  64: BITMAPCOREHEADER2/OS22XBITMAPHEADER</span>
        <span class="s0"># 108: BITMAPV4HEADER</span>
        <span class="s0"># 124: BITMAPV5HEADER</span>
        <span class="s2">elif </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;header_size&quot;</span><span class="s3">] </span><span class="s2">in </span><span class="s3">(</span><span class="s4">40</span><span class="s3">, </span><span class="s4">52</span><span class="s3">, </span><span class="s4">56</span><span class="s3">, </span><span class="s4">64</span><span class="s3">, </span><span class="s4">108</span><span class="s3">, </span><span class="s4">124</span><span class="s3">):</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;y_flip&quot;</span><span class="s3">] = </span><span class="s1">header_data</span><span class="s3">[</span><span class="s4">7</span><span class="s3">] == </span><span class="s4">0xFF</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;direction&quot;</span><span class="s3">] = </span><span class="s4">1 </span><span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;y_flip&quot;</span><span class="s3">] </span><span class="s2">else </span><span class="s3">-</span><span class="s4">1</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;width&quot;</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;height&quot;</span><span class="s3">] = (</span>
                <span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;y_flip&quot;</span><span class="s3">]</span>
                <span class="s2">else </span><span class="s4">2</span><span class="s3">**</span><span class="s4">32 </span><span class="s3">- </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">4</span><span class="s3">)</span>
            <span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;planes&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">8</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">12</span><span class="s3">)</span>
            <span class="s0"># byte size of pixel data</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;data_size&quot;</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">16</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;pixels_per_meter&quot;</span><span class="s3">] = (</span>
                <span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">20</span><span class="s3">),</span>
                <span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">24</span><span class="s3">),</span>
            <span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">28</span><span class="s3">)</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;palette_padding&quot;</span><span class="s3">] = </span><span class="s4">4</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">[</span><span class="s5">&quot;dpi&quot;</span><span class="s3">] = </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">x </span><span class="s3">/ </span><span class="s4">39.3701 </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;pixels_per_meter&quot;</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">BITFIELDS</span><span class="s3">:</span>
                <span class="s1">masks </span><span class="s3">= [</span><span class="s5">&quot;r_mask&quot;</span><span class="s3">, </span><span class="s5">&quot;g_mask&quot;</span><span class="s3">, </span><span class="s5">&quot;b_mask&quot;</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">) &gt;= </span><span class="s4">48</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">) &gt;= </span><span class="s4">52</span><span class="s3">:</span>
                        <span class="s1">masks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;a_mask&quot;</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;a_mask&quot;</span><span class="s3">] = </span><span class="s4">0x0</span>
                    <span class="s2">for </span><span class="s1">idx</span><span class="s3">, </span><span class="s1">mask </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">masks</span><span class="s3">):</span>
                        <span class="s1">file_info</span><span class="s3">[</span><span class="s1">mask</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">header_data</span><span class="s3">, </span><span class="s4">36 </span><span class="s3">+ </span><span class="s1">idx </span><span class="s3">* </span><span class="s4">4</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s0"># 40 byte headers only have the three components in the</span>
                    <span class="s0"># bitfields masks, ref:</span>
                    <span class="s0"># https://msdn.microsoft.com/en-us/library/windows/desktop/dd183376(v=vs.85).aspx</span>
                    <span class="s0"># See also</span>
                    <span class="s0"># https://github.com/python-pillow/Pillow/issues/1293</span>
                    <span class="s0"># There is a 4th component in the RGBQuad, in the alpha</span>
                    <span class="s0"># location, but it is listed as a reserved component,</span>
                    <span class="s0"># and it is not generally an alpha channel</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;a_mask&quot;</span><span class="s3">] = </span><span class="s4">0x0</span>
                    <span class="s2">for </span><span class="s1">mask </span><span class="s2">in </span><span class="s1">masks</span><span class="s3">:</span>
                        <span class="s1">file_info</span><span class="s3">[</span><span class="s1">mask</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">read</span><span class="s3">(</span><span class="s4">4</span><span class="s3">))</span>
                <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;rgb_mask&quot;</span><span class="s3">] = (</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;r_mask&quot;</span><span class="s3">],</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;g_mask&quot;</span><span class="s3">],</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;b_mask&quot;</span><span class="s3">],</span>
                <span class="s3">)</span>
                <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;rgba_mask&quot;</span><span class="s3">] = (</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;r_mask&quot;</span><span class="s3">],</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;g_mask&quot;</span><span class="s3">],</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;b_mask&quot;</span><span class="s3">],</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;a_mask&quot;</span><span class="s3">],</span>
                <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;Unsupported BMP header type (</span><span class="s2">{</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'header_size'</span><span class="s3">]</span><span class="s2">}</span><span class="s5">)&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s0"># ------------------ Special case : header is reported 40, which</span>
        <span class="s0"># ---------------------- is shorter than real size for bpp &gt;= 16</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_size </span><span class="s3">= </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;width&quot;</span><span class="s3">], </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;height&quot;</span><span class="s3">]</span>

        <span class="s0"># ------- If color count was not found in the header, compute from bits</span>
        <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">] = (</span>
            <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">file_info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;colors&quot;</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
            <span class="s2">else </span><span class="s3">(</span><span class="s4">1 </span><span class="s3">&lt;&lt; </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">])</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">offset </span><span class="s3">== </span><span class="s4">14 </span><span class="s3">+ </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;header_size&quot;</span><span class="s3">] </span><span class="s2">and </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] &lt;= </span><span class="s4">8</span><span class="s3">:</span>
            <span class="s1">offset </span><span class="s3">+= </span><span class="s4">4 </span><span class="s3">* </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">]</span>

        <span class="s0"># ---------------------- Check bit depth for unusual unsupported values</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_mode</span><span class="s3">, </span><span class="s1">raw_mode </span><span class="s3">= </span><span class="s1">BIT2MODE</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">], (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;Unsupported BMP pixel depth (</span><span class="s2">{</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'bits'</span><span class="s3">]</span><span class="s2">}</span><span class="s5">)&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s0"># ---------------- Process BMP with Bitfields compression (not palette)</span>
        <span class="s1">decoder_name </span><span class="s3">= </span><span class="s5">&quot;raw&quot;</span>
        <span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">BITFIELDS</span><span class="s3">:</span>
            <span class="s1">SUPPORTED </span><span class="s3">= {</span>
                <span class="s4">32</span><span class="s3">: [</span>
                    <span class="s3">(</span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF000000</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0xFF000000</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">),</span>
                    <span class="s3">(</span><span class="s4">0x0</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">),</span>
                <span class="s3">],</span>
                <span class="s4">24</span><span class="s3">: [(</span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">)],</span>
                <span class="s4">16</span><span class="s3">: [(</span><span class="s4">0xF800</span><span class="s3">, </span><span class="s4">0x7E0</span><span class="s3">, </span><span class="s4">0x1F</span><span class="s3">), (</span><span class="s4">0x7C00</span><span class="s3">, </span><span class="s4">0x3E0</span><span class="s3">, </span><span class="s4">0x1F</span><span class="s3">)],</span>
            <span class="s3">}</span>
            <span class="s1">MASK_MODES </span><span class="s3">= {</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">)): </span><span class="s5">&quot;BGRX&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">)): </span><span class="s5">&quot;XBGR&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">)): </span><span class="s5">&quot;BGXR&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">)): </span><span class="s5">&quot;ABGR&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF000000</span><span class="s3">)): </span><span class="s5">&quot;RGBA&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0xFF000000</span><span class="s3">)): </span><span class="s5">&quot;BGRA&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0xFF000000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">, </span><span class="s4">0xFF0000</span><span class="s3">)): </span><span class="s5">&quot;BGAR&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">32</span><span class="s3">, (</span><span class="s4">0x0</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">, </span><span class="s4">0x0</span><span class="s3">)): </span><span class="s5">&quot;BGRA&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">24</span><span class="s3">, (</span><span class="s4">0xFF0000</span><span class="s3">, </span><span class="s4">0xFF00</span><span class="s3">, </span><span class="s4">0xFF</span><span class="s3">)): </span><span class="s5">&quot;BGR&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">16</span><span class="s3">, (</span><span class="s4">0xF800</span><span class="s3">, </span><span class="s4">0x7E0</span><span class="s3">, </span><span class="s4">0x1F</span><span class="s3">)): </span><span class="s5">&quot;BGR;16&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">16</span><span class="s3">, (</span><span class="s4">0x7C00</span><span class="s3">, </span><span class="s4">0x3E0</span><span class="s3">, </span><span class="s4">0x1F</span><span class="s3">)): </span><span class="s5">&quot;BGR;15&quot;</span><span class="s3">,</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] </span><span class="s2">in </span><span class="s1">SUPPORTED</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s3">(</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] == </span><span class="s4">32</span>
                    <span class="s2">and </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;rgba_mask&quot;</span><span class="s3">] </span><span class="s2">in </span><span class="s1">SUPPORTED</span><span class="s3">[</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">]]</span>
                <span class="s3">):</span>
                    <span class="s1">raw_mode </span><span class="s3">= </span><span class="s1">MASK_MODES</span><span class="s3">[(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">], </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;rgba_mask&quot;</span><span class="s3">])]</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_mode </span><span class="s3">= </span><span class="s5">&quot;RGBA&quot; </span><span class="s2">if </span><span class="s5">&quot;A&quot; </span><span class="s2">in </span><span class="s1">raw_mode </span><span class="s2">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span>
                <span class="s2">elif </span><span class="s3">(</span>
                    <span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] </span><span class="s2">in </span><span class="s3">(</span><span class="s4">24</span><span class="s3">, </span><span class="s4">16</span><span class="s3">)</span>
                    <span class="s2">and </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;rgb_mask&quot;</span><span class="s3">] </span><span class="s2">in </span><span class="s1">SUPPORTED</span><span class="s3">[</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">]]</span>
                <span class="s3">):</span>
                    <span class="s1">raw_mode </span><span class="s3">= </span><span class="s1">MASK_MODES</span><span class="s3">[(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">], </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;rgb_mask&quot;</span><span class="s3">])]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Unsupported BMP bitfields layout&quot;</span>
                    <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Unsupported BMP bitfields layout&quot;</span>
                <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">RAW</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] == </span><span class="s4">32 </span><span class="s2">and </span><span class="s1">header </span><span class="s3">== </span><span class="s4">22</span><span class="s3">:  </span><span class="s0"># 32-bit .cur offset</span>
                <span class="s1">raw_mode</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_mode </span><span class="s3">= </span><span class="s5">&quot;BGRA&quot;</span><span class="s3">, </span><span class="s5">&quot;RGBA&quot;</span>
        <span class="s2">elif </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] </span><span class="s2">in </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">RLE8</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">RLE4</span><span class="s3">):</span>
            <span class="s1">decoder_name </span><span class="s3">= </span><span class="s5">&quot;bmp_rle&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;Unsupported BMP compression (</span><span class="s2">{</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'compression'</span><span class="s3">]</span><span class="s2">}</span><span class="s5">)&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s0"># --------------- Once the header is processed, process the palette/LUT</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s5">&quot;P&quot;</span><span class="s3">:  </span><span class="s0"># Paletted for 1, 4 and 8 bit images</span>
            <span class="s0"># ---------------------------------------------------- 1-bit images</span>
            <span class="s2">if not </span><span class="s3">(</span><span class="s4">0 </span><span class="s3">&lt; </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">] &lt;= </span><span class="s4">65536</span><span class="s3">):</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;Unsupported BMP Palette size (</span><span class="s2">{</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">'colors'</span><span class="s3">]</span><span class="s2">}</span><span class="s5">)&quot;</span>
                <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">padding </span><span class="s3">= </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;palette_padding&quot;</span><span class="s3">]</span>
                <span class="s1">palette </span><span class="s3">= </span><span class="s1">read</span><span class="s3">(</span><span class="s1">padding </span><span class="s3">* </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">])</span>
                <span class="s1">grayscale </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s1">indices </span><span class="s3">= (</span>
                    <span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">255</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">] == </span><span class="s4">2</span>
                    <span class="s2">else </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">]))</span>
                <span class="s3">)</span>

                <span class="s0"># ----------------- Check if grayscale and ignore palette if so</span>
                <span class="s2">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">indices</span><span class="s3">):</span>
                    <span class="s1">rgb </span><span class="s3">= </span><span class="s1">palette</span><span class="s3">[</span><span class="s1">ind </span><span class="s3">* </span><span class="s1">padding </span><span class="s3">: </span><span class="s1">ind </span><span class="s3">* </span><span class="s1">padding </span><span class="s3">+ </span><span class="s4">3</span><span class="s3">]</span>
                    <span class="s2">if </span><span class="s1">rgb </span><span class="s3">!= </span><span class="s1">o8</span><span class="s3">(</span><span class="s1">val</span><span class="s3">) * </span><span class="s4">3</span><span class="s3">:</span>
                        <span class="s1">grayscale </span><span class="s3">= </span><span class="s2">False</span>

                <span class="s0"># ------- If all colors are gray, white or black, ditch palette</span>
                <span class="s2">if </span><span class="s1">grayscale</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_mode </span><span class="s3">= </span><span class="s5">&quot;1&quot; </span><span class="s2">if </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;colors&quot;</span><span class="s3">] == </span><span class="s4">2 </span><span class="s2">else </span><span class="s5">&quot;L&quot;</span>
                    <span class="s1">raw_mode </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_mode </span><span class="s3">= </span><span class="s5">&quot;P&quot;</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">palette </span><span class="s3">= </span><span class="s1">ImagePalette</span><span class="s3">.</span><span class="s1">raw</span><span class="s3">(</span>
                        <span class="s5">&quot;BGRX&quot; </span><span class="s2">if </span><span class="s1">padding </span><span class="s3">== </span><span class="s4">4 </span><span class="s2">else </span><span class="s5">&quot;BGR&quot;</span><span class="s3">, </span><span class="s1">palette</span>
                    <span class="s3">)</span>

        <span class="s0"># ---------------------------- Finally set the tile data for the plugin</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] = </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">]</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s1">raw_mode</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">decoder_name </span><span class="s3">== </span><span class="s5">&quot;bmp_rle&quot;</span><span class="s3">:</span>
            <span class="s1">args</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;compression&quot;</span><span class="s3">] == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">RLE4</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">args</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(((</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;width&quot;</span><span class="s3">] * </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;bits&quot;</span><span class="s3">] + </span><span class="s4">31</span><span class="s3">) &gt;&gt; </span><span class="s4">3</span><span class="s3">) &amp; (~</span><span class="s4">3</span><span class="s3">))</span>
        <span class="s1">args</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;direction&quot;</span><span class="s3">])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tile </span><span class="s3">= [</span>
            <span class="s3">(</span>
                <span class="s1">decoder_name</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;width&quot;</span><span class="s3">], </span><span class="s1">file_info</span><span class="s3">[</span><span class="s5">&quot;height&quot;</span><span class="s3">]),</span>
                <span class="s1">offset </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">tell</span><span class="s3">(),</span>
                <span class="s1">tuple</span><span class="s3">(</span><span class="s1">args</span><span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Open file, check magic number and read header&quot;&quot;&quot;</span>
        <span class="s0"># read 14 bytes: magic number, filesize, reserved, header final offset</span>
        <span class="s1">head_data </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s4">14</span><span class="s3">)</span>
        <span class="s0"># choke if the file does not have the required magic bytes</span>
        <span class="s2">if not </span><span class="s1">_accept</span><span class="s3">(</span><span class="s1">head_data</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Not a BMP file&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s0"># read the start position of the BMP image data (u32)</span>
        <span class="s1">offset </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">head_data</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
        <span class="s0"># load bitmap information (offset=raster info)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_bitmap</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">=</span><span class="s1">offset</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">BmpRleDecoder</span><span class="s3">(</span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">PyDecoder</span><span class="s3">):</span>
    <span class="s1">_pulls_fd </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">decode</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">buffer</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]:</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd </span><span class="s2">is not None</span>
        <span class="s1">rle4 </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">bytearray</span><span class="s3">()</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">dest_length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">xsize </span><span class="s3">* </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">ysize</span>
        <span class="s2">while </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) &lt; </span><span class="s1">dest_length</span><span class="s3">:</span>
            <span class="s1">pixels </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)</span>
            <span class="s1">byte </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">pixels </span><span class="s2">or not </span><span class="s1">byte</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">num_pixels </span><span class="s3">= </span><span class="s1">pixels</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">num_pixels</span><span class="s3">:</span>
                <span class="s0"># encoded mode</span>
                <span class="s2">if </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">num_pixels </span><span class="s3">&gt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">xsize</span><span class="s3">:</span>
                    <span class="s0"># Too much data for row</span>
                    <span class="s1">num_pixels </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">xsize </span><span class="s3">- </span><span class="s1">x</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">rle4</span><span class="s3">:</span>
                    <span class="s1">first_pixel </span><span class="s3">= </span><span class="s1">o8</span><span class="s3">(</span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] &gt;&gt; </span><span class="s4">4</span><span class="s3">)</span>
                    <span class="s1">second_pixel </span><span class="s3">= </span><span class="s1">o8</span><span class="s3">(</span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] &amp; </span><span class="s4">0x0F</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">index </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_pixels</span><span class="s3">):</span>
                        <span class="s2">if </span><span class="s1">index </span><span class="s3">% </span><span class="s4">2 </span><span class="s3">== </span><span class="s4">0</span><span class="s3">:</span>
                            <span class="s1">data </span><span class="s3">+= </span><span class="s1">first_pixel</span>
                        <span class="s2">else</span><span class="s3">:</span>
                            <span class="s1">data </span><span class="s3">+= </span><span class="s1">second_pixel</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">data </span><span class="s3">+= </span><span class="s1">byte </span><span class="s3">* </span><span class="s1">num_pixels</span>
                <span class="s1">x </span><span class="s3">+= </span><span class="s1">num_pixels</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s4">0</span><span class="s3">:</span>
                    <span class="s0"># end of line</span>
                    <span class="s2">while </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) % </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">xsize </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
                        <span class="s1">data </span><span class="s3">+= </span><span class="s6">b&quot;</span><span class="s2">\x00</span><span class="s6">&quot;</span>
                    <span class="s1">x </span><span class="s3">= </span><span class="s4">0</span>
                <span class="s2">elif </span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s4">1</span><span class="s3">:</span>
                    <span class="s0"># end of bitmap</span>
                    <span class="s2">break</span>
                <span class="s2">elif </span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s4">2</span><span class="s3">:</span>
                    <span class="s0"># delta</span>
                    <span class="s1">bytes_read </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bytes_read</span><span class="s3">) &lt; </span><span class="s4">2</span><span class="s3">:</span>
                        <span class="s2">break</span>
                    <span class="s1">right</span><span class="s3">, </span><span class="s1">up </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)</span>
                    <span class="s1">data </span><span class="s3">+= </span><span class="s6">b&quot;</span><span class="s2">\x00</span><span class="s6">&quot; </span><span class="s3">* (</span><span class="s1">right </span><span class="s3">+ </span><span class="s1">up </span><span class="s3">* </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">xsize</span><span class="s3">)</span>
                    <span class="s1">x </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) % </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">.</span><span class="s1">xsize</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s0"># absolute mode</span>
                    <span class="s2">if </span><span class="s1">rle4</span><span class="s3">:</span>
                        <span class="s0"># 2 pixels per byte</span>
                        <span class="s1">byte_count </span><span class="s3">= </span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] // </span><span class="s4">2</span>
                        <span class="s1">bytes_read </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">byte_count</span><span class="s3">)</span>
                        <span class="s2">for </span><span class="s1">byte_read </span><span class="s2">in </span><span class="s1">bytes_read</span><span class="s3">:</span>
                            <span class="s1">data </span><span class="s3">+= </span><span class="s1">o8</span><span class="s3">(</span><span class="s1">byte_read </span><span class="s3">&gt;&gt; </span><span class="s4">4</span><span class="s3">)</span>
                            <span class="s1">data </span><span class="s3">+= </span><span class="s1">o8</span><span class="s3">(</span><span class="s1">byte_read </span><span class="s3">&amp; </span><span class="s4">0x0F</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">byte_count </span><span class="s3">= </span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
                        <span class="s1">bytes_read </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">byte_count</span><span class="s3">)</span>
                        <span class="s1">data </span><span class="s3">+= </span><span class="s1">bytes_read</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">bytes_read</span><span class="s3">) &lt; </span><span class="s1">byte_count</span><span class="s3">:</span>
                        <span class="s2">break</span>
                    <span class="s1">x </span><span class="s3">+= </span><span class="s1">byte</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

                    <span class="s0"># align to 16-bit word boundary</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">tell</span><span class="s3">() % </span><span class="s4">2 </span><span class="s3">!= </span><span class="s4">0</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">fd</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">SEEK_CUR</span><span class="s3">)</span>
        <span class="s1">rawmode </span><span class="s3">= </span><span class="s5">&quot;L&quot; </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s5">&quot;L&quot; </span><span class="s2">else </span><span class="s5">&quot;P&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">set_as_raw</span><span class="s3">(</span><span class="s1">bytes</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), (</span><span class="s1">rawmode</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">args</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]))</span>
        <span class="s2">return </span><span class="s3">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span>


<span class="s0"># =============================================================================</span>
<span class="s0"># Image plugin for the DIB format (BMP alias)</span>
<span class="s0"># =============================================================================</span>
<span class="s2">class </span><span class="s1">DibImageFile</span><span class="s3">(</span><span class="s1">BmpImageFile</span><span class="s3">):</span>
    <span class="s1">format </span><span class="s3">= </span><span class="s5">&quot;DIB&quot;</span>
    <span class="s1">format_description </span><span class="s3">= </span><span class="s5">&quot;Windows Bitmap&quot;</span>

    <span class="s2">def </span><span class="s1">_open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_bitmap</span><span class="s3">()</span>


<span class="s0">#</span>
<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Write BMP file</span>


<span class="s1">SAVE </span><span class="s3">= {</span>
    <span class="s5">&quot;1&quot;</span><span class="s3">: (</span><span class="s5">&quot;1&quot;</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">),</span>
    <span class="s5">&quot;L&quot;</span><span class="s3">: (</span><span class="s5">&quot;L&quot;</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">256</span><span class="s3">),</span>
    <span class="s5">&quot;P&quot;</span><span class="s3">: (</span><span class="s5">&quot;P&quot;</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">256</span><span class="s3">),</span>
    <span class="s5">&quot;RGB&quot;</span><span class="s3">: (</span><span class="s5">&quot;BGR&quot;</span><span class="s3">, </span><span class="s4">24</span><span class="s3">, </span><span class="s4">0</span><span class="s3">),</span>
    <span class="s5">&quot;RGBA&quot;</span><span class="s3">: (</span><span class="s5">&quot;BGRA&quot;</span><span class="s3">, </span><span class="s4">32</span><span class="s3">, </span><span class="s4">0</span><span class="s3">),</span>
<span class="s3">}</span>


<span class="s2">def </span><span class="s1">_dib_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">: </span><span class="s1">IO</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">], </span><span class="s1">filename</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_save</span><span class="s3">(</span>
    <span class="s1">im</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">: </span><span class="s1">IO</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">], </span><span class="s1">filename</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bitmap_header</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">rawmode</span><span class="s3">, </span><span class="s1">bits</span><span class="s3">, </span><span class="s1">colors </span><span class="s3">= </span><span class="s1">SAVE</span><span class="s3">[</span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">]</span>
    <span class="s2">except </span><span class="s1">KeyError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;cannot write mode </span><span class="s2">{</span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode</span><span class="s2">} </span><span class="s5">as BMP&quot;</span>
        <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) </span><span class="s2">from </span><span class="s1">e</span>

    <span class="s1">info </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span>

    <span class="s1">dpi </span><span class="s3">= </span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;dpi&quot;</span><span class="s3">, (</span><span class="s4">96</span><span class="s3">, </span><span class="s4">96</span><span class="s3">))</span>

    <span class="s0"># 1 meter == 39.3701 inches</span>
    <span class="s1">ppm </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">x </span><span class="s3">* </span><span class="s4">39.3701 </span><span class="s3">+ </span><span class="s4">0.5</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">dpi</span><span class="s3">)</span>

    <span class="s1">stride </span><span class="s3">= ((</span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] * </span><span class="s1">bits </span><span class="s3">+ </span><span class="s4">7</span><span class="s3">) // </span><span class="s4">8 </span><span class="s3">+ </span><span class="s4">3</span><span class="s3">) &amp; (~</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">header </span><span class="s3">= </span><span class="s4">40  </span><span class="s0"># or 64 for OS/2 version 2</span>
    <span class="s1">image </span><span class="s3">= </span><span class="s1">stride </span><span class="s3">* </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]</span>

    <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s5">&quot;1&quot;</span><span class="s3">:</span>
        <span class="s1">palette </span><span class="s3">= </span><span class="s6">b&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">o8</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) * </span><span class="s4">4 </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">255</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s5">&quot;L&quot;</span><span class="s3">:</span>
        <span class="s1">palette </span><span class="s3">= </span><span class="s6">b&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">o8</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) * </span><span class="s4">4 </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">256</span><span class="s3">))</span>
    <span class="s2">elif </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s5">&quot;P&quot;</span><span class="s3">:</span>
        <span class="s1">palette </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">getpalette</span><span class="s3">(</span><span class="s5">&quot;RGB&quot;</span><span class="s3">, </span><span class="s5">&quot;BGRX&quot;</span><span class="s3">)</span>
        <span class="s1">colors </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">palette</span><span class="s3">) // </span><span class="s4">4</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">palette </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s0"># bitmap header</span>
    <span class="s2">if </span><span class="s1">bitmap_header</span><span class="s3">:</span>
        <span class="s1">offset </span><span class="s3">= </span><span class="s4">14 </span><span class="s3">+ </span><span class="s1">header </span><span class="s3">+ </span><span class="s1">colors </span><span class="s3">* </span><span class="s4">4</span>
        <span class="s1">file_size </span><span class="s3">= </span><span class="s1">offset </span><span class="s3">+ </span><span class="s1">image</span>
        <span class="s2">if </span><span class="s1">file_size </span><span class="s3">&gt; </span><span class="s4">2</span><span class="s3">**</span><span class="s4">32 </span><span class="s3">- </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;File size is too large for the BMP format&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span>
            <span class="s6">b&quot;BM&quot;  </span><span class="s0"># file type (magic)</span>
            <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">file_size</span><span class="s3">)  </span><span class="s0"># file size</span>
            <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)  </span><span class="s0"># reserved</span>
            <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">)  </span><span class="s0"># image data offset</span>
        <span class="s3">)</span>

    <span class="s0"># bitmap info header</span>
    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span>
        <span class="s1">o32</span><span class="s3">(</span><span class="s1">header</span><span class="s3">)  </span><span class="s0"># info header size</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])  </span><span class="s0"># width</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">[</span><span class="s4">1</span><span class="s3">])  </span><span class="s0"># height</span>
        <span class="s3">+ </span><span class="s1">o16</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)  </span><span class="s0"># planes</span>
        <span class="s3">+ </span><span class="s1">o16</span><span class="s3">(</span><span class="s1">bits</span><span class="s3">)  </span><span class="s0"># depth</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)  </span><span class="s0"># compression (0=uncompressed)</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">image</span><span class="s3">)  </span><span class="s0"># size of bitmap</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">ppm</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])  </span><span class="s0"># resolution</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">ppm</span><span class="s3">[</span><span class="s4">1</span><span class="s3">])  </span><span class="s0"># resolution</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">colors</span><span class="s3">)  </span><span class="s0"># colors used</span>
        <span class="s3">+ </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">colors</span><span class="s3">)  </span><span class="s0"># colors important</span>
    <span class="s3">)</span>

    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s6">b&quot;</span><span class="s2">\0</span><span class="s6">&quot; </span><span class="s3">* (</span><span class="s1">header </span><span class="s3">- </span><span class="s4">40</span><span class="s3">))  </span><span class="s0"># padding (for OS/2 format)</span>

    <span class="s2">if </span><span class="s1">palette</span><span class="s3">:</span>
        <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">palette</span><span class="s3">)</span>

    <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, [(</span><span class="s5">&quot;raw&quot;</span><span class="s3">, (</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">) + </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, (</span><span class="s1">rawmode</span><span class="s3">, </span><span class="s1">stride</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">))])</span>


<span class="s0">#</span>
<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Registry</span>


<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_open</span><span class="s3">(</span><span class="s1">BmpImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">BmpImageFile</span><span class="s3">, </span><span class="s1">_accept</span><span class="s3">)</span>
<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_save</span><span class="s3">(</span><span class="s1">BmpImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">_save</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_extension</span><span class="s3">(</span><span class="s1">BmpImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s5">&quot;.bmp&quot;</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_mime</span><span class="s3">(</span><span class="s1">BmpImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s5">&quot;image/bmp&quot;</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_decoder</span><span class="s3">(</span><span class="s5">&quot;bmp_rle&quot;</span><span class="s3">, </span><span class="s1">BmpRleDecoder</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_open</span><span class="s3">(</span><span class="s1">DibImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">DibImageFile</span><span class="s3">, </span><span class="s1">_dib_accept</span><span class="s3">)</span>
<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_save</span><span class="s3">(</span><span class="s1">DibImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">_dib_save</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_extension</span><span class="s3">(</span><span class="s1">DibImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s5">&quot;.dib&quot;</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_mime</span><span class="s3">(</span><span class="s1">DibImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s5">&quot;image/bmp&quot;</span><span class="s3">)</span>
</pre>
</body>
</html>